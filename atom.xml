<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>jkzhao&#39;s blog</title>
  <subtitle>学习 总结 思考</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2019-10-10T09:19:32.000Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Zhao Jiankai</name>
    <email>jk.zhaocoder@gmail.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>资源指标API及自定义指标API</title>
    <link href="http://yoursite.com/2019/10/08/%E8%B5%84%E6%BA%90%E6%8C%87%E6%A0%87API%E5%8F%8A%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E6%A0%87API/"/>
    <id>http://yoursite.com/2019/10/08/资源指标API及自定义指标API/</id>
    <published>2019-10-08T08:06:11.000Z</published>
    <updated>2019-10-10T09:19:32.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Kubernetes资源指标&quot;&gt;&lt;a href=&quot;#Kubernetes资源指标&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes资源指标&quot;&gt;&lt;/a&gt;Kubernetes资源指标&lt;/h2&gt;&lt;p&gt;官方文档的changelog中讲从1.11版本开始，开始将监控体系，指标数据获取机制移向新一代的监控模型。对于k8s来讲，现在有两种资源指标被使用：&lt;br&gt;1、资源指标&lt;br&gt;2、自定义指标 &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;heapster提供的指标收集和存储的功能，并支持多个数据接收器，或者说是sink，比如说influxdb。每个存储后端的代码都驻留在heapster代码仓库中。意思是说heapster为了支持多种各种各样的存储后端，不得不去适配和驱动每一个不同的后端。这每一个适配器都是第三方组织研发的，第三方组织哪一天没兴趣了，就不维护了。以至于heapster为了适配很多存储后端，整合了近十几个后端存储的适配器，有些适配器自从整合进heapster以后在也没改动过，但heapster为此就不得不付出代码量很庞大的局面，所以这就意味着heapster里的设计架构不适用于这种云原生。所以要设计新一代的监控架构。k8s本身如此强大，一个方面就在于很多功能是可以基于addons来实现，非常灵活。而且现在版本中的k8s还支持开发人员轻松自己定义自己的api服务器，来扩展核心api服务。意思是如果用户觉得现有的资源类型，比如service、pod，不能够解决我们自己的问题，我们可以根据自己实际的需要扩展k8s系统所支持的资源类型。&lt;br&gt;传统heapster时代，大多数功能都是通过apiserver获取的，除了一个功能不是，就是要想获取资源指标数据，得专门部署一个addon，叫heapster。能不能干脆把资源指标这样的数据也直接整合进apiserver。让用户能通过apiserver获取所有数据，包括指标。&lt;br&gt;从1.8以后引入了资源指标API。另外，k8s从1.6引入了自定义指标。很多系统级的组件都是依赖于这些指标API的功能的，比如kubectl top。没有资源指标供给，是没办法运行的。另外像HPA，水平Pod自动伸缩器。这也是必须根据获取当前Pod使用的资源量，比如CPU负载80%已经很高了，可以额外加几个Pod。如果Pod的CPU使用率一直低于5%，可以删除几个，腾出一些资源和空间，留给其他Pod使用。Pod无论运行与否，requests一直会预留给这个Pod使用，这些资源放那不用，不运行，很可惜。可以移除一些这样的Pod，腾出空间给其他Pod使用。这些组件都是依赖资源指标工作的，早期都是依赖heapster来实现的。新一代的资源指标API获取的主要方式是靠metric-server实现的。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;资源指标: metrics-server&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;自定义指标: prometheus, k8s-prometheus-adapter。&lt;/strong&gt; prometheus要想把它的监控的采集数据转成指标格式，需要一个特殊的组件来实现，k8s-prometheus-adapter。这是早期的版本，还没来得及看现有版本是否有了改进。prometheus已经被CNCF收录进去了，是个强大的监控系统。&lt;/p&gt;
&lt;h2 id=&quot;新一代架构&quot;&gt;&lt;a href=&quot;#新一代架构&quot; class=&quot;headerlink&quot; title=&quot;新一代架构&quot;&gt;&lt;/a&gt;新一代架构&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;核心指标流水线:&lt;/strong&gt; 由kubelet、metrics-server以及由API server提供的api组成;&lt;br&gt;主要提供CPU累积使用率(这个程序累计使用CPU多长时间占整个CPU时长多大比例)、内存实时使用率、Pod的资源占用率及容器的磁盘占用率。&lt;br&gt;除了这些指标，可能你还需要评估网络、连接数量、可用网络带宽等等，这些度量标准一般而言就需要用第三方组件了。核心指标是不适合第三方来提供的，因为这些核心指标将会被系统中的很多组件使用。&lt;br&gt;&lt;strong&gt;监控流水线:&lt;/strong&gt; 在系统上部署一个监控系统，用于从系统收集各种指标数据并提供终端用户、存储系统以及HPA，它们包含核心指标及许多非核心指标，并不仅限于CPU、内存、Pod的资源占用率及容器的磁盘占用率等数据。所以HPA既能够使用核心指标，也可以使用监控流水线中的扩展指标。监控流水线提供的指标我们称为非核心指标，但它通常也包括核心指标。&lt;br&gt;非核心指标本身不能被k8s所解析。比如prometheus采集到的数据，那是prometheus语境中保存的，prometheus能理解没问题，但是k8s理解不了，这就是为什么需要一个叫k8s-prometheus-adapter的原因。&lt;/p&gt;
&lt;h2 id=&quot;metrics-server&quot;&gt;&lt;a href=&quot;#metrics-server&quot; class=&quot;headerlink&quot; title=&quot;metrics-server&quot;&gt;&lt;/a&gt;metrics-server&lt;/h2&gt;&lt;p&gt;metrics-server 是一个外部的API服务器，它是提供资源指标服务的。metrics-server本身不是k8s的组成部分，它是托管运行在k8s之上的一个Pod。&lt;br&gt;k8s apiserver该怎么运行怎么运行，除此之外我们又运行了一个metrics-server，它提供另外一组API，我们需要把这两组API合并成一个使用，在它两个之间加一个代理，这个代理称为kube-aggregator，聚合器。相当于把来自多个地方的API聚合成一个来使用。不光光能聚合这两个，还能聚合第三方用户定义的API server。而这个聚合器提供的资源指标将通过apis下的一个群组叫 &lt;strong&gt;/apis/metrics.k8s.io/v1beta1&lt;/strong&gt; 来获取。在没部署metrics-server之前，通过kubectl api-versions是获取不到这个群组的，部署完后是可以获取到的。以后通过这个聚合器kube-aggregator既可以访问apiserver下的群组，也可以访问metrics-server下的群组。&lt;br&gt;heapster被废了，因此metrics-server已经成为k8s多个核心组件的先决条件，没有它就没办法运行。比如kubectl top，HPA等。&lt;/p&gt;
&lt;h2 id=&quot;部署metrics-server&quot;&gt;&lt;a href=&quot;#部署metrics-server&quot; class=&quot;headerlink&quot; title=&quot;部署metrics-server&quot;&gt;&lt;/a&gt;部署metrics-server&lt;/h2&gt;&lt;p&gt;打开metrics-server在github上的主页：&lt;a href=&quot;https://github.com/kubernetes-incubator/metrics-server&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/kubernetes-incubator/metrics-server&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/242.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;点击进入deploy目录下，我这里k8s集群是1.14.1，所以点击进入1.8+目录，把这些yaml文件下载下来执行：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# mkdir metrics-server&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cd metrics-server&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 metrics-server]# for file in auth-delegator.yaml auth-reader.yaml metrics-apiservice.yaml metrics-server-deployment.yaml metrics-server-service.yaml resource-reader.yaml aggregated-metrics-reader.yaml; do wget ht&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tps://raw.githubusercontent.com/kubernetes-incubator/metrics-server/master/deploy/1.8%2B/$file; done&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 metrics-server]# kubectl apply -f .&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 metrics-server]# kubectl get pods -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                                    READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;canal-p9v5f                             2/2     Running   0          22d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;canal-sksfk                             2/2     Running   0          22d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;canal-zchqq                             2/2     Running   0          22d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;canal-zgwsq                             2/2     Running   0          22d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-t2xj8                 1/1     Running   0          180d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-xdjkx                 1/1     Running   0          180d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-spark32                            1/1     Running   1          180d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-apiserver-spark32                  1/1     Running   0          180d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-controller-manager-spark32         1/1     Running   0          180d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-2mcd2             1/1     Running   0          22d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-jsx8s             1/1     Running   0          22d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-kk8cx             1/1     Running   0          22d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-vdjn4             1/1     Running   0          22d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-czhfc                        1/1     Running   0          180d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-gzhqw                        1/1     Running   0          64d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-rfxjw                        1/1     Running   0          180d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-xmkxq                        1/1     Running   0          180d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-scheduler-spark32                  1/1     Running   0          180d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes-dashboard-5f7b999d65-ngrr7   1/1     Running   0          24d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metrics-server-7967c9877f-m4jl8         1/1     Running   0          21d&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但是查看pod日志，一直在报错：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;unable to fully collect metrics: [unable to fully scrape metrics from source kubelet_summary:&amp;lt;hostname&amp;gt;: unable to fetch metrics from Kubelet &amp;lt;hostname&amp;gt; (&amp;lt;hostname&amp;gt;): Get https://&amp;lt;hostname&amp;gt;:10250/stats/summary/: dial tcp: lookup &amp;lt;hostname&amp;gt; on 10.96.0.10:53: no such host&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;解决：&lt;a href=&quot;https://github.com/kubernetes-incubator/metrics-server/issues/143&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/kubernetes-incubator/metrics-server/issues/143&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 metrics-server]# kubectl delete -f .&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 metrics-server]# vim metrics-server-deployment.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/243.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 metrics-server]# kubectl apply -f .&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/244.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;部署完后，如果metrics-server已经收集到数据了，我们就可以使用curl命令去获取数据了。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 metrics-server]# curl http://localhost:8080/apis/metrics.k8s.io/v1beta1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/245.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/246.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 metrics-server]# kubectl top nodes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;hadoop16   148m         7%     4470Mi          58%       &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark17    86m          2%     4824Mi          63%       &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32    282m         3%     16629Mi         69%       &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ubuntu31   130m         1%     2724Mi          17%       &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 metrics-server]# kubectl top pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                            CPU(cores)   MEMORY(bytes)   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;initcontainer-myapp-pod         0m           1Mi             &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-4sn9w   0m           2Mi             &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-7qn59   0m           3Mi             &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-jww2c   0m           2Mi             &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                        0m           4Mi             &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 metrics-server]# kubectl top pods -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                                    CPU(cores)   MEMORY(bytes)   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;canal-p9v5f                             16m          31Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;canal-sksfk                             30m          47Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;canal-zchqq                             16m          33Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;canal-zgwsq                             28m          49Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-t2xj8                 4m           18Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-xdjkx                 3m           19Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-spark32                            31m          361Mi           &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-apiserver-spark32                  37m          436Mi           &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-controller-manager-spark32         20m          65Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-2mcd2             3m           21Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-jsx8s             2m           15Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-kk8cx             3m           22Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-vdjn4             2m           13Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-czhfc                        1m           20Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-gzhqw                        2m           13Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-rfxjw                        1m           25Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-xmkxq                        3m           26Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-scheduler-spark32                  2m           21Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes-dashboard-5f7b999d65-ngrr7   1m           21Mi            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metrics-server-7967c9877f-m4jl8         1m           17Mi&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;Prometheus&quot;&gt;&lt;a href=&quot;#Prometheus&quot; class=&quot;headerlink&quot; title=&quot;Prometheus&quot;&gt;&lt;/a&gt;Prometheus&lt;/h2&gt;&lt;h3 id=&quot;Prometheus介绍&quot;&gt;&lt;a href=&quot;#Prometheus介绍&quot; class=&quot;headerlink&quot; title=&quot;Prometheus介绍&quot;&gt;&lt;/a&gt;Prometheus介绍&lt;/h3&gt;&lt;p&gt;Prometheus是个监控系统，和zabbix一样，都是server-agent模式。在每个节点上都要部署agent，node_exporter，但是这个组件只是用来采集当前节点的系统级指标数据的，如果要采集其他指标数据，比如采集mysql的，还需要部署mysql的exporter，还有很多重量级服务的专用exporter。&lt;br&gt;要去采集Pod的话，Pod在k8s上本身就有获取采集数据的接口，倒也不一定非得额外去部署，更何况其实每个容器的日志都在节点上。 这些日志信息是通过对应的接口输出出来的。简单来讲，prometheus是通过metrics-url来到各Pod获取数据的。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# cd /var/log/containers/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 containers]# ll&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/247.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;采集以后，如何看呢？prometheus提供一个非常强大的接口叫PromQL。mysql有个查询语句叫sql。PromQL支持非常强大的restful风格接口的查询条件表达式。但是这种数据是不能被apiserver解析的，数据格式不兼容。因此如果期望能够让这些数据通过k8s的apiserver，像在apiserver中请求获取数据一样来获取指标数据，那么必须把PromQL所查询到的数据格式转为k8s的api查询接口的格式。这就需要k8s-prometheus-adapter，这是第三方开发的。这个k8s-prometheus-adapter能够用PromQL语句完成从prometheus这里查询到一些指标数据，并转为k8s apiserver上的格式的数据。&lt;/p&gt;
&lt;h3 id=&quot;部署Prometheus&quot;&gt;&lt;a href=&quot;#部署Prometheus&quot; class=&quot;headerlink&quot; title=&quot;部署Prometheus&quot;&gt;&lt;/a&gt;部署Prometheus&lt;/h3&gt;&lt;p&gt;建议将prometheus放到单独的名称空间里去。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Kubernetes资源指标&quot;&gt;&lt;a href=&quot;#Kubernetes资源指标&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes资源指标&quot;&gt;&lt;/a&gt;Kubernetes资源指标&lt;/h2&gt;&lt;p&gt;官方文档的changelog中讲从1.11版本开始，开始将监控体系，指标数据获取机制移向新一代的监控模型。对于k8s来讲，现在有两种资源指标被使用：&lt;br&gt;1、资源指标&lt;br&gt;2、自定义指标
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>容器资源需求、资源限制及HeapSter</title>
    <link href="http://yoursite.com/2019/09/29/%E5%AE%B9%E5%99%A8%E8%B5%84%E6%BA%90%E9%9C%80%E6%B1%82%E3%80%81%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6%E5%8F%8AHeapSter/"/>
    <id>http://yoursite.com/2019/09/29/容器资源需求、资源限制及HeapSter/</id>
    <published>2019-09-29T00:52:16.000Z</published>
    <updated>2019-10-08T08:06:40.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;容器的资源需求和资源限制&quot;&gt;&lt;a href=&quot;#容器的资源需求和资源限制&quot; class=&quot;headerlink&quot; title=&quot;容器的资源需求和资源限制&quot;&gt;&lt;/a&gt;容器的资源需求和资源限制&lt;/h2&gt;&lt;p&gt;定义在容器级别的属性pods.spec.containers。目前支持定义CPU和内存资源。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;requests: 需求,最低保障; &lt;/li&gt;
&lt;li&gt;limits:限制,硬限制; &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;CPU: CPU资源属于可压缩型的，一个Pod或一个容器在获取本应该获得的CPU资源却获取不到时，无非就是等待就行了。&lt;br&gt;CPU的单位：在k8s之上，1颗逻辑CPU可以化为1000颗millicores，我这里称为毫核心或微核心。比如：500m=0.5CPU。&lt;/p&gt;
&lt;p&gt;内存: 但是对内存来讲不是如此，假如它所需要用到的内存资源不够时，有可能会因为内存资源耗尽而被kill掉。因为内存资源属于非可压缩性资源。单位为E、P、T、G、M、K 和 Ei、Pi、Ti、Gi、Mi、Ki，i表示1024。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/238.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;在定义资源需求时，最好把资源限制也定义了，防止容器中的应用程序因为bug或其它原因把CPU都吃掉。&lt;/p&gt;
&lt;h2 id=&quot;示例&quot;&gt;&lt;a href=&quot;#示例&quot; class=&quot;headerlink&quot; title=&quot;示例&quot;&gt;&lt;/a&gt;示例&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# mkdir resources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cd resources/&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pod.spec.containers.resources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: resources &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Compute Resources required by this container. Cannot be updated. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ResourceRequirements describes the compute resource requirements.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   limits       &amp;lt;map[string]string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Limits describes the maximum amount of compute resources allowed. More&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   requests     &amp;lt;map[string]string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Requests describes the minimum amount of compute resources required. If&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Requests is omitted for a container, it defaults to Limits if that is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     explicitly specified, otherwise to an implementation-defined value. More&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 resources]# vim pod-resources-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-resources-demo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    wisedu.com/created-by: &amp;quot;cluster admin&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/stress-ng&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    command: [&amp;quot;/usr/bin/stress-ng&amp;quot;, &amp;quot;-c 1&amp;quot;, &amp;quot;--metrics-brief&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    resources:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      requests:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        cpu: &amp;quot;200m&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        memory: &amp;quot;128Mi&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      limits:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        cpu: &amp;quot;500m&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        memory: &amp;quot;512Mi&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 resources]# kubectl apply -f pod-resources-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-resources-demo created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/239.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 resources]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                 READY   STATUS    RESTARTS   AGE     IP            NODE      NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-resources-demo   1/1     Running   0          5m27s   10.244.1.45   spark17   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 resources]# kubectl exec pod-resources-demo -- top    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Mem: 7710724K used, 195564K free, 350524K shrd, 278040K buff, 4441320K cached&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CPU:  18% usr   2% sys   0% nic  78% idle   0% io   0% irq   0% sirq&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Load average: 0.00 0.01 0.05 3/566 11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    6     1 root     R     6888   0%   1  13% &amp;#123;stress-ng-cpu&amp;#125; /usr/bin/stress-ng&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    1     0 root     S     6244   0%   1   0% /usr/bin/stress-ng -c 1 --metrics-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    7     0 root     R     1500   0%   3   0% top&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;pod运行在节点spark17上，这台服务器是4核CPU。而这个pod内的主程序占用CPU比例为13%，其实是12.5%，500m是0.5CPU，也就是1/8。&lt;br&gt;【说明】：容器的可见资源量和可用资源量不是一回事，在容器内使用free命令看到的是整个节点上的内存，而不会仅仅是当前容器中的内存，这会有问题的。比如，在一个容器中运行一个jvm，jvm上很多程序在跑起来要分堆内存的，如果在容器中看到的内存可用量不是容器的最大限额，而是节点的内存量，可能使用节点可用内存的%几十，这就比较麻烦。计算结果很可能会吞掉整个容器的内存都不够。所以目前来讲，在容器的资源限制，在这个维度上还是存在一些问题的。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 resources]# kubectl describe pod pod-resources-demo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;QoS Class:       Burstable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;QoS Class: 服务质量 类别。&lt;br&gt;在容器中限制了资源以后，系统会自动分配属于一个QoS类别。一般有3个类别：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Guranteed: 确保保证。&lt;br&gt;这类Pod具有最高的优先级。最先可被运行起来&lt;br&gt;一个Pod中的每个容器同时设置CPU和内存的requests和limits，并且满足requests=limits&lt;br&gt;cpu.limits=cpu.requests&lt;br&gt;memory.limits=memory.request&lt;/li&gt;
&lt;li&gt;Burstable: 一个Pod中至少有一个容器设置CPU或内存资源的requests属性。&lt;br&gt;这类Pod具有中等优先级。&lt;/li&gt;
&lt;li&gt;BestEffort: 一个Pod中没有任何一个容器设置了requests或limits属性;&lt;br&gt;最低优先级别;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;创建一个新的清单文件，将requests和limits中的值都设置为一样：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 resources]# vim pod-resources-demo2.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-resources-demo2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    wisedu.com/created-by: &amp;quot;cluster admin&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    resources:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      requests:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        cpu: &amp;quot;200m&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        memory: &amp;quot;128Mi&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      limits:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        cpu: &amp;quot;200m&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        memory: &amp;quot;128Mi&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 resources]# kubectl apply -f pod-resources-demo2.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-resources-demo2 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 resources]# kubectl describe pod  pod-resources-demo2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/240.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;当系统上资源不够用时，会优先终止BestEffort类别的Pod，以腾出资源来确保另外两类Pod中的容器能够正常运行。假设系统上只有Burstable和Guranteed时，Burstable类别有很多Pod，先终止哪一个？因此需要有一种计算标准去终止。其实在k8s代码中有一段设置的是尽可能把它对应的request资源占用量比例较大的给关掉。比如现在有两个Pod，以内存为例，第一个Pod中limits是1Gi，requests是512Mi，此时已经占了500Mi，不会一上来就立马占用了512Mi。第二个Pod中limits是2Gi，requests是1Gi，此时已经占了512Mi。这两个Pod终止的是第一个，因为第一个占据的量已经接近它的requests的量了。认为第二个Pod是比较温和的，声称要1Gi，目前只用到了512Mi。而第一个声称要512Mi，现在已经用了500Mi。&lt;/p&gt;
&lt;h2 id=&quot;Heapster&quot;&gt;&lt;a href=&quot;#Heapster&quot; class=&quot;headerlink&quot; title=&quot;Heapster&quot;&gt;&lt;/a&gt;Heapster&lt;/h2&gt;&lt;h3 id=&quot;heapster介绍&quot;&gt;&lt;a href=&quot;#heapster介绍&quot; class=&quot;headerlink&quot; title=&quot;heapster介绍&quot;&gt;&lt;/a&gt;heapster介绍&lt;/h3&gt;&lt;p&gt;在k8s上创建运行了Pod后，想知道Pod到底占用了多少资源了，比如定义了limits为512Mi，requests是256Mi，现在想看看到底用了多少了。docker有命令docker status，k8s之上也有命令可以看kubectl top。但是现在没法用。这个top命令的使用依赖于集群上部署一个叫 heapster 的附件。包括此前部署的dashboard上有些资源使用显示也是依赖heapster的。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 resources]# kubectl top nodes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Error from server (NotFound): the server could not find the requested resource (get services http:heapster:)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;统一的资源指标收集和存储工具，至少有个收集功能，当用户需要看的时候，它能联系到每一个节点上，通过每个节点上本地的agent来获取到这个节点之上的每一个进程甚至是节点本身的资源用量。传统的k8s集群中默认使用的指标采集和存储工具叫heapster，但是heapster只是个汇聚工具。在每个节点上运行的有一个组件叫kubelet，kubelet是可以获取当前节点上由它来创建和管理的各种资源对象尤其是Pod的相关信息数据的，但是真正完整去采集节点级和Pod的数据是kubelet当中的一个子组件，也是kubelet的插件叫 cAdvisor。早期的kubelet版本中1.8之后，这个cAdvisor已经是kubelet内建的功能了。cAdvisor专门负责收集当前节点上各Pod上的各容器以及节点级各种系统级资源指标的占用量。比如节点级的CPU、内存和存储用量，以及Pod级的各CPU、内存和存储用量。收集完后早期版本是支持单节点查看，现在不支持了。以前cAdvisor是监听在节点的4194端口，现在已经关掉了，不需要用户主动连接它来收集，而是由它来报告，报告给heapster。&lt;br&gt;heapster早期是专门为cAdvisor在每个节点上采集的数据为一个统一的存储工具。我们在集群上托管运行一个Pod，heapster。然后每个cAdvisor会去主动向heapster报告采集到的数据。heapster可以将数据缓存到内存中，但是内存是有限的，只能缓存一段时间的数据，以供kubectl top查看。如果想长期存储，得靠另外一个组件，heapster调用外部的时序数据库系统，叫InfluxDB。以后还可以查看历史中的信息数据。不过得借助另外一个工具来查看，grafana。grafana是可以把InfluxDB当数据源的。 &lt;/p&gt;
&lt;p&gt;但是从k8s 1.11开始，heapster已经废弃了，转向了新的监控模型：metric-server。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/241.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;容器的资源需求和资源限制&quot;&gt;&lt;a href=&quot;#容器的资源需求和资源限制&quot; class=&quot;headerlink&quot; title=&quot;容器的资源需求和资源限制&quot;&gt;&lt;/a&gt;容器的资源需求和资源限制&lt;/h2&gt;&lt;p&gt;定义在容器级别的属性pods.spec.containers。目前支持定义CPU和内存资源。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;requests: 需求,最低保障; &lt;/li&gt;
&lt;li&gt;limits:限制,硬限制;
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes高级调度方式</title>
    <link href="http://yoursite.com/2019/09/26/Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6%E6%96%B9%E5%BC%8F/"/>
    <id>http://yoursite.com/2019/09/26/Kubernetes高级调度方式/</id>
    <published>2019-09-26T01:10:06.000Z</published>
    <updated>2019-09-26T01:20:42.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;scheduler调度过程概述&quot;&gt;&lt;a href=&quot;#scheduler调度过程概述&quot; class=&quot;headerlink&quot; title=&quot;scheduler调度过程概述&quot;&gt;&lt;/a&gt;scheduler调度过程概述&lt;/h2&gt;&lt;p&gt;scheduler在实现调度时，分为三步实现调度过程。首先是预选，从所有节点当中选择基本符合条件的节点；而后在众多符合条件的节点当中，在使用优选函数去计算各自的得分并且加以比较，并从最高得分的节点当中随机选择出一个作为运行Pod的节点。这就是控制平面当中scheduler所实现负责的主要工作。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;同时如果在某些调度场景当中，我们期望通过自己的预设去影响它的一些调度方式，比如把Pod运行在一些特定的节点之上，可以通过自己的预设操作来影响scheduler的预选和优选的过程，从而使用调度操作能符合我们的期望。&lt;br&gt;此类的影响方式通常有3种，我们通常称为高级调度设置机制：&lt;br&gt;&lt;strong&gt;节点选择器: nodeSelector, nodeName&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;节点亲和调度: nodeAffinity&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;示例1：nodeSelector&quot;&gt;&lt;a href=&quot;#示例1：nodeSelector&quot; class=&quot;headerlink&quot; title=&quot;示例1：nodeSelector&quot;&gt;&lt;/a&gt;示例1：nodeSelector&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# mkdir schedule&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cd schedule/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# vim pod-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-schedule-demo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    wisedu.com/created-by: &amp;quot;cluster admin&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  nodeSelector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    disktype: ssd&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/230.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get nodes --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       STATUS   ROLES    AGE    VERSION   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;hadoop16   Ready    &amp;lt;none&amp;gt;   40d    v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=hadoop16,kubernetes.io/os=linux&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark17    Ready    &amp;lt;none&amp;gt;   157d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=spark17,kubernetes.io/os=linux&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32    Ready    master   157d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=spark32,kubernetes.io/os=linux,node-role.kubernetes.io/master=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ubuntu31   Ready    &amp;lt;none&amp;gt;   157d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=ssd,kubernetes.io/arch=amd64,kubernetes.io/hostname=ubuntu31,kubernetes.io/os=linux&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                READY   STATUS    RESTARTS   AGE     IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-schedule-demo   1/1     Running   0          2m19s   10.244.2.76   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此前在集群中一个节点ubuntu31上打上过标签 disktype=ssd，所以这个Pod运行会运行在这个节点上。打标签和删除标签的方式如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label node ubuntu31 disktype=ssd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/ubuntu31 labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label node ubuntu31 disktype-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/ubuntu31 labeled&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;当从node节点上删除这个 disktype=ssd 标签，只要删除前pod已经运行在这个节点上，那么删除这个标签，pod依然会运行着，不会因此而终止。&lt;br&gt;现在来修改下这个pod的nodeSelector的值，需要先删除这个pod，修改完重新apply一下这个清单文件：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl delete -f pod-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-schedule-demo&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# vim pod-demo.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/231.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl apply -f pod-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-schedule-demo created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-schedule-demo   0/1     Pending   0          8s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此时pod一直处于pending状态。这也就意味着nodeSelector是强约束，在预选阶段就不能满足了。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl describe pod pod-schedule-demo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Events:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Type     Reason            Age                From               Message&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ----     ------            ----               ----               -------&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Warning  FailedScheduling  10s (x3 over 79s)  default-scheduler  0/4 nodes are available: 4 node(s) didn&amp;apos;t match node selector.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;给集群中其中一个节点打上该标签，pod立马被调度到这台节点上运行了：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl label node spark17 disktype=harddisk&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/spark17 labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                READY   STATUS    RESTARTS   AGE     IP            NODE      NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-schedule-demo   1/1     Running   0          2m25s   10.244.1.36   spark17   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl delete -f pod-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-schedule-demo&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;示例2：pods-spec-affinity中nodeAffinity&quot;&gt;&lt;a href=&quot;#示例2：pods-spec-affinity中nodeAffinity&quot; class=&quot;headerlink&quot; title=&quot;示例2：pods.spec.affinity中nodeAffinity&quot;&gt;&lt;/a&gt;示例2：pods.spec.affinity中nodeAffinity&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.spec.affinity&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: affinity &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     If specified, the pod&amp;apos;s scheduling constraints&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Affinity is a group of affinity scheduling rules.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   nodeAffinity &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Describes node affinity scheduling rules for the pod.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   podAffinity  &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Describes pod affinity scheduling rules (e.g. co-locate this pod in the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     same node, zone, etc. as some other pod(s)).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   podAntiAffinity      &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Describes pod anti-affinity scheduling rules (e.g. avoid putting this pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     in the same node, zone, etc. as some other pod(s)).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.spec.affinity.nodeAffinity&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: nodeAffinity &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Describes node affinity scheduling rules for the pod.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Node affinity is a group of node affinity scheduling rules.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   preferredDuringSchedulingIgnoredDuringExecution      &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The scheduler will prefer to schedule pods to nodes that satisfy the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     affinity expressions specified by this field, but it may choose a node that&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     violates one or more of the expressions. The node that is most preferred is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the one with the greatest sum of weights, i.e. for each node that meets all&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     of the scheduling requirements (resource request, requiredDuringScheduling&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     affinity expressions, etc.), compute a sum by iterating through the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     elements of this field and adding &amp;quot;weight&amp;quot; to the sum if the node matches&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the corresponding matchExpressions; the node(s) with the highest sum are&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the most preferred.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   requiredDuringSchedulingIgnoredDuringExecution       &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     If the affinity requirements specified by this field are not met at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     scheduling time, the pod will not be scheduled onto the node. If the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     affinity requirements specified by this field cease to be met at some point&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     during pod execution (e.g. due to an update), the system may or may not try&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     to eventually evict the pod from its node.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;preferredDuringSchedulingIgnoredDuringExecution      &amp;lt;[]Object&amp;gt;&lt;br&gt;倾向，尽量满足的条件。不满足也行。尽量运行在满足这里定义的亲和条件的节点上。&lt;/li&gt;
&lt;li&gt;requiredDuringSchedulingIgnoredDuringExecution       &lt;object&gt;&lt;br&gt;硬亲和性，必须得满足的条件。如果用required，实现的效果就和nodeSelector一样，如果没有任何节点满足这里的亲和定义，那么一定不会去运行，就处于pending状态了。&lt;/object&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: requiredDuringSchedulingIgnoredDuringExecution &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     If the affinity requirements specified by this field are not met at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     scheduling time, the pod will not be scheduled onto the node. If the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     affinity requirements specified by this field cease to be met at some point&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     during pod execution (e.g. due to an update), the system may or may not try&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     to eventually evict the pod from its node.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     A node selector represents the union of the results of one or more label&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     queries over a set of nodes; that is, it represents the OR of the selectors&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     represented by the node selector terms.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   nodeSelectorTerms    &amp;lt;[]Object&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Required. A list of node selector terms. The terms are ORed.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You have mail in /var/spool/mail/root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: nodeSelectorTerms &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Required. A list of node selector terms. The terms are ORed.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     A null or empty node selector term matches no objects. The requirements of&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     them are ANDed. The TopologySelectorTerm type implements a subset of the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     NodeSelectorTerm.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   matchExpressions     &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     A list of node selector requirements by node&amp;apos;s labels.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   matchFields  &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     A list of node selector requirements by node&amp;apos;s fields.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;matchExpressions     &amp;lt;[]Object&amp;gt;&lt;br&gt;A list of node selector requirements by node’s labels. 匹配表达式的&lt;/li&gt;
&lt;li&gt;matchFields  &amp;lt;[]Object&amp;gt;&lt;br&gt;A list of node selector requirements by node’s fields. 匹配字段的&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;下面定义示例yaml文件：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# vim pod-nodeaffinity.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-nodeaffinity-demo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    wisedu.com/created-by: &amp;quot;cluster admin&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  affinity:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    nodeAffinity:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      requiredDuringSchedulingIgnoredDuringExecution:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        nodeSelectorTerms:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - matchExpressions:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          - key: zone&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            operator: In&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            values: [&amp;quot;foo&amp;quot;, &amp;quot;bar&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl apply -f pod-nodeaffinity.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-nodeaffinity-demo created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;清单中定义的是硬亲和性，目前还没有节点拥有标签zone，并且值在foo和bar内。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                    READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-nodeaffinity-demo   0/1     Pending   0          5s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;找一个集群中的节点打上一个标签 zone=bar:&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl label node hadoop16 zone=bar&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/hadoop16 labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                     READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-nodeaffinity-demo    1/1     Running   0          11m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;删除标签和pod：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl label node hadoop16 zone-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/hadoop16 labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl delete -f pod-nodeaffinity.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-nodeaffinity-demo&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;下面定义一个软亲和性的清单文件（即使定义的条件不满足，也会勉为其难地找一个节点运行pod）：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# vim pod-nodeaffinity-demo2.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-nodeaffinity-demo2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    wisedu.com/created-by: &amp;quot;cluster admin&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  affinity:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    nodeAffinity:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      preferredDuringSchedulingIgnoredDuringExecution:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - preference:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          matchExpressions:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          - key: zone&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            operator: In&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            values: [&amp;quot;foo&amp;quot;, &amp;quot;bar&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        weight: 60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl apply -f pod-nodeaffinity-demo2.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-nodeaffinity-demo2 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                     READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-nodeaffinity-demo2   1/1     Running   0          6s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;删除这个pod：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl delete -f pod-nodeaffinity-demo2.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-nodeaffinity-demo2&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;示例3：pods-spec-affinity中的podAffinity和podAntiAffinity&quot;&gt;&lt;a href=&quot;#示例3：pods-spec-affinity中的podAffinity和podAntiAffinity&quot; class=&quot;headerlink&quot; title=&quot;示例3：pods.spec.affinity中的podAffinity和podAntiAffinity&quot;&gt;&lt;/a&gt;示例3：pods.spec.affinity中的podAffinity和podAntiAffinity&lt;/h2&gt;&lt;p&gt;一般是出于高效通信的需求，偶尔需要把一些pod对象组织在相近的位置，比如运行在同一节点，同一机架，同一区域，同一地区等等，这样子pod和pod通信效率更高。&lt;br&gt;主要目的是把pod运行在一起，或不运行在一起，其实通过节点亲和性就能达到目的。比如3个Pod，NMP，使用3个同样的节点标签，而后我们在节点上打标签的时候就确保它3个选择的标签的节点就在同一个位置，就在同一个机架上，也能达到这个目的。但是为何还要定义pod亲和性和反亲和性呢？是因为使用节点亲和性去限制pod，它不是一种较优的选择方式，需要精心布局节点是被打上什么标签的才能实现目的。这种方式使用起来可能难度较大。&lt;br&gt;较理想的方式是，允许调度器把第一个Pod随机选择一个位置，但是第二个Pod就要根据第一个pod所在的位置来进行调度。Pod的亲和性并不强制一定要在同一个节点，相近的就可以了。所以要定义什么叫同一位置，什么叫不同位置。&lt;br&gt;如何判定是哪些节点是相同位置，哪些节点是不同位置是需要定义的。比如现在有4个正常运行的主机，当第一个Pod运行在第一个节点上之后，如何判定第2、3、4节点是否可以运行与第一个Pod亲和的Pod？比如NMP是亲和的，N被放在了第一个节点，M是应该放在第一个节点上，还是其他节点都不能放？Pod的亲和性并不强制一定要在同一个节点，非要把NMP放在同一个节点，假如这个节点资源不够，这样也不是一个最佳选择。比如我们定义，把N、M、P分别运行在一个节点上，只要这3个节点在一个机柜内，那就认为这是满足亲和条件的。所以在定义Pod亲和性时必须有个判断前提，Pod和Pod要在同一位置和不要在同一位置的判断标准是什么。因此什么叫同一位置，什么叫不同位置就很关键了。当以节点名称来判定这几个节点是不是同一位置，很显然这4个节点都是不同的位置。节点名相同的就认为是同一位置，不同的就认为是不同位置。所以如果把N这个Pod运行在节点1上，M和P也是会被调度到节点1上的。&lt;br&gt;换个判定标准，比如判定是否是同一位置的标准是：节点标签rack(机架)相同的就是同一位置。比如rack=rack1，两个节点都有这个标签，并且值为rack1的，那么两个节点就是同一位置。另外两个节点的标签是rack=rack2。所以此时假如第一个Pod运行在第一个节点上，也就是rack=rack1的节点上，那么M和P可以运行在第一个和第二个节点上。&lt;/p&gt;
&lt;h3 id=&quot;podAffinity&quot;&gt;&lt;a href=&quot;#podAffinity&quot; class=&quot;headerlink&quot; title=&quot;podAffinity&quot;&gt;&lt;/a&gt;podAffinity&lt;/h3&gt;&lt;p&gt;Pod亲和性也有硬亲和性和软亲和性。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.affinity.podAffinity&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: podAffinity &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Describes pod affinity scheduling rules (e.g. co-locate this pod in the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     same node, zone, etc. as some other pod(s)).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Pod affinity is a group of inter pod affinity scheduling rules.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   preferredDuringSchedulingIgnoredDuringExecution      &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The scheduler will prefer to schedule pods to nodes that satisfy the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     affinity expressions specified by this field, but it may choose a node that&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     violates one or more of the expressions. The node that is most preferred is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the one with the greatest sum of weights, i.e. for each node that meets all&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     of the scheduling requirements (resource request, requiredDuringScheduling&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     affinity expressions, etc.), compute a sum by iterating through the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     elements of this field and adding &amp;quot;weight&amp;quot; to the sum if the node has pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     which matches the corresponding podAffinityTerm; the node(s) with the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     highest sum are the most preferred.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   requiredDuringSchedulingIgnoredDuringExecution       &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     If the affinity requirements specified by this field are not met at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     scheduling time, the pod will not be scheduled onto the node. If the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     affinity requirements specified by this field cease to be met at some point&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     during pod execution (e.g. due to a pod label update), the system may or&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     may not try to eventually evict the pod from its node. When there are&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     multiple elements, the lists of nodes corresponding to each podAffinityTerm&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     are intersected, i.e. all terms must be satisfied.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.affinity.podAffinity.requiredDuringSchedulingIgnoredDuringExecution&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: requiredDuringSchedulingIgnoredDuringExecution &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     If the affinity requirements specified by this field are not met at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     scheduling time, the pod will not be scheduled onto the node. If the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     affinity requirements specified by this field cease to be met at some point&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     during pod execution (e.g. due to a pod label update), the system may or&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     may not try to eventually evict the pod from its node. When there are&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     multiple elements, the lists of nodes corresponding to each podAffinityTerm&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     are intersected, i.e. all terms must be satisfied.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Defines a set of pods (namely those matching the labelSelector relative to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the given namespace(s)) that this pod should be co-located (affinity) or&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     not co-located (anti-affinity) with, where co-located is defined as running&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     on a node whose value of the label with key &amp;lt;topologyKey&amp;gt; matches that of&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     any node on which a pod of the set of pods is running&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   labelSelector        &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     A label query over a set of resources, in this case pods.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   namespaces   &amp;lt;[]string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     namespaces specifies which namespaces the labelSelector applies to (matches&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     against); null or empty list means &amp;quot;this pod&amp;apos;s namespace&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   topologyKey  &amp;lt;string&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     This pod should be co-located (affinity) or not co-located (anti-affinity)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     with the pods matching the labelSelector in the specified namespaces, where&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     co-located is defined as running on a node whose value of the label with&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     key topologyKey matches that of any node on which any of the selected pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     is running. Empty topologyKey is not allowed.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;labelSelector        &lt;object&gt;&lt;br&gt;A label query over a set of resources, in this case pods. 和哪个Pod亲和，用来选定一组pod&lt;/object&gt;&lt;/li&gt;
&lt;li&gt;namespaces   &amp;lt;[]string&amp;gt;&lt;br&gt;namespaces specifies which namespaces the labelSelector applies to (matches against); null or empty list means “this pod’s namespace” 指明labelSelector匹配到一组pod到底是哪个名称空间的，不指意味着与要创建的新pod一个名称空间的&lt;/li&gt;
&lt;li&gt;topologyKey  &lt;string&gt; -required-&lt;br&gt;位置拓扑的键，用来判定是不是同一个位置。用哪个键来判定是不是同一位置&lt;/string&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;接下来定义两个pod，第一个是基准，第二个跟第一个走。&lt;/strong&gt;&lt;br&gt;每一个节点都有个标签叫 kubernetes.io/hostname。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get nodes --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       STATUS   ROLES    AGE    VERSION   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;hadoop16   Ready    &amp;lt;none&amp;gt;   40d    v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=hadoop16,kubernetes.io/os=linux&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark17    Ready    &amp;lt;none&amp;gt;   157d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=harddisk,kubernetes.io/arch=amd64,kubernetes.io/hostname=spark17,kubernetes.io/os=linux&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32    Ready    master   157d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=spark32,kubernetes.io/os=linux,node-role.kubernetes.io/master=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ubuntu31   Ready    &amp;lt;none&amp;gt;   157d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=ssd,kubernetes.io/arch=amd64,kubernetes.io/hostname=ubuntu31,kubernetes.io/os=linux&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# vim pod-podaffinity-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-podaffinity-first&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;---&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-podaffinity-second&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: backend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: db&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: busybox&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: busybox:latest&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    command: [&amp;quot;sh&amp;quot;, &amp;quot;-c&amp;quot;, &amp;quot;sleep 3600&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  affinity:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    podAffinity:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      requiredDuringSchedulingIgnoredDuringExecution:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - labelSelector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          matchExpressions:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          #- &amp;#123;key: app, operator: In, values: [&amp;quot;myapp&amp;quot;]&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          - key: app&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            operator: In&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            values: [&amp;quot;myapp&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        topologyKey: kubernetes.io/hostname&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/232.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl apply -f pod-podaffinity-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-podaffinity-first created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-podaffinity-second created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                     READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-podaffinity-first    1/1     Running   0          7s    10.244.2.77   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-podaffinity-second   1/1     Running   0          6s    10.244.2.78   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;两个pod都运行在第二个节点上。&lt;br&gt;删除这两个pod：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl delete -f pod-podaffinity-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-podaffinity-first&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-podaffinity-second&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;podAntiAffinity&quot;&gt;&lt;a href=&quot;#podAntiAffinity&quot; class=&quot;headerlink&quot; title=&quot;podAntiAffinity&quot;&gt;&lt;/a&gt;podAntiAffinity&lt;/h3&gt;&lt;p&gt;podAffinity和podAntiAffinity区别是：二者的标签的值不能是相同的。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# vim pod-podantiaffinity-demo.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/233.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl apply -f pod-podantiaffinity-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-podaffinity-first created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-podaffinity-second created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                     READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-podaffinity-first    1/1     Running   0          7s    10.244.2.79   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-podaffinity-second   1/1     Running   0          7s    10.244.1.40   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;一定不在同一个节点上。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl delete -f pod-podantiaffinity-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-podaffinity-first&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-podaffinity-second&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;将集群中的三个node节点，都打上同一个标签 zone=foo，其中spark32为master节点：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get nodes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       STATUS   ROLES    AGE    VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;hadoop16   Ready    &amp;lt;none&amp;gt;   40d    v1.14.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark17    Ready    &amp;lt;none&amp;gt;   157d   v1.14.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32    Ready    master   157d   v1.14.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ubuntu31   Ready    &amp;lt;none&amp;gt;   157d   v1.14.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl label node spark17 zone=foo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/spark17 labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl label node ubuntu31 zone=foo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/ubuntu31 labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl label node hadoop16 zone=foo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/hadoop16 labeled&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;修改 pod-podantiaffinity-demo.yaml 中topologyKey的值：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/234.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl apply -f pod-podantiaffinity-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-podaffinity-first created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-podaffinity-second created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods -o wide                                    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                     READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-podaffinity-first    1/1     Running   0          2s    10.244.2.81   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-podaffinity-second   0/1     Pending   0          2s    &amp;lt;none&amp;gt;        &amp;lt;none&amp;gt;     &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;第一个Pod在运行，第二个Pod处于pending状态。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl delete -f pod-podantiaffinity-demo.yaml     &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-podaffinity-first&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-podaffinity-second&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;示例4：污点调度&quot;&gt;&lt;a href=&quot;#示例4：污点调度&quot; class=&quot;headerlink&quot; title=&quot;示例4：污点调度&quot;&gt;&lt;/a&gt;示例4：污点调度&lt;/h2&gt;&lt;p&gt;污点就是定义在节点上的键值数据。键值数据有三类：标签、注解、污点。污点是运行在节点上的，不像标签和注解，所有资源都能用。&lt;br&gt;这就给了节点选择权，给节点打一些污点，pod不容忍就不能运行上来。我们需要在Pod上定义容忍度。容忍度tolerations是Pod对象上的第三种键值数据。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl explain nodes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl explain nodes.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl explain nodes.spec.taints&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Node&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: taints &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     If specified, the node&amp;apos;s taints.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The node this Taint is attached to has the &amp;quot;effect&amp;quot; on any pod that does&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     not tolerate the Taint.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   effect       &amp;lt;string&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Required. The effect of the taint on pods that do not tolerate the taint.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Valid effects are NoSchedule, PreferNoSchedule and NoExecute.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   key  &amp;lt;string&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Required. The taint key to be applied to a node.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   timeAdded    &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     TimeAdded represents the time at which the taint was added. It is only&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     written for NoExecute taints.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   value        &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Required. The taint value corresponding to the taint key.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;effect       &lt;string&gt; -required-&lt;br&gt;当Pod不能容忍这个污点时，要采取的行为是什么。taint的effect定义对Pod排斥效果: &lt;/string&gt;&lt;/li&gt;
&lt;li&gt;NoSchedule:仅影响调度过程,对现存的Pod对象不产生影响; &lt;/li&gt;
&lt;li&gt;NoExecute:既影响调度过程,也影响现在的Pod对象;不容忍的Pod对象将被驱逐; &lt;/li&gt;
&lt;li&gt;PreferNoSchedule: 不能容忍，但是没地方运行也可以过来运行。最好不，表示也可以。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在Pod对象上定义容忍度的时候，还支持两种操作。&lt;strong&gt;等值比较和存在性判断&lt;/strong&gt;。所谓等值比较，需要在key、value、effect上完全匹配。存在性判断表示二者的key和effect必须匹配，但是value可以使用空值，即判断存在不存在与否即可。一个节点可以配置多个污点，一个Pod也可以有多个容忍度。只不过二者匹配时要遵循如下的逻辑。&lt;br&gt;比如在Pod上定义了3个容忍度，在节点之上定义了2个污点，这个pod一定能运行在这个节点上吗？不一定，pod容忍了其中一个污点，另外一个没有容忍，这种情况是可能的。要逐一检查节点的污点，节点的每一个污点都必须被Pod容忍。如果某个污点被Pod的容忍度匹配到了，那么这个污点就过了，检查下一个。如果存在污点不被pod所容忍，就要看这个污点的条件了。如果这个污点的行为是PreferNoSchedule，那么事实上还是可以运行在这个节点上的。但是如果这个污点的行为是NoSchedule，就一定不能被调度到这个节点上了。&lt;br&gt;此前在运行pod时，没有一个pod会被调度到master节点上运行，是因为master上默认就有污点，我们定义的Pod都没有去定义容忍度去匹配master节点上的这个污点。master是用来运行集群控制平面组件的，可以看看这几个Pod，肯定定义了容忍度去匹配这个污点。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/235.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;master节点上打的污点，value为空值，即判断表示存在不存在。&lt;br&gt;看下api-server这个pod中定义的容忍度：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pod kube-apiserver-spark32 -n kube-system -o yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/236.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;管理节点的污点：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl taint --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Update the taints on one or more nodes.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  *  A taint consists of a key, value, and effect. As an argument here, it is expressed as key=value:effect.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  *  The key must begin with a letter or number, and may contain letters, numbers, hyphens, dots, and underscores, up to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;253 characters.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  *  Optionally, the key can begin with a DNS subdomain prefix and a single &amp;apos;/&amp;apos;, like example.com/my-app&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  *  The value must begin with a letter or number, and may contain letters, numbers, hyphens, dots, and underscores, up&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;to  63 characters.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  *  The effect must be NoSchedule, PreferNoSchedule or NoExecute.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  *  Currently taint can only apply to node.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Update node &amp;apos;foo&amp;apos; with a taint with key &amp;apos;dedicated&amp;apos; and value &amp;apos;special-user&amp;apos; and effect &amp;apos;NoSchedule&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # If a taint with that key and effect already exists, its value is replaced as specified.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl taint nodes foo dedicated=special-user:NoSchedule&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Remove from node &amp;apos;foo&amp;apos; the taint with key &amp;apos;dedicated&amp;apos; and effect &amp;apos;NoSchedule&amp;apos; if one exists.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl taint nodes foo dedicated:NoSchedule-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Remove from node &amp;apos;foo&amp;apos; all the taints with key &amp;apos;dedicated&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl taint nodes foo dedicated-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Add a taint with key &amp;apos;dedicated&amp;apos; on nodes having label mylabel=X&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl taint node -l myLabel=X  dedicated=foo:PreferNoSchedule&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Options:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --all=false: Select all nodes in the cluster&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --allow-missing-template-keys=true: If true, ignore any errors in templates when a field or map key is missing in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the template. Only applies to golang and jsonpath output formats.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -o, --output=&amp;apos;&amp;apos;: Output format. One of:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;json|yaml|name|go-template|go-template-file|template|templatefile|jsonpath|jsonpath-file.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --overwrite=false: If true, allow taints to be overwritten, otherwise reject taint updates that overwrite existing&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;taints.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -l, --selector=&amp;apos;&amp;apos;: Selector (label query) to filter on, supports &amp;apos;=&amp;apos;, &amp;apos;==&amp;apos;, and &amp;apos;!=&amp;apos;.(e.g. -l key1=value1,key2=value2)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --template=&amp;apos;&amp;apos;: Template string or path to template file to use when -o=go-template, -o=go-template-file. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;template format is golang templates [http://golang.org/pkg/text/template/#pkg-overview].&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --validate=true: If true, use a schema to validate the input before sending it&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl taint NODE NAME KEY_1=VAL_1:TAINT_EFFECT_1 ... KEY_N=VAL_N:TAINT_EFFECT_N [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl options&amp;quot; for a list of global command-line options (applies to all commands).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;现在集群中有3个node节点，给其中两个node节点打上污点如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl taint node spark17 node-type=production:NoSchedule         &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/spark17 tainted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl taint node ubuntu31 node-type=production:NoSchedule &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/ubuntu31 tainted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get node ubuntu31 -o yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  podCIDR: 10.244.2.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  taints:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - effect: NoSchedule&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    key: node-type&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    value: production&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl describe node ubuntu31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Taints:             node-type=production:NoSchedule&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;定义一个Deployment，不定义其中Pod的污点容忍度：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# vim deploy-taint-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: myapp-deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  replicas: 3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    matchLabels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  template:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        image: ikubernetes/myapp:v2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          containerPort: 80&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl apply -f deploy-taint-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/myapp-deploy created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                            READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-99xj9   1/1     Running   0          7s    10.244.3.18   hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-scqtz   1/1     Running   0          7s    10.244.3.19   hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-wsrdp   1/1     Running   0          7s    10.244.3.17   hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这样这个Deployment中的Pod都运行在没打污点的那个节点上。&lt;/p&gt;
&lt;p&gt;将没打污点的节点hadoop16也打上污点，并且effect为NoExecute：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl taint node hadoop16 node-type=production:NoExecute&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/hadoop16 tainted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                            READY   STATUS        RESTARTS   AGE     IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-99xj9   1/1     Terminating   0          2m38s   10.244.3.18   hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-bl5nk   0/1     Pending       0          2s      &amp;lt;none&amp;gt;        &amp;lt;none&amp;gt;     &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-fdmq2   0/1     Pending       0          2s      &amp;lt;none&amp;gt;        &amp;lt;none&amp;gt;     &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-scqtz   1/1     Terminating   0          2m38s   10.244.3.19   hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-wsrdp   1/1     Terminating   0          2m38s   10.244.3.17   hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-xd98m   0/1     Pending       0          2s      &amp;lt;none&amp;gt;        &amp;lt;none&amp;gt;     &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                            READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-bl5nk   0/1     Pending   0          18s   &amp;lt;none&amp;gt;   &amp;lt;none&amp;gt;   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-fdmq2   0/1     Pending   0          18s   &amp;lt;none&amp;gt;   &amp;lt;none&amp;gt;   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-xd98m   0/1     Pending   0          18s   &amp;lt;none&amp;gt;   &amp;lt;none&amp;gt;   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;运行在hadoop16上的pod被驱逐了。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;下面看看如何在pod上定义tolerations。&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl explain pods.spec.tolerations&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: tolerations &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     If specified, the pod&amp;apos;s tolerations.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The pod this Toleration is attached to tolerates any taint that matches the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     triple &amp;lt;key,value,effect&amp;gt; using the matching operator &amp;lt;operator&amp;gt;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   effect       &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Effect indicates the taint effect to match. Empty means match all taint&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     effects. When specified, allowed values are NoSchedule, PreferNoSchedule&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     and NoExecute.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   key  &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Key is the taint key that the toleration applies to. Empty means match all&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     taint keys. If the key is empty, operator must be Exists; this combination&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     means to match all values and all keys.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   operator     &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Operator represents a key&amp;apos;s relationship to the value. Valid operators are&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Exists and Equal. Defaults to Equal. Exists is equivalent to wildcard for&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     value, so that a pod can tolerate all taints of a particular category.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   tolerationSeconds    &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     TolerationSeconds represents the period of time the toleration (which must&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     be of effect NoExecute, otherwise this field is ignored) tolerates the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     taint. By default, it is not set, which means tolerate the taint forever&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     (do not evict). Zero and negative values will be treated as 0 (evict&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     immediately) by the system.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   value        &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Value is the taint value the toleration matches to. If the operator is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Exists, the value should be empty, otherwise just a regular string.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;tolerationSeconds：被驱逐时可以等待多久被驱逐，默认是0，立即驱逐。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;修改deploy-taint-demo.yaml，定义tolerations：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# vim deploy-taint-demo.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl apply -f deploy-taint-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/myapp-deploy configured&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods -o wide    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                            READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-6bc4494c9b-695lm   1/1     Running   0          7s    10.244.1.43   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-6bc4494c9b-qjg2h   1/1     Running   0          11s   10.244.2.82   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-6bc4494c9b-qsslj   1/1     Running   0          9s    10.244.1.42   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;运行在了spark17和ubuntu31节点上。将spark17上污点的effect改为NoExecute：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl taint node spark17 node-type=production:NoExecute&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/spark17 tainted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                            READY   STATUS              RESTARTS   AGE    IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-6bc4494c9b-695lm   1/1     Terminating         0          96s    10.244.1.43   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-6bc4494c9b-mtxp2   0/1     ContainerCreating   0          2s     &amp;lt;none&amp;gt;        ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-6bc4494c9b-pl5j9   0/1     ContainerCreating   0          2s     &amp;lt;none&amp;gt;        ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-6bc4494c9b-qjg2h   1/1     Running             0          100s   10.244.2.82   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-6bc4494c9b-qsslj   0/1     Terminating         0          98s    10.244.1.42   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                            READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-6bc4494c9b-mtxp2   1/1     Running   0          22s   10.244.2.84   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-6bc4494c9b-pl5j9   1/1     Running   0          22s   10.244.2.83   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-6bc4494c9b-qjg2h   1/1     Running   0          2m    10.244.2.82   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果想让pod调度到spark17和hadoop16上，必须使得effect值也一样。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/237.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl apply -f deploy-taint-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/myapp-deploy configured&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 schedule]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                            READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-84dd787cff-nz899   1/1     Running   0          8s    10.244.1.44   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-84dd787cff-rcgwq   1/1     Running   0          5s    10.244.3.20   hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-84dd787cff-zjsr9   1/1     Running   0          11s   10.244.2.85   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;去掉三个节点上的污点：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl taint node spark17 node-type-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/spark17 untainted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl taint node hadoop16 node-type-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/hadoop16 untainted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl taint node ubuntu31 node-type-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/ubuntu31 untainted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;scheduler调度过程概述&quot;&gt;&lt;a href=&quot;#scheduler调度过程概述&quot; class=&quot;headerlink&quot; title=&quot;scheduler调度过程概述&quot;&gt;&lt;/a&gt;scheduler调度过程概述&lt;/h2&gt;&lt;p&gt;scheduler在实现调度时，分为三步实现调度过程。首先是预选，从所有节点当中选择基本符合条件的节点；而后在众多符合条件的节点当中，在使用优选函数去计算各自的得分并且加以比较，并从最高得分的节点当中随机选择出一个作为运行Pod的节点。这就是控制平面当中scheduler所实现负责的主要工作。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>调度器、预选策略及优选函数</title>
    <link href="http://yoursite.com/2019/09/23/%E8%B0%83%E5%BA%A6%E5%99%A8%E3%80%81%E9%A2%84%E9%80%89%E7%AD%96%E7%95%A5%E5%8F%8A%E4%BC%98%E9%80%89%E5%87%BD%E6%95%B0/"/>
    <id>http://yoursite.com/2019/09/23/调度器、预选策略及优选函数/</id>
    <published>2019-09-23T09:09:23.000Z</published>
    <updated>2019-09-23T09:18:42.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Kubernetes整体架构概述&quot;&gt;&lt;a href=&quot;#Kubernetes整体架构概述&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes整体架构概述&quot;&gt;&lt;/a&gt;Kubernetes整体架构概述&lt;/h2&gt;&lt;p&gt;master从本质上来讲主要是运行整个集群的控制平面组件的，比如三个最核心的组件：apiserver、Scheduler、Controller-manger。除此之外，master还依赖etcd这样的存储节点，最好还是个有冗余能力的存储集群。使用kubeadm部署时会把这个控制平面部署为了pod应用程序，但是是部署为静态Pod的。从本质上来讲，我们可以认为这几个pod就是简单的运行在master节点本地的守护进程，从这个角度来讲，master本身是不负责运行任何工作负载的。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;所有的工作节点才是真正去运行工作负载的Pod的节点，终端用户以后在运行Pod时只需要提交给master就行了，甚至不用关心对应自己的Pod运行在哪个节点之上，因为工作节点被master组织成为一个庞大的虚拟资源池。虚拟资源池中，cpu、ram、存储卷等通通整合为统一的视角向客户端进行提供。但是对于集群管理员来讲，这个虚拟资源池不是所关注的根本，应该关心底层这些pod应该更加优化的部署在哪些节点上。当用户请求创建一个Pod资源对象时，应该运行在哪个节点上，是由控制平面当中的Scheduler来做决策的。Scheduler是可以自定义的。&lt;br&gt;当用户提交创建pod请求到apiserver后，apiserver检查权限都没有任何问题的话，接下来会把请求交由Scheduler，(Scheduler是一个守护进程，内部有很多调度算法，调度算法是可以换的，默认用的是default Scheduler，) 由Scheduler从众多节点当中选择一个匹配的节点来作为接下来运行此Pod的节点，注意它的选择结果并不是直接反应在节点之上的，它的选择结果会告诉apiserver，apiserver会将选择的结果会被记录在etcd中，然后apiserver会指挥着被选定节点上的kubelet，或者说是kubelet始终去watch着apiserver与当前节点相关连的事件变动，接下来kubelet去获取到apiserver中定义的配置清单，去创建Pod。清单中会定义镜像拉取策略，仓库地址等配置。这些都是kubelet要完成的任务。当然建议使用控制器去创建Pod。&lt;br&gt;因为Pod是有生命周期的，所以必要的时候在前端加一个service，以提供一个固定的访问端点。service并不是一个实实在在的组件，它是所有节点上相关iptables或ipvs规则，因此当用户通过kubectl或其他客户端创建一个service时，这个请求一样提供给apiserver，apiserver检查权限后，开始创建service。这个service的创建一样要存储在etcd中。在每个节点上还有个组件kube-proxy，kube-proxy会监控service资源相关的变动，然后把规则创建成节点上的iptables或ipvs规则。&lt;br&gt;kubelet和kube-proxy都需要去连接apiserver去获取某些资源定义，而apiserver可不是人人可以访问的，需要做认证、授权、准入控制。从这个角度来讲，kubelet和kube-proxy都是apiserver的客户端。而且他们之间实现数据传输时也要做数据序列化，序列化方案是protocolbuffers，Facebook还是google研发的非常底层的序列化方案。apiserver与kubectl这个客户端之间使用的序列化方案是json。&lt;/p&gt;
&lt;h2 id=&quot;Scheduler调度过程&quot;&gt;&lt;a href=&quot;#Scheduler调度过程&quot; class=&quot;headerlink&quot; title=&quot;Scheduler调度过程&quot;&gt;&lt;/a&gt;Scheduler调度过程&lt;/h2&gt;&lt;p&gt;Scheduler要考虑哪个节点是最佳运行pod的节点，default scheduler在默认实现调度决策时是通过是三个步骤(三级)来完成的。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;第一步，Predicate，预选&lt;/strong&gt;。假如现在有一堆节点，先去排除不符合此Pod运行条件的节点。在k8s中，Pod中定义容器可以定义两个维度的资源限制。第一，叫资源需求，意思是每一个节点，只有满足Pod的最低资源需求才能运行此Pod。比如这个pod至少需要运行2g内存，1核cpu，这是一种资源下限。第二，资源限额。在Pod使用过程中，有可能会超出定义的需求资源，最多能到多少呢？可以做资源限额，表示最多能用多少资源。很显然，这么多节点中，不是每一个节点剩余的可用资源都能满足此Pod的需求，不能满足就排除掉。当然还有其他一些条件，比如说在定义Pod时，要求共享宿主机网络名称空间，并且Pod中容器要监听在80端口上，那么那些节点上80端口被占用的节点就不符合要求了。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;第二步，Priority&lt;/strong&gt;，优选。基于一系列的算法函数，把每一个节点的属性输入进去，然后去计算每一个节点的优先级，计算完后进行排序。然后得分最高的，就是选定的节点。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;第三步，Select，选定&lt;/strong&gt;。将pod绑定在优选后的节点上。&lt;br&gt;假如出现一种极端情况，最后最高得分者有好几个，分数是一样的，这个时候就没有倾向性了。所以选定这个步骤是不可少的，因为最高得分的不一定是一个。最高分不止一个，就从中随机选择一个界定啊。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;特殊偏好：&lt;strong&gt;nodeName和nodeSelector&lt;/strong&gt;。只对某一些类型的节点有倾向性。这些在预选中，就会缩小很多范围了。&lt;/p&gt;
&lt;h2 id=&quot;特殊的调度方式&quot;&gt;&lt;a href=&quot;#特殊的调度方式&quot; class=&quot;headerlink&quot; title=&quot;特殊的调度方式&quot;&gt;&lt;/a&gt;特殊的调度方式&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;节点亲和调度: nodeAffinity&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Pod亲和调度和反亲和性：podAffinity  podUnAffinity&lt;/strong&gt; 有些时候我们期望某些个Pod运行在同一节点，或者是相邻的节点上，网络通信带宽可用性更大的节点。反亲和性：比如一个Pod运行了httpd，绑定在了物理节点的名称空间上，另外一个Pod要运行Nginx，也要绑定在一个物理节点上，如果这两个pod在一台主机上，同时监听80端口，就冲突了，这是反亲和性的例子。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;污点taints和污点容忍Tolerations：&lt;/strong&gt;这是反其道而行之的做法。一直在说Pod怎么选定哪些节点，但是也允许节点不让某些Pod来运行。可以给一些节点打上污点标识，说明这个节点是拥有不光彩、见不得人的一些事情存在。因此一个Pod是否能够运行在这些节点，就取决于这个Pod是否能容忍这些污点。我们在某些节点上打上一些污点标识，而后我们给Pod定义它的容忍污点能力，容忍哪些污点，它就能被调度到仅含有这些污点子集的节点上去。比如这个pod非常大度，能容忍10个污点，第一个节点由5个污点，正好这5个污点还是pod容忍度的子集，所以这个pod是可以运行在这个节点上的。如果这个节点后来不想让这个Pod运行了，我们可以在这个节点上多打一个污点，并且这个污点不在这个pod的容忍度内。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;常见的预选策略&quot;&gt;&lt;a href=&quot;#常见的预选策略&quot; class=&quot;headerlink&quot; title=&quot;常见的预选策略&quot;&gt;&lt;/a&gt;常见的预选策略&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/227.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/228.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;CheckNodeCondition: 检查节点本身是否正常，磁盘网络等是否可用。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;GeneralPredicates：不是一个单独的预选策略，包含好几个预选策略。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;HostName: 检查Pod对象是否定义了pod.spec.hostname, 如果定义了，检查节点的hostname是否与pod定义的这个值相匹配。pod.spec.hostname这个属性并不是定义这个Pod运行在有相同hostname值的节点上。意思在对应的节点上，这个pod名称还没有被使用，要不然在一个节点上Pod是不允许同名的。因为某些Pod名称是固定的，不是随机生成的。&lt;/li&gt;
&lt;li&gt;PodFitsHostPorts: pods.spec.containers.ports.hostPort，port能适配节点的端口。如果Pod中容器上定义了pods.spec.containers.ports.hostPort属性，指定绑定在节点的哪个端口上，如果你的节点这个端口已经被占用了，显然这个节点不符合条件了。&lt;/li&gt;
&lt;li&gt;MatchNodeSelector: pods.spec.nodeSelector&lt;/li&gt;
&lt;li&gt;PodFitsResources: 检查Pod的资源需求是否能被节点所满足，运行此Pod的最低配置是否满足。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;NoDiskConflict: 检查Pod依赖的存储卷是否能满足需求; 但是这个不是默认启用的策略。&lt;/li&gt;
&lt;li&gt;PodToleratesNodeTaints: 检查Pod上的spec.tolerations可容忍的污点是否完全包含节点上的污点;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;PodToleratesNodeNoExecuteTaints: 等后面讲污点和容忍度的时候在解释。检查Pod上的spec.tolerations可容忍的污点是否完全包含节点上定义的NoExecute类型的污点。污点有3重属性。就是本来pod能接纳这个节点的污点，在上面跑着，但是后来节点污点改了，改成Pod里面不包含的污点了，所以pod此时不能接纳这个节点了，默认是可以继续在节点运行的，但是NoExecute意味着不能容忍，会驱离Pod的。这个预选策略默认是不启用的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CheckNodeLabelPresence: 检查节点上指定标签的存在性。取决于用户定义，标签是用户自己定义的。这个预选策略默认不是启用的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CheckServiceAffinity: pod可能会属于一个或多个service，根据当前Pod对象所属的service已有的其他pod对象，其中有一部分已经调度到这个节点上了，有些节点并没有运行此service关联的Pod。将相同service的pod对象尽可能放置在同一个节点上。这个默认不是启用的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;MaxEBSVolumeCount：检查节点上已挂载的EBS存储卷的数量是否超出了最大设定值。EBS是亚马逊的弹性块存储。如果你的k8s使用EBS存储卷，一般来讲一个节点上最多只能挂载39个存储卷。有定义，默认就是39个。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;MaxGCEPDVolumeCount：google的GCE存储&lt;/li&gt;
&lt;li&gt;&lt;p&gt;MaxAzureDiskVolumeCount：亚马逊的存储AzureDisk    –这3个都是启用的，这3个都是CNCF成员&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CheckVolumeBinding: 检查节点上已绑定和未绑定的pvc是否满足Pod对象的存储卷需求&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;NoVolumeZoneConflict: Zone，机房逻辑范围划分&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CheckNodeMemoryPressure：检查节点内存是否存在压力。如果一个节点上内存资源已经比较紧缺了，表示这节点不符合条件，肯定是倾向压力不大节点。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;CheckNodePIDPressure：检查节点PID数量压力多大，PID资源紧缺。&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CheckNodeDiskPressure：磁盘IO是否过大&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;MatchInterPodAffinity：Pod和Pod之间也是有亲和性。检查节点是否满足Pod的亲和性或反亲和性。到底用哪个，取决于你定义的是亲和性还是反亲和性。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;调度器默认启用了的预选策略，是要检查所有启用了的预选策略。满足所有启用了的预选策略，节点才是满足条件的。&lt;/p&gt;
&lt;h2 id=&quot;常见的优选函数&quot;&gt;&lt;a href=&quot;#常见的优选函数&quot; class=&quot;headerlink&quot; title=&quot;常见的优选函数&quot;&gt;&lt;/a&gt;常见的优选函数&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/229.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;LeastRequested: 最少请求的节点。计算比率的。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;(cpu((capacity-sum(requested))*10/capacity)+memory((capacity-sum(requested))*10/capacity))/2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;BalancedResourceAllocation: CPU和内存资源被占用率相近的胜出;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;NodePreferAvoidPods:&lt;br&gt;节点倾向不要运行pods，根据节点是否有注解存在。如果给定的节点没有以下这个注解信息，得分为10，而且权重为1万，权重非常高。&lt;br&gt;节点注解信息“scheduler.alpha.kubernetes.io/preferAvoidPods”&lt;/li&gt;
&lt;li&gt;TaintToleration: 将Pod对象的spec.tolerations列表项与节点的taints列表项进行匹配度检查,匹配条目越多, 意味着节点污点越多，得分越低;&lt;/li&gt;
&lt;li&gt;SeletorSpreading: 标签选择器分散度。查找与当前Pod对象匹配的sevice、replication controller、ReplicaSet、StatefulSet等，看看与这些选择器匹配到的现存的Pod对象所在的节点有哪些个，已经运行此类pod对象越少的节点得分越高。spread：散开。&lt;/li&gt;
&lt;li&gt;InterPodAffinity: Pod亲和性。遍历Pod对象的亲和性条目，并将那些能够匹配到给定节点的条目的权重相加，结果值越大，得分越高。用pod自己去评估每个节点，能在多大程度上满足这个pod的亲和性，假如第一个节点它有两条能满足，第二个节点有三条能满足，显然第二个节点得分越高。&lt;/li&gt;
&lt;li&gt;&lt;p&gt;NodeAffinity: 节点亲和性。根据Pod中的nodeSelector对节点进行检查，能成功匹配的数量越多，得分越高。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;MostRequested: LeastRequested相反。两者不能同时使用。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;NodeLabel: 节点标签。根据节点是否拥有特定标签来评估得分。只关注标签，不关注值，标签存在就得分。&lt;/li&gt;
&lt;li&gt;ImageLocality: 根据满足当前Pod对象需求的已有镜像的体积大小之和。比如一个Pod内有3个容器，节点上镜像都有的得分最高。事实上不是这么算的，根据镜像体积来算的。&lt;br&gt;最后三个默认没有启用。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;预选是一票否决，只要有一个策略不满足，节点就不符合了。&lt;br&gt;优选函数是计算总得分的。每个函数都评估，然后将函数得分加起来。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Kubernetes整体架构概述&quot;&gt;&lt;a href=&quot;#Kubernetes整体架构概述&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes整体架构概述&quot;&gt;&lt;/a&gt;Kubernetes整体架构概述&lt;/h2&gt;&lt;p&gt;master从本质上来讲主要是运行整个集群的控制平面组件的，比如三个最核心的组件：apiserver、Scheduler、Controller-manger。除此之外，master还依赖etcd这样的存储节点，最好还是个有冗余能力的存储集群。使用kubeadm部署时会把这个控制平面部署为了pod应用程序，但是是部署为静态Pod的。从本质上来讲，我们可以认为这几个pod就是简单的运行在master节点本地的守护进程，从这个角度来讲，master本身是不负责运行任何工作负载的。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>基于canel的网络策略</title>
    <link href="http://yoursite.com/2019/09/18/%E5%9F%BA%E4%BA%8Ecanel%E7%9A%84%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5/"/>
    <id>http://yoursite.com/2019/09/18/基于canel的网络策略/</id>
    <published>2019-09-18T01:17:57.000Z</published>
    <updated>2019-09-19T01:16:31.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;flannel、calico和canel&quot;&gt;&lt;a href=&quot;#flannel、calico和canel&quot; class=&quot;headerlink&quot; title=&quot;flannel、calico和canel&quot;&gt;&lt;/a&gt;flannel、calico和canel&lt;/h2&gt;&lt;p&gt;calico的配置依赖于对BGP等协议的理解，我们这里不去使用calico作为网络插件提供网络功能了，而是把重点集中在calico如何提供网络策略，因为flannel本身提供不了网络策略，而flannel和calico二者已经合二为一了，有个新项目叫canel。可以在flannel提供网络功能的基础之上，在额外提供calico，去服务于网络策略。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;calico默认使用的网段不是10.244，calico如果被你拿来作网络插件使用的话，它工作在192.168.0.0网络，而且是16位掩码，分网络时就是192.168.0.0，192.168.1.0这样去给节点分网络。&lt;/p&gt;
&lt;h2 id=&quot;部署calico&quot;&gt;&lt;a href=&quot;#部署calico&quot; class=&quot;headerlink&quot; title=&quot;部署calico&quot;&gt;&lt;/a&gt;部署calico&lt;/h2&gt;&lt;p&gt;在kubernetes上部署calico有多种方式，在&lt;a href=&quot;https://docs.projectcalico.org/v3.9/getting-started/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;calico官方文档&lt;/a&gt;上有详细的介绍。&lt;br&gt;这里是在kubernetes上安装calico，我们需要参照的安装是：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/221.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;calico对集群中所有的地址分配，自己不记录，而是借助于etcd记录的。这事就比较麻烦了，k8s自己有一套etcd集群，calico也需要一套etcd集群，这样对k8s工程师不是个好事情。后来etcd支持不把数据放在自己专用的etcd中，而是调apiserver的功能，直接把所有的设置都发给apiserver，由apiserver存储在etcd中。因为k8s任何节点，任何功能、任何组件都不能直接写k8s的etcd，必须通过apiserver写，因为主要是确保数据一致性的。&lt;br&gt;对我们来说最简单的方式是使用k8s的etcd，这也是官方推荐的方式。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/222.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;部署canel：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# mkdir networkpolicy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cd networkpolicy/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# wget https://docs.projectcalico.org/v3.9/manifests/canal.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# kubectl apply -f canal.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;configmap/canal-config created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrole.rbac.authorization.k8s.io/calico-node created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrole.rbac.authorization.k8s.io/flannel configured&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrolebinding.rbac.authorization.k8s.io/canal-flannel created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrolebinding.rbac.authorization.k8s.io/canal-calico created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps/canal created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceaccount/canal created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# kubectl get pods -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                                    READY   STATUS     RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;canal-p9v5f                             0/2     Init:1/2   0          80s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;canal-sksfk                             0/2     Init:1/2   0          80s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;canal-zchqq                             0/2     Init:1/2   0          80s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;canal-zgwsq                             0/2     Init:1/2   0          80s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-t2xj8                 1/1     Running    0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-xdjkx                 1/1     Running    0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-spark32                            1/1     Running    1          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-apiserver-spark32                  1/1     Running    0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-controller-manager-spark32         1/1     Running    0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-2mcd2             1/1     Running    0          103m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-jsx8s             1/1     Running    0          103m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-kk8cx             1/1     Running    0          103m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-vdjn4             1/1     Running    0          103m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-czhfc                        1/1     Running    0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-gzhqw                        1/1     Running    0          41d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-rfxjw                        1/1     Running    0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-xmkxq                        1/1     Running    0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-scheduler-spark32                  1/1     Running    0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes-dashboard-5f7b999d65-ngrr7   1/1     Running    0          2d3h&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;等待pod运行起来。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/224.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;示例&quot;&gt;&lt;a href=&quot;#示例&quot; class=&quot;headerlink&quot; title=&quot;示例&quot;&gt;&lt;/a&gt;示例&lt;/h2&gt;&lt;p&gt;所谓的网络策略(Network Policy)，通过Egress和Ingress规则分别来控制不同的通信需求，Egress表示出站，Ingress表示入站。这里的Ingress和此前讲的Ingress规则是两回事。Egress表示Pod作为客户端去访问别人，或者是响应别人，就是自己作为源地址，对方作为目标地址来通信的。Ingress表示自己是目标地址，远程是源地址。&lt;br&gt;当定义Egress规则时，Pod作为客户端出站的时候去请求别人，自己的地址是固定的，端口是随机的，服务端的地址和端口一般是可预测的；当定义Ingress规则时，对方Pod来请求自己，自己的地址和端口是固定的，对方的地址和端口是没法预测的。所以我们去定义规则时，如果定义的是Egress规则，也就是出站规则，我们可以定义目标地址和目标端口，如果定义的是Ingress规则，也就是入站规则，能限制对方的地址和自己的端口。这种限制是针对哪一个Pod来说的呢？使用podSelector去选择Pod。&lt;br&gt;将来，如果每个名称空间托管了不同的项目，甚至不同客户的项目，可以给名称空间设置默认策略，在一个名称空间内，所有Pod可以无障碍通信，但是跨名称空间都不被允许。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/223.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain networkpolicy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     NetworkPolicy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DEPRECATED 1.9 - This group version of NetworkPolicy is deprecated by&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     networking/v1/NetworkPolicy. NetworkPolicy describes what network traffic&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     is allowed for a set of Pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   apiVersion   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     APIVersion defines the versioned schema of this representation of an&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     object. Servers should convert recognized schemas to the latest internal&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     value, and may reject unrecognized values. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#resources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   kind &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Kind is a string value representing the REST resource this object&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     represents. Servers may infer this from the endpoint the client submits&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     requests to. Cannot be updated. In CamelCase. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   metadata     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Standard object&amp;apos;s metadata. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Specification of the desired behavior for this NetworkPolicy.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain networkpolicy.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     NetworkPolicy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Specification of the desired behavior for this NetworkPolicy.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DEPRECATED 1.9 - This group version of NetworkPolicySpec is deprecated by&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     networking/v1/NetworkPolicySpec.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   egress       &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     List of egress rules to be applied to the selected pods. Outgoing traffic&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     is allowed if there are no NetworkPolicies selecting the pod (and cluster&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     policy otherwise allows the traffic), OR if the traffic matches at least&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     one egress rule across all of the NetworkPolicy objects whose podSelector&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     matches the pod. If this field is empty then this NetworkPolicy limits all&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     outgoing traffic (and serves solely to ensure that the pods it selects are&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     isolated by default). This field is beta-level in 1.8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   ingress      &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     List of ingress rules to be applied to the selected pods. Traffic is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     allowed to a pod if there are no NetworkPolicies selecting the pod OR if&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the traffic source is the pod&amp;apos;s local node, OR if the traffic matches at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     least one ingress rule across all of the NetworkPolicy objects whose&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     podSelector matches the pod. If this field is empty then this NetworkPolicy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     does not allow any traffic (and serves solely to ensure that the pods it&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     selects are isolated by default).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   podSelector  &amp;lt;Object&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Selects the pods to which this NetworkPolicy object applies. The array of&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ingress rules is applied to any pods selected by this field. Multiple&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     network policies can select the same set of pods. In this case, the ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     rules for each are combined additively. This field is NOT optional and&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     follows standard label selector semantics. An empty podSelector matches all&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     pods in this namespace.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   policyTypes  &amp;lt;[]string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     List of rule types that the NetworkPolicy relates to. Valid options are&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &amp;quot;Ingress&amp;quot;, &amp;quot;Egress&amp;quot;, or &amp;quot;Ingress,Egress&amp;quot;. If this field is not specified,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     it will default based on the existence of Ingress or Egress rules; policies&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     that contain an Egress section are assumed to affect Egress, and all&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     policies (whether or not they contain an Ingress section) are assumed to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     affect Ingress. If you want to write an egress-only policy, you must&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     explicitly specify policyTypes [ &amp;quot;Egress&amp;quot; ]. Likewise, if you want to write&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     a policy that specifies that no egress is allowed, you must specify a&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     policyTypes value that include &amp;quot;Egress&amp;quot; (since such a policy would not&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     include an Egress section and would otherwise default to just [ &amp;quot;Ingress&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ]). This field is beta-level in 1.8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;字段解释：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;egress       &amp;lt;[]Object&amp;gt;&lt;/li&gt;
&lt;li&gt;ingress      &amp;lt;[]Object&amp;gt;&lt;/li&gt;
&lt;li&gt;podSelector  &lt;object&gt; -required-&lt;br&gt;为{}  表示选择指定名称空间中的所有Pod&lt;/object&gt;&lt;/li&gt;
&lt;li&gt;policyTypes  &amp;lt;[]string&amp;gt;&lt;br&gt;策略类型：假如当前策略中既定义了egress，又定义了Ingress，哪个生效呢？它两其实不冲突，一个控制出站，一个控制入站。但也可以在某个时刻只让一个方向的规则生效。policyTypes就是干这个事情的。给哪个就代表哪个生效，如果都给了，代表都生效。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;假如定义规则的时候只写了Igress，而policyTypes中既写了Egress，又写了Ingress。Egress没定义啊，表示Egress默认规则生效。如果Egress默认规则是拒绝的，那么所有的出站都是拒绝的，如果Egress默认规则是允许的，那么所有的出站都是允许的。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# kubectl create ns dev&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;namespace/dev created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# kubectl create ns prod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;namespace/prod created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# vim networkpolicy-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: networking.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: NetworkPolicy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: deny-all-ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  podSelector: &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  policyTypes:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - Ingress&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;以上这种定义，表示Ingress规则生效，但是没有任何显式定义的规则，就意味着默认是拒绝所有的，而policyTypes里没有加Egress，意味着Egress默认是允许所有的。&lt;br&gt;在dev环境创建上面定义的networkpolicy：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# kubectl apply -f networkpolicy-demo.yaml -n dev&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;networkpolicy.networking.k8s.io/deny-all-ingress created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# kubectl get netpol -n dev&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME               POD-SELECTOR   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deny-all-ingress   &amp;lt;none&amp;gt;         52s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此时dev名称空间里还没有Pod，创建Pod：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# vim pod-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: netpol-demo1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# kubectl apply -f pod-demo.yaml -n dev &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/netpol-demo1 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# kubectl get pods -n dev -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME           READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;netpol-demo1   1/1     Running   0          13s   10.244.2.3   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;访问下这个Pod内的服务，发现不能访问：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# curl 10.244.2.3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;现在修改dev名称空间的策略，允许所有入站。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: networking.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: NetworkPolicy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: deny-all-ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  podSelector: &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ingress:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  policyTypes:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - Ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# kubectl apply -f networkpolicy-demo.yaml -n dev&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;networkpolicy.networking.k8s.io/deny-all-ingress configured&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/225.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;现在就可以访问了：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# curl 10.244.2.3                                &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v1 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;放心特定的入站流量：只允许访问dev名称空间的一组pod。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# kubectl label pod netpol-demo1 app=myapp -n dev&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/netpol-demo1 labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# vim networkpolicy-allow-myapp-ingress.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: networking.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: NetworkPolicy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: allow-myapp-ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  podSelector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    matchLabels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ingress:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - from:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - ipBlock:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        cidr: 10.244.0.0/16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        except:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - 10.244.1.2/32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - protocol: TCP&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      port: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  policyTypes:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - Ingress&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/226.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# kubectl apply -f networkpolicy-allow-myapp-ingress.yaml -n dev&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;networkpolicy.networking.k8s.io/allow-myapp-ingress created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# kubectl get netpol -n dev                                     &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                  POD-SELECTOR   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;allow-myapp-ingress   app=myapp      2s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deny-all-ingress      &amp;lt;none&amp;gt;         30m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;访问:&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# curl 10.244.2.3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v1 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# curl 10.244.2.3:443&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;curl: (7) Failed connect to 10.244.2.3:443; Connection refused&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但是443还是能访问，把deny-all-ingress这个策略删除掉，这个策略里放开了所有的入站：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# kubectl delete -f networkpolicy-demo.yaml -n dev&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;networkpolicy.networking.k8s.io &amp;quot;deny-all-ingress&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# curl 10.244.2.3:443&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这下就访问不了443了。&lt;br&gt;在dev创建另一个Pod，看看这个规则是否对这个pod生效：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# vim pod-demo2.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: netpol-demo2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# kubectl apply -f pod-demo2.yaml -n dev&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# kubectl get pods -n dev -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME           READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;netpol-demo1   1/1     Running   0          36m   10.244.2.3   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;netpol-demo2   1/1     Running   0          9s    10.244.2.4   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# curl 10.244.2.4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v1 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 networkpolicy]# curl 10.244.2.4:443&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;curl: (7) Failed connect to 10.244.2.4:443; Connection refused&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;很显然，上面设置的策略只对podSelector选中的pod生效。&lt;/p&gt;
&lt;p&gt;官方文档示例：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: networking.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: NetworkPolicy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: test-network-policy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  podSelector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    matchLabels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      role: db&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  policyTypes:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - Ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - Egress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ingress:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - from:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - ipBlock:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        cidr: 172.17.0.0/16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        except:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - 172.17.1.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - namespaceSelector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        matchLabels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          project: myproject&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - podSelector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        matchLabels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          role: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - protocol: TCP&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      port: 6379&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  egress:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - to:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - ipBlock:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        cidr: 10.0.0.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - protocol: TCP&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      port: 5978&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中，ingree的规则如下：对于含有标签”role=db”的Pod的TCP的5978端口&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;default名称空间下的含有标签 “role=frontend” 的Pod可以访问&lt;/li&gt;
&lt;li&gt;含有标签 “project=myproject” 名称空间下的Pod可以访问&lt;/li&gt;
&lt;li&gt;IP地址在 172.17.0.0/16，除了172.17.1.0/24网络内的，可以访问&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果pod作为客户端的话，应该允许访问外面所有的服务，出站应该放行所有。入站控制哪些进来就行。&lt;br&gt;如果想苛刻一点，就是拒绝所有入站，拒绝所有出站，单独放行。但是拒绝所有出站，拒绝所有入站会有问题，会导致同一个名称空间中被同一个podSelector选中的Pod与Pod也没法通信了。所以设置完拒绝所有入站，拒绝所有出站后，还应该加上一条，本名称空间出，然后又到本名称空间的pod是被允许的。就是放行同一个名称空间的pod之间通信。这样内部通信就没问题。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;flannel、calico和canel&quot;&gt;&lt;a href=&quot;#flannel、calico和canel&quot; class=&quot;headerlink&quot; title=&quot;flannel、calico和canel&quot;&gt;&lt;/a&gt;flannel、calico和canel&lt;/h2&gt;&lt;p&gt;calico的配置依赖于对BGP等协议的理解，我们这里不去使用calico作为网络插件提供网络功能了，而是把重点集中在calico如何提供网络策略，因为flannel本身提供不了网络策略，而flannel和calico二者已经合二为一了，有个新项目叫canel。可以在flannel提供网络功能的基础之上，在额外提供calico，去服务于网络策略。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>配置网络插件flannel</title>
    <link href="http://yoursite.com/2019/09/16/%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6flannel/"/>
    <id>http://yoursite.com/2019/09/16/配置网络插件flannel/</id>
    <published>2019-09-16T08:49:40.000Z</published>
    <updated>2019-09-18T05:37:25.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;docker的4种常用的网络模型&quot;&gt;&lt;a href=&quot;#docker的4种常用的网络模型&quot; class=&quot;headerlink&quot; title=&quot;docker的4种常用的网络模型&quot;&gt;&lt;/a&gt;docker的4种常用的网络模型&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;bridge&lt;/li&gt;
&lt;li&gt;joined：共享使用另外一个容器的网络名称空间&lt;/li&gt;
&lt;li&gt;open：使用宿主机网络名称空间。&lt;/li&gt;
&lt;li&gt;none&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;无论是哪一种方式，跨节点容器之间进行通信时，必须使用NAT机制来实现。出宿主机时做源地址转换，必须拿着物理机的地址出去。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/206.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;在上图中，左边节点上有个container1，container1用纯软件的方式生成一个网络接口，通常是veth格式的网络接口，一半在容器上，一半在宿主机上并关联到docker0桥上来了，很显然是个私网地址，需要在报文离开本机时做源地址转换SNAT。同样的，如果container2想被别人访问到，需要做DNAT把服务暴露出去。&lt;br&gt;所以如果是contaner1和container2通信，那就需要两级NAT转换了。所以网络通信性能很差，container1其实一直不知道自己访问的是谁，它本意访问的是container2，但是目标地址只能是节点2的eth0的地址。container2也不知道是谁访问的自己，一直收到的都是节点1的eth0地址。&lt;br&gt;所以这种通信方式实在是效率低，而且很难构建我们真正需要的通信网络模型。因此k8s作为一个编排工具来讲，本身就必须要让容器运行在多个节点之上，而且是以Pod的形式。各Pod之间是需要进行通信的。&lt;/p&gt;
&lt;h2 id=&quot;Kubernetes网络通信&quot;&gt;&lt;a href=&quot;#Kubernetes网络通信&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes网络通信&quot;&gt;&lt;/a&gt;Kubernetes网络通信&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;1.容器间通信:&lt;/strong&gt; 同一个Pod内的多个容器间的通信, lo&lt;br&gt;&lt;strong&gt;2.Pod通信: Pod IP &amp;lt;–&amp;gt; Pod IP。&lt;/strong&gt;k8s要求直达，不允许做任何地址转换，要使用自己的IP与对方的IP直接通信。意思是通信双方所见的地址就是通信双方的地址。&lt;br&gt;&lt;strong&gt;3.Pod与Service通信: PodIP &amp;lt;–&amp;gt; ClusterIP。&lt;/strong&gt;他两不在同一个网段，但是通过本地的iptables或ipvs规则能实现通信。如何启用ipvs，之前讲的有点问题，系统上有个configMap，kube-proxy，这里面定义了kube-proxy到底使用哪种模式工作。但是注意ipvs取代不了iptables，因为ipvs只能拿来做负载均衡，做NAT转换这个功能就做不到。&lt;br&gt;&lt;strong&gt;4.Service与集群外部客户端的通信。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;k8s的网络实现不是自己来实现的，要靠网络插件来实现。通过CNI标准实现的插件都可以在k8s上使用。&lt;br&gt;CNI: 有几十种现有的解决方案，常用的如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;flannel&lt;/li&gt;
&lt;li&gt;calico&lt;/li&gt;
&lt;li&gt;canel：flannel和calico拼凑起来的&lt;/li&gt;
&lt;li&gt;kube-router&lt;br&gt;…&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;无论是哪一种插件，他们去试图解决以上4种通信时，所用的解决方案无非是以下几种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;虚拟网桥：bridge，&lt;/strong&gt;纯软件的方式实现虚拟网卡，接入到网桥上去。每一对虚拟网卡，一半留在Pod之上，一半留在宿主机之上，并接入到网桥中去使用。甚至接入到物理接口上，使用物理桥接的方式。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;多路复用: MacVLAN。&lt;/strong&gt;基于MAC的方式去创建VLAN，为每个虚拟接口配置一个独有的MAC地址，使得一个物理网卡可以承载多个容器使用，这样他们就直接使用物理网卡并基于物理网卡中的MacVLAN机制进行跨节点之间进行通信。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;硬件交换: SR-IOV，单根IO虚拟化。&lt;/strong&gt;网卡支持硬件交换。一个网卡支持直接在物理级虚拟出多个接口来，叫单根IO虚拟化。现在市面上很多网卡都支持单根IO虚拟化。它是创建虚拟设备的一种很高性能的方式。一块网卡能虚拟出硬件级多块网卡来，然后我们可以让每个容器使用一个。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这几种方案里硬件交换的性能最好。而MacVLAN是一个网卡基于VLAN方式构建多个网络，也算可行。而虚拟网桥不得不靠叠加的方式来确保Pod通信是从Pod IP直接到Pod IP。很多情况下，用户期望创建L3或L2的逻辑网络子网，就需要借助于叠加的网络协议来实现。所以多种解决方案中，第一种虚拟网桥我们确实可以实现更为强大的控制能力，但是对网络传输来讲有额外的性能开销，毕竟是要使用隧道网络，或者称为叠加网络，需要多封装IP首部或者多封装MAC首部，具体看是几层隧道。不过一般来讲，我们使用叠加网络时，控制平面还没有很好的标准化，用起来彼此之间可能有很多不兼容。另外，我们如果要使用VXLAN这种技术，叫扩展的VLAN技术，可能会引入更多的开销，但是这种方式给了用户更大的腾挪空间。&lt;/p&gt;
&lt;p&gt;使用CNI时要用到的配置文件：&lt;br&gt;kubelet 或者 /etc/cni/net.d/ 下找配置文件&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# ls /etc/cni/net.d/ &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10-flannel.conflist&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cat /etc/cni/net.d/10-flannel.conflist&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cat /etc/cni/net.d/10-flannel.conflist&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;name&amp;quot;: &amp;quot;cbr0&amp;quot;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;plugins&amp;quot;: [&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;quot;type&amp;quot;: &amp;quot;flannel&amp;quot;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;quot;delegate&amp;quot;: &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;quot;hairpinMode&amp;quot;: true,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;quot;isDefaultGateway&amp;quot;: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;quot;type&amp;quot;: &amp;quot;portmap&amp;quot;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;quot;capabilities&amp;quot;: &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;quot;portMappings&amp;quot;: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;任何其他网络插件部署上来后，一般都是把配置文件放到 /etc/cni/net.d/ 目录下，从而可以被kubelet所加载，从而能够被kubelet作为必要时创建一个Pod，这个Pod应该有网络和网卡，kubelet调 /etc/cni/net.d/ 指定配置文件中定义的网络插件，由网络插件代为实现地址分配、接口创建、网络创建等。&lt;br&gt;目前flannel仍然占据着主要份额，毕竟简单。但是flannel有缺陷，在k8s之上网络插件不但要实现网络地址分配、管理等功能，还应该实现网络策略，可以控制Pod与Pod之间能不能通信。k8s之上存在名称空间，但是这个名称空间并不隔离Pod的访问，虽然隔离了用户权限。flannel是不支持网络策略的。&lt;br&gt;而calico的部署确实比flannel复杂很多，但是calico不仅支持地址分配、管理等功能，还支持网络策略。因此虽然calico复杂，但是仍然受到很多用户接受。另外，calico在实现地址转发的方式中，可以基于BGP的方式来实现二层网络转发和三层网络路由。性能上比flannel好，但是flannel也是三层网络方式，默认网络是叠加。&lt;br&gt;使用时可以同时使用flannel和calico，用flannel来实现网络功能，用calico来实现网络策略。&lt;/p&gt;
&lt;h2 id=&quot;flannel介绍&quot;&gt;&lt;a href=&quot;#flannel介绍&quot; class=&quot;headerlink&quot; title=&quot;flannel介绍&quot;&gt;&lt;/a&gt;flannel介绍&lt;/h2&gt;&lt;p&gt;flannel默认使用的VXLAN的方式来做后端网络传输机制的。如果基于宿主机桥接通信，那么Pod就应该可以借助虚拟网卡实现报文交换了，但现在我们要组成一个叠加网络。那就意味着两台主机之上应该有个专门用于叠加报文封装的隧道，这个通常是被叫做flannel.0，flannel.1这样的接口，如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# ifconfig&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;flannel.1: flags=4163&amp;lt;UP,BROADCAST,RUNNING,MULTICAST&amp;gt;  mtu 1450&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        inet 10.244.0.0  netmask 255.255.255.255  broadcast 0.0.0.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        inet6 fe80::b86d:87ff:fe95:7cd4  prefixlen 64  scopeid 0x20&amp;lt;link&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ether ba:6d:87:95:7c:d4  txqueuelen 0  (Ethernet)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        RX packets 2070  bytes 1140135 (1.0 MiB)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        RX errors 0  dropped 0  overruns 0  frame 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        TX packets 2242  bytes 536917 (524.3 KiB)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        TX errors 0  dropped 28 overruns 0  carrier 0  collisions 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这个接口专门用来封装隧道协议报文的，物理网卡的mtu是1500，而flannel.1网卡的mtu为 1450，要留出来一部分，因为要做叠加时有额外的开销，把额外的开销留出来了。而额外的空间不是不被占用的，而是留给隧道使用的。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;cni0: flags=4163&amp;lt;UP,BROADCAST,RUNNING,MULTICAST&amp;gt;  mtu 1450&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        inet 10.244.0.1  netmask 255.255.255.0  broadcast 0.0.0.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        inet6 fe80::b03f:bcff:fe63:9952  prefixlen 64  scopeid 0x20&amp;lt;link&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ether b2:3f:bc:63:99:52  txqueuelen 1000  (Ethernet)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        RX packets 54049595  bytes 3683516535 (3.4 GiB)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        RX errors 0  dropped 0  overruns 0  frame 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        TX packets 55354293  bytes 16544397952 (15.4 GiB)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;另外ifconfig里还看到cni0接口。cni0是被当前主机作为隧道协议上在本地通信时使用的接口。但是要创建完Pod后，这个cni0接口才会出现。&lt;br&gt;在两个主机的flannel接口之间要构建一个额外添加了报文传输通道，使用两个节点上的Pod之间通信借助这个传输通道来实现，就好像两个Pod之间直接通信了。这个通信使用的功能就是所谓的flannel.1接口，每次通信报文之外在封装一个二层或三层或四层的报文首部，这取决于工作模式。默认情况下用的是VXLAN技术，外层的隧道使用的VxLAN协议，扩展的虚拟局域网。扩展的虚拟局域网在实现报文通信时，可以理解为类似四层隧道这样的协议。正常传输一个以太网帧的时候，应该是在二层链路层直接进行传输以太网帧报文。那这个报文真正传输报文怎么传的？当一个帧发过来的时候，它要经由这个隧道接口在额外封装一个首部，第一VxLAN首部，而VxLAN首部之外，还有个UDP首部，借助于UDP来传输。UDP之外是IP首部，IP之外又有个以太网首部，所以这几层都是额外的开销。所以说基于VxLAN，性能可能会比较低，但好处在于可以独立管理一个网络，而且彼此之间跟物理网络是不相干扰的。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/207.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;以上只是flannel网络后端传输的第一种方式，所以flannel支持多种后端承载方式，就是报文是怎么发过去的：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;VxLAN&lt;/strong&gt;&lt;ul&gt;
&lt;li&gt;(1) vxlan&lt;/li&gt;
&lt;li&gt;(2) Directrouting：如果源Pod所在的节点与目标Pod所在的节点在同一个二层网络中，就是在同一个网咯中，那么大家直接使用host-gw通信，但是假如源Pod所在的节点与目标Pod所在的节点不在同一个网络中，就是中间有路由的，那么就自动降级为VxLAN叠加隧道进行通信。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;host-gw: Host Gateway。&lt;/strong&gt;两个节点上的Pod各自拥有一个网段，我们把主机自己所在的网络接口当做是网关来使用。在物理机上创建一个虚拟接口，每一个Pod也有个虚拟接口，Pod的虚拟接口在传输报文时，不是通过隧道承载传送过去的，当它需要传输报文时，发现目标主机不是本地的，它把报文传给物理机上的虚拟接口，把它当做网关来用，这个网关看到报文后要查路由表，这个路由表中记录了到达哪个网络要发给谁。比如发给10.244.1.0网络的要发给对端主机的物理网卡，然后经过物理网卡就发出去了。对端的物理网卡收到后一看是本物理机的另外一块虚拟网卡接口，所以报文传给那个虚拟网卡接口，然后在传到到Pod的虚拟接口。这里面没有使用叠加，报文通过路由就到达对端主机了，把主机所在的节点所在的地址额外加一个接口当网关，但是这样子就使得路由表很大。这种方式比vxlan性能要好很多，几乎没有什么多余的开销，除了本地路由之外。但是默认没有使用这种方式，因为有个缺陷，要求k8s节点必须在同一个二层网络中，如果两台主机之间要有路由，就没办法定义清楚了，不知道发哪去了。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/208.png&quot; alt=&quot;&quot;&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;UDP: 就用纯粹的UDP报文进行传输，&lt;/strong&gt;这种比VxLAN方式性能更差。因为它是用普通的UDP报文转发的，不是VxLAN专用的UDP报文转发的。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;flannel刚刚被发明出来的时候，Linux内核不支持VxLAN，Linux内核级没有VxLAN模块，而那个时候host-gw又有很高的门槛，所以早期flannel用的是UDP，最差的方式。因此在网上产生了一种偏见，认为flannel性能很差，现在使用host-gw方式的性能比calico性能都要好。&lt;/p&gt;
&lt;h2 id=&quot;部署flannel&quot;&gt;&lt;a href=&quot;#部署flannel&quot; class=&quot;headerlink&quot; title=&quot;部署flannel&quot;&gt;&lt;/a&gt;部署flannel&lt;/h2&gt;&lt;p&gt;flannel本身和k8s没有关系，它事先等存在，没有网络插件，k8s没法跑起来。他是被kubelet所调用的。凡是有kubelet的节点上都应该部署flannel。kubelet存在是为了运行Pod，而Pod就需要网络，而网络是kubelet调用flannel或者其他网络插件来实现网络功能。&lt;br&gt;flannel可以部署为系统的守护进程，也可以部署为k8s之上的Pod。当部署为k8s之上的Pod时，一定是个DaemonSet，在每一个节点上运行一个Pod副本，而且这个Pod副本是直接共享宿主机的网络名称空间的，这样Pod才能设置宿主机网络名称空间的。不然的话，就不能代为在Pod中运行又能改宿主机的网络接口了，比如创建个cni，每一个Pod启动时还能创建另外一对虚拟网卡，有一个在宿主机上，还能添加到桥上去，这些功能如果flannel不能共享宿主机网络名称空间的话，显然是做不到的。&lt;br&gt;当我们使用kubeadm部署k8s集群的时候，部署flannel是作为Pod托管在k8s之上的。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get daemonset -n kube-system&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/209.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/210.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;配置flannel时使用的是configMap，用来配置这几个Pod是怎么来运行的。有个configMap叫 kube-flannel-cfg。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get configmap -n kube-system     &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                                 DATA   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns                              1      158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;extension-apiserver-authentication   6      158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-cfg                     2      158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy                           2      158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubeadm-config                       2      158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubelet-config-1.14                  1      158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get configmap kube-flannel-cfg -o yaml -n kube-system&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/211.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;也可以配置为Directrouting方式。&lt;/p&gt;
&lt;h2 id=&quot;flannel的配置参数&quot;&gt;&lt;a href=&quot;#flannel的配置参数&quot; class=&quot;headerlink&quot; title=&quot;flannel的配置参数&quot;&gt;&lt;/a&gt;flannel的配置参数&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Network: flannel使用的CIDR格式的网络地址,用于为Pod配置网络功能。这个是个全局的网络，通常是8位或16位掩码的。然后这个全局网络会划分成子网，每个节点使用一个子网。比如：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;             10.244.0.0/16 -&amp;gt; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                 master节点: 10.244.0.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                 node01节点: 10.244.1.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                 ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                 node255节点: 10.244.255.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;意味着整个集群最多256个节点。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;             10.0.0.0/8 -&amp;gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                 10.0.0.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                 ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                 10.255.255.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;意味着整个集群最多2^16=65356个节点。 太大了，一般可以使用12或16位掩码，自己配置。注意要留出service使用的网络，比如service使用10.96.0.0/12，pod可以使用10.10.0.0/12。&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;SubnetLen: 把Network切分子网供各节点使用时, 使用多长的掩码进行切分, 默认为24位;                         &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;SubnetMin:10.244.10.0/24  子网中地址段中最小是多少给节点使用。比如如果是10.244.0.0/16网络，那么最小是10.244.0.0/24，最大是 10.244.255.0/24&lt;/li&gt;
&lt;li&gt;SubnetMax: 10.244.100.0/24&lt;/li&gt;
&lt;li&gt;Backend: vxlan, host-gw, udp。各Pod之间怎么通信。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;示例1：抓包看flannel的默认vxlan报文通信&quot;&gt;&lt;a href=&quot;#示例1：抓包看flannel的默认vxlan报文通信&quot; class=&quot;headerlink&quot; title=&quot;示例1：抓包看flannel的默认vxlan报文通信&quot;&gt;&lt;/a&gt;示例1：抓包看flannel的默认vxlan报文通信&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f deploy-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/myapp-deploy created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                            READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-c9kw9   1/1     Running   0          79s   10.244.2.92   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-f5v6m   1/1     Running   0          79s   10.244.3.21   hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-lwbz6   1/1     Running   0          79s   10.244.1.55   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;进入ubuntu31主机上运行的pod：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl exec myapp-deploy-675558bfc5-c9kw9 -it -- /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ #&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;打开另一个终端，进入spark7主机上运行的pod，然后ping ubuntu31上的pod的IP：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl exec myapp-deploy-675558bfc5-lwbz6 -it -- /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # ping 10.244.2.92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;PING 10.244.2.92 (10.244.2.92): 56 data bytes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64 bytes from 10.244.2.92: seq=0 ttl=62 time=0.756 ms&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64 bytes from 10.244.2.92: seq=1 ttl=62 time=0.384 ms&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64 bytes from 10.244.2.92: seq=2 ttl=62 time=0.408 ms&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在打开一个终端，连接ubuntu31和spark17，分别在上面抓icmp包：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;jkzhao@ubuntu31:~$ sudo tcpdump -i enp3s0 -nn icmp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tcpdump: verbose output suppressed, use -v or -vv for full protocol decode&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;listening on enp3s0, link-type EN10MB (Ethernet), capture size 262144 bytes&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# tcpdump -i enp0s25 -nn icmp &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tcpdump: verbose output suppressed, use -v or -vv for full protocol decode&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;listening on enp0s25, link-type EN10MB (Ethernet), capture size 65535 bytes&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;两个主机上都抓不到icmp报文。因为报文到物理接口上时已经被封装成UDP报文了，实际上是通过cni0或者flannel.1接口来接入的。所以报文到达这些接口的时候，应该还没有被隧道转发，至少是在它自己网卡的前后端还没有被隧道转发。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/212.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# brctl show flannel.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;bridge name     bridge id               STP enabled     interfaces&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;flannel.1               can&amp;apos;t get info Operation not supported&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# brctl show cni0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;bridge name     bridge id               STP enabled     interfaces&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cni0            8000.46c489cb0a37       no              vethe3b43012&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;jkzhao@ubuntu31:~$ brctl show cni0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;-bash: brctl: command not found&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;jkzhao@ubuntu31:~$ sudo apt-get install bridge-utils&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;jkzhao@ubuntu31:~$ brctl show cni0                  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;bridge name     bridge id               STP enabled     interfaces&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cni0            8000.6e57635fa57b       no              veth71751fdf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                                        vetha7ffd48d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                                                        vethcca0b8bd&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Pod的网络接口都桥接到cni0，因此在cni上抓包应该都没被隧道封装。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/213.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/214.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;虽然这里看到的是10.244.1.55直接到10.244.2.92，但是实际上报文在被送达到flannel.1接口的时候，报文先从cni0进来，从flannel.1出去，然后借助于物理网卡发出去。&lt;br&gt;抓取到达物理网卡上的报文：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/215.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;不支持抓取vxlan：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# tcpdump -i enp0s25 -nn vxlan&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tcpdump: syntax error&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;示例2：配置使用Directrouting的通信方式&quot;&gt;&lt;a href=&quot;#示例2：配置使用Directrouting的通信方式&quot; class=&quot;headerlink&quot; title=&quot;示例2：配置使用Directrouting的通信方式&quot;&gt;&lt;/a&gt;示例2：配置使用Directrouting的通信方式&lt;/h2&gt;&lt;p&gt;先看下当前主机的路由表：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# ip route show&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;default via 172.16.206.1 dev enp3s0  proto static  metric 100 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.0.0/24 dev cni0  proto kernel  scope link  src 10.244.0.1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.1.0/24 via 10.244.1.0 dev flannel.1 onlink &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.2.0/24 via 10.244.2.0 dev flannel.1 onlink &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.3.0/24 via 10.244.3.0 dev flannel.1 onlink &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.0/24 dev enp3s0  proto kernel  scope link  src 172.16.206.32  metric 100 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.17.0.0/16 dev docker0  proto kernel  scope link  src 172.17.0.1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.18.0.0/16 dev br-39b34343d087  proto kernel  scope link  src 172.18.0.1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;192.168.122.0/24 dev virbr0  proto kernel  scope link  src 192.168.122.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/217.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# mkdir flannel&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cd flannel/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# vim net-conf.json&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;Network&amp;quot;: &amp;quot;10.244.0.0/16&amp;quot;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;Backend&amp;quot;: &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;Type&amp;quot;: &amp;quot;vxlan&amp;quot;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;Directrouting&amp;quot;: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;需要把配置的内容应用到集群中，这实际上是configMap中的数据，所以需要把它定义成独立的configMap，或者合并到flannel现在用的configMap中。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# kubectl edit configmap kube-flannel-cfg -n kube-system&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/216.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;看下现在的路由表：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# ip route show&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;default via 172.16.206.1 dev enp3s0  proto static  metric 100 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.0.0/24 dev cni0  proto kernel  scope link  src 10.244.0.1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.1.0/24 via 10.244.1.0 dev flannel.1 onlink &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.2.0/24 via 10.244.2.0 dev flannel.1 onlink &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.3.0/24 via 10.244.3.0 dev flannel.1 onlink &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.0/24 dev enp3s0  proto kernel  scope link  src 172.16.206.32  metric 100 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.17.0.0/16 dev docker0  proto kernel  scope link  src 172.17.0.1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.18.0.0/16 dev br-39b34343d087  proto kernel  scope link  src 172.18.0.1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;192.168.122.0/24 dev virbr0  proto kernel  scope link  src 192.168.122.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这两条路由条目应该是送往物理接口才对，改完没有生效。&lt;/p&gt;
&lt;p&gt;把pod删除，重新创建，然后在查看路由表：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# kubectl delete -f ../deploy-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps &amp;quot;myapp-deploy&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# kubectl apply -f ../deploy-demo.yaml       &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/myapp-deploy created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# ip route show                         &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;default via 172.16.206.1 dev enp3s0  proto static  metric 100 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.0.0/24 dev cni0  proto kernel  scope link  src 10.244.0.1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.1.0/24 via 10.244.1.0 dev flannel.1 onlink &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.2.0/24 via 10.244.2.0 dev flannel.1 onlink &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.3.0/24 via 10.244.3.0 dev flannel.1 onlink &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.0/24 dev enp3s0  proto kernel  scope link  src 172.16.206.32  metric 100 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.17.0.0/16 dev docker0  proto kernel  scope link  src 172.17.0.1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.18.0.0/16 dev br-39b34343d087  proto kernel  scope link  src 172.18.0.1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;192.168.122.0/24 dev virbr0  proto kernel  scope link  src 192.168.122.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;还是不行。&lt;/p&gt;
&lt;p&gt;此前安装flannel时是kubectl appy -f，而我们这里修改是kubectl edit，不建议这么做，可能不会直接生效。现在去下载flannel的yaml文件，直接改这个文件，在apply一下。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# vim kube-flannel.yml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/218.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# kubectl apply -f kube-flannel.yml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;podsecuritypolicy.policy/psp.flannel.unprivileged configured&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrole.rbac.authorization.k8s.io/flannel unchanged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrolebinding.rbac.authorization.k8s.io/flannel unchanged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceaccount/flannel unchanged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;configmap/kube-flannel-cfg configured&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps/kube-flannel-ds-amd64 unchanged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps/kube-flannel-ds-arm64 unchanged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps/kube-flannel-ds-arm unchanged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps/kube-flannel-ds-ppc64le unchanged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps/kube-flannel-ds-s390x unchanged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# ip route show                     &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;default via 172.16.206.1 dev enp3s0  proto static  metric 100 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.0.0/24 dev cni0  proto kernel  scope link  src 10.244.0.1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.1.0/24 via 10.244.1.0 dev flannel.1 onlink &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.2.0/24 via 10.244.2.0 dev flannel.1 onlink &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.3.0/24 via 10.244.3.0 dev flannel.1 onlink &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.0/24 dev enp3s0  proto kernel  scope link  src 172.16.206.32  metric 100 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.17.0.0/16 dev docker0  proto kernel  scope link  src 172.17.0.1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.18.0.0/16 dev br-39b34343d087  proto kernel  scope link  src 172.18.0.1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;192.168.122.0/24 dev virbr0  proto kernel  scope link  src 192.168.122.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;还是没有生效。&lt;/p&gt;
&lt;p&gt;只能删除flannel，然后重新创建了：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# kubectl delete -f kube-flannel.yml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;podsecuritypolicy.policy &amp;quot;psp.flannel.unprivileged&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrole.rbac.authorization.k8s.io &amp;quot;flannel&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrolebinding.rbac.authorization.k8s.io &amp;quot;flannel&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceaccount &amp;quot;flannel&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;configmap &amp;quot;kube-flannel-cfg&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps &amp;quot;kube-flannel-ds-amd64&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps &amp;quot;kube-flannel-ds-arm64&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps &amp;quot;kube-flannel-ds-arm&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps &amp;quot;kube-flannel-ds-ppc64le&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps &amp;quot;kube-flannel-ds-s390x&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# kubectl get pods -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                                    READY   STATUS        RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-t2xj8                 1/1     Running       0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-xdjkx                 1/1     Running       0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-spark32                            1/1     Running       1          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-apiserver-spark32                  1/1     Running       0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-controller-manager-spark32         1/1     Running       0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-8h57w             1/1     Terminating   0          23h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-blwzz             1/1     Terminating   0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-lmmvh             1/1     Terminating   0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-tql5w             1/1     Terminating   0          23h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-czhfc                        1/1     Running       0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-gzhqw                        1/1     Running       0          41d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-rfxjw                        1/1     Running       0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-xmkxq                        1/1     Running       0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-scheduler-spark32                  1/1     Running       0          158d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes-dashboard-5f7b999d65-ngrr7   1/1     Running       0          2d1h&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【注意】:正常在生产环境不能这么搞，flannel一删除，所有Pod都不能运行了，因为没有网络。系统刚装完就要去调整flannel。&lt;/strong&gt;&lt;br&gt;等flannel的pod都终止完成，在重新创建：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# kubectl apply -f kube-flannel.yml         &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;podsecuritypolicy.policy/psp.flannel.unprivileged created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrole.rbac.authorization.k8s.io/flannel created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrolebinding.rbac.authorization.k8s.io/flannel created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceaccount/flannel created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;configmap/kube-flannel-cfg created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps/kube-flannel-ds-amd64 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps/kube-flannel-ds-arm64 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps/kube-flannel-ds-arm created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps/kube-flannel-ds-ppc64le created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps/kube-flannel-ds-s390x created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/219.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;在测试下跨节点通信：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                            READY   STATUS    RESTARTS   AGE    IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-4sn9w   1/1     Running   0          101m   10.244.3.22   hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-7qn59   1/1     Running   0          101m   10.244.2.93   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-jww2c   1/1     Running   0          101m   10.244.1.56   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 flannel]# kubectl exec myapp-deploy-675558bfc5-7qn59 -it -- /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # ping 10.244.1.56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;PING 10.244.1.56 (10.244.1.56): 56 data bytes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64 bytes from 10.244.1.56: seq=0 ttl=62 time=0.629 ms&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64 bytes from 10.244.1.56: seq=1 ttl=62 time=0.573 ms&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64 bytes from 10.244.1.56: seq=2 ttl=62 time=0.516 ms&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在物理节点上抓ICMP包，这时能抓到了：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# tcpdump -i enp0s25 -nn icmp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tcpdump: verbose output suppressed, use -v or -vv for full protocol decode&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;listening on enp0s25, link-type EN10MB (Ethernet), capture size 65535 bytes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13:39:01.090246 IP 10.244.2.93 &amp;gt; 10.244.1.56: ICMP echo request, id 3328, seq 0, length 64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13:39:01.090349 IP 10.244.1.56 &amp;gt; 10.244.2.93: ICMP echo reply, id 3328, seq 0, length 64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13:39:02.007033 IP 10.244.2.93 &amp;gt; 10.244.1.56: ICMP echo request, id 3328, seq 1, length 64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13:39:02.007133 IP 10.244.1.56 &amp;gt; 10.244.2.93: ICMP echo reply, id 3328, seq 1, length 64&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这和物理桥接很相像了。但是如果两个节点是跨网段的，会直接降级为overlay。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;如果想要使用host-gw模式，修改如下：&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/220.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;host-gw要求k8s节点必须在同一个网络，不允许跨网段。这种方式有个缺陷，那么多的Pod，成千上万个都在同一个二层网络中，不隔网段，将来一旦有广播报文，大家都会受到影响。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;docker的4种常用的网络模型&quot;&gt;&lt;a href=&quot;#docker的4种常用的网络模型&quot; class=&quot;headerlink&quot; title=&quot;docker的4种常用的网络模型&quot;&gt;&lt;/a&gt;docker的4种常用的网络模型&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;bridge&lt;/li&gt;
&lt;li&gt;joined：共享使用另外一个容器的网络名称空间&lt;/li&gt;
&lt;li&gt;open：使用宿主机网络名称空间。&lt;/li&gt;
&lt;li&gt;none&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;无论是哪一种方式，跨节点容器之间进行通信时，必须使用NAT机制来实现。出宿主机时做源地址转换，必须拿着物理机的地址出去。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes dashboard认证及分级授权</title>
    <link href="http://yoursite.com/2019/09/12/Kubernetes-dashboard%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%88%86%E7%BA%A7%E6%8E%88%E6%9D%83/"/>
    <id>http://yoursite.com/2019/09/12/Kubernetes-dashboard认证及分级授权/</id>
    <published>2019-09-12T05:50:22.000Z</published>
    <updated>2019-09-16T07:20:48.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;dashboard&quot;&gt;&lt;a href=&quot;#dashboard&quot; class=&quot;headerlink&quot; title=&quot;dashboard&quot;&gt;&lt;/a&gt;dashboard&lt;/h2&gt;&lt;p&gt;Kubernetes的子项目之一，是Kubernetes核心附件之一。作为Kubernetes的Web用户界面，用户可以通过Dashboard在Kubernetes集群中部署容器化的应用，对应用进行问题处理和管理，并对集群本身进行管理。通过Dashboard，用户可以查看集群中应用的运行情况，同时也能够基于Dashboard创建或修改部署、任务、服务等Kubernetes的资源。通过部署向导，用户能够对部署进行扩缩容，进行滚动更新、重启Pod和部署新应用。在Kubernetes 1.8之后，在部署dashboard时，有着更复杂的权限检查了。传统的在互联网上看到的开放访问的方式不一定支持了。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;安装部署dashboard&quot;&gt;&lt;a href=&quot;#安装部署dashboard&quot; class=&quot;headerlink&quot; title=&quot;安装部署dashboard&quot;&gt;&lt;/a&gt;安装部署dashboard&lt;/h2&gt;&lt;p&gt;打开 &lt;a href=&quot;https://github.com/kubernetes/dashboard&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;dashboard github地址&lt;/a&gt;，&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/197.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;我这里把这个yaml文件下载下来，这样可以看看里面的内容，然后进行安装。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# mkdir dashboard&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cd dashboard/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# ls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# wget https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl apply -f kubernetes-dashboard.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;secret/kubernetes-dashboard-certs created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceaccount/kubernetes-dashboard created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/kubernetes-dashboard created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/kubernetes-dashboard created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果dashboard镜像拉取不下来，可以如下操作：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# docker pull mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# docker tag mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1 k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;dashboard自身是https的，可以查看yaml中定义的Service：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/198.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;并且这个Service的类型是默认的cluserIP类型的，可以改为NodePort类型的：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl get svc -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-dns               ClusterIP   10.96.0.10      &amp;lt;none&amp;gt;        53/UDP,53/TCP,9153/TCP   156d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes-dashboard   ClusterIP   10.108.56.150   &amp;lt;none&amp;gt;        443/TCP                  73s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl patch svc kubernetes-dashboard -p &amp;apos;&amp;#123;&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;type&amp;quot;:&amp;quot;NodePort&amp;quot;&amp;#125;&amp;#125;&amp;apos; -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/kubernetes-dashboard patched&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl get svc -n kube-system                                           &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-dns               ClusterIP   10.96.0.10      &amp;lt;none&amp;gt;        53/UDP,53/TCP,9153/TCP   156d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes-dashboard   NodePort    10.108.56.150   &amp;lt;none&amp;gt;        443:30763/TCP            4m3s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;浏览器输入：&lt;a href=&quot;https://172.16.206.32:30763&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://172.16.206.32:30763&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/199.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;令牌认证可以直接输入令牌。&lt;/li&gt;
&lt;li&gt;Kubeconfig：kubectl就能使用kubeconfig，但是注意认证时必须使用serviceaccount账号认证。dashboard自己是个Pod，我们所提供的信息是让dashboard Pod认证到k8s集群上去的。不是让我们自己认证，是让dashboard Pod认证k8s，因为我们是通过这个Pod去访问管理集群上的Pod的。因此我们是为dashboard这个pod提供一个kubeconfig，所以主体必须是一个serviceaccount。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;token认证&quot;&gt;&lt;a href=&quot;#token认证&quot; class=&quot;headerlink&quot; title=&quot;token认证&quot;&gt;&lt;/a&gt;token认证&lt;/h2&gt;&lt;p&gt;token认证也需要先定义一个serviceaccount。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl create serviceaccount dashboard-admin -n kube-system &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceaccount/dashboard-admin created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;接下来需要通过RoleBinding把dashboard-admin这个serviceaccount和集群管理员绑定起来。不然这个serviceaccount不能通过RBAC的检查。dashboard部署完后，登录进来期望借助于dashboard做什么事情，假如要做整个集群的管理，也就是说该serviceaccount应该具有整个集群的访问权限，那么就应该通过ClusterRoleBinding把这个serviceaccount和cluster-admin角色绑定在一起。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl create clusterrolebinding dashboard-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrolebinding.rbac.authorization.k8s.io/dashboard-cluster-admin created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;绑定完成后，我们去获取对应的serviceaccount的secret信息。并且通过这个secret就可以访问集群了。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl get secret -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                                             TYPE                                  DATA   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;dashboard-admin-token-9sbkc                      kubernetes.io/service-account-token   3      98s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这个 dashboard-admin-token-9sbkc 是上面创建serviceaccount时自动生成的。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl describe secret dashboard-admin-token-9sbkc -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name:         dashboard-admin-token-9sbkc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Namespace:    kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Labels:       &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Annotations:  kubernetes.io/service-account.name: dashboard-admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;              kubernetes.io/service-account.uid: 1531c9c1-d84c-11e9-9e1c-60a44c223099&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Type:  kubernetes.io/service-account-token&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Data&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;====&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ca.crt:     1025 bytes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;namespace:  11 bytes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tOXNia2MiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMTUzMWM5YzEtZDg0Yy0xMWU5LTllMWMtNjBhNDRjMjIzMDk5Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.P4EXyMjsqbWEVu5aDD0LYhBteFIpvlj1AxNIH2eNAweqQyzeePqSmAUVQ825wUItIlhD0H-OLgoxuQOozYy-XNxonH-ixhe5S3o5uhAOzgxIydPAxZqle9b-SKjJHtnWPh48RMy1uVtAk7zTwXftvCjr8QNSWUDN60CKjoaOGLLuo1UPh2UQBuC5KcMg_FkROvXmiBoaw-EjECq_gV6_6f3FnveJGj0pSFITXXayux9tv3lRFjQiE7-wd-0OKfOlNnEPDkkrrSzaLbg5536AL_mdjI3ZjuA93ybavtH_so40K19TXy6sOTQwT38nArGdWikcZra-g8HYTN4CVYFYxA&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这个token信息就是当前 dashboard-admin 这个serviceaccount的认证令牌。&lt;/p&gt;
&lt;p&gt;在浏览器dashboard的登录界面，选择”令牌”，然后将上面的token信息复制上去，点击”登录”。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/200.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/201.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/202.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;登录进来了，可以查看所有的名称空间。&lt;/p&gt;
&lt;h2 id=&quot;Kubeconfig认证&quot;&gt;&lt;a href=&quot;#Kubeconfig认证&quot; class=&quot;headerlink&quot; title=&quot;Kubeconfig认证&quot;&gt;&lt;/a&gt;Kubeconfig认证&lt;/h2&gt;&lt;p&gt;这里创建个权限小一点的，只让它对默认名称空间有权限的管理员。还得在创建个serviceaccount。仅能够通过dashboard访问default一个名称空间，不让他做分级管理。所以需要把这个serviceaccount绑定在admin上，admin也是ClusterRole。但是可以使用RoleBinding去绑定。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl create sa def-ns-admin &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceaccount/def-ns-admin created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl create rolebinding def-ns-admin --clusterrole=admin --serviceaccount=default:def-ns-admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rolebinding.rbac.authorization.k8s.io/def-ns-admin created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl get secret &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                       TYPE                                  DATA   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;admin-token-th7zd          kubernetes.io/service-account-token   3      4d3h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;def-ns-admin-token-b9s8n   kubernetes.io/service-account-token   3      100s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;default-token-wb7fl        kubernetes.io/service-account-token   3      156d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql-root-passwd          Opaque                                1      18d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-ingress-secret      kubernetes.io/tls                     2      25d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl describe secret def-ns-admin-token-b9s8n&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name:         def-ns-admin-token-b9s8n&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Namespace:    default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Labels:       &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Annotations:  kubernetes.io/service-account.name: def-ns-admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;              kubernetes.io/service-account.uid: e1497fb6-d84d-11e9-9e1c-60a44c223099&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Type:  kubernetes.io/service-account-token&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Data&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;====&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ca.crt:     1025 bytes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;namespace:  7 bytes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZi1ucy1hZG1pbi10b2tlbi1iOXM4biIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJkZWYtbnMtYWRtaW4iLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJlMTQ5N2ZiNi1kODRkLTExZTktOWUxYy02MGE0NGMyMjMwOTkiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6ZGVmYXVsdDpkZWYtbnMtYWRtaW4ifQ.MaWQQSVdVzC67wHFqbFRaAEoC_KBtijs9lmcfV1GbUboJ3k-BswmWmHozSnREY1G2kpFWrnR3gETuodDLujeE4hUyix8vLh473iQ5TciP7Uw0FTdxKXqMkn9a_pb_dz5RUQn3tt2JGqd_v44nXRjgUuUnJIifyUv23U7iwmSN4riREhfYLvrNBbTBNIApaahn-9REWePXNllH93MLJSpGsbzpvDQcVCbUhgVxHUWsfAeNa9xAqOoUqJqbfe7QivKFXoEntU1BwTNOTl8j7YwQt_JQt2LpMkFg7R-T1CuZzohePas8tNmNfrEDGSavamQ56SDtlW7HVeGiM2IANX2eQ&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用这个token去登录dashboard，只能管理default名称空间的资源。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/203.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;但是我们希望使用装载一个kubeconfig配置文件来认证，所以接下来不得不为这个serviceaccount创建一个配置文件。配置文件和之前kubectl配置文件基本一致。注意去设置的时候要放上面看到的token，不要放证书进去，证书只是为了做k8s系统认证的。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl config set-cluster kubernetes  --certificate-authority=/etc/kubernetes/pki/ca.crt --server=&amp;quot;https://172.16.206.32:6443&amp;quot; --embed-certs=true --kubeconfig=/root/def-ns-admin.conf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Cluster &amp;quot;kubernetes&amp;quot; set.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;需要把 token 写到kubeconfig中。使用token进行认证。注意在设置认证token时不要把加密后的token设置进去，直接写入上面看到的那个token。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl config set-cluster kubernetes  --certificate-authority=/etc/kubernetes/pki/ca.crt --server=&amp;quot;https://172.16.206.32:6443&amp;quot; --embed-certs=true --kubeconfig=/root/def-ns-admin.conf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Cluster &amp;quot;kubernetes&amp;quot; set.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl config set-credentials def-ns-admin --token=&amp;quot;ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNklpSjkuZXlKcGMzTWlPaUpyZFdKbGNtNWxkR1Z6TDNObGNuWnBZMlZoWTJOdmRXNTBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5dVlXMWxjM0JoWTJVaU9pSmtaV1poZFd4MElpd2lhM1ZpWlhKdVpYUmxjeTVwYnk5elpYSjJhV05sWVdOamIzVnVkQzl6WldOeVpYUXVibUZ0WlNJNkltUmxaaTF1Y3kxaFpHMXBiaTEwYjJ0bGJpMWlPWE00YmlJc0ltdDFZbVZ5Ym1WMFpYTXVhVzh2YzJWeWRtbGpaV0ZqWTI5MWJuUXZjMlZ5ZG1salpTMWhZMk52ZFc1MExtNWhiV1VpT2lKa1pXWXRibk10WVdSdGFXNGlMQ0pyZFdKbGNtNWxkR1Z6TG1sdkwzTmxjblpwWTJWaFkyTnZkVzUwTDNObGNuWnBZMlV0WVdOamIzVnVkQzUxYVdRaU9pSmxNVFE1TjJaaU5pMWtPRFJrTFRFeFpUa3RPV1V4WXkwMk1HRTBOR015TWpNd09Ua2lMQ0p6ZFdJaU9pSnplWE4wWlcwNmMyVnlkbWxqWldGalkyOTFiblE2WkdWbVlYVnNkRHBrWldZdGJuTXRZV1J0YVc0aWZRLk1hV1FRU1ZkVnpDNjd3SEZxYkZSYUFFb0NfS0J0aWpzOWxtY2ZWMUdiVWJvSjNrLUJzd21XbUhvelNuUkVZMUcya3BGV3JuUjNnRVR1b2RETHVqZUU0aFV5aXg4dkxoNDczaVE1VGNpUDdVdzBGVGR4S1hxTWtuOWFfcGJfZHo1UlVRbjN0dDJKR3FkX3Y0NG5YUmpnVXVVbkpJaWZ5VXYyM1U3aXdtU040cmlSRWhmWUx2ck5CYlRCTklBcGFhaG4tOVJFV2VQWE5sbEg5M01MSlNwR3NienB2RFFjVkNiVWhnVnhIVVdzZkFlTmE5eEFxT29VcUpxYmZlN1FpdktGWG9FbnRVMUJ3VE5PVGw4ajdZd1F0X0pRdDJMcE1rRmc3Ui1UMUN1WnpvaGVQYXM4dE5tTmZyRURHU2F2YW1RNTZTRHRsVzdIVmVHaU0ySUFOWDJlUQ==&amp;quot; --kubeconfig=/root/def-ns-admin.conf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl config set-context def-ns-admin@kubernetes --cluster=kubernetes --user=def-ns-admin --kubeconfig=/root/def-ns-admin.conf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Context &amp;quot;def-ns-admin@kubernetes&amp;quot; created.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 dashboard]# kubectl config use-context def-ns-admin@kubernetes --kubeconfig=/root/def-ns-admin.conf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Switched to context &amp;quot;def-ns-admin@kubernetes&amp;quot;.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看生成的配置文件：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl config view --kubeconfig=/root/def-ns-admin.conf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusters:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- cluster:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    certificate-authority-data: DATA+OMITTED&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server: https://172.16.206.32:6443&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;contexts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- context:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    cluster: kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    user: def-ns-admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: def-ns-admin@kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;current-context: def-ns-admin@kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Config&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;preferences: &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;users:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- name: def-ns-admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  user:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    token: eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZi1ucy1hZG1pbi10b2tlbi1iOXM4biIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJkZWYtbnMtYWRtaW4iLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJlMTQ5N2ZiNi1kODRkLTExZTktOWUxYy02MGE0NGMyMjMwOTkiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6ZGVmYXVsdDpkZWYtbnMtYWRtaW4ifQ.MaWQQSVdVzC67wHFqbFRaAEoC_KBtijs9lmcfV1GbUboJ3k-BswmWmHozSnREY1G2kpFWrnR3gETuodDLujeE4hUyix8vLh473iQ5TciP7Uw0FTdxKXqMkn9a_pb_dz5RUQn3tt2JGqd_v44nXRjgUuUnJIifyUv23U7iwmSN4riREhfYLvrNBbTBNIApaahn-9REWePXNllH93MLJSpGsbzpvDQcVCbUhgVxHUWsfAeNa9xAqOoUqJqbfe7QivKFXoEntU1BwTNOTl8j7YwQt_JQt2LpMkFg7R-T1CuZzohePas8tNmNfrEDGSavamQ56SDtlW7HVeGiM2IANX2eQ&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;将配置文件传到自己本地，然后在dashboard界面选择kubeconfig认证，使用该配置文件认证：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/204.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;以后可以使用dashboard来管理资源了，比如创建资源：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/205.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【总结】：&lt;/strong&gt;&lt;br&gt;认证时的账号必须为ServiceAccount: 被dashboard pod拿来由kubernetes进行认证;&lt;br&gt;&lt;strong&gt;token认证: &lt;/strong&gt;&lt;br&gt;(1)创建ServiceAccount,根据其管理目标,使用rolebinding或clusterrolebinding绑定至合理role或&lt;br&gt;clusterrole;&lt;br&gt;(2)获取到此ServiceAccount的secret, 这个secret是创建serviceaccount自动生成的。作为此serviceaccount去k8s认证的信息。查看secret的详细信息, 其中就有token;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;kubeconfig认证:&lt;/strong&gt; 把ServiceAccount的token封装为kubeconfig文件&lt;br&gt;(1)创建ServiceAccount,根据其管理目标,使用rolebinding或clusterrolebinding绑定至合理role或clusterrole;&lt;br&gt;(2)kubectl get secret | awk ‘/^ServiceAccount/{print $1}’   ##这里的ServiceAccount指的是你创建的serviceaccount的名字&lt;br&gt;            KUBE_TOKEN=$(kubectl get secret SERVCIEACCOUNT_SERRET_NAME -o jsonpath={.data.token} | base64 -d)&lt;br&gt;(3)生成kubeconfig文件&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;kubectl config set-cluster --kubeconfig=/PATH/TO/SOMEFILE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubectl config set-credentials NAME --token=$KUBE_TOKEN --kubeconfig=/PATH/TO/SOMEFILE    #这里的NAME只是个自定义的名字，认证时k8s识别的此名字是你第一步创建的serviceaccount。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubectl config set-context&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubectl config use-context&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;dashboard&quot;&gt;&lt;a href=&quot;#dashboard&quot; class=&quot;headerlink&quot; title=&quot;dashboard&quot;&gt;&lt;/a&gt;dashboard&lt;/h2&gt;&lt;p&gt;Kubernetes的子项目之一，是Kubernetes核心附件之一。作为Kubernetes的Web用户界面，用户可以通过Dashboard在Kubernetes集群中部署容器化的应用，对应用进行问题处理和管理，并对集群本身进行管理。通过Dashboard，用户可以查看集群中应用的运行情况，同时也能够基于Dashboard创建或修改部署、任务、服务等Kubernetes的资源。通过部署向导，用户能够对部署进行扩缩容，进行滚动更新、重启Pod和部署新应用。在Kubernetes 1.8之后，在部署dashboard时，有着更复杂的权限检查了。传统的在互联网上看到的开放访问的方式不一定支持了。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes RBAC</title>
    <link href="http://yoursite.com/2019/09/09/Kubernetes-RBAC/"/>
    <id>http://yoursite.com/2019/09/09/Kubernetes-RBAC/</id>
    <published>2019-09-09T06:08:09.000Z</published>
    <updated>2019-09-16T03:04:30.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;常用的授权插件&quot;&gt;&lt;a href=&quot;#常用的授权插件&quot; class=&quot;headerlink&quot; title=&quot;常用的授权插件&quot;&gt;&lt;/a&gt;常用的授权插件&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;Node：由节点来认证。&lt;/li&gt;
&lt;li&gt;ABAC：基于属性的访问控制。&lt;/li&gt;
&lt;li&gt;RBAC：Role-based AC&lt;/li&gt;
&lt;li&gt;Webhook：基于http的回调机制&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;RBAC&quot;&gt;&lt;a href=&quot;#RBAC&quot; class=&quot;headerlink&quot; title=&quot;RBAC&quot;&gt;&lt;/a&gt;RBAC&lt;/h2&gt;&lt;p&gt;RBAC: Role-based AC&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;角色(role)  &lt;/li&gt;
&lt;li&gt;许可(permission)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/186.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;所有的许可授权都添加在角色上，随后让用户去扮演这角色，所以用户就拥有了这个角色的权限。所以是基于角色的访问授权。&lt;br&gt;权限是怎么定义的呢？基于对象。k8s的所有内容可分为3类，第一个叫对象，占了绝大部分主体，第二部分叫对象列表，第三部分是一些虚拟对象，通常是一些url。第三部分很少，叫非对象资源。在restful风格中的所有的操作都是指在某个对象上施加的某种行为，称为operation。在一个对象上能够施加的操作组合起来，称为一个Permission。而后去授予某个role拥有某种或某些被许可的权限。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/187.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;subject：执行主体，分为Human user和 Pod serviceaccount。&lt;/li&gt;
&lt;li&gt;Object URL: 如果这个对象属于名称空间级别：&lt;br&gt;/apis/&lt;group&gt;/&lt;version&gt;/namespaces/&lt;namespace_name&gt;/&lt;kind&gt;[/OBJECT_ID]/&lt;/kind&gt;&lt;/namespace_name&gt;&lt;/version&gt;&lt;/group&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/188.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;RBAC的工作逻辑：&lt;/strong&gt;&lt;br&gt;定义一个role，role是标准的k8s资源。role里面定义了如下东西：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、operations&lt;/li&gt;
&lt;li&gt;2、objects&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;没有拒绝权限，只有许可权限。&lt;br&gt;接下来定义一个用户账号，和role绑定，叫做rolebinding。&lt;/p&gt;
&lt;p&gt;在k8s当中，资源分属两种级别，集群级别和名称空间级别。role和rolebinding是名称空间级别，授予这个名称空间范围内的许可权限的。除了role和rolebinding，还有clusterrole和clusterrolebinding，集群角色和集群角色绑定。它们两是集群级别生效的。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/189.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;那么为什么这么设计呢？不允许RoleBinding绑定ClusterBinding不就好了吗？比如现在需要授权一个用户当前名称空间拥有管理权限，如果有10个名称空间，每个名称空间都有一个名称空间的管理员，应该怎么定义呢？在第一个名称空间中，定义一个Role，拥有管理权限，定义一个用户，做RoleBinding，每个空间都得定义一个拥有管理权限的Role。现在可以只定义一个ClusterRole，然后用RoleBinding去绑。&lt;/p&gt;
&lt;h2 id=&quot;RBAC示例&quot;&gt;&lt;a href=&quot;#RBAC示例&quot; class=&quot;headerlink&quot; title=&quot;RBAC示例&quot;&gt;&lt;/a&gt;RBAC示例&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# mkdir rbac&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cd rbac/&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;示例1：Role和RoleBinding&quot;&gt;&lt;a href=&quot;#示例1：Role和RoleBinding&quot; class=&quot;headerlink&quot; title=&quot;示例1：Role和RoleBinding&quot;&gt;&lt;/a&gt;示例1：Role和RoleBinding&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl create role pods-reader --verb=get,list,watch --resource=pods --dry-run&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;role.rbac.authorization.k8s.io/pods-reader created (dry run)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You have mail in /var/spool/mail/root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl create role pods-reader --verb=get,list,watch --resource=pods --dry-run -o yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: rbac.authorization.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Role&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  creationTimestamp: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pods-reader&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rules:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- apiGroups:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - &amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  resources:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  verbs:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - get&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - list&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - watch&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl create role pods-reader --verb=get,list,watch --resource=pods --dry-run -o yaml &amp;gt; role-demo.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# vim role-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: rbac.authorization.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Role&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pods-reader&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rules:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- apiGroups:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - &amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  resources:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  verbs:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - get&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - list&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - watch&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/190.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl apply -f role-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;role.rbac.authorization.k8s.io/pods-reader created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl get role&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME          AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pods-reader   6s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/191.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;前一篇博文中创建了一个用户叫wisedu，他是没有权限去读Pod的。这个wisedu并不存在于k8s系统上，他只是个标识，当使用kubectl登录认证的时候，k8s就能识别他了，这个wisedu并不是我们手动创建的实际存在的用户，只是个标识。现在我们让wisedu扮演这个角色，而扮演这个角色需要RoleBinding。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl create rolebinding --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Create a RoleBinding for a particular Role or ClusterRole.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Create a RoleBinding for user1, user2, and group1 using the admin ClusterRole&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create rolebinding admin --clusterrole=admin --user=user1 --user=user2 --group=group1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Options:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --allow-missing-template-keys=true: If true, ignore any errors in templates when a field or map key is missing in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the template. Only applies to golang and jsonpath output formats.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --clusterrole=&amp;apos;&amp;apos;: ClusterRole this RoleBinding should reference&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --dry-run=false: If true, only print the object that would be sent, without sending it.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --generator=&amp;apos;rolebinding.rbac.authorization.k8s.io/v1alpha1&amp;apos;: The name of the API generator to use.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --group=[]: Groups to bind to the role&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -o, --output=&amp;apos;&amp;apos;: Output format. One of:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;json|yaml|name|go-template|go-template-file|template|templatefile|jsonpath|jsonpath-file.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --role=&amp;apos;&amp;apos;: Role this RoleBinding should reference&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --save-config=false: If true, the configuration of current object will be saved in its annotation. Otherwise, the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;annotation will be unchanged. This flag is useful when you want to perform kubectl apply on this object in the future.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --serviceaccount=[]: Service accounts to bind to the role, in the format &amp;lt;namespace&amp;gt;:&amp;lt;name&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --template=&amp;apos;&amp;apos;: Template string or path to template file to use when -o=go-template, -o=go-template-file. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;template format is golang templates [http://golang.org/pkg/text/template/#pkg-overview].&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --validate=true: If true, use a schema to validate the input before sending it&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create rolebinding NAME --clusterrole=NAME|--role=NAME [--user=username] [--group=groupname]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[--serviceaccount=namespace:serviceaccountname] [--dry-run] [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl options&amp;quot; for a list of global command-line options (applies to all commands).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;–clusterrole=NAME|–role=NAME: 只能选择一个进行绑定。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl create rolebinding wisedu-read-pods --role=pods-reader --user=wisedu --dry-run -o yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: rbac.authorization.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: RoleBinding&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  creationTimestamp: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: wisedu-read-pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;roleRef:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  apiGroup: rbac.authorization.k8s.io&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kind: Role&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pods-reader&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;subjects:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- apiGroup: rbac.authorization.k8s.io&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kind: User&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: wisedu&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl create rolebinding wisedu-read-pods --role=pods-reader --user=wisedu --dry-run -o yaml &amp;gt; rolebinding-demo.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl apply -f rolebinding-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rolebinding.rbac.authorization.k8s.io/wisedu-read-pods created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl get rolebinding&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME               AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;wisedu-read-pods   10s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/192.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;接下来切换kubectl的当前上下文：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl config use-context wisedu@kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Switched to context &amp;quot;wisedu@kubernetes&amp;quot;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME          READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-0       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-1       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-2       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-3       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-4       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-sa-demo   1/1     Running   0          3d22h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl get pods -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Error from server (Forbidden): pods is forbidden: User &amp;quot;wisedu&amp;quot; cannot list resource &amp;quot;pods&amp;quot; in API group &amp;quot;&amp;quot; in the namespace &amp;quot;kube-system&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;仅能查看default名称空间的Pods，其他名称空间的Pods依然没有权限看。&lt;/p&gt;
&lt;h3 id=&quot;示例2：ClusterRole和ClusterRoleBinding&quot;&gt;&lt;a href=&quot;#示例2：ClusterRole和ClusterRoleBinding&quot; class=&quot;headerlink&quot; title=&quot;示例2：ClusterRole和ClusterRoleBinding&quot;&gt;&lt;/a&gt;示例2：ClusterRole和ClusterRoleBinding&lt;/h3&gt;&lt;p&gt;ClusterRole和Role的定义是一样的。ClusterRole是集群级别的资源，不能定义在名称空间里，所以不能定义字段namespace。下面创建一个ClusterRole。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl create clusterrole cluster-reader --verb=get,list,watch --resource=pods --dry-run -o yaml &amp;gt; clusterrole-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# vim clusterrole-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: rbac.authorization.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: ClusterRole&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  creationTimestamp: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: cluster-reader&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rules:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- apiGroups:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - &amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  resources:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  verbs:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - get&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - list&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - watch&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;先将kubectl切回管理员，否则创建不了资源。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl config use-context kubernetes-admin@kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Switched to context &amp;quot;kubernetes-admin@kubernetes&amp;quot;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl apply -f clusterrole-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrole.rbac.authorization.k8s.io/cluster-reader created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;创建完ClusterRole之后，利用ClusterRoleBinding把wisedu绑定在这个ClusterRole上，这样wisedu就可以查看所有名称空间的Pods了。但是需要先把之前的RoleBinding去掉。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl delete rolebinding wisedu-read-pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rolebinding.rbac.authorization.k8s.io &amp;quot;wisedu-read-pods&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl create clusterrolebinding wisedu-read-all-pods --clusterrole=cluster-reader --user=wisedu -o yaml &amp;gt; clusterrolebinding-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# vim clusterrolebinding-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: rbac.authorization.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: ClusterRoleBinding&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: wisedu-read-all-pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;roleRef:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  apiGroup: rbac.authorization.k8s.io&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kind: ClusterRole&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: cluster-reader&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;subjects:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- apiGroup: rbac.authorization.k8s.io&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kind: User&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: wisedu&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;切换用户，查看Pods：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME          READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-0       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-1       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-2       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-3       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-4       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-sa-demo   1/1     Running   0          3d22h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl get pods -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                              READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-t2xj8           1/1     Running   0          156d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-xdjkx           1/1     Running   0          156d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-spark32                      1/1     Running   1          156d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-apiserver-spark32            1/1     Running   0          156d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-controller-manager-spark32   1/1     Running   0          156d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-blwzz       1/1     Running   0          156d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-gchzj       1/1     Running   4          39d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-jdpbk       1/1     Running   0          156d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-lmmvh       1/1     Running   0          156d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-czhfc                  1/1     Running   0          156d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-gzhqw                  1/1     Running   0          39d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-rfxjw                  1/1     Running   0          156d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-xmkxq                  1/1     Running   0          156d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-scheduler-spark32            1/1     Running   0          156d&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此时，wisedu已经可以读取所有名称空间的Pods了。但是wisedu此时只有读权限，没有删除权限。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl delete pod pod-sa-demo &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Error from server (Forbidden): pods &amp;quot;pod-sa-demo&amp;quot; is forbidden: User &amp;quot;wisedu&amp;quot; cannot delete resource &amp;quot;pods&amp;quot; in API group &amp;quot;&amp;quot; in the namespace &amp;quot;default&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;下面把ClusterRoleBinding删了，换成RoleBinding来绑定ClusterRole，来看看效果。这样wisedu只能读取RoleBinding所在名称空间的Pods资源。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl config use-context kubernetes-admin@kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Switched to context &amp;quot;kubernetes-admin@kubernetes&amp;quot;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl delete clusterrolebinding wisedu-read-all-pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrolebinding.rbac.authorization.k8s.io &amp;quot;wisedu-read-all-pods&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl create rolebinding wisedu-read-pods --clusterrole=cluster-reader --user=wisedu -o yaml &amp;gt; rolebinding-clusterrole-demo.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl config use-context wisedu@kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Switched to context &amp;quot;wisedu@kubernetes&amp;quot;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME          READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-0       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-1       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-2       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-3       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-4       1/1     Running   0          6d16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-sa-demo   1/1     Running   0          3d22h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl get pods -n kube-system             &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Error from server (Forbidden): pods is forbidden: User &amp;quot;wisedu&amp;quot; cannot list resource &amp;quot;pods&amp;quot; in API group &amp;quot;&amp;quot; in the namespace &amp;quot;kube-system&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;系统内建的一些ClusterRole&quot;&gt;&lt;a href=&quot;#系统内建的一些ClusterRole&quot; class=&quot;headerlink&quot; title=&quot;系统内建的一些ClusterRole&quot;&gt;&lt;/a&gt;系统内建的一些ClusterRole&lt;/h2&gt;&lt;p&gt;系统上有两个非常重要的clusterrole：&lt;strong&gt;admin和cluster-admin。&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;admin&quot;&gt;&lt;a href=&quot;#admin&quot; class=&quot;headerlink&quot; title=&quot;admin&quot;&gt;&lt;/a&gt;admin&lt;/h3&gt;&lt;p&gt;admin：为了一个特殊场景，就是上面描述的，每一个名称空间都需要一个管理员，只管理自己这一个名称空间，不用定义角色了，用RoleBinding引用这个clusterrole：admin。但这个admin不具备删除一些敏感资源，比如configMap之类的只能查看。&lt;/p&gt;
&lt;p&gt;看看ClusterRole admin具有哪些权限：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl get clusterrole admin -o yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/193.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;admin测试：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl create rolebinding default-ns-admin --clusterrole=admin --user=wisedu&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rolebinding.rbac.authorization.k8s.io/default-ns-admin created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl config use-context wisedu@kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Switched to context &amp;quot;wisedu@kubernetes&amp;quot;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME          READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-0       1/1     Running   0          6d17h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-1       1/1     Running   0          6d17h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-2       1/1     Running   0          6d17h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-3       1/1     Running   0          6d17h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-4       1/1     Running   0          6d17h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-sa-demo   1/1     Running   0          3d23h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl delete pod pod-sa-demo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-sa-demo&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;admin这个cluserrole是可以删除pods的。&lt;/p&gt;
&lt;h3 id=&quot;cluster-admin&quot;&gt;&lt;a href=&quot;#cluster-admin&quot; class=&quot;headerlink&quot; title=&quot;cluster-admin&quot;&gt;&lt;/a&gt;cluster-admin&lt;/h3&gt;&lt;p&gt;k8s系统装完以后，默认kubectl的配置文件拥有管理所有名称空间的所有资源的权限。这是因为有个ClusterRole cluster-admin 和 ClusterRoleBinding cluster-admin。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl get clusterrole cluster-admin -o yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: rbac.authorization.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: ClusterRole&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    rbac.authorization.kubernetes.io/autoupdate: &amp;quot;true&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  creationTimestamp: &amp;quot;2019-04-12T08:58:33Z&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    kubernetes.io/bootstrapping: rbac-defaults&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: cluster-admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  resourceVersion: &amp;quot;43&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterroles/cluster-admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  uid: 264c4493-5d01-11e9-9e1c-60a44c223099&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rules:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- apiGroups:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - &amp;apos;*&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  resources:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - &amp;apos;*&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  verbs:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - &amp;apos;*&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- nonResourceURLs:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - &amp;apos;*&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  verbs:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - &amp;apos;*&amp;apos;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 rbac]# kubectl get clusterrolebinding cluster-admin -o yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: rbac.authorization.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: ClusterRoleBinding&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    rbac.authorization.kubernetes.io/autoupdate: &amp;quot;true&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  creationTimestamp: &amp;quot;2019-04-12T08:58:34Z&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    kubernetes.io/bootstrapping: rbac-defaults&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: cluster-admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  resourceVersion: &amp;quot;97&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/cluster-admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  uid: 26ead5d8-5d01-11e9-9e1c-60a44c223099&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;roleRef:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  apiGroup: rbac.authorization.k8s.io&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kind: ClusterRole&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: cluster-admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;subjects:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- apiGroup: rbac.authorization.k8s.io&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kind: Group&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: system:masters&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;subjects(主体)是 &lt;strong&gt;system:masters&lt;/strong&gt;，这是一个组。而这个组内有个用户叫 kubernetes-admin，这个用户属于组system:masters。为什么kubernetes-admin属于这个组内？这是在kubernetes-admin的证书中定义的。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# pwd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/etc/kubernetes/pki&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# openssl x509 -in ./apiserver-kubelet-client.crt -text -noout&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/194.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;kubernetes-admin对应的CN就是上图中的kube-apiserver-kubelet-client，虽然在kubectl config view中看到的是kubernetes-admin，但是k8s识别时是kube-apiserver-kubelet-client。以后我们定义证书时，也可以定义组，指定O就可以了。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;在RBAC上进行授权时，可以绑定在三类组件上:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;绑定在user上。RoleBinding和ClusterRoleBinding都可以绑定在user上&lt;/li&gt;
&lt;li&gt;绑定在group上。绑定在group上时，表示授权这个组内的所有用户都可以扮演这个角色。&lt;/li&gt;
&lt;li&gt;绑定在serviceaccount上。&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create rolebinding NAME --clusterrole=NAME|--role=NAME [--user=username] [--group=groupname]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[--serviceaccount=namespace:serviceaccountname] [--dry-run] [options]&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;目前演示了前两种。绑定到serviceaccount，和前两种绑定没什么区别。而且一旦serviceaccount上做了RoleBinding或ClusterRoleBinding，也就意味着这个serviceaccount拥有了访问权限。任何一个Pod如果启动时以这个serviceaccountName作为它使用的serviceaccount的话，那么Pod中应用程序就拥有了这个serviceaccount所拥有的权限。&lt;br&gt;有一些Pod是需要管理员权限的，比如kube-system名称空间的一些Pods。一般都需要一些特殊的权限。比如flannel：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim kube-flannel.yml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/195.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/196.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;接下来与apiserver通信使用这个ClusterRole所具有的权限。&lt;br&gt;另外，准入控制一般很少操作，多数情况下都是RBAC，用户创建和授权。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;常用的授权插件&quot;&gt;&lt;a href=&quot;#常用的授权插件&quot; class=&quot;headerlink&quot; title=&quot;常用的授权插件&quot;&gt;&lt;/a&gt;常用的授权插件&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;Node：由节点来认证。&lt;/li&gt;
&lt;li&gt;ABAC：基于属性的访问控制。&lt;/li&gt;
&lt;li&gt;RBAC：Role-based AC&lt;/li&gt;
&lt;li&gt;Webhook：基于http的回调机制
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes认证及serviceaccount</title>
    <link href="http://yoursite.com/2019/09/02/Kubernetes%E8%AE%A4%E8%AF%81%E5%8F%8Aserviceaccount/"/>
    <id>http://yoursite.com/2019/09/02/Kubernetes认证及serviceaccount/</id>
    <published>2019-09-02T07:14:20.000Z</published>
    <updated>2019-09-22T11:46:45.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Kubernetes安全概述&quot;&gt;&lt;a href=&quot;#Kubernetes安全概述&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes安全概述&quot;&gt;&lt;/a&gt;Kubernetes安全概述&lt;/h2&gt;&lt;p&gt;对于k8s api接口的访问不会是任何人能够轻易使用的，此前我们是通过kubectl这个客户端工具进行访问的，如果人人都可以通过kubectl来访问，那么就很可能会删除别人的应用，这是非常危险的。因此k8s对于整个系统的认证、授权和所谓的后续的访问控制做了非常精密和精细的设计。当然考虑k8s从诞生到现在还不算太长，可能会陆续有一些漏洞和缺陷被发现，但至少到现在为止，它在模型设计上已经做得足够安全了。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;对于管理员来讲，整个k8s集群的apiserver是访问控制的唯一入口，但是如果我们在集群上部署了应用程序，通过Ingress或者通过Service把后端服务暴露出去，这些服务是不需要通过apiserver来访问的，只需要通过节点的NodePort或Ingress中Ingress Controller中的DaemonSet共享宿主机节点网络名称所监听的宿主机的地址来访问。&lt;br&gt;apiserver中的 api 是分了群组的，而且每一个群组还可以迭代，但是不管怎么样，任何用户试图到这平台上来操作资源对象，他们必须要经历所谓三种安全相关的操作：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、认证：任何客户端访问之前，经过apiserver操作之前，得先完成认证操作。用户得有正确的账号。&lt;/li&gt;
&lt;li&gt;2、授权检查：认证通过以后，只是证明了他是当前系统合法的用户，是否拥有删除对应资源的权限，还需要做授权检查。&lt;/li&gt;
&lt;li&gt;3、准入控制：授权检查完后，我们可以操作某些资源了，但是有些资源的操作还要级联到其他资源和相应的环境，才能满足它的相应条件。因此，级联到的其他资源用户是否有权限，以及他是不是在我们所指定的操作范围内。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;k8s是高度模块化设计的，它的认证、授权和准入控制各自都通过插件的方式，可由用户自定义选择经由什么样的插件来完成何种控制逻辑。&lt;/p&gt;
&lt;h2 id=&quot;认证&quot;&gt;&lt;a href=&quot;#认证&quot; class=&quot;headerlink&quot; title=&quot;认证&quot;&gt;&lt;/a&gt;认证&lt;/h2&gt;&lt;p&gt;对认证来讲，可能有n多个插件，支持多种不同的认证方式。&lt;/p&gt;
&lt;h3 id=&quot;令牌认证&quot;&gt;&lt;a href=&quot;#令牌认证&quot; class=&quot;headerlink&quot; title=&quot;令牌认证&quot;&gt;&lt;/a&gt;令牌认证&lt;/h3&gt;&lt;p&gt;所谓&lt;strong&gt;令牌认证&lt;/strong&gt;就是双方有一个域共享密钥，服务端存了一个密码，就像mysql认证一样，我们在服务器上先创建一个密码存放下来，随后登录时就拿这个密码登录。这种称为对称密钥登录方式。但是由于k8s提供的是restful风格的接口，它的所有服务都是通过http协议提供的，因此认证信息只能经由http协议的首部进行传递，这种首部在传递时，域共享密钥的编码信息我们称为认证令牌，就叫token。这是最简单的认证方式，&lt;strong&gt;但是这种认证，一般只是双方交换下是否拥有域共享密钥就足够了。&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;ssl认证&quot;&gt;&lt;a href=&quot;#ssl认证&quot; class=&quot;headerlink&quot; title=&quot;ssl认证&quot;&gt;&lt;/a&gt;ssl认证&lt;/h3&gt;&lt;p&gt;ssl认证能让客户端去确认服务器的身份。去和服务器端通信之前，先要求服务器发一个服务器证书过来，先看一看这个证书是否是我们认可的CA签署的。这是第一步。如果是我们认可的CA签署的，而且里面的签署信息与我们访问的服务器信息保持一致，那我们就认为这个服务器的身份得到认证了。但是在k8s通信当中，服务器还要认证客户端的身份。因此kubectl自己也应该有一个证书，有自己的私钥，而且这个证书必须是server端认可的CA所签署的证书。客户端身份也要与证书中标识的身份保持一致。所以双方都需要互相做双向证书认证。认证后双方实现ssl加密通信。&lt;/p&gt;
&lt;h3 id=&quot;其它认证方式&quot;&gt;&lt;a href=&quot;#其它认证方式&quot; class=&quot;headerlink&quot; title=&quot;其它认证方式&quot;&gt;&lt;/a&gt;其它认证方式&lt;/h3&gt;&lt;p&gt;其实认证还有很多种，以上只是比较常见的两种方式。认证插件可能会有很多，但是用户经过任何一个认证插件通过以后，即表示认证通过，无需经由其他插件进行检查。无需进行串行检查。&lt;/p&gt;
&lt;h2 id=&quot;授权&quot;&gt;&lt;a href=&quot;#授权&quot; class=&quot;headerlink&quot; title=&quot;授权&quot;&gt;&lt;/a&gt;授权&lt;/h2&gt;&lt;p&gt;k8s支持n种授权插件来完成用户的权限检查。k8s 1.6之后开始支持RBAC的认证，此前有ABAC之类的认证。现在用的比较广泛的、安全的就是RBAC。除此之外还有基于节点认证。最重要的是RBAC授权检查机制。Role Based Access Control，基于角色的访问控制机制。这种基于角色的访问控制机制一般只有许可授权，没有拒绝授权，因为默认都是拒绝的。&lt;br&gt;默认情况下使用kubeadm部署的k8s集群是强制启用了RBAC认证的，此前的操作到现在还没涉及到所谓授权操作控制逻辑，我们一直在使用k8s的最高管理权限，系统管理员cluster admin来实现操作，而不是普通用户。这就相当于在Linux上使用root用户去操作。随后如果使用admin这样的用户，或者其他普通用户，会发现很有可能这些用户只有只读权限，只能看见有哪些资源对象，而无法去创建、编辑和删除资源对象。所以RBAC可以做到非常灵活。&lt;br&gt;常见的插件：Node、ABAC、RBAC、Webhook。同样的，不需要串行检查。这些插件可以同时启用。我们也可以定义比较独特的访问控制逻辑。&lt;/p&gt;
&lt;h2 id=&quot;准入控制&quot;&gt;&lt;a href=&quot;#准入控制&quot; class=&quot;headerlink&quot; title=&quot;准入控制&quot;&gt;&lt;/a&gt;准入控制&lt;/h2&gt;&lt;p&gt;一般而言，准入控制本身只是用来定义对应授权检查完后，后续的其他安全检查操作。了解即可。&lt;/p&gt;
&lt;h2 id=&quot;apiserver如何校验请求&quot;&gt;&lt;a href=&quot;#apiserver如何校验请求&quot; class=&quot;headerlink&quot; title=&quot;apiserver如何校验请求&quot;&gt;&lt;/a&gt;apiserver如何校验请求&lt;/h2&gt;&lt;p&gt;客户端对apiserver发起操作请求，apiserver要识别这个用户能不能执行他请求的操作：&lt;br&gt;1、用户账号user：username、uid&lt;br&gt;2、用户所属的组group：&lt;br&gt;3、extra：用来提供一些额外信息&lt;/p&gt;
&lt;p&gt;用户拿着这用户账号去请求时，一定会请求某个特定的api资源，而k8s的apiserver是分了组的，所以到底向哪个组的哪个版本的api资源对象发出请求，必须要进行标识，而标识则通过用户在http协议当中，request path来标识，比如访问apps下的v1版本的某个资源，资源要么属于集群，要么在名称空间下，名称空间属于集群级别的，所有名称空间级别的资源访问时都要指明名称空间：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;http://172.20.0.70:6443/apis/apps/v1/namespaces/default/deployments/myapp-deploy/&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们可以基于请求这个url来增删改查，此前执行的kubectl create、delete等事实上都被转换成一个http协议的请求来请求的。&lt;br&gt;可以演示下，api服务只监听在6443上，它是https的，双向都要做证书认证。我们的curl本地是没有认证的。可以换一种方式。在本地启一个代理。这是kubectl自带的功能。首先kubectl自身有认证能力，其自带的配置文件中拥有认证信息，如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# cat .kube/config&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/171.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;所以如果要使用curl请求apiserver是要带着认证信息的，但是curl没有认证信息。在kubectl节点上，运行kubectl proxy命令，就相当于这个家伙在本地作为服务运行了，它监听在我们指定的端口上，为了安全起见，一般监听在127.0.0.1:8080，端口可以自己指定。随后使用curl命令，就访问本地的8080端口，然后由kubectl反向代理至apiserver。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/172.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl proxy --port=8080&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Starting to serve on 127.0.0.1:8080&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在另一个终端上使用curl访问apiserver：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# curl http://localhost:8080/api/v1/namespaces&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/173.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;【注意】：只有是核心群组的资源，访问时是/api/，其他的都是/apis/group_name/version/&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# curl http://localhost:8080/apis/apps/v1/namespaces/kube-system/deployments&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/174.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;只看某个具体的对象:&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# curl http://localhost:8080/apis/apps/v1/namespaces/kube-system/deployments/coredns&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;HTTP request verb: 对于指定的资源做什么操作。在restful风格中我们称为action，操作，verb也是操作的。&lt;br&gt;get, post, put, delete API &lt;/li&gt;
&lt;li&gt;requests verb: 上面http的请求方法要转成对API对象的请求。也就是映射到k8s语境中对应的请求有哪些：&lt;br&gt;get, list, create, update, patch, watch, proxy, redirect, delete, deletecollection &lt;/li&gt;
&lt;li&gt;Resource: 请求哪个资源，一般是资源的id，或者资源的名称，不同的方法中可能不一样&lt;/li&gt;
&lt;li&gt;Subresource: 有些资源可能还有子资源，restful风格中允许有子资源的&lt;/li&gt;
&lt;li&gt;Namespace：名称空间&lt;/li&gt;
&lt;li&gt;API group：所属的api群组&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;上述示例中的request path中已经把上述的都表达出来了。&lt;/p&gt;
&lt;h2 id=&quot;serviceaccount&quot;&gt;&lt;a href=&quot;#serviceaccount&quot; class=&quot;headerlink&quot; title=&quot;serviceaccount&quot;&gt;&lt;/a&gt;serviceaccount&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;1、集群外部的客户端：比如访问apiserver对外通信的监听地址 6443端口&lt;/li&gt;
&lt;li&gt;2、Pod中容器里的应用程序访问api&lt;br&gt;比如运行系统级的服务CoreDNS，需要从api获取用户到底创建什么Service，给Service创建解析记录。创建k8s的图形控制接口Dashboard，这个Dashboard的Pod可以通过Service暴露到集群外部去，可以通过一个浏览器打开它，而用户有可能通过此Dashboard在当前集群中增删改查资源，所以这个Pod也得跟apiserver打交道。Pod和apiserver通信使用的是apiserver在集群内的地址。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/175.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;客户端与apiserver通信，&lt;/strong&gt;首先apiserver要把自己的证书传给客户端，客户端去校验apiserver身份，同时apiserver还要去校验客户端身份。服务器apiserver发给它的客户端Pod的时候，证书中标明自己的身份不能是172.16.206.32这个地址，而应该是10.96.0.1，因为客户端访问的是10.96.0.1。所以在apiserver上，如果自己手动建立证书，那么必须确保这个证书的持有者的名称能解析到两条A记录。或者在证书里使用IP地址，这两个地址都得包含进来。另外，Pod客户端也得有证书，apiserver也得验证客户端。此前我们使用kubectl，我们给它提供了配置文件，能进行认证。Pod跟apiserver打交道，怎么认证呢？认证不应该是由Pod内的应用程序来提供的，而是应该由Pod来提供。这些信息在哪里？&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pod.spec&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/176.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;整个k8s的apiserver的账号有两类：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;一类是实实在在的现实中的人类用户。kubectl不会自己去访问，一定是人去发起它去访问的；&lt;/li&gt;
&lt;li&gt;第二类用户叫 Pod客户端。人用的账号叫&lt;strong&gt;useraccount&lt;/strong&gt;，Pod去连接apiserver时使用的账号叫&lt;strong&gt;serviceaccount&lt;/strong&gt;。事实上每一个Pod都需要与apiserver打交道，只不过它的权限有大有小而已。默认每一个Pod在运行时，它都会有相关信息的。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubeNAME      READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-0   1/1     Running   0          2d15h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-1   1/1     Running   0          2d15h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-2   1/1     Running   0          2d15h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-3   1/1     Running   0          2d15h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-4   1/1     Running   0          2d15h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl describe pod myapp-0&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/177.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;随便看一个Pod，里面默认就有一个存储卷下面有个default-token，token是令牌，这就是Pod serviceaccount认证时用到认证信息，因为认证信息毕竟是敏感信息，所以通过secret来定义。并以存储卷的形式关联到Pod之上，从而让Pod内运行的应用通过secret中保存的认证信息来连接apiserver，并完成认证的。这就是每一个名称空间中都有一个默认的secret的原因。让名称空间所有的Pod资源试图去联系apiserver时预置的一个认证信息。所以所有Pod都可以连接apiserver。当然这个secret中包含的认证信息仅仅是获取当前Pod自身的相关属性，不能随便看别人的。如果我们想扩展一个Pod，比如有个pod，打算让它去管其他pod的，那我们就必须得自己手动创建一个serviceaccount，并且创建pod时附加这个我们自己定义的serviceaccount。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/178.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;serviceaccount示例&quot;&gt;&lt;a href=&quot;#serviceaccount示例&quot; class=&quot;headerlink&quot; title=&quot;serviceaccount示例&quot;&gt;&lt;/a&gt;serviceaccount示例&lt;/h2&gt;&lt;p&gt;serviceaccount也属于标准的k8s资源，可以创建一个serviceaccount，创建完以后，然后在定义Pod时，有个spec.serviceAccountName字段可以加载这个我们定义的serviceaccount。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl create serviceaccount --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Create a service account with the specified name.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Aliases:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceaccount, sa&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Create a new service account named my-service-account&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create serviceaccount my-service-account&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Options:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --allow-missing-template-keys=true: If true, ignore any errors in templates when a field or map key is missing in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the template. Only applies to golang and jsonpath output formats.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --dry-run=false: If true, only print the object that would be sent, without sending it.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --generator=&amp;apos;serviceaccount/v1&amp;apos;: The name of the API generator to use.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -o, --output=&amp;apos;&amp;apos;: Output format. One of:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;json|yaml|name|go-template|go-template-file|template|templatefile|jsonpath|jsonpath-file.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --save-config=false: If true, the configuration of current object will be saved in its annotation. Otherwise, the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;annotation will be unchanged. This flag is useful when you want to perform kubectl apply on this object in the future.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --template=&amp;apos;&amp;apos;: Template string or path to template file to use when -o=go-template, -o=go-template-file. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;template format is golang templates [http://golang.org/pkg/text/template/#pkg-overview].&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --validate=true: If true, use a schema to validate the input before sending it&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create serviceaccount NAME [--dry-run] [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl options&amp;quot; for a list of global command-line options (applies to all commands).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;创建时可以只给个serviceaccount名字，因为serviceaccount本身不带权限，只不过是个账号而已，我们将来可以使用RBAC来实现对这个serviceaccount授予更大的权限。所以授权不属于serviceaccount，我们只不过可以换个专用账号给这个Pod。回头可以给这个专用账号授予更大的权限。肯定不能把权限授予默认的serviceaccount，会导致这个名称空间的所有Pod都会拥有这个serviceaccount所拥有的权限。能认证不代表权限。&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl create serviceaccount mysa --dry-run&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceaccount/mysa created (dry run)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You have mail in /var/spool/mail/root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl create serviceaccount mysa -o yaml --dry-run&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: ServiceAccount&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  creationTimestamp: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: mysa&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此前创建每个资源都是自己手动写yaml文件，现在这是快捷方法了。如果某个资源支持在命令行创建，那么可以使用–dry-run这种方式生成一个框架。可以使用输出重定向保存到文件中，拿来改一改就行了。还有一种方式：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods myapp-0 -o yaml --export&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;–export：显示的内容比较贴切我们手动写的yaml文件的内容。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl create sa admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceaccount/admin created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get sa&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME      SECRETS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;admin     1         47s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;default   1         152d&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/179.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim pod-sa-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-sa-demo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    wisedu.com/created-by: &amp;quot;cluster admin&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  serviceAccountName: admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f pod-sa-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-sa-demo created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl describe pod pod-sa-demo&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/180.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;【补充】：我们写的资源清单，提交给apiserver时，apiserver告诉kubelet，node节点要创建运行一个Pod，而这个Pod中的容器的启动要依赖于一个私有registry之上的镜像时，认证信息是放到secret中的。然后Pod清单文件中，pods.spec.imagePullSecrets引用secret。但是这种认证方式可能有一些缺陷，因此我们也可以在Pod中不使用imagePullSecrets，而是直接使用serviceAccountName。这个sa账号是可以附带认证到私有registry上的secret信息的。这样子我们在Pod配置文件清单中就不会泄露出去secret到底用的是哪个相关信息了。因为只能看见sa。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/181.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;上面我们已经看到了serviceaccount可以使用token信息，而token其实就是一串base64编码的子串，它实际上是个域共享密钥。我们系统会自动生成，当然你也可以手动创建。&lt;br&gt;TLS认证，双向认证无非是双方都配置证书和私钥，而且双方都要认可CA颁发的证书。不过这在k8s上用的证书一般都是私有CA做的证书，而且这个私有CA千万不要轻易授权证书出去，因为做的任何一个证书出去，都可以被人家拿来当做客户端来连接apiserver完成认证。所以这个CA应该是专用CA，不会去做任何其他事情。&lt;/p&gt;
&lt;h2 id=&quot;kubectl认证&quot;&gt;&lt;a href=&quot;#kubectl认证&quot; class=&quot;headerlink&quot; title=&quot;kubectl认证&quot;&gt;&lt;/a&gt;kubectl认证&lt;/h2&gt;&lt;p&gt;kubectl使用配置文件来认证。&lt;br&gt;kubectl config –help  用来管理kubectl的配置文件。所有连往apiserver的客户端，在认证时，如果我们要基于配置文件来保存认证信息，而不是刚才看到serviceaccount使用token来认证，我们就应该为它配置一个配置文件。&lt;br&gt;k8s集群中的所有组件，除了apiserver之外的组件，像controller-manager、Scheduler都想要连入apiserver，都需要被apiserver所认证。所以它们都算的上是apiserver的客户端，包括kubectl。那么这每个组件为了能够连入正确的apiserver，需要提供正确的账号、证书、私钥等认证需要的信息，或者token。我们需要把这些信息保存为一个配置文件。这个配置文件有个专门的称呼，叫&lt;strong&gt;kubeconfig&lt;/strong&gt;。是apiserver的客户端连入apiserver时使用的认证格式的客户端配置文件。kubectl也是这样的客户端，它也有自己的配置文件，可以使用kubectl config view来查看。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl config view&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusters:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- cluster:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    certificate-authority-data: DATA+OMITTED&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server: https://172.16.206.32:6443&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;contexts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- context:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    cluster: kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    user: kubernetes-admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: kubernetes-admin@kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;current-context: kubernetes-admin@kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Config&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;preferences: &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;users:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- name: kubernetes-admin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  user:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    client-certificate-data: REDACTED&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    client-key-data: REDACTED&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;kubectl的配置文件是 ~/.kube/config。&lt;br&gt;&lt;strong&gt;这个配置文件格式和资源清单文件有点像，解释几个字段：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;clusters：集群列表。可以有多个集群。&lt;ul&gt;
&lt;li&gt;certificate-authority-data: REDACTED 认证到这个集群，这个集群发过来的证书用什么方式去检验&lt;/li&gt;
&lt;li&gt;server: &lt;a href=&quot;https://172.20.0.70:6443&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://172.20.0.70:6443&lt;/a&gt; –集群的apiserver监听的外部地址&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;users：用户列表，可以有多个。&lt;ul&gt;
&lt;li&gt;certificate-authority-data: REDACTED –客户端证书&lt;/li&gt;
&lt;li&gt;client-key-data: REDACTED  –客户端私钥&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;contents：上下文列表。用哪个账号访问哪个集群。&lt;br&gt;列表，每个content还有个name&lt;/li&gt;
&lt;li&gt;current-content：当前上下文。当前是用哪个账号访问哪个集群的。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这个配置文件不单单是用来访问一个集群的，如果有多个k8s集群，但是只有一台机器作为客户端，一会想访问A集群，一会想访问B集群。为了让一个kubectl能控制多个集群，比如下面有3个集群，每个集群上所用的账号可能是不一样的，所以配置文件中有这么几项配置：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;集群列表，A、B、C三个集群&lt;/li&gt;
&lt;li&gt;对于每个集群来讲，可能会用到不同的账号，于是有了用户列表。&lt;/li&gt;
&lt;li&gt;打算用哪个用户访问哪个集群，假设第一个账号和第二个账号都是访问第一个集群的，而第二个集群和第三个集群的账号都是第三个账号，两个集群有着同一个名字的账号，这是有这种可能性的。因此就需要定义contents了，使用哪个账号访问哪个集群。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;使用kubeadm创建集群，它会把当前这个集群初始化的过程中创建多个私有CA，其中有一个CA是跟apiserver相关的。如下:&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# ls /etc/kubernetes/pki/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiserver.crt              apiserver-etcd-client.key  apiserver-kubelet-client.crt  ca.crt  etcd                front-proxy-ca.key      front-proxy-client.key  sa.pub&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiserver-etcd-client.crt  apiserver.key              apiserver-kubelet-client.key  ca.key  front-proxy-ca.crt  front-proxy-client.crt  sa.key&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中ca.crt 和 ca.key。&lt;br&gt;如果有需要，我们也可以自己用这个ca来签署一个自己自定义的证书和私钥，拿来做认证都没问题。只要是apiserver信任的ca签署的证书，都可以认证连入集群的。&lt;br&gt;接下来可以来创建自己的账号了，不可以使用这个目录下的其他证书和私钥，主要证书里的CN是用户名，pki下面的证书的里的CN都是已经定义了的名字。这里自做一组证书和私钥，作为另外一个账号去认证到apiserver上的证书文件。&lt;br&gt;创建的账号不是操作系统账号，而是连接apiserver的账号，需要先创建一个私钥，生成一个签署证书，证书中的证书持有者跟用户的用户名必须保持一致，就是证书的subject。&lt;/p&gt;
&lt;p&gt;生成私钥：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# cd /etc/kubernetes/pki/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# (umask 077; openssl genrsa -out wisedu.key 2048)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Generating RSA private key, 2048 bit long modulus&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.+++&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;....+++&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;e is 65537 (0x10001)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;生成证书签署请求：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# openssl req -new -key wisedu.key -out wisedu.csr -subj &amp;quot;/CN=wisedu&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;使用CA去签署证书：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# openssl x509 -req -in wisedu.csr -CA ./ca.crt  -CAkey ./ca.key -CAcreateserial -out wisedu.crt -days 3650 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Signature ok&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;subject=/CN=wisedu&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Getting CA Private Key&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看证书内容，以文本输出：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# openssl x509 -in wisedu.crt -text -noout&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/182.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;接下来我们把这个用户账号信息添加到kubectl配置文件中，这个账号是由Kubernetes集群的CA创建的证书，所以认证不会有任何问题。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# kubectl config --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Modify kubeconfig files using subcommands like &amp;quot;kubectl config set current-context my-context&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; The loading order follows these rules:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  1.  If the --kubeconfig flag is set, then only that file is loaded. The flag may only be set once and no merging takes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;place.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  2.  If $KUBECONFIG environment variable is set, then it is used as a list of paths (normal path delimiting rules for&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;your system). These paths are merged. When a value is modified, it is modified in the file that defines the stanza. When&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;a value is created, it is created in the first file that exists. If no files in the chain exist, then it creates the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;last file in the list.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  3.  Otherwise, $&amp;#123;HOME&amp;#125;/.kube/config is used and no merging takes place.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Available Commands:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  current-context Displays the current-context&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  delete-cluster  Delete the specified cluster from the kubeconfig&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  delete-context  Delete the specified context from the kubeconfig&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  get-clusters    Display clusters defined in the kubeconfig&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  get-contexts    Describe one or many contexts&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  rename-context  Renames a context from the kubeconfig file.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  set             Sets an individual value in a kubeconfig file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  set-cluster     Sets a cluster entry in kubeconfig&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  set-context     Sets a context entry in kubeconfig&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  set-credentials Sets a user entry in kubeconfig&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  unset           Unsets an individual value in a kubeconfig file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  use-context     Sets the current-context in a kubeconfig file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  view            Display merged kubeconfig settings or a specified kubeconfig file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl config SUBCOMMAND [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl &amp;lt;command&amp;gt; --help&amp;quot; for more information about a given command.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl options&amp;quot; for a list of global command-line options (applies to all commands).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# kubectl config set-credentials --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Sets a user entry in kubeconfig&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Specifying a name that already exists will merge new fields on top of existing values.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Client-certificate flags:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  --client-certificate=certfile --client-key=keyfile&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Bearer token flags:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    --token=bearer_token&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Basic auth flags:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    --username=basic_user --password=basic_password&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Bearer token and basic auth are mutually exclusive.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Set only the &amp;quot;client-key&amp;quot; field on the &amp;quot;cluster-admin&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # entry, without touching other values:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl config set-credentials cluster-admin --client-key=~/.kube/admin.key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Set basic auth for the &amp;quot;cluster-admin&amp;quot; entry&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl config set-credentials cluster-admin --username=admin --password=uXFGweU9l35qcif&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Embed client certificate data in the &amp;quot;cluster-admin&amp;quot; entry&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl config set-credentials cluster-admin --client-certificate=~/.kube/admin.crt --embed-certs=true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Enable the Google Compute Platform auth provider for the &amp;quot;cluster-admin&amp;quot; entry&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl config set-credentials cluster-admin --auth-provider=gcp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Enable the OpenID Connect auth provider for the &amp;quot;cluster-admin&amp;quot; entry with additional args&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl config set-credentials cluster-admin --auth-provider=oidc --auth-provider-arg=client-id=foo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;--auth-provider-arg=client-secret=bar&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Remove the &amp;quot;client-secret&amp;quot; config value for the OpenID Connect auth provider for the &amp;quot;cluster-admin&amp;quot; entry&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl config set-credentials cluster-admin --auth-provider=oidc --auth-provider-arg=client-secret-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Options:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --auth-provider=&amp;apos;&amp;apos;: Auth provider for the user entry in kubeconfig&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --auth-provider-arg=[]: &amp;apos;key=value&amp;apos; arguments for the auth provider&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --embed-certs=false: Embed client cert/key for the user entry in kubeconfig&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl config set-credentials NAME [--client-certificate=path/to/certfile] [--client-key=path/to/keyfile]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[--token=bearer_token] [--username=basic_user] [--password=basic_password] [--auth-provider=provider_name]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[--auth-provider-arg=key=value] [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl options&amp;quot; for a list of global command-line options (applies to all commands).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/183.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# kubectl config set-credentials wisedu --client-certificate=./wisedu.crt --client-key=./wisedu.key --embed-certs=true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;User &amp;quot;wisedu&amp;quot; set.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;–embed-certs=true 表示把证书隐藏起来。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# kubectl config view&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/184.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;设置个上下文，让wisedu这个用户账号也能访问k8s集群。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# kubectl config set-context wisedu@kubernetes --cluster=kubernetes --user=wisedu&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Context &amp;quot;wisedu@kubernetes&amp;quot; created.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# kubectl config view&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/185.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;设置当前上下文，即设置使用这个用户wisedu访问集群kubernetes：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# kubectl config use-context wisedu@kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Switched to context &amp;quot;wisedu@kubernetes&amp;quot;.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Error from server (Forbidden): pods is forbidden: User &amp;quot;wisedu&amp;quot; cannot list resource &amp;quot;pods&amp;quot; in API group &amp;quot;&amp;quot; in the namespace &amp;quot;default&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个用户可没有管理员权限。&lt;br&gt;以上少演示了一个步骤，就是添加集群，因为这里只有一个集群。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# kubectl config set-cluster --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Sets a cluster entry in kubeconfig.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Specifying a name that already exists will merge new fields on top of existing values for those fields.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Set only the server field on the e2e cluster entry without touching other values.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl config set-cluster e2e --server=https://1.2.3.4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Embed certificate authority data for the e2e cluster entry&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl config set-cluster e2e --certificate-authority=~/.kube/e2e/kubernetes.ca.crt&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Disable cert checking for the dev cluster entry&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl config set-cluster e2e --insecure-skip-tls-verify=true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Options:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --embed-certs=false: embed-certs for the cluster entry in kubeconfig&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl config set-cluster NAME [--server=server] [--certificate-authority=path/to/certificate/authority]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[--insecure-skip-tls-verify=true] [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl options&amp;quot; for a list of global command-line options (applies to all commands).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;现在把当前上下文切换回来，使用一个新的配置文件来演示，有一个选项–kubeconfig可以指定配置文件路径。&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# kubectl config use-context kubernetes-admin@kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Switched to context &amp;quot;kubernetes-admin@kubernetes&amp;quot;.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;设置一个集群：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# kubectl config set-cluster mycluster --kubeconfig=/tmp/test.conf --server=&amp;quot;https://172.16.206.32:6443&amp;quot; --certificate-authority=/etc/kubernetes/pki/ca.crt --embed-certs=true   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Cluster &amp;quot;mycluster&amp;quot; set.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You have mail in /var/spool/mail/root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pki]# kubectl config view --kubeconfig=/tmp/test.conf &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusters:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- cluster:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    certificate-authority-data: DATA+OMITTED&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server: https://172.16.206.32:6443&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: mycluster&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;contexts: []&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;current-context: &amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Config&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;preferences: &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;users: []&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Kubernetes安全概述&quot;&gt;&lt;a href=&quot;#Kubernetes安全概述&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes安全概述&quot;&gt;&lt;/a&gt;Kubernetes安全概述&lt;/h2&gt;&lt;p&gt;对于k8s api接口的访问不会是任何人能够轻易使用的，此前我们是通过kubectl这个客户端工具进行访问的，如果人人都可以通过kubectl来访问，那么就很可能会删除别人的应用，这是非常危险的。因此k8s对于整个系统的认证、授权和所谓的后续的访问控制做了非常精密和精细的设计。当然考虑k8s从诞生到现在还不算太长，可能会陆续有一些漏洞和缺陷被发现，但至少到现在为止，它在模型设计上已经做得足够安全了。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes StatefulSet控制器</title>
    <link href="http://yoursite.com/2019/08/30/Kubernetes-StatefulSet%E6%8E%A7%E5%88%B6%E5%99%A8/"/>
    <id>http://yoursite.com/2019/08/30/Kubernetes-StatefulSet控制器/</id>
    <published>2019-08-30T02:05:57.000Z</published>
    <updated>2019-09-09T09:41:33.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;StatefulSet介绍&quot;&gt;&lt;a href=&quot;#StatefulSet介绍&quot; class=&quot;headerlink&quot; title=&quot;StatefulSet介绍&quot;&gt;&lt;/a&gt;StatefulSet介绍&lt;/h2&gt;&lt;p&gt;简称sts。&lt;br&gt;不同的分布式系统运维管理逻辑和运维操作过程是不尽相同的。因此没有办法有一种控制器把每一种功能都同步进来，让我们非常简单地去操作这些有状态应用。即便有了StatefulSet，我们用StatefulSet去实现真正功能控制时也是极其麻烦的。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;StatefulSet即便在一定程度上能实现有状态应用的管理，但是我们需要自行把对某个应用的运维管理过程写成脚本注入到StatefulSet的文件中，才能使用。&lt;br&gt;好在Kubernetes支持叫做TPR，后来变为CRD了，第三方资源或自定义资源。甚至于还支持其他更为复杂的机制，比如叫api聚合。当我们使用api聚合时，就需要自己去修改k8s源代码，增强我们自己所需要的功能。好在k8s很有弹性，支持非常灵活的扩展功能。后来CoreOS提供了一个组件叫Operator。我们可以把操作封装到这个组件中。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;StatefulSet管理有以下几个特点的Pod：&lt;/strong&gt;&lt;br&gt;1、稳定且惟一的网络标识符;&lt;br&gt;2、稳定且持久的存储;&lt;br&gt;3、有序、平滑地部署和扩展;&lt;br&gt;比如像redis的主从集群，应该先启动主节点，然后在启动从节点。从节点如果没有先后顺序，可以一下子全启动，如果有先后次序，可能要求串行来，先启动一个从，在启动第二个从…&lt;br&gt;4、有序、平滑地终止和删除;&lt;br&gt;比如现在要缩减redis集群的规模，现在的架构是一主八从的，在关闭的时候应该把这个8个从节点先关掉，而且关的时候，如果启动的时候是串行启动的，关的时候也得串行关。比如8个从节点，名字分别是r1-r8，应该先关r8，在关r7，逆序来进行。&lt;br&gt;5、有序的滚动更新;&lt;br&gt;假如仍然是主从服务器，应该先滚动更新从节点，而且是逆序的。先更新r8，在更新r7。。。把所有的从都更新完了，在去更新主节点。因为从节点的版本高的特性能兼容版本低的，反过来不行。当然更新完后要确保它们的特性能互相兼容，如果不兼容，更新谁都不行。&lt;/p&gt;
&lt;p&gt;一般来讲，一个典型的StatefulSet由3个组件组成：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;headless service：&lt;/strong&gt;之前使用Deployment的时候，Pod是没有顺序的，随机字符串。我们无法识别这些Pod的顺序。因此是无序的。但是在StatefulSet中要求这些Pod必须是有序的。多个Pod有主从之分，启动时有顺序r1-r8，终止时也有顺序r8-r1。每一个节点，每一个Pod都不能随意被别的所取代。比如r6因为有故障重建了，那它重建还应该是r6。尤其是redis cluster最容易理解，redis里面有很多槽位来存数据，比如第一个节点1-5000，第二个节点5001-10000，第三个10001到16383。第一个节点挂了，随后替换出来的时候它没有顺序了，这事情就很麻烦。因为只有靠数据才能识别它是管理哪些槽位的。因为Pod的IP地址会变化的，所以我们不以IP地址来识别，而是以Pod名称来识别。所以Pod名称不能变。在有状态的集中，每一个Pod的名称都不能变，删了Pod，被重建的Pod的名称还必须得是此前Pod的名字。所以Pod的名称是作为识别Pod唯一性的标识符。这个标识符必须稳定持久有效。怎么能保证Pod标识符持久稳定有效呢？这个时候就需要用到headless service来确保我们解析的名称是直达后端Pod的IP地址，并确保给每一个Pod配置一个唯一的名称。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;StatefulSet控制器：&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;volumeClaimTemplate：&lt;/strong&gt;存储卷申请模板。大多数有状态副本集都会用到一个功能，都会用到持久存储。仍然以redis为例，做一个redis cluster在3个Pod存储数据不一样，对分布式系统，它的最大特点就是数据是不一样的，所以这3个Pod能不能使用一个共享的后端存储。比如我做了一个NFS存储卷，3个Pod多路读写同一个存储卷肯定是不行的。如果是web服务，网页文件放在同一个存储卷上，3个Pod都挂载这个存储卷，向客户端提供服务是没有问题的。但是3个redis的Pod使用同一个存储卷是不行的，3个Pod存的数据是不一样的，因此不能使用同一个存储卷，每个Pod应该有自己专用的存储卷。这些数据有可能是重名的，一重名就覆盖掉了，所以不能使用同一个存储卷。如果在Deployment中的Pod的template中定义一个存储卷，如果你Deployment中定义的Pod副本是5个，那么这5个Pod使用的将是同一个存储卷。因此我们基于Pod的template创建Pod是不适用的。这就为什么要定义volumeClaimTemplate的原因。这样我们创建每一个Pod时，它会自动生成一个pvc，从而请求绑定一个pv，从而有自己专用的存储卷。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;StatefulSet示例&quot;&gt;&lt;a href=&quot;#StatefulSet示例&quot; class=&quot;headerlink&quot; title=&quot;StatefulSet示例&quot;&gt;&lt;/a&gt;StatefulSet示例&lt;/h2&gt;&lt;p&gt;之前NFS服务器输出了5个目录。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@dingding volumes]# showmount -e 172.16.6.73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Export list for 172.16.6.73:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v5 172.16.206.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v4 172.16.206.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v3 172.16.206.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v2 172.16.206.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v1 172.16.206.0/24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pv&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM           STORAGECLASS   REASON   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv001   10Mi       RWO,RWX        Retain           Available                                           8d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv002   20Mi       RWO            Retain           Available                                           8d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv003   50Mi       RWO,RWX        Retain           Bound       default/mypvc                           8d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv004   50Mi       RWO,RWX        Retain           Available                                           8d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv005   50Mi       RWO,RWX        Retain           Available                                           8d&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;先清理掉集群上的deploy、svc、pod、pvc资源。&lt;br&gt;对于pv，我这里用的是默认策略：Retain，之前有个pv被pvc绑定了，虽然删除了这个pvc，pv变成了Released状态，但是这个pv依然不能为其他pvc所用。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pvc-pv]# kubectl get pv&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM           STORAGECLASS   REASON   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv001   10Mi       RWO,RWX        Retain           Available                                           8d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv002   20Mi       RWO            Retain           Available                                           8d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv003   50Mi       RWO,RWX        Retain           Released    default/mypvc                           8d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv004   50Mi       RWO,RWX        Retain           Available                                           8d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv005   50Mi       RWO,RWX        Retain           Available                                           8d&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;只能先删除了这个pv，然后在重新创建pv。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pvc-pv]# kubectl delete pv pv003 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;persistentvolume &amp;quot;pv003&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pvc-pv]# kubectl apply -f pv-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;persistentvolume/pv001 unchanged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;persistentvolume/pv002 unchanged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;persistentvolume/pv003 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;persistentvolume/pv004 unchanged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;persistentvolume/pv005 unchanged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pvc-pv]# kubectl get pv&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv001   10Mi       RWO,RWX        Retain           Available                                   24s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv002   20Mi       RWO            Retain           Available                                   24s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv003   50Mi       RWO,RWX        Retain           Available                                   12s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv004   50Mi       RWO,RWX        Retain           Available                                   23s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv005   50Mi       RWO,RWX        Retain           Available                                   23s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例1：创建StatefulSet-demo&quot;&gt;&lt;a href=&quot;#示例1：创建StatefulSet-demo&quot; class=&quot;headerlink&quot; title=&quot;示例1：创建StatefulSet demo&quot;&gt;&lt;/a&gt;示例1：创建StatefulSet demo&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim statefulSet-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: myapp-svc-headless&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp-svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp-pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - port: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name: web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  clusterIP: None&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;---&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: StatefulSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  replicas: 3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  serviceName: myapp-svc-headless&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    matchLabels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      app: myapp-pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  template:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        app: myapp-pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        image: ikubernetes/myapp:v5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          name: web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        volumeMounts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - name: myappdata&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          mountPath: /usr/share/nginx/html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  volumeClaimTemplates:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      name: myappdata&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      accessModes: [&amp;quot;ReadWriteOnce&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      resources:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        requests:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          storage: 10Mi&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/163.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/164.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f statefulSet-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/myapp-svc-headless created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;statefulset.apps/myapp created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes           ClusterIP   10.96.0.1    &amp;lt;none&amp;gt;        443/TCP   149d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-svc-headless   ClusterIP   None         &amp;lt;none&amp;gt;        80/TCP    69s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get sts&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME    READY   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp   3/3     38s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME      READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-0   1/1     Running   0          42s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-1   1/1     Running   0          32s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-2   1/1     Running   0          23s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pv&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                       STORAGECLASS   REASON   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv001   10Mi       RWO,RWX        Retain           Bound       default/myappdata-myapp-1                           50s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv002   20Mi       RWO            Retain           Bound       default/myappdata-myapp-0                           50s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv003   50Mi       RWO,RWX        Retain           Bound       default/myappdata-myapp-2                           50s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv004   50Mi       RWO,RWX        Retain           Available                                                       50s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv005   50Mi       RWO,RWX        Retain           Available                                                       50s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如上所示：Pod的名称不再是随机的了。&lt;br&gt;&lt;strong&gt;volumeClaimTemplate&lt;/strong&gt;做了两件事：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;第一为每一个Pod定义了volumes&lt;/li&gt;
&lt;li&gt;第二在Pod所在的名称空间中自动创建了pvc 【注意】：直接删除这个StatefulSet，是不会删除生成的pvc的&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;删除StatefulSet，看看pod是否是倒序删除的：&lt;br&gt;在一个终端上监控着pods：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods -w&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME      READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-0   1/1     Running   0          9m42s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-1   1/1     Running   0          9m32s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-2   1/1     Running   0          9m23s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-0   1/1     Terminating   0          10m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-2   1/1     Terminating   0          10m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-1   1/1     Terminating   0          10m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-0   0/1     Terminating   0          10m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-2   0/1     Terminating   0          10m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-1   0/1     Terminating   0          10m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-0   0/1     Terminating   0          10m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-0   0/1     Terminating   0          10m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-1   0/1     Terminating   0          10m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-1   0/1     Terminating   0          10m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-2   0/1     Terminating   0          10m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-2   0/1     Terminating   0          10m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在另一个终端上删除这个StatefulSet：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete -f statefulSet-demo.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这样看不明显，重新创建下，看下创建过程：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/165.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pv&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                       STORAGECLASS   REASON   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv001   10Mi       RWO,RWX        Retain           Bound       default/myappdata-myapp-1                           50s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv002   20Mi       RWO            Retain           Bound       default/myappdata-myapp-0                           50s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv003   50Mi       RWO,RWX        Retain           Bound       default/myappdata-myapp-2                           50s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv004   50Mi       RWO,RWX        Retain           Available                                                       50s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv005   50Mi       RWO,RWX        Retain           Available                                                       50s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;只要使用同一个StatefulSet去创建，创建后就会绑定相应的pvc上去。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl describe pod myapp-2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;对于StatefulSet来说，也支持动态更新，或者叫滚动更新，也支持扩容和缩容。比如从现在的3个扩展到4个，它会为第4个Pod专门在创建个pvc，满足5Gi空间的pvc。而后创建个有名字的Pod，使得它能够正常工作起来。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/166.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;解析Pod的名称时，Pod必须跟上它无头服务的名称：&lt;/strong&gt;&lt;br&gt;pod_name.service_name.ns_name.svc.cluster.local&lt;br&gt;在本示例中：myapp-0.myapp.default.svc.cluster.local&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/167.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;每一个Pod名称是固定的，DNS中能解析，所以我们靠这唯一名称去识别它以后，跟它的固定名称的pvc保持对应关系，pvc的名字隐含了pod的名字，使得pvc能够持续地给同一个Pod使用。&lt;/p&gt;
&lt;h3 id=&quot;示例2：扩容缩容&quot;&gt;&lt;a href=&quot;#示例2：扩容缩容&quot; class=&quot;headerlink&quot; title=&quot;示例2：扩容缩容&quot;&gt;&lt;/a&gt;示例2：扩容缩容&lt;/h3&gt;&lt;p&gt;使用scale或patch。&lt;br&gt;现在有5个pv，还有2个没用，扩展到5个Pod，扩展的时候是先扩展第4个，在扩展第5个。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl scale sts myapp --replicas=5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;statefulset.apps/myapp scaled&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/168.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;接着缩减至2个：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl patch sts myapp -p &amp;apos;&amp;#123;&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;replicas&amp;quot;: 2&amp;#125;&amp;#125;&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;statefulset.apps/myapp patched&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/169.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例3：升级StatefulSet中的应用程序版本&quot;&gt;&lt;a href=&quot;#示例3：升级StatefulSet中的应用程序版本&quot; class=&quot;headerlink&quot; title=&quot;示例3：升级StatefulSet中的应用程序版本&quot;&gt;&lt;/a&gt;示例3：升级StatefulSet中的应用程序版本&lt;/h3&gt;&lt;p&gt;使用set image。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain sts.spec.updateStrategy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     StatefulSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: updateStrategy &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     updateStrategy indicates the StatefulSetUpdateStrategy that will be&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     employed to update Pods in the StatefulSet when a revision is made to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Template.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     StatefulSetUpdateStrategy indicates the strategy that the StatefulSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     controller will use to perform updates. It includes any additional&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     parameters necessary to perform the update for the indicated strategy.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   rollingUpdate        &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RollingUpdate is used to communicate parameters when Type is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RollingUpdateStatefulSetStrategyType.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   type &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Type indicates the type of the StatefulSetUpdateStrategy. Default is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RollingUpdate.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain sts.spec.updateStrategy.rollingUpdate&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     StatefulSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: rollingUpdate &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RollingUpdate is used to communicate parameters when Type is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RollingUpdateStatefulSetStrategyType.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RollingUpdateStatefulSetStrategy is used to communicate parameter for&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RollingUpdateStatefulSetStrategyType.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   partition    &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Partition indicates the ordinal at which the StatefulSet should be&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     partitioned. Default value is 0.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;更新分区：&lt;/strong&gt;&lt;br&gt;假设现在有5个Pod，这5个Pod是有标识符的，分别叫myapp-0到myapp-4。如果定义partition为5，意味着编号大于等于5的将会被更新。比如这里定义为5，那就都不更新。定义为4，那就myapp-4会被更新，其他不会被更新，这叫金丝雀发布。随后我们发现这myapp-4向客户端提供服务没有任何问题，接下里在手动打补丁，把partition改成0。&lt;/p&gt;
&lt;p&gt;先把StatefulSet扩展到5个。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl patch sts myapp -p &amp;apos;&amp;#123;&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;replicas&amp;quot;: 5&amp;#125;&amp;#125;&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;statefulset.apps/myapp patched&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You have mail in /var/spool/mail/root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl describe sts myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name:               myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Namespace:          default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CreationTimestamp:  Mon, 09 Sep 2019 17:16:37 +0800&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Selector:           app=myapp-pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Labels:             &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Annotations:        kubectl.kubernetes.io/last-applied-configuration:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                      &amp;#123;&amp;quot;apiVersion&amp;quot;:&amp;quot;apps/v1&amp;quot;,&amp;quot;kind&amp;quot;:&amp;quot;StatefulSet&amp;quot;,&amp;quot;metadata&amp;quot;:&amp;#123;&amp;quot;annotations&amp;quot;:&amp;#123;&amp;#125;,&amp;quot;name&amp;quot;:&amp;quot;myapp&amp;quot;,&amp;quot;namespace&amp;quot;:&amp;quot;default&amp;quot;&amp;#125;,&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;replicas&amp;quot;:3,&amp;quot;sele...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Replicas:           5 desired | 5 total&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Update Strategy:    RollingUpdate&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Partition:        824640877672&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Pods Status:        5 Running / 0 Waiting / 0 Succeeded / 0 Failed&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;sts默认更新策略是RollingUpdate，但是没有定义partition，默认为0。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl set image sts myapp myapp=ikubernetes/myapp:v2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;statefulset.apps/myapp image updated&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/170.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;以上演示的都是无状态应用，如果真正要用有状态应用，会很麻烦。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;StatefulSet介绍&quot;&gt;&lt;a href=&quot;#StatefulSet介绍&quot; class=&quot;headerlink&quot; title=&quot;StatefulSet介绍&quot;&gt;&lt;/a&gt;StatefulSet介绍&lt;/h2&gt;&lt;p&gt;简称sts。&lt;br&gt;不同的分布式系统运维管理逻辑和运维操作过程是不尽相同的。因此没有办法有一种控制器把每一种功能都同步进来，让我们非常简单地去操作这些有状态应用。即便有了StatefulSet，我们用StatefulSet去实现真正功能控制时也是极其麻烦的。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes configMap和secret</title>
    <link href="http://yoursite.com/2019/08/28/Kubernetes-configmap%E5%92%8Csecret/"/>
    <id>http://yoursite.com/2019/08/28/Kubernetes-configmap和secret/</id>
    <published>2019-08-28T07:54:17.000Z</published>
    <updated>2019-08-29T02:46:23.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;两种特殊的存储卷-configMap和secret&quot;&gt;&lt;a href=&quot;#两种特殊的存储卷-configMap和secret&quot; class=&quot;headerlink&quot; title=&quot;两种特殊的存储卷:configMap和secret&quot;&gt;&lt;/a&gt;两种特殊的存储卷:configMap和secret&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.volumes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   configMap    &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ConfigMap represents a configMap that should populate this volume&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   secret       &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Secret represents a secret that should populate this volume. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/volumes#secret&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;这两种存储卷多数情况下，它们的目的不是给Pod提供存储空间来用的，而是给我们的管理员或用户提供了从集群外部向Pod内部的应用程序注入配置信息的方式。&lt;br&gt;第一点，比如在集群上，有个名称空间，在这个名称空间之上，有个Pod在运行。我们启动Pod是基于镜像来运行容器的。镜像做好后，镜像内的应用程序启动时要读配置文件也是镜像内的配置文件，因此镜像内的应用启动时到底应该运行在什么配置下，在做镜像之前就确定了。做完镜像后就改不了了。除非用entrypoint脚本，去接受用户启动容器时传一些环境变量进来。把环境变量中的数据给他写到或替换到配置文件中去从而使得应用程序在启动之前就获得一个新的配置文件，而后得到新配置。否则会有个问题，做好了的镜像，它可能为了适用不同的部署方式或者不同的环境，需要做很多个镜像。比如开发、测试、线上，三套环境都要部署tomcat，但是使用的内存大小不一样，很显然我们把配置写在配置文件之中，三个环境不可能都适用的，所以不得不做三个镜像，这很麻烦。所以后来想了其他办法来解决这个配置信息的注入。在k8s上也是如此，本来镜像都是做好的，一个镜像应付不了那么多场景，就不得不做多个镜像，这个特别难受，所以能够从镜像外部向镜像内部启动为容器时给它添加配置信息，是很重要的。&lt;br&gt;第二点，假如现在部署了20个Pod，里面都是tomcat，就算我们能够从外部通过环境变量注入进去，但是运行了一段时间以后，需要改配置参数，怎么改？重新替换环境变量的值。但是entrypoint已经生过效了。你可能还要触发entrypoint脚本重新执行一次，甚至是Pod不用动，把里面容器重启下。这个过程其实是比较麻烦的，而且还得一个一个去操作，一个一个重新改环境变量的值。应用程序运行时，有一种简单地方式来实现这个功能，可以使用配置中心。把配置放在配置中心，tomcat启动时加载的文件，文件看起来存在，可能并没有内容，文件来自于配置中心，动态从配置中心拉过来，然后启动tomcat。将来在配置中心修改配置，并通知给进程，让这些进程重载配置文件。k8s也面临一样的场景，这20个Pod需要更新的时候，改配置只能通过改镜像的话，代价太大了。因此我们不把配置写死在镜像中，而是引入一个新的资源，这个新的资源甚至是整个k8s之上的一等公民，这个资源就叫&lt;strong&gt;configMap&lt;/strong&gt;，它里面放的是配置信息。随后启动的每一个Pod时，都可以共享使用同一个configMap资源。这个资源对象可以当存储卷来使用，也可以从中基于环境变量的方式从里面获取到一些数据传递给环境变量从而注入到容器中使用。&lt;br&gt;总结下来，有两种较为合适的方式去解决以上出现的两个场景：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、假如现在要启动一个Pod，这个Pod启动时可以把configmap资源关联到当前Pod上来，从中读一个数据，传递给Pod内容器中的一个变量，仍然是变量注入的方式来给容器传递配置信息。&lt;/li&gt;
&lt;li&gt;2、把每一个configmap当一个存储卷，直接挂载到容器中的某个目录上，这个目录恰好是应用程序读取配置信息的文件路径。而且支持动态修改，意思是说如果configmap中内容修改下，改完后会通知给所有的Pod，让Pod里面的应用重载，当然有些应用可能不能自动重载，你需要手动触发下重载。因此configmap扮演了k8s之上的配置中心的功能。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;所以要想传一个配置文件给Pod中的容器，可以把配置文件打包在configmap中，让Pod启动时把configmap挂载到配置文件目录下，就从这下面读配置文件就能ok了。但是configmap是明文存数据的，因此在里面放的各种配置文件，不能包含敏感数据，比如连mysql，不能放root账号。跟configmap有些同样功能的另外一个标准k8s资源叫&lt;strong&gt;secret&lt;/strong&gt;。secret的功能和configmap功能一样，所不同的是其中的内容不是明文存放的，而是base64编码存放的。不是加密，很容易解开，但是至少对很多人来讲，是不可为的任务了。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;先做一个总结：配置容器化应用的方式：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、自定义命令行参数;&lt;br&gt;args: [] &lt;/li&gt;
&lt;li&gt;2、把配置文件直接放进镜像;&lt;br&gt;不建议，这是在用dockerfile制作镜像时就把配置文件放进去了&lt;/li&gt;
&lt;li&gt;3、环境变量&lt;br&gt;(1) Cloud Native的应用程序一般可直接通过环境变量加载配置;&lt;br&gt;(2) 通过entrypoint脚本来预处理变量为配置文件中的配置信息，通过SET命令之类的替换到配置文件中去；&lt;/li&gt;
&lt;li&gt;4、存储卷&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;Pod资源获取环境变量的方式：env、envFrom&quot;&gt;&lt;a href=&quot;#Pod资源获取环境变量的方式：env、envFrom&quot; class=&quot;headerlink&quot; title=&quot;Pod资源获取环境变量的方式：env、envFrom&quot;&gt;&lt;/a&gt;Pod资源获取环境变量的方式：env、envFrom&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.containers.env&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;name &amp;lt;string&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Name of the environment variable. Must be a C_IDENTIFIER.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   value        &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Variable references $(VAR_NAME) are expanded using the previous defined&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     environment variables in the container and any service environment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     variables. If a variable cannot be resolved, the reference in the input&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     string will be unchanged. The $(VAR_NAME) syntax can be escaped with a&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     double $$, ie: $$(VAR_NAME). Escaped references will never be expanded,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     regardless of whether the variable exists or not. Defaults to &amp;quot;&amp;quot;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   valueFrom    &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Source for the environment variable&amp;apos;s value. Cannot be used if value is not&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     empty.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;valueFrom: 数据来自引用另外一个变量或另外一个对象&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.containers.env.valueFrom&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   configMapKeyRef      &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Selects a key of a ConfigMap.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   fieldRef     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Selects a field of the pod: supports metadata.name, metadata.namespace,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     metadata.labels, metadata.annotations, spec.nodeName,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     spec.serviceAccountName, status.hostIP, status.podIP.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   resourceFieldRef     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Selects a resource of the container: only resources limits and requests&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     (limits.cpu, limits.memory, limits.ephemeral-storage, requests.cpu,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     requests.memory and requests.ephemeral-storage) are currently supported.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   secretKeyRef &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Selects a key of a secret in the pod&amp;apos;s namespace&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;configMapKeyRef: 在configMap中的某个key的vlaue，configMap也是键值对。&lt;/li&gt;
&lt;li&gt;fieldRef: 某个字段，这个字段很可能是Pod自身的字段，比如像metadata.labels, metadata.annotations, spec.nodeName, spec.serviceAccountName, status.hostIP, status.podIP.&lt;/li&gt;
&lt;li&gt;resourceFieldRef: 资源需求和资源算法，后面讲到调度器算法时在解释&lt;/li&gt;
&lt;li&gt;secretKeyRef: 引用secretKey&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;configMap&quot;&gt;&lt;a href=&quot;#configMap&quot; class=&quot;headerlink&quot; title=&quot;configMap&quot;&gt;&lt;/a&gt;configMap&lt;/h2&gt;&lt;p&gt;简称cm。&lt;br&gt;&lt;strong&gt;configMap作用：&lt;/strong&gt;让配置信息与镜像文件解耦。从而增强了应用的可移植性以及可复用性。configMap就是一系列配置数据的集合，而这些数据将来可以注入到Pod中的容器中所使用。&lt;br&gt;在configMap中，所有的配置信息都保存为键值格式。比如name: zhangshan。但是这种格式保存的数据量很小，我们也可以保存为比较复杂的格式。比如键名叫server.conf, 值是曾经在Nginx上配置时传递的这个server的整个内容。可以是整个文件的所有内容。因为value的长度是没有限制的。&lt;br&gt;configMap是一等公民，属于名称空间的资源，但是它的字段比较独特，和之前所学的Pod、Service等都不一样。没有spec，因为它没有那么复杂的结构，不需要嵌套众多状态描述的属性或字段。只需要给数据就可以了，所以有个data字段，是个map类型的。也可以以二进制形式给数据。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain cm&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     ConfigMap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ConfigMap holds configuration data for pods to consume.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   apiVersion   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     APIVersion defines the versioned schema of this representation of an&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     object. Servers should convert recognized schemas to the latest internal&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     value, and may reject unrecognized values. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#resources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   binaryData   &amp;lt;map[string]string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     BinaryData contains the binary data. Each key must consist of alphanumeric&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     characters, &amp;apos;-&amp;apos;, &amp;apos;_&amp;apos; or &amp;apos;.&amp;apos;. BinaryData can contain byte sequences that are&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     not in the UTF-8 range. The keys stored in BinaryData must not overlap with&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the ones in the Data field, this is enforced during validation process.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Using this field will require 1.10+ apiserver and kubelet.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   data &amp;lt;map[string]string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Data contains the configuration data. Each key must consist of alphanumeric&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     characters, &amp;apos;-&amp;apos;, &amp;apos;_&amp;apos; or &amp;apos;.&amp;apos;. Values with non-UTF-8 byte sequences must use&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the BinaryData field. The keys stored in Data must not overlap with the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     keys in the BinaryData field, this is enforced during validation process.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   kind &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Kind is a string value representing the REST resource this object&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     represents. Servers may infer this from the endpoint the client submits&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     requests to. Cannot be updated. In CamelCase. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   metadata     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Standard object&amp;apos;s metadata. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;data和binaryData，一般只使用其中一种。&lt;br&gt;定义configMap时，可以使用yaml文件，也可以在命令行使用kubectl create configmap来定义。如果需要长期使用，可以定义成yaml文件来保存。&lt;/p&gt;
&lt;h2 id=&quot;configMap示例&quot;&gt;&lt;a href=&quot;#configMap示例&quot; class=&quot;headerlink&quot; title=&quot;configMap示例&quot;&gt;&lt;/a&gt;configMap示例&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create configmap -h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Create a new configmap named my-config based on folder bar&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create configmap my-config --from-file=path/to/bar&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Create a new configmap named my-config with specified keys instead of file basenames on disk&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create configmap my-config --from-file=key1=/path/to/bar/file1.txt --from-file=key2=/path/to/bar/file2.txt&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Create a new configmap named my-config with key1=config1 and key2=config2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create configmap my-config --from-literal=key1=config1 --from-literal=key2=config2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Create a new configmap named my-config from the key=value pairs in the file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create configmap my-config --from-file=path/to/bar&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Create a new configmap named my-config from an env file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create configmap my-config --from-env-file=path/to/bar.env&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Options:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --allow-missing-template-keys=true: If true, ignore any errors in templates when a field or map key is missing in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the template. Only applies to golang and jsonpath output formats.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --append-hash=false: Append a hash of the configmap to its name.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --dry-run=false: If true, only print the object that would be sent, without sending it.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --from-env-file=&amp;apos;&amp;apos;: Specify the path to a file to read lines of key=val pairs to create a configmap (i.e. a Docker&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.env file).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --from-file=[]: Key file can be specified using its file path, in which case file basename will be used as&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;configmap key, or optionally with a key and file path, in which case the given key will be used.  Specifying a directory&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;will iterate each named file in the directory whose basename is a valid configmap key.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --from-literal=[]: Specify a key and literal value to insert in configmap (i.e. mykey=somevalue)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --generator=&amp;apos;configmap/v1&amp;apos;: The name of the API generator to use.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -o, --output=&amp;apos;&amp;apos;: Output format. One of:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;json|yaml|name|go-template|go-template-file|template|templatefile|jsonpath|jsonpath-file.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --save-config=false: If true, the configuration of current object will be saved in its annotation. Otherwise, the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;annotation will be unchanged. This flag is useful when you want to perform kubectl apply on this object in the future.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --template=&amp;apos;&amp;apos;: Template string or path to template file to use when -o=go-template, -o=go-template-file. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;template format is golang templates [http://golang.org/pkg/text/template/#pkg-overview].&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --validate=true: If true, use a schema to validate the input before sending it&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create configmap NAME [--from-file=[key=]source] [--from-literal=key1=value1] [--dry-run] [options]&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/154.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例1】：把键值做成configMap。&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create configmap nginx-config --from-literal=nginx_port=80 --from-literal=server_name=myapp.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;configmap/nginx-config created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get cm&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME           DATA   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-config   2      28s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl describe cm nginx-config&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name:         nginx-config&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Namespace:    default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Labels:       &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Annotations:  &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Data&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;====&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx_port:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;----&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;server_name:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;----&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Events:  &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;可以看出，直接就可以看到configMap中的内容了。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例2】：把一个文件内容做成configMap。&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# mkdir configmap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cd configmap/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# vim www.conf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;server &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server_name myapp.wisedu.com;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    listen 80;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    root /data/web/html;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl create cm nginx-www --from-file=./www.conf&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl create cm nginx-www --from-file=./www.conf  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;configmap/nginx-www created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl describe cm nginx-www&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name:         nginx-www&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Namespace:    default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Labels:       &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Annotations:  &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Data&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;====&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;www.conf:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;----&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;server &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server_name myapp.wisedu.com;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    listen 80;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    root /data/web/html;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Events:  &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;configmap两种方式注入容器中：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1.在容器中使用env，使用envFrom来获取。&lt;br&gt;如果通过环境变量来注入的话，必须确保环境变量传递进去能被容器作为配置信息使用，否则传过去没用。而两种方式上面提了，cloudnative，可直接通过环境变量加载配置，要不就是通过entrypoint脚本来处理。所以不是云环境，得在容器里写了entrypoint脚本才能使用传递进来的环境变量。&lt;/li&gt;
&lt;li&gt;2.存储卷方式&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;【示例3】：使用env来传递环境变量&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.containers.env.valueFrom.configMapKeyRef&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: configMapKeyRef &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Selects a key of a ConfigMap.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Selects a key from a ConfigMap.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   key  &amp;lt;string&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The key to select.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   name &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Name of the referent. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   optional     &amp;lt;boolean&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Specify whether the ConfigMap or it&amp;apos;s key must be defined&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;optional: 如果在容器中定义了从configmap引用，万一没有这个configmap，或者configmap中没有这个key，pod就启动不了了，因为引用数据不存在，会出错的。但是我们可以optional这一项启用起来，optional: true。意思是可选的，就算没有也没关系，如果不写为true，就表示must be defined。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# vim pod-configmap.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-cm-1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    wisedu.com/created-by: &amp;quot;cluster admin&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    env:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: NGINX_SERVER_PORT&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      valueFrom:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        configMapKeyRef:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          name: nginx-config&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          key: nginx_port&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: NGINX_SERVER_NAME&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      valueFrom:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        configMapKeyRef:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          name: nginx-config&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          key: server_name&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl apply -f pod-configmap.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-cm-1 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                             READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;busybox                          0/1     Error     0          12d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-ff9xf     1/1     Running   0          12d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-msv5x     1/1     Running   0          12d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-wls6h     1/1     Running   0          12d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-pod                        1/1     Running   0          24h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx                            1/1     Running   0          12d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-cm-1                         1/1     Running   0          5s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-vol-pvc                      1/1     Running   0          25h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis-58b9f5776-fzslw            1/1     Running   0          9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-4lhql   1/1     Running   0          6d6h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-ghz7l   1/1     Running   0          6d6h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-kd5v8   1/1     Running   0          6d6h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl exec -it pod-cm-1 -- printenv&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;HOSTNAME=pod-cm-1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;TERM=xterm&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NGINX_SERVER_PORT=80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NGINX_SERVER_NAME=myapp.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;MYAPP_SVC_SERVICE_HOST=10.111.183.73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KUBERNETES_SERVICE_HOST=10.96.0.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;REDIS_SERVICE_HOST=10.97.97.97&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;已经传进来了。&lt;br&gt;现在修改configmap中的key的value，看Pod中容器中的变量是否会及时生效。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl edit cm nginx-config&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/155.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;查看Pod容器中变量是否发生变化：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl exec -it pod-cm-1 -- printenv | grep NGINX_SERVER_PORT&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NGINX_SERVER_PORT=80&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;实践证明修改 ConfigMap 无法更新容器中已注入的环境变量信息。&lt;br&gt;&lt;strong&gt;当我们使用环境变量注入时，只在容器启动时有效。因为它是Pod创建时获取的。如果通过存储卷的方式来获取，是可以实时更新的。见下面的实例&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例4】：使用存储卷来传递环境变量。&lt;/strong&gt;&lt;br&gt;configmap无论创建时是不是文件，比如在命令行指了个key，指了个value，我们可以把整个configmap当存储卷挂载到Pod上，然后yaml文件中指定容器把存储卷挂载到自己的某个目录下(挂载点不存在会自动创建)。在这个挂载目录下，每一个key就转换成一个文件名，那个key的value就转换成文件内容。以刚才在命令行创建的configmap nginx-config为例。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl delete -f pod-configmap.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-cm-1&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# vim pod-configmap-volume.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-cm-vol&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    wisedu.com/created-by: &amp;quot;cluster admin&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    volumeMounts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: nginxconf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      mountPath: /etc/nginx/config.d/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      readOnly: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  volumes:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: nginxconf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    configMap:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      name: nginx-config&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/156.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl apply -f pod-configmap-volume.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-cm-vol created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                             READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;busybox                          0/1     Error     0          12d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-ff9xf     1/1     Running   0          12d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-msv5x     1/1     Running   0          12d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-wls6h     1/1     Running   0          12d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-pod                        1/1     Running   0          24h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx                            1/1     Running   0          12d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-cm-vol                       1/1     Running   0          13s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-vol-pvc                      1/1     Running   0          26h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis-58b9f5776-fzslw            1/1     Running   0          9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-4lhql   1/1     Running   0          6d7h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-ghz7l   1/1     Running   0          6d7h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-kd5v8   1/1     Running   0          6d7h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl exec -it pod-cm-vol -- /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # cd /etc/nginx/config.d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/etc/nginx/config.d # ls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx_port   server_name&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/etc/nginx/config.d # ls -l&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;total 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;lrwxrwxrwx    1 root     root            17 Aug 28 09:44 nginx_port -&amp;gt; ..data/nginx_port&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;lrwxrwxrwx    1 root     root            18 Aug 28 09:44 server_name -&amp;gt; ..data/server_name&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/etc/nginx/config.d # cat nginx_port &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/etc/nginx/config.d # cat server_name &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp.wisedu.com/etc/nginx/config.d #&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;现在去修改下cm中的key的value：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl edit cm nginx-config&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/157.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;在容器中查看这个变量：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;/etc/nginx/config.d # cat nginx_port &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8088/etc/nginx/config.d #&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;需要稍微等下，因为这个修改要同步到apiserver中，apiserver在同步到Pod上。时间取决于apiserver同步速度。这里实测大概10秒才能同步更新。&lt;br&gt;其实这两个文件是链接文件，不是同步进来的，这两个文件本来就是访问原来的文件。链接改成指向新的configmap版本。是个独特路径，映射n级后能到configmap存储卷上，所以只要configmap源内容改了，就会同步改掉。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/158.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例5】:演示真正注入Nginx配置文件。&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl delete -f pod-configmap-volume.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-cm-vol&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# vim pod-configmap-nginx.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-cm-nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    wisedu.com/created-by: &amp;quot;cluster admin&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    volumeMounts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: nginxconf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      mountPath: /etc/nginx/conf.d/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      readOnly: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  volumes:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: nginxconf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    configMap:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      name: nginx-www&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/159.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;如果这个挂载点指定的目录在原来容器中有内容，会被挂载的内容覆盖掉。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl exec pod-cm-nginx -it -- /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # cd /etc/nginx/conf.d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/etc/nginx/conf.d # ls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;www.conf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/etc/nginx/conf.d # cat www.conf &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;server &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server_name myapp.wisedu.com;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    listen 80;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    root /data/web/html;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/etc/nginx/conf.d # mkdir /data/web/html -p&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/etc/nginx/conf.d # vi /data/web/html/index.html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;h1&amp;gt;Nginx Server configured by CM&amp;lt;/h1&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;接下来配置hosts解析：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-cm-nginx                     1/1     Running   0          4m7s   10.244.1.26   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# vim /etc/hosts&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.1.26 myapp.wisedu.com&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;访问：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# curl myapp.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;h1&amp;gt;Nginx Server configured by CM&amp;lt;/h1&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;现在改下外部配置，改下监听端口：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl edit cm nginx-www&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/160.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;还是等了10来秒才生效&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/161.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;访问：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# curl myapp.wisedu.com:8080&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;h1&amp;gt;Nginx Server configured by CM&amp;lt;/h1&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但是刚才挂载的时候，只要configmap有的键，都挂载进去了。如果以存储卷挂载访问configmap时不希望把所有的key都挂载进来，只希望挂载部分key，这也是可以的。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl explain pods.spec.volumes.configMap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   defaultMode  &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Optional: mode bits to use on created files by default. Must be a value&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     between 0 and 0777. Defaults to 0644. Directories within the path are not&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     affected by this setting. This might be in conflict with other options that&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     affect the file mode, like fsGroup, and the result can be other mode bits&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     set.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   items        &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     If unspecified, each key-value pair in the Data field of the referenced&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ConfigMap will be projected into the volume as a file whose name is the key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     and content is the value. If specified, the listed keys will be projected&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     into the specified paths, and unlisted keys will not be present. If a key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     is specified which is not present in the ConfigMap, the volume setup will&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     error unless it is marked optional. Paths must be relative and may not&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     contain the &amp;apos;..&amp;apos; path or start with &amp;apos;..&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   name &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Name of the referent. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   optional     &amp;lt;boolean&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Specify whether the ConfigMap or it&amp;apos;s keys must be defined&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;itmes: 把name字段指定的configMap中的哪些字段挂载进来&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl explain pods.spec.volumes.configMap.items&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   key  &amp;lt;string&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The key to project.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   mode &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Optional: mode bits to use on this file, must be a value between 0 and&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     0777. If not specified, the volume defaultMode will be used. This might be&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     in conflict with other options that affect the file mode, like fsGroup, and&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the result can be other mode bits set.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   path &amp;lt;string&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The relative path of the file to map the key to. May not be an absolute&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     path. May not contain the path element &amp;apos;..&amp;apos;. May not start with the string&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &amp;apos;..&amp;apos;.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;列出键的时候，不光要列出键的名字，还要指明真正的文件名(path)，key已经不是默认作为文件名了，是required。文件名和key名一样也可以，但是你需要指定。文件内容就是key所对应的value。挂载的文件可以同时指定文件权限(mode)，path不能使用..，因为..有特殊作用，路径映射方式。&lt;/p&gt;
&lt;h2 id=&quot;Secret&quot;&gt;&lt;a href=&quot;#Secret&quot; class=&quot;headerlink&quot; title=&quot;Secret&quot;&gt;&lt;/a&gt;Secret&lt;/h2&gt;&lt;p&gt;configMap存数据是明文的，Secret是base64编码的，但是使用Secret会麻烦一些。只有敏感数据才建议使用secret存放。私钥和证书最好是放在secret中，还有连接mysql时的密码。&lt;br&gt;对于secret而言，它有三种类型：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1.generic: Create a secret from a local file, directory or literal value&lt;br&gt;通用的secret，就是里面保存一些密码数据&lt;/li&gt;
&lt;li&gt;2.tls: Create a TLS secret&lt;br&gt;私钥和证书。&lt;/li&gt;
&lt;li&gt;3.docker-registry: Create a secret for use with a Docker registry&lt;br&gt;保存docker-registry的认证信息。每一个Node在运行Pod之前，它得把Pod所依赖的镜像拉取到本地，需要到某个registry上拉取。如果是去某个私有registry拉取，里面镜像也是私有的，必须要输入账号密码才能访问，账号密码放哪？也就意味着当前的Node要能够自动地认证，并从registry拉取镜像。否则Pod创建肯定是失败。现在是kubelet会认证到私有仓库，然后拉下来进行。&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl explain pods.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   imagePullSecrets     &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ImagePullSecrets is an optional list of references to secrets in the same&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     namespace to use for pulling any of the images used by this PodSpec. If&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     specified, these secrets will be passed to individual puller&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     implementations for them to use. For example, in the case of docker, only&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DockerConfig type secrets are honored. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/containers/images#specifying-imagepullsecrets-on-a-pod&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;创建secret命令：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl create secret -h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Create a secret using specified subcommand.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Available Commands:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  docker-registry Create a secret for use with a Docker registry&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  generic         Create a secret from a local file, directory or literal value&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  tls             Create a TLS secret&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create secret [flags] [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl &amp;lt;command&amp;gt; --help&amp;quot; for more information about a given command.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl options&amp;quot; for a list of global command-line options (applies to all commands).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl create secret generic -h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Create a secret based on a file, directory, or specified literal value.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; A single secret may package one or more key/value pairs.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; When creating a secret based on a file, the key will default to the basename of the file, and the value will default to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the file content. If the basename is an invalid key or you wish to chose your own, you may specify an alternate key.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; When creating a secret based on a directory, each file whose basename is a valid key in the directory will be packaged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;into the secret. Any directory entries except regular files are ignored (e.g. subdirectories, symlinks, devices, pipes,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etc).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Create a new secret named my-secret with keys for each file in folder bar&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create secret generic my-secret --from-file=path/to/bar&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Create a new secret named my-secret with specified keys instead of names on disk&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create secret generic my-secret --from-file=ssh-privatekey=~/.ssh/id_rsa&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;--from-file=ssh-publickey=~/.ssh/id_rsa.pub&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Create a new secret named my-secret with key1=supersecret and key2=topsecret&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create secret generic my-secret --from-literal=key1=supersecret --from-literal=key2=topsecret&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Create a new secret named my-secret using a combination of a file and a literal&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create secret generic my-secret --from-file=ssh-privatekey=~/.ssh/id_rsa --from-literal=passphrase=topsecret&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Create a new secret named my-secret from an env file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create secret generic my-secret --from-env-file=path/to/bar.env&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Options:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --allow-missing-template-keys=true: If true, ignore any errors in templates when a field or map key is missing in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the template. Only applies to golang and jsonpath output formats.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --append-hash=false: Append a hash of the secret to its name.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --dry-run=false: If true, only print the object that would be sent, without sending it.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --from-env-file=&amp;apos;&amp;apos;: Specify the path to a file to read lines of key=val pairs to create a secret (i.e. a Docker&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.env file).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --from-file=[]: Key files can be specified using their file path, in which case a default name will be given to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;them, or optionally with a name and file path, in which case the given name will be used.  Specifying a directory will&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;iterate each named file in the directory that is a valid secret key.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --from-literal=[]: Specify a key and literal value to insert in secret (i.e. mykey=somevalue)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --generator=&amp;apos;secret/v1&amp;apos;: The name of the API generator to use.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -o, --output=&amp;apos;&amp;apos;: Output format. One of:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;json|yaml|name|go-template|go-template-file|template|templatefile|jsonpath|jsonpath-file.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --save-config=false: If true, the configuration of current object will be saved in its annotation. Otherwise, the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;annotation will be unchanged. This flag is useful when you want to perform kubectl apply on this object in the future.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --template=&amp;apos;&amp;apos;: Template string or path to template file to use when -o=go-template, -o=go-template-file. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;template format is golang templates [http://golang.org/pkg/text/template/#pkg-overview].&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --type=&amp;apos;&amp;apos;: The type of secret to create&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --validate=true: If true, use a schema to validate the input before sending it&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl create secret generic NAME [--type=string] [--from-file=[key=]source] [--from-literal=key1=value1] [--dry-run]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl options&amp;quot; for a list of global command-line options (applies to all commands).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;【示例1】：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl create secret generic mysql-root-passwd --from-literal=password=Mypass@123&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;secret/mysql-root-passwd created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl get secret&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                    TYPE                                  DATA   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;default-token-wb7fl     kubernetes.io/service-account-token   3      138d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql-root-passwd       Opaque                                1      5s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-ingress-secret   kubernetes.io/tls                     2      6d22h&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Opaque: 模糊类型，就是generic类型&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl describe secret mysql-root-passwd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name:         mysql-root-passwd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Namespace:    default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Labels:       &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Annotations:  &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Type:  Opaque&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Data&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;====&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;password:  10 bytes&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这么看是看不到secret内容的。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/162.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例2】：env方式引用secret中的key&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# vim pod-secret.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-secret-1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    wisedu.com/created-by: &amp;quot;cluster admin&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    env:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: MYSQL_ROOT_PASSWORD&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      valueFrom:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        secretKeyRef:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          name: mysql-root-passwd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          key: password&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl apply -f pod-secret.yaml                                    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-secret-1 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 configmap]# kubectl exec pod-secret-1 -it -- printenv | grep MYSQL_ROOT_PASSWORD&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;MYSQL_ROOT_PASSWORD=Mypass@123&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;可见，变量的值是解码以后注入进去的。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;两种特殊的存储卷-configMap和secret&quot;&gt;&lt;a href=&quot;#两种特殊的存储卷-configMap和secret&quot; class=&quot;headerlink&quot; title=&quot;两种特殊的存储卷:configMap和secret&quot;&gt;&lt;/a&gt;两种特殊的存储卷:configMap和secret&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.volumes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   configMap    &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ConfigMap represents a configMap that should populate this volume&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   secret       &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Secret represents a secret that should populate this volume. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/volumes#secret&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes存储卷</title>
    <link href="http://yoursite.com/2019/08/26/Kubernetes%E5%AD%98%E5%82%A8%E5%8D%B7/"/>
    <id>http://yoursite.com/2019/08/26/Kubernetes存储卷/</id>
    <published>2019-08-26T05:43:43.000Z</published>
    <updated>2019-09-04T09:08:02.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;什么是存储卷&quot;&gt;&lt;a href=&quot;#什么是存储卷&quot; class=&quot;headerlink&quot; title=&quot;什么是存储卷&quot;&gt;&lt;/a&gt;什么是存储卷&lt;/h2&gt;&lt;p&gt;大多数和数据存储相关的应用和有状态应用都是需要持久存储数据的。容器本身有生命周期，为了使得容器将来终结后我们可以把它删除，甚至是编排到其他节点上运行，意味着数据不能放在容器自己的名称空间中。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;在k8s中，Pod是运行在某个节点上的，只要不出故障，就一直会运行在这个节点上，节点故障了才会调度到其他节点，只要节点不故障，是不会走的，无非就是重启重启而已。这里就有两个问题了，一旦这个Pod故障了被删除，或者节点故障了，此时有可能编排到其他节点上了，为了突破Pod生命周期受限这种现状，我们需要把数据放在Pod自有文件系统之外的地方。&lt;br&gt;我们此前在单独使用docker时，使用存储卷，相当于把容器中的某一目录与节点上某一目录关联起来，随后容器内该目录存储的数据都存到了节点上了。当我们删了容器，在重建容器，只要这个存储卷不受影响，那么数据是没有问题的，在一定程度上拥有了持久功能。&lt;br&gt;但是这个问题在k8s上不能这么来操作，k8s是一个集群，由调度器负责调度，Pod被删掉了可能会被调度到其他节点，所以这种在节点级帮忙提供存储卷的方式来持久存储数据的逻辑在k8s上，只能说只有一定程度上的持久性，不是真正意义上的持久性。应该使用脱离节点而存在的存储设备。&lt;br&gt;为此，k8s提供了能应付各种不同类型的存储卷让我们来使用，没有持久、半持久、或真正意义上的持久功能。对于Pod来说，Pod内的多个容器可共享访问同一组存储卷，因为对k8s来讲，存储卷不属于容器，而属于Pod。在容器中挂载存储卷，如果Pod中两个容器都挂载了某个存储卷，就相当于两个容器共享数据了。Pod底层有个基础容器，不启动，靠一个独特的镜像来创建的，叫pause。所有的Pod，其网络名称空间、存储卷之类的都是分配给这个Pod的，Pod中运行的主容器是共享这个镜像的网络名称空间的，容器挂载存储卷其实是挂载这个容器的存储卷的。所以叫基础架构容器。&lt;br&gt;在Pod上使用存储卷，实际上也就是这个pause容器有了存储卷，而这个容器有存储卷，只不过是这个容器和宿主机目录建立了关联关系。而宿主机目录如果是节点本地的，那么它就随着宿主机而终结了，因此宿主机这个目录为了真正实现持久性，它应该也不是宿主机本地的，而是宿主机挂载的外部存储设备上的存储卷。当然如果这个宿主机的目录没挂载，那就是节点本地的了。只要节点不宕机，数据就是持久的。但是跨节点存储，只能使用脱离节点本地的网络设备。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/143.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;Kubernetes存储卷分类&quot;&gt;&lt;a href=&quot;#Kubernetes存储卷分类&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes存储卷分类&quot;&gt;&lt;/a&gt;Kubernetes存储卷分类&lt;/h2&gt;&lt;h3 id=&quot;emptyDir&quot;&gt;&lt;a href=&quot;#emptyDir&quot; class=&quot;headerlink&quot; title=&quot;emptyDir&quot;&gt;&lt;/a&gt;emptyDir&lt;/h3&gt;&lt;p&gt;给Pod分配一个存储卷，存储卷只要节点本地，当Pod被删除，节点上存储卷也会一并被删除。这个不是为了持久而设计。只是用来做临时目录使用的。&lt;/p&gt;
&lt;h3 id=&quot;hostPath&quot;&gt;&lt;a href=&quot;#hostPath&quot; class=&quot;headerlink&quot; title=&quot;hostPath&quot;&gt;&lt;/a&gt;hostPath&lt;/h3&gt;&lt;p&gt;主机路径。直接在宿主机找一个目录，与容器建立关联关系。也不具有真正意义上的持久性。如果需要真正以上的持久性，则需要连接网络连接存储。大概分3类：&lt;br&gt;(1)SAN(存储区域网络，比如iSCSI、FC协议)、NAS(网络附加存储，比如nfs协议、cifs协议以及http协议)&lt;br&gt;(2)分布式存储：或是文件系统级别、或者块设备。&lt;br&gt;文件系统级别：glusterfs、cephfs&lt;br&gt;块级别：rbd&lt;br&gt;(3)云存储：亚马逊的EBS(弹性块存储)、Azure Disk。&lt;/p&gt;
&lt;h3 id=&quot;pvc&quot;&gt;&lt;a href=&quot;#pvc&quot; class=&quot;headerlink&quot; title=&quot;pvc&quot;&gt;&lt;/a&gt;pvc&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;持久存储卷申请，简称pvc&lt;/strong&gt;。从某种意义上来讲，它不是一个存储卷。以rbd为例，当你定义使用rbd类型的存储时，你需要定义很多相关的参数，这需要你对这个存储很熟悉。这会阻断一大部分用户来用k8s。怎么转换成傻瓜的形式来使用？pvc就是干这个事情的。&lt;br&gt;当需要创建一个存储卷时，你只需要告诉我，“我要来个存储卷”，所以叫存储卷创建申请。你不要管它底层存储系统是什么，你只需要说“我就需要这么多”就行。指定告诉它比如说需要个5g的存储空间，而不用管它那个存储到底放在哪个系统上。这叫存储及服务。&lt;/p&gt;
&lt;p&gt;让Pod创建和底层存储解耦。关键是和pvc建立关联关系，而pvc关键是和pv建立关联关系，而pv关键是和存储系统建立关联关系。解释如下：假如一个Pod创建调度到某个节点上，我们在Pod上定义一个pvc，它是一种存储卷类型，pvc要关联到当前这个Pod所在名称空间真正存在的pvc资源，这个pvc只是个申请，申请要与pv建立关联关系，pv是真正存储系统之上的一段存储空间，pv与后端存储建立关联关系。但是这个pvc与哪个pv建立关联关系时，怎么可能有个pv放在那等你来用呢？要做到这一步，用户在创建申请之前，先提需求，然后后端存储工程师或者k8s管理员把这些pv创建好。但是如果是公有云呢？有很多租户在上面跑着，压根不知道他们什么时候要创建pv。因此如果要做到按需创建，我们pv也不建了，我们把所有的存储空间抽象出来，抽象为一个抽象层，叫&lt;strong&gt;存储类&lt;/strong&gt;。当用户创建pvc需要用到pv时，它能够向存储类申请说，“你帮我创建出来”，存储类会帮它生成刚好符合用户请求大小的pv来，并让二者建立关联关系。像这种pv由用户的请求触发而动态生成，我们称为pv的动态供给。而这里需要依赖一个前提：要定义好存储类。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/144.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;什么叫存储类？存储按照其综合服务质量可以分为好几个级别，有的又慢又笨，称为Bronze存储，有的速度算中间，我们对性能没有太高要求，称为Silver存储，而有些特别快，ssd之类组成的，称为Gold存储。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/145.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;如果我们自己是一个对于存储系统非常了解的人，创建Pod时可直接使用存储空间，如果你不是特别了解，或者我们将来有很多用户、终端用户对于存储技术知之不多的话，那么这个时候我们就应该尽可能地给他们做成动态供给的方式，让他们使用pvc来使用。&lt;/p&gt;
&lt;h2 id=&quot;存储卷示例&quot;&gt;&lt;a href=&quot;#存储卷示例&quot; class=&quot;headerlink&quot; title=&quot;存储卷示例&quot;&gt;&lt;/a&gt;存储卷示例&lt;/h2&gt;&lt;p&gt;存储卷只是在Pod上定义的，容器中要想使用还得挂载和绑定。第一在Pod中要定义volume，这个volume要指明关联到哪个存储设备上去的，第二要在容器中使用volumeMounts，然后你才能使用。&lt;/p&gt;
&lt;h3 id=&quot;emptyDir-1&quot;&gt;&lt;a href=&quot;#emptyDir-1&quot; class=&quot;headerlink&quot; title=&quot;emptyDir&quot;&gt;&lt;/a&gt;emptyDir&lt;/h3&gt;&lt;p&gt;emptyDir不需要依赖任何外部设备。&lt;br&gt;查看定义emptyDir的相关字段：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   volumes      &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     List of volumes that can be mounted by containers belonging to the pod.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     More info: https://kubernetes.io/docs/concepts/storage/volumes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.volumes&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.volumes.emptyDir&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: emptyDir &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     EmptyDir represents a temporary directory that shares a pod&amp;apos;s lifetime.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     More info: https://kubernetes.io/docs/concepts/storage/volumes#emptydir&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Represents an empty directory for a pod. Empty directory volumes support&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ownership management and SELinux relabeling.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   medium       &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     What type of storage medium should back this directory. The default is &amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     which means to use the node&amp;apos;s default medium. Must be an empty string&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     (default) or Memory. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/volumes#emptydir&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   sizeLimit    &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Total amount of local storage required for this EmptyDir volume. The size&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     limit is also applicable for memory medium. The maximum usage on memory&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     medium EmptyDir would be the minimum value between the SizeLimit specified&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     here and the sum of memory limits of all containers in a pod. The default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     is nil which means that the limit is undefined. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     http://kubernetes.io/docs/user-guide/volumes#emptydir&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;查看容器中挂载存储卷的相关字段：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.containers&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   volumeMounts &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Pod volumes to mount into the container&amp;apos;s filesystem. Cannot be updated.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例1】：定义个emptyDir类型的存储卷，并让Pod内的容器挂载这个存储卷。&lt;/strong&gt;&lt;br&gt;1.先定义Pod的存储卷。emptyDir的两个属性medium和sizeLimit可以都不指，都为空，使用默认值，磁盘空间，大小不限制。空代表了一个映射，用{}。因为要映射数据，就是键值，键值。&lt;br&gt;2.然后定义容器挂载这个存储卷，哪个容器用，哪个容器挂载。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# mkdir volume&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cd volume/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# vim pod-vol-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-vol-demo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    wisedu.com/created-by: &amp;quot;cluster admin&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    volumeMounts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      mountPath: /data/web/html/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: busybox&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: busybox:latest&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    command:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - &amp;quot;/bin/sh&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - &amp;quot;-c&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - &amp;quot;sleep 3600&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    volumeMounts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      mountPath: /data/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  volumes:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    emptyDir: &amp;#123;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/146.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl apply -f pod-vol-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-vol-demo created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You have mail in /var/spool/mail/root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                             READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;busybox                          0/1     Error     0          10d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-ff9xf     1/1     Running   0          10d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-msv5x     1/1     Running   0          10d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-rp9vj     1/1     Running   0          10d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-wls6h     1/1     Running   0          10d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-xzgdl     1/1     Running   0          10d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx                            1/1     Running   0          10d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-vol-demo                     2/2     Running   0          8s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis-58b9f5776-fzslw            1/1     Running   0          7d7h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-4lhql   1/1     Running   0          4d7h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-ghz7l   1/1     Running   0          4d7h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-kd5v8   1/1     Running   0          4d7h&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;进入Pod中的busybox容器：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl exec pod-vol-demo -c busybox -it -- /bin/sh &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # ls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;bin   data  dev   etc   home  proc  root  sys   tmp   usr   var&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # echo $(date) &amp;gt;&amp;gt; /data/index.html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # echo $(date) &amp;gt;&amp;gt; /data/index.html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # cat /data/index.html &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Mon Aug 26 09:25:49 UTC 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Mon Aug 26 09:25:54 UTC 2019&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;接着进去Pod中的另一个容器myapp：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl exec pod-vol-demo -c myapp -it -- /bin/sh       &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # ls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;bin    data   dev    etc    home   lib    media  mnt    proc   root   run    sbin   srv    sys    tmp    usr    var&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # ls /data/web/html/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;index.html&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例2】：一个Pod中两个容器，一个容器是主容器，另外一个容器辅助容器。辅助容器每隔2s帮我们在一个共享的存储当中往一个网页文件添加新内容，主容器能够用这个新内容加载后响应给请求者。&lt;/strong&gt;&lt;br&gt;【注意】：是先挂载存储卷，后启动主容器。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl delete -f pod-vol-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-vol-demo&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# cp pod-vol-demo.yaml pod-vol-demo2.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# vim pod-vol-demo2.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-vol-demo2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    wisedu.com/created-by: &amp;quot;cluster admin&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    volumeMounts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      mountPath: /usr/share/nginx/html/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: busybox&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: busybox:latest&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    command: [&amp;quot;/bin/sh&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    args: [&amp;quot;-c&amp;quot;, &amp;quot;while true; do echo $(date) &amp;gt;&amp;gt; /data/index.html; sleep 2; done&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    volumeMounts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      mountPath: /data/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  volumes:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    emptyDir: &amp;#123;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl apply -f pod-vol-demo2.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-vol-demo2 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                             READY   STATUS    RESTARTS   AGE     IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;busybox                          0/1     Error     0          10d     10.244.2.49   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-ff9xf     1/1     Running   0          10d     10.244.1.19   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-msv5x     1/1     Running   0          10d     10.244.1.18   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-rp9vj     1/1     Running   0          10d     10.244.2.46   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-wls6h     1/1     Running   0          10d     10.244.3.7    hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-xzgdl     1/1     Running   0          10d     10.244.2.45   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx                            1/1     Running   0          10d     10.244.2.52   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-vol-demo2                    2/2     Running   0          20s     10.244.1.22   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis-58b9f5776-fzslw            1/1     Running   0          7d22h   10.244.2.53   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-4lhql   1/1     Running   0          4d22h   10.244.3.9    hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-ghz7l   1/1     Running   0          4d22h   10.244.1.21   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-kd5v8   1/1     Running   0          4d22h   10.244.2.56   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;访问：每隔2s生成一行新的数据。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# curl 10.244.1.22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Tue Aug 27 01:16:09 UTC 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Tue Aug 27 01:16:11 UTC 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Tue Aug 27 01:16:13 UTC 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Tue Aug 27 01:16:15 UTC 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Tue Aug 27 01:16:17 UTC 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Tue Aug 27 01:16:19 UTC 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Tue Aug 27 01:16:21 UTC 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Tue Aug 27 01:16:23 UTC 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Tue Aug 27 01:16:25 UTC 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Tue Aug 27 01:16:27 UTC 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Tue Aug 27 01:16:29 UTC 2019&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但是emptyDir有个特点，只要把Pod删除了，哪怕Pod重建在同一个节点上，数据也不会继续存在的。emptyDir的生命周期同Pod。&lt;/p&gt;
&lt;h3 id=&quot;gitRepo&quot;&gt;&lt;a href=&quot;#gitRepo&quot; class=&quot;headerlink&quot; title=&quot;gitRepo&quot;&gt;&lt;/a&gt;gitRepo&lt;/h3&gt;&lt;p&gt;把git仓库当做存储卷来使用。并不是Pod真正把git仓库当存储卷来使用，它只不过是把git仓库中的内容，比如说找github或者私有的git服务器，git仓库里一般有数据，可以把网站的源代码放在仓库里，而后当Pod创建时，会自动地连接到这个仓库之上，但是这个连接要依赖于宿主机上有git命令来命令，因为它是基于宿主机来决定的，让宿主机把整个仓库克隆到本地来，并且把它作为存储卷定义在Pod之上。但是，gitRepo是建立在emptyDir之上的。&lt;br&gt;gitRepo本质上来讲还是emptyDir，也是个空目录，对Pod而言也就是上来建立个空目录，仍然是一个空的存储卷，但是所不同的地方在于，要把指定的仓库的内容clone下来，并且扔到这个空目录里面来。因此主容器就可以把这个用户当做服务用户的数据来源。但是你做的修改是不会同步到git仓库里面去的。如果在你的Pod运行过程中，git仓库发生改变了，Pod内存储卷的内容也不会改变。这种持久需要你本地推送到远程仓库才行。&lt;/p&gt;
&lt;h3 id=&quot;hostPath-1&quot;&gt;&lt;a href=&quot;#hostPath-1&quot; class=&quot;headerlink&quot; title=&quot;hostPath&quot;&gt;&lt;/a&gt;hostPath&lt;/h3&gt;&lt;p&gt;把Pod所在的宿主机之上的、脱离Pod中容器的名称空间之外的、宿主机的文件系统的某一个目录与Pod建立关联关系。在Pod被删除时，这个存储卷是不会被删除的。所以只要同一个Pod能够调度到同一个节点上来，在Pod被删除以后，重新调度过来以后，对应的数据依然是存在的。如果要使用hostPath，就要指明在宿主机上哪个路径，万一宿主机上这个路径默认不存在，到底要不要新建取决于type字段。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl explain pods.spec.volumes.hostPath&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: hostPath &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     HostPath represents a pre-existing file or directory on the host machine&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     that is directly exposed to the container. This is generally used for&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     system agents or other privileged things that are allowed to see the host&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     machine. Most containers will NOT need this. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/volumes#hostpath&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Represents a host path mapped into a pod. Host path volumes do not support&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ownership management or SELinux relabeling.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   path &amp;lt;string&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Path of the directory on the host. If the path is a symlink, it will follow&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the link to the real path. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/volumes#hostpath&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   type &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Type for HostPath Volume Defaults to &amp;quot;&amp;quot; More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/volumes#hostpath&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;访问：&lt;a href=&quot;https://kubernetes.io/docs/concepts/storage/volumes#hostpath&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/concepts/storage/volumes#hostpath&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/147.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;空：为了兼容老版本的&lt;/li&gt;
&lt;li&gt;Socket: 必须是一个socket类型的文件&lt;/li&gt;
&lt;li&gt;CharDevice：必须是一个字符类型的设备文件&lt;/li&gt;
&lt;li&gt;BlockDevice：必须是一个块类型的设备文件&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;【示例】:hostPath示例。&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# vim pod-hostpath-vol.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-vol-hostpath&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    volumeMounts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      mountPath: /usr/share/nginx/html/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  volumes:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    hostPath:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      path: /data/pod/volume1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      type: DirectoryOrCreate&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在k8s集群的每个node节点上都创建如下的目录和文件，因为我们不清楚这个Pod会被调度到哪个节点上:&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mkdir /data/pod/volume1 -p&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;vim /data/pod/volume1/index.html&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在index.html中写入当前主机的主机名。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl apply -f pod-hostpath-vol.yaml  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-vol-hostpath created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                             READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;busybox                          0/1     Error     0          10d   10.244.2.49   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-ff9xf     1/1     Running   0          10d   10.244.1.19   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-msv5x     1/1     Running   0          10d   10.244.1.18   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-rp9vj     1/1     Running   0          10d   10.244.2.46   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-wls6h     1/1     Running   0          10d   10.244.3.7    hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-xzgdl     1/1     Running   0          10d   10.244.2.45   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx                            1/1     Running   0          10d   10.244.2.52   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-vol-hostpath                 1/1     Running   0          8s    10.244.2.58   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis-58b9f5776-fzslw            1/1     Running   0          8d    10.244.2.53   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-4lhql   1/1     Running   0          5d    10.244.3.9    hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-ghz7l   1/1     Running   0          5d    10.244.1.21   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-kd5v8   1/1     Running   0          5d    10.244.2.56   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# curl 10.244.2.58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ubuntu31&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;现在我们来删除这个pod，在重新创建这个pod，看看存储卷是否依然存在。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl delete -f pod-hostpath-vol.yaml        &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-vol-hostpath&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl apply -f pod-hostpath-vol.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-vol-hostpath created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl get pods -o wide                &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                             READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;busybox                          0/1     Error     0          10d   10.244.2.49   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-ff9xf     1/1     Running   0          10d   10.244.1.19   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-msv5x     1/1     Running   0          10d   10.244.1.18   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-rp9vj     1/1     Running   0          10d   10.244.2.46   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-wls6h     1/1     Running   0          10d   10.244.3.7    hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-xzgdl     1/1     Running   0          10d   10.244.2.45   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx                            1/1     Running   0          10d   10.244.2.52   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-vol-hostpath                 1/1     Running   0          3s    10.244.2.59   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis-58b9f5776-fzslw            1/1     Running   0          8d    10.244.2.53   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-4lhql   1/1     Running   0          5d    10.244.3.9    hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-ghz7l   1/1     Running   0          5d    10.244.1.21   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-kd5v8   1/1     Running   0          5d    10.244.2.56   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# curl 10.244.2.59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ubuntu31&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但是这种持久只是节点级的持久，如果节点宕机了，数据也就没了。因此跨节点调度时，数据还是会丢失的。&lt;/p&gt;
&lt;h3 id=&quot;nfs&quot;&gt;&lt;a href=&quot;#nfs&quot; class=&quot;headerlink&quot; title=&quot;nfs&quot;&gt;&lt;/a&gt;nfs&lt;/h3&gt;&lt;p&gt;以NFS为例，做一个共享存储。然后让三个节点挂载这个共享存储。&lt;br&gt;现在有1个节点：172.20.0.76  作为 nfs server。&lt;br&gt;将来集群中的node节点 hadoop16、spark17、ubuntu31要将nfs server上的相应目录挂载到本机的，所以要确定这几台node节点支持nfs。&lt;/p&gt;
&lt;p&gt;1、安装nfs server&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@dingding ~]# yum install -y nfs-utils&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;定义共享目录：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@dingding ~]# mkdir /home/data/volumes -pv&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mkdir: created directory ‘/home/data’&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mkdir: created directory ‘/home/data/volumes’&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@dingding ~]# vim /etc/exports&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes 172.16.206.0/24(rw,no_root_squash)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@dingding ~]# systemctl start nfs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@dingding ~]# netstat -anp|grep &amp;quot;2049&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tcp        0      0 0.0.0.0:2049            0.0.0.0:*               LISTEN      -                   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tcp6       0      0 :::2049                 :::*                    LISTEN      -                   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;udp        0      0 0.0.0.0:2049            0.0.0.0:*                           -                   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;udp6       0      0 :::2049                 :::*                                -&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在这个共享目录下创建个文件：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@dingding ~]# cd /home/data/volumes/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@dingding volumes]# vim index.html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;h1&amp;gt;NFS Server&amp;lt;/h1&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;下面手动找个节点去挂载下试试可否挂载：&lt;br&gt;要确保挂载节点都要能驱动这个存储设备。安装下工具。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# CentOS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@hadoop16 ~]# yum install nfs-utils -y&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Ubuntu&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;jkzhao@ubuntu31:~$ sudo apt-get install nfs-common -y&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@hadoop16 ~]# mount -t nfs 172.16.6.73:/home/data/volumes /mnt&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@hadoop16 ~]# mount | grep mnt&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.6.73:/home/data/volumes on /mnt type nfs4 (rw,relatime,vers=4.0,rsize=1048576,wsize=1048576,namlen=255,hard,proto=tcp,port=0,timeo=600,retrans=2,sec=sys,clientaddr=172.16.206.16,local_lock=none,addr=172.16.6.73)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;卸载：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@hadoop16 ~]# umount /mnt&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【注意】；这里在k8s集群node节点宿主机上不需要挂载，在容器里取挂载这个NFS server导出的目录。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例】：nfs存储卷示例。&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.volumes.nfs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: nfs &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     NFS represents an NFS mount on the host that shares a pod&amp;apos;s lifetime More&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     info: https://kubernetes.io/docs/concepts/storage/volumes#nfs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Represents an NFS mount that lasts the lifetime of a pod. NFS volumes do&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     not support ownership management or SELinux relabeling.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   path &amp;lt;string&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Path that is exported by the NFS server. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/volumes#nfs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   readOnly     &amp;lt;boolean&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ReadOnly here will force the NFS export to be mounted with read-only&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     permissions. Defaults to false. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/volumes#nfs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   server       &amp;lt;string&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Server is the hostname or IP address of the NFS server. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/volumes#nfs&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;path: NFS server上导出的路径。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# vim pod-nfs-vol.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-vol-nfs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    volumeMounts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      mountPath: /usr/share/nginx/html/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  volumes:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    nfs:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      path: /home/data/volumes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      server: 172.16.6.73&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl apply -f pod-nfs-vol.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-vol-nfs created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                             READY   STATUS    RESTARTS   AGE    IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;busybox                          0/1     Error     0          10d    10.244.2.49   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-ff9xf     1/1     Running   0          10d    10.244.1.19   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-msv5x     1/1     Running   0          10d    10.244.1.18   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-rp9vj     1/1     Running   0          10d    10.244.2.46   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-wls6h     1/1     Running   0          10d    10.244.3.7    hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-xzgdl     1/1     Running   0          10d    10.244.2.45   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx                            1/1     Running   0          10d    10.244.2.52   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-vol-nfs                      1/1     Running   0          9s     10.244.1.24   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis-58b9f5776-fzslw            1/1     Running   0          8d     10.244.2.53   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-4lhql   1/1     Running   0          5d1h   10.244.3.9    hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-ghz7l   1/1     Running   0          5d1h   10.244.1.21   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-kd5v8   1/1     Running   0          5d1h   10.244.2.56   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# curl 10.244.1.24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;h1&amp;gt;NFS Server&amp;lt;/h1&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;接下来删除这个pod，然后重新创建这个pod，即使这个pod被调度到其他节点，都能正常工作：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl delete -f pod-nfs-vol.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-vol-nfs&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl apply -f pod-nfs-vol.yaml  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-vol-nfs created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl get pods -o wide           &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                             READY   STATUS    RESTARTS   AGE    IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;busybox                          0/1     Error     0          10d    10.244.2.49   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-ff9xf     1/1     Running   0          10d    10.244.1.19   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-msv5x     1/1     Running   0          10d    10.244.1.18   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-rp9vj     1/1     Running   0          10d    10.244.2.46   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-wls6h     1/1     Running   0          10d    10.244.3.7    hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-xzgdl     1/1     Running   0          10d    10.244.2.45   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx                            1/1     Running   0          10d    10.244.2.52   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-vol-nfs                      1/1     Running   0          3s     10.244.2.60   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis-58b9f5776-fzslw            1/1     Running   0          8d     10.244.2.53   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-4lhql   1/1     Running   0          5d1h   10.244.3.9    hadoop16   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-ghz7l   1/1     Running   0          5d1h   10.244.1.21   spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-deploy-56699db4f7-kd5v8   1/1     Running   0          5d1h   10.244.2.56   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# curl 10.244.2.60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;h1&amp;gt;NFS Server&amp;lt;/h1&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;假设这里改成新建Deployment，里面有多个Pod，Deployment中template都定义挂载这个存储卷，nfs是否支持多路读写。nfs支持多客户端同时挂载，支持多客户端同时写操作。因为nfs server有持锁能力。&lt;br&gt;虽然这使得Pod有了真正意义上的持久能力，但是万一nfs server宕机了？数据一样会丢失，nfs不是一个分布式存储，没有冗余能力。应该使用glusterfs、ceph(rbd、cephfs)这样的自建的分布式存储，再不然使用云端存储。ceph可以直接提供restful的接口给k8s用。&lt;/p&gt;
&lt;h3 id=&quot;pvc-1&quot;&gt;&lt;a href=&quot;#pvc-1&quot; class=&quot;headerlink&quot; title=&quot;pvc&quot;&gt;&lt;/a&gt;pvc&lt;/h3&gt;&lt;p&gt;我们上面在使用NFS的时候，就得指定NFS的共享路径、NFS服务器地址之类的，所以很多要使用Pod的人，比如就是要运行一个应用程序，这个程序就要持久存数据，假设用户能做出镜像来，但是还得让用户去懂各种各样的存储，这是有点难为用户了。因此我们可以把这个所谓的存储功能隔离开来。就像k8s向用户提供所谓的运算能力，用户不用担心自己的应用程序怎么被启动的，运行在哪里，因此简化了部署操作的过程。存储能力也是这样子的，我们定义成生产者-消费者模型，有人去生产存储空间，有人去消费就行，不需要了解背后是什么。现在我们要用存储空间，得自己先去做，找个nfs服务器，创建nfs服务，提供存储空间。&lt;br&gt;能不能这样子，让存储工程师来管理存储服务，让k8s管理员来管理k8s。作为用户来讲，我们只需要创建Pod。如果Pod中需要用存储，我们只需要说“要用存储”就可以了，这就是所谓的pvc要帮我们达到的效果。但是pvc的使用逻辑比较复杂。我们可以这样来组织我们的存储，我们在Pod中定义pvc类型的存储卷，告诉要用多大的存储卷，而pvc类型的存储卷必须与当前名称空间中的pvc建立绑定关系，而且pvc必须pv建立绑定关系，而pv应该是某个真正存储设备的存储空间。所以pv和pvc这两个东西是k8s之上的抽象的、但也算是标准的资源。pvc是一种资源，pv也是一种资源，他们的创建方式和创建Ingress、Service几乎没有什么太大的区别。它们就是标准的资源。&lt;br&gt;但是用户需要怎么做呢？存储工程师把存储这一端，每一个存储空间先划分好，k8s管理员需要把每一个存储空间映射到系统上做成pv，pv是划分好的一个个大小的存储空间，一个pvc与pv建立关联关系后，完全占有这个pv。用户就自己定义Pod，在Pod中定义使用pvc就可以了。pvc可以是用户去定义，也可以是k8s管理员去定义，pvc是属于当前名称空间的资源。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/148.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/149.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl explain pods.spec.volumes.persistentVolumeClaim&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: persistentVolumeClaim &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PersistentVolumeClaimVolumeSource represents a reference to a&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PersistentVolumeClaim in the same namespace. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/persistent-volumes#persistentvolumeclaims&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PersistentVolumeClaimVolumeSource references the user&amp;apos;s PVC in the same&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     namespace. This volume finds the bound PV and mounts that volume for the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     pod. A PersistentVolumeClaimVolumeSource is, essentially, a wrapper around&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     another type of volume that is owned by someone else (the system).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   claimName    &amp;lt;string&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ClaimName is the name of a PersistentVolumeClaim in the same namespace as&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the pod using this volume. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/persistent-volumes#persistentvolumeclaims&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   readOnly     &amp;lt;boolean&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Will force the ReadOnly setting in VolumeMounts. Default false.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;pvc也是标准的k8s资源。下面看看pvc定义使用的一些字段：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl explain pvc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl explain pvc.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     PersistentVolumeClaim&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Spec defines the desired characteristics of a volume requested by a pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     author. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/persistent-volumes#persistentvolumeclaims&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PersistentVolumeClaimSpec describes the common attributes of storage&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     devices and allows a Source for provider-specific attributes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   accessModes  &amp;lt;[]string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     AccessModes contains the desired access modes the volume should have. More&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/persistent-volumes#access-modes-1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   dataSource   &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     This field requires the VolumeSnapshotDataSource alpha feature gate to be&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     enabled and currently VolumeSnapshot is the only supported data source. If&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the provisioner can support VolumeSnapshot data source, it will create a&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     new volume and data will be restored to the volume at the same time. If the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     provisioner does not support VolumeSnapshot data source, volume will not be&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     created and the failure will be reported as an event. In the future, we&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     plan to support more data source types and the behavior of the provisioner&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     may change.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   resources    &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Resources represents the minimum resources the volume should have. More&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/persistent-volumes#resources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   selector     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     A label query over volumes to consider for binding.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   storageClassName     &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Name of the StorageClass required by the claim. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/persistent-volumes#class-1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   volumeMode   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     volumeMode defines what type of volume is required by the claim. Value of&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Filesystem is implied when not included in claim spec. This is a beta&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     feature.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   volumeName   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     VolumeName is the binding reference to the PersistentVolume backing this&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     claim.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;accessModes  &amp;lt;[]string&amp;gt;&lt;br&gt;访问模型，无非就是支不支持多人同时访问之类的。&lt;br&gt;&lt;a href=&quot;https://kubernetes.io/docs/concepts/storage/persistent-volumes#access-modes-1&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/concepts/storage/persistent-volumes#access-modes-1&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;resources    &lt;object&gt;&lt;br&gt;资源限制条件，期望对应的存储空间最少有多大，比如10g。我们创建个10g的pvc，背后的pv一定要10g以上，找到10g的就绑10g的pv，如果我们找到了pv有12g的，就绑这个。所以是至少多少。&lt;/object&gt;&lt;/li&gt;
&lt;li&gt;selector     &lt;object&gt;&lt;br&gt;pv是可以有标签的，pvc上使用标签选择器就表示必须与哪个pv建立关联关系，但是 你也可以不加标签，就会在所有pv里找最佳匹配&lt;/object&gt;&lt;/li&gt;
&lt;li&gt;storageClassName     &lt;string&gt;&lt;br&gt;存储类名称，后续在谈。&lt;/string&gt;&lt;/li&gt;
&lt;li&gt;volumeMode   &lt;string&gt;&lt;br&gt;后端存储卷的模式。&lt;/string&gt;&lt;/li&gt;
&lt;li&gt;volumeName   &lt;string&gt;&lt;br&gt;卷名称，后端persistentVolume(pv)的name。精确选择，就是要绑定哪个pv。也可以用选择器来选定。&lt;/string&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;pv也是标准的k8s资源。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl explain pv&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl explain pv.spec&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;而 pv.spec 与我们定义存储卷时的 pods.spec.volumes 一模一样。只不过把此前应该定义在Pod上的，现在定义在pv上了。&lt;/p&gt;
&lt;p&gt;创建pvc后，系统就会去找符合等价的pv，找到就绑定，找不到就会一直pending，挂起。&lt;br&gt;存储工程师将存储划分了很多个存储空间，然后k8s集群管理员把这些存储都引入到集群中来，定义成pv。随后k8s用户创建Pod，在创建Pod之前，要先创建pvc，这是个claim，这个claim表示要在当前k8s集群中找一个能符合我们条件的存储空间来用。而后系统就在pv里面找哪个合适，然后分给它。pv和pvc是一一对应关系，意思是说如果某个pv被某个pvc占用了，意味着这个pv就不能被其他pvc占用了。会显示这个pv的状态是binding。但是一个pvc创建以后，这个pvc就相当于一个存储卷了，这个存储卷却可以被多个Pod所访问，多路访问。到底支持不支持多个Pod同时访问，你要定义这个pvc的访问模式。因此我们在创建pvc的时候，最好底下有匹配的pv存在，如果不存在就绑定不了了，绑定不了，pvc的状态就是pending。直到有符合条件的pv出现。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例】：我们在nfs上先准备几个空间，然后把它们做成pv放在那里，然后用户才能使用pvc去申请绑定和使用它们。&lt;/strong&gt;&lt;br&gt;先把上面的示例中的Pod删除了：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl delete -f pod-nfs-vol.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-vol-nfs&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在nfs server服务器上执行如下操作：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@dingding volumes]# pwd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@dingding volumes]# mkdir v&amp;#123;1,2,3,4,5&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@dingding volumes]# ls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;index.html  v1  v2  v3  v4  v5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@dingding volumes]# vim /etc/exports&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v1 172.16.206.0/24(rw,no_root_squash)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v2 172.16.206.0/24(rw,no_root_squash)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v3 172.16.206.0/24(rw,no_root_squash)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v4 172.16.206.0/24(rw,no_root_squash)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v5 172.16.206.0/24(rw,no_root_squash)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@dingding volumes]# exportfs -arv&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;exporting 172.16.206.0/24:/home/data/volumes/v5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;exporting 172.16.206.0/24:/home/data/volumes/v4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;exporting 172.16.206.0/24:/home/data/volumes/v3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;exporting 172.16.206.0/24:/home/data/volumes/v2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;exporting 172.16.206.0/24:/home/data/volumes/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@dingding volumes]# showmount -e 172.16.6.73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Export list for 172.16.6.73:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v5 172.16.206.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v4 172.16.206.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v3 172.16.206.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v2 172.16.206.0/24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/home/data/volumes/v1 172.16.206.0/24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我们先把这5个存储定义成pv。正常使用的场景中，这部分工作是k8s管理员做的。&lt;br&gt;&lt;strong&gt;定义一个nfs格式的pv:&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# kubectl explain pv.spec&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;重要字段：&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;- accessModes  &amp;lt;[]string&amp;gt;&lt;/strong&gt;&lt;br&gt;     AccessModes contains all ways the volume can be mounted. More info:&lt;br&gt;     &lt;a href=&quot;https://kubernetes.io/docs/concepts/storage/persistent-volumes#access-modes&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/concepts/storage/persistent-volumes#access-modes&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/150.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/151.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;看表中，NFS这3种模型都支持。accessModes 是个列表，意味着我们可以同时定义支持3种模型。但是即使支持多种访问模型，但是挂载时只能选定一种模式。&lt;br&gt;&lt;strong&gt;- capacity     &lt;map[string]string&gt;  ：指定存储空间大小的。&lt;/map[string]string&gt;&lt;/strong&gt;&lt;br&gt;     A description of the persistent volume’s resources and capacity. More info:&lt;br&gt;     &lt;a href=&quot;https://kubernetes.io/docs/concepts/storage/persistent-volumes#capacity&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/concepts/storage/persistent-volumes#capacity&lt;/a&gt;&lt;br&gt;对于存储空间来讲，它其实只有1路能输出的资源限制功能，叫Storage，无非就是存储空间是多大。支持这么几种单位。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/152.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;我们使用Ki、Mi，Gi，不要像硬盘生产厂商那样子，说是500GB，是以1000为单位的，拿回来一看可能只有480GB。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# mkdir pvc-pv&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 volume]# cd pvc-pv/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pvc-pv]# vim pv-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: PersistentVolume&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pv001&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name: pv001&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  nfs:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    path: /home/data/volumes/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server: 172.16.6.73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  accessModes: [&amp;quot;ReadWriteMany&amp;quot;,&amp;quot;ReadWriteOnce&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  capacity:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    storage: 10Mi&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;---&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: PersistentVolume&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pv002&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name: pv002&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  nfs:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    path: /home/data/volumes/v2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server: 172.16.6.73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  accessModes: [&amp;quot;ReadWriteOnce&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  capacity:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    storage: 20Mi&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;---&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: PersistentVolume&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pv003&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name: pv003&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  nfs:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    path: /home/data/volumes/v3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server: 172.16.6.73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  accessModes: [&amp;quot;ReadWriteMany&amp;quot;,&amp;quot;ReadWriteOnce&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  capacity:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    storage: 50Mi&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;---&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: PersistentVolume&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pv004&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name: pv004&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  nfs:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    path: /home/data/volumes/v4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server: 172.16.6.73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  accessModes: [&amp;quot;ReadWriteMany&amp;quot;,&amp;quot;ReadWriteOnce&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  capacity:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    storage: 50Mi&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;---&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: PersistentVolume&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pv005&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name: pv005&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  nfs:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    path: /home/data/volumes/v5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server: 172.16.6.73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  accessModes: [&amp;quot;ReadWriteMany&amp;quot;,&amp;quot;ReadWriteOnce&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  capacity:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    storage: 50Mi&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;【注意】：定义pv的时候一定不要加名称空间，因为pv是属于集群级别的，不属于名称空间，属于整个集群。但是pvc是属于名称空间级别的。namespace不能嵌套，namespace也是属于集群级别的资源。所谓集群级别的，意思就是不能定义在名称空间中。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pvc-pv]# kubectl apply -f pv-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;persistentvolume/pv001 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;persistentvolume/pv002 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;persistentvolume/pv003 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;persistentvolume/pv004 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;persistentvolume/pv005 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pvc-pv]# kubectl get pv&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv001   10Mi       RWO,RWX        Retain           Available                                   71s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv002   20Mi       RWO            Retain           Available                                   71s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv003   50Mi       RWO,RWX        Retain           Available                                   70s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv004   50Mi       RWO,RWX        Retain           Available                                   70s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pv005   50Mi       RWO,RWX        Retain           Available                                   70s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;RECLAIM POLICY：回收策略。&lt;/strong&gt;&lt;br&gt;比如说某个pvc和某个pv绑定了，在里面存数据了，但是后来这pvc被删了，此时绑定就不存在了。一旦绑定不存在以后，这个pv怎么处理？它里面还放着数据呢。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Retain：表示保留。pv默认就是这个策略。&lt;/li&gt;
&lt;li&gt;Recycle：回收，表示把里面数据都删了，pv给其他pvc绑定。&lt;/li&gt;
&lt;li&gt;Delete：解绑后，把pv也删除了，当然数据也没了。后面这两种都很危险。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;下面定义pvc，然后给pod使用。&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pvc-pv]# kubectl explain pvc.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     PersistentVolumeClaim&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Spec defines the desired characteristics of a volume requested by a pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     author. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/persistent-volumes#persistentvolumeclaims&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PersistentVolumeClaimSpec describes the common attributes of storage&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     devices and allows a Source for provider-specific attributes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   accessModes  &amp;lt;[]string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     AccessModes contains the desired access modes the volume should have. More&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/persistent-volumes#access-modes-1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   dataSource   &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     This field requires the VolumeSnapshotDataSource alpha feature gate to be&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     enabled and currently VolumeSnapshot is the only supported data source. If&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the provisioner can support VolumeSnapshot data source, it will create a&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     new volume and data will be restored to the volume at the same time. If the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     provisioner does not support VolumeSnapshot data source, volume will not be&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     created and the failure will be reported as an event. In the future, we&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     plan to support more data source types and the behavior of the provisioner&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     may change.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   resources    &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Resources represents the minimum resources the volume should have. More&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/persistent-volumes#resources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   selector     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     A label query over volumes to consider for binding.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   storageClassName     &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Name of the StorageClass required by the claim. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/storage/persistent-volumes#class-1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   volumeMode   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     volumeMode defines what type of volume is required by the claim. Value of&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Filesystem is implied when not included in claim spec. This is a beta&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     feature.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   volumeName   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     VolumeName is the binding reference to the PersistentVolume backing this&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     claim.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;重要字段解释：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;accessModes：必须是想绑定的pv的accessModes的子集。&lt;/li&gt;
&lt;li&gt;resources：pv的值要大于等于这个值才能是候选之一的pv&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pvc-pv]# vim pod-vol-pvc.yaml  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: PersistentVolumeClaim&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: mypvc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  accessModes: [&amp;quot;ReadWriteMany&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  resources:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    requests:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      storage: 30Mi&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;---&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-vol-pvc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    volumeMounts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      mountPath: /usr/share/nginx/html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  volumes:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    persistentVolumeClaim:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      claimName: mypvc            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 pvc-pv]# kubectl apply -f pod-vol-pvc.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;persistentvolumeclaim/mypvc unchanged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-vol-pvc created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/153.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;将来一般删Pod时不会删pvc，只要pvc不删除，pv就算你定义的策略为回收或删除，pv也会一直在那，数据也在那。pvc不属于节点，存储在etcd中的，只要etcd不出问题，pvc就不会有问题。k8s资源，只有Pod是需要运行在节点上的，所有的其他资源基本都是保存在apiserver的存储，叫集群状态存储etcd中。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【注意】：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;当pvc被Pod挂载时，我们直接删除pvc是删除不了的，除非先删除相应的Pod。&lt;/li&gt;
&lt;li&gt;假设pv的回收策略是Retain，当删除了pvc后，pv状态会从Bound变成Released，数据依然在pv对应的存储空间上。虽然 pv 中的数据得到了保留，但其 PV 状态会一直处于 Released，不能被其他 PVC 申请。为了重新使用存储资源，可以删除并重新创建 这个pv。删除操作只是删除了 PV 对象，存储空间中的数据并不会被删除。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;假如现在要请求使用30G的pvc，目前这5个pv是满足不了条件的，所以得事先联系管理员，告诉他要用这么大，事先帮我们创建好。不然pvc就pending了，从而Pod也就pending了。因此我们要比较灵活地解决这个问题，动态供给。意思是定义好&lt;strong&gt;存储类&lt;/strong&gt;，而后用户创建pvc的时候，动态地给他生成一个pv，pv事先是不存在的。&lt;/p&gt;
&lt;p&gt;pvc申请的时候，未必有现成的pv正好符合pvc在申请中指定的条件。因此k8s有意设计了这么一种工作逻辑，能够让pvc在申请pv时，不针对某个pv进行。或者说是针对某个存储类(StorageClass)进行，存储类也是k8s之上的一个标准资源，借助这么个中间层，来完成资源分配。意思是k8s管理员可以事先把存储管理员准备的众多的存储设备，可能有NFS、glusterfs、ceph、rbd、甚至是一些云端的存储，把这些提供好的存储空间，我们事先不做pv，把这些存储资源做一个分类，根据综合服务质量，或者根据哪怕是I/O性能等等，做一个简单的分类。&lt;br&gt;比如有两个节点的NFS集群，把这两个NFS所能提供的存储空间分为一类，另外我们还有一个ceph的rbd集群，我们将这个集群定义成另一个分类。这就是存储类。我们分类可以根据自己评估的任何维度，甚至地理位置等。然后我们定义出来这个类StorageClass。随后pvc申请pv时，不在针对某个pv直接进行，而是针对存储类来进行。假如说ceph集群我们定义为Gold StorageClass，NFS集群定义为silver StorageClass。我们向金牌存储类中申请，就在金牌存储类中给pvc动态创建一个pv来。&lt;br&gt;对这些存储设备，有一个前提，必须支持restful风格的请求的创建接口才行。比如NFS，我们上面输出了v1，v2，一直到v5。这几个大小都是定义时设定好了，但是pvc在申请时你之前是不知道大小的。存储工程师只提供了存储服务器，或者说是存储集群，在这个存储上没有任何已经划分好的卷，以NFS为例，在NFS server上并没有一个导出的v1，v2…  假设服务器本地有一块硬盘，我们可以把它划分成很多分区来，每一个分区输出一个共享点。但是现状是分区还没创建呢，更别提共享点了。而后我们在NFS前端定义好restful风格的接口，用户可以通过api直接请求，请求什么呢？&lt;br&gt;1.在磁盘上划分一个刚好符合pvc大小的分区；&lt;br&gt;2.编辑exports文件，把对应的分区挂载至本地的某个目录上，并且导出。&lt;br&gt;3.动态创建出一个pv，刚好使用刚才导出的空间。&lt;br&gt;但是NFS是不支持刚才描述的功能的，只是举例子说明动态供给是怎么工作的。有些存储是支持的，比如ceph。比如我们准备了很多本地的磁盘，大概一共4PB的空间，但是这4PB不是拿来直接用的，将来在划分成子单位，子单位一般叫image。每个image相当于一块硬盘或一个分区。当我们想申请一个20GB的pv时，我们通过ceph的restful接口请求，立即划分成一个大小为20G的image，把它格式化完成，而后通过ceph导出出来，接着在集群中定义成20G大小的pv，接着跟pvc绑定。所以后端存储设备得支持restful风格的管理接口，才能实现动态pv供给的。、&lt;br&gt;glusterfs也可以。比ceph要简单多。但是glustefs自身不携带restful风格的接口，你得找一个第三方项目在上面补一个restful风格的接口。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;什么是存储卷&quot;&gt;&lt;a href=&quot;#什么是存储卷&quot; class=&quot;headerlink&quot; title=&quot;什么是存储卷&quot;&gt;&lt;/a&gt;什么是存储卷&lt;/h2&gt;&lt;p&gt;大多数和数据存储相关的应用和有状态应用都是需要持久存储数据的。容器本身有生命周期，为了使得容器将来终结后我们可以把它删除，甚至是编排到其他节点上运行，意味着数据不能放在容器自己的名称空间中。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Ingress及Ingress Controller</title>
    <link href="http://yoursite.com/2019/08/21/Kubernetes-Ingress%E5%8F%8AIngress-Controller/"/>
    <id>http://yoursite.com/2019/08/21/Kubernetes-Ingress及Ingress-Controller/</id>
    <published>2019-08-21T01:44:12.000Z</published>
    <updated>2019-08-22T05:31:40.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Ingress-Controller&quot;&gt;&lt;a href=&quot;#Ingress-Controller&quot; class=&quot;headerlink&quot; title=&quot;Ingress Controller&quot;&gt;&lt;/a&gt;Ingress Controller&lt;/h2&gt;&lt;p&gt;在Kubernetes集群中，后端被代理的资源，是不配置https的，是纯明文的http，但是我们使用一个独特的调度器或者叫Pod，对这个Pod来讲，它是一个运行在用户空间的应用程序，比如Nginx、traefik、haproxy、Envoy等。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;当用户试图访问某一服务时，我们不让这些请求先到达这些后端Pod的service，而是先到达这个Pod。这个Pod和service后的Pod是同一个网段的，所以可以让这个Pod和后端Pod直接通信，不要经过service，来完成反向代理。问题是这个Pod怎么接入外部流量呢？它需要NodePort类型的service。&lt;br&gt;客户端通过NodePort类型的service调度以后，与我们专门配置了https的Pod进行通信。但是等请求到达此Pod以后，由此Pod反向代理至后端Pod。所以这个Pod是https会话卸载器了。&lt;br&gt;访问任何一个节点的NodePort都能到达那个反向代理Pod，每一个节点都拥有Pod所在网络的地址，可以跟Pod直接通信。&lt;br&gt;但是这种模式调度次数太多了，集群外负载均衡调度到Node，Node调度到service，service调度到反向代理Pod，反向代理Pod调度到后端Pod。性能太差了。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/124.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;可以让实现反向代理的Pod直接共享节点的网络名称空间，也就是Pod监听着宿主机的地址。这样在集群外做个4层负载均衡，这个四层调度性能损失较少，然后到集群Pod了。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/125.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;但是这样一来，这个Pod在每个node上只能运行1个了。一般来讲，这样的Pod，集群一般只运行1个，这个Pod运行在集群某个节点上就可以了。但是让这个Pod监听在节点的端口上，会有一个问题。使用Service时，用户访问任何一个节点的NodePort都行，但是目前这个Pod只运行1个，只监听在一个节点上。万一这个节点挂了呢？&lt;br&gt;使用DaemonSet，在每个节点上都运行，而且只运行1个这样的Pod。这样调度到任何一个节点都可以了。但是假如集群有非常多的节点，比如1000个节点，没必要在每个节点上都运行这样的Pod，DaemonSet可以实现在部分节点上运行。1000个节点拿出3个节点，打上污点，让别的Pod都调度不上来，我们定义这个DaemonSet控制下的Pod只允许运行在这3个节点上，并且能容忍这个污点。这3个节点专门用来接入集群外部的7层调度的流量。&lt;br&gt;而这个Pod在k8s当中有个专门的称呼，叫&lt;strong&gt;Ingress Controller&lt;/strong&gt;。Ingress Controller是一个或一组Pod资源，它通常就是一个应用程序，这个应用程序就是拥有7层代理能力和调度能力的应用程序。目前k8s上的选择通常有4种：Nginx、Traefik、Envoy、HAProxy。最不受待见的就是HAProxy，但是现在在serviceMesh，服务网格中大家倾向的是Envoy。&lt;br&gt;将来在用Ingress Controller时，我们有3种选择：&lt;strong&gt;Nginx、Traefik、Envoy&lt;/strong&gt;。去做微服务的，大家都比较倾向于Envoy。Traefik本身也是为微服务设计的，动态生成配置。Nginx是后来改造的。&lt;br&gt;假设这个7层Pod调度多个后端服务，比如有一组Pod提供了电商服务，第二组Pod提供了社交服务，第三组服务提供了API服务，还有一组Pod提供的是论坛服务。这个7层Pod如果来调度这4组http服务。以Nginx为例，这是4组upstream，然后定义4个虚拟主机。假如说这个Pod只有1个IP地址，那么做4个虚拟主机只能根据4个主机名来做了。每个虚拟主机对应后端Pod。这4个虚拟主机要能提供公网能解析的域名。但是假如我们没有那么多主机名，就1个域名怎么办？url映射。每一个location映射不到不同的upstream。&lt;/p&gt;
&lt;h2 id=&quot;Ingress&quot;&gt;&lt;a href=&quot;#Ingress&quot; class=&quot;headerlink&quot; title=&quot;Ingress&quot;&gt;&lt;/a&gt;Ingress&lt;/h2&gt;&lt;p&gt;现在有个问题，Nginx中upstream中要指定有哪些主机的，现在后端不是主机，Pod是有生命周期的，随时有可能挂掉，起来一个新Pod，新Pod的IP地址就变了。另外后端的Pod可以动态升缩的，改一下，Pod就变多或变少了。&lt;br&gt;Service是怎么面对这个问题的：Service通过标签选择器关联标签来解决，而且Service始终watch着apiserver中的api，关心自己对应的资源是否发生变动。&lt;br&gt;这里Nginx怎么办？Nginx是运行在Pod中的，配置是在Pod内部的，upstream对应的Pod变动怎么办？同样的，Ingress Controller，也需要随时watch api当中的后端Pod资源的改变，怎么知道是哪些Pod资源呢？Ingress Controller自己没这个能力，它自己并不知道目前符合自己条件的Pod资源有哪些个，必须要借助于Service来实现。因此我们还是得建Service。每一个upstream服务器组要对应1个Service资源。但是这个Service不是被当做代理时的中间节点，它仅仅是帮忙分组的，知道找哪几个Pod就行了，调度时是不会走Service的。Pod一有变化，Service对应的也变了，这个变化怎么反应到配置文件中呢？依赖于一个专门的资源叫&lt;strong&gt;Ingress&lt;/strong&gt;。Ingress和Ingress Controller是两回事，我们定义一个Ingress的时候要说明，期望Ingress Controller是如何给我们建一个前端，又给我们定义一个后端，就是upstream server，这个upstream server中有几个主机，Ingress是通过这个Service来知道的。&lt;br&gt;而且Ingress有一个特点，作为一个资源来讲，它可以直接通过边界注入到Ingress Controller里面来，注入并保存为配置文件。而且一旦Ingress发现Service选定的后端Pod发生改变，这个改变一定会及时反应到Ingress中，Ingress会及时注入到Ingress Controller中定义的Pod中，而且还能触发主容器的进程重载配置文件。但是Nginx并不是很适合这种场景，每次修改配置都得重载，traefik、Envoy天生就是为这种设计而生的，只要动了，它自己可以自动加载生效，不需要重载。或者说它可以自己监控着配置文件，改变了就自己重载了。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/126.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;使用步骤：先是定义Ingress Controller这个Pod，然后去定义Ingress，而后在定义后端Pod生成service。&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/127.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;Ingress资源定义字段&quot;&gt;&lt;a href=&quot;#Ingress资源定义字段&quot; class=&quot;headerlink&quot; title=&quot;Ingress资源定义字段&quot;&gt;&lt;/a&gt;Ingress资源定义字段&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Ingress is a collection of rules that allow inbound connections to reach&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the endpoints defined by a backend. An Ingress can be configured to give&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     services externally-reachable urls, load balance traffic, terminate SSL,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     offer name based virtual hosting etc. DEPRECATED - This group version of&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Ingress is deprecated by networking.k8s.io/v1beta1 Ingress. See the release&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     notes for more information.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   apiVersion   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     APIVersion defines the versioned schema of this representation of an&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     object. Servers should convert recognized schemas to the latest internal&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     value, and may reject unrecognized values. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#resources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   kind &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Kind is a string value representing the REST resource this object&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     represents. Servers may infer this from the endpoint the client submits&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     requests to. Cannot be updated. In CamelCase. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   metadata     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Standard object&amp;apos;s metadata. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Spec is the desired state of the Ingress. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   status       &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Status is the current state of the Ingress. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;一级字段依然是这5个。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain ingress.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Spec is the desired state of the Ingress. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     IngressSpec describes the Ingress the user wishes to exist.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   backend      &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     A default backend capable of servicing requests that don&amp;apos;t match any rule.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     At least one of &amp;apos;backend&amp;apos; or &amp;apos;rules&amp;apos; must be specified. This field is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     optional to allow the loadbalancer controller or defaulting logic to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     specify a global default.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   rules        &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     A list of host rules used to configure the Ingress. If unspecified, or no&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     rule matches, all traffic is sent to the default backend.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   tls  &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     TLS configuration. Currently the Ingress only supports a single TLS port,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     443. If multiple members of this list specify different hosts, they will be&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     multiplexed on the same port according to the hostname specified through&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the SNI TLS extension, if the ingress controller fulfilling the ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     supports SNI.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain ingress.spec.backend &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain ingress.spec.rules&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain ingress.spec.rules.http&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;官方文档中指明Ingress有很多种类型，要么是基于虚拟主机的，要么是url映射的。&lt;br&gt;Ingress Controller已经是作为k8s的附件了。整个k8s集群，有master、node和附件组成，一共有4个核心附件，DNS、heasper、dashboard、Ingress Controller。&lt;/p&gt;
&lt;h2 id=&quot;创建Nginx-Ingress-Controller&quot;&gt;&lt;a href=&quot;#创建Nginx-Ingress-Controller&quot; class=&quot;headerlink&quot; title=&quot;创建Nginx Ingress Controller&quot;&gt;&lt;/a&gt;创建Nginx Ingress Controller&lt;/h2&gt;&lt;p&gt;浏览器输入&lt;a href=&quot;https://github.com/kubernetes&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kubernetes在github上网址&lt;/a&gt;，在这个下面可以找到一个项目叫“ingress-nginx”。点击进去：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/128.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;部署时只会用到deploy/static目录下的文件，我们可以把项目克隆下来，或者直接进deploy/static目录下载这些清单文件。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/129.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;在部署前，可以先大概了解下，部署Nginx Ingress Controller需要部署哪些资源：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;namespace.yaml: Nginx Ingress Controller要部署在一个独立的namespace中，可以打开namespace.yaml中看下。&lt;/li&gt;
&lt;li&gt;configmap.yaml: 用到configMap，从外界为Nginx注入配置，可以查看configmap.yaml中的内容&lt;/li&gt;
&lt;li&gt;rbac.yaml: 我们使用kubeadm部署的k8s集群默认启用了rbac，这个rbac.yaml文件定义可一个ClusterRole，做一些授权，必要的让这个Ingress Controller拥有访问它本来到达不了的名称空间的权限&lt;/li&gt;
&lt;li&gt;with-rbac.yaml: 部署Ingress Controller的清单文件，带上了rbac&lt;/li&gt;
&lt;li&gt;mandatory.yaml: 这个清单文件是把所有资源都组合在了一个文件中。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;下载yaml清单文件：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# cd manifests/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# mkdir ingress-nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cd ingress-nginx/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress-nginx]# for file in configmap.yaml namespace.yaml rbac.yaml with-rbac.yaml; do wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/$file; done&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress-nginx]# ls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;configmap.yaml  namespace.yaml  rbac.yaml  with-rbac.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;先创建namespace，其他的yaml文件执行顺序没关系：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress-nginx]# kubectl apply -f namespace.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;namespace/ingress-nginx created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;创建其他资源：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress-nginx]# kubectl apply -f ./&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;configmap/nginx-configuration created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;configmap/tcp-services created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;configmap/udp-services created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;namespace/ingress-nginx unchanged&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceaccount/nginx-ingress-serviceaccount created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrole.rbac.authorization.k8s.io/nginx-ingress-clusterrole created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;role.rbac.authorization.k8s.io/nginx-ingress-role created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rolebinding.rbac.authorization.k8s.io/nginx-ingress-role-nisa-binding created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrolebinding.rbac.authorization.k8s.io/nginx-ingress-clusterrole-nisa-binding created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/nginx-ingress-controller created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress-nginx]# kubectl get pods -n ingress-nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                                        READY   STATUS              RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-ingress-controller-86449c74bb-jth2m   0/1     ContainerCreating   0          16s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个Pod内的镜像在国内拉取速度非常慢，等了好久。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress-nginx]# kubectl get pods -n ingress-nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                                        READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-ingress-controller-86449c74bb-jth2m   1/1     Running   0          83m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;可以提前手动拉取：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;docker pull quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.25.0&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;目前 Nginx Ingress Controller 已经有自己项目的官方站点了: &lt;a href=&quot;https://kubernetes.github.io/ingress-nginx/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.github.io/ingress-nginx/&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/130.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;对于通用部署命令中，只需要执行一条命令即可：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这个mandatory.yaml就是将所有需要的资源定义在了这一个清单文件中了。我这里部署在了虚拟机上，还需要看下裸机章节中需要执行什么额外操作：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/131.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;如果不加这个service nodeport，你会发现你的Ingress Controller部署完以后，只能在集群内部访问，因为Ingress Controller无法接入集群外部的流量，为了接入流量，我们得为它做一个NodePort类型的service。&lt;br&gt;&lt;strong&gt;有两种方案让Ingress Controller接入外部流量：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;一是创建一个NodePort类型的Service，其标签选择器选中Ingress Controller这个Pod&lt;/li&gt;
&lt;li&gt;二是部署Ingress Controller这个Pod时，设置其共享节点网络名称空间，这个方案需要我们在创建Ingress Controller前修改with-rbac.yaml文件。修改如下几个地方：&lt;ul&gt;
&lt;li&gt;将一级字段kind的值从Deployment改为DaemonSet&lt;/li&gt;
&lt;li&gt;将一级字段spec下的replicas字段删除&lt;/li&gt;
&lt;li&gt;在spec.template.spec下加一个字段 hostNetwork: true&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我这里选择第一种方案，那就还需要为Ingress Controller创建一个NodePort类型的service，不然无法在集群外访问。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress-nginx]# wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/baremetal/service-nodeport.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress-nginx]# vim service-nodeport.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/132.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress-nginx]# kubectl apply -f .&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress-nginx]# kubectl get svc -n ingress-nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME            TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ingress-nginx   NodePort   10.110.228.115   &amp;lt;none&amp;gt;        80:30080/TCP,443:30443/TCP   24s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;创建Ingress&quot;&gt;&lt;a href=&quot;#创建Ingress&quot; class=&quot;headerlink&quot; title=&quot;创建Ingress&quot;&gt;&lt;/a&gt;创建Ingress&lt;/h2&gt;&lt;p&gt;看看k8s官网上Ingress的定义示例，打开网址：&lt;a href=&quot;https://kubernetes.io/docs/concepts/services-networking/ingress/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/concepts/services-networking/ingress/&lt;/a&gt; ，有个最简单的示例如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: networking.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: test-ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    nginx.ingress.kubernetes.io/rewrite-target: /&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  rules:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - http:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      paths:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - path: /testpath&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        backend:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          serviceName: test&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          servicePort: 80&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中，annotations至关重要，必须要定义。在这个annotations中必须指明我们用的Ingress Controller类型是Nginx。&lt;/p&gt;
&lt;h3 id=&quot;示例1&quot;&gt;&lt;a href=&quot;#示例1&quot; class=&quot;headerlink&quot; title=&quot;示例1&quot;&gt;&lt;/a&gt;示例1&lt;/h3&gt;&lt;p&gt;下面定义Ingress，将myapp-deploy里的Pod通过Nginx Ingress Controller向外提供服务。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME           READY   UP-TO-DATE   AVAILABLE   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy   5/5     5            5           5d4h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis          1/1     1            1           2d4h&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;已经有一个Deployment了，为这个Deployment创建个Service：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl expose deploy myapp-deploy --name=myapp --port=80 --target-port=80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/myapp exposed&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes           ClusterIP   10.96.0.1       &amp;lt;none&amp;gt;        443/TCP    130d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp         ClusterIP   10.103.20.216  &amp;lt;none&amp;gt;        80/TCP     8s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-svc-headless   ClusterIP   None            &amp;lt;none&amp;gt;        80/TCP     2d3h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis                ClusterIP   10.97.97.97     &amp;lt;none&amp;gt;        6379/TCP   2d4h&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在定义Ingress时需要加一个注解，说明接下来要用到的Ingress Controller是Nginx，而不是Traefik和Envoy。要靠这个Annotation来识别的。他才能转换成对应的与Controller相匹配的规则。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress-nginx]# cd ..&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# mkdir ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cd ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# vim ingress-myapp.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: ingress-myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    kubernetes.io/ingress.class: &amp;quot;nginx&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  rules:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - host: myapp.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    http:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      paths:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - path: /&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        backend:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          serviceName: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          servicePort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# kubectl apply -f ingress-myapp.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ingress.extensions/ingress-myapp created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# kubectl get ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME            HOSTS              ADDRESS   PORTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ingress-myapp   myapp.wisedu.com             80      5s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/133.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/134.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;去看看配置有没有加到Nginx上：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -n ingress-nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                                        READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-ingress-controller-86449c74bb-jth2m   1/1     Running   0          172m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl exec nginx-ingress-controller-86449c74bb-jth2m -n ingress-nginx -it -- /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ ls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;geoip  lua  mime.types  modsecurity  modules  nginx.conf  opentracing.json  owasp-modsecurity-crs  template&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ ps -ef|grep nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;www-data     1     0  0 07:17 ?        00:00:00 /usr/bin/dumb-init -- /nginx-ingress-controller --configmap=ingress-nginx/nginx-configuration --tcp-services-configmap=ingress-nginx/tcp-services --udp-services-configmap=ingress-nginx/udp-services --publish-service=ingress-nginx/ingress-nginx --annotations-prefix=nginx.ingress.kubernetes.io&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;www-data     6     1  0 07:17 ?        00:00:11 /nginx-ingress-controller --configmap=ingress-nginx/nginx-configuration --tcp-services-configmap=ingress-nginx/tcp-services --udp-services-configmap=ingress-nginx/udp-services --publish-service=ingress-nginx/ingress-nginx --annotations-prefix=nginx.ingress.kubernetes.io&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;www-data    35     6  0 07:17 ?        00:00:00 nginx: master process /usr/local/openresty/nginx/sbin/nginx -c /etc/nginx/nginx.conf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;www-data   320    35  0 08:54 ?        00:00:00 nginx: worker process&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;www-data   321    35  0 08:54 ?        00:00:00 nginx: worker process&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;www-data   322    35  0 08:54 ?        00:00:00 nginx: worker process&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;www-data   323    35  0 08:54 ?        00:00:00 nginx: worker process&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;www-data   324    35  0 08:54 ?        00:00:00 nginx: worker process&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;www-data   325    35  0 08:54 ?        00:00:00 nginx: worker process&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;www-data   326    35  0 08:54 ?        00:00:00 nginx: worker process&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;www-data   327    35  0 08:54 ?        00:00:00 nginx: worker process&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;www-data   600   593  0 09:03 pts/0    00:00:00 grep nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ cat /etc/nginx/nginx.conf&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/135.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/136.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;下面修改下客户端hosts文件，我这里修改自己笔记本的/etc/hosts文件，把myapp.wisedu.com这个域名配置解析成k8s集群中所有节点的IP地址，我这里node节点有3个：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.17 myapp.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.31 myapp.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.16 myapp.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.32 myapp.wisedu.com&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;打开浏览器访问：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/137.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例2&quot;&gt;&lt;a href=&quot;#示例2&quot; class=&quot;headerlink&quot; title=&quot;示例2&quot;&gt;&lt;/a&gt;示例2&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;1、创建Deployment和Service(该示例中我使用的是headless Service)&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim tomcat-deploy.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: tomcat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: tomcat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  clusterIP: None&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    port: 8080&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    targetPort: 8080&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: ajp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    port: 8009&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    targetPort: 8009&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;---&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: tomcat-deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  replicas: 3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    matchLabels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      app: tomcat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  template:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        app: tomcat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        image: tomcat:8.5.32-jre8-alpine&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          containerPort: 8080&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - name: ajp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          containerPort: 8009&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f tomcat-deploy.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/tomcat created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/tomcat-deploy created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;2、创建Ingress&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# vim ingress-tomcat.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: ingress-tomcat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    kubernetes.io/ingress.class: &amp;quot;nginx&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  rules:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - host: tomcat.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    http:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      paths:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - path: /&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        backend:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          serviceName: tomcat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          servicePort: 8080&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# kubectl apply -f ingress-tomcat.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ingress.extensions/ingress-tomcat created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/138.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# kubectl describe ingress ingress-tomcat           &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name:             ingress-tomcat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Namespace:        default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Address:          &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Default backend:  default-http-backend:80 (&amp;lt;none&amp;gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Rules:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Host               Path  Backends&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ----               ----  --------&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  tomcat.wisedu.com  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                     /   tomcat:8080 (10.244.1.21:8080,10.244.2.56:8080,10.244.3.9:8080)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl.kubernetes.io/last-applied-configuration:  &amp;#123;&amp;quot;apiVersion&amp;quot;:&amp;quot;extensions/v1beta1&amp;quot;,&amp;quot;kind&amp;quot;:&amp;quot;Ingress&amp;quot;,&amp;quot;metadata&amp;quot;:&amp;#123;&amp;quot;annotations&amp;quot;:&amp;#123;&amp;quot;kubernetes.io/ingress.class&amp;quot;:&amp;quot;nginx&amp;quot;&amp;#125;,&amp;quot;name&amp;quot;:&amp;quot;ingress-tomcat&amp;quot;,&amp;quot;namespace&amp;quot;:&amp;quot;default&amp;quot;&amp;#125;,&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;rules&amp;quot;:[&amp;#123;&amp;quot;host&amp;quot;:&amp;quot;tomcat.wisedu.com&amp;quot;,&amp;quot;http&amp;quot;:&amp;#123;&amp;quot;paths&amp;quot;:[&amp;#123;&amp;quot;backend&amp;quot;:&amp;#123;&amp;quot;serviceName&amp;quot;:&amp;quot;tomcat&amp;quot;,&amp;quot;servicePort&amp;quot;:8080&amp;#125;,&amp;quot;path&amp;quot;:&amp;quot;/&amp;quot;&amp;#125;]&amp;#125;&amp;#125;]&amp;#125;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubernetes.io/ingress.class:  nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Events:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Type    Reason  Age   From                      Message&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ----    ------  ----  ----                      -------&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Normal  CREATE  90s   nginx-ingress-controller  Ingress default/ingress-tomcat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Normal  UPDATE  31s   nginx-ingress-controller  Ingress default/ingress-tomcat&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3、配置hosts文件&lt;/strong&gt;&lt;br&gt;在要访问这个服务的客户端机器上配置hosts文件，我这里配置的是：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.17 myapp.wisedu.com tomcat.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.31 myapp.wisedu.com tomcat.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.16 myapp.wisedu.com tomcat.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.32 myapp.wisedu.com tomcat.wisedu.com&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;打开浏览器访问：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/139.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例3：HTTPS&quot;&gt;&lt;a href=&quot;#示例3：HTTPS&quot; class=&quot;headerlink&quot; title=&quot;示例3：HTTPS&quot;&gt;&lt;/a&gt;示例3：HTTPS&lt;/h3&gt;&lt;p&gt;需要证书和私钥，而这个证书和私钥我们还需要创建为特定格式才能提供给Ingress。不是说做好证书贴到Nginx的Pod里面去就可以了，需要先转成特殊格式，这个特殊的格式叫secret。它也是个标准的k8s对象。secret也是被注入到Pod中，被Pod所引用。&lt;br&gt;这里就不做CA了，直接做一个自签发的证书。&lt;/p&gt;
&lt;p&gt;1、生成私钥和自签发证书&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# openssl genrsa -out tls.key 2048&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Generating RSA private key, 2048 bit long modulus&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.......+++&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;..........................................................................................................+++&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;e is 65537 (0x10001)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# ls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ingress-myapp.yaml  ingress-tomcat.yaml  tls.key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# openssl req -new -x509 -key tls.key -out tls.crt -subj /C=CN/ST=Beijing/O=DevOps/CN=tomcat.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# ls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ingress-myapp.yaml  ingress-tomcat.yaml  tls.crt  tls.key&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;2、创建secret&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# kubectl create secret tls tomcat-ingress-secret --cert=tls.crt --key=tls.key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;secret/tomcat-ingress-secret created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# kubectl get secret&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                    TYPE                                  DATA   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;default-token-wb7fl     kubernetes.io/service-account-token   3      131d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tomcat-ingress-secret   kubernetes.io/tls                     2      8s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# kubectl describe secret tomcat-ingress-secret&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name:         tomcat-ingress-secret&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Namespace:    default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Labels:       &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Annotations:  &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Type:  kubernetes.io/tls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Data&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;====&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tls.crt:  1245 bytes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tls.key:  1675 bytes&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;3、创建Ingress，包含这个secret&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain ingress.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   tls  &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     TLS configuration. Currently the Ingress only supports a single TLS port,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     443. If multiple members of this list specify different hosts, they will be&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     multiplexed on the same port according to the hostname specified through&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the SNI TLS extension, if the ingress controller fulfilling the ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     supports SNI.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain ingress.spec.tls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   hosts        &amp;lt;[]string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Hosts are a list of hosts included in the TLS certificate. The values in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     this list must match the name/s used in the tlsSecret. Defaults to the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     wildcard host setting for the loadbalancer controller fulfilling this&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Ingress, if left unspecified.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   secretName   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     SecretName is the name of the secret used to terminate SSL traffic on 443.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Field is left optional to allow SSL routing based on SNI hostname alone. If&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the SNI host in a listener conflicts with the &amp;quot;Host&amp;quot; header field used by&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     an IngressRule, the SNI host is used for termination and value of the Host&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     header is used for routing.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;表示把哪个主机做成tls，并且用哪个secret来获取证书和私钥等相关信息。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# cp ingress-tomcat.yaml ingress-tomcat-tls.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# vim ingress-tomcat-tls.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: ingress-tomcat-tls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    kubernetes.io/ingress.class: &amp;quot;nginx&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  rules:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - host: tomcat.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    http:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      paths:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - path: /&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        backend:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          serviceName: tomcat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          servicePort: 8080&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  tls:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - hosts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - tomcat.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    secretName: tomcat-ingress-secret&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# kubectl apply -f ingress-tomcat-tls.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ingress.extensions/ingress-tomcat-tls created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# kubectl get ingress&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                 HOSTS               ADDRESS   PORTS     AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ingress-myapp        myapp.wisedu.com              80        16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ingress-tomcat       tomcat.wisedu.com             80        32m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ingress-tomcat-tls   tomcat.wisedu.com             80, 443   9s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ingress]# kubectl describe ingress ingress-tomcat-tls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name:             ingress-tomcat-tls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Namespace:        default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Address:          &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Default backend:  default-http-backend:80 (&amp;lt;none&amp;gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;TLS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  tomcat-ingress-secret terminates tomcat.wisedu.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Rules:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Host               Path  Backends&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ----               ----  --------&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  tomcat.wisedu.com  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                     /   tomcat:8080 (10.244.1.21:8080,10.244.2.56:8080,10.244.3.9:8080)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Annotations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl.kubernetes.io/last-applied-configuration:  &amp;#123;&amp;quot;apiVersion&amp;quot;:&amp;quot;extensions/v1beta1&amp;quot;,&amp;quot;kind&amp;quot;:&amp;quot;Ingress&amp;quot;,&amp;quot;metadata&amp;quot;:&amp;#123;&amp;quot;annotations&amp;quot;:&amp;#123;&amp;quot;kubernetes.io/ingress.class&amp;quot;:&amp;quot;nginx&amp;quot;&amp;#125;,&amp;quot;name&amp;quot;:&amp;quot;ingress-tomcat-tls&amp;quot;,&amp;quot;namespace&amp;quot;:&amp;quot;default&amp;quot;&amp;#125;,&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;rules&amp;quot;:[&amp;#123;&amp;quot;host&amp;quot;:&amp;quot;tomcat.wisedu.com&amp;quot;,&amp;quot;http&amp;quot;:&amp;#123;&amp;quot;paths&amp;quot;:[&amp;#123;&amp;quot;backend&amp;quot;:&amp;#123;&amp;quot;serviceName&amp;quot;:&amp;quot;tomcat&amp;quot;,&amp;quot;servicePort&amp;quot;:8080&amp;#125;,&amp;quot;path&amp;quot;:&amp;quot;/&amp;quot;&amp;#125;]&amp;#125;&amp;#125;],&amp;quot;tls&amp;quot;:[&amp;#123;&amp;quot;hosts&amp;quot;:[&amp;quot;tomcat.wisedu.com&amp;quot;],&amp;quot;secretName&amp;quot;:&amp;quot;tomcat-ingress-secret&amp;quot;&amp;#125;]&amp;#125;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubernetes.io/ingress.class:  nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Events:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Type    Reason  Age   From                      Message&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ----    ------  ----  ----                      -------&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Normal  CREATE  7s    nginx-ingress-controller  Ingress default/ingress-tomcat-tls&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;查看Nginx Ingress Controller中的配置：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -n ingress-nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                                        READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-ingress-controller-86449c74bb-bw9fv   1/1     Running   0          16h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl exec nginx-ingress-controller-86449c74bb-bw9fv -n ingress-nginx -it -- /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ cat nginx.conf | more&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/140.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;浏览器访问https：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/141.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/142.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Ingress-Controller&quot;&gt;&lt;a href=&quot;#Ingress-Controller&quot; class=&quot;headerlink&quot; title=&quot;Ingress Controller&quot;&gt;&lt;/a&gt;Ingress Controller&lt;/h2&gt;&lt;p&gt;在Kubernetes集群中，后端被代理的资源，是不配置https的，是纯明文的http，但是我们使用一个独特的调度器或者叫Pod，对这个Pod来讲，它是一个运行在用户空间的应用程序，比如Nginx、traefik、haproxy、Envoy等。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Service资源</title>
    <link href="http://yoursite.com/2019/08/19/kubernetes-Service%E8%B5%84%E6%BA%90/"/>
    <id>http://yoursite.com/2019/08/19/kubernetes-Service资源/</id>
    <published>2019-08-19T00:49:31.000Z</published>
    <updated>2019-09-22T02:27:02.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Service介绍&quot;&gt;&lt;a href=&quot;#Service介绍&quot; class=&quot;headerlink&quot; title=&quot;Service介绍&quot;&gt;&lt;/a&gt;Service介绍&lt;/h2&gt;&lt;p&gt;为了给客户端提供一个固定访问端点，因此在客户端和服务端(Pod)之间添加了一个固定的中间层，这个中间层称为service。这个service的名称解析强依赖于在k8s集群之上部署的一个附件叫k8s的DNS服务。较新版本中，使用的是CoreDNS。1.11之前的版本用的是kube-dns。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;Kubernetes要想能够向客户端提供网络功能，需要依赖于第三方的方案。在k8s新版本中可通过cni(容器网络插件标准接口)来进行接入任何遵循这种插件标准的第三方方案。&lt;br&gt;在Kubernetes集群中有三类网络：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;node network&lt;/li&gt;
&lt;li&gt;pod network&lt;/li&gt;
&lt;li&gt;service network（cluster network）：虚拟的地址，Virtual IP。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在每个节点上，有个组件叫kube-proxy。这个组件将始终监视着master上apiserver中有关service资源的变动信息。随时要连到apiserver上获取任何一个与service资源相关的资源变动状态。这种是通过Kubernetes中固有的一种请求方法叫watch来实现的。一旦有service资源的内容发生变动，包括创建、修改、删除，kube-proxy都要把它转换为当前节点之上的能够实现service资源调度到后端特定Pod资源上的规则。这种规则可能是iptables，也有可能是ipvs，取决于service的实现方式。&lt;/p&gt;
&lt;h2 id=&quot;Service工作模型&quot;&gt;&lt;a href=&quot;#Service工作模型&quot; class=&quot;headerlink&quot; title=&quot;Service工作模型&quot;&gt;&lt;/a&gt;Service工作模型&lt;/h2&gt;&lt;p&gt;service的实现方式在Kubernetes之上有三种模型。&lt;/p&gt;
&lt;h3 id=&quot;userspace模型&quot;&gt;&lt;a href=&quot;#userspace模型&quot; class=&quot;headerlink&quot; title=&quot;userspace模型&quot;&gt;&lt;/a&gt;userspace模型&lt;/h3&gt;&lt;p&gt;所谓用户空间可以理解为用户的请求。看下图。一是来自于用户内部的请求，Client Pod发请求，请求某个服务时，一定先到达当前节点内核空间的iptables规则，这个iptables规则其实就是service规则。这个service规则，它的工作方式是请求到达Service IP以后(iptables)，由service先把它转为本地监听在某个套接字上的用户空间的kube-proxy，由它来负责处理，处理完后在转给Service IP，最终代理至这个service关联的相关Pod。kube-proxy是工作在用户空间的进程。所以被称为userspace。这种方式效率很低，原因在于先要到内核空间，然后然后回到当前主机上的用户空间，由kube-proxy封装请求报文代理完以后在回到内核空间，然后有iptables规则进行分发。效率很对。因此后来就到了第2种方式。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/114.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;iptables&quot;&gt;&lt;a href=&quot;#iptables&quot; class=&quot;headerlink&quot; title=&quot;iptables&quot;&gt;&lt;/a&gt;iptables&lt;/h3&gt;&lt;p&gt;客户端IP请求service时直接请求service IP，这个请求被本地内核空间的service规则所截取，进而直接调度给相关的后端Pod。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/115.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;ipvs&quot;&gt;&lt;a href=&quot;#ipvs&quot; class=&quot;headerlink&quot; title=&quot;ipvs&quot;&gt;&lt;/a&gt;ipvs&lt;/h3&gt;&lt;p&gt;client请求到达内核空间后，直接由ipvs规则来调度。直接调度给后端的Pod。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/116.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;在安装配置Kubernetes集群时，设定service工作在什么模式下，它应该就会生成对应的模式的规则。1.1及之前的版本用的是userspace，1.1-1.10之间用的是iptables，而1.11默认使用ipvs。当然如果安装时没有激活ipvs，它会自动降级为iptables。&lt;br&gt;如果某个service背后的Pod资源发生改变了，比如Pod多了一个，这个Pod的信息会立即反应到apiserver上，apiserver会把信息更新到etcd上，kube-proxy会检测到apiserver上这个变化，并将该变化立即转为iptables规则。转换是动态的，而且是实时的。&lt;br&gt;kubernetes集群安装完成后，默认有个service的名称叫 kubernetes。集群内的各种Pod需要和Kubernetes集群的apiserver联系时都要通过这个地址联系的。&lt;/p&gt;
&lt;h2 id=&quot;Service字段解释&quot;&gt;&lt;a href=&quot;#Service字段解释&quot; class=&quot;headerlink&quot; title=&quot;Service字段解释&quot;&gt;&lt;/a&gt;Service字段解释&lt;/h2&gt;&lt;p&gt;Service简称svc。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Service is a named abstraction of software service (for example, mysql)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     consisting of local port (for example 3306) that the proxy listens on, and&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the selector that determines which pods will answer requests sent through&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the proxy.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   apiVersion   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     APIVersion defines the versioned schema of this representation of an&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     object. Servers should convert recognized schemas to the latest internal&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     value, and may reject unrecognized values. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#resources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   kind &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Kind is a string value representing the REST resource this object&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     represents. Servers may infer this from the endpoint the client submits&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     requests to. Cannot be updated. In CamelCase. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   metadata     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Standard object&amp;apos;s metadata. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Spec defines the behavior of a service.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   status       &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Most recently observed status of the service. Populated by the system.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Read-only. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;依然是这5个一级字段。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain svc.spec&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;svc.spec下有几个重要字段：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ports        &amp;lt;[]Object&amp;gt;   Service的哪个port和后端Pod的端口建立关联关系。&lt;/li&gt;
&lt;li&gt;selector     &lt;map[string]string&gt;   关联到哪些Pod资源上&lt;/map[string]string&gt;&lt;/li&gt;
&lt;li&gt;clusterIP    &lt;string&gt;  集群IP，这个IP是动态分配的。可以用这个字段定义固定地址。但是给定后，就无法修改了&lt;/string&gt;&lt;/li&gt;
&lt;li&gt;type &lt;string&gt;  service类型。如果有必要的话，要指定type。ExternalName, ClusterIP, NodePort, and LoadBalancer。Defaults to ClusterIP.&lt;ul&gt;
&lt;li&gt;ClusterIP：分配一个集群IP地址，仅用于集群内通信&lt;/li&gt;
&lt;li&gt;NodePort：接入进群外部的流量&lt;/li&gt;
&lt;li&gt;LoadBalancer：这表示把k8s部署在虚拟机上，而虚拟机是工作在云环境中，而云环境支持LBAAS，叫负载均衡级服务的一键调用，创建软负载均衡器使用的&lt;/li&gt;
&lt;li&gt;ExternalName：把集群外部的服务引入到进群内部来&lt;/li&gt;
&lt;/ul&gt;
&lt;/string&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;svc.spec.ports&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;name &lt;string&gt;  port的名称&lt;/string&gt;&lt;/li&gt;
&lt;li&gt;nodePort     &lt;integer&gt;   指定节点上的端口，这个不用定义，因为只有service的类型是NodePort时，节点端口才有用&lt;/integer&gt;&lt;/li&gt;
&lt;li&gt;port &lt;integer&gt; -required-  这个service对外提供服务的端口&lt;/integer&gt;&lt;/li&gt;
&lt;li&gt;protocol     &lt;string&gt;  不指定就是TCP&lt;/string&gt;&lt;/li&gt;
&lt;li&gt;targetPort   &lt;string&gt;  Pod的端口&lt;/string&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;Service示例&quot;&gt;&lt;a href=&quot;#Service示例&quot; class=&quot;headerlink&quot; title=&quot;Service示例&quot;&gt;&lt;/a&gt;Service示例&lt;/h2&gt;&lt;h3 id=&quot;示例1：ClusterIP类型的Service&quot;&gt;&lt;a href=&quot;#示例1：ClusterIP类型的Service&quot; class=&quot;headerlink&quot; title=&quot;示例1：ClusterIP类型的Service&quot;&gt;&lt;/a&gt;示例1：ClusterIP类型的Service&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim redis-svc.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: redis&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: redis&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    role: logstor&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  clusterIP: 10.97.97.97&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  type: ClusterIP&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - port: 6379&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    targetPort: 6379&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/117.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f redis-svc.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/redis created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   ClusterIP   10.96.0.1     &amp;lt;none&amp;gt;        443/TCP    128d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis        ClusterIP   10.97.97.97   &amp;lt;none&amp;gt;        6379/TCP   4s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl describe svc redis&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name:              redis&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Namespace:         default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Labels:            &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Annotations:       kubectl.kubernetes.io/last-applied-configuration:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                     &amp;#123;&amp;quot;apiVersion&amp;quot;:&amp;quot;v1&amp;quot;,&amp;quot;kind&amp;quot;:&amp;quot;Service&amp;quot;,&amp;quot;metadata&amp;quot;:&amp;#123;&amp;quot;annotations&amp;quot;:&amp;#123;&amp;#125;,&amp;quot;name&amp;quot;:&amp;quot;redis&amp;quot;,&amp;quot;namespace&amp;quot;:&amp;quot;default&amp;quot;&amp;#125;,&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;clusterIP&amp;quot;:&amp;quot;10.97.97.97&amp;quot;,&amp;quot;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Selector:          app=redis,role=logstor&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Type:              ClusterIP&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;IP:                10.97.97.97&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Port:              &amp;lt;unset&amp;gt;  6379/TCP&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;TargetPort:        6379/TCP&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Endpoints:         10.244.2.53:6379&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Session Affinity:  None&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Events:            &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/118.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;其实service到pod是有一个中间层的，service不会直接到pod。service是先到endpoints。endpoints也是一个标准的Kubernetes资源对象，endpoints就是地址+端口。然后再由endpoints关联至后端的Pod。只不过作为我们来讲，可以理解为是从service直接到pod。事实上我们可以手动为service创建endpoints资源。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get endpoints&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         ENDPOINTS            AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   172.16.206.32:6443   128d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis        10.244.2.53:6379     5m3s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;service创建完，只要k8s集群内的dns附件存在，那么我们就可以直接解析服务名。每个service创建，都会在集群dns中动态添加相应的资源记录。&lt;br&gt;&lt;strong&gt;资源记录: SVC_NAME.NS_NAME.DOMAIN.LTD.&lt;/strong&gt;&lt;br&gt;集群的默认域名后缀：&lt;strong&gt;svc.cluster.local.&lt;/strong&gt;    如果我们没有改这个特定域名后缀，每一个服务创建后对应的都是这种格式。比如：&lt;br&gt;        &lt;strong&gt;redis.default.svc.cluster.local.&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例2：NodePort类型的Service&quot;&gt;&lt;a href=&quot;#示例2：NodePort类型的Service&quot; class=&quot;headerlink&quot; title=&quot;示例2：NodePort类型的Service&quot;&gt;&lt;/a&gt;示例2：NodePort类型的Service&lt;/h3&gt;&lt;p&gt;字段nodePort可以不指定，但是如果指定请确保指定的每一个节点的nodePort都不能被占用。这个端口默认是动态分配的，从30000-32767之间。当然如果你确保两个节点上的80没被占用，你在清单文件中指定80也是可以的。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cp redis-svc.yaml myapp-svc.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  clusterIP: 10.99.99.99&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  type: NodePort&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - port: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    targetPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    nodePort: 30080&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/119.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f myapp-svc.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/myapp created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   ClusterIP   10.96.0.1     &amp;lt;none&amp;gt;        443/TCP        128d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp        NodePort    10.99.99.99   &amp;lt;none&amp;gt;        80:30080/TCP   4s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis        ClusterIP   10.97.97.97   &amp;lt;none&amp;gt;        6379/TCP       12m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Service的80端口映射到节点的30080端口。&lt;br&gt;集群外通过节点IP和PORT访问服务：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# while true; do curl http://172.16.206.32:30080/hostname.html; sleep 1; done&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-xzgdl&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-ff9xf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-wls6h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-msv5x&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-ff9xf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-ff9xf&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例3：LoadBalancer类型的service&quot;&gt;&lt;a href=&quot;#示例3：LoadBalancer类型的service&quot; class=&quot;headerlink&quot; title=&quot;示例3：LoadBalancer类型的service&quot;&gt;&lt;/a&gt;示例3：LoadBalancer类型的service&lt;/h3&gt;&lt;p&gt;假如你在阿里云上买了4个虚拟机，同时也买了LB服务LBAAS。在这4个虚拟主机上部署k8s集群，这个k8s集群可以与底层的公有云IaaS的api做交互，k8s具有这样的能力。调的时候能够去请求创建1个外置的负载均衡器。1个master，3个node。3个node上都使用同一个nodePort对外输出服务，它会自动请求底层IaaS的api，用纯软件的方式做一个负载均衡器，并且为这个负载均衡器提供的配置信息是这3个节点的节点端口上提供的服务。这样外部客户在访问时直接访问LBAAS，由它来调度到3个nodePort上。nodePort先代理给service，由service在集群内部负载均衡至Pod。OpenStack也支持LBAAS。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/120.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例4：ExternalName类型的service&quot;&gt;&lt;a href=&quot;#示例4：ExternalName类型的service&quot; class=&quot;headerlink&quot; title=&quot;示例4：ExternalName类型的service&quot;&gt;&lt;/a&gt;示例4：ExternalName类型的service&lt;/h3&gt;&lt;p&gt;集群中建立的Service的endpoints不是集群内的Pod，而是集群外的服务。&lt;/p&gt;
&lt;h2 id=&quot;Service会话绑定&quot;&gt;&lt;a href=&quot;#Service会话绑定&quot; class=&quot;headerlink&quot; title=&quot;Service会话绑定&quot;&gt;&lt;/a&gt;Service会话绑定&lt;/h2&gt;&lt;p&gt;service在实现负载均衡时还支持 sessionAffinity。默认是None，不做会话绑定。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sessionAffinity      &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Supports &amp;quot;ClientIP&amp;quot; and &amp;quot;None&amp;quot;. Used to maintain session affinity. Enable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  client IP based session affinity. Must be ClientIP or None. Defaults to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  None. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  https://kubernetes.io/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/121.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl patch svc myapp -p &amp;apos;&amp;#123;&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;sessionAffinity&amp;quot;:&amp;quot;ClientIP&amp;quot;&amp;#125;&amp;#125;&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/myapp patched&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/122.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/123.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;headless-Service&quot;&gt;&lt;a href=&quot;#headless-Service&quot; class=&quot;headerlink&quot; title=&quot;headless Service&quot;&gt;&lt;/a&gt;headless Service&lt;/h2&gt;&lt;p&gt;Pod也是有名称的，Pod的主机名就是Pod的名称。所谓无头，就是去掉service对应的clusterIP，解析service时解析到后端Pod的IP。这种service就叫headless service。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl exec myapp-deploy-67b6dfcd8-ff9xf -it -- cat /etc/hosts&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Kubernetes-managed hosts file.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;127.0.0.1       localhost&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;::1     localhost ip6-localhost ip6-loopback&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;fe00::0 ip6-localnet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;fe00::0 ip6-mcastprefix&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;fe00::1 ip6-allnodes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;fe00::2 ip6-allrouters&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10.244.1.19     myapp-deploy-67b6dfcd8-ff9xf&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   clusterIP    &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     clusterIP is the IP address of the service and is usually assigned randomly&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     by the master. If an address is specified manually and is not in use by&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     others, it will be allocated to the service; otherwise, creation of the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     service will fail. This field can not be changed through updates. Valid&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     values are &amp;quot;None&amp;quot;, empty string (&amp;quot;&amp;quot;), or a valid IP address. &amp;quot;None&amp;quot; can be&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     specified for headless services when proxying is not required. Only applies&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     to types ClusterIP, NodePort, and LoadBalancer. Ignored if type is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ExternalName. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;Valid values are “None”, empty string (“”), or a valid IP address. “None” can be specified for headless services when proxying is not required. &lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cp myapp-svc.yaml myapp-svc-headless.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim myapp-svc-headless.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: myapp-svc-headless&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  clusterIP: None&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - port: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    targetPort: 80&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f myapp-svc-headless.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/myapp-svc-headless created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes           ClusterIP   10.96.0.1     &amp;lt;none&amp;gt;        443/TCP        128d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp                NodePort    10.99.99.99   &amp;lt;none&amp;gt;        80:30080/TCP   37m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-svc-headless   ClusterIP   None          &amp;lt;none&amp;gt;        80/TCP         28s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis                ClusterIP   10.97.97.97   &amp;lt;none&amp;gt;        6379/TCP       50m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;看看解析情况：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# dig -t A myapp-svc-headless.default.svc.cluster.local. @10.96.0.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;; &amp;lt;&amp;lt;&amp;gt;&amp;gt; DiG 9.9.4-RedHat-9.9.4-29.el7 &amp;lt;&amp;lt;&amp;gt;&amp;gt; -t A myapp-svc-headless.default.svc.cluster.local. @10.96.0.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; global options: +cmd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; Got answer:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; -&amp;gt;&amp;gt;HEADER&amp;lt;&amp;lt;- opcode: QUERY, status: NOERROR, id: 63409&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; flags: qr aa rd; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; WARNING: recursion requested but not available&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; OPT PSEUDOSECTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;; EDNS: version: 0, flags:; udp: 4096&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; QUESTION SECTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;myapp-svc-headless.default.svc.cluster.local. IN A&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; ANSWER SECTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-svc-headless.default.svc.cluster.local. 5 IN A 10.244.3.7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-svc-headless.default.svc.cluster.local. 5 IN A 10.244.2.45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-svc-headless.default.svc.cluster.local. 5 IN A 10.244.1.19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-svc-headless.default.svc.cluster.local. 5 IN A 10.244.1.18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-svc-headless.default.svc.cluster.local. 5 IN A 10.244.2.46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; Query time: 0 msec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; SERVER: 10.96.0.10#53(10.96.0.10)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; WHEN: Mon Aug 19 11:14:20 CST 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; MSG SIZE  rcvd: 373&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;直接解析到了Pod的地址。看看此前创建的Service myapp的解析：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# dig -t A myapp.default.svc.cluster.local. @10.96.0.10             &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;; &amp;lt;&amp;lt;&amp;gt;&amp;gt; DiG 9.9.4-RedHat-9.9.4-29.el7 &amp;lt;&amp;lt;&amp;gt;&amp;gt; -t A myapp.default.svc.cluster.local. @10.96.0.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; global options: +cmd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; Got answer:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; -&amp;gt;&amp;gt;HEADER&amp;lt;&amp;lt;- opcode: QUERY, status: NOERROR, id: 9086&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; WARNING: recursion requested but not available&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; OPT PSEUDOSECTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;; EDNS: version: 0, flags:; udp: 4096&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; QUESTION SECTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;myapp.default.svc.cluster.local. IN    A&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; ANSWER SECTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp.default.svc.cluster.local. 5 IN   A       10.99.99.99&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; Query time: 0 msec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; SERVER: 10.96.0.10#53(10.96.0.10)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; WHEN: Mon Aug 19 11:15:06 CST 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; MSG SIZE  rcvd: 107&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;它就是解析到了Service的IP。&lt;br&gt;@10.96.0.10表示不使用本地的dns解析，10.96.0.10是集群CoreDNS的地址。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get svc -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-dns   ClusterIP   10.96.0.10   &amp;lt;none&amp;gt;        53/UDP,53/TCP,9153/TCP   128d&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;StatefulSet用到的就是headless Service。&lt;/p&gt;
&lt;h2 id=&quot;Service的问题&quot;&gt;&lt;a href=&quot;#Service的问题&quot; class=&quot;headerlink&quot; title=&quot;Service的问题&quot;&gt;&lt;/a&gt;Service的问题&lt;/h2&gt;&lt;p&gt;service有个问题，通过nodePort访问时需要做两次转换，另外无论是iptables还是ipvs，都是四层调度。因此如果我们要建一个https服务的话，每一个myapp都得配置为https的主机，因为四层调度是没有办法卸载https会话的。Kubernetes还有一种引入集群外部流量的方式。叫Ingress。&lt;br&gt;Ingress资源是一种七层调度器，因为它利用一种七层Pod来实现将外部流量引入到内部来。事实上它也脱离不了service的工作。可用的解决方法有Nginx、Haproxy等。还有Traefik。&lt;br&gt;k8s之上调度用的更多的还是Nginx。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Service介绍&quot;&gt;&lt;a href=&quot;#Service介绍&quot; class=&quot;headerlink&quot; title=&quot;Service介绍&quot;&gt;&lt;/a&gt;Service介绍&lt;/h2&gt;&lt;p&gt;为了给客户端提供一个固定访问端点，因此在客户端和服务端(Pod)之间添加了一个固定的中间层，这个中间层称为service。这个service的名称解析强依赖于在k8s集群之上部署的一个附件叫k8s的DNS服务。较新版本中，使用的是CoreDNS。1.11之前的版本用的是kube-dns。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Pod控制器-Deployment、DaemonSet</title>
    <link href="http://yoursite.com/2019/08/14/Kubernetes-Pod%E6%8E%A7%E5%88%B6%E5%99%A8-Deployment%E3%80%81DaemonSet/"/>
    <id>http://yoursite.com/2019/08/14/Kubernetes-Pod控制器-Deployment、DaemonSet/</id>
    <published>2019-08-14T05:18:01.000Z</published>
    <updated>2019-08-16T08:04:05.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Deployment&quot;&gt;&lt;a href=&quot;#Deployment&quot; class=&quot;headerlink&quot; title=&quot;Deployment&quot;&gt;&lt;/a&gt;Deployment&lt;/h2&gt;&lt;p&gt;简称deploy。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DEPRECATED - This group version of Deployment is deprecated by&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     apps/v1beta2/Deployment. See the release notes for more information.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Deployment enables declarative updates for Pods and ReplicaSets.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   apiVersion   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     APIVersion defines the versioned schema of this representation of an&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     object. Servers should convert recognized schemas to the latest internal&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     value, and may reject unrecognized values. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#resources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   kind &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Kind is a string value representing the REST resource this object&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     represents. Servers may infer this from the endpoint the client submits&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     requests to. Cannot be updated. In CamelCase. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   metadata     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Standard object metadata.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Specification of the desired behavior of the Deployment.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   status       &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Most recently observed status of the Deployment.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;一级字段依然是5个。其中，version最新的是apps/v1，文档里显示的版本是落后的。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain deploy.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Specification of the desired behavior of the Deployment.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DeploymentSpec is the specification of the desired behavior of the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Deployment.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   minReadySeconds      &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Minimum number of seconds for which a newly created pod should be ready&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     without any of its container crashing, for it to be considered available.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Defaults to 0 (pod will be considered available as soon as it is ready)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   paused       &amp;lt;boolean&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Indicates that the deployment is paused and will not be processed by the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     deployment controller.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   progressDeadlineSeconds      &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The maximum time in seconds for a deployment to make progress before it is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     considered to be failed. The deployment controller will continue to process&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     failed deployments and a condition with a ProgressDeadlineExceeded reason&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     will be surfaced in the deployment status. Note that progress will not be&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     estimated during the time a deployment is paused. This is set to the max&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     value of int32 (i.e. 2147483647) by default, which means &amp;quot;no deadline&amp;quot;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   replicas     &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Number of desired pods. This is a pointer to distinguish between explicit&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     zero and not specified. Defaults to 1.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   revisionHistoryLimit &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The number of old ReplicaSets to retain to allow rollback. This is a&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     pointer to distinguish between explicit zero and not specified. This is set&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     to the max value of int32 (i.e. 2147483647) by default, which means&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &amp;quot;retaining all old RelicaSets&amp;quot;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   rollbackTo   &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DEPRECATED. The config this deployment is rolling back to. Will be cleared&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     after rollback is done.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   selector     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Label selector for pods. Existing ReplicaSets whose pods are selected by&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     this will be the ones affected by this deployment.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   strategy     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The deployment strategy to use to replace existing pods with new ones.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   template     &amp;lt;Object&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Template describes the pods that will be created.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;deploy.spec下可定义的字段比rs.spec的要多。其中最重要的一个字段是 &lt;strong&gt;strategy&lt;/strong&gt;。这个字段用来定义更新策略，滚动更新只是其中的一个策略。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain deploy.spec.strategy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: strategy &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The deployment strategy to use to replace existing pods with new ones.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DeploymentStrategy describes how to replace existing pods with new ones.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   rollingUpdate        &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Rolling update config params. Present only if DeploymentStrategyType =&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RollingUpdate.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   type &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Type of deployment. Can be &amp;quot;Recreate&amp;quot; or &amp;quot;RollingUpdate&amp;quot;. Default is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RollingUpdate.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;type：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Recreate：你删除一个Pod，它就创建1个新的Pod。&lt;/li&gt;
&lt;li&gt;RollingUpdate：滚动更新。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果清单文件中定义type的值为RollingUpdate，还可以使用rollingUpdate来定义滚动更新的更新方式的。说白了就是控制更新粒度。比如在更新期间，Pod最多能比清单中定义的期望状态多几个，能少几个。如果type是Recreate，rollingUpdate这个字段就没有用了&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain deploy.spec.strategy.rollingUpdate&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: rollingUpdate &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Rolling update config params. Present only if DeploymentStrategyType =&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RollingUpdate.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Spec to control the desired behavior of rolling update.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   maxSurge     &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The maximum number of pods that can be scheduled above the desired number&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     of pods. Value can be an absolute number (ex: 5) or a percentage of desired&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     pods (ex: 10%). This can not be 0 if MaxUnavailable is 0. Absolute number&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     is calculated from percentage by rounding up. By default, a value of 1 is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     used. Example: when this is set to 30%, the new RC can be scaled up&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     immediately when the rolling update starts, such that the total number of&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     old and new pods do not exceed 130% of desired pods. Once old pods have&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     been killed, new RC can be scaled up further, ensuring that total number of&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     pods running at any time during the update is at most 130% of desired pods.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   maxUnavailable       &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The maximum number of pods that can be unavailable during the update. Value&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     can be an absolute number (ex: 5) or a percentage of desired pods (ex:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     10%). Absolute number is calculated from percentage by rounding down. This&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     can not be 0 if MaxSurge is 0. By default, a fixed value of 1 is used.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Example: when this is set to 30%, the old RC can be scaled down to 70% of&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     desired pods immediately when the rolling update starts. Once new pods are&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ready, old RC can be scaled down further, followed by scaling up the new&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RC, ensuring that the total number of pods available at all times during&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the update is at least 70% of desired pods.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;rollingUpdate可定义两个字段，maxSurge和maxUnavailable。这两个值不能同时为0，可以同时为正，或者一个为正，一个为0。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;maxSurge: 能多出期望Pod数量几个，可以直接使用数字，或百分比。&lt;/li&gt;
&lt;li&gt;maxUnavailable: 最多比期望Pod数量少几个，可以使用数字或百分比。比如该值定义为1，期望为5，那么至少要保证有4个Pod可用。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;再看看deploy.spec比rs.spec中多的几个其他字段：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;revisionHistoryLimit &lt;integer&gt;&lt;br&gt;做滚动更新后，最多在历史中保存过去多少个历史版本。默认是10个。&lt;/integer&gt;&lt;/li&gt;
&lt;li&gt;paused       &lt;boolean&gt;&lt;br&gt;当启动更新后，没有立即更新，而是一启动就让它暂停了。一般而言默认都是不暂停的，上来就更新。&lt;/boolean&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;Deploy示例&quot;&gt;&lt;a href=&quot;#Deploy示例&quot; class=&quot;headerlink&quot; title=&quot;Deploy示例&quot;&gt;&lt;/a&gt;Deploy示例&lt;/h2&gt;&lt;h3 id=&quot;示例1：声明式创建deploy&quot;&gt;&lt;a href=&quot;#示例1：声明式创建deploy&quot; class=&quot;headerlink&quot; title=&quot;示例1：声明式创建deploy&quot;&gt;&lt;/a&gt;示例1：声明式创建deploy&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim deploy-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: myapp-deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  replicas: 2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    matchLabels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  template:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f deploy-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/myapp-deploy created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/100.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/101.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例2：更新&quot;&gt;&lt;a href=&quot;#示例2：更新&quot; class=&quot;headerlink&quot; title=&quot;示例2：更新&quot;&gt;&lt;/a&gt;示例2：更新&lt;/h3&gt;&lt;p&gt;deploy在实现更新应用时，可以直接通过编辑清单文件来实现或者patch打补丁(使用JSON格式给定补丁信息)实现，比如从副本数从2个改成3个。默认是滚动更新，见下图。如果只是更新镜像文件的，可以使用kubectl set image。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/102.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;通过编辑清单文件更新&quot;&gt;&lt;a href=&quot;#通过编辑清单文件更新&quot; class=&quot;headerlink&quot; title=&quot;通过编辑清单文件更新&quot;&gt;&lt;/a&gt;通过编辑清单文件更新&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim deploy-demo.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/103.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f deploy-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/myapp-deploy configured&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-knspq   1/1     Running   0          12m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-qz9kc   1/1     Running   0          5s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-xkgpt   1/1     Running   0          12m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;已经变成3个Pod了。67b6dfcd8这个值依然没变，因为我们没有修改模板。&lt;br&gt;apply可以执行多次，它可以把变化同步到apiserver，apiserver发现与etcd中不一致，从而改变etcd，从而实现修改期望状态，接下来让现有状态不断逼近期望状态。&lt;/p&gt;
&lt;h4 id=&quot;跟踪滚动更新效果&quot;&gt;&lt;a href=&quot;#跟踪滚动更新效果&quot; class=&quot;headerlink&quot; title=&quot;跟踪滚动更新效果&quot;&gt;&lt;/a&gt;跟踪滚动更新效果&lt;/h4&gt;&lt;p&gt;在一个终端上，执行如下命令进行监控：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l app=myapp -w&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;打开另一个终端，编辑清单文件来更新：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim deploy-demo.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/104.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;更新：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f deploy-demo.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;接着查看第一个终端：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/105.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;查看rs：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get rs -o wide&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/106.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;通过patch打补丁更新&quot;&gt;&lt;a href=&quot;#通过patch打补丁更新&quot; class=&quot;headerlink&quot; title=&quot;通过patch打补丁更新&quot;&gt;&lt;/a&gt;通过patch打补丁更新&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl patch --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Update field(s) of a resource using strategic merge patch, a JSON merge patch, or a JSON patch.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; JSON and YAML formats are accepted.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Partially update a node using a strategic merge patch. Specify the patch as JSON.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl patch node k8s-node-1 -p &amp;apos;&amp;#123;&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;unschedulable&amp;quot;:true&amp;#125;&amp;#125;&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Partially update a node using a strategic merge patch. Specify the patch as YAML.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl patch node k8s-node-1 -p $&amp;apos;spec:\n unschedulable: true&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Partially update a node identified by the type and name specified in &amp;quot;node.json&amp;quot; using strategic merge patch.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl patch -f node.json -p &amp;apos;&amp;#123;&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;unschedulable&amp;quot;:true&amp;#125;&amp;#125;&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Update a container&amp;apos;s image; spec.containers[*].name is required because it&amp;apos;s a merge key.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl patch pod valid-pod -p &amp;apos;&amp;#123;&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;containers&amp;quot;:[&amp;#123;&amp;quot;name&amp;quot;:&amp;quot;kubernetes-serve-hostname&amp;quot;,&amp;quot;image&amp;quot;:&amp;quot;new image&amp;quot;&amp;#125;]&amp;#125;&amp;#125;&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Update a container&amp;apos;s image using a json patch with positional arrays.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl patch pod valid-pod --type=&amp;apos;json&amp;apos; -p=&amp;apos;[&amp;#123;&amp;quot;op&amp;quot;: &amp;quot;replace&amp;quot;, &amp;quot;path&amp;quot;: &amp;quot;/spec/containers/0/image&amp;quot;, &amp;quot;value&amp;quot;:&amp;quot;new&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;image&amp;quot;&amp;#125;]&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Options:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --allow-missing-template-keys=true: If true, ignore any errors in templates when a field or map key is missing in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the template. Only applies to golang and jsonpath output formats.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --dry-run=false: If true, only print the object that would be sent, without sending it.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -f, --filename=[]: Filename, directory, or URL to files identifying the resource to update&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -k, --kustomize=&amp;apos;&amp;apos;: Process the kustomization directory. This flag can&amp;apos;t be used together with -f or -R.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --local=false: If true, patch will operate on the content of the file, not the server-side resource.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -o, --output=&amp;apos;&amp;apos;: Output format. One of:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;json|yaml|name|go-template|go-template-file|template|templatefile|jsonpath|jsonpath-file.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -p, --patch=&amp;apos;&amp;apos;: The patch to be applied to the resource JSON file.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --record=false: Record current kubectl command in the resource annotation. If set to false, do not record the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;command. If set to true, record the command. If not set, default to updating the existing annotation value only if one&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;already exists.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -R, --recursive=false: Process the directory used in -f, --filename recursively. Useful when you want to manage&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;related manifests organized within the same directory.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --template=&amp;apos;&amp;apos;: Template string or path to template file to use when -o=go-template, -o=go-template-file. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;template format is golang templates [http://golang.org/pkg/text/template/#pkg-overview].&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --type=&amp;apos;strategic&amp;apos;: The type of patch being provided; one of [json merge strategic]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl patch (-f FILENAME | TYPE NAME) -p PATCH [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl options&amp;quot; for a list of global command-line options (applies to all commands).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;patch写结构定义很繁琐，不如vim修改清单文件，apply -f运行即可。但是这样会修改原有的清单文件，有些时候我们也许只是临时测试，修改文件不妥当。&lt;br&gt;【示例】：修改Pod副本数为5&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl patch deploy myapp-deploy -p &amp;apos;&amp;#123;&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;replicas&amp;quot;:5&amp;#125;&amp;#125;&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp-deploy patched&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                            READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-4pnr7   1/1     Running   0          3h16m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-6vz48   1/1     Running   0          3h16m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-nkm4z   1/1     Running   0          7s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-sjpmm   1/1     Running   0          3h16m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-w729d   1/1     Running   0          7s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Pod已经变为5个了。&lt;/p&gt;
&lt;p&gt;【示例】：修改滚动更新策略&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl patch deploy myapp-deploy -p &amp;apos;&amp;#123;&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;strategy&amp;quot;:&amp;#123;&amp;quot;rollingUpdate&amp;quot;:&amp;#123;&amp;quot;maxSurge&amp;quot;:1,&amp;quot;maxUnavailable&amp;quot;:0&amp;#125;&amp;#125;&amp;#125;&amp;#125;&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp-deploy patched&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/107.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;kubectl-set-image更新&quot;&gt;&lt;a href=&quot;#kubectl-set-image更新&quot; class=&quot;headerlink&quot; title=&quot;kubectl set image更新&quot;&gt;&lt;/a&gt;kubectl set image更新&lt;/h4&gt;&lt;p&gt;如果只是更新镜像文件的，可以使用kubectl set image。&lt;br&gt;在一个终端上，执行如下命令进行监控：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l app=myapp -w&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;打开另一个终端，使用kubectl set image来更新镜像文件：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/108.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/109.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/110.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;下面恢复更新：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout resume deploy myapp-deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp-deploy resumed&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/111.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/112.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;回滚&quot;&gt;&lt;a href=&quot;#回滚&quot; class=&quot;headerlink&quot; title=&quot;回滚&quot;&gt;&lt;/a&gt;回滚&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Manage the rollout of a resource.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Valid resource types include:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  *  deployments&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  *  daemonsets&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  *  statefulsets&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Rollback to the previous deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl rollout undo deployment/abc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Check the rollout status of a daemonset&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl rollout status daemonset/foo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Available Commands:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  history     View rollout history&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  pause       Mark the provided resource as paused&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  resume      Resume a paused resource&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  status      Show the status of the rollout&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  undo        Undo a previous rollout&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl rollout SUBCOMMAND [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl &amp;lt;command&amp;gt; --help&amp;quot; for more information about a given command.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl options&amp;quot; for a list of global command-line options (applies to all commands).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其中，子命令undo表示回滚。status查看更新历史。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;回滚，默认是回滚到上一个版本，可以指定回滚到某一版本。&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout undo --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Rollback to a previous rollout.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Rollback to the previous deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl rollout undo deployment/abc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Rollback to daemonset revision 3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl rollout undo daemonset/abc --to-revision=3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Rollback to the previous deployment with dry-run&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl rollout undo --dry-run=true deployment/abc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Options:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --allow-missing-template-keys=true: If true, ignore any errors in templates when a field or map key is missing in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the template. Only applies to golang and jsonpath output formats.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --dry-run=false: If true, only print the object that would be sent, without sending it.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -f, --filename=[]: Filename, directory, or URL to files identifying the resource to get from a server.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -k, --kustomize=&amp;apos;&amp;apos;: Process the kustomization directory. This flag can&amp;apos;t be used together with -f or -R.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -o, --output=&amp;apos;&amp;apos;: Output format. One of:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;json|yaml|name|go-template|go-template-file|template|templatefile|jsonpath|jsonpath-file.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -R, --recursive=false: Process the directory used in -f, --filename recursively. Useful when you want to manage&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;related manifests organized within the same directory.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --template=&amp;apos;&amp;apos;: Template string or path to template file to use when -o=go-template, -o=go-template-file. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;template format is golang templates [http://golang.org/pkg/text/template/#pkg-overview].&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --to-revision=0: The revision to rollback to. Default to 0 (last revision).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl rollout undo (TYPE NAME | TYPE/NAME) [flags] [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl options&amp;quot; for a list of global command-line options (applies to all commands).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout history deploy myapp-deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp-deploy &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;REVISION  CHANGE-CAUSE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1         &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2         &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3         &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;比如，回滚到第一个版本：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout undo deploy myapp-deploy --to-revision=1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp-deploy rolled back&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此时，在查看更新历史时，第1版已经没有，变成了第4版：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout history deploy myapp-deploy  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp-deploy &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;REVISION  CHANGE-CAUSE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2         &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3         &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4         &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看当前工作pod中镜像是第几个版本：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get rs -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                      DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES                 SELECTOR&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5   0         0         0       3h43m   myapp        ikubernetes/myapp:v2   app=myapp,pod-template-hash=675558bfc5,release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8    5         5         5       4h      myapp        ikubernetes/myapp:v1   app=myapp,pod-template-hash=67b6dfcd8,release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-7f577979c8   0         0         0       15m     myapp        ikubernetes/myapp:v3   app=myapp,pod-template-hash=7f577979c8,release=canary&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;由此可见，Deployment可以对无状态的应用做到如此的灵活和简单。&lt;/p&gt;
&lt;h2 id=&quot;DaemonSet&quot;&gt;&lt;a href=&quot;#DaemonSet&quot; class=&quot;headerlink&quot; title=&quot;DaemonSet&quot;&gt;&lt;/a&gt;DaemonSet&lt;/h2&gt;&lt;p&gt;简称ds，主要作用在集群上符合条件的每个节点上只运行某个指定Pod，并且只运行1个副本。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain ds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     DaemonSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DEPRECATED - This group version of DaemonSet is deprecated by&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     apps/v1beta2/DaemonSet. See the release notes for more information.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DaemonSet represents the configuration of a daemon set.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   apiVersion   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     APIVersion defines the versioned schema of this representation of an&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     object. Servers should convert recognized schemas to the latest internal&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     value, and may reject unrecognized values. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#resources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   kind &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Kind is a string value representing the REST resource this object&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     represents. Servers may infer this from the endpoint the client submits&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     requests to. Cannot be updated. In CamelCase. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   metadata     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Standard object&amp;apos;s metadata. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The desired behavior of this daemon set. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   status       &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The current status of this daemon set. This data may be out of date by some&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     window of time. Populated by the system. Read-only. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;一级字段依然是这5个。但是ds.spec中没有replicas字段了，因为符合条件的每个节点上只运行1个Pod。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain ds.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     DaemonSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The desired behavior of this daemon set. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DaemonSetSpec is the specification of a daemon set.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   minReadySeconds      &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The minimum number of seconds for which a newly created DaemonSet pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     should be ready without any of its container crashing, for it to be&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     considered available. Defaults to 0 (pod will be considered available as&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     soon as it is ready).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   revisionHistoryLimit &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The number of old history to retain to allow rollback. This is a pointer to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     distinguish between explicit zero and not specified. Defaults to 10.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   selector     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     A label query over pods that are managed by the daemon set. Must match in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     order to be controlled. If empty, defaulted to labels on Pod template. More&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#label-selectors&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   template     &amp;lt;Object&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     An object that describes the pod that will be created. The DaemonSet will&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     create exactly one copy of this pod on every node that matches the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     template&amp;apos;s node selector (or on every node if no node selector is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     specified). More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller#pod-template&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   templateGeneration   &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DEPRECATED. A sequence number representing a specific generation of the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     template. Populated by the system. It can be set only during the creation.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   updateStrategy       &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     An update strategy to replace existing DaemonSet pods with new pods.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;DaemonSet示例&quot;&gt;&lt;a href=&quot;#DaemonSet示例&quot; class=&quot;headerlink&quot; title=&quot;DaemonSet示例&quot;&gt;&lt;/a&gt;DaemonSet示例&lt;/h2&gt;&lt;p&gt;使用一个事先做好了的镜像filebeat，这个镜像在使用时要给两个变量：redis主机地址和redis日志级别。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cp deploy-demo.yaml ds-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim ds-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: redis&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  replicas: 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    matchLabels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      app: redis&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      role: logstor&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  template:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        app: redis&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        role: logstor&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - name: redis&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        image: redis:4.0-alpine&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - name: redis&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          containerPort: 6379&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;---&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: redis&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: redis&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    role: logstor&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: tcp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    port: 6379&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    targetPort: 6379&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;--- &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: DaemonSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: filebeat-ds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    matchLabels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      app: filebeat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      release: stable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  template:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        app: filebeat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        release: stable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - name: filebeat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        image: ikubernetes/filebeat:5.6.5-alpine&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        env:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - name: REDIS_HOST&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          value: redis.default.svc.cluster.local&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - name: REDIS_LOG_LEVEL&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          value: info&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f ds-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/redis created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/redis created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps/filebeat-ds created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;filebeat-ds-2l7vw              1/1     Running   0          97s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;filebeat-ds-fqdmh              1/1     Running   0          97s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;filebeat-ds-ql5kc              1/1     Running   0          97s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-ff9xf   1/1     Running   0          35m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-msv5x   1/1     Running   0          35m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-rp9vj   1/1     Running   0          35m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-wls6h   1/1     Running   0          35m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-xzgdl   1/1     Running   0          35m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis-58b9f5776-tsks5          1/1     Running   0          3m59s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   ClusterIP   10.96.0.1        &amp;lt;none&amp;gt;        443/TCP    125d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis        ClusterIP   10.101.223.105   &amp;lt;none&amp;gt;        6379/TCP   6m16s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;【说明】：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;master上不会运行这个pod。除非指定Pod能够容忍master上的污点，master上才会也启动一个Pod。&lt;/li&gt;
&lt;li&gt;启动一个redis pod，然后在default命名空间定义一个服务叫redis，这样filebeat就会连上那个redis服务了。&lt;/li&gt;
&lt;li&gt;在一个清单文件中可定义多个资源，把有关联的资源定义在一起。用 — 分割。&lt;/li&gt;
&lt;li&gt;redis应该用StatefulSet来运行，我这里只运行1个，使用Deployment是没问题的，但是别扩展规模，只运行1个。对于redis来讲，还应该使用存储卷，后面的内容会讲，这里先不做了。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;DaemonSet滚动更新&quot;&gt;&lt;a href=&quot;#DaemonSet滚动更新&quot; class=&quot;headerlink&quot; title=&quot;DaemonSet滚动更新&quot;&gt;&lt;/a&gt;DaemonSet滚动更新&lt;/h2&gt;&lt;p&gt;DaemonSet也支持滚动更新。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ kubectl explain ds.spec&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;有个字段：updateStrategy &lt;object&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain ds.spec.updateStrategy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     DaemonSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: updateStrategy &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     An update strategy to replace existing DaemonSet pods with new pods.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   rollingUpdate        &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Rolling update config params. Present only if type = &amp;quot;RollingUpdate&amp;quot;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   type &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Type of daemon set update. Can be &amp;quot;RollingUpdate&amp;quot; or &amp;quot;OnDelete&amp;quot;. Default is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     OnDelete.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/object&gt;&lt;/p&gt;
&lt;p&gt;默认是是OnDelete。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain ds.spec.updateStrategy.rollingUpdate&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     DaemonSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: rollingUpdate &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Rolling update config params. Present only if type = &amp;quot;RollingUpdate&amp;quot;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Spec to control the desired behavior of daemon set rolling update.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   maxUnavailable       &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The maximum number of DaemonSet pods that can be unavailable during the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     update. Value can be an absolute number (ex: 5) or a percentage of total&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     number of DaemonSet pods at the start of the update (ex: 10%). Absolute&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     number is calculated from percentage by rounding up. This cannot be 0.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Default value is 1. Example: when this is set to 30%, at most 30% of the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     total number of nodes that should be running the daemon pod (i.e.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     status.desiredNumberScheduled) can have their pods stopped for an update at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     any given time. The update starts by stopping at most 30% of those&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DaemonSet pods and then brings up new DaemonSet pods in their place. Once&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the new pods are available, it then proceeds onto other DaemonSet pods,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     thus ensuring that at least 70% of original number of DaemonSet pods are&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     available at all times during the update.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;DaemonSet的滚动更新字段没有maxSurge。&lt;br&gt;【注意】：只能先删除在更新。因为一个节点只能运行一个，假如现在3个节点，你要运行4个，第4个运行到哪去。没有可能性，不支持1个节点上运行两个。所以只能是先删除1个，在更新1个。当然也可以一次删除多个。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/113.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Deployment&quot;&gt;&lt;a href=&quot;#Deployment&quot; class=&quot;headerlink&quot; title=&quot;Deployment&quot;&gt;&lt;/a&gt;Deployment&lt;/h2&gt;&lt;p&gt;简称deploy。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Pod控制器——ReplicaSet</title>
    <link href="http://yoursite.com/2019/08/12/Kubernetes-Pod%E6%8E%A7%E5%88%B6%E5%99%A8%E2%80%94%E2%80%94ReplicaSet/"/>
    <id>http://yoursite.com/2019/08/12/Kubernetes-Pod控制器——ReplicaSet/</id>
    <published>2019-08-12T01:23:02.000Z</published>
    <updated>2019-08-12T05:38:41.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Pod控制器&quot;&gt;&lt;a href=&quot;#Pod控制器&quot; class=&quot;headerlink&quot; title=&quot;Pod控制器&quot;&gt;&lt;/a&gt;Pod控制器&lt;/h2&gt;&lt;h3 id=&quot;Pod控制器介绍&quot;&gt;&lt;a href=&quot;#Pod控制器介绍&quot; class=&quot;headerlink&quot; title=&quot;Pod控制器介绍&quot;&gt;&lt;/a&gt;Pod控制器介绍&lt;/h3&gt;&lt;p&gt;此前使用配置清单创建Pod，都是在配置文件中定义要创建的Pod具体是什么。而后就提交给apiserver，由apiserver转交给Scheduler完成调度，由目标节点予以创建并启动相关的Pod资源。如果我们把Pod资源意外删除，Pod不会重建。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;在实际应用中，去管理Pod资源时很少用自主式Pod方式。之所以介绍自主式Pod，是为了讲清楚Pod是怎么创建的，而后面介绍的控制器创建Pod时，都是内嵌了Pod模板的。也就是将此前手动管理的Pod资源的定义方式内嵌到控制器的定义结构中去。&lt;br&gt;Pod控制器是用于实现代我们去管理Pod的中间层，并帮我们确保每一个Pod资源始终处于我们所定义或者所期望的目标状态。万一这个Pod资源出现故障，首先它会尝试着去重启容器，如果一直重启有问题的话，那么可能会基于某种策略来重新委派。如果Pod的副本数量低于用户所定义的目标数量，它也会自动补全。&lt;/p&gt;
&lt;h3 id=&quot;Pod控制器分类&quot;&gt;&lt;a href=&quot;#Pod控制器分类&quot; class=&quot;headerlink&quot; title=&quot;Pod控制器分类&quot;&gt;&lt;/a&gt;Pod控制器分类&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;ReplicationController:&lt;/strong&gt; 最早k8s只有这一种控制器。后来发现ReplicationController设计目标过于庞大，一个想完成所有的功能。目前推荐使用ReplicaSet。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;ReplicaSet:&lt;/strong&gt; 主要是帮助用户管理无状态的Pod资源。代用户创建指定数量的Pod副本，并确保Pod副本一直处于满足用户期望的数量的状态。多退少补。支持自动扩缩容策略。主要有三个核心资源组成：&lt;br&gt;1.用户期望的Pod副本数&lt;br&gt;2.标签选择器，判定哪些Pod是自己来管理的&lt;br&gt;3.Pod资源模板：如果集群中现存的Pod副本数量不够用户定义的副本数量时怎么办？新建Pod，根据Pod模板来建立。&lt;br&gt;但是ReplicaSet却不是我们直接使用的控制器。或者说k8s不建议我们直接使用ReplicaSet，而是使用Deployment。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Deployment:&lt;/strong&gt; 也是个控制器，工作在ReplicaSet之上。也就是说Deployment不是直接控制Pod，而是通过控制ReplicaSet来控制Pod。基于此，一定是Deployment能够提供比ReplicaSet更为强大的功能。Deployment还支持滚动更新和回滚等众多更为强大的机制，还提供了声明式配置的功能。这种声明式配置使得我们将来创建资源时可以基于声明的逻辑来定义。那些所有更新的资源我们可以随时重新进行声明，随时可以改变在apiserver上定义的资源的目标状态，只要对应的资源支持动态运行时修改。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;DaemonSet:&lt;/strong&gt; 用于确保集群中的每一个节点只运行一个特定的Pod副本。这些Pod通常是用来实现所谓的系统级的后台任务。当然系统级的后台任务本可以以守护进程的方式来运行这些任务，但是这种方式，服务宕了没法恢复。把这些任务托管到k8s之上有一个好处，宕了后可以被控制器自动重启。还有一个好处，当集群中新加入节点，DaemonSet会确保集群中的每个节点精确运行一个Pod，新节点进来了，上面也会启动一个这样的Pod。所以对于DaemonSet来说，不用定义Pod副本数量了，但是Pod模板肯定是要存在的。只有有了Pod模板，才能够建立起Pod资源。另外，标签选择器也是需要的，毕竟每一个节点上有没有符合我们所指定条件的Pod资源，是要靠标签选择器来判定。&lt;br&gt;用于确保集群中的每一个节点只运行一个特定的Pod副本。其实还有另外一个需求，我们也可以根据自己的需求在集群中的部分节点上，每一个节点只运行一个Pod副本。比如说要监控ssd硬盘的Pod，如果不是所有节点都有ssd，就没必要在没有ssd硬盘的节点上运行这个Pod了。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;无论是Deployment还是DaemonSet，都有这么几个特点。一是服务都是无状态的，二是这些服务必须是守护进程类的，就是必须持续地运行在后台。但是有的时候我们有这种需求，比如对数据库做备份操作，这种备份操作可以自己手动启动一个程序来运行，也可以在k8s上启动一个Pod来实现。备份结束了，这个Pod就没必要运行下去了。能实现这种功能的叫Job。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Job:&lt;/strong&gt; 也是控制器。要不要重建Pod，就看任务是否完成。只能执行一次性的作业。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Cronjob:&lt;/strong&gt; 周期性任务。Job只是一次性运行。对于Cronjob来说，如果前一次任务还没结束，下一次任务时间已经来临了，怎么办？所以Cronjob要去处理这个问题。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;StatefulSet:&lt;/strong&gt; 管理有状态应用。而且每一个Pod副本都是被单独管理的。它拥有着自己独有的标识和数据集。一旦这个Pod出现故障了，新的Pod加进来之前，我们可能需要做很多初始化操作。&lt;br&gt;假设要管理redis cluster，cluster中几个Pod，没办法取代任何一个。这种场景中我们关注的是个体行为。每个个体都要被单独对待。而不像Deployment，假如运行了3个Nginx，任何一个Nginx挂了，调度器生成一个新Pod，把配置文件一改启动起来就可以了。但是redis cluster中任何一个Pod故障了，新生成一个Pod，是取代不了之前那个的。&lt;br&gt;看起来很美好，把每个Pod当做个体来管理。但是用StatefulSet去定义管理Redis、Mysql、Zookeeper，配置方式肯定不一样。配置主从复制操作步骤肯定是不一样的。部署方式也是不一样的，没有什么共通的规律可循。因此StatefulSet最多给我们提供了一个封装控制器，这个封装指的是我们需要人为地把我们需要手动做的操作，那些复杂的操作逻辑定义成脚本，放置在StatefulSet的Pod模板的定义之中。每一次Pod故障发生后，通过脚本能自动恢复回来。难度比较大，试想一下，MySQL主从，那个代表从的Pod副本宕了，怎么能够重建个Pod副本过来，让这个Pod副本能够作为从节点。一个运行很久的MySQL，里面会有大量的数据，我们需要先从主节点做备份，备份后恢复到从节点。而且备份的时候还需要记下binlog的文件名和位置。随后在从节点上启动时还要指定从指定文件的指定位置开始。这些操作要封装成脚本实现。Pod副本创建时自动实现。好不容易开发成功这个StatefulSet，后面还有redis集群。redis主从和mysql是不一样的，又是另外一套脚本。而且脚本未必能考虑到所有情形。&lt;br&gt;所以有状态应用在k8s托管管理是极其麻烦的，原因在于有状态应用的运维技能要求非常高，运维操作步骤是各不相同的。没办法抽取共同特点，并定义模式来工作。只能每一种应用分别、单独地对待。k8s还支持一种特殊的资源叫TPR。&lt;br&gt;&lt;strong&gt;TPR:&lt;/strong&gt; Third Party Resources, 从k8s 1.2+开始支持第三方资源, 但是到1.7又被废了。因为有了更新的功能叫CDR。&lt;br&gt;&lt;strong&gt;CDR:&lt;/strong&gt; Custom Defined Resources, 用户自定义资源。从k8s 1.8+开始支持。自定义资源可以把我们运维操作技能封装进去，定义成一种特殊类型的资源，或者把我们要管理的目标资源的管理方式定义成一个独特的管理逻辑来实现。我们还可以借助CoreOS研发的叫做Operator的东西来实现灌进去我们的运维技能。&lt;br&gt;Operator：实现的灌进去的运维技能比StatefulSet要强大的太多了，但是到今天为止，成熟的Operator支持的也不过是etcd，promethus等几个。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;k8s现在难就难在使用门槛太高。每一次创建资源都需要自己写配置清单才行。任何一个系统，如果不把用户当傻瓜的话，注定用户不可能太多。为了解决这样的问题，k8s后来提供了一种功能叫Helm，头盔，外壳。Helm跟Linux上的yum一样。以后在部署应用程序，比如要在k8s之上部署redis cluster，刚才那样写要写半天，现在有人写好了，我们直接helm install就ok了。当然我们用的不是install命令，而是传一些参数告诉它，要创建什么样的存储卷，利用多少空间来存数据，以及我们要创建几个规模的集群。&lt;br&gt;目前Helm诞生还不超过3年，即便如此，大量主流的应用在Helm上已经有了。我们可以直接使用Helm就可以安装了。&lt;/p&gt;
&lt;h2 id=&quot;查看ReplicaSet帮助文档&quot;&gt;&lt;a href=&quot;#查看ReplicaSet帮助文档&quot; class=&quot;headerlink&quot; title=&quot;查看ReplicaSet帮助文档&quot;&gt;&lt;/a&gt;查看ReplicaSet帮助文档&lt;/h2&gt;&lt;p&gt;简称rs。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain rs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     ReplicaSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DEPRECATED - This group version of ReplicaSet is deprecated by&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     apps/v1beta2/ReplicaSet. See the release notes for more information.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ReplicaSet ensures that a specified number of pod replicas are running at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     any given time.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   apiVersion   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     APIVersion defines the versioned schema of this representation of an&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     object. Servers should convert recognized schemas to the latest internal&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     value, and may reject unrecognized values. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#resources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   kind &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Kind is a string value representing the REST resource this object&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     represents. Servers may infer this from the endpoint the client submits&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     requests to. Cannot be updated. In CamelCase. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   metadata     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     If the Labels of a ReplicaSet are empty, they are defaulted to be the same&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     as the Pod(s) that the ReplicaSet manages. Standard object&amp;apos;s metadata. More&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Spec defines the specification of the desired behavior of the ReplicaSet.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   status       &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Status is the most recently observed status of the ReplicaSet. This data&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     may be out of date by some window of time. Populated by the system.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Read-only. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;【注意】：截至目前为止，rs在使用时的apiVersion是apps/v1，explain时看到的显示的是旧版本，帮助文档没更新到最新。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain rs.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     ReplicaSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Spec defines the specification of the desired behavior of the ReplicaSet.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ReplicaSetSpec is the specification of a ReplicaSet.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   minReadySeconds      &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Minimum number of seconds for which a newly created pod should be ready&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     without any of its container crashing, for it to be considered available.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Defaults to 0 (pod will be considered available as soon as it is ready)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   replicas     &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Replicas is the number of desired replicas. This is a pointer to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     distinguish between explicit zero and unspecified. Defaults to 1. More&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/#what-is-a-replicationcontroller&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   selector     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Selector is a label query over pods that should match the replica count. If&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the selector is empty, it is defaulted to the labels present on the pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     template. Label keys and values that must match in order to be controlled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     by this replica set. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#label-selectors&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   template     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Template is the object that describes the pod that will be created if&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     insufficient replicas are detected. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller#pod-template&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;rs.spec下定义的主要是replicas、selector和template这3个字段。其中，template就是定义Pod的模板。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain rs.spec.template&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     ReplicaSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: template &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Template is the object that describes the pod that will be created if&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     insufficient replicas are detected. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller#pod-template&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PodTemplateSpec describes the data a pod should have when created from a&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     template&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   metadata     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Standard object&amp;apos;s metadata. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Specification of the desired behavior of the pod. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这里的metadata和spec是Pod的metadata和spec。&lt;/p&gt;
&lt;h2 id=&quot;ReplicaSet示例&quot;&gt;&lt;a href=&quot;#ReplicaSet示例&quot; class=&quot;headerlink&quot; title=&quot;ReplicaSet示例&quot;&gt;&lt;/a&gt;ReplicaSet示例&lt;/h2&gt;&lt;h3 id=&quot;示例1：创建ReplicaSet&quot;&gt;&lt;a href=&quot;#示例1：创建ReplicaSet&quot; class=&quot;headerlink&quot; title=&quot;示例1：创建ReplicaSet&quot;&gt;&lt;/a&gt;示例1：创建ReplicaSet&lt;/h3&gt;&lt;p&gt;先清理掉集群中无用的Pod。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;liveness-httpget-pod           1/1     Running   1          2d19h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;poststart-pod                  1/1     Running   65         2d17h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;readiness-httpget-pod          1/1     Running   0          2d19h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME           READY   UP-TO-DATE   AVAILABLE   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client         1/1     1            1           9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp          3/3     3            3           9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy   1/1     1            1           9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete deploy client&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions &amp;quot;client&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete deploy myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions &amp;quot;myapp&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete deploy nginx-deploy &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions &amp;quot;nginx-deploy&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   ClusterIP   10.96.0.1        &amp;lt;none&amp;gt;        443/TCP        121d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp        NodePort    10.109.204.135   &amp;lt;none&amp;gt;        80:31784/TCP   9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx        ClusterIP   10.107.191.247   &amp;lt;none&amp;gt;        80/TCP         9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete svc myapp &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service &amp;quot;myapp&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete svc nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service &amp;quot;nginx&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete -f liveness-httpget.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;liveness-httpget-pod&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete -f readiness-httpget.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;readiness-httpget-pod&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete -f poststart-pod.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;poststart-pod&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例】：&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim rs-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: ReplicaSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  replicas: 2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    matchLabels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  template:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      name: myapp-pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        environment: qa&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - name: myapp-container&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f rs-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;replicaset.apps/myapp created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/92.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;【说明】：&lt;br&gt;1、rs的metadata和Pod的metadata很类似，rs自己也是个资源，也可以有标签，也可以有注解。如果需要的话自己定义就行。这里为了结构清晰一点，就不写了。&lt;br&gt;2、spec.selector是个标签选择器，它是一个对象，支持两种挑选方式。第一种是基于等值的标签选择，matchLabels。它是个map，可以给定多个键值。第二种叫matchExpressions。&lt;br&gt;3、spec.template也是个对象，嵌套的字段有两个：metadata和spec。template中定义的的metadata中标签要包含selector中的标签，否则创建的Pod不符合自己的选择器，没有意义。当然也可以在template中定义多余的标签。&lt;br&gt;4、对于容器来讲，一般要做存活性探测和就绪性探测的，这里为了结构清晰和简单，就没写。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/93.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;现在删除一个Pod，看控制器是否会自动重新创建一个Pod：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/94.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;创建一个别的Pod，并为这个Pod打上标签，使得这个Pod可以被上面创建的RS的标签选择器选中：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f pod-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME          READY   STATUS    RESTARTS   AGE     LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-g4vt8   1/1     Running   0          12m     app=myapp,environment=qa,release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-tj86f   1/1     Running   0          3m36s   app=myapp,environment=qa,release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo      2/2     Running   0          19s     app=myapp,tier=frontend&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label pod pod-demo app=myapp release=canary --overwrite&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME          READY   STATUS        RESTARTS   AGE     LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-g4vt8   1/1     Running       0          13m     app=myapp,environment=qa,release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-tj86f   1/1     Running       0          4m56s   app=myapp,environment=qa,release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo      2/2     Terminating   0          99s     app=myapp,release=canary,tier=frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME          READY   STATUS    RESTARTS   AGE     LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-g4vt8   1/1     Running   0          14m     app=myapp,environment=qa,release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-tj86f   1/1     Running   0          5m13s   app=myapp,environment=qa,release=canary&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;结果这个新创建的Pod pod-demo被终止删除了，RS始终保持被选中的Pod的副本数量为我们在清单文件中定义的值2。&lt;/p&gt;
&lt;h3 id=&quot;示例2：扩容&quot;&gt;&lt;a href=&quot;#示例2：扩容&quot; class=&quot;headerlink&quot; title=&quot;示例2：扩容&quot;&gt;&lt;/a&gt;示例2：扩容&lt;/h3&gt;&lt;p&gt;kubectl scale 或者 kubectl edit rs的清单文件&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get rs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubeNAME    DESIRED   CURRENT   READY   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp   2         2         2       19m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You have mail in /var/spool/mail/root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl edit rs myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;replicaset.extensions/myapp edited&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/95.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME          READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-fsntj   1/1     Running   0          21s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-g4vt8   1/1     Running   0          21m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-lk7dr   1/1     Running   0          21s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-p7pm8   1/1     Running   0          21s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-tj86f   1/1     Running   0          12m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例3：更新升级&quot;&gt;&lt;a href=&quot;#示例3：更新升级&quot; class=&quot;headerlink&quot; title=&quot;示例3：更新升级&quot;&gt;&lt;/a&gt;示例3：更新升级&lt;/h3&gt;&lt;p&gt;更新升级：更新升级无非是去改容器的镜像文件的版本。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl edit rs myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;replicaset.extensions/myapp edited&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/96.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/97.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;改了控制器的template中的镜像版本，Pod资源并不会被改掉，因为Pod资源不会被重建，只有重建的Pod资源，它的版本才会改掉。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/98.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;删除一个，一个重建，发布完成；&lt;br&gt;删除一个，一个重建，发布完成；&lt;br&gt;删除一个，一个重建，发布完成；&lt;br&gt;…&lt;br&gt;这是“灰度发布”。但是这需要我们人为参与进来。节奏我们自己能掌握，如果只删除一个，这叫金丝雀。那些被导向到v2的就是小白鼠，试试新版本有没有问题，两天以后，没人反应有问题，那就可以全部升级了。这是金丝雀发布。&lt;br&gt;当然也可以一次性把所有Pod都删除了，但是一次性全删除了，一定会影响在线访问的。这种发布有点暴力，虽然更新也很快。最妥当的更新是用蓝绿的方式进行。在创建一个rs，新的rs的标签选择器可以和老的rs的标签选择器不完全一样，但跟前面的service都能兼容。即service关联的pod既来之rs1，也来自rs2。我们先创建rs2，在删除rs1，这就是蓝绿发布。&lt;br&gt;或者先创建rs2，等rs2就绪了，修改service，将service匹配rs2，不在指向rs1。这样才是真正意义上的蓝绿。但是仍然需要我们自己去规划部署。有一个组件就是建立在rs之上完成的，叫Deployment。Deployment就是帮我们干这个事情的，&lt;strong&gt;能提供滚动式、自定义更新。&lt;/strong&gt;Deployment建立在rs之前，一个Deployment管理多个rs，但是当前正在使用的只有1个。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/99.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;而且Deployment提供&lt;strong&gt;声明式更新配置&lt;/strong&gt;，声明式创建一般使用apply，而不使用create。对于apply管理的，还可以patch打补丁来实现修改，而不用使用edit。我们完全可以在命令行中通过纯命令方式来直接完成对应资源版本内容修改。说白了就是可以使用POST方式来提交内容来进行修改，而不是直接改配置文件。直接通过打补丁的方式来修改。&lt;br&gt;Deployment除了可以实现滚动更新，还可以控制更新节奏和更新逻辑。假如说ReplicaSet有5个Pod副本，刚才手动更新是这么更新的，删除1个，由rs自动创建1个，在删1个，在自动创建1个。有这么个场景，假如这5个刚刚能满足用户访问需求，我们通过service将用户流量调度到这5个Pod上。删1个，这4个不足以承载这么大的流量。怎么办？不删又不能更新。如果支持先加1个，在删1个。加1个是违反Pod管理机制的，副本数是精确反应在清单中定义的数量，加1个就多了1个，所以这里是需要临时加1个。所以临时加几个，怎么加是可以控制的。我们不但可以指定在滚动更新期间，最多能够多出我们期望副本数量几个，还能定义最多能少于副本数量几个。&lt;br&gt;控制逻辑可以实现 灰度、金丝雀、蓝绿发布。&lt;br&gt;滚动更新时，定义liveness和readiness是很重要的，不然一启动就就绪了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Pod控制器&quot;&gt;&lt;a href=&quot;#Pod控制器&quot; class=&quot;headerlink&quot; title=&quot;Pod控制器&quot;&gt;&lt;/a&gt;Pod控制器&lt;/h2&gt;&lt;h3 id=&quot;Pod控制器介绍&quot;&gt;&lt;a href=&quot;#Pod控制器介绍&quot; class=&quot;headerlink&quot; title=&quot;Pod控制器介绍&quot;&gt;&lt;/a&gt;Pod控制器介绍&lt;/h3&gt;&lt;p&gt;此前使用配置清单创建Pod，都是在配置文件中定义要创建的Pod具体是什么。而后就提交给apiserver，由apiserver转交给Scheduler完成调度，由目标节点予以创建并启动相关的Pod资源。如果我们把Pod资源意外删除，Pod不会重建。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Pod探针</title>
    <link href="http://yoursite.com/2019/08/09/Kubernetes-Pod%E6%8E%A2%E9%92%88/"/>
    <id>http://yoursite.com/2019/08/09/Kubernetes-Pod探针/</id>
    <published>2019-08-09T01:25:46.000Z</published>
    <updated>2019-08-09T09:32:54.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;探针类型&quot;&gt;&lt;a href=&quot;#探针类型&quot; class=&quot;headerlink&quot; title=&quot;探针类型&quot;&gt;&lt;/a&gt;探针类型&lt;/h2&gt;&lt;p&gt;探针主要有两种：livenessProbe和readinessProbe。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.spec.containers&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/83.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;容器探测无非就是我们在里面设置了一些探针，或传感器来获取相应的数据作为判定其存活与否的标准和就绪与否的标准。对于 livenessProbe和readinessProbe 这两种探针，可定义的具体探针有三种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ExecAction&lt;/li&gt;
&lt;li&gt;TCPSocketAction&lt;/li&gt;
&lt;li&gt;HTTPGetAction      &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;每次定义三者之中的一个就可以了。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ kubectl explain pods.spec.containers.livenessProbe&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;- exec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;exec探针。执行用户自定义命令，这个命令得是容器中存在的命令才行&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- failureThreshold  &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;探测几次都失败，才认为是失败的。默认是3个。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- httpGet &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;httpGet探针&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- initialDelaySeconds &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;在容器启动以后多久做探测，很多时间容器启动了，但是主程序很可能还没初始化完成。因此应该等一些时间在探测。默认是容器一启动就探测。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- periodSeconds &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;每次探测之间间隔多长时间，默认10s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- successThreshold &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;成功几次说明ok，默认是1次&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- tcpSocket &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tcpSocket探针&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- timeoutSeconds &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;超时时间，发出探测，多久没响应，默认1s。&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;readiness探测所使用的字段和liveness字段是一样的。只是两者探测目的不一样。&lt;/p&gt;
&lt;h2 id=&quot;livenessProbe探针示例&quot;&gt;&lt;a href=&quot;#livenessProbe探针示例&quot; class=&quot;headerlink&quot; title=&quot;livenessProbe探针示例&quot;&gt;&lt;/a&gt;livenessProbe探针示例&lt;/h2&gt;&lt;h3 id=&quot;exec探测&quot;&gt;&lt;a href=&quot;#exec探测&quot; class=&quot;headerlink&quot; title=&quot;exec探测&quot;&gt;&lt;/a&gt;exec探测&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.spec.containers.livenessProbe.exec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: exec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     One and only one of the following should be specified. Exec specifies the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     action to take.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ExecAction describes a &amp;quot;run in container&amp;quot; action.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   command      &amp;lt;[]string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Command is the command line to execute inside the container, the working&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     directory for the command is root (&amp;apos;/&amp;apos;) in the container&amp;apos;s filesystem. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     command is simply exec&amp;apos;d, it is not run inside a shell, so traditional&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     shell instructions (&amp;apos;|&amp;apos;, etc) won&amp;apos;t work. To use a shell, you need to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     explicitly call out to that shell. Exit status of 0 is treated as&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     live/healthy and non-zero is unhealthy.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim liveness-exec.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: liveness-exec-pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: liveness-exec-container&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: busybox:latest&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    command: [&amp;quot;sh&amp;quot;,&amp;quot;-c&amp;quot;,&amp;quot;touch /tmp/healthy; sleep 30; rm -f /tmp/healthy; sleep 3600&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    livenessProbe:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      exec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        command: [&amp;quot;test&amp;quot;,&amp;quot;-e&amp;quot;,&amp;quot;/tmp/healthy&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      initialDelaySeconds: 1 #默认0s，即容器一启动就探测&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      periodSeconds: 3 #每隔多长时间进行探测&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f liveness-exec.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/liveness-exec-pod created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;过个30s，然后去查看下这个pod的状态：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl describe pod liveness-exec-pod&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/84.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;httpGet探测&quot;&gt;&lt;a href=&quot;#httpGet探测&quot; class=&quot;headerlink&quot; title=&quot;httpGet探测&quot;&gt;&lt;/a&gt;httpGet探测&lt;/h3&gt;&lt;p&gt;如果容器内是个web服务，可以使用TCP套接字探测，还可以使用HTTP探测。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.containers.livenessProbe.httpGet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: httpGet &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     HTTPGet specifies the http request to perform.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     HTTPGetAction describes an action based on HTTP Get requests.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   host &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Host name to connect to, defaults to the pod IP. You probably want to set&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &amp;quot;Host&amp;quot; in httpHeaders instead.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   httpHeaders  &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Custom headers to set in the request. HTTP allows repeated headers.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   path &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Path to access on the HTTP server.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   port &amp;lt;string&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Name or number of the port to access on the container. Number must be in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the range 1 to 65535. Name must be an IANA_SVC_NAME.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   scheme       &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Scheme to use for connecting to the host. Defaults to HTTP.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;host &lt;string&gt;&lt;/string&gt;&lt;/strong&gt;&lt;br&gt;默认往Pod IP发请求。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;httpHeaders  &amp;lt;[]Object&amp;gt;&lt;/strong&gt;&lt;br&gt;自定义首部。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;path &lt;string&gt;&lt;/string&gt;&lt;/strong&gt;&lt;br&gt;向哪个url发请求&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;port &lt;string&gt; -required-&lt;/string&gt;&lt;/strong&gt;&lt;br&gt;Name or number of the port to access on the container. Number must be in&lt;br&gt;the range 1 to 65535. Name must be an &lt;strong&gt;IANA_SVC_NAME&lt;/strong&gt;.&lt;br&gt;如果我们在containers暴露定义了名称，这里port这个字段可以使用定义的名称。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;scheme       &lt;string&gt;&lt;/string&gt;&lt;/strong&gt;&lt;br&gt;Scheme to use for connecting to the host. Defaults to HTTP.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim liveness-httpget.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: liveness-httpget-pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: liveness-httpget-container&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    livenessProbe:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      httpGet:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        port: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        path: /index.html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      initialDelaySeconds: 1 #默认0s，即容器一启动就探测&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      periodSeconds: 3 #每隔多长时间进行探测&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f liveness-httpget.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/liveness-httpget-pod created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl describe pod liveness-httpget-pod&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/85.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;下面手动进入Pod中的容器，删除这个index.html文件，然后看看探针是否探测失败：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl exec -it liveness-httpget-pod -- /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # ls /usr/share/nginx/html/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50x.html    index.html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # rm -f /usr/share/nginx/html/index.html&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在另一个终端 describe 这个pod：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl describe pod liveness-httpget-pod | grep -i liveness&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/86.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;readinessProbe探针示例&quot;&gt;&lt;a href=&quot;#readinessProbe探针示例&quot; class=&quot;headerlink&quot; title=&quot;readinessProbe探针示例&quot;&gt;&lt;/a&gt;readinessProbe探针示例&lt;/h2&gt;&lt;h3 id=&quot;就绪性探测必要性&quot;&gt;&lt;a href=&quot;#就绪性探测必要性&quot; class=&quot;headerlink&quot; title=&quot;就绪性探测必要性&quot;&gt;&lt;/a&gt;就绪性探测必要性&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/87.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;如果你不定义就绪，那么容器一启动，该容器状态就显示为1，就绪。&lt;br&gt;就绪性探测和service调度有着重要的关联性。service是个固定入口端点，为动态地、有生命周期的Pod资源提供一个固定的入口端口。客户端不是直接访问Pod，而是访问service。service使用标签选择器关联至各Pod资源。这里有个问题，比如现在又创建了一个新Pod出来，这个新Pod正好符合这个service标签选择器的选择条件，立即把这个Pod作为后端对象了。用户请求进来可能被调度到这个新Pod上了。但是这个新Pod一创建成功，就被service关联到后端去了，但是此时Pod里的服务很有可能还没就绪。这个时候有请求被调度上来，肯定是访问不到服务的。因此要做就绪性探测，否则Pod一创建就被立即关联到service上了。所以以后使用Pod必须要做readinessProbe。&lt;br&gt;readinessProbe和livenessProbe支持的探针都是一样的，但是两者目的不一样。&lt;/p&gt;
&lt;h3 id=&quot;httpGet探测-1&quot;&gt;&lt;a href=&quot;#httpGet探测-1&quot; class=&quot;headerlink&quot; title=&quot;httpGet探测&quot;&gt;&lt;/a&gt;httpGet探测&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cp liveness-httpget.yaml readiness-httpget.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim readiness-httpget.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: readiness-httpget-pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: readiness-httpget-container&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    readinessProbe:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      httpGet:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        port: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        path: /index.html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      initialDelaySeconds: 1 #默认0s，即容器一启动就探测&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      periodSeconds: 3 #每隔多长时间进行探测&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f readiness-httpget.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          6d21h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;liveness-httpget-pod           1/1     Running   1          34m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          7d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          7d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          7d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          7d1h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;readiness-httpget-pod          1/1     Running   0          3s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;已经显示为就绪状态。然后我们进入这个Pod中的容器，删除index.html文件&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl exec -it readiness-httpget-pod -- /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # rm -f /usr/share/nginx/html/index.html&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/88.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/89.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;/ # echo &amp;quot;hi&amp;quot; &amp;gt;&amp;gt; /usr/share/nginx/html/index.html&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/90.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子&quot;&gt;&lt;a href=&quot;#Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子&quot; class=&quot;headerlink&quot; title=&quot;Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子&quot;&gt;&lt;/a&gt;Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子&lt;/h2&gt;&lt;p&gt;在主容器刚刚启动之后，用户可以手动嵌入做一些操作，可以做一个 post start，比如执行完一个命令就退出。&lt;br&gt;如果主容器要退出，在结束之前，也可以做一些事情，pre stop。类似于awk的BEGIN和END。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.containers.lifecycle&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: lifecycle &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Actions that the management system should take in response to container&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     lifecycle events. Cannot be updated.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Lifecycle describes actions that the management system should take in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     response to container lifecycle events. For the PostStart and PreStop&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     lifecycle handlers, management of the container blocks until the action is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     complete, unless the container process fails, in which case the handler is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     aborted.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   postStart    &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PostStart is called immediately after a container is created. If the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     handler fails, the container is terminated and restarted according to its&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     restart policy. Other management of the container blocks until the hook&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     completes. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#container-hooks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   preStop      &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PreStop is called immediately before a container is terminated due to an&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     API request or management event such as liveness probe failure, preemption,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     resource contention, etc. The handler is not called if the container&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     crashes or exits. The reason for termination is passed to the handler. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Pod&amp;apos;s termination grace period countdown begins before the PreStop hooked&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     is executed. Regardless of the outcome of the handler, the container will&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     eventually terminate within the Pod&amp;apos;s termination grace period. Other&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     management of the container blocks until the hook completes or until the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     termination grace period is reached. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#container-hooks&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.containers.lifecycle.postStart&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: postStart &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PostStart is called immediately after a container is created. If the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     handler fails, the container is terminated and restarted according to its&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     restart policy. Other management of the container blocks until the hook&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     completes. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#container-hooks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Handler defines a specific action that should be taken&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   exec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     One and only one of the following should be specified. Exec specifies the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     action to take.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   httpGet      &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     HTTPGet specifies the http request to perform.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   tcpSocket    &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     TCPSocket specifies an action involving a TCP port. TCP hooks not yet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     supported&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.containers.lifecycle.preStop&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: preStop &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PreStop is called immediately before a container is terminated due to an&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     API request or management event such as liveness probe failure, preemption,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     resource contention, etc. The handler is not called if the container&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     crashes or exits. The reason for termination is passed to the handler. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Pod&amp;apos;s termination grace period countdown begins before the PreStop hooked&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     is executed. Regardless of the outcome of the handler, the container will&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     eventually terminate within the Pod&amp;apos;s termination grace period. Other&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     management of the container blocks until the hook completes or until the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     termination grace period is reached. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#container-hooks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Handler defines a specific action that should be taken&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   exec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     One and only one of the following should be specified. Exec specifies the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     action to take.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   httpGet      &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     HTTPGet specifies the http request to perform.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   tcpSocket    &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     TCPSocket specifies an action involving a TCP port. TCP hooks not yet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     supported&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;【示例】：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim poststart-pod.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: poststart-pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: busybox-httpd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: busybox:latest&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lifecycle:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      postStart:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          command: [&amp;quot;mkdir&amp;quot;,&amp;quot;-p&amp;quot;,&amp;quot;/data/web/html&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    command: [&amp;quot;/bin/sh&amp;quot;,&amp;quot;-c&amp;quot;,&amp;quot;sleep 3600&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f poststart-pod.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/poststart-pod created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          6d22h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;liveness-httpget-pod           1/1     Running   1          134m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          7d1h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          7d1h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          7d1h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          7d2h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;poststart-pod                  1/1     Running   0          6s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;readiness-httpget-pod          1/1     Running   0          100m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl exec -it poststart-pod -- /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # ls /data/web/html/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # ls /data/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;web&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/91.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;探针类型&quot;&gt;&lt;a href=&quot;#探针类型&quot; class=&quot;headerlink&quot; title=&quot;探针类型&quot;&gt;&lt;/a&gt;探针类型&lt;/h2&gt;&lt;p&gt;探针主要有两种：livenessProbe和readinessProbe。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.spec.containers&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Pod控制器</title>
    <link href="http://yoursite.com/2019/08/07/Kubernetes-Pod%E6%8E%A7%E5%88%B6%E5%99%A8/"/>
    <id>http://yoursite.com/2019/08/07/Kubernetes-Pod控制器/</id>
    <published>2019-08-07T01:11:46.000Z</published>
    <updated>2019-08-08T06:12:43.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Pod控制器资源配置清单重要字段详解&quot;&gt;&lt;a href=&quot;#Pod控制器资源配置清单重要字段详解&quot; class=&quot;headerlink&quot; title=&quot;Pod控制器资源配置清单重要字段详解&quot;&gt;&lt;/a&gt;Pod控制器资源配置清单重要字段详解&lt;/h2&gt;&lt;p&gt;资源的清单格式:&lt;br&gt;一级字段：apiVersion(group/version), kind, metadata(name,namespace,labels,annotations,…), spec, status(只读)&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Pod资源：&lt;/strong&gt;&lt;br&gt;spec.containers &amp;lt;[]object&amp;gt;  # kubectl explain pods.spec.containers&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;name &lt;string&gt;&lt;/string&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;image &lt;string&gt;&lt;/string&gt;&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/74.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;imagePullPolicy &lt;string&gt;&lt;/string&gt;&lt;/strong&gt;&lt;br&gt;可用值：Always, Never, IfNotPresent。Always：本地有或者没有这个镜像，就算有，也不用本地已有的这个镜像，而是去registry中下载。Never：如果有，就用。如果没有，它也不会去下载。IfNotPresent：如果本地存在就直接使用，如果不存在就去下载。如果你的镜像的标签是latest，那么默认值就是Always。如果不是latest标签，默认值都是IfNotPresent。另外在创建完这个资源后，imagePullPolicy这个字段是不可以修改的。除非把这个资源删了，然后去修改这个文件，在创建。很多时候，从一个无法确定其可信与否的主机之上运行容器时，我们把imagePullPolicy设置为Always时一定会浪费我们拖这个对应的对象的带宽，同时也会导致容器启动速度较慢。但是带来的好处是，当你试图启动一个容器时，那个目标主机之上正好存在了启动容器的这个镜像，但是那个镜像可能不是你想要运行的镜像，但是它精巧地伪装成了你要运行的镜像的名称，比如有人在每一个公有云的主机之上都放了某一个镜像，这个镜像里面内建了挖矿的代码，当你试图启动某一个容器时，因为本地已经有了这个镜像，就不用从registry上下载了，这样就中招了。所以 Always 在某些情况下还是有用的。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/75.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;ports &amp;lt;[]Object&amp;gt;&lt;/strong&gt;&lt;br&gt;定义容器内的要暴露的端口时，可以暴露多个端口。而且每一个端口还应该有多个属性来定义。比如端口的名称，将来可以基于名称(在service中映射时可以用到)来引用它。端口号，还有协议。【注意】：暴露一个端口仅仅是提供额外信息的，并不会限制系统是否会真的会暴露。这和docker不太一样，这儿的网络是叠加网络，pod和pod可以通过ip地址直接通信的，所以不需要手动绑定在节点的IP地址上才能访问。在文件中明确地、显式地定义，至少让用户知道我们的应用程序到底监听在哪个端口。只要你容器里那个应用程序监听的端口，一定会暴露出去。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;args &amp;lt;[]string&amp;gt; 和 commad &amp;lt;[]string&amp;gt;&lt;/strong&gt; 修改镜像中的默认启动的命令。&lt;br&gt;如果我们想不去运行镜像中定义的默认要运行的应用程序，此前的例子中用的是command。其实应该是 args 和 command 两个一起配合。command表示要运行的程序，args表示传递给程序的参数。而在dockerfile中，里面有entrypoint和cmd，如果只有cmd，那就运行cmd中的程序。如果既有entrypoint，又有cmd，cmd的内容将作为参数被传递给entrypoint中的命令。&lt;br&gt;Kubernetes清单文件中的 command 是一个 Entrypoint array，有点相像于dockerfile中的entrypoint。而且command给定的代码是不会运行在shell中的。因此如果你想运行在shell中，必须指定/bin/sh。如果你没有提供command，docker镜像在制作时，它有entrypoint那个指令，那么就会运行镜像中的entrypoint。说白了就是当你不提供命令时，就默认运行镜像中的命令。&lt;br&gt;args 用来向 command 传参数。如果在args中引用了变量，变量引用格式为：$(VAR_NAME)。如果不想在这被替换，就是想用shell中命令引用的效果，使用方式为：$$(VAR_NAME)。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;关于清单文件中定义Pod时使用的command和args字段与dockerfile中的entrypoint和cmd的关系，在 &lt;a href=&quot;https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/&lt;/a&gt; 文档中有详细的说明。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/76.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;标签和标签选择器&quot;&gt;&lt;a href=&quot;#标签和标签选择器&quot; class=&quot;headerlink&quot; title=&quot;标签和标签选择器&quot;&gt;&lt;/a&gt;标签和标签选择器&lt;/h2&gt;&lt;h3 id=&quot;标签简介&quot;&gt;&lt;a href=&quot;#标签简介&quot; class=&quot;headerlink&quot; title=&quot;标签简介&quot;&gt;&lt;/a&gt;标签简介&lt;/h3&gt;&lt;p&gt;标签是附加在对应对象之上的“键值对”。一个资源之上可存在多个标签，一个标签也可以在多个资源对象上。这每一个标签都可以对标签选择器进行匹配度检查，从而完成资源挑选。标签既可以在对象创建时指定，也可以在资源创建之后使用命令来添加、删除、修改。实践中，我们通常可以给资源附加多个不同维度的标签来进行不同维度的管理。常用的维度有：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;release，比如stable，beta, alpha, canary等。&lt;/li&gt;
&lt;li&gt;environment：dev/test/prod&lt;/li&gt;
&lt;li&gt;架构层面：接入层、前台等&lt;/li&gt;
&lt;li&gt;应用维度：应用名&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;标签：&lt;/strong&gt;&lt;br&gt;key=value&lt;br&gt;key：字母、数字、&lt;em&gt;、-、.&lt;br&gt;value：也不可以超过63个字符，可以为空。只能以 字母或数字开头及结尾，中间可使用 字母、数字、&lt;/em&gt;、-、.&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/77.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例1：利用标签选择器查看资源&quot;&gt;&lt;a href=&quot;#示例1：利用标签选择器查看资源&quot; class=&quot;headerlink&quot; title=&quot;示例1：利用标签选择器查看资源&quot;&gt;&lt;/a&gt;示例1：利用标签选择器查看资源&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# 查看对应资源下含有标签app的资源&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l app&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          28s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l app --show-labels &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          35s   app=myapp,tier=frontend&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# -L 标签名，表示显示对应资源下有相应标签的值。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -L app,run&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE     APP     RUN&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          5d17h           client&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          5d20h           myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          5d20h           myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          5d20h           myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          5d21h           nginx-deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                       2/2     Running   0          2m48s   myapp&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;示例2：添加标签&quot;&gt;&lt;a href=&quot;#示例2：添加标签&quot; class=&quot;headerlink&quot; title=&quot;示例2：添加标签&quot;&gt;&lt;/a&gt;示例2：添加标签&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl label [--overwrite] (-f FILENAME | TYPE NAME) KEY_1=VAL_1 ... KEY_N=VAL_N [--resource-version=version]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;TYPE NAME：表示什么类型的、什么名字的资源。&lt;/p&gt;
&lt;p&gt;给Pod pod-demo添加一个标签：release=canary&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label pods pod-demo release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods pod-demo --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          10m   app=myapp,release=canary,tier=frontend&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例3：修改标签&quot;&gt;&lt;a href=&quot;#示例3：修改标签&quot; class=&quot;headerlink&quot; title=&quot;示例3：修改标签&quot;&gt;&lt;/a&gt;示例3：修改标签&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label pods pod-demo release=stable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;error: &amp;apos;release&amp;apos; already has a value (canary), and --overwrite is false&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label pods pod-demo release=stable --overwrite&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods pod-demo --show-labels   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          13m   app=myapp,release=stable,tier=frontend&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;示例4：删除标签&quot;&gt;&lt;a href=&quot;#示例4：删除标签&quot; class=&quot;headerlink&quot; title=&quot;示例4：删除标签&quot;&gt;&lt;/a&gt;示例4：删除标签&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods pod-demo --show-labels  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          38m   app=myapp,release=stable,tier=frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label pod pod-demo release-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods pod-demo --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          38m   app=myapp,tier=frontend&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;标签选择器介绍&quot;&gt;&lt;a href=&quot;#标签选择器介绍&quot; class=&quot;headerlink&quot; title=&quot;标签选择器介绍&quot;&gt;&lt;/a&gt;标签选择器介绍&lt;/h3&gt;&lt;p&gt;k8s的标签选择器支持两类：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;等值关系的标签选择器：=、==、!=&lt;/li&gt;
&lt;li&gt;基于集合关系的标签选择器：&lt;ul&gt;
&lt;li&gt;KEY in (VALUE1,VALUE2,…)      &lt;/li&gt;
&lt;li&gt;KEY notin (VALUE1,VALUE2,…)&lt;/li&gt;
&lt;li&gt;KEY&lt;/li&gt;
&lt;li&gt;!KEY&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;有很多类型的资源都要基于 标签选择器 来关联其他资源的，比如说Pod控制器和service。Pod控制器和service来实现标签关联时，通常使用另外两个字段来嵌套。Deployment、service等许多资源通常支持使用 matchLabels来让你去定义，就是里面内嵌一字段来定义怎么使用标签选择器。Deployment、ReplicaSet等支持两种 matchLabels 和 matchExpressions，service只支持第一种 matchLabels。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;matchLabels: 直接给定键值，相当于使用等值关系一样&lt;/li&gt;
&lt;li&gt;matchExpressions: 基于给定的表达式来定义使用的标签选择器。{key:”KEY”, operator:”OPERATOR”, values:[VALUE1,VALUE2,…]}&lt;ul&gt;
&lt;li&gt;OPERATOR: &lt;ul&gt;
&lt;li&gt;In、NotIn：values字段的值必须为非空列表&lt;/li&gt;
&lt;li&gt;Exists、NotExists：values字段的值必须为空列表&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l release&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          22m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# ,表示与关系，必须都满足&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l release,app&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          22m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l release=stable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          22m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l release=stable --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          22m   app=myapp,release=stable,tier=frontend&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# !=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# 没有release标签也视为不等于&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l release!=stable &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          5d17h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          5d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          5d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          5d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          5d21h&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# in、notin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l &amp;quot;release in (canary,alpha,beta)&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;No resources found.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l &amp;quot;release in (canary,alpha,beta,stable)&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          25m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# 没有release标签也视为不在集合内&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l &amp;quot;release notin (canary,alpha,beta,stable)&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          5d17h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          5d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          5d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          5d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          5d21h&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;能使用标签的不仅仅包括Pod，各种资源对象都可以打标，包括节点。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get nodes --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       STATUS   ROLES    AGE    VERSION   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;hadoop16   Ready    &amp;lt;none&amp;gt;   19h    v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=hadoop16,kubernetes.io/os=linux&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark17    Ready    &amp;lt;none&amp;gt;   117d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=spark17,kubernetes.io/os=linux&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32    Ready    master   117d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=spark32,kubernetes.io/os=linux,node-role.kubernetes.io/master=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ubuntu31   Ready    &amp;lt;none&amp;gt;   117d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ubuntu31,kubernetes.io/os=linux&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;给节点ubuntu31新增一个标签：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label node ubuntu31 disktype=ssd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/ubuntu31 labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get nodes --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       STATUS   ROLES    AGE    VERSION   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;hadoop16   Ready    &amp;lt;none&amp;gt;   19h    v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=hadoop16,kubernetes.io/os=linux&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark17    Ready    &amp;lt;none&amp;gt;   117d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=spark17,kubernetes.io/os=linux&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32    Ready    master   117d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=spark32,kubernetes.io/os=linux,node-role.kubernetes.io/master=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ubuntu31   Ready    &amp;lt;none&amp;gt;   117d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=ssd,kubernetes.io/arch=amd64,kubernetes.io/hostname=ubuntu31,kubernetes.io/os=linux&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;当节点有标签以后，我们随后在添加资源时，可以让资源对节点有倾向性。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/78.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;假设我们想让pod-demo这个pod运行在node01上，node01上有个标签是disktype=ssd&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/79.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete -f pod-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-demo&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f pod-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods pod-demo -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE     IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          2m41s   10.244.2.31   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;注解&quot;&gt;&lt;a href=&quot;#注解&quot; class=&quot;headerlink&quot; title=&quot;注解&quot;&gt;&lt;/a&gt;注解&lt;/h2&gt;&lt;p&gt;资源除了可以使用标签外，还可以使用注解，annotations。资源注解和标签很相像，都是键值。区别是annotations不能用于挑选资源对象，仅用于为对象提供“元数据”。这些元数据有些时候可能被某些程序所用到，而且很重要，会作为基本判断条件。键值长度不再受字符数量限制。labels键值必须是不超过63个字符，键前缀使用域名的话，不超过253字符。&lt;br&gt;annotations其实可以动态编辑的，它不是特别重要的属性字段。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/80.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete -f pod-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-demo&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f pod-demo.yaml       &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/81.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;Pod的生命周期&quot;&gt;&lt;a href=&quot;#Pod的生命周期&quot; class=&quot;headerlink&quot; title=&quot;Pod的生命周期&quot;&gt;&lt;/a&gt;Pod的生命周期&lt;/h2&gt;&lt;p&gt;在Pod创建时，它可能要做初始化。所以在创建启动之前需要一点时间做初始化。所谓的Pod秒级启动，这个秒级不具有实际意义，有的应用程序初始化有的时候需要很长时间，不可能1s之内完成。另外，在写dockerfile的时候，我们应该使用entrypoint脚本来对容器做环境初始化，这个初始化估计都不止1s。&lt;br&gt;Pod能站起来，容器启动起来之前，要经历那么一点点时间。如果这点时间忽略不计的话，那么Pod的生命周期从Pod被创建开始。一个容器只用来运行一个进程，一个Pod中可以运行多个容器，但是一般我们只运行一个容器。Pod内的这个主容器，在运行之前，可能需要做一些环境设定。所以一般来讲，主容器启动之前，可以把这段时间哪来去做别的事。比如运行另外一个容器，这个容器专门为主容器做环境初始化，所以通常被称为&lt;strong&gt;init container&lt;/strong&gt;。这个容器内部程序运行完，就可以退出了，它不会一直存在。初始化容器可以有多个，多个初始化容器是串行执行的。主容器退出了，Pod也就退出了，这两个是一个时间点。&lt;br&gt;在主容器启动时，它也需要把应用程序环境初始化，比如说要用entrypoint生成一个配置文件，再比如要运行一个tomcat，tomcat要把war文件内容展开部署等。所以在主容器刚刚启动之后，用户可以手动嵌入做一些操作，可以做一个 post start，比如执行完一个命令就退出。&lt;br&gt;如果我们的主容器要退出，在结束之前，也可以做一些事情，pre stop。类似于awk的BEGIN和END。&lt;br&gt;另外，在整个主容器的执行过程当中，我们还可以做两类操作，一般而言，在post start执行之后，我们就可以做两类检测了，在k8s中，支持两类对Pod中容器的检测。第一种检测：liveness probe，主进程还是否处于存活状态。但是就算这个主进程在运行，也不一定意味着能正常提供服务。liveness probe是做存活状态检测。因为一个Pod内是可以有多个容器的，通常我们称为 主容器 和 辅助容器。所以每一个容器，尤其是主容器，我们应该对它正常与否、以及就绪与否做状态检测。分别是liveness probe和readiness probe。无论是哪种probe，都可以支持三种探测行为：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1.执行自定义命令&lt;/li&gt;
&lt;li&gt;2.向指定的套接字发TCP请求&lt;/li&gt;
&lt;li&gt;3.向指定的HTTP服务发请求&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;liveness probe只要用来判断主容器是否处于运行状态的，readiness probe用于判定容器中的主进程是否准备就绪并可以对外提供服务。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/82.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;整个Pod从创建到结束之前，Pod一定会处于某种状态之中。&lt;strong&gt;所以Pod有多种状态：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pending：挂起。我们请求创建这个Pod时，条件不能满足，调度没完成，就更别提启动了&lt;/li&gt;
&lt;li&gt;Running：运行中。&lt;/li&gt;
&lt;li&gt;Failed：失败。&lt;/li&gt;
&lt;li&gt;Successed: 有些状态时间很短。&lt;/li&gt;
&lt;li&gt;Unknown: 为什么会未知呢？因为所谓一个Pod处于什么状态，是apiserver跟运行这个Pod的节点上的kubelet通信来获取Pod的状态信息的。如果kubelet本身出故障了，那么很显然此时apiserver肯定连不上kubelet，也就得不到信息了。类似于这样&lt;br&gt;…&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;创建Pod经历的阶段：&lt;/strong&gt;&lt;br&gt;当用户创建Pod时，这个请求要提交给apiserver，apiserver先把创建请求的目标状态保存在etcd中，而后apiserver之后会请求Scheduler进行调度。如果调度成功了，会把调度结果保存在etcd中。随后目标节点，比如node01，node01上的kubelet通过apiserver当中的状态变化，就知道有一个新的任务给自己了。所以kubelet会通过apiserver拿到此前用户创建的清单，根据清单在当前节点上去创建启动这个Pod。然后将Pod的状态发回给apiserver，apiserver在更新到etcd中。&lt;br&gt;而Pod整个生命周期中有非常多的重要行为，如上面的图及分析。&lt;br&gt;Pod生命周期中的重要行为: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;初始化容器&lt;/li&gt;
&lt;li&gt;启动前钩子、结束前钩子&lt;/li&gt;
&lt;li&gt;容器探测: &lt;ul&gt;
&lt;li&gt;liveness&lt;/li&gt;
&lt;li&gt;readiness&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;restartPolicy: Pod的重启策略。&lt;/strong&gt;比如做liveness探测后发现容器挂了，Pod还在。此时容器要不要重启，要取决于这个字段。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Always：&lt;/li&gt;
&lt;li&gt;OnFailure：状态为错误时才会重启，正常停止是不重启的。&lt;/li&gt;
&lt;li&gt;Never.：从不重启，挂了就挂了。Default to Always.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;重启逻辑：第一次重启是一停止，就立即重启。第二次重启就要延时了，比如第二次重启是终止后等10s在重启。第三次重启等20s，第四次重启等40s…300s是最长的等待时间。为了防止不断重启给系统造成压力。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;restartPolicy        &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Restart policy for all containers within the pod. One of Always, OnFailure,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Never. Default to Always. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;当我们想终止某个Pod，我们应该对其平滑终止。这样才会确保数据不会丢失。比如MariaDB，我们想要结束这个Pod，强行kill掉有可能会导致数据丢失。因此在提交删除一个Pod的时候，它是不会上来就kill掉而删除的，而是像Pod内的每一个容器发送终止term信号，让Pod中的容器正常进行终止。这个终止会给个宽限期，比如30s。宽限期到了，那就只能发送kill信号了。Pod的宽限期一般是30s，可以自己指定时长。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Pod控制器资源配置清单重要字段详解&quot;&gt;&lt;a href=&quot;#Pod控制器资源配置清单重要字段详解&quot; class=&quot;headerlink&quot; title=&quot;Pod控制器资源配置清单重要字段详解&quot;&gt;&lt;/a&gt;Pod控制器资源配置清单重要字段详解&lt;/h2&gt;&lt;p&gt;资源的清单格式:&lt;br&gt;一级字段：apiVersion(group/version), kind, metadata(name,namespace,labels,annotations,…), spec, status(只读)&lt;br&gt;
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes资源清单定义</title>
    <link href="http://yoursite.com/2019/08/05/Kubernetes%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E5%AE%9A%E4%B9%89/"/>
    <id>http://yoursite.com/2019/08/05/Kubernetes资源清单定义/</id>
    <published>2019-08-05T00:54:38.000Z</published>
    <updated>2019-08-05T03:02:10.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;资源和对象&quot;&gt;&lt;a href=&quot;#资源和对象&quot; class=&quot;headerlink&quot; title=&quot;资源和对象&quot;&gt;&lt;/a&gt;资源和对象&lt;/h2&gt;&lt;p&gt;Kubernetes之上常用的资源，它把所有内容都抽象为资源，把资源实例化出来后称为对象。&lt;br&gt;&lt;strong&gt;Kubernetes核心资源：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;workload： 工作负载型资源，运行应用程序，对外提供服务。&lt;br&gt;Pod, ReplicaSet, Deployment, StatefulSet, DaemonSet, Job, Cronjob, … &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;跟服务发现及均衡相关：&lt;br&gt;Service, Ingress, …&lt;/li&gt;
&lt;li&gt;配置与存储相关：&lt;br&gt;Volume, CSI：还支持容器存储接口来对接第三方存储卷, ConfigMap, Secret, DownwardAPI&lt;/li&gt;
&lt;li&gt;集群级的资源：上面提到的都是配置在名称空间级别的资源。只不过没指都是default名称空间的。而有些资源需要在集群级别定义。&lt;br&gt;Namespace, Node, Role, ClusterRole, RoleBinding, ClusterRoleBinding&lt;/li&gt;
&lt;li&gt;元数据型资源：&lt;br&gt;HPA：能够自动去调整其他资源的元数据信息。&lt;br&gt;PodTemplate, LimitRange&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;资源清单示例&quot;&gt;&lt;a href=&quot;#资源清单示例&quot; class=&quot;headerlink&quot; title=&quot;资源清单示例&quot;&gt;&lt;/a&gt;资源清单示例&lt;/h2&gt;&lt;p&gt;在上一篇博文中，我们使用了命令去创建了一些资源。在创建这些资源时，除了使用命令去创建，还可以使用配置清单来创建。举例看看配置清单是什么样子的：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;96&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;97&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;98&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          2d15h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          2d18h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          2d18h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          2d18h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          2d19h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pod myapp-5bc569c47d-qq8lb -o yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  creationTimestamp: &amp;quot;2019-08-02T06:54:36Z&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  generateName: myapp-5bc569c47d-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    pod-template-hash: 5bc569c47d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    run: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: myapp-5bc569c47d-qq8lb&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ownerReferences:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - apiVersion: apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    blockOwnerDeletion: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    controller: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    kind: ReplicaSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name: myapp-5bc569c47d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    uid: f241ea22-b4eb-11e9-9e1c-60a44c223099&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  resourceVersion: &amp;quot;13132088&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selfLink: /api/v1/namespaces/default/pods/myapp-5bc569c47d-qq8lb&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  uid: 64232e79-b4f2-11e9-9e1c-60a44c223099&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    resources: &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    terminationMessagePath: /dev/termination-log&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    terminationMessagePolicy: File&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    volumeMounts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      name: default-token-wb7fl&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      readOnly: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  dnsPolicy: ClusterFirst&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  enableServiceLinks: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  nodeName: ubuntu31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  priority: 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  restartPolicy: Always&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  schedulerName: default-scheduler&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  securityContext: &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  serviceAccount: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  serviceAccountName: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  terminationGracePeriodSeconds: 30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  tolerations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - effect: NoExecute&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    key: node.kubernetes.io/not-ready&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    operator: Exists&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tolerationSeconds: 300&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - effect: NoExecute&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    key: node.kubernetes.io/unreachable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    operator: Exists&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tolerationSeconds: 300&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  volumes:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: default-token-wb7fl&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    secret:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      defaultMode: 420&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      secretName: default-token-wb7fl&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;status:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  conditions:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - lastProbeTime: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lastTransitionTime: &amp;quot;2019-08-02T06:54:46Z&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    status: &amp;quot;True&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    type: Initialized&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - lastProbeTime: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lastTransitionTime: &amp;quot;2019-08-02T06:54:49Z&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    status: &amp;quot;True&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    type: Ready&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - lastProbeTime: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lastTransitionTime: &amp;quot;2019-08-02T06:54:49Z&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    status: &amp;quot;True&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    type: ContainersReady&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - lastProbeTime: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lastTransitionTime: &amp;quot;2019-08-02T06:54:36Z&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    status: &amp;quot;True&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    type: PodScheduled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containerStatuses:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - containerID: docker://bebf87f526684a20413175bce9f9aa2382bd000ef5b9446c49e390d585e04db8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imageID: docker-pullable://ikubernetes/myapp@sha256:9c3dc30b5219788b2b8a4b065f548b922a34479577befb54b03330999d30d513&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lastState: &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ready: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    restartCount: 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    state:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      running:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        startedAt: &amp;quot;2019-08-02T06:54:48Z&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  hostIP: 172.16.206.31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  phase: Running&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  podIP: 10.244.2.12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  qosClass: BestEffort&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  startTime: &amp;quot;2019-08-02T06:54:46Z&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【说明】：&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;apiVersion: v1&lt;/strong&gt;&lt;br&gt;指定该对象属于k8s的哪个api版本，或者叫api组。这叫api群组的名称和版本。我们给定apiversion时有两个部分组成，group/version。如果group省略，表示core，核心组，最根本的资源。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;kind: Pod&lt;/strong&gt;&lt;br&gt;资源类别，Pod、控制器、service都是资源。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;metadata：&lt;/strong&gt;&lt;br&gt;元数据。内部嵌套了很多二级字段，甚至三级字段来定义。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;spec:&lt;/strong&gt;&lt;br&gt;可以理解为“规格”。我们要去定义接下来要创建的资源对象应该具有什么样的特性，或者应该满足什么样的规范。比如说容器有几个，每个容器应该用什么镜像文件来创建。包括它的容忍度，能容忍哪些污点。这也是资源对象中一个最重要的字段，因为它正是用来定义我们所期望的资源应该拥有什么样的特性。而后靠控制器来确保它的特性能够被满足。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;status:&lt;/strong&gt;&lt;br&gt;spec用来让用户定义一个资源对象应该所处的目标状态。而status则是显示当前这个资源的当前状态。如果当前状态和目标状态不一样怎么办？应该以目标状态为准。k8s保证当前状态无限向目标状态靠近或转移从而能满足用户期望。因此从这个角度讲，status应该是只读的，因为会动态维护。而spec是用户定义的。&lt;/p&gt;
&lt;h2 id=&quot;创建资源的方法&quot;&gt;&lt;a href=&quot;#创建资源的方法&quot; class=&quot;headerlink&quot; title=&quot;创建资源的方法&quot;&gt;&lt;/a&gt;创建资源的方法&lt;/h2&gt;&lt;p&gt;1.在定义资源时，apiserver仅接收JSON格式的资源定义；&lt;br&gt;之前通过kubectl run创建一个deployment的时候，run命令被自动把我们给的内容转成了JSON格式而已。但JSON格式写起来太重量级了，而yaml格式几乎没有冗余数据。人更容易理解和记忆的是yaml格式的。&lt;/p&gt;
&lt;p&gt;2.提供yaml格式的配置清单&lt;br&gt;apiserver可自动将其转为JSON格式，而后在执行。JSON格式对于apiserver才是根本。&lt;/p&gt;
&lt;h2 id=&quot;资源的配置清单详解&quot;&gt;&lt;a href=&quot;#资源的配置清单详解&quot; class=&quot;headerlink&quot; title=&quot;资源的配置清单详解&quot;&gt;&lt;/a&gt;资源的配置清单详解&lt;/h2&gt;&lt;p&gt;大部分资源的配置清单都有5个一级字段组成：&lt;/p&gt;
&lt;h3 id=&quot;apiVersion-group-version&quot;&gt;&lt;a href=&quot;#apiVersion-group-version&quot; class=&quot;headerlink&quot; title=&quot;apiVersion: group/version&quot;&gt;&lt;/a&gt;apiVersion: group/version&lt;/h3&gt;&lt;p&gt;api版本。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# kubectl api-versions&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;admissionregistration.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiextensions.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiregistration.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiregistration.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apps/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apps/v1beta2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;authentication.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;authentication.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;authorization.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;authorization.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;autoscaling/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;autoscaling/v2beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;autoscaling/v2beta2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;batch/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;batch/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;certificates.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coordination.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coordination.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;events.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;networking.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;networking.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;policy/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rbac.authorization.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rbac.authorization.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;scheduling.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;scheduling.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;storage.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;storage.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;v1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;资源所属群组，k8s把apiserver中所支持的api有多少种，分组来管理。&lt;br&gt;分组的好处是：如果不分组，假设将来要更新一个，牵一发而动全身。而现在分成组以后，如果某一组当中的改变了，我们只需要改这一个组就可以了，其他组不受影响，可以继续使用。另外，组还加了版本号，同一个群组的多个不同版本还可以并存。Pod是最核心的资源，所以属于核心群组v1。像控制器Deployment、ReplicaSet等属于应用程序管理的资源，属于群组apps/v1。在创建Deployment的时候，可以使用apps/v1，也可以使用apps/v1beta1，或者apps/v1beta2。如果某一组标记为beta，意味着属于公测版。不同的版本，对于同一个资源来讲，可支持的字段有可能是不一样的。&lt;/p&gt;
&lt;h3 id=&quot;kind&quot;&gt;&lt;a href=&quot;#kind&quot; class=&quot;headerlink&quot; title=&quot;kind&quot;&gt;&lt;/a&gt;kind&lt;/h3&gt;&lt;p&gt;资源类别&lt;/p&gt;
&lt;h3 id=&quot;metadata&quot;&gt;&lt;a href=&quot;#metadata&quot; class=&quot;headerlink&quot; title=&quot;metadata&quot;&gt;&lt;/a&gt;metadata&lt;/h3&gt;&lt;p&gt;元数据&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;name，对象名称&lt;/li&gt;
&lt;li&gt;namespace: 对象属于哪个名称空间的&lt;/li&gt;
&lt;li&gt;labels：标签&lt;/li&gt;
&lt;li&gt;annotation：资源注解&lt;/li&gt;
&lt;li&gt;uid：系统自己生成的，不要自己去定义。自己去定义有可能冲突。&lt;/li&gt;
&lt;li&gt;每个资源的引用PATH：基于HTPP&lt;br&gt;/api/GROUP/VERSION/namespaces/NAMESPACE/TYPE/NAME&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/64.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;spec&quot;&gt;&lt;a href=&quot;#spec&quot; class=&quot;headerlink&quot; title=&quot;spec&quot;&gt;&lt;/a&gt;spec&lt;/h3&gt;&lt;p&gt;期望的状态。disired state。&lt;br&gt;不同的资源类型，spec中所需要嵌套的字段不尽相同。字段这么多，我们可能无法全部记下来，可以通过命令行来查看文档。比如查看Pod清单定义文档：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/65.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.metadata&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/66.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.spec&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/67.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.spec.containers&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/68.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/69.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;status&quot;&gt;&lt;a href=&quot;#status&quot; class=&quot;headerlink&quot; title=&quot;status&quot;&gt;&lt;/a&gt;status&lt;/h3&gt;&lt;p&gt;资源当前状态，current state。&lt;br&gt;该字段由Kubernetes集群维护，用户不能定义和删除。&lt;/p&gt;
&lt;h2 id=&quot;清单定义示例&quot;&gt;&lt;a href=&quot;#清单定义示例&quot; class=&quot;headerlink&quot; title=&quot;清单定义示例&quot;&gt;&lt;/a&gt;清单定义示例&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# mkdir manifests&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# cd manifests/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim pod-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-demo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: busybox&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: busybox:latest&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    command:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - &amp;quot;/bin/sh&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - &amp;quot;-c&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - &amp;quot;sleep 3600&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/70.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;【说明】：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;containers的值是个对象列表，列表我们使用 []  或者 - 来引导。&lt;br&gt;容器名、容器镜像。一个pod内可以有多个容器。&lt;/li&gt;
&lt;li&gt;对于busybox这个镜像启动起来运行的命令是shell，启动起来一会就挂了，所以需要需要额外改个命令来运行，使用command。command是个列表，可以使用[]，也可以使用 - 来引导。对于第一个镜像没有加command，表示运行镜像启动后默认的命令。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/71.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;访问myapp服务：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE     IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          2d16h   10.244.2.27   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          2d19h   10.244.2.12   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          2d19h   10.244.2.13   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          2d19h   10.244.1.9    spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          2d21h   10.244.1.5    spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                       2/2     Running   0          12m     10.244.2.28   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# curl 10.244.2.28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v1 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看日志：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/72.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;进入Pod中的myapp容器：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/73.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;删除这个Pod：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete pod pod-demo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-demo&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -w&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS        RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running       1          2d17h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running       0          2d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running       0          2d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running       0          2d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running       0          2d21h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                       2/2     Terminating   0          19m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                       0/2     Terminating   0          19m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                       0/2     Terminating   0          19m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                       0/2     Terminating   0          19m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                       0/2     Terminating   0          19m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再次创建这个Pod：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f pod-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;删除这个清单文件中定义的资源：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete -f pod-demo.yaml       &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-demo&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这个文件里定义的资源Pod是“自主式Pod”，不受任何控制器控制的，这种Pod一删除就没了。不像控制器控制的Pod，哪怕删了，也会根据副本数量进行重新创建。&lt;/p&gt;
&lt;h2 id=&quot;kubectl管理资源的方式&quot;&gt;&lt;a href=&quot;#kubectl管理资源的方式&quot; class=&quot;headerlink&quot; title=&quot;kubectl管理资源的方式&quot;&gt;&lt;/a&gt;kubectl管理资源的方式&lt;/h2&gt;&lt;p&gt;有三种方式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;命令式&lt;/li&gt;
&lt;li&gt;刚刚上面演示的配置清单式&lt;/li&gt;
&lt;li&gt;第三种也是清单，但要使用另外的命令。和第二种方式的区别为：第二种叫命令式资源清单，第三种叫声明式资源清单。使用声明式，我们可以确保资源尽可能地像我们声明的状态改变，而且可以随时改变我们的声明，并随时应用。后面的博文中将介绍使用声明式方式创建资源。&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;资源和对象&quot;&gt;&lt;a href=&quot;#资源和对象&quot; class=&quot;headerlink&quot; title=&quot;资源和对象&quot;&gt;&lt;/a&gt;资源和对象&lt;/h2&gt;&lt;p&gt;Kubernetes之上常用的资源，它把所有内容都抽象为资源，把资源实例化出来后称为对象。&lt;br&gt;&lt;strong&gt;Kubernetes核心资源：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;workload： 工作负载型资源，运行应用程序，对外提供服务。&lt;br&gt;Pod, ReplicaSet, Deployment, StatefulSet, DaemonSet, Job, Cronjob, …
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes应用快速入门</title>
    <link href="http://yoursite.com/2019/08/02/kubernetes%E5%BA%94%E7%94%A8%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
    <id>http://yoursite.com/2019/08/02/kubernetes应用快速入门/</id>
    <published>2019-08-02T02:13:30.000Z</published>
    <updated>2019-08-16T08:22:41.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;kubectl简介&quot;&gt;&lt;a href=&quot;#kubectl简介&quot; class=&quot;headerlink&quot; title=&quot;kubectl简介&quot;&gt;&lt;/a&gt;kubectl简介&lt;/h2&gt;&lt;p&gt;API Server是Kubernetes集群的网关，任何人只能通过API Server接口与集群进行交互。而kubectl是Kubernetes的终端客户端，此前博客里讲解的使用kubeadm初始化Kubernetes集群时，&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;kubeadm init自动生成的/etc/kubernetes/admin.conf是kubectl接入k8s集群时使用的kubeconfig配置文件，它内建了用于访问Kubernetes集群的最高管理权限的用户账号及相关的认证凭据。&lt;br&gt;kubectl提供了基于命令行访问Kubernetes API的简洁方式，能够满足对Kubernetes的绝大部分的操作需求。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/42.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/43.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;taint：&lt;/strong&gt;污点。taint是跟高级调度相关的，给节点增加污点以后，能容忍这污点的pod就可以调度到这个节点上，否则就不能调度上来。其实master上就有很多的污点，这就是为什么我们创建pod不会调度到master节点上。因为默认创建的所有pod都无法容忍master的污点。这样确保了master只用于运行apiserver等组件。我们在定义pod时可以定义容忍度(tolerance)。&lt;br&gt;查看master节点上的污点：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get nodes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       STATUS   ROLES    AGE    VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark17    Ready    &amp;lt;none&amp;gt;   111d   v1.14.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32    Ready    master   111d   v1.14.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ubuntu31   Ready    &amp;lt;none&amp;gt;   111d   v1.14.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl describe node spark32&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/44.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;查看node上有没有污点：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/45.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;查看集群信息和集群组件状态信息：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/46.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;kubectl增删改查&quot;&gt;&lt;a href=&quot;#kubectl增删改查&quot; class=&quot;headerlink&quot; title=&quot;kubectl增删改查&quot;&gt;&lt;/a&gt;kubectl增删改查&lt;/h2&gt;&lt;h3 id=&quot;示例1：创建一个Nginx的Pod&quot;&gt;&lt;a href=&quot;#示例1：创建一个Nginx的Pod&quot; class=&quot;headerlink&quot; title=&quot;示例1：创建一个Nginx的Pod&quot;&gt;&lt;/a&gt;示例1：创建一个Nginx的Pod&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/47.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl run nginx-deploy --image=nginx:1.14-alpine --port=80 --replicas=1 --dry-run=true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/nginx-deploy created (dry run)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You have mail in /var/spool/mail/root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl run nginx-deploy --image=nginx:1.14-alpine --port=80 --replicas=1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/nginx-deploy created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME           READY   UP-TO-DATE   AVAILABLE   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy   1/1     1            1           8s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-bh8z5   1/1     Running   0          26s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-bh8z5   1/1     Running   0          35s   10.244.2.5   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;【说明】：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;–dry-run=true：干跑模式，并没有真正运行&lt;/li&gt;
&lt;li&gt;–port=80：不指定这个也会暴露容器中的相应端口&lt;/li&gt;
&lt;li&gt;默认创建的是其实是Deployment，如果想创建一个Pod，而不是想要创建由Deployment控制器控制的pod，可以在创建命令上加一个–restart=…&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# kubectl run nginx --image=nginx:1.14-alpine --port=80 --restart=Never&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/nginx created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/48.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/49.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;这是Pod的地址，只能在k8s集群内使用。Pod的客户端一般有两类：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;其他Pod&lt;/li&gt;
&lt;li&gt;集群外部客户端：怎么访问？&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Pod地址可能会变化的，假设我们误删除了pod：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@spark32 ~]# kubectl get pods
NAME                           READY   STATUS    RESTARTS   AGE
nginx-deploy-55d8d67cf-bh8z5   1/1     Running   0          9m10s
[root@spark32 ~]# kubectl delete pods nginx-deploy-55d8d67cf-bh8z5
pod &amp;quot;nginx-deploy-55d8d67cf-bh8z5&amp;quot; deleted
[root@spark32 ~]# kubectl get pods -o wide
NAME                           READY   STATUS    RESTARTS   AGE   IP           NODE      NOMINATED NODE   READINESS GATES
nginx-deploy-55d8d67cf-qrd2s   1/1     Running   0          11s   10.244.1.4   spark17   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;删除了pod，控制器Deployment发现副本少了一个，会自动创建一个。但是这个新Pod的IP地址已经变了，跑到另外一个node主机上去了。&lt;br&gt;在上一篇博文中，提到了需要在Pod前创建一个service，让service关联到Pod上。这样用户在访问时只需要访问service的地址或名称，只要service不被删除，后端的Pod因为各种原因被终止掉或删除掉后重新创建后，哪怕IP地址变了也没什么关系。&lt;/p&gt;
&lt;h3 id=&quot;示例2：创建service&quot;&gt;&lt;a href=&quot;#示例2：创建service&quot; class=&quot;headerlink&quot; title=&quot;示例2：创建service&quot;&gt;&lt;/a&gt;示例2：创建service&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl expose --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --type=&amp;apos;&amp;apos;: Type for this service: ClusterIP, NodePort, LoadBalancer, or ExternalName. Default is &amp;apos;ClusterIP&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl expose (-f FILENAME | TYPE NAME) [--port=port] [--protocol=TCP|UDP|SCTP] [--target-port=number-or-name]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[--name=name] [--external-ip=external-ip-of-service] [--type=type] [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;【说明】：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;–type=’’：指定service类型。service类型有4种，默认是ClusterIP。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl expose deployment nginx-deploy --name=nginx --port=80 --target-port=80 --protocol=TCP&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/nginx exposed&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You have mail in /var/spool/mail/root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   ClusterIP   10.96.0.1        &amp;lt;none&amp;gt;        443/TCP   111d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx        ClusterIP   10.109.152.170   &amp;lt;none&amp;gt;        80/TCP    10s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/50.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;【说明】：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;svc是service的简称&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;通过service访问服务：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# curl 10.109.152.170&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;title&amp;gt;Welcome to nginx!&amp;lt;/title&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;style&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    body &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        width: 35em;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        margin: 0 auto;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        font-family: Tahoma, Verdana, Arial, sans-serif;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/style&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;h1&amp;gt;Welcome to nginx!&amp;lt;/h1&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;If you see this page, the nginx web server is successfully installed and&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;working. Further configuration is required.&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;For online documentation and support please refer to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;a href=&amp;quot;http://nginx.org/&amp;quot;&amp;gt;nginx.org&amp;lt;/a&amp;gt;.&amp;lt;br/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Commercial support is available at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;a href=&amp;quot;http://nginx.com/&amp;quot;&amp;gt;nginx.com&amp;lt;/a&amp;gt;.&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;&amp;lt;em&amp;gt;Thank you for using nginx.&amp;lt;/em&amp;gt;&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/html&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;外部节点，是无法通过service这个地址来访问这个服务的。&lt;br&gt;更多的时候，这个service地址是被Pod客户端来访问的，而且被访问时是完全可以基于service名称来访问。只不过需要Pod客户端可以解析名称，这就需要用到CoreDNS服务。之前的博文《kubeadm安装kubernetes 1.14.0》里安装集群时已经把CoreDNS这个附件安装好了。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/51.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;创建个Pod，作为客户端：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl run client --image=busybox --replicas=1 -it --restart=Never&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;If you don&amp;apos;t see a command prompt, try pressing enter.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # cat /etc/resolv.conf &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nameserver 10.96.0.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;search default.svc.cluster.local svc.cluster.local cluster.local&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;options ndots:5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # nslookup nginx.default.svc.cluster.local&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Server:         10.96.0.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Address:        10.96.0.10:53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;*** Can&amp;apos;t find nginx.default.svc.cluster.local: No answer&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # ping nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;PING nginx (10.109.152.170): 56 data bytes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;^C&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;--- nginx ping statistics ---&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5 packets transmitted, 0 packets received, 100% packet loss&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # wget -O - -q nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;title&amp;gt;Welcome to nginx!&amp;lt;/title&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;style&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    body &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        width: 35em;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        margin: 0 auto;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        font-family: Tahoma, Verdana, Arial, sans-serif;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/style&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;h1&amp;gt;Welcome to nginx!&amp;lt;/h1&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;If you see this page, the nginx web server is successfully installed and&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;working. Further configuration is required.&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;For online documentation and support please refer to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;a href=&amp;quot;http://nginx.org/&amp;quot;&amp;gt;nginx.org&amp;lt;/a&amp;gt;.&amp;lt;br/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Commercial support is available at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;a href=&amp;quot;http://nginx.com/&amp;quot;&amp;gt;nginx.com&amp;lt;/a&amp;gt;.&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;&amp;lt;em&amp;gt;Thank you for using nginx.&amp;lt;/em&amp;gt;&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # curl nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sh: curl: not found&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;【说明】：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pod中的默认DNS就是CoreDNS service的地址。&lt;/li&gt;
&lt;li&gt;svc.cluster.local：这是特殊的域名，表示是你的Kubernetes集群的本地Pod资源，特定后缀。&lt;/li&gt;
&lt;li&gt;default：Pod所属于的名称空间的名称。&lt;/li&gt;
&lt;li&gt;ping nginx，解析到的IP地址10.109.152.170是nginx这个service的IP地址，至于为什么ping不通，是因为service的地址仅仅是存在于iptables规则或ipvs规则中。&lt;/li&gt;
&lt;li&gt;在Pod中可以使用service名称来访问，因为有DNS可以解析service的名称&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们可以在节点上解析这个service名称：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# dig -t A nginx.default.svc.cluster.local @10.96.0.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;; &amp;lt;&amp;lt;&amp;gt;&amp;gt; DiG 9.9.4-RedHat-9.9.4-29.el7 &amp;lt;&amp;lt;&amp;gt;&amp;gt; -t A nginx.default.svc.cluster.local @10.96.0.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; global options: +cmd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; Got answer:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; -&amp;gt;&amp;gt;HEADER&amp;lt;&amp;lt;- opcode: QUERY, status: NOERROR, id: 53679&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; WARNING: recursion requested but not available&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; OPT PSEUDOSECTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;; EDNS: version: 0, flags:; udp: 4096&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; QUESTION SECTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;nginx.default.svc.cluster.local. IN    A&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; ANSWER SECTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx.default.svc.cluster.local. 5 IN   A       10.109.152.170&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; Query time: 0 msec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; SERVER: 10.96.0.10#53(10.96.0.10)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; WHEN: Fri Aug 02 13:37:22 CST 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; MSG SIZE  rcvd: 107&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;【注意】：在节点级解析service时需要输入service名称的全程，而不能仅仅使用service的简称来解析，因为节点级别的搜索域和Pod内的搜索域是不一样的。&lt;/p&gt;
&lt;p&gt;这个service调度给我们之前创建的Pod了，service给有生命周期的Pod提供了固定访问的端点。我们现在人为把nginx Pod搞挂。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/52.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;接着在Pod客户端再次访问下service：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/53.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;当一个service生成时，会在每个节点上生成相应的iptables规则或ipvs规则，当客户端访问这个service地址和相应的端口时，就会调度到这个service利用标签选择器关联到的Pod了。&lt;br&gt;在上面的示例中，会把所有访问10.109.152.170:80这个地址的都调度至这个service用label-selector(标签选择器)关联到的各Pod后端。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/54.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;当我们修改这个service或者删除这个service再重新建个service，会立刻反应到CoreDNS的解析记录中去。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl delete svc nginx    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service &amp;quot;nginx&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl expose deployment nginx-deploy --name=nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/nginx exposed&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   ClusterIP   10.96.0.1        &amp;lt;none&amp;gt;        443/TCP   111d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx        ClusterIP   10.107.191.247   &amp;lt;none&amp;gt;        80/TCP    44s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;service对应的IP已经改变了，我们在Pod客户端里再测试下访问这个service，发现仍然可以根据service名称访问：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;/ # wget -O - -q nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;title&amp;gt;Welcome to nginx!&amp;lt;/title&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;style&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    body &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        width: 35em;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        margin: 0 auto;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        font-family: Tahoma, Verdana, Arial, sans-serif;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/style&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;h1&amp;gt;Welcome to nginx!&amp;lt;/h1&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;If you see this page, the nginx web server is successfully installed and&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;working. Further configuration is required.&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;For online documentation and support please refer to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;a href=&amp;quot;http://nginx.org/&amp;quot;&amp;gt;nginx.org&amp;lt;/a&amp;gt;.&amp;lt;br/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Commercial support is available at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;a href=&amp;quot;http://nginx.com/&amp;quot;&amp;gt;nginx.com&amp;lt;/a&amp;gt;.&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;&amp;lt;em&amp;gt;Thank you for using nginx.&amp;lt;/em&amp;gt;&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/html&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例3：副本&quot;&gt;&lt;a href=&quot;#示例3：副本&quot; class=&quot;headerlink&quot; title=&quot;示例3：副本&quot;&gt;&lt;/a&gt;示例3：副本&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl run myapp --image=ikubernetes/myapp:v1 --replicas=2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/myapp created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME           READY   UP-TO-DATE   AVAILABLE   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp          2/2     2            2           15s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy   1/1     1            1           171m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/55.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;通过Pod IP访问下服务：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# curl 10.244.2.7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v1 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;为这个deploy创建一个service：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl expose deploy myapp --name=myapp --port=80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/myapp exposed&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   ClusterIP   10.96.0.1        &amp;lt;none&amp;gt;        443/TCP   111d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp        ClusterIP   10.109.204.135   &amp;lt;none&amp;gt;        80/TCP    4s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx        ClusterIP   10.107.191.247   &amp;lt;none&amp;gt;        80/TCP    17m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在Pod中访问这个服务：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;/ # wget -O - -q 10.244.2.7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v1 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # wget -O - -q myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v1 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # while true; do wget -O - -q myapp/hostname.html; sleep 1; done&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-mkdqg&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qht8j&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qht8j&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qht8j&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-mkdqg&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-mkdqg&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例4：扩展和缩减副本&quot;&gt;&lt;a href=&quot;#示例4：扩展和缩减副本&quot; class=&quot;headerlink&quot; title=&quot;示例4：扩展和缩减副本&quot;&gt;&lt;/a&gt;示例4：扩展和缩减副本&lt;/h3&gt;&lt;p&gt;接着上面的示例，我们扩展myapp这个deployment中的副本。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl scale --replicas=5 deploy myapp &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp scaled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client                         1/1     Running   0          63m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-9sbwq         1/1     Running   0          5s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-cmgsl         1/1     Running   0          5s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-mkdqg         1/1     Running   0          17m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qht8j         1/1     Running   0          17m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-wv7sw         1/1     Running   0          5s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          40m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl scale --replicas=3 deploy myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp scaled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS        RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client                         1/1     Running       0          64m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-9sbwq         0/1     Terminating   0          26s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-cmgsl         1/1     Running       0          26s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-mkdqg         1/1     Running       0          17m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qht8j         1/1     Running       0          17m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-wv7sw         0/1     Terminating   0          26s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running       0          40m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client                         1/1     Running   0          64m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-cmgsl         1/1     Running   0          30s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-mkdqg         1/1     Running   0          17m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qht8j         1/1     Running   0          17m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          40m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;【说明】：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Terminating：表示正在终止Pod。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;示例5：滚动更新程序&quot;&gt;&lt;a href=&quot;#示例5：滚动更新程序&quot; class=&quot;headerlink&quot; title=&quot;示例5：滚动更新程序&quot;&gt;&lt;/a&gt;示例5：滚动更新程序&lt;/h3&gt;&lt;p&gt;除了以上的动态伸缩，还可以做滚动更新。比如将myapp从v1滚动更新到v2。比如现在有3个Pod，它会先替换1个，在替换1个，在替换1个。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl set image --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl set image (-f FILENAME | TYPE NAME) CONTAINER_NAME_1=CONTAINER_IMAGE_1 ... CONTAINER_NAME_N=CONTAINER_IMAGE_N&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看当前Pod所使用的image镜像版本：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/56.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl set image deploy myapp myapp=ikubernetes/myapp:v2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp image updated&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout status deploy myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 1 out of 3 new replicas have been updated...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 1 out of 3 new replicas have been updated...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 1 out of 3 new replicas have been updated...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 2 out of 3 new replicas have been updated...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 2 out of 3 new replicas have been updated...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 2 out of 3 new replicas have been updated...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 1 old replicas are pending termination...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 1 old replicas are pending termination...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment &amp;quot;myapp&amp;quot; successfully rolled out&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]#&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在Pod中访问下服务，已经全部变为v2版本了：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;/ # while true; do wget -O - -q myapp; sleep 1; done&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v2 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v2 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v2 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v2 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v2 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v2 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例6：回滚&quot;&gt;&lt;a href=&quot;#示例6：回滚&quot; class=&quot;headerlink&quot; title=&quot;示例6：回滚&quot;&gt;&lt;/a&gt;示例6：回滚&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/57.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/58.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout undo deploy myapp     &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp rolled back&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/59.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;如果需要在集群外部访问myapp，需要修改service类型为NodePort。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   ClusterIP   10.96.0.1        &amp;lt;none&amp;gt;        443/TCP   111d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp        ClusterIP   10.109.204.135   &amp;lt;none&amp;gt;        80/TCP    40m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx        ClusterIP   10.107.191.247   &amp;lt;none&amp;gt;        80/TCP    58m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl edit svc myapp&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/60.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;【注意】：kubectl edit在编辑资源时，有些字段是不能这样修改的，后面在写yaml清单文件会介绍。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/61.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;打开浏览器，访问集群任何一个Node的30020端口：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/62.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;但是假如这个Node挂了，对客户端来说就不友好了，它得改地址为其他的Node地址。所以最好手工在集群外做个物理的负载均衡器。&lt;/p&gt;
&lt;p&gt;service到底是什么？&lt;br&gt;service是在集群每个节点上生成的iptables规则或者ipvs规则。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# iptables -L -n -v -t nat&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/63.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;kubectl简介&quot;&gt;&lt;a href=&quot;#kubectl简介&quot; class=&quot;headerlink&quot; title=&quot;kubectl简介&quot;&gt;&lt;/a&gt;kubectl简介&lt;/h2&gt;&lt;p&gt;API Server是Kubernetes集群的网关，任何人只能通过API Server接口与集群进行交互。而kubectl是Kubernetes的终端客户端，此前博客里讲解的使用kubeadm初始化Kubernetes集群时，
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
</feed>
