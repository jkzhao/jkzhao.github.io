<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>jkzhao&#39;s blog</title>
  <subtitle>学习 总结 思考</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2019-08-16T06:56:44.000Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Zhao Jiankai</name>
    <email>jk.zhaocoder@gmail.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Kubernetes Pod控制器-Deployment、DaemonSet</title>
    <link href="http://yoursite.com/2019/08/14/Kubernetes-Pod%E6%8E%A7%E5%88%B6%E5%99%A8-Deployment%E3%80%81DaemonSet/"/>
    <id>http://yoursite.com/2019/08/14/Kubernetes-Pod控制器-Deployment、DaemonSet/</id>
    <published>2019-08-14T05:18:01.000Z</published>
    <updated>2019-08-16T06:56:44.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Deployment&quot;&gt;&lt;a href=&quot;#Deployment&quot; class=&quot;headerlink&quot; title=&quot;Deployment&quot;&gt;&lt;/a&gt;Deployment&lt;/h2&gt;&lt;p&gt;简称deploy。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DEPRECATED - This group version of Deployment is deprecated by&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     apps/v1beta2/Deployment. See the release notes for more information.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Deployment enables declarative updates for Pods and ReplicaSets.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   apiVersion   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     APIVersion defines the versioned schema of this representation of an&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     object. Servers should convert recognized schemas to the latest internal&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     value, and may reject unrecognized values. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#resources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   kind &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Kind is a string value representing the REST resource this object&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     represents. Servers may infer this from the endpoint the client submits&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     requests to. Cannot be updated. In CamelCase. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   metadata     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Standard object metadata.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Specification of the desired behavior of the Deployment.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   status       &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Most recently observed status of the Deployment.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;一级字段依然是5个。其中，version最新的是apps/v1，文档里显示的版本是落后的。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain deploy.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Specification of the desired behavior of the Deployment.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DeploymentSpec is the specification of the desired behavior of the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Deployment.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   minReadySeconds      &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Minimum number of seconds for which a newly created pod should be ready&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     without any of its container crashing, for it to be considered available.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Defaults to 0 (pod will be considered available as soon as it is ready)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   paused       &amp;lt;boolean&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Indicates that the deployment is paused and will not be processed by the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     deployment controller.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   progressDeadlineSeconds      &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The maximum time in seconds for a deployment to make progress before it is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     considered to be failed. The deployment controller will continue to process&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     failed deployments and a condition with a ProgressDeadlineExceeded reason&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     will be surfaced in the deployment status. Note that progress will not be&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     estimated during the time a deployment is paused. This is set to the max&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     value of int32 (i.e. 2147483647) by default, which means &amp;quot;no deadline&amp;quot;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   replicas     &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Number of desired pods. This is a pointer to distinguish between explicit&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     zero and not specified. Defaults to 1.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   revisionHistoryLimit &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The number of old ReplicaSets to retain to allow rollback. This is a&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     pointer to distinguish between explicit zero and not specified. This is set&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     to the max value of int32 (i.e. 2147483647) by default, which means&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &amp;quot;retaining all old RelicaSets&amp;quot;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   rollbackTo   &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DEPRECATED. The config this deployment is rolling back to. Will be cleared&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     after rollback is done.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   selector     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Label selector for pods. Existing ReplicaSets whose pods are selected by&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     this will be the ones affected by this deployment.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   strategy     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The deployment strategy to use to replace existing pods with new ones.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   template     &amp;lt;Object&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Template describes the pods that will be created.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;deploy.spec下可定义的字段比rs.spec的要多。其中最重要的一个字段是 &lt;strong&gt;strategy&lt;/strong&gt;。这个字段用来定义更新策略，滚动更新只是其中的一个策略。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain deploy.spec.strategy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: strategy &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The deployment strategy to use to replace existing pods with new ones.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DeploymentStrategy describes how to replace existing pods with new ones.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   rollingUpdate        &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Rolling update config params. Present only if DeploymentStrategyType =&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RollingUpdate.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   type &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Type of deployment. Can be &amp;quot;Recreate&amp;quot; or &amp;quot;RollingUpdate&amp;quot;. Default is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RollingUpdate.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;type：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Recreate：你删除一个Pod，它就创建1个新的Pod。&lt;/li&gt;
&lt;li&gt;RollingUpdate：滚动更新。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果清单文件中定义type的值为RollingUpdate，还可以使用rollingUpdate来定义滚动更新的更新方式的。说白了就是控制更新粒度。比如在更新期间，Pod最多能比清单中定义的期望状态多几个，能少几个。如果type是Recreate，rollingUpdate这个字段就没有用了&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain deploy.spec.strategy.rollingUpdate&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: rollingUpdate &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Rolling update config params. Present only if DeploymentStrategyType =&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RollingUpdate.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Spec to control the desired behavior of rolling update.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   maxSurge     &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The maximum number of pods that can be scheduled above the desired number&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     of pods. Value can be an absolute number (ex: 5) or a percentage of desired&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     pods (ex: 10%). This can not be 0 if MaxUnavailable is 0. Absolute number&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     is calculated from percentage by rounding up. By default, a value of 1 is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     used. Example: when this is set to 30%, the new RC can be scaled up&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     immediately when the rolling update starts, such that the total number of&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     old and new pods do not exceed 130% of desired pods. Once old pods have&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     been killed, new RC can be scaled up further, ensuring that total number of&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     pods running at any time during the update is at most 130% of desired pods.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   maxUnavailable       &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The maximum number of pods that can be unavailable during the update. Value&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     can be an absolute number (ex: 5) or a percentage of desired pods (ex:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     10%). Absolute number is calculated from percentage by rounding down. This&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     can not be 0 if MaxSurge is 0. By default, a fixed value of 1 is used.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Example: when this is set to 30%, the old RC can be scaled down to 70% of&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     desired pods immediately when the rolling update starts. Once new pods are&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ready, old RC can be scaled down further, followed by scaling up the new&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     RC, ensuring that the total number of pods available at all times during&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the update is at least 70% of desired pods.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;rollingUpdate可定义两个字段，maxSurge和maxUnavailable。这两个值不能同时为0，可以同时为正，或者一个为正，一个为0。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;maxSurge: 能多出期望Pod数量几个，可以直接使用数字，或百分比。&lt;/li&gt;
&lt;li&gt;maxUnavailable: 最多比期望Pod数量少几个，可以使用数字或百分比。比如该值定义为1，期望为5，那么至少要保证有4个Pod可用。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;再看看deploy.spec比rs.spec中多的几个其他字段：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;revisionHistoryLimit &lt;integer&gt;&lt;br&gt;做滚动更新后，最多在历史中保存过去多少个历史版本。默认是10个。&lt;/integer&gt;&lt;/li&gt;
&lt;li&gt;paused       &lt;boolean&gt;&lt;br&gt;当启动更新后，没有立即更新，而是一启动就让它暂停了。一般而言默认都是不暂停的，上来就更新。&lt;/boolean&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;Deploy示例&quot;&gt;&lt;a href=&quot;#Deploy示例&quot; class=&quot;headerlink&quot; title=&quot;Deploy示例&quot;&gt;&lt;/a&gt;Deploy示例&lt;/h2&gt;&lt;h3 id=&quot;示例1：声明式创建deploy&quot;&gt;&lt;a href=&quot;#示例1：声明式创建deploy&quot; class=&quot;headerlink&quot; title=&quot;示例1：声明式创建deploy&quot;&gt;&lt;/a&gt;示例1：声明式创建deploy&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim deploy-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: myapp-deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  replicas: 2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    matchLabels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  template:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f deploy-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/myapp-deploy created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/100.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/101.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例2：更新&quot;&gt;&lt;a href=&quot;#示例2：更新&quot; class=&quot;headerlink&quot; title=&quot;示例2：更新&quot;&gt;&lt;/a&gt;示例2：更新&lt;/h3&gt;&lt;p&gt;deploy在实现更新应用时，可以直接通过编辑清单文件来实现或者patch打补丁(使用JSON格式给定补丁信息)实现，比如从副本数从2个改成3个。默认是滚动更新，见下图。如果只是更新镜像文件的，可以使用kubectl set image。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/102.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;通过编辑清单文件更新&quot;&gt;&lt;a href=&quot;#通过编辑清单文件更新&quot; class=&quot;headerlink&quot; title=&quot;通过编辑清单文件更新&quot;&gt;&lt;/a&gt;通过编辑清单文件更新&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim deploy-demo.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/103.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f deploy-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/myapp-deploy configured&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-knspq   1/1     Running   0          12m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-qz9kc   1/1     Running   0          5s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-xkgpt   1/1     Running   0          12m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;已经变成3个Pod了。67b6dfcd8这个值依然没变，因为我们没有修改模板。&lt;br&gt;apply可以执行多次，它可以把变化同步到apiserver，apiserver发现与etcd中不一致，从而改变etcd，从而实现修改期望状态，接下来让现有状态不断逼近期望状态。&lt;/p&gt;
&lt;h4 id=&quot;跟踪滚动更新效果&quot;&gt;&lt;a href=&quot;#跟踪滚动更新效果&quot; class=&quot;headerlink&quot; title=&quot;跟踪滚动更新效果&quot;&gt;&lt;/a&gt;跟踪滚动更新效果&lt;/h4&gt;&lt;p&gt;在一个终端上，执行如下命令进行监控：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l app=myapp -w&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;打开另一个终端，编辑清单文件来更新：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim deploy-demo.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/104.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;更新：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f deploy-demo.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;接着查看第一个终端：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/105.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;查看rs：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get rs -o wide&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/106.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;通过patch打补丁更新&quot;&gt;&lt;a href=&quot;#通过patch打补丁更新&quot; class=&quot;headerlink&quot; title=&quot;通过patch打补丁更新&quot;&gt;&lt;/a&gt;通过patch打补丁更新&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl patch --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Update field(s) of a resource using strategic merge patch, a JSON merge patch, or a JSON patch.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; JSON and YAML formats are accepted.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Partially update a node using a strategic merge patch. Specify the patch as JSON.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl patch node k8s-node-1 -p &amp;apos;&amp;#123;&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;unschedulable&amp;quot;:true&amp;#125;&amp;#125;&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Partially update a node using a strategic merge patch. Specify the patch as YAML.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl patch node k8s-node-1 -p $&amp;apos;spec:\n unschedulable: true&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Partially update a node identified by the type and name specified in &amp;quot;node.json&amp;quot; using strategic merge patch.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl patch -f node.json -p &amp;apos;&amp;#123;&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;unschedulable&amp;quot;:true&amp;#125;&amp;#125;&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Update a container&amp;apos;s image; spec.containers[*].name is required because it&amp;apos;s a merge key.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl patch pod valid-pod -p &amp;apos;&amp;#123;&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;containers&amp;quot;:[&amp;#123;&amp;quot;name&amp;quot;:&amp;quot;kubernetes-serve-hostname&amp;quot;,&amp;quot;image&amp;quot;:&amp;quot;new image&amp;quot;&amp;#125;]&amp;#125;&amp;#125;&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Update a container&amp;apos;s image using a json patch with positional arrays.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl patch pod valid-pod --type=&amp;apos;json&amp;apos; -p=&amp;apos;[&amp;#123;&amp;quot;op&amp;quot;: &amp;quot;replace&amp;quot;, &amp;quot;path&amp;quot;: &amp;quot;/spec/containers/0/image&amp;quot;, &amp;quot;value&amp;quot;:&amp;quot;new&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;image&amp;quot;&amp;#125;]&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Options:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --allow-missing-template-keys=true: If true, ignore any errors in templates when a field or map key is missing in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the template. Only applies to golang and jsonpath output formats.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --dry-run=false: If true, only print the object that would be sent, without sending it.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -f, --filename=[]: Filename, directory, or URL to files identifying the resource to update&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -k, --kustomize=&amp;apos;&amp;apos;: Process the kustomization directory. This flag can&amp;apos;t be used together with -f or -R.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --local=false: If true, patch will operate on the content of the file, not the server-side resource.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -o, --output=&amp;apos;&amp;apos;: Output format. One of:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;json|yaml|name|go-template|go-template-file|template|templatefile|jsonpath|jsonpath-file.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -p, --patch=&amp;apos;&amp;apos;: The patch to be applied to the resource JSON file.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --record=false: Record current kubectl command in the resource annotation. If set to false, do not record the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;command. If set to true, record the command. If not set, default to updating the existing annotation value only if one&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;already exists.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -R, --recursive=false: Process the directory used in -f, --filename recursively. Useful when you want to manage&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;related manifests organized within the same directory.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --template=&amp;apos;&amp;apos;: Template string or path to template file to use when -o=go-template, -o=go-template-file. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;template format is golang templates [http://golang.org/pkg/text/template/#pkg-overview].&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --type=&amp;apos;strategic&amp;apos;: The type of patch being provided; one of [json merge strategic]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl patch (-f FILENAME | TYPE NAME) -p PATCH [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl options&amp;quot; for a list of global command-line options (applies to all commands).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;patch写结构定义很繁琐，不如vim修改清单文件，apply -f运行即可。但是这样会修改原有的清单文件，有些时候我们也许只是临时测试，修改文件不妥当。&lt;br&gt;【示例】：修改Pod副本数为5&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl patch deploy myapp-deploy -p &amp;apos;&amp;#123;&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;replicas&amp;quot;:5&amp;#125;&amp;#125;&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp-deploy patched&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                            READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-4pnr7   1/1     Running   0          3h16m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-6vz48   1/1     Running   0          3h16m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-nkm4z   1/1     Running   0          7s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-sjpmm   1/1     Running   0          3h16m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5-w729d   1/1     Running   0          7s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Pod已经变为5个了。&lt;/p&gt;
&lt;p&gt;【示例】：修改滚动更新策略&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl patch deploy myapp-deploy -p &amp;apos;&amp;#123;&amp;quot;spec&amp;quot;:&amp;#123;&amp;quot;strategy&amp;quot;:&amp;#123;&amp;quot;rollingUpdate&amp;quot;:&amp;#123;&amp;quot;maxSurge&amp;quot;:1,&amp;quot;maxUnavailable&amp;quot;:0&amp;#125;&amp;#125;&amp;#125;&amp;#125;&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp-deploy patched&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/107.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;kubectl-set-image更新&quot;&gt;&lt;a href=&quot;#kubectl-set-image更新&quot; class=&quot;headerlink&quot; title=&quot;kubectl set image更新&quot;&gt;&lt;/a&gt;kubectl set image更新&lt;/h4&gt;&lt;p&gt;如果只是更新镜像文件的，可以使用kubectl set image。&lt;br&gt;在一个终端上，执行如下命令进行监控：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l app=myapp -w&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;打开另一个终端，使用kubectl set image来更新镜像文件：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/108.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/109.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/110.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;下面恢复更新：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout resume deploy myapp-deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp-deploy resumed&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/111.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/112.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;回滚&quot;&gt;&lt;a href=&quot;#回滚&quot; class=&quot;headerlink&quot; title=&quot;回滚&quot;&gt;&lt;/a&gt;回滚&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Manage the rollout of a resource.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Valid resource types include:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  *  deployments&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  *  daemonsets&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  *  statefulsets&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Rollback to the previous deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl rollout undo deployment/abc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Check the rollout status of a daemonset&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl rollout status daemonset/foo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Available Commands:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  history     View rollout history&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  pause       Mark the provided resource as paused&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  resume      Resume a paused resource&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  status      Show the status of the rollout&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  undo        Undo a previous rollout&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl rollout SUBCOMMAND [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl &amp;lt;command&amp;gt; --help&amp;quot; for more information about a given command.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl options&amp;quot; for a list of global command-line options (applies to all commands).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其中，子命令undo表示回滚。status查看更新历史。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;回滚，默认是回滚到上一个版本，可以指定回滚到某一版本。&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout undo --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Rollback to a previous rollout.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Rollback to the previous deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl rollout undo deployment/abc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Rollback to daemonset revision 3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl rollout undo daemonset/abc --to-revision=3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  # Rollback to the previous deployment with dry-run&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl rollout undo --dry-run=true deployment/abc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Options:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --allow-missing-template-keys=true: If true, ignore any errors in templates when a field or map key is missing in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the template. Only applies to golang and jsonpath output formats.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --dry-run=false: If true, only print the object that would be sent, without sending it.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -f, --filename=[]: Filename, directory, or URL to files identifying the resource to get from a server.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -k, --kustomize=&amp;apos;&amp;apos;: Process the kustomization directory. This flag can&amp;apos;t be used together with -f or -R.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -o, --output=&amp;apos;&amp;apos;: Output format. One of:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;json|yaml|name|go-template|go-template-file|template|templatefile|jsonpath|jsonpath-file.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  -R, --recursive=false: Process the directory used in -f, --filename recursively. Useful when you want to manage&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;related manifests organized within the same directory.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --template=&amp;apos;&amp;apos;: Template string or path to template file to use when -o=go-template, -o=go-template-file. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;template format is golang templates [http://golang.org/pkg/text/template/#pkg-overview].&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --to-revision=0: The revision to rollback to. Default to 0 (last revision).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl rollout undo (TYPE NAME | TYPE/NAME) [flags] [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Use &amp;quot;kubectl options&amp;quot; for a list of global command-line options (applies to all commands).&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout history deploy myapp-deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp-deploy &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;REVISION  CHANGE-CAUSE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1         &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2         &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3         &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;比如，回滚到第一个版本：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout undo deploy myapp-deploy --to-revision=1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp-deploy rolled back&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此时，在查看更新历史时，第1版已经没有，变成了第4版：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout history deploy myapp-deploy  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp-deploy &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;REVISION  CHANGE-CAUSE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2         &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3         &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4         &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看当前工作pod中镜像是第几个版本：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get rs -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                      DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES                 SELECTOR&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-675558bfc5   0         0         0       3h43m   myapp        ikubernetes/myapp:v2   app=myapp,pod-template-hash=675558bfc5,release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8    5         5         5       4h      myapp        ikubernetes/myapp:v1   app=myapp,pod-template-hash=67b6dfcd8,release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-7f577979c8   0         0         0       15m     myapp        ikubernetes/myapp:v3   app=myapp,pod-template-hash=7f577979c8,release=canary&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;由此可见，Deployment可以对无状态的应用做到如此的灵活和简单。&lt;/p&gt;
&lt;h2 id=&quot;DaemonSet&quot;&gt;&lt;a href=&quot;#DaemonSet&quot; class=&quot;headerlink&quot; title=&quot;DaemonSet&quot;&gt;&lt;/a&gt;DaemonSet&lt;/h2&gt;&lt;p&gt;简称ds，主要作用在集群上符合条件的每个节点上只运行某个指定Pod，并且只运行1个副本。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain ds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     DaemonSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DEPRECATED - This group version of DaemonSet is deprecated by&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     apps/v1beta2/DaemonSet. See the release notes for more information.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DaemonSet represents the configuration of a daemon set.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   apiVersion   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     APIVersion defines the versioned schema of this representation of an&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     object. Servers should convert recognized schemas to the latest internal&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     value, and may reject unrecognized values. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#resources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   kind &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Kind is a string value representing the REST resource this object&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     represents. Servers may infer this from the endpoint the client submits&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     requests to. Cannot be updated. In CamelCase. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   metadata     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Standard object&amp;apos;s metadata. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The desired behavior of this daemon set. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   status       &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The current status of this daemon set. This data may be out of date by some&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     window of time. Populated by the system. Read-only. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;一级字段依然是这5个。但是ds.spec中没有replicas字段了，因为符合条件的每个节点上只运行1个Pod。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain ds.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     DaemonSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The desired behavior of this daemon set. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DaemonSetSpec is the specification of a daemon set.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   minReadySeconds      &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The minimum number of seconds for which a newly created DaemonSet pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     should be ready without any of its container crashing, for it to be&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     considered available. Defaults to 0 (pod will be considered available as&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     soon as it is ready).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   revisionHistoryLimit &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The number of old history to retain to allow rollback. This is a pointer to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     distinguish between explicit zero and not specified. Defaults to 10.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   selector     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     A label query over pods that are managed by the daemon set. Must match in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     order to be controlled. If empty, defaulted to labels on Pod template. More&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#label-selectors&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   template     &amp;lt;Object&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     An object that describes the pod that will be created. The DaemonSet will&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     create exactly one copy of this pod on every node that matches the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     template&amp;apos;s node selector (or on every node if no node selector is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     specified). More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller#pod-template&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   templateGeneration   &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DEPRECATED. A sequence number representing a specific generation of the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     template. Populated by the system. It can be set only during the creation.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   updateStrategy       &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     An update strategy to replace existing DaemonSet pods with new pods.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;DaemonSet示例&quot;&gt;&lt;a href=&quot;#DaemonSet示例&quot; class=&quot;headerlink&quot; title=&quot;DaemonSet示例&quot;&gt;&lt;/a&gt;DaemonSet示例&lt;/h2&gt;&lt;p&gt;使用一个事先做好了的镜像filebeat，这个镜像在使用时要给两个变量：redis主机地址和redis日志级别。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cp deploy-demo.yaml ds-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim ds-demo.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl apply -f ds-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/redis created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/redis created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.apps/filebeat-ds created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;filebeat-ds-2l7vw              1/1     Running   0          97s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;filebeat-ds-fqdmh              1/1     Running   0          97s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;filebeat-ds-ql5kc              1/1     Running   0          97s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-ff9xf   1/1     Running   0          35m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-msv5x   1/1     Running   0          35m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-rp9vj   1/1     Running   0          35m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-wls6h   1/1     Running   0          35m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-deploy-67b6dfcd8-xzgdl   1/1     Running   0          35m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis-58b9f5776-tsks5          1/1     Running   0          3m59s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   ClusterIP   10.96.0.1        &amp;lt;none&amp;gt;        443/TCP    125d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;redis        ClusterIP   10.101.223.105   &amp;lt;none&amp;gt;        6379/TCP   6m16s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;【说明】：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;master上不会运行这个pod。除非指定Pod能够容忍master上的污点，master上才会也启动一个Pod。&lt;/li&gt;
&lt;li&gt;启动一个redis pod，然后在default命名空间定义一个服务叫redis，这样filebeat就会连上那个redis服务了。&lt;/li&gt;
&lt;li&gt;在一个清单文件中可定义多个资源，把有关联的资源定义在一起。用 — 分割。&lt;/li&gt;
&lt;li&gt;redis应该用StatefulSet来运行，我这里只运行1个，使用Deployment是没问题的，但是别扩展规模，只运行1个。对于redis来讲，还应该使用存储卷，后面的内容会讲，这里先不做了。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;DaemonSet滚动更新&quot;&gt;&lt;a href=&quot;#DaemonSet滚动更新&quot; class=&quot;headerlink&quot; title=&quot;DaemonSet滚动更新&quot;&gt;&lt;/a&gt;DaemonSet滚动更新&lt;/h2&gt;&lt;p&gt;DaemonSet也支持滚动更新。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ kubectl explain ds.spec&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;有个字段：updateStrategy &lt;object&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain ds.spec.updateStrategy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     DaemonSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: updateStrategy &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     An update strategy to replace existing DaemonSet pods with new pods.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   rollingUpdate        &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Rolling update config params. Present only if type = &amp;quot;RollingUpdate&amp;quot;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   type &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Type of daemon set update. Can be &amp;quot;RollingUpdate&amp;quot; or &amp;quot;OnDelete&amp;quot;. Default is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     OnDelete.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/object&gt;&lt;/p&gt;
&lt;p&gt;默认是是OnDelete。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain ds.spec.updateStrategy.rollingUpdate&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     DaemonSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: rollingUpdate &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Rolling update config params. Present only if type = &amp;quot;RollingUpdate&amp;quot;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Spec to control the desired behavior of daemon set rolling update.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   maxUnavailable       &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     The maximum number of DaemonSet pods that can be unavailable during the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     update. Value can be an absolute number (ex: 5) or a percentage of total&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     number of DaemonSet pods at the start of the update (ex: 10%). Absolute&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     number is calculated from percentage by rounding up. This cannot be 0.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Default value is 1. Example: when this is set to 30%, at most 30% of the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     total number of nodes that should be running the daemon pod (i.e.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     status.desiredNumberScheduled) can have their pods stopped for an update at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     any given time. The update starts by stopping at most 30% of those&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DaemonSet pods and then brings up new DaemonSet pods in their place. Once&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the new pods are available, it then proceeds onto other DaemonSet pods,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     thus ensuring that at least 70% of original number of DaemonSet pods are&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     available at all times during the update.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;DaemonSet的滚动更新字段没有maxSurge。&lt;br&gt;【注意】：只能先删除在更新。因为一个节点只能运行一个，假如现在3个节点，你要运行4个，第4个运行到哪去。没有可能性，不支持1个节点上运行两个。所以只能是先删除1个，在更新1个。当然也可以一次删除多个。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/113.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Deployment&quot;&gt;&lt;a href=&quot;#Deployment&quot; class=&quot;headerlink&quot; title=&quot;Deployment&quot;&gt;&lt;/a&gt;Deployment&lt;/h2&gt;&lt;p&gt;简称deploy。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Pod控制器——ReplicaSet</title>
    <link href="http://yoursite.com/2019/08/12/Kubernetes-Pod%E6%8E%A7%E5%88%B6%E5%99%A8%E2%80%94%E2%80%94ReplicaSet/"/>
    <id>http://yoursite.com/2019/08/12/Kubernetes-Pod控制器——ReplicaSet/</id>
    <published>2019-08-12T01:23:02.000Z</published>
    <updated>2019-08-12T05:38:41.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Pod控制器&quot;&gt;&lt;a href=&quot;#Pod控制器&quot; class=&quot;headerlink&quot; title=&quot;Pod控制器&quot;&gt;&lt;/a&gt;Pod控制器&lt;/h2&gt;&lt;h3 id=&quot;Pod控制器介绍&quot;&gt;&lt;a href=&quot;#Pod控制器介绍&quot; class=&quot;headerlink&quot; title=&quot;Pod控制器介绍&quot;&gt;&lt;/a&gt;Pod控制器介绍&lt;/h3&gt;&lt;p&gt;此前使用配置清单创建Pod，都是在配置文件中定义要创建的Pod具体是什么。而后就提交给apiserver，由apiserver转交给Scheduler完成调度，由目标节点予以创建并启动相关的Pod资源。如果我们把Pod资源意外删除，Pod不会重建。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;在实际应用中，去管理Pod资源时很少用自主式Pod方式。之所以介绍自主式Pod，是为了讲清楚Pod是怎么创建的，而后面介绍的控制器创建Pod时，都是内嵌了Pod模板的。也就是将此前手动管理的Pod资源的定义方式内嵌到控制器的定义结构中去。&lt;br&gt;Pod控制器是用于实现代我们去管理Pod的中间层，并帮我们确保每一个Pod资源始终处于我们所定义或者所期望的目标状态。万一这个Pod资源出现故障，首先它会尝试着去重启容器，如果一直重启有问题的话，那么可能会基于某种策略来重新委派。如果Pod的副本数量低于用户所定义的目标数量，它也会自动补全。&lt;/p&gt;
&lt;h3 id=&quot;Pod控制器分类&quot;&gt;&lt;a href=&quot;#Pod控制器分类&quot; class=&quot;headerlink&quot; title=&quot;Pod控制器分类&quot;&gt;&lt;/a&gt;Pod控制器分类&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;ReplicationController:&lt;/strong&gt; 最早k8s只有这一种控制器。后来发现ReplicationController设计目标过于庞大，一个想完成所有的功能。目前推荐使用ReplicaSet。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;ReplicaSet:&lt;/strong&gt; 主要是帮助用户管理无状态的Pod资源。代用户创建指定数量的Pod副本，并确保Pod副本一直处于满足用户期望的数量的状态。多退少补。支持自动扩缩容策略。主要有三个核心资源组成：&lt;br&gt;1.用户期望的Pod副本数&lt;br&gt;2.标签选择器，判定哪些Pod是自己来管理的&lt;br&gt;3.Pod资源模板：如果集群中现存的Pod副本数量不够用户定义的副本数量时怎么办？新建Pod，根据Pod模板来建立。&lt;br&gt;但是ReplicaSet却不是我们直接使用的控制器。或者说k8s不建议我们直接使用ReplicaSet，而是使用Deployment。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Deployment:&lt;/strong&gt; 也是个控制器，工作在ReplicaSet之上。也就是说Deployment不是直接控制Pod，而是通过控制ReplicaSet来控制Pod。基于此，一定是Deployment能够提供比ReplicaSet更为强大的功能。Deployment还支持滚动更新和回滚等众多更为强大的机制，还提供了声明式配置的功能。这种声明式配置使得我们将来创建资源时可以基于声明的逻辑来定义。那些所有更新的资源我们可以随时重新进行声明，随时可以改变在apiserver上定义的资源的目标状态，只要对应的资源支持动态运行时修改。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;DaemonSet:&lt;/strong&gt; 用于确保集群中的每一个节点只运行一个特定的Pod副本。这些Pod通常是用来实现所谓的系统级的后台任务。当然系统级的后台任务本可以以守护进程的方式来运行这些任务，但是这种方式，服务宕了没法恢复。把这些任务托管到k8s之上有一个好处，宕了后可以被控制器自动重启。还有一个好处，当集群中新加入节点，DaemonSet会确保集群中的每个节点精确运行一个Pod，新节点进来了，上面也会启动一个这样的Pod。所以对于DaemonSet来说，不用定义Pod副本数量了，但是Pod模板肯定是要存在的。只有有了Pod模板，才能够建立起Pod资源。另外，标签选择器也是需要的，毕竟每一个节点上有没有符合我们所指定条件的Pod资源，是要靠标签选择器来判定。&lt;br&gt;用于确保集群中的每一个节点只运行一个特定的Pod副本。其实还有另外一个需求，我们也可以根据自己的需求在集群中的部分节点上，每一个节点只运行一个Pod副本。比如说要监控ssd硬盘的Pod，如果不是所有节点都有ssd，就没必要在没有ssd硬盘的节点上运行这个Pod了。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;无论是Deployment还是DaemonSet，都有这么几个特点。一是服务都是无状态的，二是这些服务必须是守护进程类的，就是必须持续地运行在后台。但是有的时候我们有这种需求，比如对数据库做备份操作，这种备份操作可以自己手动启动一个程序来运行，也可以在k8s上启动一个Pod来实现。备份结束了，这个Pod就没必要运行下去了。能实现这种功能的叫Job。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Job:&lt;/strong&gt; 也是控制器。要不要重建Pod，就看任务是否完成。只能执行一次性的作业。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Cronjob:&lt;/strong&gt; 周期性任务。Job只是一次性运行。对于Cronjob来说，如果前一次任务还没结束，下一次任务时间已经来临了，怎么办？所以Cronjob要去处理这个问题。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;StatefulSet:&lt;/strong&gt; 管理有状态应用。而且每一个Pod副本都是被单独管理的。它拥有着自己独有的标识和数据集。一旦这个Pod出现故障了，新的Pod加进来之前，我们可能需要做很多初始化操作。&lt;br&gt;假设要管理redis cluster，cluster中几个Pod，没办法取代任何一个。这种场景中我们关注的是个体行为。每个个体都要被单独对待。而不像Deployment，假如运行了3个Nginx，任何一个Nginx挂了，调度器生成一个新Pod，把配置文件一改启动起来就可以了。但是redis cluster中任何一个Pod故障了，新生成一个Pod，是取代不了之前那个的。&lt;br&gt;看起来很美好，把每个Pod当做个体来管理。但是用StatefulSet去定义管理Redis、Mysql、Zookeeper，配置方式肯定不一样。配置主从复制操作步骤肯定是不一样的。部署方式也是不一样的，没有什么共通的规律可循。因此StatefulSet最多给我们提供了一个封装控制器，这个封装指的是我们需要人为地把我们需要手动做的操作，那些复杂的操作逻辑定义成脚本，放置在StatefulSet的Pod模板的定义之中。每一次Pod故障发生后，通过脚本能自动恢复回来。难度比较大，试想一下，MySQL主从，那个代表从的Pod副本宕了，怎么能够重建个Pod副本过来，让这个Pod副本能够作为从节点。一个运行很久的MySQL，里面会有大量的数据，我们需要先从主节点做备份，备份后恢复到从节点。而且备份的时候还需要记下binlog的文件名和位置。随后在从节点上启动时还要指定从指定文件的指定位置开始。这些操作要封装成脚本实现。Pod副本创建时自动实现。好不容易开发成功这个StatefulSet，后面还有redis集群。redis主从和mysql是不一样的，又是另外一套脚本。而且脚本未必能考虑到所有情形。&lt;br&gt;所以有状态应用在k8s托管管理是极其麻烦的，原因在于有状态应用的运维技能要求非常高，运维操作步骤是各不相同的。没办法抽取共同特点，并定义模式来工作。只能每一种应用分别、单独地对待。k8s还支持一种特殊的资源叫TPR。&lt;br&gt;&lt;strong&gt;TPR:&lt;/strong&gt; Third Party Resources, 从k8s 1.2+开始支持第三方资源, 但是到1.7又被废了。因为有了更新的功能叫CDR。&lt;br&gt;&lt;strong&gt;CDR:&lt;/strong&gt; Custom Defined Resources, 用户自定义资源。从k8s 1.8+开始支持。自定义资源可以把我们运维操作技能封装进去，定义成一种特殊类型的资源，或者把我们要管理的目标资源的管理方式定义成一个独特的管理逻辑来实现。我们还可以借助CoreOS研发的叫做Operator的东西来实现灌进去我们的运维技能。&lt;br&gt;Operator：实现的灌进去的运维技能比StatefulSet要强大的太多了，但是到今天为止，成熟的Operator支持的也不过是etcd，promethus等几个。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;k8s现在难就难在使用门槛太高。每一次创建资源都需要自己写配置清单才行。任何一个系统，如果不把用户当傻瓜的话，注定用户不可能太多。为了解决这样的问题，k8s后来提供了一种功能叫Helm，头盔，外壳。Helm跟Linux上的yum一样。以后在部署应用程序，比如要在k8s之上部署redis cluster，刚才那样写要写半天，现在有人写好了，我们直接helm install就ok了。当然我们用的不是install命令，而是传一些参数告诉它，要创建什么样的存储卷，利用多少空间来存数据，以及我们要创建几个规模的集群。&lt;br&gt;目前Helm诞生还不超过3年，即便如此，大量主流的应用在Helm上已经有了。我们可以直接使用Helm就可以安装了。&lt;/p&gt;
&lt;h2 id=&quot;查看ReplicaSet帮助文档&quot;&gt;&lt;a href=&quot;#查看ReplicaSet帮助文档&quot; class=&quot;headerlink&quot; title=&quot;查看ReplicaSet帮助文档&quot;&gt;&lt;/a&gt;查看ReplicaSet帮助文档&lt;/h2&gt;&lt;p&gt;简称rs。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain rs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     ReplicaSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     DEPRECATED - This group version of ReplicaSet is deprecated by&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     apps/v1beta2/ReplicaSet. See the release notes for more information.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ReplicaSet ensures that a specified number of pod replicas are running at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     any given time.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   apiVersion   &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     APIVersion defines the versioned schema of this representation of an&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     object. Servers should convert recognized schemas to the latest internal&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     value, and may reject unrecognized values. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#resources&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   kind &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Kind is a string value representing the REST resource this object&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     represents. Servers may infer this from the endpoint the client submits&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     requests to. Cannot be updated. In CamelCase. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   metadata     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     If the Labels of a ReplicaSet are empty, they are defaulted to be the same&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     as the Pod(s) that the ReplicaSet manages. Standard object&amp;apos;s metadata. More&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Spec defines the specification of the desired behavior of the ReplicaSet.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   status       &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Status is the most recently observed status of the ReplicaSet. This data&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     may be out of date by some window of time. Populated by the system.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Read-only. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;【注意】：截至目前为止，rs在使用时的apiVersion是apps/v1，explain时看到的显示的是旧版本，帮助文档没更新到最新。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain rs.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     ReplicaSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Spec defines the specification of the desired behavior of the ReplicaSet.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ReplicaSetSpec is the specification of a ReplicaSet.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   minReadySeconds      &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Minimum number of seconds for which a newly created pod should be ready&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     without any of its container crashing, for it to be considered available.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Defaults to 0 (pod will be considered available as soon as it is ready)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   replicas     &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Replicas is the number of desired replicas. This is a pointer to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     distinguish between explicit zero and unspecified. Defaults to 1. More&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/#what-is-a-replicationcontroller&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   selector     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Selector is a label query over pods that should match the replica count. If&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the selector is empty, it is defaulted to the labels present on the pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     template. Label keys and values that must match in order to be controlled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     by this replica set. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#label-selectors&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   template     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Template is the object that describes the pod that will be created if&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     insufficient replicas are detected. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller#pod-template&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;rs.spec下定义的主要是replicas、selector和template这3个字段。其中，template就是定义Pod的模板。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain rs.spec.template&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     ReplicaSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: template &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Template is the object that describes the pod that will be created if&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     insufficient replicas are detected. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller#pod-template&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PodTemplateSpec describes the data a pod should have when created from a&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     template&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   metadata     &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Standard object&amp;apos;s metadata. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   spec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Specification of the desired behavior of the pod. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这里的metadata和spec是Pod的metadata和spec。&lt;/p&gt;
&lt;h2 id=&quot;ReplicaSet示例&quot;&gt;&lt;a href=&quot;#ReplicaSet示例&quot; class=&quot;headerlink&quot; title=&quot;ReplicaSet示例&quot;&gt;&lt;/a&gt;ReplicaSet示例&lt;/h2&gt;&lt;h3 id=&quot;示例1：创建ReplicaSet&quot;&gt;&lt;a href=&quot;#示例1：创建ReplicaSet&quot; class=&quot;headerlink&quot; title=&quot;示例1：创建ReplicaSet&quot;&gt;&lt;/a&gt;示例1：创建ReplicaSet&lt;/h3&gt;&lt;p&gt;先清理掉集群中无用的Pod。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;liveness-httpget-pod           1/1     Running   1          2d19h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;poststart-pod                  1/1     Running   65         2d17h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;readiness-httpget-pod          1/1     Running   0          2d19h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME           READY   UP-TO-DATE   AVAILABLE   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client         1/1     1            1           9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp          3/3     3            3           9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy   1/1     1            1           9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete deploy client&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions &amp;quot;client&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete deploy myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions &amp;quot;myapp&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete deploy nginx-deploy &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions &amp;quot;nginx-deploy&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   ClusterIP   10.96.0.1        &amp;lt;none&amp;gt;        443/TCP        121d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp        NodePort    10.109.204.135   &amp;lt;none&amp;gt;        80:31784/TCP   9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx        ClusterIP   10.107.191.247   &amp;lt;none&amp;gt;        80/TCP         9d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete svc myapp &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service &amp;quot;myapp&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete svc nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service &amp;quot;nginx&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete -f liveness-httpget.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;liveness-httpget-pod&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete -f readiness-httpget.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;readiness-httpget-pod&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete -f poststart-pod.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;poststart-pod&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例】：&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim rs-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: ReplicaSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  replicas: 2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selector:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    matchLabels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  template:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      name: myapp-pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        release: canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        environment: qa&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      - name: myapp-container&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f rs-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;replicaset.apps/myapp created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/92.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;【说明】：&lt;br&gt;1、rs的metadata和Pod的metadata很类似，rs自己也是个资源，也可以有标签，也可以有注解。如果需要的话自己定义就行。这里为了结构清晰一点，就不写了。&lt;br&gt;2、spec.selector是个标签选择器，它是一个对象，支持两种挑选方式。第一种是基于等值的标签选择，matchLabels。它是个map，可以给定多个键值。第二种叫matchExpressions。&lt;br&gt;3、spec.template也是个对象，嵌套的字段有两个：metadata和spec。template中定义的的metadata中标签要包含selector中的标签，否则创建的Pod不符合自己的选择器，没有意义。当然也可以在template中定义多余的标签。&lt;br&gt;4、对于容器来讲，一般要做存活性探测和就绪性探测的，这里为了结构清晰和简单，就没写。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/93.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;现在删除一个Pod，看控制器是否会自动重新创建一个Pod：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/94.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;创建一个别的Pod，并为这个Pod打上标签，使得这个Pod可以被上面创建的RS的标签选择器选中：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f pod-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME          READY   STATUS    RESTARTS   AGE     LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-g4vt8   1/1     Running   0          12m     app=myapp,environment=qa,release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-tj86f   1/1     Running   0          3m36s   app=myapp,environment=qa,release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo      2/2     Running   0          19s     app=myapp,tier=frontend&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label pod pod-demo app=myapp release=canary --overwrite&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME          READY   STATUS        RESTARTS   AGE     LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-g4vt8   1/1     Running       0          13m     app=myapp,environment=qa,release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-tj86f   1/1     Running       0          4m56s   app=myapp,environment=qa,release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo      2/2     Terminating   0          99s     app=myapp,release=canary,tier=frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME          READY   STATUS    RESTARTS   AGE     LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-g4vt8   1/1     Running   0          14m     app=myapp,environment=qa,release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-tj86f   1/1     Running   0          5m13s   app=myapp,environment=qa,release=canary&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;结果这个新创建的Pod pod-demo被终止删除了，RS始终保持被选中的Pod的副本数量为我们在清单文件中定义的值2。&lt;/p&gt;
&lt;h3 id=&quot;示例2：扩容&quot;&gt;&lt;a href=&quot;#示例2：扩容&quot; class=&quot;headerlink&quot; title=&quot;示例2：扩容&quot;&gt;&lt;/a&gt;示例2：扩容&lt;/h3&gt;&lt;p&gt;kubectl scale 或者 kubectl edit rs的清单文件&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get rs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubeNAME    DESIRED   CURRENT   READY   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp   2         2         2       19m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You have mail in /var/spool/mail/root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl edit rs myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;replicaset.extensions/myapp edited&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/95.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME          READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-fsntj   1/1     Running   0          21s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-g4vt8   1/1     Running   0          21m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-lk7dr   1/1     Running   0          21s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-p7pm8   1/1     Running   0          21s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-tj86f   1/1     Running   0          12m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例3：更新升级&quot;&gt;&lt;a href=&quot;#示例3：更新升级&quot; class=&quot;headerlink&quot; title=&quot;示例3：更新升级&quot;&gt;&lt;/a&gt;示例3：更新升级&lt;/h3&gt;&lt;p&gt;更新升级：更新升级无非是去改容器的镜像文件的版本。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl edit rs myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;replicaset.extensions/myapp edited&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/96.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/97.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;改了控制器的template中的镜像版本，Pod资源并不会被改掉，因为Pod资源不会被重建，只有重建的Pod资源，它的版本才会改掉。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/98.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;删除一个，一个重建，发布完成；&lt;br&gt;删除一个，一个重建，发布完成；&lt;br&gt;删除一个，一个重建，发布完成；&lt;br&gt;…&lt;br&gt;这是“灰度发布”。但是这需要我们人为参与进来。节奏我们自己能掌握，如果只删除一个，这叫金丝雀。那些被导向到v2的就是小白鼠，试试新版本有没有问题，两天以后，没人反应有问题，那就可以全部升级了。这是金丝雀发布。&lt;br&gt;当然也可以一次性把所有Pod都删除了，但是一次性全删除了，一定会影响在线访问的。这种发布有点暴力，虽然更新也很快。最妥当的更新是用蓝绿的方式进行。在创建一个rs，新的rs的标签选择器可以和老的rs的标签选择器不完全一样，但跟前面的service都能兼容。即service关联的pod既来之rs1，也来自rs2。我们先创建rs2，在删除rs1，这就是蓝绿发布。&lt;br&gt;或者先创建rs2，等rs2就绪了，修改service，将service匹配rs2，不在指向rs1。这样才是真正意义上的蓝绿。但是仍然需要我们自己去规划部署。有一个组件就是建立在rs之上完成的，叫Deployment。Deployment就是帮我们干这个事情的，&lt;strong&gt;能提供滚动式、自定义更新。&lt;/strong&gt;Deployment建立在rs之前，一个Deployment管理多个rs，但是当前正在使用的只有1个。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/99.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;而且Deployment提供&lt;strong&gt;声明式更新配置&lt;/strong&gt;，声明式创建一般使用apply，而不使用create。对于apply管理的，还可以patch打补丁来实现修改，而不用使用edit。我们完全可以在命令行中通过纯命令方式来直接完成对应资源版本内容修改。说白了就是可以使用POST方式来提交内容来进行修改，而不是直接改配置文件。直接通过打补丁的方式来修改。&lt;br&gt;Deployment除了可以实现滚动更新，还可以控制更新节奏和更新逻辑。假如说ReplicaSet有5个Pod副本，刚才手动更新是这么更新的，删除1个，由rs自动创建1个，在删1个，在自动创建1个。有这么个场景，假如这5个刚刚能满足用户访问需求，我们通过service将用户流量调度到这5个Pod上。删1个，这4个不足以承载这么大的流量。怎么办？不删又不能更新。如果支持先加1个，在删1个。加1个是违反Pod管理机制的，副本数是精确反应在清单中定义的数量，加1个就多了1个，所以这里是需要临时加1个。所以临时加几个，怎么加是可以控制的。我们不但可以指定在滚动更新期间，最多能够多出我们期望副本数量几个，还能定义最多能少于副本数量几个。&lt;br&gt;控制逻辑可以实现 灰度、金丝雀、蓝绿发布。&lt;br&gt;滚动更新时，定义liveness和readiness是很重要的，不然一启动就就绪了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Pod控制器&quot;&gt;&lt;a href=&quot;#Pod控制器&quot; class=&quot;headerlink&quot; title=&quot;Pod控制器&quot;&gt;&lt;/a&gt;Pod控制器&lt;/h2&gt;&lt;h3 id=&quot;Pod控制器介绍&quot;&gt;&lt;a href=&quot;#Pod控制器介绍&quot; class=&quot;headerlink&quot; title=&quot;Pod控制器介绍&quot;&gt;&lt;/a&gt;Pod控制器介绍&lt;/h3&gt;&lt;p&gt;此前使用配置清单创建Pod，都是在配置文件中定义要创建的Pod具体是什么。而后就提交给apiserver，由apiserver转交给Scheduler完成调度，由目标节点予以创建并启动相关的Pod资源。如果我们把Pod资源意外删除，Pod不会重建。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Pod探针</title>
    <link href="http://yoursite.com/2019/08/09/Kubernetes-Pod%E6%8E%A2%E9%92%88/"/>
    <id>http://yoursite.com/2019/08/09/Kubernetes-Pod探针/</id>
    <published>2019-08-09T01:25:46.000Z</published>
    <updated>2019-08-09T09:32:54.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;探针类型&quot;&gt;&lt;a href=&quot;#探针类型&quot; class=&quot;headerlink&quot; title=&quot;探针类型&quot;&gt;&lt;/a&gt;探针类型&lt;/h2&gt;&lt;p&gt;探针主要有两种：livenessProbe和readinessProbe。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.spec.containers&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/83.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;容器探测无非就是我们在里面设置了一些探针，或传感器来获取相应的数据作为判定其存活与否的标准和就绪与否的标准。对于 livenessProbe和readinessProbe 这两种探针，可定义的具体探针有三种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ExecAction&lt;/li&gt;
&lt;li&gt;TCPSocketAction&lt;/li&gt;
&lt;li&gt;HTTPGetAction      &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;每次定义三者之中的一个就可以了。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ kubectl explain pods.spec.containers.livenessProbe&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;- exec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;exec探针。执行用户自定义命令，这个命令得是容器中存在的命令才行&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- failureThreshold  &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;探测几次都失败，才认为是失败的。默认是3个。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- httpGet &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;httpGet探针&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- initialDelaySeconds &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;在容器启动以后多久做探测，很多时间容器启动了，但是主程序很可能还没初始化完成。因此应该等一些时间在探测。默认是容器一启动就探测。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- periodSeconds &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;每次探测之间间隔多长时间，默认10s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- successThreshold &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;成功几次说明ok，默认是1次&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- tcpSocket &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;tcpSocket探针&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- timeoutSeconds &amp;lt;integer&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;超时时间，发出探测，多久没响应，默认1s。&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;readiness探测所使用的字段和liveness字段是一样的。只是两者探测目的不一样。&lt;/p&gt;
&lt;h2 id=&quot;livenessProbe探针示例&quot;&gt;&lt;a href=&quot;#livenessProbe探针示例&quot; class=&quot;headerlink&quot; title=&quot;livenessProbe探针示例&quot;&gt;&lt;/a&gt;livenessProbe探针示例&lt;/h2&gt;&lt;h3 id=&quot;exec探测&quot;&gt;&lt;a href=&quot;#exec探测&quot; class=&quot;headerlink&quot; title=&quot;exec探测&quot;&gt;&lt;/a&gt;exec探测&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.spec.containers.livenessProbe.exec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: exec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     One and only one of the following should be specified. Exec specifies the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     action to take.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ExecAction describes a &amp;quot;run in container&amp;quot; action.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   command      &amp;lt;[]string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Command is the command line to execute inside the container, the working&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     directory for the command is root (&amp;apos;/&amp;apos;) in the container&amp;apos;s filesystem. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     command is simply exec&amp;apos;d, it is not run inside a shell, so traditional&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     shell instructions (&amp;apos;|&amp;apos;, etc) won&amp;apos;t work. To use a shell, you need to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     explicitly call out to that shell. Exit status of 0 is treated as&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     live/healthy and non-zero is unhealthy.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim liveness-exec.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: liveness-exec-pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: liveness-exec-container&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: busybox:latest&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    command: [&amp;quot;sh&amp;quot;,&amp;quot;-c&amp;quot;,&amp;quot;touch /tmp/healthy; sleep 30; rm -f /tmp/healthy; sleep 3600&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    livenessProbe:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      exec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        command: [&amp;quot;test&amp;quot;,&amp;quot;-e&amp;quot;,&amp;quot;/tmp/healthy&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      initialDelaySeconds: 1 #默认0s，即容器一启动就探测&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      periodSeconds: 3 #每隔多长时间进行探测&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f liveness-exec.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/liveness-exec-pod created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;过个30s，然后去查看下这个pod的状态：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl describe pod liveness-exec-pod&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/84.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;httpGet探测&quot;&gt;&lt;a href=&quot;#httpGet探测&quot; class=&quot;headerlink&quot; title=&quot;httpGet探测&quot;&gt;&lt;/a&gt;httpGet探测&lt;/h3&gt;&lt;p&gt;如果容器内是个web服务，可以使用TCP套接字探测，还可以使用HTTP探测。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.containers.livenessProbe.httpGet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: httpGet &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     HTTPGet specifies the http request to perform.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     HTTPGetAction describes an action based on HTTP Get requests.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   host &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Host name to connect to, defaults to the pod IP. You probably want to set&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &amp;quot;Host&amp;quot; in httpHeaders instead.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   httpHeaders  &amp;lt;[]Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Custom headers to set in the request. HTTP allows repeated headers.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   path &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Path to access on the HTTP server.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   port &amp;lt;string&amp;gt; -required-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Name or number of the port to access on the container. Number must be in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     the range 1 to 65535. Name must be an IANA_SVC_NAME.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   scheme       &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Scheme to use for connecting to the host. Defaults to HTTP.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;host &lt;string&gt;&lt;/string&gt;&lt;/strong&gt;&lt;br&gt;默认往Pod IP发请求。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;httpHeaders  &amp;lt;[]Object&amp;gt;&lt;/strong&gt;&lt;br&gt;自定义首部。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;path &lt;string&gt;&lt;/string&gt;&lt;/strong&gt;&lt;br&gt;向哪个url发请求&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;port &lt;string&gt; -required-&lt;/string&gt;&lt;/strong&gt;&lt;br&gt;Name or number of the port to access on the container. Number must be in&lt;br&gt;the range 1 to 65535. Name must be an &lt;strong&gt;IANA_SVC_NAME&lt;/strong&gt;.&lt;br&gt;如果我们在containers暴露定义了名称，这里port这个字段可以使用定义的名称。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;scheme       &lt;string&gt;&lt;/string&gt;&lt;/strong&gt;&lt;br&gt;Scheme to use for connecting to the host. Defaults to HTTP.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim liveness-httpget.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: liveness-httpget-pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: liveness-httpget-container&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    livenessProbe:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      httpGet:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        port: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        path: /index.html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      initialDelaySeconds: 1 #默认0s，即容器一启动就探测&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      periodSeconds: 3 #每隔多长时间进行探测&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f liveness-httpget.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/liveness-httpget-pod created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl describe pod liveness-httpget-pod&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/85.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;下面手动进入Pod中的容器，删除这个index.html文件，然后看看探针是否探测失败：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl exec -it liveness-httpget-pod -- /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # ls /usr/share/nginx/html/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50x.html    index.html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # rm -f /usr/share/nginx/html/index.html&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在另一个终端 describe 这个pod：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl describe pod liveness-httpget-pod | grep -i liveness&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/86.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;readinessProbe探针示例&quot;&gt;&lt;a href=&quot;#readinessProbe探针示例&quot; class=&quot;headerlink&quot; title=&quot;readinessProbe探针示例&quot;&gt;&lt;/a&gt;readinessProbe探针示例&lt;/h2&gt;&lt;h3 id=&quot;就绪性探测必要性&quot;&gt;&lt;a href=&quot;#就绪性探测必要性&quot; class=&quot;headerlink&quot; title=&quot;就绪性探测必要性&quot;&gt;&lt;/a&gt;就绪性探测必要性&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/87.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;如果你不定义就绪，那么容器一启动，该容器状态就显示为1，就绪。&lt;br&gt;就绪性探测和service调度有着重要的关联性。service是个固定入口端点，为动态地、有生命周期的Pod资源提供一个固定的入口端口。客户端不是直接访问Pod，而是访问service。service使用标签选择器关联至各Pod资源。这里有个问题，比如现在又创建了一个新Pod出来，这个新Pod正好符合这个service标签选择器的选择条件，立即把这个Pod作为后端对象了。用户请求进来可能被调度到这个新Pod上了。但是这个新Pod一创建成功，就被service关联到后端去了，但是此时Pod里的服务很有可能还没就绪。这个时候有请求被调度上来，肯定是访问不到服务的。因此要做就绪性探测，否则Pod一创建就被立即关联到service上了。所以以后使用Pod必须要做readinessProbe。&lt;br&gt;readinessProbe和livenessProbe支持的探针都是一样的，但是两者目的不一样。&lt;/p&gt;
&lt;h3 id=&quot;httpGet探测-1&quot;&gt;&lt;a href=&quot;#httpGet探测-1&quot; class=&quot;headerlink&quot; title=&quot;httpGet探测&quot;&gt;&lt;/a&gt;httpGet探测&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# cp liveness-httpget.yaml readiness-httpget.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim readiness-httpget.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: readiness-httpget-pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: readiness-httpget-container&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ports:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - name: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      containerPort: 80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    readinessProbe:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      httpGet:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        port: http&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        path: /index.html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      initialDelaySeconds: 1 #默认0s，即容器一启动就探测&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      periodSeconds: 3 #每隔多长时间进行探测&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f readiness-httpget.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          6d21h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;liveness-httpget-pod           1/1     Running   1          34m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          7d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          7d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          7d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          7d1h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;readiness-httpget-pod          1/1     Running   0          3s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;已经显示为就绪状态。然后我们进入这个Pod中的容器，删除index.html文件&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl exec -it readiness-httpget-pod -- /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # rm -f /usr/share/nginx/html/index.html&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/88.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/89.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;/ # echo &amp;quot;hi&amp;quot; &amp;gt;&amp;gt; /usr/share/nginx/html/index.html&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/90.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子&quot;&gt;&lt;a href=&quot;#Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子&quot; class=&quot;headerlink&quot; title=&quot;Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子&quot;&gt;&lt;/a&gt;Pod生命周期中的另外一种行为lifecycle：启动后钩子和终止前钩子&lt;/h2&gt;&lt;p&gt;在主容器刚刚启动之后，用户可以手动嵌入做一些操作，可以做一个 post start，比如执行完一个命令就退出。&lt;br&gt;如果主容器要退出，在结束之前，也可以做一些事情，pre stop。类似于awk的BEGIN和END。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.containers.lifecycle&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: lifecycle &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Actions that the management system should take in response to container&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     lifecycle events. Cannot be updated.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Lifecycle describes actions that the management system should take in&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     response to container lifecycle events. For the PostStart and PreStop&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     lifecycle handlers, management of the container blocks until the action is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     complete, unless the container process fails, in which case the handler is&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     aborted.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   postStart    &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PostStart is called immediately after a container is created. If the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     handler fails, the container is terminated and restarted according to its&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     restart policy. Other management of the container blocks until the hook&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     completes. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#container-hooks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   preStop      &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PreStop is called immediately before a container is terminated due to an&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     API request or management event such as liveness probe failure, preemption,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     resource contention, etc. The handler is not called if the container&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     crashes or exits. The reason for termination is passed to the handler. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Pod&amp;apos;s termination grace period countdown begins before the PreStop hooked&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     is executed. Regardless of the outcome of the handler, the container will&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     eventually terminate within the Pod&amp;apos;s termination grace period. Other&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     management of the container blocks until the hook completes or until the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     termination grace period is reached. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#container-hooks&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.containers.lifecycle.postStart&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: postStart &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PostStart is called immediately after a container is created. If the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     handler fails, the container is terminated and restarted according to its&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     restart policy. Other management of the container blocks until the hook&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     completes. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#container-hooks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Handler defines a specific action that should be taken&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   exec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     One and only one of the following should be specified. Exec specifies the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     action to take.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   httpGet      &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     HTTPGet specifies the http request to perform.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   tcpSocket    &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     TCPSocket specifies an action involving a TCP port. TCP hooks not yet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     supported&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec.containers.lifecycle.preStop&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KIND:     Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;VERSION:  v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RESOURCE: preStop &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DESCRIPTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     PreStop is called immediately before a container is terminated due to an&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     API request or management event such as liveness probe failure, preemption,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     resource contention, etc. The handler is not called if the container&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     crashes or exits. The reason for termination is passed to the handler. The&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Pod&amp;apos;s termination grace period countdown begins before the PreStop hooked&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     is executed. Regardless of the outcome of the handler, the container will&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     eventually terminate within the Pod&amp;apos;s termination grace period. Other&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     management of the container blocks until the hook completes or until the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     termination grace period is reached. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#container-hooks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Handler defines a specific action that should be taken&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;FIELDS:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   exec &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     One and only one of the following should be specified. Exec specifies the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     action to take.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   httpGet      &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     HTTPGet specifies the http request to perform.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   tcpSocket    &amp;lt;Object&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     TCPSocket specifies an action involving a TCP port. TCP hooks not yet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     supported&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;【示例】：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim poststart-pod.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: poststart-pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: busybox-httpd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: busybox:latest&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lifecycle:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      postStart:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        exec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          command: [&amp;quot;mkdir&amp;quot;,&amp;quot;-p&amp;quot;,&amp;quot;/data/web/html&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    command: [&amp;quot;/bin/sh&amp;quot;,&amp;quot;-c&amp;quot;,&amp;quot;sleep 3600&amp;quot;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f poststart-pod.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/poststart-pod created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          6d22h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;liveness-httpget-pod           1/1     Running   1          134m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          7d1h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          7d1h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          7d1h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          7d2h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;poststart-pod                  1/1     Running   0          6s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;readiness-httpget-pod          1/1     Running   0          100m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl exec -it poststart-pod -- /bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # ls /data/web/html/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # ls /data/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;web&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/91.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;探针类型&quot;&gt;&lt;a href=&quot;#探针类型&quot; class=&quot;headerlink&quot; title=&quot;探针类型&quot;&gt;&lt;/a&gt;探针类型&lt;/h2&gt;&lt;p&gt;探针主要有两种：livenessProbe和readinessProbe。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.spec.containers&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Pod控制器</title>
    <link href="http://yoursite.com/2019/08/07/Kubernetes-Pod%E6%8E%A7%E5%88%B6%E5%99%A8/"/>
    <id>http://yoursite.com/2019/08/07/Kubernetes-Pod控制器/</id>
    <published>2019-08-07T01:11:46.000Z</published>
    <updated>2019-08-08T06:12:43.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Pod控制器资源配置清单重要字段详解&quot;&gt;&lt;a href=&quot;#Pod控制器资源配置清单重要字段详解&quot; class=&quot;headerlink&quot; title=&quot;Pod控制器资源配置清单重要字段详解&quot;&gt;&lt;/a&gt;Pod控制器资源配置清单重要字段详解&lt;/h2&gt;&lt;p&gt;资源的清单格式:&lt;br&gt;一级字段：apiVersion(group/version), kind, metadata(name,namespace,labels,annotations,…), spec, status(只读)&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Pod资源：&lt;/strong&gt;&lt;br&gt;spec.containers &amp;lt;[]object&amp;gt;  # kubectl explain pods.spec.containers&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;name &lt;string&gt;&lt;/string&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;image &lt;string&gt;&lt;/string&gt;&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/74.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;imagePullPolicy &lt;string&gt;&lt;/string&gt;&lt;/strong&gt;&lt;br&gt;可用值：Always, Never, IfNotPresent。Always：本地有或者没有这个镜像，就算有，也不用本地已有的这个镜像，而是去registry中下载。Never：如果有，就用。如果没有，它也不会去下载。IfNotPresent：如果本地存在就直接使用，如果不存在就去下载。如果你的镜像的标签是latest，那么默认值就是Always。如果不是latest标签，默认值都是IfNotPresent。另外在创建完这个资源后，imagePullPolicy这个字段是不可以修改的。除非把这个资源删了，然后去修改这个文件，在创建。很多时候，从一个无法确定其可信与否的主机之上运行容器时，我们把imagePullPolicy设置为Always时一定会浪费我们拖这个对应的对象的带宽，同时也会导致容器启动速度较慢。但是带来的好处是，当你试图启动一个容器时，那个目标主机之上正好存在了启动容器的这个镜像，但是那个镜像可能不是你想要运行的镜像，但是它精巧地伪装成了你要运行的镜像的名称，比如有人在每一个公有云的主机之上都放了某一个镜像，这个镜像里面内建了挖矿的代码，当你试图启动某一个容器时，因为本地已经有了这个镜像，就不用从registry上下载了，这样就中招了。所以 Always 在某些情况下还是有用的。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/75.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;ports &amp;lt;[]Object&amp;gt;&lt;/strong&gt;&lt;br&gt;定义容器内的要暴露的端口时，可以暴露多个端口。而且每一个端口还应该有多个属性来定义。比如端口的名称，将来可以基于名称(在service中映射时可以用到)来引用它。端口号，还有协议。【注意】：暴露一个端口仅仅是提供额外信息的，并不会限制系统是否会真的会暴露。这和docker不太一样，这儿的网络是叠加网络，pod和pod可以通过ip地址直接通信的，所以不需要手动绑定在节点的IP地址上才能访问。在文件中明确地、显式地定义，至少让用户知道我们的应用程序到底监听在哪个端口。只要你容器里那个应用程序监听的端口，一定会暴露出去。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;args &amp;lt;[]string&amp;gt; 和 commad &amp;lt;[]string&amp;gt;&lt;/strong&gt; 修改镜像中的默认启动的命令。&lt;br&gt;如果我们想不去运行镜像中定义的默认要运行的应用程序，此前的例子中用的是command。其实应该是 args 和 command 两个一起配合。command表示要运行的程序，args表示传递给程序的参数。而在dockerfile中，里面有entrypoint和cmd，如果只有cmd，那就运行cmd中的程序。如果既有entrypoint，又有cmd，cmd的内容将作为参数被传递给entrypoint中的命令。&lt;br&gt;Kubernetes清单文件中的 command 是一个 Entrypoint array，有点相像于dockerfile中的entrypoint。而且command给定的代码是不会运行在shell中的。因此如果你想运行在shell中，必须指定/bin/sh。如果你没有提供command，docker镜像在制作时，它有entrypoint那个指令，那么就会运行镜像中的entrypoint。说白了就是当你不提供命令时，就默认运行镜像中的命令。&lt;br&gt;args 用来向 command 传参数。如果在args中引用了变量，变量引用格式为：$(VAR_NAME)。如果不想在这被替换，就是想用shell中命令引用的效果，使用方式为：$$(VAR_NAME)。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;关于清单文件中定义Pod时使用的command和args字段与dockerfile中的entrypoint和cmd的关系，在 &lt;a href=&quot;https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/&lt;/a&gt; 文档中有详细的说明。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/76.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;标签和标签选择器&quot;&gt;&lt;a href=&quot;#标签和标签选择器&quot; class=&quot;headerlink&quot; title=&quot;标签和标签选择器&quot;&gt;&lt;/a&gt;标签和标签选择器&lt;/h2&gt;&lt;h3 id=&quot;标签简介&quot;&gt;&lt;a href=&quot;#标签简介&quot; class=&quot;headerlink&quot; title=&quot;标签简介&quot;&gt;&lt;/a&gt;标签简介&lt;/h3&gt;&lt;p&gt;标签是附加在对应对象之上的“键值对”。一个资源之上可存在多个标签，一个标签也可以在多个资源对象上。这每一个标签都可以对标签选择器进行匹配度检查，从而完成资源挑选。标签既可以在对象创建时指定，也可以在资源创建之后使用命令来添加、删除、修改。实践中，我们通常可以给资源附加多个不同维度的标签来进行不同维度的管理。常用的维度有：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;release，比如stable，beta, alpha, canary等。&lt;/li&gt;
&lt;li&gt;environment：dev/test/prod&lt;/li&gt;
&lt;li&gt;架构层面：接入层、前台等&lt;/li&gt;
&lt;li&gt;应用维度：应用名&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;标签：&lt;/strong&gt;&lt;br&gt;key=value&lt;br&gt;key：字母、数字、&lt;em&gt;、-、.&lt;br&gt;value：也不可以超过63个字符，可以为空。只能以 字母或数字开头及结尾，中间可使用 字母、数字、&lt;/em&gt;、-、.&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/77.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例1：利用标签选择器查看资源&quot;&gt;&lt;a href=&quot;#示例1：利用标签选择器查看资源&quot; class=&quot;headerlink&quot; title=&quot;示例1：利用标签选择器查看资源&quot;&gt;&lt;/a&gt;示例1：利用标签选择器查看资源&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# 查看对应资源下含有标签app的资源&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l app&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          28s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l app --show-labels &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          35s   app=myapp,tier=frontend&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# -L 标签名，表示显示对应资源下有相应标签的值。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -L app,run&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE     APP     RUN&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          5d17h           client&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          5d20h           myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          5d20h           myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          5d20h           myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          5d21h           nginx-deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                       2/2     Running   0          2m48s   myapp&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;示例2：添加标签&quot;&gt;&lt;a href=&quot;#示例2：添加标签&quot; class=&quot;headerlink&quot; title=&quot;示例2：添加标签&quot;&gt;&lt;/a&gt;示例2：添加标签&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl label [--overwrite] (-f FILENAME | TYPE NAME) KEY_1=VAL_1 ... KEY_N=VAL_N [--resource-version=version]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;TYPE NAME：表示什么类型的、什么名字的资源。&lt;/p&gt;
&lt;p&gt;给Pod pod-demo添加一个标签：release=canary&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label pods pod-demo release=canary&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods pod-demo --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          10m   app=myapp,release=canary,tier=frontend&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例3：修改标签&quot;&gt;&lt;a href=&quot;#示例3：修改标签&quot; class=&quot;headerlink&quot; title=&quot;示例3：修改标签&quot;&gt;&lt;/a&gt;示例3：修改标签&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label pods pod-demo release=stable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;error: &amp;apos;release&amp;apos; already has a value (canary), and --overwrite is false&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label pods pod-demo release=stable --overwrite&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods pod-demo --show-labels   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          13m   app=myapp,release=stable,tier=frontend&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;示例4：删除标签&quot;&gt;&lt;a href=&quot;#示例4：删除标签&quot; class=&quot;headerlink&quot; title=&quot;示例4：删除标签&quot;&gt;&lt;/a&gt;示例4：删除标签&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods pod-demo --show-labels  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          38m   app=myapp,release=stable,tier=frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label pod pod-demo release-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods pod-demo --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          38m   app=myapp,tier=frontend&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;标签选择器介绍&quot;&gt;&lt;a href=&quot;#标签选择器介绍&quot; class=&quot;headerlink&quot; title=&quot;标签选择器介绍&quot;&gt;&lt;/a&gt;标签选择器介绍&lt;/h3&gt;&lt;p&gt;k8s的标签选择器支持两类：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;等值关系的标签选择器：=、==、!=&lt;/li&gt;
&lt;li&gt;基于集合关系的标签选择器：&lt;ul&gt;
&lt;li&gt;KEY in (VALUE1,VALUE2,…)      &lt;/li&gt;
&lt;li&gt;KEY notin (VALUE1,VALUE2,…)&lt;/li&gt;
&lt;li&gt;KEY&lt;/li&gt;
&lt;li&gt;!KEY&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;有很多类型的资源都要基于 标签选择器 来关联其他资源的，比如说Pod控制器和service。Pod控制器和service来实现标签关联时，通常使用另外两个字段来嵌套。Deployment、service等许多资源通常支持使用 matchLabels来让你去定义，就是里面内嵌一字段来定义怎么使用标签选择器。Deployment、ReplicaSet等支持两种 matchLabels 和 matchExpressions，service只支持第一种 matchLabels。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;matchLabels: 直接给定键值，相当于使用等值关系一样&lt;/li&gt;
&lt;li&gt;matchExpressions: 基于给定的表达式来定义使用的标签选择器。{key:”KEY”, operator:”OPERATOR”, values:[VALUE1,VALUE2,…]}&lt;ul&gt;
&lt;li&gt;OPERATOR: &lt;ul&gt;
&lt;li&gt;In、NotIn：values字段的值必须为非空列表&lt;/li&gt;
&lt;li&gt;Exists、NotExists：values字段的值必须为空列表&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l release&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          22m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# ,表示与关系，必须都满足&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l release,app&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          22m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l release=stable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          22m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l release=stable --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          22m   app=myapp,release=stable,tier=frontend&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# !=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# 没有release标签也视为不等于&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l release!=stable &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          5d17h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          5d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          5d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          5d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          5d21h&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# in、notin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l &amp;quot;release in (canary,alpha,beta)&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;No resources found.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l &amp;quot;release in (canary,alpha,beta,stable)&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          25m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# 没有release标签也视为不在集合内&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -l &amp;quot;release notin (canary,alpha,beta,stable)&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          5d17h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          5d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          5d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          5d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          5d21h&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;能使用标签的不仅仅包括Pod，各种资源对象都可以打标，包括节点。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get nodes --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       STATUS   ROLES    AGE    VERSION   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;hadoop16   Ready    &amp;lt;none&amp;gt;   19h    v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=hadoop16,kubernetes.io/os=linux&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark17    Ready    &amp;lt;none&amp;gt;   117d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=spark17,kubernetes.io/os=linux&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32    Ready    master   117d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=spark32,kubernetes.io/os=linux,node-role.kubernetes.io/master=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ubuntu31   Ready    &amp;lt;none&amp;gt;   117d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ubuntu31,kubernetes.io/os=linux&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;给节点ubuntu31新增一个标签：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl label node ubuntu31 disktype=ssd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node/ubuntu31 labeled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get nodes --show-labels&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       STATUS   ROLES    AGE    VERSION   LABELS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;hadoop16   Ready    &amp;lt;none&amp;gt;   19h    v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=hadoop16,kubernetes.io/os=linux&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark17    Ready    &amp;lt;none&amp;gt;   117d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=spark17,kubernetes.io/os=linux&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32    Ready    master   117d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=spark32,kubernetes.io/os=linux,node-role.kubernetes.io/master=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ubuntu31   Ready    &amp;lt;none&amp;gt;   117d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=ssd,kubernetes.io/arch=amd64,kubernetes.io/hostname=ubuntu31,kubernetes.io/os=linux&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;当节点有标签以后，我们随后在添加资源时，可以让资源对节点有倾向性。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/78.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;假设我们想让pod-demo这个pod运行在node01上，node01上有个标签是disktype=ssd&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/79.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete -f pod-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-demo&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f pod-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods pod-demo -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       READY   STATUS    RESTARTS   AGE     IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo   2/2     Running   0          2m41s   10.244.2.31   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;注解&quot;&gt;&lt;a href=&quot;#注解&quot; class=&quot;headerlink&quot; title=&quot;注解&quot;&gt;&lt;/a&gt;注解&lt;/h2&gt;&lt;p&gt;资源除了可以使用标签外，还可以使用注解，annotations。资源注解和标签很相像，都是键值。区别是annotations不能用于挑选资源对象，仅用于为对象提供“元数据”。这些元数据有些时候可能被某些程序所用到，而且很重要，会作为基本判断条件。键值长度不再受字符数量限制。labels键值必须是不超过63个字符，键前缀使用域名的话，不超过253字符。&lt;br&gt;annotations其实可以动态编辑的，它不是特别重要的属性字段。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/80.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete -f pod-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-demo&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f pod-demo.yaml       &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/81.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;Pod的生命周期&quot;&gt;&lt;a href=&quot;#Pod的生命周期&quot; class=&quot;headerlink&quot; title=&quot;Pod的生命周期&quot;&gt;&lt;/a&gt;Pod的生命周期&lt;/h2&gt;&lt;p&gt;在Pod创建时，它可能要做初始化。所以在创建启动之前需要一点时间做初始化。所谓的Pod秒级启动，这个秒级不具有实际意义，有的应用程序初始化有的时候需要很长时间，不可能1s之内完成。另外，在写dockerfile的时候，我们应该使用entrypoint脚本来对容器做环境初始化，这个初始化估计都不止1s。&lt;br&gt;Pod能站起来，容器启动起来之前，要经历那么一点点时间。如果这点时间忽略不计的话，那么Pod的生命周期从Pod被创建开始。一个容器只用来运行一个进程，一个Pod中可以运行多个容器，但是一般我们只运行一个容器。Pod内的这个主容器，在运行之前，可能需要做一些环境设定。所以一般来讲，主容器启动之前，可以把这段时间哪来去做别的事。比如运行另外一个容器，这个容器专门为主容器做环境初始化，所以通常被称为&lt;strong&gt;init container&lt;/strong&gt;。这个容器内部程序运行完，就可以退出了，它不会一直存在。初始化容器可以有多个，多个初始化容器是串行执行的。主容器退出了，Pod也就退出了，这两个是一个时间点。&lt;br&gt;在主容器启动时，它也需要把应用程序环境初始化，比如说要用entrypoint生成一个配置文件，再比如要运行一个tomcat，tomcat要把war文件内容展开部署等。所以在主容器刚刚启动之后，用户可以手动嵌入做一些操作，可以做一个 post start，比如执行完一个命令就退出。&lt;br&gt;如果我们的主容器要退出，在结束之前，也可以做一些事情，pre stop。类似于awk的BEGIN和END。&lt;br&gt;另外，在整个主容器的执行过程当中，我们还可以做两类操作，一般而言，在post start执行之后，我们就可以做两类检测了，在k8s中，支持两类对Pod中容器的检测。第一种检测：liveness probe，主进程还是否处于存活状态。但是就算这个主进程在运行，也不一定意味着能正常提供服务。liveness probe是做存活状态检测。因为一个Pod内是可以有多个容器的，通常我们称为 主容器 和 辅助容器。所以每一个容器，尤其是主容器，我们应该对它正常与否、以及就绪与否做状态检测。分别是liveness probe和readiness probe。无论是哪种probe，都可以支持三种探测行为：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1.执行自定义命令&lt;/li&gt;
&lt;li&gt;2.向指定的套接字发TCP请求&lt;/li&gt;
&lt;li&gt;3.向指定的HTTP服务发请求&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;liveness probe只要用来判断主容器是否处于运行状态的，readiness probe用于判定容器中的主进程是否准备就绪并可以对外提供服务。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/82.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;整个Pod从创建到结束之前，Pod一定会处于某种状态之中。&lt;strong&gt;所以Pod有多种状态：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pending：挂起。我们请求创建这个Pod时，条件不能满足，调度没完成，就更别提启动了&lt;/li&gt;
&lt;li&gt;Running：运行中。&lt;/li&gt;
&lt;li&gt;Failed：失败。&lt;/li&gt;
&lt;li&gt;Successed: 有些状态时间很短。&lt;/li&gt;
&lt;li&gt;Unknown: 为什么会未知呢？因为所谓一个Pod处于什么状态，是apiserver跟运行这个Pod的节点上的kubelet通信来获取Pod的状态信息的。如果kubelet本身出故障了，那么很显然此时apiserver肯定连不上kubelet，也就得不到信息了。类似于这样&lt;br&gt;…&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;创建Pod经历的阶段：&lt;/strong&gt;&lt;br&gt;当用户创建Pod时，这个请求要提交给apiserver，apiserver先把创建请求的目标状态保存在etcd中，而后apiserver之后会请求Scheduler进行调度。如果调度成功了，会把调度结果保存在etcd中。随后目标节点，比如node01，node01上的kubelet通过apiserver当中的状态变化，就知道有一个新的任务给自己了。所以kubelet会通过apiserver拿到此前用户创建的清单，根据清单在当前节点上去创建启动这个Pod。然后将Pod的状态发回给apiserver，apiserver在更新到etcd中。&lt;br&gt;而Pod整个生命周期中有非常多的重要行为，如上面的图及分析。&lt;br&gt;Pod生命周期中的重要行为: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;初始化容器&lt;/li&gt;
&lt;li&gt;启动前钩子、结束前钩子&lt;/li&gt;
&lt;li&gt;容器探测: &lt;ul&gt;
&lt;li&gt;liveness&lt;/li&gt;
&lt;li&gt;readiness&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;restartPolicy: Pod的重启策略。&lt;/strong&gt;比如做liveness探测后发现容器挂了，Pod还在。此时容器要不要重启，要取决于这个字段。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Always：&lt;/li&gt;
&lt;li&gt;OnFailure：状态为错误时才会重启，正常停止是不重启的。&lt;/li&gt;
&lt;li&gt;Never.：从不重启，挂了就挂了。Default to Always.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;重启逻辑：第一次重启是一停止，就立即重启。第二次重启就要延时了，比如第二次重启是终止后等10s在重启。第三次重启等20s，第四次重启等40s…300s是最长的等待时间。为了防止不断重启给系统造成压力。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl explain pods.spec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;restartPolicy        &amp;lt;string&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Restart policy for all containers within the pod. One of Always, OnFailure,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Never. Default to Always. More info:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;当我们想终止某个Pod，我们应该对其平滑终止。这样才会确保数据不会丢失。比如MariaDB，我们想要结束这个Pod，强行kill掉有可能会导致数据丢失。因此在提交删除一个Pod的时候，它是不会上来就kill掉而删除的，而是像Pod内的每一个容器发送终止term信号，让Pod中的容器正常进行终止。这个终止会给个宽限期，比如30s。宽限期到了，那就只能发送kill信号了。Pod的宽限期一般是30s，可以自己指定时长。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Pod控制器资源配置清单重要字段详解&quot;&gt;&lt;a href=&quot;#Pod控制器资源配置清单重要字段详解&quot; class=&quot;headerlink&quot; title=&quot;Pod控制器资源配置清单重要字段详解&quot;&gt;&lt;/a&gt;Pod控制器资源配置清单重要字段详解&lt;/h2&gt;&lt;p&gt;资源的清单格式:&lt;br&gt;一级字段：apiVersion(group/version), kind, metadata(name,namespace,labels,annotations,…), spec, status(只读)&lt;br&gt;
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes资源清单定义</title>
    <link href="http://yoursite.com/2019/08/05/Kubernetes%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E5%AE%9A%E4%B9%89/"/>
    <id>http://yoursite.com/2019/08/05/Kubernetes资源清单定义/</id>
    <published>2019-08-05T00:54:38.000Z</published>
    <updated>2019-08-05T03:02:10.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;资源和对象&quot;&gt;&lt;a href=&quot;#资源和对象&quot; class=&quot;headerlink&quot; title=&quot;资源和对象&quot;&gt;&lt;/a&gt;资源和对象&lt;/h2&gt;&lt;p&gt;Kubernetes之上常用的资源，它把所有内容都抽象为资源，把资源实例化出来后称为对象。&lt;br&gt;&lt;strong&gt;Kubernetes核心资源：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;workload： 工作负载型资源，运行应用程序，对外提供服务。&lt;br&gt;Pod, ReplicaSet, Deployment, StatefulSet, DaemonSet, Job, Cronjob, … &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;跟服务发现及均衡相关：&lt;br&gt;Service, Ingress, …&lt;/li&gt;
&lt;li&gt;配置与存储相关：&lt;br&gt;Volume, CSI：还支持容器存储接口来对接第三方存储卷, ConfigMap, Secret, DownwardAPI&lt;/li&gt;
&lt;li&gt;集群级的资源：上面提到的都是配置在名称空间级别的资源。只不过没指都是default名称空间的。而有些资源需要在集群级别定义。&lt;br&gt;Namespace, Node, Role, ClusterRole, RoleBinding, ClusterRoleBinding&lt;/li&gt;
&lt;li&gt;元数据型资源：&lt;br&gt;HPA：能够自动去调整其他资源的元数据信息。&lt;br&gt;PodTemplate, LimitRange&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;资源清单示例&quot;&gt;&lt;a href=&quot;#资源清单示例&quot; class=&quot;headerlink&quot; title=&quot;资源清单示例&quot;&gt;&lt;/a&gt;资源清单示例&lt;/h2&gt;&lt;p&gt;在上一篇博文中，我们使用了命令去创建了一些资源。在创建这些资源时，除了使用命令去创建，还可以使用配置清单来创建。举例看看配置清单是什么样子的：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;96&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;97&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;98&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          2d15h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          2d18h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          2d18h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          2d18h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          2d19h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pod myapp-5bc569c47d-qq8lb -o yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  creationTimestamp: &amp;quot;2019-08-02T06:54:36Z&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  generateName: myapp-5bc569c47d-&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    pod-template-hash: 5bc569c47d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    run: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: myapp-5bc569c47d-qq8lb&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ownerReferences:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - apiVersion: apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    blockOwnerDeletion: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    controller: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    kind: ReplicaSet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name: myapp-5bc569c47d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    uid: f241ea22-b4eb-11e9-9e1c-60a44c223099&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  resourceVersion: &amp;quot;13132088&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  selfLink: /api/v1/namespaces/default/pods/myapp-5bc569c47d-qq8lb&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  uid: 64232e79-b4f2-11e9-9e1c-60a44c223099&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imagePullPolicy: IfNotPresent&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    resources: &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    terminationMessagePath: /dev/termination-log&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    terminationMessagePolicy: File&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    volumeMounts:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      name: default-token-wb7fl&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      readOnly: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  dnsPolicy: ClusterFirst&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  enableServiceLinks: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  nodeName: ubuntu31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  priority: 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  restartPolicy: Always&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  schedulerName: default-scheduler&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  securityContext: &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  serviceAccount: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  serviceAccountName: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  terminationGracePeriodSeconds: 30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  tolerations:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - effect: NoExecute&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    key: node.kubernetes.io/not-ready&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    operator: Exists&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tolerationSeconds: 300&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - effect: NoExecute&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    key: node.kubernetes.io/unreachable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    operator: Exists&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tolerationSeconds: 300&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  volumes:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: default-token-wb7fl&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    secret:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      defaultMode: 420&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      secretName: default-token-wb7fl&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;status:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  conditions:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - lastProbeTime: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lastTransitionTime: &amp;quot;2019-08-02T06:54:46Z&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    status: &amp;quot;True&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    type: Initialized&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - lastProbeTime: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lastTransitionTime: &amp;quot;2019-08-02T06:54:49Z&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    status: &amp;quot;True&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    type: Ready&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - lastProbeTime: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lastTransitionTime: &amp;quot;2019-08-02T06:54:49Z&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    status: &amp;quot;True&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    type: ContainersReady&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - lastProbeTime: null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lastTransitionTime: &amp;quot;2019-08-02T06:54:36Z&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    status: &amp;quot;True&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    type: PodScheduled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containerStatuses:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - containerID: docker://bebf87f526684a20413175bce9f9aa2382bd000ef5b9446c49e390d585e04db8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    imageID: docker-pullable://ikubernetes/myapp@sha256:9c3dc30b5219788b2b8a4b065f548b922a34479577befb54b03330999d30d513&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    lastState: &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ready: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    restartCount: 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    state:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      running:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        startedAt: &amp;quot;2019-08-02T06:54:48Z&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  hostIP: 172.16.206.31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  phase: Running&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  podIP: 10.244.2.12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  qosClass: BestEffort&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  startTime: &amp;quot;2019-08-02T06:54:46Z&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【说明】：&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;apiVersion: v1&lt;/strong&gt;&lt;br&gt;指定该对象属于k8s的哪个api版本，或者叫api组。这叫api群组的名称和版本。我们给定apiversion时有两个部分组成，group/version。如果group省略，表示core，核心组，最根本的资源。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;kind: Pod&lt;/strong&gt;&lt;br&gt;资源类别，Pod、控制器、service都是资源。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;metadata：&lt;/strong&gt;&lt;br&gt;元数据。内部嵌套了很多二级字段，甚至三级字段来定义。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;spec:&lt;/strong&gt;&lt;br&gt;可以理解为“规格”。我们要去定义接下来要创建的资源对象应该具有什么样的特性，或者应该满足什么样的规范。比如说容器有几个，每个容器应该用什么镜像文件来创建。包括它的容忍度，能容忍哪些污点。这也是资源对象中一个最重要的字段，因为它正是用来定义我们所期望的资源应该拥有什么样的特性。而后靠控制器来确保它的特性能够被满足。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;status:&lt;/strong&gt;&lt;br&gt;spec用来让用户定义一个资源对象应该所处的目标状态。而status则是显示当前这个资源的当前状态。如果当前状态和目标状态不一样怎么办？应该以目标状态为准。k8s保证当前状态无限向目标状态靠近或转移从而能满足用户期望。因此从这个角度讲，status应该是只读的，因为会动态维护。而spec是用户定义的。&lt;/p&gt;
&lt;h2 id=&quot;创建资源的方法&quot;&gt;&lt;a href=&quot;#创建资源的方法&quot; class=&quot;headerlink&quot; title=&quot;创建资源的方法&quot;&gt;&lt;/a&gt;创建资源的方法&lt;/h2&gt;&lt;p&gt;1.在定义资源时，apiserver仅接收JSON格式的资源定义；&lt;br&gt;之前通过kubectl run创建一个deployment的时候，run命令被自动把我们给的内容转成了JSON格式而已。但JSON格式写起来太重量级了，而yaml格式几乎没有冗余数据。人更容易理解和记忆的是yaml格式的。&lt;/p&gt;
&lt;p&gt;2.提供yaml格式的配置清单&lt;br&gt;apiserver可自动将其转为JSON格式，而后在执行。JSON格式对于apiserver才是根本。&lt;/p&gt;
&lt;h2 id=&quot;资源的配置清单详解&quot;&gt;&lt;a href=&quot;#资源的配置清单详解&quot; class=&quot;headerlink&quot; title=&quot;资源的配置清单详解&quot;&gt;&lt;/a&gt;资源的配置清单详解&lt;/h2&gt;&lt;p&gt;大部分资源的配置清单都有5个一级字段组成：&lt;/p&gt;
&lt;h3 id=&quot;apiVersion-group-version&quot;&gt;&lt;a href=&quot;#apiVersion-group-version&quot; class=&quot;headerlink&quot; title=&quot;apiVersion: group/version&quot;&gt;&lt;/a&gt;apiVersion: group/version&lt;/h3&gt;&lt;p&gt;api版本。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# kubectl api-versions&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;admissionregistration.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiextensions.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiregistration.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiregistration.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apps/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apps/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apps/v1beta2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;authentication.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;authentication.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;authorization.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;authorization.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;autoscaling/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;autoscaling/v2beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;autoscaling/v2beta2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;batch/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;batch/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;certificates.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coordination.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coordination.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;events.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;extensions/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;networking.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;networking.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;node.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;policy/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rbac.authorization.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rbac.authorization.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;scheduling.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;scheduling.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;storage.k8s.io/v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;storage.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;v1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;资源所属群组，k8s把apiserver中所支持的api有多少种，分组来管理。&lt;br&gt;分组的好处是：如果不分组，假设将来要更新一个，牵一发而动全身。而现在分成组以后，如果某一组当中的改变了，我们只需要改这一个组就可以了，其他组不受影响，可以继续使用。另外，组还加了版本号，同一个群组的多个不同版本还可以并存。Pod是最核心的资源，所以属于核心群组v1。像控制器Deployment、ReplicaSet等属于应用程序管理的资源，属于群组apps/v1。在创建Deployment的时候，可以使用apps/v1，也可以使用apps/v1beta1，或者apps/v1beta2。如果某一组标记为beta，意味着属于公测版。不同的版本，对于同一个资源来讲，可支持的字段有可能是不一样的。&lt;/p&gt;
&lt;h3 id=&quot;kind&quot;&gt;&lt;a href=&quot;#kind&quot; class=&quot;headerlink&quot; title=&quot;kind&quot;&gt;&lt;/a&gt;kind&lt;/h3&gt;&lt;p&gt;资源类别&lt;/p&gt;
&lt;h3 id=&quot;metadata&quot;&gt;&lt;a href=&quot;#metadata&quot; class=&quot;headerlink&quot; title=&quot;metadata&quot;&gt;&lt;/a&gt;metadata&lt;/h3&gt;&lt;p&gt;元数据&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;name，对象名称&lt;/li&gt;
&lt;li&gt;namespace: 对象属于哪个名称空间的&lt;/li&gt;
&lt;li&gt;labels：标签&lt;/li&gt;
&lt;li&gt;annotation：资源注解&lt;/li&gt;
&lt;li&gt;uid：系统自己生成的，不要自己去定义。自己去定义有可能冲突。&lt;/li&gt;
&lt;li&gt;每个资源的引用PATH：基于HTPP&lt;br&gt;/api/GROUP/VERSION/namespaces/NAMESPACE/TYPE/NAME&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/64.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;spec&quot;&gt;&lt;a href=&quot;#spec&quot; class=&quot;headerlink&quot; title=&quot;spec&quot;&gt;&lt;/a&gt;spec&lt;/h3&gt;&lt;p&gt;期望的状态。disired state。&lt;br&gt;不同的资源类型，spec中所需要嵌套的字段不尽相同。字段这么多，我们可能无法全部记下来，可以通过命令行来查看文档。比如查看Pod清单定义文档：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/65.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.metadata&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/66.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.spec&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/67.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl explain pods.spec.containers&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/68.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/69.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;status&quot;&gt;&lt;a href=&quot;#status&quot; class=&quot;headerlink&quot; title=&quot;status&quot;&gt;&lt;/a&gt;status&lt;/h3&gt;&lt;p&gt;资源当前状态，current state。&lt;br&gt;该字段由Kubernetes集群维护，用户不能定义和删除。&lt;/p&gt;
&lt;h2 id=&quot;清单定义示例&quot;&gt;&lt;a href=&quot;#清单定义示例&quot; class=&quot;headerlink&quot; title=&quot;清单定义示例&quot;&gt;&lt;/a&gt;清单定义示例&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# mkdir manifests&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# cd manifests/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim pod-demo.yaml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: Pod&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;metadata:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: pod-demo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  namespace: default&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  labels:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    app: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    tier: frontend&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spec:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  containers:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: ikubernetes/myapp:v1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - name: busybox&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    image: busybox:latest&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    command:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - &amp;quot;/bin/sh&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - &amp;quot;-c&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    - &amp;quot;sleep 3600&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/70.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;【说明】：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;containers的值是个对象列表，列表我们使用 []  或者 - 来引导。&lt;br&gt;容器名、容器镜像。一个pod内可以有多个容器。&lt;/li&gt;
&lt;li&gt;对于busybox这个镜像启动起来运行的命令是shell，启动起来一会就挂了，所以需要需要额外改个命令来运行，使用command。command是个列表，可以使用[]，也可以使用 - 来引导。对于第一个镜像没有加command，表示运行镜像启动后默认的命令。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/71.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;访问myapp服务：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE     IP            NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running   1          2d16h   10.244.2.27   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running   0          2d19h   10.244.2.12   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running   0          2d19h   10.244.2.13   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running   0          2d19h   10.244.1.9    spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          2d21h   10.244.1.5    spark17    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                       2/2     Running   0          12m     10.244.2.28   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# curl 10.244.2.28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v1 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看日志：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/72.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;进入Pod中的myapp容器：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/73.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;删除这个Pod：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete pod pod-demo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-demo&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl get pods -w&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS        RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client-69fd89d767-95nqt        1/1     Running       1          2d17h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qq8lb         1/1     Running       0          2d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-stvj9         1/1     Running       0          2d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-tzlsf         1/1     Running       0          2d20h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running       0          2d21h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                       2/2     Terminating   0          19m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                       0/2     Terminating   0          19m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                       0/2     Terminating   0          19m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                       0/2     Terminating   0          19m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod-demo                       0/2     Terminating   0          19m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再次创建这个Pod：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl create -f pod-demo.yaml &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod/pod-demo created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;删除这个清单文件中定义的资源：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# kubectl delete -f pod-demo.yaml       &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pod &amp;quot;pod-demo&amp;quot; deleted&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这个文件里定义的资源Pod是“自主式Pod”，不受任何控制器控制的，这种Pod一删除就没了。不像控制器控制的Pod，哪怕删了，也会根据副本数量进行重新创建。&lt;/p&gt;
&lt;h2 id=&quot;kubectl管理资源的方式&quot;&gt;&lt;a href=&quot;#kubectl管理资源的方式&quot; class=&quot;headerlink&quot; title=&quot;kubectl管理资源的方式&quot;&gt;&lt;/a&gt;kubectl管理资源的方式&lt;/h2&gt;&lt;p&gt;有三种方式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;命令式&lt;/li&gt;
&lt;li&gt;刚刚上面演示的配置清单式&lt;/li&gt;
&lt;li&gt;第三种也是清单，但要使用另外的命令。和第二种方式的区别为：第二种叫命令式资源清单，第三种叫声明式资源清单。使用声明式，我们可以确保资源尽可能地像我们声明的状态改变，而且可以随时改变我们的声明，并随时应用。后面的博文中将介绍使用声明式方式创建资源。&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;资源和对象&quot;&gt;&lt;a href=&quot;#资源和对象&quot; class=&quot;headerlink&quot; title=&quot;资源和对象&quot;&gt;&lt;/a&gt;资源和对象&lt;/h2&gt;&lt;p&gt;Kubernetes之上常用的资源，它把所有内容都抽象为资源，把资源实例化出来后称为对象。&lt;br&gt;&lt;strong&gt;Kubernetes核心资源：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;workload： 工作负载型资源，运行应用程序，对外提供服务。&lt;br&gt;Pod, ReplicaSet, Deployment, StatefulSet, DaemonSet, Job, Cronjob, …
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes应用快速入门</title>
    <link href="http://yoursite.com/2019/08/02/kubernetes%E5%BA%94%E7%94%A8%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
    <id>http://yoursite.com/2019/08/02/kubernetes应用快速入门/</id>
    <published>2019-08-02T02:13:30.000Z</published>
    <updated>2019-08-02T07:20:49.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;kubectl简介&quot;&gt;&lt;a href=&quot;#kubectl简介&quot; class=&quot;headerlink&quot; title=&quot;kubectl简介&quot;&gt;&lt;/a&gt;kubectl简介&lt;/h2&gt;&lt;p&gt;API Server是Kubernetes集群的网关，任何人只能通过API Server接口与集群进行交互。而kubectl是Kubernetes的终端客户端，此前博客里讲解的使用kubeadm初始化Kubernetes集群时，&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;kubeadm init自动生成的/etc/kubernetes/admin.conf是kubectl接入k8s集群时使用的kubeconfig配置文件，它内建了用于访问Kubernetes集群的最高管理权限的用户账号及相关的认证凭据。&lt;br&gt;kubectl提供了基于命令行访问Kubernetes API的简洁方式，能够满足对Kubernetes的绝大部分的操作需求。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/42.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/43.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;taint：&lt;/strong&gt;污点。taint是跟高级调度相关的，给节点增加污点以后，能容忍这污点的pod就可以调度到这个节点上，否则就不能调度上来。其实master上就有很多的污点，这就是为什么我们创建pod不会调度到master节点上。因为默认创建的所有pod都无法容忍master的污点。这样确保了master只用于运行apiserver等组件。我们在定义pod时可以定义容忍度(tolerance)。&lt;br&gt;查看master节点上的污点：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get nodes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       STATUS   ROLES    AGE    VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark17    Ready    &amp;lt;none&amp;gt;   111d   v1.14.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32    Ready    master   111d   v1.14.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ubuntu31   Ready    &amp;lt;none&amp;gt;   111d   v1.14.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl describe node spark32&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/44.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;查看node上有没有污点：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/45.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;查看集群信息和集群组件状态信息：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/46.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;kubectl增删改查&quot;&gt;&lt;a href=&quot;#kubectl增删改查&quot; class=&quot;headerlink&quot; title=&quot;kubectl增删改查&quot;&gt;&lt;/a&gt;kubectl增删改查&lt;/h2&gt;&lt;h3 id=&quot;示例1：创建一个Nginx的Pod&quot;&gt;&lt;a href=&quot;#示例1：创建一个Nginx的Pod&quot; class=&quot;headerlink&quot; title=&quot;示例1：创建一个Nginx的Pod&quot;&gt;&lt;/a&gt;示例1：创建一个Nginx的Pod&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/47.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl run nginx-deploy --image=nginx:1.14-alpine --port=80 --replicas=1 --dry-run=true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/nginx-deploy created (dry run)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You have mail in /var/spool/mail/root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl run nginx-deploy --image=nginx:1.14-alpine --port=80 --replicas=1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/nginx-deploy created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get deployment&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME           READY   UP-TO-DATE   AVAILABLE   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy   1/1     1            1           8s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-bh8z5   1/1     Running   0          26s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-bh8z5   1/1     Running   0          35s   10.244.2.5   ubuntu31   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;【说明】：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;–dry-run=true：干跑模式，并没有真正运行&lt;/li&gt;
&lt;li&gt;–port=80：不指定这个也会暴露容器中的相应端口&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/48.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/49.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;这是Pod的地址，只能在k8s集群内使用。Pod的客户端一般有两类：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;其他Pod&lt;/li&gt;
&lt;li&gt;集群外部客户端：怎么访问？&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Pod地址可能会变化的，假设我们误删除了pod：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@spark32 ~]# kubectl get pods
NAME                           READY   STATUS    RESTARTS   AGE
nginx-deploy-55d8d67cf-bh8z5   1/1     Running   0          9m10s
[root@spark32 ~]# kubectl delete pods nginx-deploy-55d8d67cf-bh8z5
pod &amp;quot;nginx-deploy-55d8d67cf-bh8z5&amp;quot; deleted
[root@spark32 ~]# kubectl get pods -o wide
NAME                           READY   STATUS    RESTARTS   AGE   IP           NODE      NOMINATED NODE   READINESS GATES
nginx-deploy-55d8d67cf-qrd2s   1/1     Running   0          11s   10.244.1.4   spark17   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;删除了pod，控制器Deployment发现副本少了一个，会自动创建一个。但是这个新Pod的IP地址已经变了，跑到另外一个node主机上去了。&lt;br&gt;在上一篇博文中，提到了需要在Pod前创建一个service，让service关联到Pod上。这样用户在访问时只需要访问service的地址或名称，只要service不被删除，后端的Pod因为各种原因被终止掉或删除掉后重新创建后，哪怕IP地址变了也没什么关系。&lt;/p&gt;
&lt;h3 id=&quot;示例2：创建service&quot;&gt;&lt;a href=&quot;#示例2：创建service&quot; class=&quot;headerlink&quot; title=&quot;示例2：创建service&quot;&gt;&lt;/a&gt;示例2：创建service&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl expose --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      --type=&amp;apos;&amp;apos;: Type for this service: ClusterIP, NodePort, LoadBalancer, or ExternalName. Default is &amp;apos;ClusterIP&amp;apos;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl expose (-f FILENAME | TYPE NAME) [--port=port] [--protocol=TCP|UDP|SCTP] [--target-port=number-or-name]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[--name=name] [--external-ip=external-ip-of-service] [--type=type] [options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;【说明】：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;–type=’’：指定service类型。service类型有4种，默认是ClusterIP。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl expose deployment nginx-deploy --name=nginx --port=80 --target-port=80 --protocol=TCP&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/nginx exposed&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You have mail in /var/spool/mail/root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   ClusterIP   10.96.0.1        &amp;lt;none&amp;gt;        443/TCP   111d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx        ClusterIP   10.109.152.170   &amp;lt;none&amp;gt;        80/TCP    10s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/50.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;【说明】：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;svc是service的简称&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;通过service访问服务：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# curl 10.109.152.170&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;title&amp;gt;Welcome to nginx!&amp;lt;/title&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;style&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    body &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        width: 35em;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        margin: 0 auto;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        font-family: Tahoma, Verdana, Arial, sans-serif;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/style&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;h1&amp;gt;Welcome to nginx!&amp;lt;/h1&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;If you see this page, the nginx web server is successfully installed and&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;working. Further configuration is required.&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;For online documentation and support please refer to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;a href=&amp;quot;http://nginx.org/&amp;quot;&amp;gt;nginx.org&amp;lt;/a&amp;gt;.&amp;lt;br/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Commercial support is available at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;a href=&amp;quot;http://nginx.com/&amp;quot;&amp;gt;nginx.com&amp;lt;/a&amp;gt;.&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;&amp;lt;em&amp;gt;Thank you for using nginx.&amp;lt;/em&amp;gt;&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/html&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;外部节点，是无法通过service这个地址来访问这个服务的。&lt;br&gt;更多的时候，这个service地址是被Pod客户端来访问的，而且被访问时是完全可以基于service名称来访问。只不过需要Pod客户端可以解析名称，这就需要用到CoreDNS服务。之前的博文《kubeadm安装kubernetes 1.14.0》里安装集群时已经把CoreDNS这个附件安装好了。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/51.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;创建个Pod，作为客户端：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl run client --image=busybox --replicas=1 -it --restart=Never&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;If you don&amp;apos;t see a command prompt, try pressing enter.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # cat /etc/resolv.conf &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nameserver 10.96.0.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;search default.svc.cluster.local svc.cluster.local cluster.local&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;options ndots:5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # nslookup nginx.default.svc.cluster.local&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Server:         10.96.0.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Address:        10.96.0.10:53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;*** Can&amp;apos;t find nginx.default.svc.cluster.local: No answer&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # ping nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;PING nginx (10.109.152.170): 56 data bytes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;^C&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;--- nginx ping statistics ---&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5 packets transmitted, 0 packets received, 100% packet loss&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # wget -O - -q nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;title&amp;gt;Welcome to nginx!&amp;lt;/title&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;style&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    body &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        width: 35em;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        margin: 0 auto;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        font-family: Tahoma, Verdana, Arial, sans-serif;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/style&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;h1&amp;gt;Welcome to nginx!&amp;lt;/h1&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;If you see this page, the nginx web server is successfully installed and&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;working. Further configuration is required.&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;For online documentation and support please refer to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;a href=&amp;quot;http://nginx.org/&amp;quot;&amp;gt;nginx.org&amp;lt;/a&amp;gt;.&amp;lt;br/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Commercial support is available at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;a href=&amp;quot;http://nginx.com/&amp;quot;&amp;gt;nginx.com&amp;lt;/a&amp;gt;.&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;&amp;lt;em&amp;gt;Thank you for using nginx.&amp;lt;/em&amp;gt;&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # curl nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sh: curl: not found&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;【说明】：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pod中的默认DNS就是CoreDNS service的地址。&lt;/li&gt;
&lt;li&gt;svc.cluster.local：这是特殊的域名，表示是你的Kubernetes集群的本地Pod资源，特定后缀。&lt;/li&gt;
&lt;li&gt;default：Pod所属于的名称空间的名称。&lt;/li&gt;
&lt;li&gt;ping nginx，解析到的IP地址10.109.152.170是nginx这个service的IP地址，至于为什么ping不通，是因为service的地址仅仅是存在于iptables规则或ipvs规则中。&lt;/li&gt;
&lt;li&gt;在Pod中可以使用service名称来访问，因为有DNS可以解析service的名称&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们可以在节点上解析这个service名称：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# dig -t A nginx.default.svc.cluster.local @10.96.0.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;; &amp;lt;&amp;lt;&amp;gt;&amp;gt; DiG 9.9.4-RedHat-9.9.4-29.el7 &amp;lt;&amp;lt;&amp;gt;&amp;gt; -t A nginx.default.svc.cluster.local @10.96.0.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; global options: +cmd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; Got answer:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; -&amp;gt;&amp;gt;HEADER&amp;lt;&amp;lt;- opcode: QUERY, status: NOERROR, id: 53679&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; WARNING: recursion requested but not available&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; OPT PSEUDOSECTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;; EDNS: version: 0, flags:; udp: 4096&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; QUESTION SECTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;nginx.default.svc.cluster.local. IN    A&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; ANSWER SECTION:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx.default.svc.cluster.local. 5 IN   A       10.109.152.170&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; Query time: 0 msec&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; SERVER: 10.96.0.10#53(10.96.0.10)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; WHEN: Fri Aug 02 13:37:22 CST 2019&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;;; MSG SIZE  rcvd: 107&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;【注意】：在节点级解析service时需要输入service名称的全程，而不能仅仅使用service的简称来解析，因为节点级别的搜索域和Pod内的搜索域是不一样的。&lt;/p&gt;
&lt;p&gt;这个service调度给我们之前创建的Pod了，service给有生命周期的Pod提供了固定访问的端点。我们现在人为把nginx Pod搞挂。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/52.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;接着在Pod客户端再次访问下service：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/53.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;当一个service生成时，会在每个节点上生成相应的iptables规则或ipvs规则，当客户端访问这个service地址和相应的端口时，就会调度到这个service利用标签选择器关联到的Pod了。&lt;br&gt;在上面的示例中，会把所有访问10.109.152.170:80这个地址的都调度至这个service用label-selector(标签选择器)关联到的各Pod后端。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/54.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;当我们修改这个service或者删除这个service再重新建个service，会立刻反应到CoreDNS的解析记录中去。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl delete svc nginx    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service &amp;quot;nginx&amp;quot; deleted&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl expose deployment nginx-deploy --name=nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/nginx exposed&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   ClusterIP   10.96.0.1        &amp;lt;none&amp;gt;        443/TCP   111d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx        ClusterIP   10.107.191.247   &amp;lt;none&amp;gt;        80/TCP    44s&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;service对应的IP已经改变了，我们在Pod客户端里再测试下访问这个service，发现仍然可以根据service名称访问：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;/ # wget -O - -q nginx&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;html&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;title&amp;gt;Welcome to nginx!&amp;lt;/title&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;style&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    body &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        width: 35em;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        margin: 0 auto;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        font-family: Tahoma, Verdana, Arial, sans-serif;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/style&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/head&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;h1&amp;gt;Welcome to nginx!&amp;lt;/h1&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;If you see this page, the nginx web server is successfully installed and&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;working. Further configuration is required.&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;For online documentation and support please refer to&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;a href=&amp;quot;http://nginx.org/&amp;quot;&amp;gt;nginx.org&amp;lt;/a&amp;gt;.&amp;lt;br/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Commercial support is available at&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;a href=&amp;quot;http://nginx.com/&amp;quot;&amp;gt;nginx.com&amp;lt;/a&amp;gt;.&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;p&amp;gt;&amp;lt;em&amp;gt;Thank you for using nginx.&amp;lt;/em&amp;gt;&amp;lt;/p&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/body&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/html&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例3：副本&quot;&gt;&lt;a href=&quot;#示例3：副本&quot; class=&quot;headerlink&quot; title=&quot;示例3：副本&quot;&gt;&lt;/a&gt;示例3：副本&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl run myapp --image=ikubernetes/myapp:v1 --replicas=2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.apps/myapp created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get deploy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME           READY   UP-TO-DATE   AVAILABLE   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp          2/2     2            2           15s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy   1/1     1            1           171m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/55.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;通过Pod IP访问下服务：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# curl 10.244.2.7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v1 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;为这个deploy创建一个service：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl expose deploy myapp --name=myapp --port=80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;service/myapp exposed&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   ClusterIP   10.96.0.1        &amp;lt;none&amp;gt;        443/TCP   111d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp        ClusterIP   10.109.204.135   &amp;lt;none&amp;gt;        80/TCP    4s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx        ClusterIP   10.107.191.247   &amp;lt;none&amp;gt;        80/TCP    17m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在Pod中访问这个服务：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;/ # wget -O - -q 10.244.2.7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v1 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # wget -O - -q myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v1 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/ # while true; do wget -O - -q myapp/hostname.html; sleep 1; done&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-mkdqg&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qht8j&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qht8j&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qht8j&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-mkdqg&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-mkdqg&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例4：扩展和缩减副本&quot;&gt;&lt;a href=&quot;#示例4：扩展和缩减副本&quot; class=&quot;headerlink&quot; title=&quot;示例4：扩展和缩减副本&quot;&gt;&lt;/a&gt;示例4：扩展和缩减副本&lt;/h3&gt;&lt;p&gt;接着上面的示例，我们扩展myapp这个deployment中的副本。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl scale --replicas=5 deploy myapp &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp scaled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client                         1/1     Running   0          63m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-9sbwq         1/1     Running   0          5s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-cmgsl         1/1     Running   0          5s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-mkdqg         1/1     Running   0          17m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qht8j         1/1     Running   0          17m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-wv7sw         1/1     Running   0          5s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          40m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl scale --replicas=3 deploy myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp scaled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS        RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client                         1/1     Running       0          64m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-9sbwq         0/1     Terminating   0          26s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-cmgsl         1/1     Running       0          26s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-mkdqg         1/1     Running       0          17m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qht8j         1/1     Running       0          17m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-wv7sw         0/1     Terminating   0          26s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running       0          40m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                           READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;client                         1/1     Running   0          64m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-cmgsl         1/1     Running   0          30s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-mkdqg         1/1     Running   0          17m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp-5bc569c47d-qht8j         1/1     Running   0          17m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx-deploy-55d8d67cf-wf28j   1/1     Running   0          40m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;【说明】：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Terminating：表示正在终止Pod。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;示例5：滚动更新程序&quot;&gt;&lt;a href=&quot;#示例5：滚动更新程序&quot; class=&quot;headerlink&quot; title=&quot;示例5：滚动更新程序&quot;&gt;&lt;/a&gt;示例5：滚动更新程序&lt;/h3&gt;&lt;p&gt;除了以上的动态伸缩，还可以做滚动更新。比如将myapp从v1滚动更新到v2。比如现在有3个Pod，它会先替换1个，在替换1个，在替换1个。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl set image --help&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Usage:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  kubectl set image (-f FILENAME | TYPE NAME) CONTAINER_NAME_1=CONTAINER_IMAGE_1 ... CONTAINER_NAME_N=CONTAINER_IMAGE_N&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[options]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看当前Pod所使用的image镜像版本：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/56.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl set image deploy myapp myapp=ikubernetes/myapp:v2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp image updated&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout status deploy myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 1 out of 3 new replicas have been updated...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 1 out of 3 new replicas have been updated...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 1 out of 3 new replicas have been updated...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 2 out of 3 new replicas have been updated...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 2 out of 3 new replicas have been updated...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 2 out of 3 new replicas have been updated...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 1 old replicas are pending termination...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Waiting for deployment &amp;quot;myapp&amp;quot; rollout to finish: 1 old replicas are pending termination...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment &amp;quot;myapp&amp;quot; successfully rolled out&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]#&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在Pod中访问下服务，已经全部变为v2版本了：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;/ # while true; do wget -O - -q myapp; sleep 1; done&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v2 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v2 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v2 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v2 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v2 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Hello MyApp | Version: v2 | &amp;lt;a href=&amp;quot;hostname.html&amp;quot;&amp;gt;Pod Name&amp;lt;/a&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例6：回滚&quot;&gt;&lt;a href=&quot;#示例6：回滚&quot; class=&quot;headerlink&quot; title=&quot;示例6：回滚&quot;&gt;&lt;/a&gt;示例6：回滚&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/57.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/58.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl rollout undo deploy myapp     &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deployment.extensions/myapp rolled back&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/59.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;如果需要在集群外部访问myapp，需要修改service类型为NodePort。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get svc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetes   ClusterIP   10.96.0.1        &amp;lt;none&amp;gt;        443/TCP   111d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;myapp        ClusterIP   10.109.204.135   &amp;lt;none&amp;gt;        80/TCP    40m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nginx        ClusterIP   10.107.191.247   &amp;lt;none&amp;gt;        80/TCP    58m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl edit svc myapp&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/60.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;【注意】：kubectl edit在编辑资源时，有些字段是不能这样修改的，后面在写yaml清单文件会介绍。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/61.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;打开浏览器，访问集群任何一个Node的30020端口：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/62.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;但是假如这个Node挂了，对客户端来说就不友好了，它得改地址为其他的Node地址。所以最好手工在集群外做个物理的负载均衡器。&lt;/p&gt;
&lt;p&gt;service到底是什么？&lt;br&gt;service是在集群每个节点上生成的iptables规则或者ipvs规则。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# iptables -L -n -v -t nat&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/63.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;kubectl简介&quot;&gt;&lt;a href=&quot;#kubectl简介&quot; class=&quot;headerlink&quot; title=&quot;kubectl简介&quot;&gt;&lt;/a&gt;kubectl简介&lt;/h2&gt;&lt;p&gt;API Server是Kubernetes集群的网关，任何人只能通过API Server接口与集群进行交互。而kubectl是Kubernetes的终端客户端，此前博客里讲解的使用kubeadm初始化Kubernetes集群时，
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes基础概念</title>
    <link href="http://yoursite.com/2019/07/31/kubernetes%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/"/>
    <id>http://yoursite.com/2019/07/31/kubernetes基础概念/</id>
    <published>2019-07-31T03:38:21.000Z</published>
    <updated>2019-07-31T06:00:16.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;pod分类&quot;&gt;&lt;a href=&quot;#pod分类&quot; class=&quot;headerlink&quot; title=&quot;pod分类&quot;&gt;&lt;/a&gt;pod分类&lt;/h2&gt;&lt;h3 id=&quot;自主式Pod&quot;&gt;&lt;a href=&quot;#自主式Pod&quot; class=&quot;headerlink&quot; title=&quot;自主式Pod&quot;&gt;&lt;/a&gt;自主式Pod&lt;/h3&gt;&lt;p&gt;自我管理。scheduler调度到某台node，pod启动后，如果有容器出现故障，需要重启容器，是由k8s来完成的。但是如果节点故障了，pod就消失了，没法进行全局调度。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;控制器管理端的Pod&quot;&gt;&lt;a href=&quot;#控制器管理端的Pod&quot; class=&quot;headerlink&quot; title=&quot;控制器管理端的Pod&quot;&gt;&lt;/a&gt;控制器管理端的Pod&lt;/h3&gt;&lt;p&gt;Pod控制器，有很多种。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ReplicationController：最早的一种，早期只有这一个控制器。比如启动一个Nginx pod，控制器控制了pod副本，一旦副本数量少了，立马补齐。多了就终止掉多余的Pod。ReplicationController支持滚动更新，比如一开始pod里的容器基于1.0版本的镜像启的，但是现在有新版本了，1.1版本的镜像，可以滚动更新。&lt;/li&gt;
&lt;li&gt;ReplicaSet：副本集控制器。但是ReplicaSet不直接使用，它有个申明是更新的控制器Deployment。&lt;/li&gt;
&lt;li&gt;Deployment：只能管理那些无状态的应用。&lt;/li&gt;
&lt;li&gt;StatefulSet：有状态副本集，管理有状态应用。&lt;/li&gt;
&lt;li&gt;DaemonSet：如果我们需要在每一个node上运行一个副本，而不是随意运行。&lt;/li&gt;
&lt;li&gt;Job，CronJob：作业，周期性作业。Job：比如备份操作，或者一些临时操作，比如现在要处理数据集，临时启用一个pod，清理完数据这个Pod就结束了。这种不需要一直运行着。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在k8s上创建Pod，只需要定义控制器，控制器创建好就会帮我们创建Pod。&lt;br&gt;Deployment控制器还支持二级控制器，叫HPA，称为水平Pod自动升缩控制器。比如一开始运行着两个pod，但是某个时间段用户访问增加，需要增加pod。到底应该加几个呢？HPA控制可以自动进行扩展。比如：判断一下，现在的CPU、内存资源利用率有多高，我们必须要确保平均低于60%，计算后发现需要加两个，那么HPA就扩展了两个。一旦访问量小了，还可以自动减，当然Deployment可以确保至少有几个存在。&lt;/p&gt;
&lt;h2 id=&quot;Service&quot;&gt;&lt;a href=&quot;#Service&quot; class=&quot;headerlink&quot; title=&quot;Service&quot;&gt;&lt;/a&gt;Service&lt;/h2&gt;&lt;p&gt;Pod有生命周期，万一Pod所在的节点宕机了，Pod有可能需要在其他节点上重建的，而重建完的Pod和之前的Pod不是同一个，只不过里面运行的是同一种服务。而且每一个容器都有ip地址，新Pod中的容器的ip地址可能和之前损坏的Pod中容器的ip地址也是不一样的。这样一来就有问题了，客户端怎么访问这些Pod呢？服务发现。客户端在访问后端服务时，应该不是直接访问后端服务的，这就需要服务发现机制了。&lt;br&gt;为了尽可能降低二者之间协调的复杂度，k8s为每一组提供同类服务的Pod和它的客户端之间添加了一个中间层，这个中间层是固定的，就叫service。service只要不删除，它的地址就是固定的，名称也是固定的。而后当客户端需要写在配置文件中访问某个服务时，它也不用再去自动发现某个功能，它只需要在配置文件中写明service地址或者名称就行。这个Service是一个调度器，不但能提供一个稳定的访问入口，还能将客户端带领到对应的Pod之上。一旦Pod因为什么原因消失了，新创建的Pod会立即被service关联进来，怎么实现这个关联的呢？客户端访问服务都是靠ip:port或者主机名:port来访问，service关联后端的pod不是靠IP地址来实现的，而是靠Pod上的元数据Label，标签。service靠&lt;strong&gt;标签选择器&lt;/strong&gt;来关联Pod。关联进来后，service在动态探测这个新Pod的ip地址是什么，端口是什么，并作为自己调度的后端服务器的可用对象。&lt;br&gt;在k8s上，service不是应用程序，也不是实体组件，它只不过是iptables的DNAT规则。我们在创建DNAT规则时，所有到达某地址的都通通被目标地址转换成某某某地址。DNAT规则只是规则，其中的service地址并没有配置到任何一张网卡上，是不存在的，它仅仅出现在规则里，所以service的IP是ping不通的。但是的确可以请求作为服务端。能ping通是因为有TCP/IP协议栈支持这个IP地址，所以它能够在协议栈上进行响应，而这里是没有的，地址仅出现在规则里。&lt;br&gt;service作为k8s中对象来讲，service有自己的名称，相当于这个服务的名称，而名称可以被解析。你可以把service名称解析成service的IP。名称解析得靠dns来实现，装完k8s集群，第一件事就是在k8s集群上部署一个dns pod，以确保各service名称能被解析。像这种Pod是k8s自身服务就需要的Pod，所以称为基础性的Pod，而且也称为集群的附件(附加组件)，Add-ons。可有可无，不作为程序本身的一部分组成。&lt;br&gt;k8s的附件有很多，dns只是其中一个。而且这个dns会动态改变，动态创建，动态删除，动态变动。怎么变动呢？比如说你把service的名称改一改，这会自动触发dns解析记录中对应的名称也改了。还有其他附件，比如监控，promethesure和grafana。&lt;br&gt;service后端可能是多个Pod，DNAT多目标要注意，对Linux来讲，iptables已经将负载均衡的功能主要交由ipvs来实现，因此如果后端是多个Pod时，使用DNAT来实现，在调度效果上可能不太尽如人意。因此在目前最新的1.11版本上，已经把iptables规则进一步改成了ipvs规则。也就意味着当你生成每一个service，就相当于一条ipvs规则，只不过是NAT模型的ipvs。因此支持用户指定的各种调度算法。service的地址是在iptables或ipvs规则中。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/38.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;k8s三种网络&quot;&gt;&lt;a href=&quot;#k8s三种网络&quot; class=&quot;headerlink&quot; title=&quot;k8s三种网络&quot;&gt;&lt;/a&gt;k8s三种网络&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/40.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;第一个网络：Pod网络。&lt;/strong&gt;各Pod运行在一个网络中。Pod地址是配置在Pod内部网络名称空间之上的，是可以ping通的。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;第二个网络：集群网络。&lt;/strong&gt;各service运行在一个网络中。service地址是虚拟的，是假的，只存在于iptables或ipvs的规则当中&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;第三个网络：节点网络。&lt;/strong&gt;各节点运行在一个网络中。节点网络在构建k8s之前就设置好了&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;外部访问时先到达节点网络，由节点网络代理至集群网络，在由集群网络代理至Pod网络。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/39.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;k8s三类通信&quot;&gt;&lt;a href=&quot;#k8s三类通信&quot; class=&quot;headerlink&quot; title=&quot;k8s三类通信&quot;&gt;&lt;/a&gt;k8s三类通信&lt;/h2&gt;&lt;h3 id=&quot;一个Pod内的多个容器通信&quot;&gt;&lt;a href=&quot;#一个Pod内的多个容器通信&quot; class=&quot;headerlink&quot; title=&quot;一个Pod内的多个容器通信&quot;&gt;&lt;/a&gt;一个Pod内的多个容器通信&lt;/h3&gt;&lt;p&gt;lo，本地通信。&lt;/p&gt;
&lt;p&gt;###各Pod间通信&lt;br&gt;无论两个Pod运行在一个节点上还是两个节点上，两个Pod之间的地址不会冲突，大家在同一个网段，而且可以直接通信。是通过物理桥通信或者Overay Network方案(叠加网络)。叠加网络是通过隧道的方式来转发二层报文，使得两个不同节点上的Pod，虽然跨主机，但好像工作在同一个二层网络中一样。叠加器有二层叠加，也有三层叠加。我们可以转发对方的二层报文，或隧道转发对方的三层报文，从而实现叠加网络。使用叠加网络解决docker容器跨主机容器通信，设置每台服务器使用docker0网络要不一样，比如第一台设为172.17.0.xxx，第二台使用172.17.1.xxx，这样所有容器地址都不会冲突，然后通过隧道转发以后，可以直接通信，就相当于在同一个二层网络中一样。云计算中理解最难之一就在网络上。&lt;/p&gt;
&lt;h3 id=&quot;Pod和service之间的通信&quot;&gt;&lt;a href=&quot;#Pod和service之间的通信&quot; class=&quot;headerlink&quot; title=&quot;Pod和service之间的通信&quot;&gt;&lt;/a&gt;Pod和service之间的通信&lt;/h3&gt;&lt;p&gt;两者都在各自的网络中，不是同一个网络，怎么通信？service地址只不过是节点主机中iptables或ipvs中的规则中的地址，所以只需要把容器中报文地址指向网关，网关假如是docker0桥，iptables在当前宿主机上就有规则，当容器需要访问service地址时，会把报文给网关，一般是docker0桥的地址，docker0桥收到以后，通过iptables或ipvs规则表一检查，就知道在哪了。但是service也是有可能变化的，比如被删除，被修改，这时候是如何触发修改iptables或ipvs规则的呢？在每个node上有一个守护进程，叫kube-proxy。负责随时与API server通信，Pod变化后是需要保存在API server中的。API server会生成一个通知事件，这个事件可以被任何关联的组件所接收到，一旦发现某个service背后的pod发生改变，对应的由kube-proxy将变化反应在iptables或ipvs的规则中。service的管理是由kube-proxy实现的。每一个service变动也要靠kube-proxy反应到规则上。&lt;/p&gt;
&lt;h2 id=&quot;etcd和证书&quot;&gt;&lt;a href=&quot;#etcd和证书&quot; class=&quot;headerlink&quot; title=&quot;etcd和证书&quot;&gt;&lt;/a&gt;etcd和证书&lt;/h2&gt;&lt;p&gt;API Server要存储大量的信息，如果某个master挂了，则需要切换到另外一台master，那么master之间需要共享存储，也就是etcd。&lt;br&gt;etcd是键值存储的数据库系统，跟redis很相像。但是etcd本身有很多协调功能是redis不具备的。更像zk。如果etcd宕机了，整个集群就完了。所以etcd要做成至少3节点。etcd本身也是restful风格的集群，也就是通过http/https通讯。如果是http通信，数据就有可能被拿走，所以要配置成https通信。&lt;br&gt;etcd一个端口用于集群通讯，一个端口用于像客户端提供服务。其内部通讯需要一个专门的证书，叫点对点通信的证书。而后像客户端提供服务的时候，如果需要https，得靠另外一套证书。同样的道理，k8s的apiserver，http不可靠，加密https，另外一套证书，因为这套证书是服务于k8s的客户端与服务端之间通信。而且最好不要与etcd属于同一个CA来签署。还有apiserver对外提供服务，一套证书。apiserver与kube-proxy通讯，一套证书。apiserver与kubelet通信，一套证书。一共5个CA，5套证书，为了足够安全。不光是加密，还有认证，所以CA也得是不同的，签证机构得不同。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/40.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;CNI&quot;&gt;&lt;a href=&quot;#CNI&quot; class=&quot;headerlink&quot; title=&quot;CNI&quot;&gt;&lt;/a&gt;CNI&lt;/h2&gt;&lt;p&gt;k8s通过CNI插件体系来接入外部的网络服务解决方案，所以叫容器网络接口。只要网络服务提供商，能遵循CNI开发这个服务，那么这个网络服务商就可以作为k8s的网络解决方案来使用。这些网络解决方案可以以附件的形式托管在集群之上。常见的网络解决方案如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;flannel：网络配置，不支持网络策略，纯粹的叠加网络 &lt;/li&gt;
&lt;li&gt;calico：网络配置，同时支持网络策略。但是这个部署和使用比较难，能基于bgp协议实现。。。&lt;/li&gt;
&lt;li&gt;canel：用第一种方式提供网络，用第二个提供网络策略&lt;/li&gt;
&lt;li&gt;…&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以上解决方案都是第三方公司提供的，这些可以作为附件来运行，也可以作为节点上守护进程来运行。&lt;br&gt;在容器网络的构建中，CNI和kube-proxy两者都有参与。CNI插件的任务是在容器开启时为容器分配IP，并为这个IP构建虚拟设备，另外，CNI插件也负责将容器间通信的协议包（如TCP/UDP等）从K8s集群中的任意一台机器转发到指定容器所在的机器上，再转发到指定容器上。&lt;/p&gt;
&lt;h2 id=&quot;k8s的名称空间&quot;&gt;&lt;a href=&quot;#k8s的名称空间&quot; class=&quot;headerlink&quot; title=&quot;k8s的名称空间&quot;&gt;&lt;/a&gt;k8s的名称空间&lt;/h2&gt;&lt;p&gt;这个名称空间和docker里所用到的名称空间的不一样。&lt;br&gt;整个k8s是作为一个集群存在的，我们可以在里面运行两万个pod，可能会互相干扰。可以把它切割成多个空间，一类pod只运行在一个空间中，这个空间提供的不是真正意义上的网络边界，只是管理边界。比如说第一个空间叫开发空间，所有开发相关的pod都放在这个空间中，第二个是生产环境，所有生产环境的pod都放到这个空间里。将来我们删除这个网络名称空间，可以把这个环境通通移除掉。所以这个名称空间给我们提供了管理的边界。但是第一个名称空间里的pod访问第二个名称空间的pod是没有问题的，所以CNI实现还要支持网络策略定义，可以定义名称空间和名称空间之间，甚至同一个名称空间里的各pod之间能不能互相访问。可以生成iptables规则来隔离他们之间的访问。&lt;br&gt;对k8s来讲&lt;strong&gt;网络功能&lt;/strong&gt;和&lt;strong&gt;网络策略&lt;/strong&gt;是两个维度的内容，flannel只实现网络功能配置。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;pod分类&quot;&gt;&lt;a href=&quot;#pod分类&quot; class=&quot;headerlink&quot; title=&quot;pod分类&quot;&gt;&lt;/a&gt;pod分类&lt;/h2&gt;&lt;h3 id=&quot;自主式Pod&quot;&gt;&lt;a href=&quot;#自主式Pod&quot; class=&quot;headerlink&quot; title=&quot;自主式Pod&quot;&gt;&lt;/a&gt;自主式Pod&lt;/h3&gt;&lt;p&gt;自我管理。scheduler调度到某台node，pod启动后，如果有容器出现故障，需要重启容器，是由k8s来完成的。但是如果节点故障了，pod就消失了，没法进行全局调度。&lt;br&gt;
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Java调用Python脚本</title>
    <link href="http://yoursite.com/2019/05/23/Java%E8%B0%83%E7%94%A8Python%E8%84%9A%E6%9C%AC/"/>
    <id>http://yoursite.com/2019/05/23/Java调用Python脚本/</id>
    <published>2019-05-23T01:44:38.000Z</published>
    <updated>2019-05-23T07:19:56.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;环境和问题&quot;&gt;&lt;a href=&quot;#环境和问题&quot; class=&quot;headerlink&quot; title=&quot;环境和问题&quot;&gt;&lt;/a&gt;环境和问题&lt;/h2&gt;&lt;p&gt;Maven依赖：&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;dependency&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;lt;groupId&amp;gt;org.python&amp;lt;/groupId&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;lt;artifactId&amp;gt;jython-standalone&amp;lt;/artifactId&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;lt;version&amp;gt;2.7.1&amp;lt;/version&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/dependency&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Java代码：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;public class InterpreterExample &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    PythonInterpreter interpreter = null;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    public InterpreterExample()&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        PythonInterpreter.initialize(System.getProperties(),&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                System.getProperties(), new String[0]);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        this.interpreter = new PythonInterpreter();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    void execfile( final String fileName )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        this.interpreter.execfile(fileName);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    PyInstance createClass( final String className, final String opts )&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        return (PyInstance) this.interpreter.eval(className + &amp;quot;(&amp;quot; + opts + &amp;quot;)&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    public static void main(String[] args)&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        //PySystemState sys = Py.getSystemState();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        //sys.path.add(&amp;quot;/Library/Python/2.7/site-packages&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        InterpreterExample ie = new InterpreterExample();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ie.execfile(&amp;quot;./pythonSrc/environment.py&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        PyInstance env = ie.createClass(&amp;quot;Environment&amp;quot;, &amp;quot;None&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        env.invoke(&amp;quot;get_os_version&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;问题：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Python/1.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;原因：&lt;a href=&quot;https://stackoverflow.com/questions/9100909/using-multiprocessing-2-6-2-1-package-in-jython&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://stackoverflow.com/questions/9100909/using-multiprocessing-2-6-2-1-package-in-jython&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;You can&amp;apos;t use it if multiprocessing requires C extensions i.e., if you can&amp;apos;t disable them and the module was not reimplemented for Jython in Java/pure Python. multiprocessing module is included in the stdlib since Python 2.6. Current Jython supports Python 2.5.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;There is no GIL in Jython so you can use threading in many cases where you would use multiprocessing in CPython.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此外Jython还有其他问题：&lt;br&gt;Python执行时的sys.path和Jython的sys.path路径不一致。两者加载类库的路径不一样。&lt;br&gt;代码：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;import org.python.util.PythonInterpreter;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;public class HelloPython &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    public static void main(String[] args) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        PySystemState sys = Py.getSystemState();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        interpreter.execfile(&amp;quot;./pythonSrc/test_sys.py&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;test_sys.py代码：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;import sys&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;print(sys.path)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;打印出来的是：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[&amp;apos;/Users/jkzhao/Documents/work/repository/org/python/jython-standalone/2.7.1/Lib&amp;apos;, &amp;apos;/Users/jkzhao/Documents/work/repository/org/python/jython-standalone/2.7.1/jython-standalone-2.7.1.jar/Lib&amp;apos;, &amp;apos;__classpath__&amp;apos;, &amp;apos;__pyclasspath__/&amp;apos;]&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;直接执行test_sys.py打印sys.path:&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[&amp;apos;/Users/jkzhao/Documents/study/Java/IDEAProjects/call&amp;apos;, &amp;apos;/Library/Python/2.7/site-packages/pip-7.1.0-py2.7.egg&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python27.zip&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/plat-darwin&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/plat-mac&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/plat-mac/lib-scriptpackages&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/Extras/lib/python&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/lib-tk&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/lib-old&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/lib-dynload&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/Extras/lib/python/PyObjC&amp;apos;, &amp;apos;/Library/Python/2.7/site-packages&amp;apos;]&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;常见的java调用python脚本方式&quot;&gt;&lt;a href=&quot;#常见的java调用python脚本方式&quot; class=&quot;headerlink&quot; title=&quot;常见的java调用python脚本方式&quot;&gt;&lt;/a&gt;常见的java调用python脚本方式&lt;/h2&gt;&lt;p&gt;1.通过Jython.jar提供的类库实现：上面使用的就是这种方式&lt;br&gt;2.通过Runtime.getRuntime()开启进程来执行脚本文件&lt;br&gt;介绍下第2种方式：&lt;br&gt;代码：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;public class Cmd &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    public static void main(String[] args) throws IOException, InterruptedException &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        try &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            // using the Runtime exec method:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            String[] arguments = new String[] &amp;#123; &amp;quot;python&amp;quot;, &amp;quot;./pythonSrc/environment.py&amp;quot; &amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            Process p = Runtime.getRuntime().exec(arguments);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            BufferedReader stdInput = new BufferedReader(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    new InputStreamReader(p.getInputStream()));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            BufferedReader stdError = new BufferedReader(new&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    InputStreamReader(p.getErrorStream()));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            // read the output from the command&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            System.out.println(&amp;quot;Here is the standard output of the command:\n&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            String line = null;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            while ((line = stdInput.readLine()) != null) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                System.out.println(line);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            // read any errors from the attempted command&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            System.out.println(&amp;quot;\nHere is the standard error of the command (if any):\n&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            String errline = null;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            while ((errline = stdError.readLine()) != null) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                System.out.println(errline);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            stdInput.close();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            stdError.close();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            int ret = p.waitFor();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            System.out.println(&amp;quot;Process exit code: &amp;quot; + ret);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            if (ret != 0) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                System.out.println(&amp;quot;do something&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;//            System.exit(0);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; catch (Exception e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            System.out.println(&amp;quot;exception happened - here&amp;apos;s what I know: &amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            System.exit(-1);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        System.out.println(&amp;quot;=============&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这样就正常执行了。&lt;br&gt;【注意】：&lt;br&gt;Runtime.exec方法将产生一个本地的进程，并返回一个Process子类的实例,该实例可用于控制进程或取得进程的相关信息。由于调用Runtime.exec方法所创建的子进程没有自己的终端或控制台，因此该子进程的标准IO(如stdin,stdou,stderr)都通过 p.getOutputStream(), p.getInputStream(), p.getErrorStream() 方法重定向给它的父进程了。用户需要用这些stream来向子进程输入数据或获取子进程的输出。&lt;br&gt;但是向标准输出流和标准错误流写数据，而JVM却不读取，数据会暂存在linux缓存区，当缓存区存满之后导致该进程无法继续写数据，会僵死，导致java进程会卡死在waitFor()处。我这里采取的办法是：java进程在waitFor()前不断读取标准输出流和标准错误流。&lt;/p&gt;
&lt;p&gt;参考资料：&lt;br&gt;&lt;a href=&quot;http://alvinalexander.com/java/edu/pj/pj010016&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Running system commands in Java applications&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://www.cnblogs.com/yueshutong/p/9381570.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;用Java执行Python：Jython踩坑笔记&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://yangfangs.github.io/2016/03/16/java-waitfor-block-deadlock/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Java 调用外部命令使用 waitFor() 方法阻塞或锁死&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://blog.csdn.net/caohaicheng/article/details/22928297&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Java执行shell遇到的各种问题&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;环境和问题&quot;&gt;&lt;a href=&quot;#环境和问题&quot; class=&quot;headerlink&quot; title=&quot;环境和问题&quot;&gt;&lt;/a&gt;环境和问题&lt;/h2&gt;&lt;p&gt;Maven依赖：
    
    </summary>
    
    
      <category term="Java" scheme="http://yoursite.com/tags/Java/"/>
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins与sonar集成</title>
    <link href="http://yoursite.com/2019/04/26/Jenkins%E4%B8%8Esonar%E9%9B%86%E6%88%90/"/>
    <id>http://yoursite.com/2019/04/26/Jenkins与sonar集成/</id>
    <published>2019-04-26T12:41:44.000Z</published>
    <updated>2019-04-30T07:29:38.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;部门领导要求扫描代码质量，我们平时是用jenkins来做持续集成和持续发布的，所以就将jenkins和sonar做了集成，在编译完成后sonar自动扫描代码，然后在进行发布。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;sonar简介&quot;&gt;&lt;a href=&quot;#sonar简介&quot; class=&quot;headerlink&quot; title=&quot;sonar简介&quot;&gt;&lt;/a&gt;sonar简介&lt;/h2&gt;&lt;p&gt;SonarQube 是一个开源的代码分析平台, 用来持续分析和评测项目源代码的质量。 通过SonarQube我们可以检测出项目中重复代码，潜在bug，代码风格问题，缺乏单元测试等问题， 并通过一个web ui展示出来。&lt;br&gt;这里摆一张从网上搜到的图：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/11.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;安装配置sonar&quot;&gt;&lt;a href=&quot;#安装配置sonar&quot; class=&quot;headerlink&quot; title=&quot;安装配置sonar&quot;&gt;&lt;/a&gt;安装配置sonar&lt;/h2&gt;&lt;h3 id=&quot;新建普通用户sonar&quot;&gt;&lt;a href=&quot;#新建普通用户sonar&quot; class=&quot;headerlink&quot; title=&quot;新建普通用户sonar&quot;&gt;&lt;/a&gt;新建普通用户sonar&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# useradd sonar&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# passwd sonar&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;输入两次密码&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;下载sonar&quot;&gt;&lt;a href=&quot;#下载sonar&quot; class=&quot;headerlink&quot; title=&quot;下载sonar&quot;&gt;&lt;/a&gt;下载sonar&lt;/h3&gt;&lt;p&gt;下载地址：&lt;a href=&quot;https://www.sonarqube.org/downloads/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.sonarqube.org/downloads/&lt;/a&gt;&lt;br&gt;我这里下载的是长期支持版6.7.7。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# su - sonar&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# wget https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-6.7.7.zip&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# unzip -oq sonarqube-6.7.7.zip&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;MySQL中新建sonar数据库&quot;&gt;&lt;a href=&quot;#MySQL中新建sonar数据库&quot; class=&quot;headerlink&quot; title=&quot;MySQL中新建sonar数据库&quot;&gt;&lt;/a&gt;MySQL中新建sonar数据库&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# mysql -uroot -p&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; create database sonar default charset utf8;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; grant all on sonar.* to sonar@localhost identified by &amp;apos;sonar&amp;apos;;mysql&amp;gt; grant all on sonar.* to zabbix@&amp;apos;%.%.%.%&amp;apos; identified by &amp;apos;sonar&amp;apos;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; flush privileges;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;修改sonar-properties文件&quot;&gt;&lt;a href=&quot;#修改sonar-properties文件&quot; class=&quot;headerlink&quot; title=&quot;修改sonar.properties文件&quot;&gt;&lt;/a&gt;修改sonar.properties文件&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[sonar@res ~]$ cd sonarqube-6.7.7/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[sonar@res sonarqube-6.7.7]$ ls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;bin  conf  COPYING  data  elasticsearch  extensions  lib  logs  temp  web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[sonar@res sonarqube-6.7.7]$ vim conf/sonar.properties&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/12.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;启动-停止sonar&quot;&gt;&lt;a href=&quot;#启动-停止sonar&quot; class=&quot;headerlink&quot; title=&quot;启动/停止sonar&quot;&gt;&lt;/a&gt;启动/停止sonar&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[sonar@res sonarqube-6.7.7]$ bin/linux-x86-64/sonar.sh start&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[sonar@res sonarqube-6.7.7]$ bin/linux-x86-64/sonar.sh stop&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;访问sonar web：&lt;a href=&quot;http://172.16.7.180:9000&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://172.16.7.180:9000&lt;/a&gt;&lt;br&gt;默认账号密码是：admin/admin。登录完成后，建议去修改管理员密码。点击右上角的管理员头像，选择“我的账号”，然后点击“安全”，可以看到修改密码的地方。&lt;/p&gt;
&lt;h3 id=&quot;sonar配置邮件&quot;&gt;&lt;a href=&quot;#sonar配置邮件&quot; class=&quot;headerlink&quot; title=&quot;sonar配置邮件&quot;&gt;&lt;/a&gt;sonar配置邮件&lt;/h3&gt;&lt;p&gt;使用管理员账号登录sonar web，点击第一行菜单中的“配置”。往下拉，在左侧最下方点击“通用”。在右侧，往下拉会看到可以配置邮件的地方。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/22.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/23.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;sonar添加用户、组&quot;&gt;&lt;a href=&quot;#sonar添加用户、组&quot; class=&quot;headerlink&quot; title=&quot;sonar添加用户、组&quot;&gt;&lt;/a&gt;sonar添加用户、组&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;1.添加组&lt;/strong&gt;&lt;br&gt;可以针对一个项目添加一个组，把这些人放到这个组里面，然后再配置相应的权限。&lt;br&gt;使用管理员账号登录sonar web，点击第一行的“配置”，点击“权限”，在下拉菜单中选择“群组”。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/24.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;然后点击右上方“创建群组”，输入群组名称即可创建群组。此时还没有添加用户，没有用户可以添加到新创建的群组中。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.添加用户&lt;/strong&gt;&lt;br&gt;使用管理员账号登录sonar web，点击第一行的“配置”，点击“权限”，在下拉菜单中选择“用户”。然后点击右上方的“创建用户”。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/25.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;jenkins安装sonarqube-scaner插件&quot;&gt;&lt;a href=&quot;#jenkins安装sonarqube-scaner插件&quot; class=&quot;headerlink&quot; title=&quot;jenkins安装sonarqube scaner插件&quot;&gt;&lt;/a&gt;jenkins安装sonarqube scaner插件&lt;/h2&gt;&lt;p&gt;浏览器输入jenkins访问地址，以管理员账户登录后，点击左侧菜单的“系统管理”。然后找到“管理插件”，点击“可选插件”，输入sonarqube scanner，即可搜索到。我这边由于jenkins版本比较低，是2.73.3。最新的sonarqube scanner插件需要jenkins 2.89.4以上版本才可以安装，但是这里又不提供低版本的插件直接安装。查看&lt;a href=&quot;https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;sonarqube官方文档&lt;/a&gt;，有jenkins版本和sonarscanner版本对应关系。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/13.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;这样就只能先下载好低版本的插件，然后通过“高级”选项卡上传插件进行安装。&lt;br&gt;我这里下载好了2.6.1版本的sonar.hpi。在插件管理里，选择“高级”选项卡。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/14.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;往下拉，找到“上传插件”，点击“选择文件”，然后选择本地的sonar.hpi，点击“上传”。过一会儿就装好了。&lt;/p&gt;
&lt;h2 id=&quot;jenkins构建过程配置sonar&quot;&gt;&lt;a href=&quot;#jenkins构建过程配置sonar&quot; class=&quot;headerlink&quot; title=&quot;jenkins构建过程配置sonar&quot;&gt;&lt;/a&gt;jenkins构建过程配置sonar&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;1.配置“SonarQube servers”&lt;/strong&gt;&lt;br&gt;在jenkins页面，点击“系统管理”，点击“系统设置”，找到“SonarQube servers”，点击“Add SonarQube”，输入SonarQube的相关信息。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/15.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;上图中的token，请访问sonar界面，使用管理员账号登录，点击右上角的管理员头像，选择“我的账号”，然后点击“安全”，第一项就是“令牌”。在输入框输入名字，随便定义，然后点击“生成”。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/16.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;【注意】：请复制生成的token并保存下来，因为后来在进去就看不到了。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.配置在构建过程中增加sonar扫描&lt;/strong&gt;&lt;br&gt;点击某个项目进去，在“构建”处，点击“增加构建步骤”，选择“Execute SonarQube Scanner”，配置如下：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/17.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;上图中在 Analysis properties 项里配置了一个参数，sonar.projectBaseDir=/root/.jenkins/workspace/gemini_dev。之所以配置这个参数，是因为我这个项目里配置有多个svn地址，每个svn地址都是项目的一个模块，这个情况下SonarQube的sonar.ProjectBaseDir参数默认会被设置为第一个项目的路径。这会导致找不到其他模块。详见官方issue：&lt;a href=&quot;https://issues.jenkins-ci.org/browse/JENKINS-24044&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://issues.jenkins-ci.org/browse/JENKINS-24044&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上图中的 sonar-project.properties 内容大致如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;96&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;97&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;98&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;99&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;100&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;101&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;102&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;103&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;#sonarqube的地址&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sonar.host.url=http://172.16.7.180:9000&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# SonarQube 中唯一表示，must be unique in a given SonarQube instance&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sonar.projectKey=gemini #名字随意&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# ui里面显示的项目名称，this is the name displayed in the SonarQube UI&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sonar.projectName=gemini #名字随意&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#版本号&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sonar.projectVersion=1.0  #版本随意&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#用户名密码，用token代替&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sonar.login=26e7ce1f5cc56a2442b7934b721749bd269f2dcc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#语言&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#sonar.language=java,html,css,js #默认是多语言，但是不支持这么写&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#源码位置&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sonar.modules=eetablecore,eetablemanage,emapflow,emapfunauth,emapsender,emaptaskcenter,emapturing,flowstatistics,skylobby,temppersonnel,getemapapplist,getybtapplist,emapposition,resourcemonitor,serviceanalyseapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablecore.projectBaseDir=/root/.jenkins/workspace/gemini_dev/eetablecore&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablecore.sonar.projectName=eetablecore&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablecore.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablecore.sonar.java.binaries=/usr/local/gemini/eetablecore/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablecore.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablemanage.projectBaseDir=/root/.jenkins/workspace/gemini_dev/eetablemanage&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablemanage.sonar.projectName=eetablemanage&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablemanage.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablemanage.sonar.java.binaries=/usr/local/gemini/eetablemanage/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablemanage.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js,web/public/design/plugin/**/*,web/public/design/public/**/*&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapflow.projectBaseDir=/root/.jenkins/workspace/gemini_dev/emapflow&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapflow.sonar.projectName=emapflow&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapflow.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapflow.sonar.java.binaries=/usr/local/gemini/emapflow/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapflow.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js,src/org/activiti/**/*.java&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapfunauth.projectBaseDir=/root/.jenkins/workspace/gemini_dev/emapfunauth&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapfunauth.sonar.projectName=emapfunauth&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapfunauth.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapfunauth.sonar.java.binaries=/usr/local/gemini/emapfunauth/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapfunauth.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapsender.projectBaseDir=/root/.jenkins/workspace/gemini_dev/emapsender&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapsender.sonar.projectName=emapsender&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapsender.sonar.sources=src&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapsender.sonar.java.binaries=/usr/local/gemini/emapsender/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emaptaskcenter.projectBaseDir=/root/.jenkins/workspace/gemini_dev/emaptaskcenter&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emaptaskcenter.sonar.projectName=emaptaskcenter&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emaptaskcenter.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emaptaskcenter.sonar.java.binaries=/usr/local/gemini/emaptaskcenter/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emaptaskcenter.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapturing.projectBaseDir=/root/.jenkins/workspace/gemini_dev/emapturing&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapturing.sonar.projectName=emapturing&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapturing.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapturing.sonar.java.binaries=/usr/local/gemini/emapturing/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapturing.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;flowstatistics.projectBaseDir=/root/.jenkins/workspace/gemini_dev/flowstatistics&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;flowstatistics.sonar.projectName=flowstatistics&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;flowstatistics.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;flowstatistics.sonar.java.binaries=/usr/local/gemini/flowstatistics/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;flowstatistics.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;skylobby.projectBaseDir=/root/.jenkins/workspace/gemini_dev/skylobby&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;skylobby.sonar.projectName=skylobby&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;skylobby.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;skylobby.sonar.java.binaries=/usr/local/gemini/skylobby/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;skylobby.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js,web/manager/components/UE/**/*,web/mobile/dependencies/**/*,web/mobile/static/**/*&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;temppersonnel.projectBaseDir=/root/.jenkins/workspace/gemini_dev/temppersonnel&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;temppersonnel.sonar.projectName=temppersonnel&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;temppersonnel.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;temppersonnel.sonar.java.binaries=/usr/local/gemini/temppersonnel/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;temppersonnel.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getemapapplist.projectBaseDir=/root/.jenkins/workspace/gemini_dev/getemapapplist&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getemapapplist.sonar.projectName=getemapapplist&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getemapapplist.sonar.sources=src&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getemapapplist.sonar.java.binaries=/usr/local/gemini/getemapapplist/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getybtapplist.projectBaseDir=/root/.jenkins/workspace/gemini_dev/getybtapplist&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getybtapplist.sonar.projectName=getybtapplist&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getybtapplist.sonar.sources=src&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getybtapplist.sonar.java.binaries=/usr/local/gemini/getybtapplist/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapposition.projectBaseDir=/root/.jenkins/workspace/gemini_dev/emapposition&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapposition.sonar.projectName=emapposition&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapposition.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapposition.sonar.java.binaries=/usr/local/gemini/emapposition/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapposition.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;resourcemonitor.projectBaseDir=/root/.jenkins/workspace/gemini_dev/resourcemonitor&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;resourcemonitor.sonar.projectName=resourcemonitor&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;resourcemonitor.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;resourcemonitor.sonar.java.binaries=/usr/local/gemini/resourcemonitor/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;resourcemonitor.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceanalyseapp.projectBaseDir=/root/.jenkins/workspace/gemini_dev/serviceanalyseapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceanalyseapp.sonar.projectName=serviceanalyseapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceanalyseapp.sonar.sources=src&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceanalyseapp.sonar.java.binaries=/usr/local/gemini/serviceanalyseapp/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#源码的编码&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sonar.sourceEncoding=UTF-8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【说明】：&lt;/strong&gt;&lt;br&gt;1.以上配置中 src 为java源代码目录，web为前端js目录。&lt;br&gt;2.新版本的SonarQube scanner的配置文件里扫描java源代码需要提供 java.binaries 定义，我这里对应每个模块建了个文件夹作为值。&lt;br&gt;3.配置文件可配参数更详细的介绍：&lt;br&gt;&lt;a href=&quot;https://baiyangcao.github.io/notes/2017/01/11/sonarqube-analyz-parameter.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://baiyangcao.github.io/notes/2017/01/11/sonarqube-analyz-parameter.html&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://docs.sonarqube.org/latest/analysis/analysis-parameters/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://docs.sonarqube.org/latest/analysis/analysis-parameters/&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://docs.sonarqube.org/latest/project-administration/narrowing-the-focus/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://docs.sonarqube.org/latest/project-administration/narrowing-the-focus/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;构建测试并查看结果&quot;&gt;&lt;a href=&quot;#构建测试并查看结果&quot; class=&quot;headerlink&quot; title=&quot;构建测试并查看结果&quot;&gt;&lt;/a&gt;构建测试并查看结果&lt;/h2&gt;&lt;p&gt;在jenkins相应项目上，点击“立即构建”，然后查看“Console Output”：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/18.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;构建完成后可以登录sonar web界面查看：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/19.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/20.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/21.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;部门领导要求扫描代码质量，我们平时是用jenkins来做持续集成和持续发布的，所以就将jenkins和sonar做了集成，在编译完成后sonar自动扫描代码，然后在进行发布。
    
    </summary>
    
      <category term="持续集成" scheme="http://yoursite.com/categories/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/"/>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>kubeadm安装kubernetes 1.14.0</title>
    <link href="http://yoursite.com/2019/04/08/kubeadm%E5%AE%89%E8%A3%85kubernetes-1-14-0/"/>
    <id>http://yoursite.com/2019/04/08/kubeadm安装kubernetes-1-14-0/</id>
    <published>2019-04-08T03:26:45.000Z</published>
    <updated>2019-07-31T03:43:25.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;之前采用二进制方式部署过Kubernetes，操作较为繁琐，此次采用kubeadm安装Kubernetes，Kubernetes相关组件介绍详见前面的文章。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;环境说明&quot;&gt;&lt;a href=&quot;#环境说明&quot; class=&quot;headerlink&quot; title=&quot;环境说明&quot;&gt;&lt;/a&gt;环境说明&lt;/h2&gt;&lt;h3 id=&quot;服务器环境&quot;&gt;&lt;a href=&quot;#服务器环境&quot; class=&quot;headerlink&quot; title=&quot;服务器环境&quot;&gt;&lt;/a&gt;服务器环境&lt;/h3&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;主机名&lt;/th&gt;
&lt;th&gt;操作系统版本&lt;/th&gt;
&lt;th&gt;IP地址&lt;/th&gt;
&lt;th&gt;角色&lt;/th&gt;
&lt;th&gt;安装软件&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;spark32&lt;/td&gt;
&lt;td&gt;CentOS 7.0&lt;/td&gt;
&lt;td&gt;172.16.206.32&lt;/td&gt;
&lt;td&gt;Kubernetes Master、Harbor&lt;/td&gt;
&lt;td&gt;docker-ce 18.09.4、kubelet v1.14.0、kubeadm v1.14.0、etcd 3.3.10、kube-apiserver v1.14.0、kube-scheduler v1.14.0、kube-controller-manager v1.14.0、kube-proxy、flannel v0.11.0、kubectl v1.14.0、pause 3.1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;spark17&lt;/td&gt;
&lt;td&gt;CentOS 7.0&lt;/td&gt;
&lt;td&gt;172.16.206.17&lt;/td&gt;
&lt;td&gt;Kubernetes Node&lt;/td&gt;
&lt;td&gt;docker-ce 18.09.4、kubelet v1.14.0、kubeadm v1.14.0、kube-proxy v1.14.0、flannel v0.11.0、pause 3.1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ubuntu31&lt;/td&gt;
&lt;td&gt;Ubuntu 16.04&lt;/td&gt;
&lt;td&gt;172.16.206.31&lt;/td&gt;
&lt;td&gt;Kubernetes Node&lt;/td&gt;
&lt;td&gt;docker-ce 18.09.4、kubelet v1.14.0、kubeadm v1.14.0、kube-proxy v1.14.0、flannel v0.11.0、pause 3.1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;【注意】：如果操作系统选择的是CentOS的，建议操作系统选择CentOS 7.3+的，从7.3+开始，默认安装的xfs文件系统的 ftype=1，这样docker可以使用官方推荐的存储驱动：overlay2&lt;/strong&gt;&lt;br&gt;如果当前系统小于7.3，并且ftype=0，有几个方法：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;重新创建xfs文件系统&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://superuser.com/questions/1321926/recreating-an-xfs-file-system-with-ftype-1，没试过这种方法&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://superuser.com/questions/1321926/recreating-an-xfs-file-system-with-ftype-1，没试过这种方法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;如果你的主机上的卷组还有其他空间，可以重新分配一个逻辑卷，并且在格式化时指定 ftype=1，修改docker的默认存储路径(/var/lib/docker)为新创建的逻辑卷。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;【示例】：如何查看xfs文件系统的ftype的值&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/27.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;安装准备&quot;&gt;&lt;a href=&quot;#安装准备&quot; class=&quot;headerlink&quot; title=&quot;安装准备&quot;&gt;&lt;/a&gt;安装准备&lt;/h3&gt;&lt;p&gt;1.关闭iptables和firewalld&lt;br&gt;每个节点都需要做&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;systemctl stop firewalld.service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;systemctl disable firewalld.service&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;2.集群主机时间同步&lt;br&gt;采用NTP(Network Time Protocol)方式来实现, 选择一台机器, 作为集群的时间同步服务器, 然后分别配置服务端和集群其他机器。&lt;br&gt;参见之前的博客文档&lt;a href=&quot;http://jkzhao.github.io/2016/08/07/%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2Apache%20Hadoop%20(%E5%AE%8C%E5%85%A8%E5%88%86%E5%B8%83%E5%BC%8F%E6%A8%A1%E5%BC%8F%E5%B9%B6%E4%B8%94%E5%AE%9E%E7%8E%B0NameNode%20HA%E5%92%8CResourceManager%20HA&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;安装部署Apache Hadoop (完全分布式模式并且实现NameNode HA和ResourceManager HA)&lt;/a&gt;/)&lt;/p&gt;
&lt;p&gt;3.禁用SELINUX&lt;br&gt;每个节点都需要做&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;setenforce 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;vi /etc/selinux/config&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;SELINUX=disabled&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;4.配置/etc/hosts&lt;br&gt;每个节点都需要配置&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# vim /etc/hosts&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.32 spark32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.17 spark17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.31 ubuntu31&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;5.docker会生成大量的ip规则，有可能对iptables内部的nfcall，需要打开内生的桥接功能&lt;br&gt;每个节点都需要配置&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# echo &amp;quot;net.bridge.bridge-nf-call-iptables = 1&amp;quot; &amp;gt;&amp;gt; /etc/sysctl.conf &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# echo &amp;quot;net.bridge.bridge-nf-call-ip6tables = 1&amp;quot; &amp;gt;&amp;gt; /etc/sysctl.conf &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# echo &amp;quot;net.ipv4.ip_forward=1&amp;quot; &amp;gt;&amp;gt; /etc/sysctl.conf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# sysctl -p /etc/sysctl.conf&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;安装配置master节点&quot;&gt;&lt;a href=&quot;#安装配置master节点&quot; class=&quot;headerlink&quot; title=&quot;安装配置master节点&quot;&gt;&lt;/a&gt;安装配置master节点&lt;/h2&gt;&lt;h3 id=&quot;安装docker-ce、kubelet、kubeadm、kubectl&quot;&gt;&lt;a href=&quot;#安装docker-ce、kubelet、kubeadm、kubectl&quot; class=&quot;headerlink&quot; title=&quot;安装docker-ce、kubelet、kubeadm、kubectl&quot;&gt;&lt;/a&gt;安装docker-ce、kubelet、kubeadm、kubectl&lt;/h3&gt;&lt;p&gt;我们使用阿里云仓库。点击访问&lt;a href=&quot;https://opsx.alibaba.com/mirror&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;阿里云仓库&lt;/a&gt;，可以找到docker-ce和kubernetes，在右侧有“帮助”，里面会有说明。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/21.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/20.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/yum.repos.d/kubernetes.repo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; [kubernetes]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; name=Kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; enabled=1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; gpgcheck=1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; repo_gpgcheck=1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; EOF&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# yum install docker-ce kubelet kubeadm kubectl -y&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;你也可以自己安装时指定固定的版本安装，我这里默认使用最新的稳定版本1.14.0。以kubeadm为例，查看仓库里有哪些版本可以安装：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# yum list kubeadm.x86_64 --showduplicates | sort -r&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;配置启动docker&quot;&gt;&lt;a href=&quot;#配置启动docker&quot; class=&quot;headerlink&quot; title=&quot;配置启动docker&quot;&gt;&lt;/a&gt;配置启动docker&lt;/h3&gt;&lt;p&gt;接下来需要安装apiserver、controller manager、scheduler、kube-proxy。kubeadm安装Kubernetes集群时，这些组件是跑在静态Pods中的，官网&lt;a href=&quot;https://kubernetes.io/docs/tasks/administer-cluster/static-pod/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Static Pod文档&lt;/a&gt;。&lt;br&gt;docker是需要去docker仓库里下载所依赖的每一个镜像文件，这些镜像文件放在google的gcr仓库里，可能下载不了。我这里临时改下docker的配置文件，临时添加个代理，等集群安装完去掉代理。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# vim /usr/lib/systemd/system/docker.service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Environment=&amp;quot;HTTPS_PROXY=http://www.ik8s.io:10080&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Environment=&amp;quot;NO_PROXY=127.0.0.0/8,172.16.0.0/16&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl daemon-reload&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl start docker&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker info&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/22.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;如上图所示，有个提示，Storage Driver: overlay，以后会被移除。我这里改为overlay2。具体关于存储方面的可仔细阅读&lt;a href=&quot;https://docs.docker.com/storage/storagedriver/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;docker官方文档相应章节&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl stop docker&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# cp -au /var/lib/docker /var/lib/docker.bk&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# vim /etc/docker/daemon.json&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;storage-driver&amp;quot;: &amp;quot;overlay2&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl start docker&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl enable docker.service&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;【注意】：如果你自己有代理，即使你在服务器上配置了访问所有地址都走代理，在使用命令：docker pull k8s.gcr.io/kube-apiserver:v1.14.0 就可以拉取镜像了，一定要在 /usr/lib/systemd/system/docker.service 里配置代理地址，比如：Environment=”HTTPS_PROXY=&lt;a href=&quot;http://127.0.0.1:8118&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://127.0.0.1:8118&lt;/a&gt;“&lt;br&gt;Environment=”HTTP_PROXY=&lt;a href=&quot;http://127.0.0.1:8118&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://127.0.0.1:8118&lt;/a&gt;“&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;配置kubelet&quot;&gt;&lt;a href=&quot;#配置kubelet&quot; class=&quot;headerlink&quot; title=&quot;配置kubelet&quot;&gt;&lt;/a&gt;配置kubelet&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# rpm -ql kubelet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/etc/kubernetes/manifests&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/etc/sysconfig/kubelet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/usr/bin/kubelet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/usr/lib/systemd/system/kubelet.service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# cat /etc/sysconfig/kubelet &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KUBELET_EXTRA_ARGS=&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;早期的k8s要求，每一个节点都不能打开swap设备。如果开了，不让你启动。但是我们可以人为的去忽略它，定义的方式就是上面这个参数。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# vim /etc/sysconfig/kubelet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KUBELET_EXTRA_ARGS=&amp;quot;--fail-swap-on=false&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果不配置这个，在下面使用kubeadm init初始化master时会报如下错误：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;        [ERROR Swap]: running with swap on is not supported. Please disable swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此时不能启动kubelet，它的配置文件还没有生成，在初始化master节点的过程中会生成kubelet的配置文件，并且启动kubelet。先设置开机自启动：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl enable kubelet.service&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;初始化master节点&quot;&gt;&lt;a href=&quot;#初始化master节点&quot; class=&quot;headerlink&quot; title=&quot;初始化master节点&quot;&gt;&lt;/a&gt;初始化master节点&lt;/h3&gt;&lt;p&gt;使用kubeadm安装master节点的各组件。&lt;br&gt;查看初始化参数：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubeadm init --help&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/23.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/24.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;在初始化前，我们可以打印出kubeadm默认的配置：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]#  kubeadm config print init-defaults&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;bootstrapTokens:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- groups:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - system:bootstrappers:kubeadm:default-node-token&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  token: abcdef.0123456789abcdef&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ttl: 24h0m0s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  usages:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - signing&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - authentication&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: InitConfiguration&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;localAPIEndpoint:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  advertiseAddress: 1.2.3.4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  bindPort: 6443&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nodeRegistration:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  criSocket: /var/run/dockershim.sock&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: spark32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  taints:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - effect: NoSchedule&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    key: node-role.kubernetes.io/master&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;---&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiServer:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  timeoutForControlPlane: 4m0s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;certificatesDir: /etc/kubernetes/pki&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterName: kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controlPlaneEndpoint: &amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controllerManager: &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;dns:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  type: CoreDNS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  local:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    dataDir: /var/lib/etcd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;imageRepository: k8s.gcr.io&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: ClusterConfiguration&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetesVersion: v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;networking:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  dnsDomain: cluster.local&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  podSubnet: &amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  serviceSubnet: 10.96.0.0/12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;scheduler: &amp;#123;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;下面开始初始化：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubeadm init --kubernetes-version=v1.14.0 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --ignore-preflight-errors=Swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[init] Using Kubernetes version: v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Running pre-flight checks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING IsDockerSystemdCheck]: detected &amp;quot;cgroupfs&amp;quot; as the Docker cgroup driver. The recommended driver is &amp;quot;systemd&amp;quot;. Please follow the guide at https://kubernetes.io/docs/setup/cri/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING Swap]: running with swap on is not supported. Please disable swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Pulling images required for setting up a Kubernetes cluster&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] This might take a minute or two, depending on the speed of your internet connection&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] You can also perform this action in beforehand using &amp;apos;kubeadm config images pull&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;error execution phase preflight: [preflight] Some fatal errors occurred:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [ERROR ImagePull]: failed to pull image k8s.gcr.io/kube-apiserver:v1.14.0: output: Error response from daemon: Get https://k8s.gcr.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;, error: exit status 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;问题：初始化时发现网上找的代理已经失效了，拉取不了gcr仓库的镜像。&lt;br&gt;先查看kubeadm初始化master需要哪些镜像：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubeadm config images list&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;I0408 15:43:21.372628    4131 version.go:96] could not fetch a Kubernetes version from the internet: unable to get URL &amp;quot;https://dl.k8s.io/release/stable-1.txt&amp;quot;: Get https://dl.k8s.io/release/stable-1.txt: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;I0408 15:43:21.372730    4131 version.go:97] falling back to the local client version: v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;k8s.gcr.io/kube-apiserver:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;k8s.gcr.io/kube-controller-manager:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;k8s.gcr.io/kube-scheduler:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;k8s.gcr.io/kube-proxy:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;k8s.gcr.io/pause:3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;k8s.gcr.io/etcd:3.3.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;k8s.gcr.io/coredns:1.3.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;去掉docker配置文件中代理配置：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# vim /usr/lib/systemd/system/docker.service &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Environment=&amp;quot;HTTPS_PROXY=http://www.ik8s.io:10080&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Environment=&amp;quot;NO_PROXY=127.0.0.0/8,172.16.0.0/16&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl daemon-reload&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl restart docker.service&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;配置阿里云加速：参照前面博客&lt;a href=&quot;http://jkzhao.github.io/2017/08/28/CentOS%E5%AE%89%E8%A3%85Docker-CE/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CentOS安装Docker CE&lt;/a&gt;&lt;br&gt;从阿里云registry拉取镜像&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.3.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker images&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;REPOSITORY                                                                    TAG                 IMAGE ID            CREATED             SIZE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy                v1.14.0             5cd54e388aba        13 days ago         82.1MB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager   v1.14.0             b95b1efa0436        13 days ago         158MB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler            v1.14.0             00638a24688b        13 days ago         81.6MB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver            v1.14.0             ecf910f40d6e        13 days ago         210MB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;registry.cn-hangzhou.aliyuncs.com/google_containers/coredns                   1.3.1               eb516548c180        2 months ago        40.3MB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;registry.cn-hangzhou.aliyuncs.com/google_containers/etcd                      3.3.10              2c4adeb21b4f        4 months ago        258MB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;registry.cn-hangzhou.aliyuncs.com/google_containers/pause                     3.1                 da86e6ba6ca1        15 months ago       742kB&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;因为kubeadm安装的docker镜像默认是k8s.gcr.io网站的，所以需要改一下标签：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.14.0 k8s.gcr.io/kube-apiserver:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.14.0 k8s.gcr.io/kube-scheduler:v1.14.0     &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0 k8s.gcr.io/kube-proxy:v1.14.0             &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.3.10 k8s.gcr.io/etcd:3.3.10 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.3.1 k8s.gcr.io/coredns:1.3.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;下面再次初始化：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubeadm init --kubernetes-version=v1.14.0 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --ignore-preflight-errors=Swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[init] Using Kubernetes version: v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Running pre-flight checks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING IsDockerSystemdCheck]: detected &amp;quot;cgroupfs&amp;quot; as the Docker cgroup driver. The recommended driver is &amp;quot;systemd&amp;quot;. Please follow the guide at https://kubernetes.io/docs/setup/cri/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING Swap]: running with swap on is not supported. Please disable swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Pulling images required for setting up a Kubernetes cluster&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] This might take a minute or two, depending on the speed of your internet connection&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] You can also perform this action in beforehand using &amp;apos;kubeadm config images pull&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Writing kubelet environment file with flags to file &amp;quot;/var/lib/kubelet/kubeadm-flags.env&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Writing kubelet configuration to file &amp;quot;/var/lib/kubelet/config.yaml&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Activating the kubelet service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Using certificateDir folder &amp;quot;/etc/kubernetes/pki&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;etcd/ca&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;etcd/server&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] etcd/server serving cert is signed for DNS names [spark32 localhost] and IPs [172.16.206.32 127.0.0.1 ::1]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;apiserver-etcd-client&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;etcd/peer&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] etcd/peer serving cert is signed for DNS names [spark32 localhost] and IPs [172.16.206.32 127.0.0.1 ::1]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;etcd/healthcheck-client&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;ca&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;apiserver&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] apiserver serving cert is signed for DNS names [spark32 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 172.16.206.32]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;apiserver-kubelet-client&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;front-proxy-ca&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;front-proxy-client&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;sa&amp;quot; key and public key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubeconfig] Using kubeconfig folder &amp;quot;/etc/kubernetes&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubeconfig] Writing &amp;quot;admin.conf&amp;quot; kubeconfig file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubeconfig] Writing &amp;quot;kubelet.conf&amp;quot; kubeconfig file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubeconfig] Writing &amp;quot;controller-manager.conf&amp;quot; kubeconfig file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubeconfig] Writing &amp;quot;scheduler.conf&amp;quot; kubeconfig file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[control-plane] Using manifest folder &amp;quot;/etc/kubernetes/manifests&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[control-plane] Creating static Pod manifest for &amp;quot;kube-apiserver&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[control-plane] Creating static Pod manifest for &amp;quot;kube-controller-manager&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[control-plane] Creating static Pod manifest for &amp;quot;kube-scheduler&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[etcd] Creating static Pod manifest for local etcd in &amp;quot;/etc/kubernetes/manifests&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &amp;quot;/etc/kubernetes/manifests&amp;quot;. This can take up to 4m0s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[apiclient] All control plane components are healthy after 25.563846 seconds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[upload-config] storing the configuration used in ConfigMap &amp;quot;kubeadm-config&amp;quot; in the &amp;quot;kube-system&amp;quot; Namespace&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet] Creating a ConfigMap &amp;quot;kubelet-config-1.14&amp;quot; in namespace kube-system with the configuration for the kubelets in the cluster&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[upload-certs] Skipping phase. Please see --experimental-upload-certs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[mark-control-plane] Marking the node spark32 as control-plane by adding the label &amp;quot;node-role.kubernetes.io/master=&amp;apos;&amp;apos;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[mark-control-plane] Marking the node spark32 as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[bootstrap-token] Using token: q8vnmo.3eav1kq9c3zp2xgq&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[bootstrap-token] creating the &amp;quot;cluster-info&amp;quot; ConfigMap in the &amp;quot;kube-public&amp;quot; namespace&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[addons] Applied essential addon: CoreDNS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[addons] Applied essential addon: kube-proxy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Your Kubernetes control-plane has initialized successfully!&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;To start using your cluster, you need to run the following as a regular user:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  mkdir -p $HOME/.kube&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  sudo chown $(id -u):$(id -g) $HOME/.kube/config&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You should now deploy a pod network to the cluster.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Run &amp;quot;kubectl apply -f [podnetwork].yaml&amp;quot; with one of the options listed at:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  https://kubernetes.io/docs/concepts/cluster-administration/addons/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Then you can join any number of worker nodes by running the following on each as root:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubeadm join 172.16.206.32:6443 --token q8vnmo.3eav1kq9c3zp2xgq \&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    --discovery-token-ca-cert-hash sha256:7fb950b750bc546d9343040b646bae7d8749a63a33124f51c1adb2b4c19aa235&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/25.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;【说明】：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;dns附件在k8s上已经进化到第三版了。第一版叫skydns，后来被kubedns所取代，而在1.11版开始，才正式被CoreDNS所取代。CoreDNS支持前面两版不支持的高级功能，比如像很多资源的动态配置等。&lt;/li&gt;
&lt;li&gt;kube-proxy是作为附件运行的，也是托管在k8s之上。来帮忙负责生成service资源的相关iptables或ipvs规则。从1.11版本开始，默认开始使用的是ipvs。如果当前系统支不支持，默认安装上不支持的时候自动降级为iptables。1.10版及之前都是iptables，那时候使用ipvs还不成熟。&lt;/li&gt;
&lt;li&gt;这个token是个认证令牌，其实是个域共享密钥，意思是当前这个集群不是谁都能加入进来的，你要想加入进来得拿着这个令牌。这个token是动态生成的，复制保存下来，免得以后找不着了。&lt;strong&gt;注意这个令牌有效期是24小时，过了24小时在拿这个令牌来加入集群就会报认证错误，具体看下面的章节-安装配置Ubuntu 16.04 node节点&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;–discovery-token-ca-cert-hash：做发现时TLS BootStrap那个相关证书的或者私钥文件的hash码，hash码不对是不会让加入集群的，复制保存下来。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# mkdir -p $HOME/.kube&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You have mail in /var/spool/mail/root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# cp -i /etc/kubernetes/admin.conf $HOME/.kube/config&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;【说明】：admin.conf里面是kubeadm帮我们生成的一个被kubectl可以拿来作为配置文件，指定连接至k8s的apiserver，并完成认证的配置文件。这里面包含了认证信息，认证证书信息。&lt;br&gt;&lt;strong&gt;kubeadm init workflow：&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/#init-workflow&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看kubelet状态，此时已经启动起来了。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl status kubelet&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看集群组件状态：kubectl get cs/componentstatus&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get cs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                 STATUS    MESSAGE             ERROR&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;scheduler            Healthy   ok                  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controller-manager   Healthy   ok                  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-0               Healthy   &amp;#123;&amp;quot;health&amp;quot;:&amp;quot;true&amp;quot;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get componentstatus&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                 STATUS    MESSAGE             ERROR&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controller-manager   Healthy   ok                  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;scheduler            Healthy   ok                  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-0               Healthy   &amp;#123;&amp;quot;health&amp;quot;:&amp;quot;true&amp;quot;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这里没有显示apiserver的状态，如果apiserver不健康，我们是得不到这些组件健康状态信息的。&lt;/p&gt;
&lt;p&gt;查看集群节点信息：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get nodes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME      STATUS     ROLES    AGE   VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32   NotReady   master   29m   v1.14.0&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此时只有主节点一个节点，而且是未就绪状态，因为此时还缺少一个网络附件，此时Pod之间无法通信。&lt;/p&gt;
&lt;p&gt;查看集群Pods状态信息（默认查的是default空间的pods，系统级的pods都是在kube-system空间）：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                              READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-8zzkb           0/1     Pending   0          43m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-t69hm           0/1     Pending   0          43m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-spark32                      1/1     Running   1          43m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-apiserver-spark32            1/1     Running   1          43m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-controller-manager-spark32   1/1     Running   1          43m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-9clf7                  1/1     Running   0          43m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-scheduler-spark32            1/1     Running   1          43m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;coredns处于pending状态，未决定的，行将发生的状态，是因为此时网络插件还没有安装。此时/etc/cni/目录也不存在。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【注意】：原来kubeadm 1.14.0版本初始化master节点时，已经支持从其他仓库下载需要的镜像，选项为：–image-repository string&lt;/strong&gt;&lt;br&gt;这就意味着我们不需要像上面那样从阿里云registry下载镜像，在打tag了。&lt;/p&gt;
&lt;h3 id=&quot;部署网络附件flannel&quot;&gt;&lt;a href=&quot;#部署网络附件flannel&quot; class=&quot;headerlink&quot; title=&quot;部署网络附件flannel&quot;&gt;&lt;/a&gt;部署网络附件flannel&lt;/h3&gt;&lt;p&gt;官网：&lt;a href=&quot;https://github.com/coreos/flannel&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/coreos/flannel&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/26.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;podsecuritypolicy.extensions/psp.flannel.unprivileged created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrole.rbac.authorization.k8s.io/flannel created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrolebinding.rbac.authorization.k8s.io/flannel created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceaccount/flannel created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;configmap/kube-flannel-cfg created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.extensions/kube-flannel-ds-amd64 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.extensions/kube-flannel-ds-arm64 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.extensions/kube-flannel-ds-arm created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.extensions/kube-flannel-ds-ppc64le created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.extensions/kube-flannel-ds-s390x created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;看到这些并不是执行好了，此时正在拉取flannel镜像。下载很慢，耐心等待。可以使用docker images查看是否下载完成。。。&lt;br&gt;可以使用docker images查看当前服务器上下载的镜像，如果一直没有下来，直接运行命令拉取：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull quay.io/coreos/flannel:v0.11.0-amd64&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;拉取下来后，过一会儿，对应的flannel的pod就会启动起来了。&lt;/p&gt;
&lt;p&gt;查看集群Pods状态：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                              READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-8zzkb           1/1     Running   0          79m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-t69hm           1/1     Running   0          79m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-spark32                      1/1     Running   1          78m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-apiserver-spark32            1/1     Running   1          78m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-controller-manager-spark32   1/1     Running   1          78m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-2hkjh       1/1     Running   0          27m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-9clf7                  1/1     Running   0          79m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-scheduler-spark32            1/1     Running   1          78m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此时再次查看master节点状态，已经是就绪状态了：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get nodes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME      STATUS   ROLES    AGE   VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32   Ready    master   86m   v1.14.0&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;安装配置CentOS-7-node节点&quot;&gt;&lt;a href=&quot;#安装配置CentOS-7-node节点&quot; class=&quot;headerlink&quot; title=&quot;安装配置CentOS 7 node节点&quot;&gt;&lt;/a&gt;安装配置CentOS 7 node节点&lt;/h2&gt;&lt;p&gt;我这里以spark17节点为例：&lt;/p&gt;
&lt;h3 id=&quot;安装docker-ce、kubelet、kubeadm&quot;&gt;&lt;a href=&quot;#安装docker-ce、kubelet、kubeadm&quot; class=&quot;headerlink&quot; title=&quot;安装docker-ce、kubelet、kubeadm&quot;&gt;&lt;/a&gt;安装docker-ce、kubelet、kubeadm&lt;/h3&gt;&lt;p&gt;在master节点上远程拷贝 docker-ce.repo、kubernetes.repo 到node3节点。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# scp -p /etc/yum.repos.d/docker-ce.repo root@spark17:/etc/yum.repos.d/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# scp -p /etc/yum.repos.d/kubernetes.repo root@spark17:/etc/yum.repos.d/&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;安装docker-ce、kubelet、kubeadm&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@node3 ~]# yum install docker-ce kubelet kubeadm -y&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;启动docker：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# systemctl start docker&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;配置启动docker-1&quot;&gt;&lt;a href=&quot;#配置启动docker-1&quot; class=&quot;headerlink&quot; title=&quot;配置启动docker&quot;&gt;&lt;/a&gt;配置启动docker&lt;/h3&gt;&lt;p&gt;修改docker的Storage Driver：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# scp -p /etc/docker/daemon.json root@node3:/etc/docker/&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;重启docker并设置开机自启动：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# systemctl restart docker &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# systemctl enable docker&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;配置kubelet-1&quot;&gt;&lt;a href=&quot;#配置kubelet-1&quot; class=&quot;headerlink&quot; title=&quot;配置kubelet&quot;&gt;&lt;/a&gt;配置kubelet&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# vim /etc/sysconfig/kubelet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KUBELET_EXTRA_ARGS=&amp;quot;--fail-swap-on=false&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# systemctl enable kubelet&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;加入集群&quot;&gt;&lt;a href=&quot;#加入集群&quot; class=&quot;headerlink&quot; title=&quot;加入集群&quot;&gt;&lt;/a&gt;加入集群&lt;/h3&gt;&lt;p&gt;我这里由于上面kubeadm init的时候没有使用 –image-repository string 指定从其他registry下载镜像，所以我先下载下来需要的镜像，然后再加入到集群中。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0 k8s.gcr.io/kube-proxy:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# docker pull quay.io/coreos/flannel:v0.11.0-amd64&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;或者可以在master节点上，把镜像docker save保存为tar，然后到node节点上docker load为镜像。以flannel为例：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark31 ~]# docker save -o flannel.tar quay.io/coreos/flannel:v0.11.0-amd64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# docker load -i flannel.tar&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;加入集群：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;kubeadm join 172.16.206.32:6443 --token q8vnmo.3eav1kq9c3zp2xgq --discovery-token-ca-cert-hash sha256:7fb950b750bc546d9343040b646bae7d8749a63a33124f51c1adb2b4c19aa235 --ignore-preflight-errors=Swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Running pre-flight checks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING IsDockerSystemdCheck]: detected &amp;quot;cgroupfs&amp;quot; as the Docker cgroup driver. The recommended driver is &amp;quot;systemd&amp;quot;. Please follow the guide at https://kubernetes.io/docs/setup/cri/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING Swap]: running with swap on is not supported. Please disable swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Reading configuration from the cluster...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] FYI: You can look at this config file with &amp;apos;kubectl -n kube-system get cm kubeadm-config -oyaml&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Downloading configuration for the kubelet from the &amp;quot;kubelet-config-1.14&amp;quot; ConfigMap in the kube-system namespace&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Writing kubelet configuration to file &amp;quot;/var/lib/kubelet/config.yaml&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Writing kubelet environment file with flags to file &amp;quot;/var/lib/kubelet/kubeadm-flags.env&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Activating the kubelet service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;This node has joined the cluster:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;* Certificate signing request was sent to apiserver and a response was received.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;* The Kubelet was informed of the new secure connection details.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Run &amp;apos;kubectl get nodes&amp;apos; on the control-plane to see this node join the cluster.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;要等待几分钟，node节点会下载kube-proxy和flannel，启动起来，才算真正完成。可以使用 kubectl get nodes 查看节点状态。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get nodes      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME      STATUS   ROLES    AGE   VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark17   Ready    &amp;lt;none&amp;gt;   14h   v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32   Ready    master   23h   v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods -n kube-system -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                              READY   STATUS    RESTARTS   AGE   IP              NODE      NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-8zzkb           1/1     Running   0          23h   10.244.0.2      spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-t69hm           1/1     Running   0          23h   10.244.0.3      spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-spark32                      1/1     Running   1          23h   172.16.206.32   spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-apiserver-spark32            1/1     Running   1          23h   172.16.206.32   spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-controller-manager-spark32   1/1     Running   1          23h   172.16.206.32   spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-2hkjh       1/1     Running   0          22h   172.16.206.32   spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-f5fhc       1/1     Running   0          14h   172.16.206.17   spark17   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-9clf7                  1/1     Running   0          23h   172.16.206.32   spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-p5nrg                  1/1     Running   0          14h   172.16.206.17   spark17   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-scheduler-spark32            1/1     Running   1          23h   172.16.206.32   spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/28.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;安装配置Ubuntu-16-04-node节点&quot;&gt;&lt;a href=&quot;#安装配置Ubuntu-16-04-node节点&quot; class=&quot;headerlink&quot; title=&quot;安装配置Ubuntu 16.04 node节点&quot;&gt;&lt;/a&gt;安装配置Ubuntu 16.04 node节点&lt;/h2&gt;&lt;p&gt;集群中有一台服务器的操作系统是Ubuntu 16.04，作为Node节点。&lt;br&gt;关闭防火墙：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo systemctl status ufw.service &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo systemctl stop ufw.service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo systemctl disable ufw.service&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看apparmor（相当于CentOS中的SELinux）状态：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo systemctl status apparmor.service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;● apparmor.service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Loaded: not-found (Reason: No such file or directory)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Active: inactive (dead)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;检查nf-call：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ cat /proc/sys/net/bridge/bridge-nf-call-iptables &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ cat /proc/sys/net/bridge/bridge-nf-call-ip6tables &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;安装docker-ce、kubelet、kubeadm-1&quot;&gt;&lt;a href=&quot;#安装docker-ce、kubelet、kubeadm-1&quot; class=&quot;headerlink&quot; title=&quot;安装docker-ce、kubelet、kubeadm&quot;&gt;&lt;/a&gt;安装docker-ce、kubelet、kubeadm&lt;/h3&gt;&lt;p&gt;我们使用阿里云仓库。点击访问&lt;a href=&quot;https://opsx.alibaba.com/mirror&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;阿里云仓库&lt;/a&gt;，可以找到docker-ce和kubernetes，在右侧有“帮助”，里面会有说明。&lt;/p&gt;
&lt;h4 id=&quot;安装docker&quot;&gt;&lt;a href=&quot;#安装docker&quot; class=&quot;headerlink&quot; title=&quot;安装docker&quot;&gt;&lt;/a&gt;安装docker&lt;/h4&gt;&lt;p&gt;&lt;a href=&quot;https://yq.aliyun.com/articles/110806&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://yq.aliyun.com/articles/110806&lt;/a&gt;&lt;br&gt;step 1: 安装必要的一些系统工具&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get update&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;step 2: 安装GPG证书&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Step 3: 写入软件源信息&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo add-apt-repository &amp;quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Step 4: 更新并安装 Docker-CE&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get -y update&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get -y install docker-ce&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo docker info&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Containers: 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Running: 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Paused: 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Stopped: 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Images: 4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Server Version: 18.09.4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Storage Driver: overlay2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Backing Filesystem: extfs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Supports d_type: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Native Overlay Diff: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Logging Driver: json-file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Cgroup Driver: cgroupfs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	WARNING: No swap limit support&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;有个WARNING，根据错误提示，只是cgroups中的swap account没有开启。这个功能应该是用在 &lt;code&gt;docker run -m=1524288 -it ubuntu /bin/bash&lt;/code&gt; 类似的命令，用来限制一个docker容器的内存使用上限，所以这里只是WARNING，不影响使用。&lt;br&gt;解决：&lt;br&gt;编辑/etc/default/grub，找到 GRUB_CMDLINE_LINUX=””，在双引号里面输入cgroup_enable=memory swapaccount=1&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/29.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo vim /etc/default/grub&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo update-grub&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo reboot&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;安装kubelet、kubeadm&quot;&gt;&lt;a href=&quot;#安装kubelet、kubeadm&quot; class=&quot;headerlink&quot; title=&quot;安装kubelet、kubeadm&quot;&gt;&lt;/a&gt;安装kubelet、kubeadm&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get update&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get install -y apt-transport-https&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;下面这条命令需要切换到root用户运行，普通用户sudo执行时一直提示要求使用root用户执行：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;jkzhao@ubuntu31:~$ su - root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Password: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt;/etc/apt/sources.list.d/kubernetes.list&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;EOF&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;下面在切回到普通用户执行：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get update&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get install kubelet=1.14.0-00 kubeadm=1.14.0-00 kubectl=1.14.0-00 #这里安装时我发现默认最新的是1.14.1版本，所以我安装的时候指定版本为1.14.0&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;配置kubelet-2&quot;&gt;&lt;a href=&quot;#配置kubelet-2&quot; class=&quot;headerlink&quot; title=&quot;配置kubelet&quot;&gt;&lt;/a&gt;配置kubelet&lt;/h4&gt;&lt;p&gt;Kubernetes 1.8开始要求关闭系统的Swap，如果不关闭，默认配置下kubelet将无法启动。可以通过kubelet的启动参数–fail-swap-on=false更改这个限制。配置忽略swap：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ sudo vim /etc/systemd/system/kubelet.service.d/10-kubeadm.conf &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Environment=&amp;quot;KUBELET_EXTRA_ARGS=--fail-swap-on=false&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/30.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;加入集群-1&quot;&gt;&lt;a href=&quot;#加入集群-1&quot; class=&quot;headerlink&quot; title=&quot;加入集群&quot;&gt;&lt;/a&gt;加入集群&lt;/h3&gt;&lt;p&gt;把需要的3个镜像下载下来，分别是kube-proxy、pause、flannel。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ sudo docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ sudo docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0 k8s.gcr.io/kube-proxy:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ sudo docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ sudo docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ sudo docker pull quay.io/coreos/flannel:v0.11.0-amd64&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;加入集群：&lt;br&gt;切换到root用户，执行如下命令：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# kubeadm join 172.16.206.32:6443 --token q8vnmo.3eav1kq9c3zp2xgq --discovery-token-ca-cert-hash sha256:7fb950b750bc546d9343040b646bae7d8749a63a33124f51c1adb2b4c19aa235 --ignore-preflight-errors=Swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Running pre-flight checks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING IsDockerSystemdCheck]: detected &amp;quot;cgroupfs&amp;quot; as the Docker cgroup driver. The recommended driver is &amp;quot;systemd&amp;quot;. Please follow the guide at https://kubernetes.io/docs/setup/cri/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING Swap]: running with swap on is not supported. Please disable swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Reading configuration from the cluster...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] FYI: You can look at this config file with &amp;apos;kubectl -n kube-system get cm kubeadm-config -oyaml&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;error execution phase preflight: unable to fetch the kubeadm-config ConfigMap: failed to get config map: Unauthorized&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但是发现报错了：error execution phase preflight: unable to fetch the kubeadm-config ConfigMap: failed to get config map: Unauthorized&lt;br&gt;解决：&lt;a href=&quot;https://github.com/kubernetes/kubeadm/issues/1310&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/kubernetes/kubeadm/issues/1310&lt;/a&gt;&lt;br&gt;TTL for the token should be 24h.我这个是后面几天加的新节点。&lt;br&gt;回到master节点，查看集群token：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubeadm token list&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/31.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;生成一个新的token：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubeadm token create&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85e3nn.5copkyq2j5leqrpb&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/32.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;再次回到node节点执行加入集群命令：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# kubeadm join 172.16.206.32:6443 --token 85e3nn.5copkyq2j5leqrpb --discovery-token-ca-cert-hash sha256:7fb950b750bc546d9343040b646bae7d8749a63a33124f51c1adb2b4c19aa235 --ignore-preflight-errors=Swap&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/33.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;在Ubuntu上使用kubectl，&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ mkdir -p .kube&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;把master节点上的 $HOME/.kube/config/admin.conf 拷贝到 这台Ubuntu机器的 $HOME/.kube/，并将admin.conf重命名为config&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;jkzhao@ubuntu31:~$ kubectl get nodes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       STATUS   ROLES    AGE   VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark17    Ready    &amp;lt;none&amp;gt;   21h   v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32    Ready    master   30h   v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ubuntu31   Ready    &amp;lt;none&amp;gt;   13m   v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;jkzhao@ubuntu31:~$ kubectl get pods -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                              READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-8zzkb           1/1     Running   0          30h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-t69hm           1/1     Running   0          30h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-spark32                      1/1     Running   1          30h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-apiserver-spark32            1/1     Running   1          30h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-controller-manager-spark32   1/1     Running   1          30h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-2hkjh       1/1     Running   0          29h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-f5fhc       1/1     Running   0          21h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-j596v       1/1     Running   0          13m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-9clf7                  1/1     Running   0          30h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-p5nrg                  1/1     Running   0          21h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-vbcs4                  1/1     Running   0          13m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-scheduler-spark32            1/1     Running   1          30h&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;如何从集群中移除Node&quot;&gt;&lt;a href=&quot;#如何从集群中移除Node&quot; class=&quot;headerlink&quot; title=&quot;如何从集群中移除Node&quot;&gt;&lt;/a&gt;如何从集群中移除Node&lt;/h2&gt;&lt;p&gt;如果需要从集群中移除spark17这个Node执行下面的命令：&lt;br&gt;在master节点上执行：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;kubectl drain spark17 --delete-local-data --force --ignore-daemonsets&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubectl delete node spark17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在spark17节点上执行：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;kubeadm reset&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ifconfig cni0 down&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ip link delete cni0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ifconfig flannel.1 down&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ip link delete flannel.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rm -rf /var/lib/cni/&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在ubuntu31节点上执行：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;kubectl delete node spark17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;重置集群&quot;&gt;&lt;a href=&quot;#重置集群&quot; class=&quot;headerlink&quot; title=&quot;重置集群&quot;&gt;&lt;/a&gt;重置集群&lt;/h2&gt;&lt;p&gt;在master节点上执行如下命令：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubeadm reset --ignore-preflight-errors=Swap &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] Reading configuration from the cluster...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] FYI: You can look at this config file with &amp;apos;kubectl -n kube-system get cm kubeadm-config -oyaml&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] WARNING: Changes made to this host by &amp;apos;kubeadm init&amp;apos; or &amp;apos;kubeadm join&amp;apos; will be reverted.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] Are you sure you want to proceed? [y/N]: y&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Running pre-flight checks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] Removing info for node &amp;quot;spark32&amp;quot; from the ConfigMap &amp;quot;kubeadm-config&amp;quot; in the &amp;quot;kube-system&amp;quot; Namespace&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W0412 13:10:50.222211    9235 reset.go:158] [reset] failed to remove etcd member: error syncing endpoints with etc: etcdclient: no available endpoints&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.Please manually remove this etcd member using etcdctl&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] Stopping the kubelet service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] unmounting mounted directories in &amp;quot;/var/lib/kubelet&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] Deleting contents of stateful directories: [/var/lib/etcd /var/lib/kubelet /etc/cni/net.d /var/lib/dockershim /var/run/kubernetes]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] Deleting contents of config directories: [/etc/kubernetes/manifests /etc/kubernetes/pki]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] Deleting files: [/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;The reset process does not reset or clean up iptables rules or IPVS tables.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;If you wish to reset iptables, you must do so manually.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;For example:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;iptables -F &amp;amp;&amp;amp; iptables -t nat -F &amp;amp;&amp;amp; iptables -t mangle -F &amp;amp;&amp;amp; iptables -X&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;If your cluster was setup to utilize IPVS, run ipvsadm --clear (or similar)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;to reset your system&amp;apos;s IPVS tables.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# iptables -F &amp;amp;&amp;amp; iptables -t nat -F &amp;amp;&amp;amp; iptables -t mangle -F &amp;amp;&amp;amp; iptables -X&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# rm -rf /var/lib/kubelet/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# rm -rf /var/lib/cni/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# rm -rf /var/lib/etcd/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# rm -rf /etc/kubernetes/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# rm -rf .kube/config &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# ifconfig cni0 down&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# ip link delete cni0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# ifconfig flannel.1 down&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# ip link delete flannel.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/37.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;登录另外两台机器：&lt;br&gt;CentOS：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# kubeadm reset --ignore-preflight-errors=Swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# iptables -F &amp;amp;&amp;amp; iptables -t nat -F &amp;amp;&amp;amp; iptables -t mangle -F &amp;amp;&amp;amp; iptables -X&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# rm -rf /var/lib/kubelet/                                                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# rm -rf /var/lib/cni/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# rm -rf /var/lib/etcd/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# rm -rf /etc/kubernetes/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# ifconfig flannel.1 down&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# ip link delete flannel.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Ubuntu：&lt;br&gt;切换到root用户：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# kubeadm reset --ignore-preflight-errors=Swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# iptables -F &amp;amp;&amp;amp; iptables -t nat -F &amp;amp;&amp;amp; iptables -t mangle -F &amp;amp;&amp;amp; iptables -X &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# rm -rf /var/lib/kubelet/  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# rm -rf /var/lib/cni/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# rm -rf /var/lib/etcd/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# rm -rf /etc/kubernetes/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# ifconfig flannel.1 down&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# ip link delete flannel.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;坑&quot;&gt;&lt;a href=&quot;#坑&quot; class=&quot;headerlink&quot; title=&quot;坑&quot;&gt;&lt;/a&gt;坑&lt;/h2&gt;&lt;h3 id=&quot;kubelet报错&quot;&gt;&lt;a href=&quot;#kubelet报错&quot; class=&quot;headerlink&quot; title=&quot;kubelet报错&quot;&gt;&lt;/a&gt;kubelet报错&lt;/h3&gt;&lt;p&gt;查看kubelet日志，发现kubelet一直在报错：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# journalctl -xeu kubelet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;qos_container_manager_linux.go:139] [ContainerManager] Failed to reserve QoS requests: failed to set supported cgroup subsystems for cgroup [kubepods burburstable]: Failed to find subsystem mount for required subsystem: pids&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# tail -f /var/log/messages&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Apr 10 16:48:48 spark17 kubelet: E0410 16:48:48.871706   11041 qos_container_manager_linux.go:329] [ContainerManager]: Failed to update QoS cgroup configuration&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Apr 10 16:48:48 spark17 kubelet: W0410 16:48:48.871726   11041 qos_container_manager_linux.go:139] [ContainerManager] Failed to reserve QoS requests: failed to set supported cgroup subsystems for cgroup [kubepods burstable]: Failed to find subsystem mount for required subsystem: pids&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# kubectl describe node spark17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Events:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Type     Reason                            Age                     From              Message&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ----     ------                            ----                    ----              -------&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Warning  FailedNodeAllocatableEnforcement  5m33s (x1741 over 31h)  kubelet, spark32  Failed to update Node Allocatable Limits [&amp;quot;kubepods&amp;quot;]: failed to set supported cgroup subsystems for cgroup [kubepods]: Failed to find subsystem mount for required subsystem: pids&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;查看当前系统支持哪些subsystem：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# cat /proc/cgroups&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#subsys_name    hierarchy       num_cgroups     enabled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cpuset  5       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cpu     4       104     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cpuacct 4       104     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;memory  6       104     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;devices 3       104     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;freezer 2       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;net_cls 8       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;blkio   9       104     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;perf_event      10      11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;hugetlb 7       11      1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;发现并不支持pids。&lt;/p&gt;
&lt;p&gt;查看当前系统内核：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# uname -r&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3.10.0-327.el7.x86_64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# grep CGROUP_ /boot/config-3.10.0-327.el7.x86_64   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# CONFIG_CGROUP_DEBUG is not set&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CONFIG_CGROUP_FREEZER=y&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CONFIG_CGROUP_DEVICE=y&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CONFIG_CGROUP_CPUACCT=y&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CONFIG_CGROUP_HUGETLB=y&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CONFIG_CGROUP_PERF=y&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CONFIG_CGROUP_SCHED=y&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;升级内核，经过测试，在CentOS 7.4默认的内核为3.10.0-514.26.2.el7.x86_64，默认是开启了pids subsystem，我这边使用yum升级内核为 3.10.0-957.el7.x86_64&lt;br&gt;查看仓库里有哪些版本的内核，并安装：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# yum list kernel.x86_64 --showduplicates | sort -r&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * updates: ap.stykers.moe&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Loading mirror speeds from cached hostfile&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Loaded plugins: fastestmirror, langpacks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kernel.x86_64                   3.10.0-957.el7                         base     &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kernel.x86_64                   3.10.0-957.5.1.el7                     updates  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kernel.x86_64                   3.10.0-957.1.3.el7                     updates  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kernel.x86_64                   3.10.0-957.10.1.el7                    updates  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kernel.x86_64                   3.10.0-327.el7                         @anaconda&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Installed Packages&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * extras: mirrors.huaweicloud.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * epel: mirrors.aliyun.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * elrepo: mirrors.tuna.tsinghua.edu.cn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * base: ap.stykers.moe&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Available Packages&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# yum install kernel-3.10.0-957.el7.x86_64 -y&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;由于CentOS 7使用grub2作为引导程序 ，所以和CentOS 6有所不同，并不是修改/etc/grub.conf来修改启动项，需要如下操作：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# cat /boot/grub2/grub.cfg |grep menuentry  ##查看有哪些内核选项&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if [ x&amp;quot;$&amp;#123;feature_menuentry_id&amp;#125;&amp;quot; = xy ]; then&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  menuentry_id_option=&amp;quot;--id&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  menuentry_id_option=&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;export menuentry_id_option&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;menuentry &amp;apos;CentOS Linux (3.10.0-957.el7.x86_64) 7 (Core)&amp;apos; --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option &amp;apos;gnulinux-3.10.0-327.el7.x86_64-advanced-7787952f-c2d4-4216-ae09-5188e7fd88b8&amp;apos; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;menuentry &amp;apos;CentOS Linux (3.10.0-327.el7.x86_64) 7 (Core)&amp;apos; --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option &amp;apos;gnulinux-3.10.0-327.el7.x86_64-advanced-7787952f-c2d4-4216-ae09-5188e7fd88b8&amp;apos; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;menuentry &amp;apos;CentOS Linux (0-rescue-d918a8d2df0e481a820b4e5554fed3b5) 7 (Core)&amp;apos; --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option &amp;apos;gnulinux-0-rescue-d918a8d2df0e481a820b4e5554fed3b5-advanced-7787952f-c2d4-4216-ae09-5188e7fd88b8&amp;apos; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# grub2-editenv list   #查看默认启动内核&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# shutdown -r now&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;重启后，查看内核版本，并查看是否支持pids subsystem。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# uname -r&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3.10.0-957.el7.x86_64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# cat /proc/cgroups&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#subsys_name    hierarchy       num_cgroups     enabled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cpuset  5       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cpu     4       110     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cpuacct 4       110     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;memory  3       110     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;devices 6       110     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;freezer 7       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;net_cls 2       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;blkio   10      110     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;perf_event      8       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;hugetlb 9       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pids    11      110     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;net_prio        2       11      1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此时已经支持了pids subsystem，查看kubelet已经不报错了&lt;/p&gt;
&lt;h3 id=&quot;apiserver疯狂刷日志：OpenAPI-AggregationController-Processing-item-k8s-internal-local-delegation-chain-0000000001&quot;&gt;&lt;a href=&quot;#apiserver疯狂刷日志：OpenAPI-AggregationController-Processing-item-k8s-internal-local-delegation-chain-0000000001&quot; class=&quot;headerlink&quot; title=&quot;apiserver疯狂刷日志：OpenAPI AggregationController: Processing item k8s_internal_local_delegation_chain_0000000001&quot;&gt;&lt;/a&gt;apiserver疯狂刷日志：OpenAPI AggregationController: Processing item k8s_internal_local_delegation_chain_0000000001&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# kubectl logs -f kube-apiserver-spark32 -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;I0411 12:01:07.724117       1 controller.go:102] OpenAPI AggregationController: Processing item k8s_internal_local_delegation_chain_0000000001&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;I0411 12:01:07.724291       1 controller.go:102] OpenAPI AggregationController: Processing item k8s_internal_local_delegation_chain_0000000002&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;疯狂的刷这两行日志。。。&lt;br&gt;网上查了在1.14.0版本上确实有人遇到这样的情况，见kubernetes issue：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;https://github.com/kubernetes/kubernetes/issues/75777&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes/pull/75781，说会在1.14.1版本里修复。去查了下1.14.1的CHANGELOG，上面写了已经修复了这个bug：&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/kubernetes/kubernetes/pull/75781，说会在1.14.1版本里修复。去查了下1.14.1的CHANGELOG，上面写了已经修复了这个bug：&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/36.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;但如今装的是1.14.0版本，只能尝试着降低apiserver这个组件的日志级别。基本上每个 kubernetes 组件都会有个通用的参数 –v；这个参数用于控制 kubernetes 各个组件的日志级别。官方关于apiserver命令行文档：&lt;a href=&quot;https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/，里面可以看到有个关于日志级别的选项：&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/，里面可以看到有个关于日志级别的选项：&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;-v, --v Level&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    number for the log level verbosity&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;关于Kubernetes组件输出日志级别说明：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/logging.md&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;kubeadm init在初始化master节点的时候生成了apiserver组件的manifests，在 /etc/kubernetes/manifests/ 目录下。修改文件kube-apiserver.yaml：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim kube-apiserver.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/34.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;然后重启kubelet，在重启之前我们先查看当前集群的pod，注意apiserver这个pod的运行时间，等会重启kubelet之后，在运行查询pod的命令，会发现apiserver的运行时间改了，其实是kubelet检测到了kube-apiserver的manifest文件改变了，于是重新生成了pod。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# systemctl restart kubelet&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/35.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;再去查看apiserver pod的日志，就发现没那么多输出了。&lt;br&gt;【说明】：&lt;br&gt;1.静态pod(DaemonSet)在特定的节点上直接通过 kubelet 守护进程进行管理，API 服务无法管理。它没有跟任何的副本控制器进行关联，kubelet 守护进程对它进行监控，如果崩溃了，kubelet 守护进程会重启它。Kubelet 通过 Kubernetes API 服务为每个静态 pod 创建 镜像 pod，这些镜像 pod 对于 API 服务是可见的，但是不受它控制。&lt;br&gt;2.&lt;a href=&quot;https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/#init-workflow&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;kubeadm init workflow&lt;/a&gt;里面有一句：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Static Pod manifests are written to /etc/kubernetes/manifests; the kubelet watches this directory for Pods to create on startup.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;之前采用二进制方式部署过Kubernetes，操作较为繁琐，此次采用kubeadm安装Kubernetes，Kubernetes相关组件介绍详见前面的文章。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>访问https，抓包是明文的</title>
    <link href="http://yoursite.com/2019/03/25/%E8%AE%BF%E9%97%AEhttps%EF%BC%8C%E6%8A%93%E5%8C%85%E6%98%AF%E6%98%8E%E6%96%87%E7%9A%84/"/>
    <id>http://yoursite.com/2019/03/25/访问https，抓包是明文的/</id>
    <published>2019-03-25T02:29:21.000Z</published>
    <updated>2019-05-15T03:11:51.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;Nginx启用了https，但是测试部门在使用fiddler工具抓包时，发现能抓到用户账号和密码。但是我自己在服务端用tcpdump抓包却抓不到明文账号和密码。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;现象&quot;&gt;&lt;a href=&quot;#现象&quot; class=&quot;headerlink&quot; title=&quot;现象&quot;&gt;&lt;/a&gt;现象&lt;/h2&gt;&lt;p&gt;测试反馈的问题：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/37.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;解释&quot;&gt;&lt;a href=&quot;#解释&quot; class=&quot;headerlink&quot; title=&quot;解释&quot;&gt;&lt;/a&gt;解释&lt;/h2&gt;&lt;p&gt;测试人员是在本地打开fiddler工具抓包，同时打开本地浏览器，输入应用地址，然后输入用户账号和密码，然后点击登录。在这个操作过程中，其实fiddler把测试人员输入账号和密码也给录制下来了，是客户端上传的明文账号和密码，因此也看到了明文账号和密码。这个看到的账号密码并不是https传输过程中看到的账号名和密码。&lt;br&gt;密文是针对https两端以外其他路径而言，作为https链接的两端，自然可以看到明文。这就好比，你自己打开一个网站，然后输入用户名和密码，你的朋友在你旁边看着你输入账号和密码，他是肯定能看见明文账号和密码的。&lt;br&gt;Https保证的是传输过程中第三方抓包看到的是密文。客户端和服务端，无论如何都可以拿到明文。在自己本地抓包不能说明什么。&lt;/p&gt;
&lt;h2 id=&quot;示例&quot;&gt;&lt;a href=&quot;#示例&quot; class=&quot;headerlink&quot; title=&quot;示例&quot;&gt;&lt;/a&gt;示例&lt;/h2&gt;&lt;p&gt;以&lt;a href=&quot;https://gitee.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;码云&lt;/a&gt; 网站为例，不需要抓包工具，打开F12就可以看到明文账号和密码。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/38.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/39.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;更合理办法&quot;&gt;&lt;a href=&quot;#更合理办法&quot; class=&quot;headerlink&quot; title=&quot;更合理办法&quot;&gt;&lt;/a&gt;更合理办法&lt;/h2&gt;&lt;p&gt;更安全的方式是，在写代码时，先将用户输入的账号和密码加密，然后再发到后台校验。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Nginx启用了https，但是测试部门在使用fiddler工具抓包时，发现能抓到用户账号和密码。但是我自己在服务端用tcpdump抓包却抓不到明文账号和密码。
    
    </summary>
    
      <category term="Nginx" scheme="http://yoursite.com/categories/Nginx/"/>
    
    
      <category term="Nginx" scheme="http://yoursite.com/tags/Nginx/"/>
    
      <category term="HTTPS" scheme="http://yoursite.com/tags/HTTPS/"/>
    
  </entry>
  
  <entry>
    <title>CentOS下安装字体不重启系统</title>
    <link href="http://yoursite.com/2019/03/22/CentOS%E4%B8%8B%E5%AE%89%E8%A3%85%E5%AD%97%E4%BD%93%E4%B8%8D%E9%87%8D%E5%90%AF%E7%B3%BB%E7%BB%9F/"/>
    <id>http://yoursite.com/2019/03/22/CentOS下安装字体不重启系统/</id>
    <published>2019-03-22T08:38:07.000Z</published>
    <updated>2019-03-22T09:05:46.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;代码在实现svg转png时，英文字符能正常显示，但是中文显示为方框。项目在大多数Linux系统上正常，今天在部署一个客户时出现乱码。仔细查看系统字体文件，发现没有中文字体。由于系统是客户那边自己装的，该系统安装时选择的是最小化安装，缺少字体库。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;现象&quot;&gt;&lt;a href=&quot;#现象&quot; class=&quot;headerlink&quot; title=&quot;现象&quot;&gt;&lt;/a&gt;现象&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Linux/1.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;安装中文字体uming-ttc&quot;&gt;&lt;a href=&quot;#安装中文字体uming-ttc&quot; class=&quot;headerlink&quot; title=&quot;安装中文字体uming.ttc&quot;&gt;&lt;/a&gt;安装中文字体uming.ttc&lt;/h2&gt;&lt;p&gt;找一个有该字体的操作系统，&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# cd /usr/share/fonts/
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;在这个目录下，有一个目录cjkuni-uming，这个目录下就有字体uming.ttc，将这个cjkuni-uming复制到缺少字体的系统的/usr/share/fonts/目录下。&lt;/p&gt;
&lt;p&gt;然后在系统上刷新字体缓存，&lt;strong&gt;不需要重启Linux。&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# fc-cache -f -v
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;如果没有这个命令，需要安装下：yum install -y fontconfig&lt;/p&gt;
&lt;p&gt;刷新缓存后重启下我们的项目，在做转换时，乱码就没了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;代码在实现svg转png时，英文字符能正常显示，但是中文显示为方框。项目在大多数Linux系统上正常，今天在部署一个客户时出现乱码。仔细查看系统字体文件，发现没有中文字体。由于系统是客户那边自己装的，该系统安装时选择的是最小化安装，缺少字体库。
    
    </summary>
    
      <category term="Linux" scheme="http://yoursite.com/categories/Linux/"/>
    
    
      <category term="乱码" scheme="http://yoursite.com/tags/%E4%B9%B1%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>Nginx缓存功能</title>
    <link href="http://yoursite.com/2019/03/14/Nginx%E7%BC%93%E5%AD%98%E5%8A%9F%E8%83%BD/"/>
    <id>http://yoursite.com/2019/03/14/Nginx缓存功能/</id>
    <published>2019-03-14T05:27:37.000Z</published>
    <updated>2019-03-14T07:38:54.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;业务线在压测性能时，希望将应用一些图标(appIcon.do)利用Nginx缓存功能缓存下来。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Nginx缓存功能&quot;&gt;&lt;a href=&quot;#Nginx缓存功能&quot; class=&quot;headerlink&quot; title=&quot;Nginx缓存功能&quot;&gt;&lt;/a&gt;Nginx缓存功能&lt;/h2&gt;&lt;p&gt;简单来说，就是Nginx将后端服务器返回来的部分内容缓存到本地磁盘，后面客户端请求中含有这部分内容时，可以从本地磁盘取出这些内容返回给客户端。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;如果Nginx本地没有缓存时，那么响应给客户端的过程是：被代理服务器先得自己磁盘IO一次，将内容取出，然后将内容通过网络IO响应给Nginx，Nginx然后在将该内容响应给客户端。&lt;br&gt;如果Nginx在本地缓存下这部分内容，当用户请求到达时，如果请求的内容中包含这些，Nginx直接从自己本地磁盘取得内容，构建响应报文，响应给客户端。&lt;br&gt;在后端服务器上(被代理服务器上)，磁盘上文件是按树状结构组织的，按照文件名、按照路径去组织的。我们去查找文件时，只能把整个树状结构，就是把document_root所指向的子目录，整体装入内存。将来我们找哪个文件时，才会知道这个文件在哪个路径下，能快速定位到这个文件。&lt;br&gt;Nginx缓存是这么处理的：存储也是树状结构，但是这种树状结构格式很独特，名字是固定等级的，要么是一级路径，要么是两级路径，要么是三级路径。而且每一级路径的文件的名字是hash码的一部分，要么是两个字符，要么是1个字符，因此直接基于用户请求url的字符串，就能知道这个文件在什么地方存放的。因为缓存下来的文件名是用户请求资源的url字符串的hash码，内容是那个请求页面的正常内容。&lt;br&gt;&lt;strong&gt;当用户请求url时，如何判定本地缓存有没有呢？&lt;/strong&gt;像后端服务器就只能遍历，去找树状结构路径下是不是存在。但是对于hash格式来讲，它实际上是基于路由方式来实现。对Nginx而言，通常是这么找的。把这个url编码以后，从右往左截取字符，完成路径路由。因为是16进制的，有1个字符，就有16种变化，有两个字符，就是256种变化，最多不超过3级。如果你的缓存定义分级路径是1:1:2，意味着1级子目录16个，就是说用1个字符来表示， 2级目录16个(指的是1个1级子目录下有16个)，此时一共是256个，3级子目录，每个子目录有256个，每个子目录2个字符。所以从编码后的url截取字符，从右往左，截1个字符表示1级子目录，在截一个字符表示2级子目录，在截两个字符，表示3级子目录。所以Nginx去找文件的时候，直接在url路径上就这个文件在哪个路径下了。当到第三级子目录下，底下的文件肯定不止1个，有一堆，这时候就得遍历去寻找要匹配的文件了。&lt;br&gt;对于Nginx缓存来讲，它的数据存储分为两个部分，第一部分是放在内存中的hash表，以便于一个url请求来的时候，做hash计算后去查表。如果hash表中没有，就不会去缓存在本地文件系统磁盘里找这个文件了。所以有没有命中在内存中就能判断了。第二部分是放在本地磁盘上的目录结构，一旦有，就路由到那个目录下，那个数据就在那。所以这个查找过程速度无与伦比，第一基于内存，第二它是hash值，时间O(1)，恒定，从100个中找1个和在100万中找一个所需要的时间几乎是等同的。 &lt;/p&gt;
&lt;h2 id=&quot;使用Nginx缓存&quot;&gt;&lt;a href=&quot;#使用Nginx缓存&quot; class=&quot;headerlink&quot; title=&quot;使用Nginx缓存&quot;&gt;&lt;/a&gt;使用Nginx缓存&lt;/h2&gt;&lt;p&gt;缓存空间得先定义，后使用。比如说在内存中用哪段空间来存hash表，用多大内存。磁盘上用哪段文件路径来存放目录树。&lt;br&gt;查缓存也有讲究，http的请求方法有GET、HEAD、POST、PUT、DELETE，后3种方法没必要查缓存。因此对每一种请求过来，我们先判定方法，这个方法如果不支持从缓存里找，就不用看缓存了。一般只对GET和HEAD启用缓存。&lt;br&gt;而且并不是所有GET和HEAD的资源都应该缓存。如果用户GET一个资源的时候， 用户第一次来访问时，服务器setcookie，这个就不应该缓存下来。还有一种场景，用户去请求一些资源时，服务器要求输入用户名和密码，这些内容也不应该缓存。因此不是GET和HEAD的所有资源都要缓存的，对于用户的私有信息，不应该缓存下来。&lt;br&gt;还有一些服务器端在响应时就说了，有些资源不能缓存，告诉代理服务器不能缓存，代理服务器也不应该缓存。服务器在响应时，为了避免代理服务器缓存下来，会告诉代理服务器这些资源是no store，基于cache control来定义。&lt;br&gt;浏览器是可以使用shift+f5强刷的，强制刷新就要求发请求报文时，no cache，意思是不能从缓存中给我响应。&lt;br&gt;再考虑一种场景，第一个用户请求资源时使用的是http 1.1的协议，取得的内容被Nginx缓存下来了。第二个用户使用http 1.0的协议去请求了，它两也不一定能完全兼容。所以还得考虑协议版本。协议版本不一样时，没准也不能使用缓存来响应。&lt;br&gt;缓存空间是有限的，存满了，这就需要cache_manager进程了，根据LRU(最近最少使用算法)将此前没有用的缓存对象清除出去。&lt;/p&gt;
&lt;h2 id=&quot;缓存指令&quot;&gt;&lt;a href=&quot;#缓存指令&quot; class=&quot;headerlink&quot; title=&quot;缓存指令&quot;&gt;&lt;/a&gt;缓存指令&lt;/h2&gt;&lt;p&gt;Nginx缓存指令说明：&lt;a href=&quot;http://nginx.org/en/docs/http/ngx_http_proxy_module.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://nginx.org/en/docs/http/ngx_http_proxy_module.html&lt;/a&gt;&lt;br&gt;缓存相关的有多个指令，proxy_cache打头的。缓存得先定义，后使用。下面来介绍一些常用的关于缓存方面的指令。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;定义缓存：&lt;/strong&gt;path [levels=levels] 这个目录下分几级子目录，每一级用几个字符来表示。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Syntax:	proxy_cache_path path [levels=levels] [use_temp_path=on|off] keys_zone=name:size [inactive=time] [max_size=size] [manager_files=number] [manager_sleep=time] [manager_threshold=time] [loader_files=number] [loader_sleep=time] [loader_threshold=time] [purger=on|off] [purger_files=number] [purger_sleep=time] [purger_threshold=time];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Default:	—&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Context:	http&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;比如：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/29.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;缓存内容，是按需创建目录的。而不是一开始把所有目录都创建出来。现在只是把缓存定义了，还没调用。上面定义的目录/data/nginx/需要事先创建好。&lt;br&gt;&lt;strong&gt;调用缓存指令：&lt;/strong&gt;&lt;br&gt;对于调用缓存来讲，至少需要3个参数。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;首先得声明调用(proxy_cache指令)，使用哪块缓存空间。(实践过了，如果之定义这一条指令，没有任何东西会被缓存下来)&lt;/li&gt;
&lt;li&gt;缓存时把什么当key，这也是是必须要给的。proxy_cache_key&lt;/li&gt;
&lt;li&gt;哪些内容能存，存多长时间得自己来定义。哪些东西不能存，哪些方法不检查缓存也得自己定义，虽然你不定义有默认值，但是也得定义出来 proxy_cache_methods、proxy_cache_valid&lt;br&gt;比如：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/30.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;其中最后一项配置解释下：&lt;br&gt;如果我们把内容缓存下来以后，后端服务器找不着了，也就是后端服务器不在线了，此时能不能用缓存内容来响应。也就是指明什么情况下可以使用过期的缓存来响应。比如后端服务器响应error，后端服务器连不上timeout&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;缓存实例&quot;&gt;&lt;a href=&quot;#缓存实例&quot; class=&quot;headerlink&quot; title=&quot;缓存实例&quot;&gt;&lt;/a&gt;缓存实例&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;【实例】：Nginx实现缓存图标&lt;/strong&gt;&lt;br&gt;先创建缓存目录：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mkdir /opt/nginx_cache
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;定义缓存：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/32.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;使用缓存：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/31.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;重载Nginx。此时缓存目录/opt/nginx_cache/first/目录下没有任何内容。&lt;/p&gt;
&lt;p&gt;浏览器访问，打开F12查看：&lt;br&gt;第一次访问时，都是MISS。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/33.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;此时查看opt/nginx_cache/first/目录下&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/34.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/36.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;再次刷新页面，就可以看到是命中了。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/35.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;业务线在压测性能时，希望将应用一些图标(appIcon.do)利用Nginx缓存功能缓存下来。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Nginx缓存功能&quot;&gt;&lt;a href=&quot;#Nginx缓存功能&quot; class=&quot;headerlink&quot; title=&quot;Nginx缓存功能&quot;&gt;&lt;/a&gt;Nginx缓存功能&lt;/h2&gt;&lt;p&gt;简单来说，就是Nginx将后端服务器返回来的部分内容缓存到本地磁盘，后面客户端请求中含有这部分内容时，可以从本地磁盘取出这些内容返回给客户端。
    
    </summary>
    
      <category term="Nginx" scheme="http://yoursite.com/categories/Nginx/"/>
    
    
      <category term="Nginx" scheme="http://yoursite.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>Nginx如何处理一个请求</title>
    <link href="http://yoursite.com/2019/03/06/Nginx%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E4%B8%80%E4%B8%AA%E8%AF%B7%E6%B1%82/"/>
    <id>http://yoursite.com/2019/03/06/Nginx如何处理一个请求/</id>
    <published>2019-03-06T06:24:10.000Z</published>
    <updated>2019-03-06T07:32:54.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;今天在配置Nginx多个虚拟主机的时候，发现一个问题，访问一个虚拟主机里的资源，结果却访问到了另外一个虚拟主机中的资源，赶紧去看看了官方文档，补补知识，在此记录一下Nginx是如何选定由哪个虚拟主机去处理请求的。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;问题及现象&quot;&gt;&lt;a href=&quot;#问题及现象&quot; class=&quot;headerlink&quot; title=&quot;问题及现象&quot;&gt;&lt;/a&gt;问题及现象&lt;/h2&gt;&lt;p&gt;由于公司应用较多，所以单独选择了一个地方存放应用的Nginx配置文件，在Nginx主配置文件中引入这个路径的配置文件就可以了。&lt;br&gt;在配置某个应用程序(rsfw_origin.conf)需要临时支持下https的时候，要求关闭http，只允许https。于是复制该应用配置文件为一个名字(rsfw_https.conf)，修改新配置文件里的一些与原有配置文件冲突的命名，比如upstream_server的名字等。并且关闭了http，只开启了https。两个配置文件内容大体如下：&lt;br&gt;&lt;strong&gt;rsfw_https.conf&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;server &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    listen       443;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server_name  rsfw.wisedu.com;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ssl on;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    #证书和私钥&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ssl_certificate /opt/ssl/rsfw.crt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ssl_certificate_key /opt/ssl/rsfw.key;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    access_log  logs/gemini.access.log gemini;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    location  /test &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    proxy_set_header  Host             $host;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    proxy_set_header  X-Real-IP        $remote_addr;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    proxy_set_header REMOTE-HOST $remote_addr;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    proxy_redirect http:// https://;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    proxy_pass http://rsfw_server;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;rsfw_origin.conf&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;server &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    listen       80;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server_name  testdt.wisedu.com;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    access_log  logs/rsfw_adapter.access.log rsfw_origin;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    location / &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        root   html;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        index  index.html index.htm;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    location  /test &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                proxy_set_header  Host             $host;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                proxy_set_header  X-Real-IP        $remote_addr;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                proxy_set_header REMOTE-HOST $remote_addr;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                proxy_pass http://rsfw_server_origin;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后浏览器访问：&lt;strong&gt;https:&lt;/strong&gt;//rsfw.wisedu.com/test/sys/emaphome/portal/index.do&lt;br&gt;输入用户名密码登录认证，没有问题。&lt;br&gt;接着浏览器访问：&lt;strong&gt;http:&lt;/strong&gt;//rsfw.wisedu.com/test/sys/emaphome/portal/index.do&lt;br&gt;我原以为应该是访问不了，结果竟然还跳到了登录页面。两个虚拟主机，我访问其中一个虚拟主机下的资源，怎么会跳到另外一个虚拟主机下寻找资源呢？(两个虚拟主机下都有location /test)&lt;br&gt;查看nginx的error.log，发现是&lt;strong&gt;server: testdt.wisedu.com&lt;/strong&gt;这台虚拟主机响应了请求(看下面的server：testdt.wisedu.com)：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;2019/03/06 14:52:29 [warn] 3754#0: *1624 an upstream response is buffered to a temporary file /usr/local/openresty/nginx/proxy_temp/2/09/0000000092 while reading upstream, client: 172.20.5.15, server: testdt.wisedu.com, request: &amp;quot;GET /test/sys/emapfunauth/pages/funauth-login/images/login_bg.jpg HTTP/1.1&amp;quot;, upstream: &amp;quot;http://172.16.7.78:8003/test/sys/emapfunauth/pages/funauth-login/images/login_bg.jpg&amp;quot;, host: &amp;quot;rsfw.wisedu.com&amp;quot;, referrer: &amp;quot;http://rsfw.wisedu.com/test/sys/emapfunauth/pages/funauth-login/funauth-login.css&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;由此可见，Nginx对于使用哪个虚拟主机来处理用户请求应该有自己的一套规则，于是赶紧去官方文档找找资料。&lt;/p&gt;
&lt;h2 id=&quot;原因及解决&quot;&gt;&lt;a href=&quot;#原因及解决&quot; class=&quot;headerlink&quot; title=&quot;原因及解决&quot;&gt;&lt;/a&gt;原因及解决&lt;/h2&gt;&lt;p&gt;官方文档：&lt;a href=&quot;http://nginx.org/en/docs/http/request_processing.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://nginx.org/en/docs/http/request_processing.html&lt;/a&gt;&lt;br&gt;中文文档：&lt;a href=&quot;https://tengine.taobao.org/nginx_docs/cn/docs/http/request_processing.html#how_to_prevent_undefined_server_names&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://tengine.taobao.org/nginx_docs/cn/docs/http/request_processing.html#how_to_prevent_undefined_server_names&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;总结一下，就是nginx会检测请求中的port是否匹配某个server配置块中listen指令，接着nginx继续测试请求的Host头是否匹配这个server块中的某个server_name的值。&lt;br&gt;如果主机名没有找到，nginx将把这个请求交给默认虚拟主机处理。第一个被列出的虚拟主机即nginx的默认虚拟主机——这是nginx的默认行为。而且，可以显式地设置某个主机为默认虚拟主机，即在”listen”指令中设置”default_server”参数：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;server &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    listen      80 default_server;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server_name test.wisedu.com;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在上面的例子中，由于rsfw_https.conf中的虚拟主机监听在了443端口，所以当我浏览器访问&lt;strong&gt;http:&lt;/strong&gt;//rsfw.wisedu.com/test/sys/emaphome/portal/index.do，不会被rsfw_https.conf中的虚拟主机rsfw.wisedu.com匹配到，于是交到了监听80端口的默认虚拟主机testdt.wisedu.com。&lt;/p&gt;
&lt;p&gt;接着做个实验，重新写一个配置文件，同时手动指定默认虚拟主机。新建一个配置文件wisedu_fe.conf，在其中加上default_server配置，如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;server &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        listen       80 default_server;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        server_name  ressignal.wisedu.com;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        access_log  logs/res.access.log res;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        location / &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            root   /opt/wisedu_fe/ver;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            index  index.html index.htm;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            add_header Access-Control-Allow-Origin *;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;加了default_server，这台新的虚拟主机就成为了默认虚拟主机。重载Nginx配置文件。&lt;br&gt;浏览器输入&lt;strong&gt;http:&lt;/strong&gt;//rsfw.wisedu.com/test/sys/emaphome/portal/index.do&lt;br&gt;结果：浏览器显示404，而不在登录界面了。&lt;br&gt;error.log日志：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;2019/03/06 15:28:53 [error] 4208#0: *4204 open() &amp;quot;/opt/wisedu_fe/ver/test/sys/emaphome/portal/index.do&amp;quot; failed (2: No such file or directory), client: 172.20.5.15, server: ressignal.wisedu.com, request: &amp;quot;GET /test/sys/emaphome/portal/index.do HTTP/1.1&amp;quot;, host: &amp;quot;rsfw.wisedu.com&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;相应的server也变为了&lt;strong&gt;server: ressignal.wisedu.com&lt;/strong&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;今天在配置Nginx多个虚拟主机的时候，发现一个问题，访问一个虚拟主机里的资源，结果却访问到了另外一个虚拟主机中的资源，赶紧去看看了官方文档，补补知识，在此记录一下Nginx是如何选定由哪个虚拟主机去处理请求的。
    
    </summary>
    
      <category term="Nginx" scheme="http://yoursite.com/categories/Nginx/"/>
    
    
      <category term="Nginx" scheme="http://yoursite.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>记几次Nginx问题处理</title>
    <link href="http://yoursite.com/2018/12/10/%E8%AE%B0%E5%87%A0%E6%AC%A1Nginx%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"/>
    <id>http://yoursite.com/2018/12/10/记几次Nginx问题处理/</id>
    <published>2018-12-10T02:38:00.000Z</published>
    <updated>2018-12-10T07:32:14.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;这几天遇到几个Nginx相关问题，处理完记录一下。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;前端资源无法加载&quot;&gt;&lt;a href=&quot;#前端资源无法加载&quot; class=&quot;headerlink&quot; title=&quot;前端资源无法加载&quot;&gt;&lt;/a&gt;前端资源无法加载&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;1.问题现象和排查&lt;/strong&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;客户反应浏览器访问应用，整个页面显示空白，开启浏览器F12发现很多前端资源报错误&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ERR_CONTENT_LENGTH_MISMATCH
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/27.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;查看Nginx error.log，发现竟然没有日志写入，于是立马查看磁盘空间，发现磁盘空间已满。检查发现是Nginx日志文件占用了很大的空间，应该是公司运维部门同事在安装时没有做日志切割策略，先解决问题。&lt;br&gt;先删除几个大的日志文件，然后reload nginx，但是发现磁盘空间并没有释放掉。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.解决&lt;/strong&gt;&lt;br&gt;一般说来不会出现删除文件后空间不释放的情况，但是也存在例外，比如文件被进程锁定，或者有进程一直在向这个文件写数据等等。&lt;br&gt;这里有多个服务在用到error.log这个文件，所以导致磁盘空间一直未释放。由于服务允许短时间重启，于是重启下Nginx，磁盘空间就释放了，并且服务访问也恢复了正常。&lt;br&gt;解决完再做个日志切割。&lt;/p&gt;
&lt;h2 id=&quot;后端在获取前端样式中文乱码&quot;&gt;&lt;a href=&quot;#后端在获取前端样式中文乱码&quot; class=&quot;headerlink&quot; title=&quot;后端在获取前端样式中文乱码&quot;&gt;&lt;/a&gt;后端在获取前端样式中文乱码&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;1.问题现象和排查&lt;/strong&gt;&lt;br&gt;公司前端css里会写一些字体样式，后端在引用时会偶尔出现中文乱码现象。F12查看时，发现css和js的response的Content-Type中没有charset=UTF-8。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.解决&lt;/strong&gt;&lt;br&gt;Nginx response 的 Content-Type 添加 charset=UTF-8。&lt;br&gt;查看官方文档，有指令可以配置：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;charset UTF-8;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;但是配置完发现js的响应上，Content-Type 已经添加了 charset=UTF-8，但是css样式的响应并没有自动添加上。&lt;br&gt;仔细阅读官方文档，发现Nignx默认只在     &lt;/p&gt;
&lt;pre&gt;&lt;code&gt;charset_types text/html text/xml text/plain text/vnd.wap.wml application/javascript application/rss+xml;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这几个后面添加。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/28.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;所以需要添加两个配置：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;charset UTF-8;
charset_types text/html text/xml text/plain text/vnd.wap.wml application/javascript application/rss+xml text/css;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这两个我配置在http段，然后重载Nginx，就生效了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;这几天遇到几个Nginx相关问题，处理完记录一下。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;前端资源无法加载&quot;&gt;&lt;a href=&quot;#前端资源无法加载&quot; class=&quot;headerlink&quot; title=&quot;前端资源无法加载&quot;&gt;&lt;/a&gt;前端资源无法加载&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;1.问题现象和排查&lt;/strong&gt;
    
    </summary>
    
      <category term="Nginx" scheme="http://yoursite.com/categories/Nginx/"/>
    
    
      <category term="Nginx" scheme="http://yoursite.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins+Ant自动化</title>
    <link href="http://yoursite.com/2018/12/04/jenkins-Ant%E8%87%AA%E5%8A%A8%E5%8C%96/"/>
    <id>http://yoursite.com/2018/12/04/jenkins-Ant自动化/</id>
    <published>2018-12-04T07:25:04.000Z</published>
    <updated>2018-12-04T08:46:56.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;最近需要帮部门一个ant项目做持续集成和发布，该项目有9个svn地址，还有比较多的依赖，踩了不少坑，搞完记录下。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;安装JDK-8&quot;&gt;&lt;a href=&quot;#安装JDK-8&quot; class=&quot;headerlink&quot; title=&quot;安装JDK 8&quot;&gt;&lt;/a&gt;安装JDK 8&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;# mkdir /usr/java
# tar zxf /usr/local/jdk-8u73-linux-x64.gz -C /usr/java/
# vim /etc/profile
export JAVA_HOME=/usr/java/jdk1.8.0_73
export PATH=$JAVA_HOME/bin:$PATH
export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
# source /etc/profile
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;安装Ant&quot;&gt;&lt;a href=&quot;#安装Ant&quot; class=&quot;headerlink&quot; title=&quot;安装Ant&quot;&gt;&lt;/a&gt;安装Ant&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;[root@res local]# wget http://mirror.bit.edu.cn/apache//ant/binaries/apache-ant-1.10.5-bin.zip
[root@res local]# unzip -oq apache-ant-1.10.5-bin.zip 
[root@res local]# ln -sv apache-ant-1.10.5 ant
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;Jenkins配置SVN地址&quot;&gt;&lt;a href=&quot;#Jenkins配置SVN地址&quot; class=&quot;headerlink&quot; title=&quot;Jenkins配置SVN地址&quot;&gt;&lt;/a&gt;Jenkins配置SVN地址&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;1.配置svn账号密码&lt;/strong&gt;&lt;br&gt;输入Jenkins访问地址，在首页左侧菜单有个“Credentials”，点击进去。在点击左侧菜单“Credentials”下的“System”，再点击右侧正文的“Global credentials (unrestricted)”。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/6.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;点击左侧菜单的“Add Credentials”，输入svn的账号密码，顺便添加一些描述信息。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/7.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.配置svn地址&lt;/strong&gt;&lt;br&gt;找到对应的项目，点击“配置”，点击“源码管理”，选择“Subversion”。输入9个项目的svn地址。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/8.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;需要注意的时，每个项目需要给它指定一个目录。否则最后一个项目拉下来的代码会把之前的代码全部覆盖掉。&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;外部依赖&quot;&gt;&lt;a href=&quot;#外部依赖&quot; class=&quot;headerlink&quot; title=&quot;外部依赖&quot;&gt;&lt;/a&gt;外部依赖&lt;/h2&gt;&lt;p&gt;由于需要很多外部jar包和其它的一些应用，所以必须在Jenkins服务器上创建并放好这些依赖。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/9.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/10.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;另外还需要创建ant编译时用到一些目录&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@res opt]# mkdir -p /opt/emap_build_workspace/out
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;编写build-xml文件&quot;&gt;&lt;a href=&quot;#编写build-xml文件&quot; class=&quot;headerlink&quot; title=&quot;编写build.xml文件&quot;&gt;&lt;/a&gt;编写build.xml文件&lt;/h2&gt;&lt;p&gt;build.xml文件内容如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;96&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;97&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;98&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;99&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;100&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;101&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;102&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;103&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;104&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;105&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;106&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;107&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;108&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;109&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;110&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;111&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;112&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;113&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;114&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;115&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;116&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;117&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;118&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;119&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;120&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;121&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;122&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;123&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;124&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;125&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;126&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;127&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;128&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;129&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;130&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;131&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;132&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;133&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;134&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;135&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;136&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;137&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;138&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;139&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;140&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;141&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;142&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;143&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;144&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;145&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;146&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;147&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;148&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;149&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;150&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;151&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;152&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;153&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;154&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;155&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;156&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;157&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;158&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;159&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;160&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;161&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;162&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;163&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;164&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;165&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;166&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;167&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;168&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;169&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;170&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;171&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;173&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;174&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;175&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;176&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;177&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;178&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;179&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;180&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;181&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;182&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;183&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;184&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;185&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;186&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;187&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;188&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;189&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;190&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;191&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;192&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;193&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;194&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;195&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;196&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;197&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;198&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;199&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;200&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;201&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;202&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;203&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;204&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;205&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;206&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;207&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;208&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;209&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;210&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;211&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;212&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;213&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;214&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;215&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;216&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;217&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;218&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;219&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;220&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;221&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;222&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;223&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;224&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;225&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;226&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;227&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;228&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;229&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;230&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;231&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;232&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;233&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;234&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;235&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;236&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;237&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;238&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;239&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;240&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;241&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;242&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;243&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;244&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;245&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;246&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;247&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;248&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;249&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;250&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;251&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;252&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;253&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;254&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;255&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;256&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;257&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;258&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;259&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;260&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;261&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;262&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;263&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;264&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;265&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;266&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;267&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;268&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;269&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;270&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;271&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;272&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;273&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;274&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;276&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;277&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;278&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;279&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;280&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;281&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;282&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;283&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;284&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;285&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;286&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;287&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;288&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;289&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;290&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;291&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;292&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;293&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;294&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;295&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;296&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;297&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;298&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;299&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;300&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;301&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;302&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;303&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;304&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;305&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;306&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;307&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;308&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;309&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;310&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;311&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;312&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;313&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;314&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;315&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;316&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;317&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;318&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;319&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;320&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;321&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;322&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;323&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;324&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;325&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;326&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;327&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;328&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;329&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;330&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;331&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;332&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;333&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;334&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;335&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;336&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;337&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;338&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;339&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;340&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;341&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;342&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;343&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;344&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;345&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;346&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;347&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;348&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;349&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;350&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;351&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;352&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;353&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;354&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;355&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;356&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;357&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;358&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;359&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;360&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;361&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;362&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;363&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;364&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;365&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;366&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;367&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;368&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;369&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;370&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;371&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;372&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;373&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;374&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;375&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;376&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;377&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;378&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;379&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;380&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;381&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;382&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;383&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;384&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;385&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;386&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;387&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;388&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;389&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;390&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;391&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;392&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;393&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;394&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;395&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;396&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;397&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;398&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;399&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;400&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;401&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;402&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;403&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;404&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;405&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;406&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;407&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;408&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;409&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;410&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;411&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;412&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;413&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;414&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;415&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;416&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;417&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;418&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;419&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;420&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;421&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;422&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;423&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;424&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;425&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;426&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;427&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;428&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;429&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;430&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;431&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;432&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;433&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;434&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;435&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;436&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;437&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;438&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;439&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;440&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;441&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;442&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;443&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;444&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;445&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;446&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;447&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;448&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;449&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;450&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;451&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;452&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;453&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;454&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;455&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;456&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;457&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;458&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;459&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;460&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;461&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;462&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;463&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;464&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;465&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;466&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;467&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;468&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;469&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;470&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;471&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;472&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;473&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;474&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;475&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;476&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;477&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;478&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;479&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;480&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;481&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;482&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;483&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;484&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;485&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;486&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;487&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;488&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;489&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;490&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;491&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;492&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;493&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;494&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;495&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;496&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;497&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;498&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;499&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;500&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;501&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;502&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;503&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;504&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;505&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;506&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;507&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;508&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;509&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;510&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;511&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;512&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;513&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;514&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;515&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;516&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;517&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;518&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;519&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;520&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;521&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;522&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;523&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;524&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;525&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;526&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;527&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;528&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;529&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;530&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;531&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;532&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;533&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;534&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;535&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;536&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;537&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;538&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;539&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;540&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;541&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;542&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;543&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;544&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;545&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;546&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;547&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;548&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;549&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;550&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;551&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;552&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;553&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;554&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;555&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;556&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;557&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;558&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;559&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;560&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;561&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;562&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;563&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;564&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot; standalone=&amp;quot;no&amp;quot;?&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;project basedir=&amp;quot;.&amp;quot; default=&amp;quot;build&amp;quot; name=&amp;quot;publish_jar&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property environment=&amp;quot;env&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;debuglevel&amp;quot; value=&amp;quot;source,lines,vars&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;encoding&amp;quot; value=&amp;quot;UTF-8&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;out&amp;quot; value=&amp;quot;/opt/emap_build_workspace/out/out&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;out_tmp&amp;quot; value=&amp;quot;/opt/emap_build_workspace/out/out_tmp&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;out_pub_classes&amp;quot; value=&amp;quot;/opt/emap_build_workspace/out/out_tmp_pub&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;work_home&amp;quot; value=&amp;quot;/root/.jenkins/workspace/gemini&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;pedestal_home&amp;quot; value=&amp;quot;/opt/emap&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;base_home&amp;quot; value=&amp;quot;/opt/wiseduAppGroups&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;tomcat_home_lib&amp;quot; value=&amp;quot;/opt/emap&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;emapAuth_classes&amp;quot; value=&amp;quot;/opt/wiseduAppGroups/emapAuth/pub_classes&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;emapcomponent_classes&amp;quot; value=&amp;quot;/opt/wiseduAppGroups/emapcomponent/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;zipOut&amp;quot; value=&amp;quot;/opt/emap_build_workspace/out/out.zip&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;emap_prj_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;fileset dir=&amp;quot;$&amp;#123;base_home&amp;#125;/$BASE/lib/&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;include name=&amp;quot;*.jar&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;fileset dir=&amp;quot;$&amp;#123;base_home&amp;#125;/$BASE/ext&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;include name=&amp;quot;**/*.jar&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;fileset dir=&amp;quot;$&amp;#123;tomcat_home_lib&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;include name=&amp;quot;jsp-api.jar&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;include name=&amp;quot;servlet-api.jar&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;fileset dir=&amp;quot;$&amp;#123;pedestal_home&amp;#125;/WEB-INF/lib/&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;include name=&amp;quot;*.jar&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;current_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/lib/&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;include name=&amp;quot;*.jar&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;pub_class_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;emapAuth_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;emapAuth_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;emapcomponent_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;emapcomponent_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;emapsender_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;out&amp;#125;/emapsender/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;emapfunauth_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;out&amp;#125;/emapfunauth/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;emapflow_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;out&amp;#125;/emapflow/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;flowstatistics_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;out&amp;#125;/flowstatistics/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;eetablecore_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;out&amp;#125;/eetablecore/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;emapturing_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;out&amp;#125;/emapturing/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;cleanall&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build.1.5&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/pub_src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;pub_class_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;app_info.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;EMAP_APP&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;init.project&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;jdkv1.5&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target  name=&amp;quot;init&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_emapsender&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/emapsender&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapsender/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapsender/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/pub_src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/emapsender/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;pub_class_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapsender/pub_classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapsender&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;app_info.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;EMAP_APP&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_emaptaskcenter&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/emaptaskcenter&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emaptaskcenter/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/emaptaskcenter/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emaptaskcenter&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;app_info.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;EMAP_APP&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;web&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emaptaskcenter/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_emapflow&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/emapflow&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapflow/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapflow/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/pub_src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;current_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapAuth_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/emapflow/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;current_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapAuth_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;pub_class_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapflow&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;config/propertiesPanel.json&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapflow/pub_classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapflow/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_flowstatistics&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/flowstatistics&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/flowstatistics/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/flowstatistics/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/pub_src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/flowstatistics/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;pub_class_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/flowstatistics/pub_classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/flowstatistics&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/flowstatistics/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_emapturing&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/emapturing&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapturing/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapturing/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/pub_src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapcomponent_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/emapturing/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapcomponent_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;pub_class_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapturing&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapturing/pub_classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapturing/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_emapfunauth&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/emapfunauth&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapfunauth/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapfunauth/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/pub_src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapAuth_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapcomponent_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/emapfunauth/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapAuth_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapcomponent_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;pub_class_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapsender_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapfunauth&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapfunauth/pub_classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapfunauth/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_eetablecore&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/eetablecore&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/eetablecore/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/eetablecore/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/pub_src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapflow_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/eetablecore/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;pub_class_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapflow_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/eetablecore&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/eetablecore/pub_classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/eetablecore/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_eetablemanage&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/eetablemanage&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		 &amp;lt;!--前端编译打包--&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;exec executable=&amp;quot;/bin/sh&amp;quot; failonerror=&amp;quot;true&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &amp;lt;arg value=&amp;quot;-c&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &amp;lt;arg value=&amp;quot;/root/.jenkins/workspace/tgbuilder release $&amp;#123;out_tmp&amp;#125;/web/&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;/exec&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/eetablemanage/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/eetablemanage/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;current_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapAuth_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapflow_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;eetablecore_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapfunauth_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapturing_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;flowstatistics_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/eetablemanage&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/eetablemanage/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_skylobby&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/skylobby&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/skylobby/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/skylobby/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;eetablecore_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/skylobby&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/skylobby/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;target  name=&amp;quot;end&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          &amp;lt;zip destfile=&amp;quot;$&amp;#123;zipOut&amp;#125;/&amp;quot; basedir=&amp;quot;$&amp;#123;out&amp;#125;&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;lt;delete dir=&amp;quot;$&amp;#123;out&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;!--&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target depends=&amp;quot;init.project,build.1.5&amp;quot; name=&amp;quot;build&amp;quot;&amp;gt;&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target depends=&amp;quot;init,build_emapsender,build_emapfunauth&amp;quot; name=&amp;quot;build&amp;quot;&amp;gt;&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	--&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target depends=&amp;quot;init,build_emapsender,build_emaptaskcenter,build_emapflow,build_flowstatistics,build_emapturing,build_emapfunauth,build_eetablecore,build_skylobby,build_eetablemanage,end&amp;quot; name=&amp;quot;build&amp;quot;&amp;gt;&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/project&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;发布脚本&quot;&gt;&lt;a href=&quot;#发布脚本&quot; class=&quot;headerlink&quot; title=&quot;发布脚本&quot;&gt;&lt;/a&gt;发布脚本&lt;/h2&gt;&lt;p&gt;需要配置Jenkins服务器上运行jenkins服务的用户登录目标机器不需要输入用户名和密码。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# Define constant&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;GEMINI_IP=172.16.206.32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;TOMCAT_HOME=/opt/tomcat-gemini-dev&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;GEMINI_HOME=/opt/wiseduAppGroups/gemini_dev&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;BACKUPS_HOME=/opt/gemini_backups&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Stop tomcat.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;$&amp;#123;TOMCAT_HOME&amp;#125;/bin/shutdown.sh&amp;quot; &amp;amp;&amp;gt;/dev/null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sleep 15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Check the stop is successful or not. If until not, kill the tomcat process.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;apos;ps -ef|grep &amp;quot;tomcat-gemini-dev&amp;quot; |grep -v &amp;quot;grep&amp;quot;&amp;apos; &amp;amp;&amp;gt;/dev/null; then&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  tomcat_pid=`ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;ps -ef | grep tomcat-gemini-dev | grep -v &amp;quot;grep&amp;quot; | awk &amp;apos;&amp;#123;print $2&amp;#125;&amp;apos;&amp;quot;`&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;kill -9 $&amp;#123;tomcat_pid&amp;#125;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;fi&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Check the stop is successful or not.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;apos;ps -ef|grep &amp;quot;tomcat-gemini-dev&amp;quot; |grep -v &amp;quot;grep&amp;quot;&amp;apos; &amp;amp;&amp;gt;/dev/null; then&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  echo &amp;quot;Tomcat stop failed.Please check the problem.&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  exit 5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;fi&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Backup previous version.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;cd $&amp;#123;GEMINI_HOME&amp;#125;; tar zcf gemini$(date +%Y%m%d).tar.gz eetablecore  eetablemanage  emapflow  emapfunauth  emapsender  emaptaskcenter  emapturing  flowstatistics  skylobby&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;mv -f $&amp;#123;GEMINI_HOME&amp;#125;/gemini$(date +%Y%m%d).tar.gz $&amp;#123;BACKUPS_HOME&amp;#125;/&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;cd $&amp;#123;GEMINI_HOME&amp;#125;; rm -rf eetablecore  eetablemanage  emapflow  emapfunauth  emapsender  emaptaskcenter  emapturing  flowstatistics  skylobby&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Copy the newest zip to host.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;scp /opt/emap_build_workspace/out/out.zip root@$&amp;#123;GEMINI_IP&amp;#125;:$&amp;#123;GEMINI_HOME&amp;#125;/ &amp;amp;&amp;gt;/dev/null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;cd $&amp;#123;GEMINI_HOME&amp;#125;; unzip -oq $&amp;#123;GEMINI_HOME&amp;#125;/out.zip&amp;quot; #不进入目录解压不了&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;rm -f $&amp;#123;GEMINI_HOME&amp;#125;/out.zip&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Start the tomcat.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;$&amp;#123;TOMCAT_HOME&amp;#125;/bin/startup.sh&amp;quot; &amp;amp;&amp;gt;/dev/null&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;邮件配置&quot;&gt;&lt;a href=&quot;#邮件配置&quot; class=&quot;headerlink&quot; title=&quot;邮件配置&quot;&gt;&lt;/a&gt;邮件配置&lt;/h2&gt;&lt;p&gt;我使用的是 Extended Email Publisher这个插件。在配置构建完发送邮件，遇到一个问题：&lt;br&gt;测试邮件能发出去，但是构建完收不到邮件。构建日志显示邮件触发器已经触发了。&lt;br&gt;解决：点开高级设置，&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/1.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/2.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;修改为：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/3.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;但是发现还是收不到邮件。&lt;/p&gt;
&lt;p&gt;网上找到了答案，需要在Jenkins系统设置里配置 Extended E-mail Notification，如下：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/4.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;Jenkins本身也有发邮件的配置，当你使用了其他发邮件的插件时，需要配置这些插件的发件人账号密码等。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/5.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;最近需要帮部门一个ant项目做持续集成和发布，该项目有9个svn地址，还有比较多的依赖，踩了不少坑，搞完记录下。
    
    </summary>
    
      <category term="持续集成" scheme="http://yoursite.com/categories/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/"/>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>Nginx实现XSS防御</title>
    <link href="http://yoursite.com/2018/05/10/Nginx%E5%AE%9E%E7%8E%B0XSS%E9%98%B2%E5%BE%A1/"/>
    <id>http://yoursite.com/2018/05/10/Nginx实现XSS防御/</id>
    <published>2018-05-10T06:49:16.000Z</published>
    <updated>2018-05-10T06:49:16.000Z</updated>
    
    <content type="html"></content>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Lua + OpenResty修改response body</title>
    <link href="http://yoursite.com/2018/05/03/Lua-OpenResty%E4%BF%AE%E6%94%B9response-body/"/>
    <id>http://yoursite.com/2018/05/03/Lua-OpenResty修改response-body/</id>
    <published>2018-05-03T05:18:45.000Z</published>
    <updated>2018-05-03T07:33:50.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;最近公司前端框架组提了个需求，希望修改response中的一个css文件，去掉一个样式：max-width:1632px;。于是便想到了利用lua。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;OpenResty-lua编程相关资料&quot;&gt;&lt;a href=&quot;#OpenResty-lua编程相关资料&quot; class=&quot;headerlink&quot; title=&quot;OpenResty lua编程相关资料&quot;&gt;&lt;/a&gt;OpenResty lua编程相关资料&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/openresty/lua-nginx-module#name&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;OpenResty Readme&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://moonbingbing.gitbooks.io/openresty-best-practices/lua/main.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;OpenResty最佳实践
&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;其中Readme要看完，是github上对OpenResty的lua-nginx-module比较全面的介绍。&lt;/p&gt;
&lt;h2 id=&quot;Nginx处理的几个阶段&quot;&gt;&lt;a href=&quot;#Nginx处理的几个阶段&quot; class=&quot;headerlink&quot; title=&quot;Nginx处理的几个阶段&quot;&gt;&lt;/a&gt;Nginx处理的几个阶段&lt;/h2&gt;&lt;p&gt;此处放上从网上找来的一幅图，&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/24.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;我这里修改response body显然是需要用到body_filter_by_lua*指令。&lt;/p&gt;
&lt;h2 id=&quot;修改Response-Body&quot;&gt;&lt;a href=&quot;#修改Response-Body&quot; class=&quot;headerlink&quot; title=&quot;修改Response Body&quot;&gt;&lt;/a&gt;修改Response Body&lt;/h2&gt;&lt;p&gt;修改Response Body的方式总体来说有4种，分别是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1.使用 body_filter_by_lua&lt;br&gt;指令来实现：&lt;a href=&quot;http://wiki.nginx.org/HttpLuaModule#body_filter_by_lua&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://wiki.nginx.org/HttpLuaModule#body_filter_by_lua&lt;/a&gt; 这个支持流式处理。 &lt;/li&gt;
&lt;li&gt;2.使用 ngx.location.capture 发起子请求，然后对子请求的响应体进行全缓冲式修改&lt;/li&gt;
&lt;li&gt;&lt;p&gt;3.可以使用 &lt;a href=&quot;https://github.com/agentzh/replace-filter-nginx-module&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ngx_replace_filter 模块&lt;/a&gt;来进行流式正则替换&lt;br&gt;替换成的目标值可以通过 ngx_lua 模块嵌入一小段 Lua 代码来事先计算好，放置在你自己定义的 nginx 变量中，然后在 replace_filter 指令中直接引用之。比如 &lt;/p&gt;
&lt;p&gt;  set_by_lua $my_var ‘… return …’;&lt;br&gt;  replace_filter ‘folderlist=\w+’ ‘folderlist=$my_var’ ‘g’; &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;4.使用http_sub_module模块&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;根据实际的需求，使用第3种，需要先安装sregex library，然后重新编译安装OpenResty，在编译时 ./configure –add-module=/path/to/replace-filter-nginx-module 启用replace-filter-nginx-module模块。&lt;br&gt;如果使用第4种方式都需要重新编译安装OpenResty，在编译时 –with-http_sub_module 启用http_sub_module模块。&lt;br&gt;这两种他们都不接受，因为涉及的客户太多。&lt;br&gt;对于第2种方式，是个比较好的方式，但是使用第二种方式需要增加一个用于子请求的location，相当于大动了配置文件，并且相应的我还得去修改之前写的安装升级脚本，于是最终还是选择了第一种方式。&lt;br&gt;虽然第2种到第4种的方案不适用于此次的需求，但是我还是尝试了使用下第2种和第4种的方案，并会把相关的脚本和配置贴在下面。&lt;/p&gt;
&lt;h3 id=&quot;第一种处理办法&quot;&gt;&lt;a href=&quot;#第一种处理办法&quot; class=&quot;headerlink&quot; title=&quot;第一种处理办法&quot;&gt;&lt;/a&gt;第一种处理办法&lt;/h3&gt;&lt;p&gt;lua脚本代码如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;-- body_filter_by_lua, body filter模块，ngx.arg[1]代表输入的chunk，ngx.arg[2]代表当前chunk是否为last&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;local chunk, eof = ngx.arg[1], ngx.arg[2]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;local buffered = ngx.ctx.buffered&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if not buffered then&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   buffered = &amp;#123;&amp;#125;  -- XXX we can use table.new here &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   ngx.ctx.buffered = buffered&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;end&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if chunk ~= &amp;quot;&amp;quot; then&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   buffered[#buffered + 1] = chunk&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   ngx.arg[1] = nil&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;end&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if eof then&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   local whole = table.concat(buffered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   ngx.ctx.buffered = nil&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   -- try to unzip&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   -- local status, debody = pcall(com.decode, whole) &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   -- if status then whole = debody end&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   -- try to add or replace response body&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   -- local js_code = ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   -- whole = whole .. js_code&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   whole = string.gsub(whole, &amp;quot;max%-width%:1632px%;&amp;quot;,  &amp;quot;&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   ngx.arg[1] = whole&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;end&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Nginx相关location配置如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;location  /fe_components/ &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     location ~ /fe_components/jqwidget/.*/bh-scenes-1.2.min.css &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            root   /usr/local/nginx/nginx/html/;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            body_filter_by_lua_file /opt/lua/replace.lua;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     root   /usr/local/nginx/nginx/html;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但是重载Nginx后发现，这个css样式的响应时间竟然是1.1min，可怕。。。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/25.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/26.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;仔细阅读上面贴出来的&lt;a href=&quot;https://github.com/openresty/lua-nginx-module#name&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;OpenResty Readme&lt;/a&gt;，发现有这么一段话：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;When the Lua code may change the length of the response body, then it is required to always clear out the Content-Length response header (if any) in a header filter to enforce streaming output, as in&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;location /foo &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    # fastcgi_pass/proxy_pass/...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    header_filter_by_lua_block &amp;#123; ngx.header.content_length = nil &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    body_filter_by_lua &amp;apos;ngx.arg[1] = string.len(ngx.arg[1]) .. &amp;quot;\\n&amp;quot;&amp;apos;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;于是需要修改配置文件，在body_filter_by_lua_file /opt/lua/replace.lua之前就得把header中的 content_length 置为空。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;location  /fe_components/ &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     location ~ /fe_components/jqwidget/.*/bh-scenes-1.2.min.css &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            root   /usr/local/nginx/nginx/html/;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            header_filter_by_lua &amp;apos;ngx.header.content_length = nil&amp;apos;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            body_filter_by_lua_file /opt/lua/replace.lua;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     root   /usr/local/nginx/nginx/html;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这样重载Nginx，清除缓存重新访问下，发现加载就正常了。&lt;br&gt;仔细了解了下原因，当代码运行到 body_filter_by_lua&lt;em&gt; 时，HTTP 报头（header）已经发送出去了。如果在之前设置了跟响应体相关的报头，而又在 body_filter_by_lua&lt;/em&gt; 中修改了响应体，会导致响应报头和实际响应的不一致。举个简就是说这个例子里上游的服务器返回了 Content-Length 报头，而 body_filter_by_lua* 又修改了响应体的实际大小（因为我删除了一些字符串）。客户端收到这个报头后，按其中的 Content-Length 去处理，顺着一头栽进坑里。由于Nginx 的流式响应，发出去的报头就像泼出去的水，要想修改只能提前进行。这是流式处理常常面对的悖论：要在流的开始输出长度，但又不能在那个时间事先知道流的长度。&lt;br&gt;对于处理逻辑简单的场景来说，Lua是十分合适的。 &lt;/p&gt;
&lt;h3 id=&quot;第二种处理办法&quot;&gt;&lt;a href=&quot;#第二种处理办法&quot; class=&quot;headerlink&quot; title=&quot;第二种处理办法&quot;&gt;&lt;/a&gt;第二种处理办法&lt;/h3&gt;&lt;p&gt;lua脚本：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;ngx.req.read_body()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;local data = ngx.req.get_body_data()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;local args = ngx.req.get_uri_args()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;local res = ngx.location.capture(&amp;quot;/bh-scenes-1.2.min.css&amp;quot;, &amp;#123;method = ngx.HTTP_GET, body=data, args=args&amp;#125;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;res.body = string.gsub(res.body, &amp;quot;max%-width%:1632px%;&amp;quot;, &amp;quot;&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ngx.say(res.body)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Nginx相关配置：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;location = /bh-scenes-1.2.min.css &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      root   /usr/local/nginx/nginx/html/fe_components/jqwidget/teal/;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;location  /fe_components/ &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     location ~ /fe_components/jqwidget/.*/bh-scenes-1.2.min.css &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          content_by_lua_file /opt/lua/replace2.lua;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     root   /usr/local/nginx/nginx/html;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;第四种处理办法&quot;&gt;&lt;a href=&quot;#第四种处理办法&quot; class=&quot;headerlink&quot; title=&quot;第四种处理办法&quot;&gt;&lt;/a&gt;第四种处理办法&lt;/h3&gt;&lt;p&gt;需要重新编译安装OpenResty，编译时加入参数 –with-http_sub_module。&lt;br&gt;Nginx相关配置如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;location  /fe_components/ &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        location ~ /jqwidget/teal/bh-scenes-1.2.min.css &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           #sub_filter_types *;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           sub_filter_types text/css;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           sub_filter &amp;apos;max-width:1632px;&amp;apos;  &amp;apos;&amp;apos;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           sub_filter_once off;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           root   /usr/local/nginx/nginx/html/;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        root   /usr/local/nginx/nginx/html;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;最近公司前端框架组提了个需求，希望修改response中的一个css文件，去掉一个样式：max-width:1632px;。于是便想到了利用lua。
    
    </summary>
    
      <category term="Nginx" scheme="http://yoursite.com/categories/Nginx/"/>
    
    
      <category term="Nginx" scheme="http://yoursite.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>基于mysqldump做备份恢复</title>
    <link href="http://yoursite.com/2018/04/21/%E5%9F%BA%E4%BA%8Emysqldump%E5%81%9A%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"/>
    <id>http://yoursite.com/2018/04/21/基于mysqldump做备份恢复/</id>
    <published>2018-04-21T00:17:27.000Z</published>
    <updated>2018-04-24T03:27:19.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;备份和恢复概念&quot;&gt;&lt;a href=&quot;#备份和恢复概念&quot; class=&quot;headerlink&quot; title=&quot;备份和恢复概念&quot;&gt;&lt;/a&gt;备份和恢复概念&lt;/h2&gt;&lt;h3 id=&quot;备份和恢复的意义&quot;&gt;&lt;a href=&quot;#备份和恢复的意义&quot; class=&quot;headerlink&quot; title=&quot;备份和恢复的意义&quot;&gt;&lt;/a&gt;备份和恢复的意义&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;灾难恢复：比如机房被淹。&lt;/li&gt;
&lt;li&gt;审计：比如想知道某一数据在某一时刻是什么样的。&lt;/li&gt;
&lt;li&gt;测试 &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;备份：目的用于恢复。请注意要对备份数据做恢复测试，防止备份的不能恢复，到时候就麻烦了。&lt;/p&gt;
&lt;h3 id=&quot;备份类型&quot;&gt;&lt;a href=&quot;#备份类型&quot; class=&quot;headerlink&quot; title=&quot;备份类型&quot;&gt;&lt;/a&gt;备份类型&lt;/h3&gt;&lt;p&gt;1.根据备份时，数据库服务器是否在线：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;冷备：cold backup。&lt;/strong&gt;服务器离线，数据库读写操作都不能执行。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;温备：warm backup。&lt;/strong&gt;全局施加共享锁，所有业务只能读，不能写。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;热备：hot backup。&lt;/strong&gt;服务器不离线，读写操作都能进行。这就可能会有问题了。我们去备份，数据量很大，我们得夜间备份，在你复制的过程中，如果文件发生了改变，前一半后一半时间戳不一致，备份好的文件恢复过来是不允许访问的。在文件系统上，这样的文件属于时间点不一致文件，因此是不允许访问的。我们可以把整个数据库锁定，然后创建一快照，通过快照进行备份。通过快照备份，时间点一定是一致的，但是也有一些其他的问题。首先你要锁定整个库，你一锁定，别人就读写不了了。所以这也不能算是热备。真正的热备是指任何业务不终止，它能够自动在背后进行备份，而且自动保证时间点是一致的。&lt;strong&gt;【注意】:要想完成热备，通常是基于事务的存储引擎才能完成的。&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;2.根据备份的数据集：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;完全备份：full backup&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;部分备份: partial backup&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;3.根据备份时的接口（直接备份数据文件还是通过mysql服务器导出数据）：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;物理备份：&lt;/strong&gt;直接复制(归档)数据文件的备份方式；physical backup。&lt;br&gt;copy命令就可以备份了，还可以tar归档压缩备份，因此不需要额外的工具就可以备份。恢复也很简单，把备份的文件复制到数据库里面就可以了，但是要兼容才行。但好在MySQL的InnoDB和MyISAM非常容易跨平台，一般来说，在windows上备份的在Linux上也能用，在Linux上备份的在windows上也能用。物理备份比较适合大数据量备份，比如超过10G，甚至几十个G，千万别用逻辑备份。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;逻辑备份：&lt;/strong&gt;把数据从库中提出出来保存为文本文件；logical backup。&lt;br&gt;从根本上来讲，逻辑备份备份后为文本文件，我们可以使用grep、sed、awk来处理查看，物理备份的文件则不能被如此处理。而且逻辑备份恢复简单，导入就可以了。逻辑备份也有缺点，比如说与物理备份恢复速度比，逻辑备份恢复更慢，占据空间更大。还有逻辑备份有个重要缺点，无法保证浮点数的精度，因为我们必须把二进制数据转换成文本格式。更重要的是使用逻辑备份还原数据以后还需要重建索引。 对于非常大的表，重建索引是相当消耗时间和资源的，由其是CPU资源。逻辑备份的工具：mysqldump&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;4.根据备份时是备份整个数据还是仅备份变化的数据：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;完全备份：&lt;/strong&gt;full backup&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;增量备份：&lt;/strong&gt;incremental backup。得使用专业的备份工具进行增量备份。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;差异备份：&lt;/strong&gt;differential backup&lt;br&gt;增量和差异：差异，每一次起始点不是上一次备份，而是上一次完全备份。见下图。将来设计备份策略的时候，需要根据你的数据量变化频度来设计。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/93.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;备份策略&quot;&gt;&lt;a href=&quot;#备份策略&quot; class=&quot;headerlink&quot; title=&quot;备份策略&quot;&gt;&lt;/a&gt;备份策略&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;选择备份方式&lt;/li&gt;
&lt;li&gt;选择备份时间&lt;/li&gt;
&lt;li&gt;考虑到恢复成本&lt;ul&gt;
&lt;li&gt;恢复时长&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;备份成本：&lt;ul&gt;
&lt;li&gt;锁时间&lt;/li&gt;
&lt;li&gt;备份时长&lt;/li&gt;
&lt;li&gt;备份负载&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;备份对象&quot;&gt;&lt;a href=&quot;#备份对象&quot; class=&quot;headerlink&quot; title=&quot;备份对象&quot;&gt;&lt;/a&gt;备份对象&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;数据&lt;/li&gt;
&lt;li&gt;配置文件&lt;/li&gt;
&lt;li&gt;代码：存储过程，存储函数，触发器&lt;/li&gt;
&lt;li&gt;OS相关的配置文件，如crontab配置计划及相关的脚本&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;备份工具&quot;&gt;&lt;a href=&quot;#备份工具&quot; class=&quot;headerlink&quot; title=&quot;备份工具&quot;&gt;&lt;/a&gt;备份工具&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;1.mysqldump：&lt;/strong&gt;MySQL原生自带的逻辑备份工具，单线程工具。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;InnoDB热备、温备和冷备，MyISAM温备，Aria温备&lt;/li&gt;
&lt;li&gt;因为是逻辑备份，所以备份和恢复过程较慢&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;2.mysqldumper: &lt;/strong&gt;多线程的mysqldump。装上percona的tools之后，mysqldumper就在里面。多线程同时备份多个库，在必要的场景下缩短备份时间是很有必要的。&lt;/p&gt;
&lt;p&gt;这两个备份工具很难实现差异或增量备份；&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.lvm-snapshot:&lt;/strong&gt; 基于lvm的逻辑卷快照进行备份。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;这是接近于热备的工具：为什么叫接近于？因为要先请求全局锁，而后创建快照，并在创建快照完成后释放全局锁；&lt;/li&gt;
&lt;li&gt;使用cp、tar等工具进行物理备份；&lt;/li&gt;
&lt;li&gt;备份和恢复速度较快；&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;很难实现增量备份，并且请求全局需要等待一段时间，在繁忙的服务器上尤其如此；&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;4.部分备份工具：&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;SELECT clause INTO OUTFILE &amp;apos;/path/to/somefile&amp;apos;
LOAD DATA INFILE &amp;apos;/path/from/somefile&amp;apos;   #恢复时得使用这个命令恢复。
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;部分备份工具， 不会备份关系定义，仅备份表中的数据；&lt;/li&gt;
&lt;li&gt;也是个逻辑备份工具，快于mysqldump。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;5.mysqlhotcopy:&lt;/strong&gt;几乎冷备。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;6.专业备份工具：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Innobase: 商业备份工具, innobackup&lt;/li&gt;
&lt;li&gt;Xtrabackup: 由Percona提供的开源备份工具。需要单独安装。&lt;ul&gt;
&lt;li&gt;InnoDB热备，增量备份；&lt;/li&gt;
&lt;li&gt;MyISAM温备，只是完全备份，不支持增量；&lt;/li&gt;
&lt;li&gt;物理备份，速度快；&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;mysqldump备份&quot;&gt;&lt;a href=&quot;#mysqldump备份&quot; class=&quot;headerlink&quot; title=&quot;mysqldump备份&quot;&gt;&lt;/a&gt;mysqldump备份&lt;/h2&gt;&lt;h3 id=&quot;mysqldump备份介绍&quot;&gt;&lt;a href=&quot;#mysqldump备份介绍&quot; class=&quot;headerlink&quot; title=&quot;mysqldump备份介绍&quot;&gt;&lt;/a&gt;mysqldump备份介绍&lt;/h3&gt;&lt;p&gt;【注意】：数据量在10G以下。&lt;br&gt;相当于一个MySQL客户端工具，你的服务器在远程，mysqldump在本地，没有任何问题，也就意味着二者可以在不同的主机上。可实现完全备份和部分备份，但是还原一个库时，这个库得事先存在，就是说在还原前，先得CREATE DATABASE。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;man mysqldump
mysqldump [options] [db_name [tbl_name ...]]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;备份单个库：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysqldump [options] db_name
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;恢复时：如果目标库不存在，需要事先手动创建。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例1】：备份和恢复。&lt;/strong&gt;&lt;br&gt;1.先备份库&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# mysqldump -uroot -hlocalhost -p hellodb &amp;gt;/tmp/hdb.sql
Enter password: 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;2.连接上mysql数据库，删除库hellodb&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; DROP DATABASE hellodb;
Query OK, 7 rows affected (0.01 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;3.恢复，得事先创建库&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# mysql -uroot -hlocalhost -p &amp;lt;/tmp/hdb.sql 
Enter password: 
ERROR 1046 (3D000) at line 22: No database selected

mysql&amp;gt; CREATE DATABASE hellodb DEFAULT CHARSET &amp;apos;utf8&amp;apos;;
Query OK, 1 row affected (0.00 sec)

[root@db ~]# mysql -uroot -hlocalhost -p hellodb &amp;lt;/tmp/hdb.sql     
Enter password: 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;所以说指定数据库进行备份的这种方式，它只是备份这个库里的东西，它以为这个库是事先存在的，所以恢复时是不会自动创建库的。也可以备份某个表。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;--all-databases:　备份所有库。恢复时不需要事先创建库名。
--databases db1 db2 ...: 备份指定的多个库。多个库名间用空格隔开，事先不需要创建库名。
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;【示例2】：备份前加锁。（这才是真正的备份，要锁表）&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;–lock-all-tables：请求锁定所有表之后再备份，对MyISAM、InnoDB、Aria做温备。&lt;/li&gt;
&lt;li&gt;–lock-tables：备份哪张表，就锁定哪张表。这种并不理想，不建议使用，使用上面的那个。&lt;/li&gt;
&lt;li&gt;–single-transaction: 能够对InnoDB存储引擎实现热备；&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@db ~]# mysqldump -uroot -hlocalhost -p hellodb --lock-all-tables &amp;gt;/root/hellodb.sql &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Enter password: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@db ~]# mysqldump -uroot -hlocalhost -p --databases hellodb --lock-all-tables &amp;gt;/root/hellodb2.sql  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Enter password:&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;【注意】:上面两句，第二句在备份单个表时也加了–databases参数，这样备份后的文件里是有CREATE DATABASE语句的。但是–lock-all-tables这种方式也不是很理想，其他的请求会被阻塞，如果你能确保你要备份的数据库的表的底层存储引擎都是InnoDB的话，可以使用另外一种备份方式，–single-transaction，基于多版本并发控制完成对InnoDB存储的热备，和–lock-all-tables不要同时使用。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;备份代码：mysqldump只备份数据，不备份代码。&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;–events: 备份事件调度器代码&lt;/li&gt;
&lt;li&gt;–routines: 备份存储过程和存储函数&lt;/li&gt;
&lt;li&gt;–triggers：备份触发器&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;备份时滚动日志：&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;--flush-logs: 备份前、请求到锁之后滚动日志。
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;为什么要滚动日志呢？恢复是要采用完全备份+增量备份或差异备份，最后是恢复不到数据损坏的那一刻的，比如你周日做的完全备份，周三中午崩掉了，你可以采用完全备份+周一、周二的增量备份，或者完全备份+差异备份，但是你周三凌晨到周三中午的数据怎么恢复？依靠二进制日志。滚动之后，恢复时你就知道从哪个文件向后是要用到的。因此用mysqldump做完全备份时都应该做–flush-logs。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;复制时的同步位置标记：&lt;/strong&gt;&lt;br&gt;主从复制架构中的主服务器数据，说白了它就是在你没有flush-logs时怎么知道下一次恢复时用这个文件怎么恢复到时间点。–master-data帮我们备份那一刻二进制日志的文件名及事件所处的位置。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;--master-data=[0|1|2]
  0: 不记录
  1：记录为CHANGE MASTER语句
  2：记录为注释的CHANGE MASTER语句
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;【总结】:使用mysqldump备份需要使用的参数：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;请求锁：–lock-all-tables或使用–singe-transaction进行innodb热备；&lt;/li&gt;
&lt;li&gt;滚动日志：–flush-logs&lt;/li&gt;
&lt;li&gt;选定要备份的库：–databases&lt;/li&gt;
&lt;li&gt;记录二进制日志文件及位置：–master-data=&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;mysqldump备份示例&quot;&gt;&lt;a href=&quot;#mysqldump备份示例&quot; class=&quot;headerlink&quot; title=&quot;mysqldump备份示例&quot;&gt;&lt;/a&gt;mysqldump备份示例&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;【示例1】:手动施加锁，然后进行备份。&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/94.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/95.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;【注意】：刷写所有表：把所有表在缓冲区中的内容通通同步到磁盘上。如果你的数据量很大，这句刷写和加锁语句要等很长时间。&lt;br&gt;然后用mysqldump备份就可以了。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# mysqldump -uroot -p --databases hellodb &amp;gt;/tmp/hellodb2.sql
Enter password: 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;备份完了记得释放锁：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; UNLOCK TABLES;
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;【示例2】:手动施加锁太麻烦，直接用mysqldump备份。&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# mysqldump -uroot -p --databases hellodb --lock-all-tables --flush-logs &amp;gt;/tmp/hellodb3.sql
Enter password: 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;如果有代码块，也需要把相应选项加进来。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;–events: 备份事件调度器代码&lt;/li&gt;
&lt;li&gt;–routines: 备份存储过程和存储函数&lt;/li&gt;
&lt;li&gt;–triggers：备份触发器&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;热备，你得确定库中所有表的存储引擎都是InnoDB存储引擎&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# mysqldump -uroot -p --databases hellodb --single-transaction --flush-logs &amp;gt;/tmp/hellodb4.sql                 
Enter password: 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;还应该指定–master-data=[0|1|2]&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# mysqldump -uroot -p --databases hellodb --lock-all-tables --flush-logs --master-data=2 &amp;gt;/tmp/hellodb5.sql
Enter password: 
[root@db ~]# vim /tmp/hellodb5.sql 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/96.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;恢复:&lt;/strong&gt;&lt;br&gt;建议：临时性关闭二进制日志，关闭其它用户连接。因为恢复时经常会创建数据库，创建表，插入数据，这部分没必要记录二进制日志。用这个备份恢复时只能恢复到上一次完全备份的位置，要想做时间点还原，还需要二进制日志。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例3】:数据库即时点恢复。&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# mysqldump -uroot -p --databases hellodb --lock-all-tables --flush-logs --master-data=2 &amp;gt;/tmp/hellodb6.sql
Enter password: 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;备份后，我们在hellodb库中创建了表，插入了一些数据。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; use hellodb&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Database changed&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; create table newtable(Name CHAR(30));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Query OK, 0 rows affected (0.04 sec)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; insert into newtable values (&amp;apos;Tom&amp;apos;),(&amp;apos;Jerry&amp;apos;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Query OK, 2 rows affected (0.00 sec)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Records: 2  Duplicates: 0  Warnings: 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; quit&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Bye&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;没注意把数据库hellodb删除了&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; DROP DATABASE hellodb;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Query OK, 8 rows affected (0.03 sec)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; quit&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Bye&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;恢复过程：&lt;br&gt;①让服务器离线，最起码你得保证服务器不能被别人连进来。&lt;br&gt;开启防火墙或者其他。&lt;/p&gt;
&lt;p&gt;②把即时点前的二进制日志导出来。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/97.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;二进制日志是master-bin.000013的120位置。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# vim /tmp/hellodb6.sql 
[root@db ~]# cd /data/binlog/
[root@db binlog]# mysqlbinlog --start-position=120 master-bin.000013 #这个日志文件和文件名是在配置文件中定义的
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/98.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db binlog]# mysqlbinlog --start-position=120 --stop-position=446 master-bin.000013 &amp;gt;/tmp/helldb6.inc.sql
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/99.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;③连上mysql服务器做恢复，先临时性关闭二进制日志&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/100.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;千万不要xshell另起一个会话，导入完全备份，因为session sql_log_bin=0只对当前会话生效，另起一会话导入备份，那么同时也会写到二进制日志中，这是我们不期望的。&lt;/p&gt;
&lt;p&gt;④恢复到即时点。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/101.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/102.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/103.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;但事实上这个开不开没什么影响，只要你自己不在当前session中操作就行。     &lt;/p&gt;
&lt;p&gt;【总结】:备份策略：基于mysqldump&lt;br&gt;&lt;strong&gt;1.备份：mysqldump+二进制日志文件&lt;/strong&gt;&lt;br&gt;    周日做一次完全备份：备份的同时滚动日志&lt;br&gt;    周一至周六：备份二进制日志；(可以每天都FLUSH LOGS，然后把备份之前的那个二进制日志，每天备份每天的二进制日志，直接copy就可以备份二进制日志文件。这里其实是把二进制日志当增量备份)。&lt;br&gt;&lt;strong&gt;2.恢复&lt;/strong&gt;&lt;br&gt;    完全备份+各二进制日志文件中至此刻的事件&lt;br&gt;   日志滚动也可以使用mysqladmin工具：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db binlog]# mysqladmin -uroot -p flush-logs
Enter password: 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;对MySQL配置文件，以及与MySQL相关的OS配置文件在每次修改后都应该直接进行备份。cp一份放在一个地方就行。&lt;/p&gt;
&lt;p&gt;我们可以写一个备份脚本：&lt;br&gt;1、备份所有数据库；&lt;br&gt;2、在每周日凌晨自动执行；&lt;br&gt;【注意】:crontab的PATH环境变量和系统的PATH环境变量是不一样的，无论你在命令行中使用命令多么顺当，在crontab中未必会执行，所以你写一个脚本的目的不是在命令行中执行，而是在crontab中执行，请使用命令全路径。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;备份和恢复概念&quot;&gt;&lt;a href=&quot;#备份和恢复概念&quot; class=&quot;headerlink&quot; title=&quot;备份和恢复概念&quot;&gt;&lt;/a&gt;备份和恢复概念&lt;/h2&gt;&lt;h3 id=&quot;备份和恢复的意义&quot;&gt;&lt;a href=&quot;#备份和恢复的意义&quot; class=&quot;headerlink&quot; title=&quot;备份和恢复的意义&quot;&gt;&lt;/a&gt;备份和恢复的意义&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;灾难恢复：比如机房被淹。&lt;/li&gt;
&lt;li&gt;审计：比如想知道某一数据在某一时刻是什么样的。&lt;/li&gt;
&lt;li&gt;测试
    
    </summary>
    
      <category term="MySQL" scheme="http://yoursite.com/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="http://yoursite.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL日志功能详解</title>
    <link href="http://yoursite.com/2018/04/16/MySQL%E6%97%A5%E5%BF%97%E5%8A%9F%E8%83%BD%E8%AF%A6%E8%A7%A3/"/>
    <id>http://yoursite.com/2018/04/16/MySQL日志功能详解/</id>
    <published>2018-04-16T00:40:02.000Z</published>
    <updated>2018-04-18T06:03:54.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;MySQL日志&quot;&gt;&lt;a href=&quot;#MySQL日志&quot; class=&quot;headerlink&quot; title=&quot;MySQL日志&quot;&gt;&lt;/a&gt;MySQL日志&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;查询日志&lt;br&gt;这是最不应该记录的日志。因为一个非常繁忙的数据库服务器，其查询会有很多，每一次都记录日志会导致系统性能下降。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;而且还会有额外的空间开销。MySQL默认没有开启这个日志。注意不仅仅是SELECT。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;慢查询日志&lt;br&gt;查询执行时长超过指定时长的查询，即为慢查询。这里的慢不一定是语句自身执行慢，如果一个操作锁定了某张表，尤其是独占锁锁定了这张表，那么其他人对于这张表的查询就阻塞掉了。但不管怎么讲，慢查询日志是我们通常拿来定位系统上查询操作执行速度过慢时常用到的一个评估工具。所以在生产环境中有时是很有必要启用慢查日志的。percona公司在提供的工具perconatools中有专门工具用来分析慢查日志中哪些查询执行时长过长，以及产生的原因有哪些。这是一个应该启用的日志，但是默认没启用。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;错误日志&lt;br&gt;通常情况下记录的不光是错误信息，也包括mysql启动和关闭过程中的信息，以及启动复制线程时的信息。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;中继日志&lt;br&gt;在从服务器上的日志。就是说复制的时候，主服务器任何能够产生数据修改的操作，在写入数据文件的同时，还会把这个语句(也可能是行)记录到二进制日志文件中一份。从服务器就是使用一个用户帐号不断的去连接主服务器，并尝试去读取主服务器上二进制日志中的每一个条目，从服务器将这些挨个的读到从服务器上，在执行之前，先要将这些读到的保存在本地的日志文件中，而后从本地日志文件中读一条执行一条。这个日志文件就叫做中继日志。很显然，中继日志内容应该和二进制日志内容是一样的，为了完成复制，二进制日志不能随便删除，中继日志可以删除，用完后清了。如果发现清错了，可以找个二进制日志复制下就可以了。再想一个问题，从服务器也有二进制日志，每次执行都是从中继日志中读，然后执行，同时还要写入二进制日志，如果要记录二进制日志的话，应该是和主服务器的二进制日志一样的。这种记录是额外的开销，如果其他服务器不把这个从服务器当做主来用，这个二进制日志就没有用了，所以应该关闭掉，以提升性能。另外，从服务器是不能执行额外的任何写操作的，只能从中继日志中读一条写一条。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;事务日志&lt;br&gt;先暂存事务提交的数据，然后在同步到数据文件中。&lt;br&gt;随机I/O转换为顺序I/O。但是即便是顺序I/O，其速度依然有限。把事务日志放在RAID10上，或放在固态硬盘上，或放在PCI-E固态硬盘上，那就体会几乎内存的性能了。&lt;br&gt;如果是支持事务的存储引擎，要满足事务的要求，就必须满足ACID测试，其中有一点很重要就是持久性。事务还要能够回滚。考虑一种场景，我们的事务隔离级别是”读未提交”，两个连接进来了，都在做事务，第一个事务执行的语句，它的事务在提交之前有可能是保存在内存中，有可能是被同步到事务日志中，内存中可能放不下，就放到事务日志中去了。当第二个事务查询时，它的查询应该是来自磁盘上的数据文件，但问题是第一个事务执行的操作还没有同步到磁盘上，那它怎么查到呢？所以要支持事务，背后的工作逻辑是很复杂的，不但要从数据文件中找，还要去找那些有可能潜在修改这个数据文件的数据集，比如内存缓冲区，这个缓冲区我们称为innodb_buffer，还有可能要去查询事务日志。所以事务日志还要支撑读操作。只有完全把buffer和事务日志中的数据全部同步到磁盘的数据文件中去了，从磁盘上读到的数据才是最新的。所以buffer和事务日志中所保存的数据接近于表中所存储的格式的。&lt;br&gt;再考虑一种场景如果我们启动了一个非常大的事务，那么buffer实在缓存不下了，就要先写到事务日志中去了，日志文件至少需要两个，以实现轮替的，两个组成一个日志文件组。第一个日志文件写满了，就去写第二个。日志文件一个5M，可以调整的，但是大多数场景是够用的。第一个日志文件不够用了，写第二个日志文件，然后第一个日志文件中的数据开始往磁盘数据文件同步。即便如此，这个事务只执行了一半或者2/3，过一会，回滚。该怎么回滚？那些写到磁盘数据文件的数据也得删掉。所以回滚也是一个非常复杂的操作。如果说这个回滚的所有数据最多只到事务日志中和最多走到数据文件中，哪种回滚的开销比较小？只是走到事务日志中开销比较小，甚至于还没走到事务日志中，仍然还在innodb_buffer中，回滚的开销会更小，所以我们应该使用小事务。&lt;br&gt;为了保证提交的事务不丢失，其一部分写操作可能在内存中，我们一commit，所有位于内存中的数据有可能会因为断电或系统崩溃而丢失，为了避免这种情况，要立即写到持久存储中去。写到事务日志中。假如一个事务提交了，刚从内存中同步到事务日志中，还没同步到数据文件中，系统崩溃了。下次启动时，这个事务能恢复回来，因为事务日志中有。所以下一次mysql启动时，它必须保证把那些提交的事务从事务文件中同步到数据文件中。而未提交的事务，比如有些事务正在操作，但并未提交，系统崩溃了，这种情况怎么办？因为没有完成，所以之前这个事务的操作全部回滚，这个过程就叫做系统崩溃恢复的过程。把那些提交的事务同步到数据文件中，没提交的事务回滚。而事务性存储引擎的崩溃恢复能力是天生的。&lt;br&gt;如果MySQL崩溃是因为事务日志的磁盘坏了，这种情况下，就不能崩溃恢复了。只能用备份恢复了。所以我们应该让事务日志所在的硬盘足够可靠，RAID10或者RAID1。假如说是因为数据文件崩溃了，一样的场景。你有事务日志，但你数据文件坏了，怎么去写啊。有事务日志并不能恢复数据，&lt;strong&gt;事务日志不是用来恢复数据的，事务日志仅仅是崩溃时能够保证已提交事务不丢失，未提交事务能回滚。&lt;/strong&gt;&lt;br&gt;从性能上来讲，将事务日志和数据文件放在一块是不合理的。从内存到硬盘，I/O，从事务日志到数据文件也要I/O，所有的I/O都压在一块硬盘上去了，导致性能下降。因此，把数据文件放在一个RAID设备上，把事务日志放在一个RAID设备上。考虑独特的场景，我们实在没有RAID设备放事务日志了，那就给事务日志做镜像。如果你实在是没钱，那就找个其他磁盘空间，跟事务日志文件不在同一个磁盘上就行，做一个mirror，任何往第一组事务日志中写的数据会被自动同步到第二组中去的。&lt;br&gt;日志文件组：至少应该有两个日志文件；&lt;br&gt;【注意】：尽可能使用小事务以提升事务引擎的性能；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;二进制日志&lt;br&gt;主要用于MySQL时间点恢复和复制。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;查询日志&quot;&gt;&lt;a href=&quot;#查询日志&quot; class=&quot;headerlink&quot; title=&quot;查询日志&quot;&gt;&lt;/a&gt;查询日志&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;log={ON|OFF}:是否记录所有语句的日志信息于一般查询日志文件(general_log)。MySQL5.6已经弃用此项变量了，都使用general_log。&lt;/li&gt;
&lt;li&gt;log_output={TABLE|FILE|NONE}&lt;ul&gt;
&lt;li&gt;TABLE：记录于表中。MySQL库中会自动生成一个表记录。&lt;/li&gt;
&lt;li&gt;FILE：记录于general_log_file。&lt;/li&gt;
&lt;li&gt;NONE：不记录。&lt;/li&gt;
&lt;li&gt;TABLE和FILE可以同时出现，用逗号分隔即可。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;general_log：是否启用查询日志。由于历史的原因，和log是个冲突的概念。&lt;/li&gt;
&lt;li&gt;general_log_file：定义一般查询日志保存的文件。文件名为：主机名.log，保存路径没说的话保存在数据目录中。所有的相对路径通常都是相对于数据目录而言的。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; SHOW GLOBAL VARIABLES LIKE &amp;quot;%log%&amp;quot;;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/89.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;如果开启查询日志，包括SHOW、SET操作也会被记录，这些操作过程中也需要查询。如果要记录查询日志，记录到数据库中，会比记录到文件中快一点。但是一般是不启用记录查询日志的，除非特殊情况。&lt;/p&gt;
&lt;h2 id=&quot;慢查询日志&quot;&gt;&lt;a href=&quot;#慢查询日志&quot; class=&quot;headerlink&quot; title=&quot;慢查询日志&quot;&gt;&lt;/a&gt;慢查询日志&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;long_query_time： 10.000000&lt;br&gt;执行多长时间的查询算是慢查询&lt;/li&gt;
&lt;li&gt;slow_query_log={ON|OFF}  或者是1 | 0&lt;br&gt;设定是否启用慢查询日志；它的输出位置也取决log_output={TABLE|FILE|NONE}；&lt;/li&gt;
&lt;li&gt;slow_query_log_file=www-slow.log&lt;br&gt;定义日志文件路径及名称；&lt;/li&gt;
&lt;li&gt;log_slow_queries=ON    &lt;/li&gt;
&lt;li&gt;与上面slow_query_log={ON|OFF}好像是重复的，上面那个是全局的，下面这个是用户自己会话的。                                &lt;/li&gt;
&lt;li&gt;log_slow_rate_limit=1     记录慢查询日志的速率。                  &lt;/li&gt;
&lt;li&gt;log_slow_verbosity     是否记录详细的慢查询的详细信息。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; SHOW GLOBAL VARIABLES LIKE &amp;quot;long%&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+-----------------+-----------+&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Variable_name   | Value     |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+-----------------+-----------+&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| long_query_time | 10.000000 |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+-----------------+-----------+&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1 row in set (0.00 sec)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;错误日志&quot;&gt;&lt;a href=&quot;#错误日志&quot; class=&quot;headerlink&quot; title=&quot;错误日志&quot;&gt;&lt;/a&gt;错误日志&lt;/h2&gt;&lt;p&gt;错误日志： 通常是开启的。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;服务器启动和关闭过程中的信息；&lt;/li&gt;
&lt;li&gt;服务器运行过程中的错误信息；&lt;/li&gt;
&lt;li&gt;事件调度器运行一个事件时产生的信息；&lt;/li&gt;
&lt;li&gt;&lt;p&gt;在复制架构中的从服务器上启动从服务器线程时产生的信息。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_error = /path/to/error_log_file&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;log_warnings = {1|0}&lt;br&gt;是否记录警告信息于错误日志中。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; SHOW GLOBAL VARIABLES LIKE &amp;quot;%log%&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| log_error                               | /data/mydata/db.err           |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;二进制日志&quot;&gt;&lt;a href=&quot;#二进制日志&quot; class=&quot;headerlink&quot; title=&quot;二进制日志&quot;&gt;&lt;/a&gt;二进制日志&lt;/h2&gt;&lt;h3 id=&quot;二进制日志介绍&quot;&gt;&lt;a href=&quot;#二进制日志介绍&quot; class=&quot;headerlink&quot; title=&quot;二进制日志介绍&quot;&gt;&lt;/a&gt;二进制日志介绍&lt;/h3&gt;&lt;p&gt;二进制日志：也称为复制日志，记录的是”修改”类信息，记录的是一个个事件。&lt;br&gt;格式也应该是二进制的，不能使用cat命令查看，有专门的工具mysqlbinlog可以查看。&lt;br&gt;二进制日志能够基于过去某个数据集的基础上，把后续的所有操作重新跑一遍，能得到和此前第一次跑时所得到的是一样的结果。日志文件名字以及存放路径都是可以定义的。比如我在安装mysql时将数据文件和二进制日志文件就定义在了不同的目录：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# cd /data/binlog/
[root@db binlog]# ls
master-bin.000001  master-bin.000003  master-bin.000005  master-bin.000007  master-bin.index
master-bin.000002  master-bin.000004  master-bin.000006  master-bin.000008
[root@db binlog]# file master-bin.000001
master-bin.000001: MySQL replication log
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;可以使用工具mysqlbinlog查看二进制日志文件内容：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db binlog]# mysqlbinlog master-bin.000001
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/90.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;这个事件从66773开始到66846结束，66846-66773=中间的信息的偏移量。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;position：位置，空间记录法。空间记录法就是相对于当前日志文件而言它的偏移位置。&lt;/li&gt;
&lt;li&gt;time: 时间点，时间记录法。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;二进制日志文件内容格式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;事件发生的日期和时间&lt;/li&gt;
&lt;li&gt;服务器ID&lt;/li&gt;
&lt;li&gt;事件的结束位置&lt;/li&gt;
&lt;li&gt;事件的类型&lt;/li&gt;
&lt;li&gt;原服务器生成此事件时的线程ID&lt;/li&gt;
&lt;li&gt;语句的时间戳和写入二进制日志文件的时间差。exec_time=0，由于单位是s，所以很多时候是0。&lt;/li&gt;
&lt;li&gt;错误代码；&lt;/li&gt;
&lt;li&gt;事件内容：也就是语句本身。&lt;/li&gt;
&lt;li&gt;事件位置，相当于下一事件的开始位置&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;考虑一种场景：如果说我们有多个进程同时进行，比如处理两个请求的两个线程分别在两颗CPU上跑着，而且修改不是同一张表，这个时候都需要写入二进制日志，但是某个时刻只会往一个二进制日志文件中写，具体哪个见下面的命令。显然，这个文件不能有两个进程同时写，如果交替着写，事件就混到一块了。由于二进制日志成为了资源争用点，有可能会导致性能下降，如果你去设计的话，如何去避免性能下降？缓存，于是每一个线程在写数据时不是直接写文件，而是写在缓冲区中，专业点的说法是，写通常是叫做缓冲。过一段时间，由MySQL服务器后台线程找空闲时间自行往二进制日志文件中同步。但这会带来一个问题，如果说事件写在缓冲区中了，忽然间系统断电了，这些缓冲区的数据还没写到二进制文件中去呢，那么拿来二进制日志执行，数据也不对。虽然没有写到二进制日志文件中去，但是却已经写到本地数据文件中去了。只不过这个有可能产生数据修改的操作还得写到记录到二进制日志中去。将来把这个二进制日志信息复制到从服务器上，重新跑一遍，得到的数据不一样。因此这是不安全的做法。通常效率和安全性通常是两个背离的方向。所以我们要求应该在事务提交时无论如何也应该把二进制日志缓冲区中的信息同步到二进制日志文件中去。&lt;/p&gt;
&lt;p&gt;滚动： 二进制日志文件需要不停的进行滚动，防止文件大小过大。&lt;br&gt;1、大小&lt;br&gt;2、时间&lt;/p&gt;
&lt;p&gt;二进制日志的功用：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;即时点恢复：我们想恢复到哪个位置，可以通过二进制日志文件手动调整进行的。&lt;/li&gt;
&lt;li&gt;复制。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;二进制日志常用命令&quot;&gt;&lt;a href=&quot;#二进制日志常用命令&quot; class=&quot;headerlink&quot; title=&quot;二进制日志常用命令&quot;&gt;&lt;/a&gt;二进制日志常用命令&lt;/h3&gt;&lt;p&gt;1.查看当前服务器所正在使用的二进制日志文件，以及下一个事件要开始时记录的位置&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW MASTER STATUS;
+-------------------+----------+--------------+------------------+-------------------+
| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+-------------------+----------+--------------+------------------+-------------------+
| master-bin.000008 |  5525554 |              |                  |                   |
+-------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;2.每一次重启MySQL服务器或者FLUSH LOGS，日志文件都会滚动。FLUSH LOGS，对错误日志等没有意义，它主要是用来滚动二进制日志和中继日志的。二进制日志不像事务日志ib_logfile0、ib_logfile1，反复被用到。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; FLUSH LOGS;       
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;3.查看有多少二进制日志文件及其大小&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW BINARY LOGS; 
+-------------------+-----------+
| Log_name          | File_size |
+-------------------+-----------+
| master-bin.000001 |     67251 |
| master-bin.000002 |   1361538 |
| master-bin.000003 |  73892389 |
| master-bin.000004 |       120 |
| master-bin.000005 |   5076873 |
| master-bin.000006 |   8200661 |
| master-bin.000007 |  30885330 |
| master-bin.000008 |   5525554 |
+-------------------+-----------+
8 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;我们可以通过删除文件的方式清除二进制日志，注意不到万不得已，千万不要手动删除。而且手动删除也不是通过删除文件删除的，而是通过PURGE命令删除的。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; HELP PURGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name: &amp;apos;PURGE BINARY LOGS&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Description:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Syntax:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;PURGE &amp;#123; BINARY | MASTER &amp;#125; LOGS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123; TO &amp;apos;log_name&amp;apos; | BEFORE datetime_expr &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;The binary log is a set of files that contain information about data&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;modifications made by the MySQL server. The log consists of a set of&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;binary log files, plus an index file (see&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;http://dev.mysql.com/doc/refman/5.6/en/binary-log.html).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;The PURGE BINARY LOGS statement deletes all the binary log files listed&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;in the log index file prior to the specified log file name or date.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;BINARY and MASTER are synonyms. Deleted log files also are removed from&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the list recorded in the index file, so that the given log file becomes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the first in the list.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;This statement has no effect if the server was not started with the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;--log-bin option to enable binary logging.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;URL: http://dev.mysql.com/doc/refman/5.6/en/purge-binary-logs.html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;PURGE BINARY LOGS TO &amp;apos;mysql-bin.010&amp;apos;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;PURGE BINARY LOGS BEFORE &amp;apos;2008-04-02 22:46:26&amp;apos;;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;4.查看事件信息&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; HELP SHOW BINLOG EVENTS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name: &amp;apos;SHOW BINLOG EVENTS&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Description:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Syntax:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;SHOW BINLOG EVENTS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   [IN &amp;apos;log_name&amp;apos;] [FROM pos] [LIMIT [offset,] row_count]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Shows the events in the binary log. If you do not specify &amp;apos;log_name&amp;apos;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the first binary log is displayed.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;URL: http://dev.mysql.com/doc/refman/5.6/en/show-binlog-events.html&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW BINLOG EVENTS IN &amp;apos;master-bin.000001&amp;apos;\G
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/91.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;server-id: 服务器身份标识。MySQL的复制模型可以做的很复杂，服务器之间可以互为主从，也就是说各自是对方的主，又各自是对方的从。也就意味着左边的服务器也会复制右边的服务器的二进制日志，右边的机器是从左边的二进制日志中读取信息到中继日志中，并执行，同时写入自己的二进制日志，那左边从右边的二进制日志拿回来在执行一次，也就重复了。为了避免重复，server-id。左边读回来的信息发现是自己的server-id，就不会执行了。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;或者可以使用mysqlbinlog工具查看事件信息：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# mysqlbinlog      
    --start-time
    --stop-time
    --start-position
    --stop-position
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;考虑一种场景：我们当前执行了INSERT INTO t1 VALUE (CURRENT_DATE())，记录到了二进制日志，但是以后拿这个日志跑一遍，很显然这个函数在那个时刻获得值肯定和现在不一样的。&lt;br&gt;MySQL记录二进制日志的格式的三种方式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;基于语句：statement。像上面那个插入语句，就不能基于语句做了，就得把那个时间记录下来，叫基于行记录。&lt;/li&gt;
&lt;li&gt;基于行：row。但是基于行，每个行都得记录，比如我执行了一条语句UPDATE tb1 SET salary=salary+1000; ，如果公司有2万人，基于行记录得产生很大的数据量，但是基于语句，只需要记录这个语句就行。&lt;/li&gt;
&lt;li&gt;混合模式：mixed。由MySQL自动判断基于哪种方式记录。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;二进制日志相关配置&quot;&gt;&lt;a href=&quot;#二进制日志相关配置&quot; class=&quot;headerlink&quot; title=&quot;二进制日志相关配置&quot;&gt;&lt;/a&gt;二进制日志相关配置&lt;/h3&gt;&lt;p&gt;跟二进制日志相关的服务器参数：&lt;br&gt;&lt;strong&gt;1.log_bin = {ON|OFF},&lt;/strong&gt; 是否开启二进制日志。还可以是个文件路径。同样二进制日志文件也不要和数据文件放在一起。建议在安装好MySQL就配置好二进制日志文件存放路径和没给你做。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# vim /etc/my.cnf
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/92.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.log_bin_trust_function_creators：&lt;/strong&gt;用于控制创建存储函数时如果会导致不完全事件的记录。一般是OFF。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.sql_log_bin = {ON|OFF} &lt;/strong&gt; sql_log_bin 是一个动态变量，修改该变量时，可以只对当前会话生效（Session），也可以是全局的（Global），当全局修改这个变量时，只会对新的会话生效（这意味当对当前会话也不会生效），因此一般全局修改了这个变量后，都要把原来的所有连接 kill 掉。在 mysql 启动时，通过命令行或配置文件决定是否开启 binlog，而 log_bin 这个变量仅仅是报告当前 binlog 系统的状态（打开与否）。若你想要关闭 binlog，你可以通过修改 sql_log_bin 并把原来的连接 kill 掉，也可以修改 log_bin，然后重启 mysql，后者更彻底，缺点就是需要重启。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;4.sync_binlog：&lt;/strong&gt;设定多久同步一次。就是定义多久将缓冲区中的二进制日志信息同步到二进制日志文件中。时间间隔越长，性能就越好，但数据安全性就越差。默认为0，表示不同步，也就是不靠时间来控制。如果你给的是正值，就表示每隔多长时间会同步。事实上如果你的auto_commit=0，意味着每一次事务提交时才会自动同步。虽然这里是二进制日志，和事务没关系，但为了保证事务安全，每一次事务提交时都会同步二进制日志。因此如果auto_commit=1，每个语句执行完都会同步，这是相当的性能低下。sync_binlog和MySQL的性能密切相关，虽然说不至于和事务日志、事务日志的刷写方式影响那么严重，这也是应该引起我们重视的一个服务器参数。=0反而是性能表现比较好的方式。默认情况下auto_commint=1，见下图。建议关闭。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;5.binlog_format = {statement|row|mixed}&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;6.max_binlog_cache_size = &lt;/strong&gt;&lt;br&gt;二进制日志缓冲空间大小，从MySQL5.5.9以后仅用于缓冲事务类的语句。一般不需要调整。如果是非事务类的，比如Aria存储引擎，max_binlog_stmt_cache_size。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;7.max_binlog_stmt_cache_size =&lt;/strong&gt;&lt;br&gt;非事务类的和事务类的共用的空间大小。一般不需要调整。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;8.max_binlog_size = &lt;/strong&gt;&lt;br&gt;二进制日志文件上限。一旦超过这个大小，就自动滚动了。默认单位是bytes。&lt;/p&gt;
&lt;p&gt;建议：切勿将二进制日志与数据文件放在一同设备。MySQL的很多默认设定并不适合生产环境，我们需要调整。&lt;/p&gt;
&lt;p&gt;中继日志：对于非从服务器，其中继日志默认是不启用的。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;relay_log_purge={ON|OFF} 是否自动清理 不再需要的中继日志。
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;总结日志相关的服务器参数&quot;&gt;&lt;a href=&quot;#总结日志相关的服务器参数&quot; class=&quot;headerlink&quot; title=&quot;总结日志相关的服务器参数&quot;&gt;&lt;/a&gt;总结日志相关的服务器参数&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;expire_logs_days={0..99}&lt;br&gt;设定二进制日志的过期天数，超出此天数的二进制日志文件将被自动删除。默认为0，表示不启用过期自动删除功能。如果启用此功能，自动删除工作通常发生在MySQL启动时或FLUSH日志时。作用范围为全局，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;general_log={ON|OFF}&lt;br&gt;设定是否启用查询日志，默认值为取决于在启动mysqld时是否使用了–general_log选项。如若启用此项，其输出位置则由–log_output选项进行定义，如果log_output的值设定为NONE，即使用启用查询日志，其也不会记录任何日志信息。作用范围为全局，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;general_log_file=FILE_NAME&lt;br&gt;查询日志的日志文件名称，默认为“hostname.log”。作用范围为全局，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;binlog-format={ROW|STATEMENT|MIXED}&lt;br&gt;指定二进制日志的类型，默认为STATEMENT。如果设定了二进制日志的格式，却没有启用二进制日志，则MySQL启动时会产生警告日志信息并记录于错误日志中。作用范围为全局或会话，可用于配置文件，且属于动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log={YES|NO}&lt;br&gt;是否启用记录所有语句的日志信息于一般查询日志(general query log)中，默认通常为OFF。MySQL 5.6已经弃用此选项。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log-bin={YES|NO}&lt;br&gt;是否启用二进制日志，如果为mysqld设定了–log-bin选项，则其值为ON，否则则为OFF。其仅用于显示是否启用了二进制日志，并不反应log-bin的设定值。作用范围为全局级别，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_bin_trust_function_creators={TRUE|FALSE}&lt;br&gt;此参数仅在启用二进制日志时有效，用于控制创建存储函数时如果会导致不安全的事件记录二进制日志条件下是否禁止创建存储函数。默认值为0，表示除非用户除了CREATE ROUTING或ALTER ROUTINE权限外还有SUPER权限，否则将禁止创建或修改存储函数，同时，还要求在创建函数时必需为之使用DETERMINISTIC属性，再不然就是附带READS SQL DATA或NO SQL属性。设置其值为1时则不启用这些限制。作用范围为全局级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_error=/PATH/TO/ERROR_LOG_FILENAME&lt;br&gt;定义错误日志文件。作用范围为全局或会话级别，可用于配置文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_output={TABLE|FILE|NONE}&lt;br&gt;定义一般查询日志和慢查询日志的保存方式，可以是TABLE、FILE、NONE，也可以是TABLE及FILE的组合(用逗号隔开)，默认为TABLE。如果组合中出现了NONE，那么其它设定都将失效，同时，无论是否启用日志功能，也不会记录任何相关的日志信息。作用范围为全局级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_query_not_using_indexes={ON|OFF}&lt;br&gt;设定是否将没有使用索引的查询操作记录到慢查询日志。作用范围为全局级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_slave_updates&lt;br&gt;用于设定复制场景中的从服务器是否将从主服务器收到的更新操作记录进本机的二进制日志中。本参数设定的生效需要在从服务器上启用二进制日志功能。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_slow_queries={YES|NO}&lt;br&gt;是否记录慢查询日志。慢查询是指查询的执行时间超出long_query_time参数所设定时长的事件。MySQL 5.6将此参数修改为了slow_query_log。作用范围为全局级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_warnings=#&lt;br&gt;设定是否将警告信息记录进错误日志。默认设定为1，表示启用；可以将其设置为0以禁用；而其值为大于1的数值时表示将新发起连接时产生的“失败的连接”和“拒绝访问”类的错误信息也记录进错误日志。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;long_query_time=#&lt;br&gt;设定区别慢查询与一般查询的语句执行时间长度。这里的语句执行时长为实际的执行时间，而非在CPU上的执行时长，因此，负载较重的服务器上更容易产生慢查询。其最小值为0，默认值为10，单位是秒钟。它也支持毫秒级的解析度。作用范围为全局或会话级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;max_binlog_cache_size{4096 .. 18446744073709547520}&lt;br&gt;二进定日志缓存空间大小，5.5.9及以后的版本仅应用于事务缓存，其上限由max_binlog_stmt_cache_size决定。作用范围为全局级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;max_binlog_size={4096 .. 1073741824}&lt;br&gt;设定二进制日志文件上限，单位为字节，最小值为4K，最大值为1G，默认为1G。某事务所产生的日志信息只能写入一个二进制日志文件，因此，实际上的二进制日志文件可能大于这个指定的上限。作用范围为全局级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;max_relay_log_size={4096..1073741824}&lt;br&gt;设定从服务器上中继日志的体积上限，到达此限度时其会自动进行中继日志滚动。此参数值为0时，mysqld将使用max_binlog_size参数同时为二进制日志和中继日志设定日志文件体积上限。作用范围为全局级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;innodb_log_buffer_size={262144 .. 4294967295}&lt;br&gt;设定InnoDB用于辅助完成日志文件写操作的日志缓冲区大小，单位是字节，默认为8MB。较大的事务可以借助于更大的日志缓冲区来避免在事务完成之前将日志缓冲区的数据写入日志文件，以减少I/O操作进而提升系统性能。因此，在有着较大事务的应用场景中，建议为此变量设定一个更大的值。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;innodb_log_file_size={108576 .. 4294967295}&lt;br&gt;设定日志组中每个日志文件的大小，单位是字节，默认值是5MB。较为明智的取值范围是从1MB到缓存池体积的1/n，其中n表示日志组中日志文件的个数。日志文件越大，在缓存池中需要执行的检查点刷写操作就越少，这意味着所需的I/O操作也就越少，然而这也会导致较慢的故障恢复速度。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;innodb_log_files_in_group={2 .. 100}&lt;br&gt;设定日志组中日志文件的个数。InnoDB以循环的方式使用这些日志文件。默认值为2。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;innodb_log_group_home_dir=/PATH/TO/DIR&lt;br&gt;设定InnoDB重做日志文件的存储目录。在缺省使用InnoDB日志相关的所有变量时，其默认会在数据目录中创建两个大小为5MB的名为ib_logfile0和ib_logfile1的日志文件。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;relay_log=file_name&lt;br&gt;设定中继日志的文件名称，默认为host_name-relay-bin。也可以使用绝对路径，以指定非数据目录来存储中继日志。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;relay_log_index=file_name&lt;br&gt;设定中继日志的索引文件名，默认为为数据目录中的host_name-relay-bin.index。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;relay-log-info-file=file_name&lt;br&gt;设定中继服务用于记录中继信息的文件，默认为数据目录中的relay-log.info。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;relay_log_purge={ON|OFF}&lt;br&gt;设定对不再需要的中继日志是否自动进行清理。默认值为ON。作用范围为全局级别，可用于选项文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;relay_log_space_limit=#&lt;br&gt;设定用于存储所有中继日志文件的可用空间大小。默认为0，表示不限定。最大值取决于系统平台位数。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;slow_query_log={ON|OFF}&lt;br&gt;设定是否启用慢查询日志。0或OFF表示禁用，1或ON表示启用。日志信息的输出位置取决于log_output变量的定义，如果其值为NONE，则即便slow_query_log为ON，也不会记录任何慢查询信息。作用范围为全局级别，可用于选项文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;slow_query_log_file=/PATH/TO/SOMEFILE&lt;br&gt;设定慢查询日志文件的名称。默认为hostname-slow.log，但可以通过–slow_query_log_file选项修改。作用范围为全局级别，可用于选项文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;sql_log_bin={ON|OFF}&lt;br&gt;用于控制二进制日志信息是否记录进日志文件。默认为ON，表示启用记录功能。用户可以在会话级别修改此变量的值，但其必须具有SUPER权限。作用范围为全局和会话级别，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;sql_log_off={ON|OFF}&lt;br&gt;用于控制是否禁止将一般查询日志类信息记录进查询日志文件。默认为OFF，表示不禁止记录功能。用户可以在会话级别修改此变量的值，但其必须具有SUPER权限。作用范围为全局和会话级别，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;sync_binlog=#&lt;br&gt;设定多久同步一次二进制日志至磁盘文件中，0表示不同步，任何正数值都表示对二进制每多少次写操作之后同步一次。当autocommit的值为1时，每条语句的执行都会引起二进制日志同步，否则，每个事务的提交会引起二进制日志同步。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;MySQL日志&quot;&gt;&lt;a href=&quot;#MySQL日志&quot; class=&quot;headerlink&quot; title=&quot;MySQL日志&quot;&gt;&lt;/a&gt;MySQL日志&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;查询日志&lt;br&gt;这是最不应该记录的日志。因为一个非常繁忙的数据库服务器，其查询会有很多，每一次都记录日志会导致系统性能下降。
    
    </summary>
    
      <category term="MySQL" scheme="http://yoursite.com/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="http://yoursite.com/tags/MySQL/"/>
    
  </entry>
  
</feed>
