<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>jkzhao&#39;s blog</title>
  <subtitle>学习 总结 思考</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2019-07-31T06:00:16.000Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Zhao Jiankai</name>
    <email>jk.zhaocoder@gmail.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>kubernetes基础概念</title>
    <link href="http://yoursite.com/2019/07/31/kubernetes%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/"/>
    <id>http://yoursite.com/2019/07/31/kubernetes基础概念/</id>
    <published>2019-07-31T03:38:21.000Z</published>
    <updated>2019-07-31T06:00:16.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;pod分类&quot;&gt;&lt;a href=&quot;#pod分类&quot; class=&quot;headerlink&quot; title=&quot;pod分类&quot;&gt;&lt;/a&gt;pod分类&lt;/h2&gt;&lt;h3 id=&quot;自主式Pod&quot;&gt;&lt;a href=&quot;#自主式Pod&quot; class=&quot;headerlink&quot; title=&quot;自主式Pod&quot;&gt;&lt;/a&gt;自主式Pod&lt;/h3&gt;&lt;p&gt;自我管理。scheduler调度到某台node，pod启动后，如果有容器出现故障，需要重启容器，是由k8s来完成的。但是如果节点故障了，pod就消失了，没法进行全局调度。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;控制器管理端的Pod&quot;&gt;&lt;a href=&quot;#控制器管理端的Pod&quot; class=&quot;headerlink&quot; title=&quot;控制器管理端的Pod&quot;&gt;&lt;/a&gt;控制器管理端的Pod&lt;/h3&gt;&lt;p&gt;Pod控制器，有很多种。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ReplicationController：最早的一种，早期只有这一个控制器。比如启动一个Nginx pod，控制器控制了pod副本，一旦副本数量少了，立马补齐。多了就终止掉多余的Pod。ReplicationController支持滚动更新，比如一开始pod里的容器基于1.0版本的镜像启的，但是现在有新版本了，1.1版本的镜像，可以滚动更新。&lt;/li&gt;
&lt;li&gt;ReplicaSet：副本集控制器。但是ReplicaSet不直接使用，它有个申明是更新的控制器Deployment。&lt;/li&gt;
&lt;li&gt;Deployment：只能管理那些无状态的应用。&lt;/li&gt;
&lt;li&gt;StatefulSet：有状态副本集，管理有状态应用。&lt;/li&gt;
&lt;li&gt;DaemonSet：如果我们需要在每一个node上运行一个副本，而不是随意运行。&lt;/li&gt;
&lt;li&gt;Job，CronJob：作业，周期性作业。Job：比如备份操作，或者一些临时操作，比如现在要处理数据集，临时启用一个pod，清理完数据这个Pod就结束了。这种不需要一直运行着。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在k8s上创建Pod，只需要定义控制器，控制器创建好就会帮我们创建Pod。&lt;br&gt;Deployment控制器还支持二级控制器，叫HPA，称为水平Pod自动升缩控制器。比如一开始运行着两个pod，但是某个时间段用户访问增加，需要增加pod。到底应该加几个呢？HPA控制可以自动进行扩展。比如：判断一下，现在的CPU、内存资源利用率有多高，我们必须要确保平均低于60%，计算后发现需要加两个，那么HPA就扩展了两个。一旦访问量小了，还可以自动减，当然Deployment可以确保至少有几个存在。&lt;/p&gt;
&lt;h2 id=&quot;Service&quot;&gt;&lt;a href=&quot;#Service&quot; class=&quot;headerlink&quot; title=&quot;Service&quot;&gt;&lt;/a&gt;Service&lt;/h2&gt;&lt;p&gt;Pod有生命周期，万一Pod所在的节点宕机了，Pod有可能需要在其他节点上重建的，而重建完的Pod和之前的Pod不是同一个，只不过里面运行的是同一种服务。而且每一个容器都有ip地址，新Pod中的容器的ip地址可能和之前损坏的Pod中容器的ip地址也是不一样的。这样一来就有问题了，客户端怎么访问这些Pod呢？服务发现。客户端在访问后端服务时，应该不是直接访问后端服务的，这就需要服务发现机制了。&lt;br&gt;为了尽可能降低二者之间协调的复杂度，k8s为每一组提供同类服务的Pod和它的客户端之间添加了一个中间层，这个中间层是固定的，就叫service。service只要不删除，它的地址就是固定的，名称也是固定的。而后当客户端需要写在配置文件中访问某个服务时，它也不用再去自动发现某个功能，它只需要在配置文件中写明service地址或者名称就行。这个Service是一个调度器，不但能提供一个稳定的访问入口，还能将客户端带领到对应的Pod之上。一旦Pod因为什么原因消失了，新创建的Pod会立即被service关联进来，怎么实现这个关联的呢？客户端访问服务都是靠ip:port或者主机名:port来访问，service关联后端的pod不是靠IP地址来实现的，而是靠Pod上的元数据Label，标签。service靠&lt;strong&gt;标签选择器&lt;/strong&gt;来关联Pod。关联进来后，service在动态探测这个新Pod的ip地址是什么，端口是什么，并作为自己调度的后端服务器的可用对象。&lt;br&gt;在k8s上，service不是应用程序，也不是实体组件，它只不过是iptables的DNAT规则。我们在创建DNAT规则时，所有到达某地址的都通通被目标地址转换成某某某地址。DNAT规则只是规则，其中的service地址并没有配置到任何一张网卡上，是不存在的，它仅仅出现在规则里，所以service的IP是ping不通的。但是的确可以请求作为服务端。能ping通是因为有TCP/IP协议栈支持这个IP地址，所以它能够在协议栈上进行响应，而这里是没有的，地址仅出现在规则里。&lt;br&gt;service作为k8s中对象来讲，service有自己的名称，相当于这个服务的名称，而名称可以被解析。你可以把service名称解析成service的IP。名称解析得靠dns来实现，装完k8s集群，第一件事就是在k8s集群上部署一个dns pod，以确保各service名称能被解析。像这种Pod是k8s自身服务就需要的Pod，所以称为基础性的Pod，而且也称为集群的附件(附加组件)，Add-ons。可有可无，不作为程序本身的一部分组成。&lt;br&gt;k8s的附件有很多，dns只是其中一个。而且这个dns会动态改变，动态创建，动态删除，动态变动。怎么变动呢？比如说你把service的名称改一改，这会自动触发dns解析记录中对应的名称也改了。还有其他附件，比如监控，promethesure和grafana。&lt;br&gt;service后端可能是多个Pod，DNAT多目标要注意，对Linux来讲，iptables已经将负载均衡的功能主要交由ipvs来实现，因此如果后端是多个Pod时，使用DNAT来实现，在调度效果上可能不太尽如人意。因此在目前最新的1.11版本上，已经把iptables规则进一步改成了ipvs规则。也就意味着当你生成每一个service，就相当于一条ipvs规则，只不过是NAT模型的ipvs。因此支持用户指定的各种调度算法。service的地址是在iptables或ipvs规则中。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/38.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;k8s三种网络&quot;&gt;&lt;a href=&quot;#k8s三种网络&quot; class=&quot;headerlink&quot; title=&quot;k8s三种网络&quot;&gt;&lt;/a&gt;k8s三种网络&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/40.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;第一个网络：Pod网络。&lt;/strong&gt;各Pod运行在一个网络中。Pod地址是配置在Pod内部网络名称空间之上的，是可以ping通的。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;第二个网络：集群网络。&lt;/strong&gt;各service运行在一个网络中。service地址是虚拟的，是假的，只存在于iptables或ipvs的规则当中&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;第三个网络：节点网络。&lt;/strong&gt;各节点运行在一个网络中。节点网络在构建k8s之前就设置好了&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;外部访问时先到达节点网络，由节点网络代理至集群网络，在由集群网络代理至Pod网络。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/39.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;k8s三类通信&quot;&gt;&lt;a href=&quot;#k8s三类通信&quot; class=&quot;headerlink&quot; title=&quot;k8s三类通信&quot;&gt;&lt;/a&gt;k8s三类通信&lt;/h2&gt;&lt;h3 id=&quot;一个Pod内的多个容器通信&quot;&gt;&lt;a href=&quot;#一个Pod内的多个容器通信&quot; class=&quot;headerlink&quot; title=&quot;一个Pod内的多个容器通信&quot;&gt;&lt;/a&gt;一个Pod内的多个容器通信&lt;/h3&gt;&lt;p&gt;lo，本地通信。&lt;/p&gt;
&lt;p&gt;###各Pod间通信&lt;br&gt;无论两个Pod运行在一个节点上还是两个节点上，两个Pod之间的地址不会冲突，大家在同一个网段，而且可以直接通信。是通过物理桥通信或者Overay Network方案(叠加网络)。叠加网络是通过隧道的方式来转发二层报文，使得两个不同节点上的Pod，虽然跨主机，但好像工作在同一个二层网络中一样。叠加器有二层叠加，也有三层叠加。我们可以转发对方的二层报文，或隧道转发对方的三层报文，从而实现叠加网络。使用叠加网络解决docker容器跨主机容器通信，设置每台服务器使用docker0网络要不一样，比如第一台设为172.17.0.xxx，第二台使用172.17.1.xxx，这样所有容器地址都不会冲突，然后通过隧道转发以后，可以直接通信，就相当于在同一个二层网络中一样。云计算中理解最难之一就在网络上。&lt;/p&gt;
&lt;h3 id=&quot;Pod和service之间的通信&quot;&gt;&lt;a href=&quot;#Pod和service之间的通信&quot; class=&quot;headerlink&quot; title=&quot;Pod和service之间的通信&quot;&gt;&lt;/a&gt;Pod和service之间的通信&lt;/h3&gt;&lt;p&gt;两者都在各自的网络中，不是同一个网络，怎么通信？service地址只不过是节点主机中iptables或ipvs中的规则中的地址，所以只需要把容器中报文地址指向网关，网关假如是docker0桥，iptables在当前宿主机上就有规则，当容器需要访问service地址时，会把报文给网关，一般是docker0桥的地址，docker0桥收到以后，通过iptables或ipvs规则表一检查，就知道在哪了。但是service也是有可能变化的，比如被删除，被修改，这时候是如何触发修改iptables或ipvs规则的呢？在每个node上有一个守护进程，叫kube-proxy。负责随时与API server通信，Pod变化后是需要保存在API server中的。API server会生成一个通知事件，这个事件可以被任何关联的组件所接收到，一旦发现某个service背后的pod发生改变，对应的由kube-proxy将变化反应在iptables或ipvs的规则中。service的管理是由kube-proxy实现的。每一个service变动也要靠kube-proxy反应到规则上。&lt;/p&gt;
&lt;h2 id=&quot;etcd和证书&quot;&gt;&lt;a href=&quot;#etcd和证书&quot; class=&quot;headerlink&quot; title=&quot;etcd和证书&quot;&gt;&lt;/a&gt;etcd和证书&lt;/h2&gt;&lt;p&gt;API Server要存储大量的信息，如果某个master挂了，则需要切换到另外一台master，那么master之间需要共享存储，也就是etcd。&lt;br&gt;etcd是键值存储的数据库系统，跟redis很相像。但是etcd本身有很多协调功能是redis不具备的。更像zk。如果etcd宕机了，整个集群就完了。所以etcd要做成至少3节点。etcd本身也是restful风格的集群，也就是通过http/https通讯。如果是http通信，数据就有可能被拿走，所以要配置成https通信。&lt;br&gt;etcd一个端口用于集群通讯，一个端口用于像客户端提供服务。其内部通讯需要一个专门的证书，叫点对点通信的证书。而后像客户端提供服务的时候，如果需要https，得靠另外一套证书。同样的道理，k8s的apiserver，http不可靠，加密https，另外一套证书，因为这套证书是服务于k8s的客户端与服务端之间通信。而且最好不要与etcd属于同一个CA来签署。还有apiserver对外提供服务，一套证书。apiserver与kube-proxy通讯，一套证书。apiserver与kubelet通信，一套证书。一共5个CA，5套证书，为了足够安全。不光是加密，还有认证，所以CA也得是不同的，签证机构得不同。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/40.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;CNI&quot;&gt;&lt;a href=&quot;#CNI&quot; class=&quot;headerlink&quot; title=&quot;CNI&quot;&gt;&lt;/a&gt;CNI&lt;/h2&gt;&lt;p&gt;k8s通过CNI插件体系来接入外部的网络服务解决方案，所以叫容器网络接口。只要网络服务提供商，能遵循CNI开发这个服务，那么这个网络服务商就可以作为k8s的网络解决方案来使用。这些网络解决方案可以以附件的形式托管在集群之上。常见的网络解决方案如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;flannel：网络配置，不支持网络策略，纯粹的叠加网络 &lt;/li&gt;
&lt;li&gt;calico：网络配置，同时支持网络策略。但是这个部署和使用比较难，能基于bgp协议实现。。。&lt;/li&gt;
&lt;li&gt;canel：用第一种方式提供网络，用第二个提供网络策略&lt;/li&gt;
&lt;li&gt;…&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以上解决方案都是第三方公司提供的，这些可以作为附件来运行，也可以作为节点上守护进程来运行。&lt;br&gt;在容器网络的构建中，CNI和kube-proxy两者都有参与。CNI插件的任务是在容器开启时为容器分配IP，并为这个IP构建虚拟设备，另外，CNI插件也负责将容器间通信的协议包（如TCP/UDP等）从K8s集群中的任意一台机器转发到指定容器所在的机器上，再转发到指定容器上。&lt;/p&gt;
&lt;h2 id=&quot;k8s的名称空间&quot;&gt;&lt;a href=&quot;#k8s的名称空间&quot; class=&quot;headerlink&quot; title=&quot;k8s的名称空间&quot;&gt;&lt;/a&gt;k8s的名称空间&lt;/h2&gt;&lt;p&gt;这个名称空间和docker里所用到的名称空间的不一样。&lt;br&gt;整个k8s是作为一个集群存在的，我们可以在里面运行两万个pod，可能会互相干扰。可以把它切割成多个空间，一类pod只运行在一个空间中，这个空间提供的不是真正意义上的网络边界，只是管理边界。比如说第一个空间叫开发空间，所有开发相关的pod都放在这个空间中，第二个是生产环境，所有生产环境的pod都放到这个空间里。将来我们删除这个网络名称空间，可以把这个环境通通移除掉。所以这个名称空间给我们提供了管理的边界。但是第一个名称空间里的pod访问第二个名称空间的pod是没有问题的，所以CNI实现还要支持网络策略定义，可以定义名称空间和名称空间之间，甚至同一个名称空间里的各pod之间能不能互相访问。可以生成iptables规则来隔离他们之间的访问。&lt;br&gt;对k8s来讲&lt;strong&gt;网络功能&lt;/strong&gt;和&lt;strong&gt;网络策略&lt;/strong&gt;是两个维度的内容，flannel只实现网络功能配置。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;pod分类&quot;&gt;&lt;a href=&quot;#pod分类&quot; class=&quot;headerlink&quot; title=&quot;pod分类&quot;&gt;&lt;/a&gt;pod分类&lt;/h2&gt;&lt;h3 id=&quot;自主式Pod&quot;&gt;&lt;a href=&quot;#自主式Pod&quot; class=&quot;headerlink&quot; title=&quot;自主式Pod&quot;&gt;&lt;/a&gt;自主式Pod&lt;/h3&gt;&lt;p&gt;自我管理。scheduler调度到某台node，pod启动后，如果有容器出现故障，需要重启容器，是由k8s来完成的。但是如果节点故障了，pod就消失了，没法进行全局调度。&lt;br&gt;
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Java调用Python脚本</title>
    <link href="http://yoursite.com/2019/05/23/Java%E8%B0%83%E7%94%A8Python%E8%84%9A%E6%9C%AC/"/>
    <id>http://yoursite.com/2019/05/23/Java调用Python脚本/</id>
    <published>2019-05-23T01:44:38.000Z</published>
    <updated>2019-05-23T07:19:56.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;环境和问题&quot;&gt;&lt;a href=&quot;#环境和问题&quot; class=&quot;headerlink&quot; title=&quot;环境和问题&quot;&gt;&lt;/a&gt;环境和问题&lt;/h2&gt;&lt;p&gt;Maven依赖：&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;dependency&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;lt;groupId&amp;gt;org.python&amp;lt;/groupId&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;lt;artifactId&amp;gt;jython-standalone&amp;lt;/artifactId&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;lt;version&amp;gt;2.7.1&amp;lt;/version&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/dependency&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Java代码：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;public class InterpreterExample &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    PythonInterpreter interpreter = null;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    public InterpreterExample()&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        PythonInterpreter.initialize(System.getProperties(),&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                System.getProperties(), new String[0]);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        this.interpreter = new PythonInterpreter();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    void execfile( final String fileName )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        this.interpreter.execfile(fileName);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    PyInstance createClass( final String className, final String opts )&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        return (PyInstance) this.interpreter.eval(className + &amp;quot;(&amp;quot; + opts + &amp;quot;)&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    public static void main(String[] args)&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        //PySystemState sys = Py.getSystemState();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        //sys.path.add(&amp;quot;/Library/Python/2.7/site-packages&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        InterpreterExample ie = new InterpreterExample();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ie.execfile(&amp;quot;./pythonSrc/environment.py&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        PyInstance env = ie.createClass(&amp;quot;Environment&amp;quot;, &amp;quot;None&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        env.invoke(&amp;quot;get_os_version&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;问题：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Python/1.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;原因：&lt;a href=&quot;https://stackoverflow.com/questions/9100909/using-multiprocessing-2-6-2-1-package-in-jython&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://stackoverflow.com/questions/9100909/using-multiprocessing-2-6-2-1-package-in-jython&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;You can&amp;apos;t use it if multiprocessing requires C extensions i.e., if you can&amp;apos;t disable them and the module was not reimplemented for Jython in Java/pure Python. multiprocessing module is included in the stdlib since Python 2.6. Current Jython supports Python 2.5.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;There is no GIL in Jython so you can use threading in many cases where you would use multiprocessing in CPython.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此外Jython还有其他问题：&lt;br&gt;Python执行时的sys.path和Jython的sys.path路径不一致。两者加载类库的路径不一样。&lt;br&gt;代码：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;import org.python.util.PythonInterpreter;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;public class HelloPython &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    public static void main(String[] args) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        PySystemState sys = Py.getSystemState();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        interpreter.execfile(&amp;quot;./pythonSrc/test_sys.py&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;test_sys.py代码：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;import sys&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;print(sys.path)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;打印出来的是：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[&amp;apos;/Users/jkzhao/Documents/work/repository/org/python/jython-standalone/2.7.1/Lib&amp;apos;, &amp;apos;/Users/jkzhao/Documents/work/repository/org/python/jython-standalone/2.7.1/jython-standalone-2.7.1.jar/Lib&amp;apos;, &amp;apos;__classpath__&amp;apos;, &amp;apos;__pyclasspath__/&amp;apos;]&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;直接执行test_sys.py打印sys.path:&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[&amp;apos;/Users/jkzhao/Documents/study/Java/IDEAProjects/call&amp;apos;, &amp;apos;/Library/Python/2.7/site-packages/pip-7.1.0-py2.7.egg&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python27.zip&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/plat-darwin&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/plat-mac&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/plat-mac/lib-scriptpackages&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/Extras/lib/python&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/lib-tk&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/lib-old&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/lib-dynload&amp;apos;, &amp;apos;/System/Library/Frameworks/Python.framework/Versions/2.7/Extras/lib/python/PyObjC&amp;apos;, &amp;apos;/Library/Python/2.7/site-packages&amp;apos;]&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;常见的java调用python脚本方式&quot;&gt;&lt;a href=&quot;#常见的java调用python脚本方式&quot; class=&quot;headerlink&quot; title=&quot;常见的java调用python脚本方式&quot;&gt;&lt;/a&gt;常见的java调用python脚本方式&lt;/h2&gt;&lt;p&gt;1.通过Jython.jar提供的类库实现：上面使用的就是这种方式&lt;br&gt;2.通过Runtime.getRuntime()开启进程来执行脚本文件&lt;br&gt;介绍下第2种方式：&lt;br&gt;代码：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;public class Cmd &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    public static void main(String[] args) throws IOException, InterruptedException &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        try &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            // using the Runtime exec method:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            String[] arguments = new String[] &amp;#123; &amp;quot;python&amp;quot;, &amp;quot;./pythonSrc/environment.py&amp;quot; &amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            Process p = Runtime.getRuntime().exec(arguments);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            BufferedReader stdInput = new BufferedReader(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    new InputStreamReader(p.getInputStream()));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            BufferedReader stdError = new BufferedReader(new&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    InputStreamReader(p.getErrorStream()));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            // read the output from the command&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            System.out.println(&amp;quot;Here is the standard output of the command:\n&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            String line = null;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            while ((line = stdInput.readLine()) != null) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                System.out.println(line);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            // read any errors from the attempted command&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            System.out.println(&amp;quot;\nHere is the standard error of the command (if any):\n&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            String errline = null;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            while ((errline = stdError.readLine()) != null) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                System.out.println(errline);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            stdInput.close();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            stdError.close();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            int ret = p.waitFor();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            System.out.println(&amp;quot;Process exit code: &amp;quot; + ret);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            if (ret != 0) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                System.out.println(&amp;quot;do something&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;//            System.exit(0);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; catch (Exception e) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            System.out.println(&amp;quot;exception happened - here&amp;apos;s what I know: &amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            e.printStackTrace();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            System.exit(-1);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        System.out.println(&amp;quot;=============&amp;quot;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这样就正常执行了。&lt;br&gt;【注意】：&lt;br&gt;Runtime.exec方法将产生一个本地的进程，并返回一个Process子类的实例,该实例可用于控制进程或取得进程的相关信息。由于调用Runtime.exec方法所创建的子进程没有自己的终端或控制台，因此该子进程的标准IO(如stdin,stdou,stderr)都通过 p.getOutputStream(), p.getInputStream(), p.getErrorStream() 方法重定向给它的父进程了。用户需要用这些stream来向子进程输入数据或获取子进程的输出。&lt;br&gt;但是向标准输出流和标准错误流写数据，而JVM却不读取，数据会暂存在linux缓存区，当缓存区存满之后导致该进程无法继续写数据，会僵死，导致java进程会卡死在waitFor()处。我这里采取的办法是：java进程在waitFor()前不断读取标准输出流和标准错误流。&lt;/p&gt;
&lt;p&gt;参考资料：&lt;br&gt;&lt;a href=&quot;http://alvinalexander.com/java/edu/pj/pj010016&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Running system commands in Java applications&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://www.cnblogs.com/yueshutong/p/9381570.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;用Java执行Python：Jython踩坑笔记&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://yangfangs.github.io/2016/03/16/java-waitfor-block-deadlock/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Java 调用外部命令使用 waitFor() 方法阻塞或锁死&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://blog.csdn.net/caohaicheng/article/details/22928297&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Java执行shell遇到的各种问题&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;环境和问题&quot;&gt;&lt;a href=&quot;#环境和问题&quot; class=&quot;headerlink&quot; title=&quot;环境和问题&quot;&gt;&lt;/a&gt;环境和问题&lt;/h2&gt;&lt;p&gt;Maven依赖：
    
    </summary>
    
    
      <category term="Java" scheme="http://yoursite.com/tags/Java/"/>
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins与sonar集成</title>
    <link href="http://yoursite.com/2019/04/26/Jenkins%E4%B8%8Esonar%E9%9B%86%E6%88%90/"/>
    <id>http://yoursite.com/2019/04/26/Jenkins与sonar集成/</id>
    <published>2019-04-26T12:41:44.000Z</published>
    <updated>2019-04-30T07:29:38.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;部门领导要求扫描代码质量，我们平时是用jenkins来做持续集成和持续发布的，所以就将jenkins和sonar做了集成，在编译完成后sonar自动扫描代码，然后在进行发布。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;sonar简介&quot;&gt;&lt;a href=&quot;#sonar简介&quot; class=&quot;headerlink&quot; title=&quot;sonar简介&quot;&gt;&lt;/a&gt;sonar简介&lt;/h2&gt;&lt;p&gt;SonarQube 是一个开源的代码分析平台, 用来持续分析和评测项目源代码的质量。 通过SonarQube我们可以检测出项目中重复代码，潜在bug，代码风格问题，缺乏单元测试等问题， 并通过一个web ui展示出来。&lt;br&gt;这里摆一张从网上搜到的图：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/11.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;安装配置sonar&quot;&gt;&lt;a href=&quot;#安装配置sonar&quot; class=&quot;headerlink&quot; title=&quot;安装配置sonar&quot;&gt;&lt;/a&gt;安装配置sonar&lt;/h2&gt;&lt;h3 id=&quot;新建普通用户sonar&quot;&gt;&lt;a href=&quot;#新建普通用户sonar&quot; class=&quot;headerlink&quot; title=&quot;新建普通用户sonar&quot;&gt;&lt;/a&gt;新建普通用户sonar&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# useradd sonar&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# passwd sonar&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;输入两次密码&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;下载sonar&quot;&gt;&lt;a href=&quot;#下载sonar&quot; class=&quot;headerlink&quot; title=&quot;下载sonar&quot;&gt;&lt;/a&gt;下载sonar&lt;/h3&gt;&lt;p&gt;下载地址：&lt;a href=&quot;https://www.sonarqube.org/downloads/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.sonarqube.org/downloads/&lt;/a&gt;&lt;br&gt;我这里下载的是长期支持版6.7.7。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# su - sonar&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# wget https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-6.7.7.zip&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# unzip -oq sonarqube-6.7.7.zip&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;MySQL中新建sonar数据库&quot;&gt;&lt;a href=&quot;#MySQL中新建sonar数据库&quot; class=&quot;headerlink&quot; title=&quot;MySQL中新建sonar数据库&quot;&gt;&lt;/a&gt;MySQL中新建sonar数据库&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# mysql -uroot -p&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; create database sonar default charset utf8;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; grant all on sonar.* to sonar@localhost identified by &amp;apos;sonar&amp;apos;;mysql&amp;gt; grant all on sonar.* to zabbix@&amp;apos;%.%.%.%&amp;apos; identified by &amp;apos;sonar&amp;apos;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; flush privileges;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;修改sonar-properties文件&quot;&gt;&lt;a href=&quot;#修改sonar-properties文件&quot; class=&quot;headerlink&quot; title=&quot;修改sonar.properties文件&quot;&gt;&lt;/a&gt;修改sonar.properties文件&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[sonar@res ~]$ cd sonarqube-6.7.7/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[sonar@res sonarqube-6.7.7]$ ls&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;bin  conf  COPYING  data  elasticsearch  extensions  lib  logs  temp  web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[sonar@res sonarqube-6.7.7]$ vim conf/sonar.properties&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/12.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;启动-停止sonar&quot;&gt;&lt;a href=&quot;#启动-停止sonar&quot; class=&quot;headerlink&quot; title=&quot;启动/停止sonar&quot;&gt;&lt;/a&gt;启动/停止sonar&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[sonar@res sonarqube-6.7.7]$ bin/linux-x86-64/sonar.sh start&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[sonar@res sonarqube-6.7.7]$ bin/linux-x86-64/sonar.sh stop&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;访问sonar web：&lt;a href=&quot;http://172.16.7.180:9000&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://172.16.7.180:9000&lt;/a&gt;&lt;br&gt;默认账号密码是：admin/admin。登录完成后，建议去修改管理员密码。点击右上角的管理员头像，选择“我的账号”，然后点击“安全”，可以看到修改密码的地方。&lt;/p&gt;
&lt;h3 id=&quot;sonar配置邮件&quot;&gt;&lt;a href=&quot;#sonar配置邮件&quot; class=&quot;headerlink&quot; title=&quot;sonar配置邮件&quot;&gt;&lt;/a&gt;sonar配置邮件&lt;/h3&gt;&lt;p&gt;使用管理员账号登录sonar web，点击第一行菜单中的“配置”。往下拉，在左侧最下方点击“通用”。在右侧，往下拉会看到可以配置邮件的地方。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/22.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/23.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;sonar添加用户、组&quot;&gt;&lt;a href=&quot;#sonar添加用户、组&quot; class=&quot;headerlink&quot; title=&quot;sonar添加用户、组&quot;&gt;&lt;/a&gt;sonar添加用户、组&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;1.添加组&lt;/strong&gt;&lt;br&gt;可以针对一个项目添加一个组，把这些人放到这个组里面，然后再配置相应的权限。&lt;br&gt;使用管理员账号登录sonar web，点击第一行的“配置”，点击“权限”，在下拉菜单中选择“群组”。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/24.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;然后点击右上方“创建群组”，输入群组名称即可创建群组。此时还没有添加用户，没有用户可以添加到新创建的群组中。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.添加用户&lt;/strong&gt;&lt;br&gt;使用管理员账号登录sonar web，点击第一行的“配置”，点击“权限”，在下拉菜单中选择“用户”。然后点击右上方的“创建用户”。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/25.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;jenkins安装sonarqube-scaner插件&quot;&gt;&lt;a href=&quot;#jenkins安装sonarqube-scaner插件&quot; class=&quot;headerlink&quot; title=&quot;jenkins安装sonarqube scaner插件&quot;&gt;&lt;/a&gt;jenkins安装sonarqube scaner插件&lt;/h2&gt;&lt;p&gt;浏览器输入jenkins访问地址，以管理员账户登录后，点击左侧菜单的“系统管理”。然后找到“管理插件”，点击“可选插件”，输入sonarqube scanner，即可搜索到。我这边由于jenkins版本比较低，是2.73.3。最新的sonarqube scanner插件需要jenkins 2.89.4以上版本才可以安装，但是这里又不提供低版本的插件直接安装。查看&lt;a href=&quot;https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;sonarqube官方文档&lt;/a&gt;，有jenkins版本和sonarscanner版本对应关系。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/13.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;这样就只能先下载好低版本的插件，然后通过“高级”选项卡上传插件进行安装。&lt;br&gt;我这里下载好了2.6.1版本的sonar.hpi。在插件管理里，选择“高级”选项卡。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/14.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;往下拉，找到“上传插件”，点击“选择文件”，然后选择本地的sonar.hpi，点击“上传”。过一会儿就装好了。&lt;/p&gt;
&lt;h2 id=&quot;jenkins构建过程配置sonar&quot;&gt;&lt;a href=&quot;#jenkins构建过程配置sonar&quot; class=&quot;headerlink&quot; title=&quot;jenkins构建过程配置sonar&quot;&gt;&lt;/a&gt;jenkins构建过程配置sonar&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;1.配置“SonarQube servers”&lt;/strong&gt;&lt;br&gt;在jenkins页面，点击“系统管理”，点击“系统设置”，找到“SonarQube servers”，点击“Add SonarQube”，输入SonarQube的相关信息。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/15.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;上图中的token，请访问sonar界面，使用管理员账号登录，点击右上角的管理员头像，选择“我的账号”，然后点击“安全”，第一项就是“令牌”。在输入框输入名字，随便定义，然后点击“生成”。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/16.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;【注意】：请复制生成的token并保存下来，因为后来在进去就看不到了。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.配置在构建过程中增加sonar扫描&lt;/strong&gt;&lt;br&gt;点击某个项目进去，在“构建”处，点击“增加构建步骤”，选择“Execute SonarQube Scanner”，配置如下：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/17.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;上图中在 Analysis properties 项里配置了一个参数，sonar.projectBaseDir=/root/.jenkins/workspace/gemini_dev。之所以配置这个参数，是因为我这个项目里配置有多个svn地址，每个svn地址都是项目的一个模块，这个情况下SonarQube的sonar.ProjectBaseDir参数默认会被设置为第一个项目的路径。这会导致找不到其他模块。详见官方issue：&lt;a href=&quot;https://issues.jenkins-ci.org/browse/JENKINS-24044&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://issues.jenkins-ci.org/browse/JENKINS-24044&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上图中的 sonar-project.properties 内容大致如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;96&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;97&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;98&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;99&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;100&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;101&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;102&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;103&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;#sonarqube的地址&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sonar.host.url=http://172.16.7.180:9000&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# SonarQube 中唯一表示，must be unique in a given SonarQube instance&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sonar.projectKey=gemini #名字随意&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# ui里面显示的项目名称，this is the name displayed in the SonarQube UI&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sonar.projectName=gemini #名字随意&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#版本号&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sonar.projectVersion=1.0  #版本随意&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#用户名密码，用token代替&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sonar.login=26e7ce1f5cc56a2442b7934b721749bd269f2dcc&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#语言&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#sonar.language=java,html,css,js #默认是多语言，但是不支持这么写&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#源码位置&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sonar.modules=eetablecore,eetablemanage,emapflow,emapfunauth,emapsender,emaptaskcenter,emapturing,flowstatistics,skylobby,temppersonnel,getemapapplist,getybtapplist,emapposition,resourcemonitor,serviceanalyseapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablecore.projectBaseDir=/root/.jenkins/workspace/gemini_dev/eetablecore&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablecore.sonar.projectName=eetablecore&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablecore.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablecore.sonar.java.binaries=/usr/local/gemini/eetablecore/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablecore.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablemanage.projectBaseDir=/root/.jenkins/workspace/gemini_dev/eetablemanage&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablemanage.sonar.projectName=eetablemanage&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablemanage.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablemanage.sonar.java.binaries=/usr/local/gemini/eetablemanage/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;eetablemanage.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js,web/public/design/plugin/**/*,web/public/design/public/**/*&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapflow.projectBaseDir=/root/.jenkins/workspace/gemini_dev/emapflow&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapflow.sonar.projectName=emapflow&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapflow.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapflow.sonar.java.binaries=/usr/local/gemini/emapflow/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapflow.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js,src/org/activiti/**/*.java&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapfunauth.projectBaseDir=/root/.jenkins/workspace/gemini_dev/emapfunauth&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapfunauth.sonar.projectName=emapfunauth&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapfunauth.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapfunauth.sonar.java.binaries=/usr/local/gemini/emapfunauth/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapfunauth.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapsender.projectBaseDir=/root/.jenkins/workspace/gemini_dev/emapsender&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapsender.sonar.projectName=emapsender&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapsender.sonar.sources=src&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapsender.sonar.java.binaries=/usr/local/gemini/emapsender/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emaptaskcenter.projectBaseDir=/root/.jenkins/workspace/gemini_dev/emaptaskcenter&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emaptaskcenter.sonar.projectName=emaptaskcenter&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emaptaskcenter.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emaptaskcenter.sonar.java.binaries=/usr/local/gemini/emaptaskcenter/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emaptaskcenter.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapturing.projectBaseDir=/root/.jenkins/workspace/gemini_dev/emapturing&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapturing.sonar.projectName=emapturing&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapturing.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapturing.sonar.java.binaries=/usr/local/gemini/emapturing/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapturing.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;flowstatistics.projectBaseDir=/root/.jenkins/workspace/gemini_dev/flowstatistics&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;flowstatistics.sonar.projectName=flowstatistics&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;flowstatistics.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;flowstatistics.sonar.java.binaries=/usr/local/gemini/flowstatistics/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;flowstatistics.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;skylobby.projectBaseDir=/root/.jenkins/workspace/gemini_dev/skylobby&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;skylobby.sonar.projectName=skylobby&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;skylobby.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;skylobby.sonar.java.binaries=/usr/local/gemini/skylobby/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;skylobby.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js,web/manager/components/UE/**/*,web/mobile/dependencies/**/*,web/mobile/static/**/*&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;temppersonnel.projectBaseDir=/root/.jenkins/workspace/gemini_dev/temppersonnel&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;temppersonnel.sonar.projectName=temppersonnel&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;temppersonnel.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;temppersonnel.sonar.java.binaries=/usr/local/gemini/temppersonnel/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;temppersonnel.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getemapapplist.projectBaseDir=/root/.jenkins/workspace/gemini_dev/getemapapplist&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getemapapplist.sonar.projectName=getemapapplist&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getemapapplist.sonar.sources=src&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getemapapplist.sonar.java.binaries=/usr/local/gemini/getemapapplist/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getybtapplist.projectBaseDir=/root/.jenkins/workspace/gemini_dev/getybtapplist&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getybtapplist.sonar.projectName=getybtapplist&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getybtapplist.sonar.sources=src&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;getybtapplist.sonar.java.binaries=/usr/local/gemini/getybtapplist/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapposition.projectBaseDir=/root/.jenkins/workspace/gemini_dev/emapposition&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapposition.sonar.projectName=emapposition&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapposition.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapposition.sonar.java.binaries=/usr/local/gemini/emapposition/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;emapposition.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;resourcemonitor.projectBaseDir=/root/.jenkins/workspace/gemini_dev/resourcemonitor&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;resourcemonitor.sonar.projectName=resourcemonitor&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;resourcemonitor.sonar.sources=src,web&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;resourcemonitor.sonar.java.binaries=/usr/local/gemini/resourcemonitor/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;resourcemonitor.sonar.exclusions=web/**/*.css,web/**/*.less,web/**/*.scss,web/**/*.min.js&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceanalyseapp.projectBaseDir=/root/.jenkins/workspace/gemini_dev/serviceanalyseapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceanalyseapp.sonar.projectName=serviceanalyseapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceanalyseapp.sonar.sources=src&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceanalyseapp.sonar.java.binaries=/usr/local/gemini/serviceanalyseapp/classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#源码的编码&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sonar.sourceEncoding=UTF-8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【说明】：&lt;/strong&gt;&lt;br&gt;1.以上配置中 src 为java源代码目录，web为前端js目录。&lt;br&gt;2.新版本的SonarQube scanner的配置文件里扫描java源代码需要提供 java.binaries 定义，我这里对应每个模块建了个文件夹作为值。&lt;br&gt;3.配置文件可配参数更详细的介绍：&lt;br&gt;&lt;a href=&quot;https://baiyangcao.github.io/notes/2017/01/11/sonarqube-analyz-parameter.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://baiyangcao.github.io/notes/2017/01/11/sonarqube-analyz-parameter.html&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://docs.sonarqube.org/latest/analysis/analysis-parameters/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://docs.sonarqube.org/latest/analysis/analysis-parameters/&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://docs.sonarqube.org/latest/project-administration/narrowing-the-focus/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://docs.sonarqube.org/latest/project-administration/narrowing-the-focus/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;构建测试并查看结果&quot;&gt;&lt;a href=&quot;#构建测试并查看结果&quot; class=&quot;headerlink&quot; title=&quot;构建测试并查看结果&quot;&gt;&lt;/a&gt;构建测试并查看结果&lt;/h2&gt;&lt;p&gt;在jenkins相应项目上，点击“立即构建”，然后查看“Console Output”：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/18.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;构建完成后可以登录sonar web界面查看：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/19.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/20.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/21.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;部门领导要求扫描代码质量，我们平时是用jenkins来做持续集成和持续发布的，所以就将jenkins和sonar做了集成，在编译完成后sonar自动扫描代码，然后在进行发布。
    
    </summary>
    
      <category term="持续集成" scheme="http://yoursite.com/categories/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/"/>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>kubeadm安装kubernetes 1.14.0</title>
    <link href="http://yoursite.com/2019/04/08/kubeadm%E5%AE%89%E8%A3%85kubernetes-1-14-0/"/>
    <id>http://yoursite.com/2019/04/08/kubeadm安装kubernetes-1-14-0/</id>
    <published>2019-04-08T03:26:45.000Z</published>
    <updated>2019-07-31T03:43:25.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;之前采用二进制方式部署过Kubernetes，操作较为繁琐，此次采用kubeadm安装Kubernetes，Kubernetes相关组件介绍详见前面的文章。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;环境说明&quot;&gt;&lt;a href=&quot;#环境说明&quot; class=&quot;headerlink&quot; title=&quot;环境说明&quot;&gt;&lt;/a&gt;环境说明&lt;/h2&gt;&lt;h3 id=&quot;服务器环境&quot;&gt;&lt;a href=&quot;#服务器环境&quot; class=&quot;headerlink&quot; title=&quot;服务器环境&quot;&gt;&lt;/a&gt;服务器环境&lt;/h3&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;主机名&lt;/th&gt;
&lt;th&gt;操作系统版本&lt;/th&gt;
&lt;th&gt;IP地址&lt;/th&gt;
&lt;th&gt;角色&lt;/th&gt;
&lt;th&gt;安装软件&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;spark32&lt;/td&gt;
&lt;td&gt;CentOS 7.0&lt;/td&gt;
&lt;td&gt;172.16.206.32&lt;/td&gt;
&lt;td&gt;Kubernetes Master、Harbor&lt;/td&gt;
&lt;td&gt;docker-ce 18.09.4、kubelet v1.14.0、kubeadm v1.14.0、etcd 3.3.10、kube-apiserver v1.14.0、kube-scheduler v1.14.0、kube-controller-manager v1.14.0、kube-proxy、flannel v0.11.0、kubectl v1.14.0、pause 3.1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;spark17&lt;/td&gt;
&lt;td&gt;CentOS 7.0&lt;/td&gt;
&lt;td&gt;172.16.206.17&lt;/td&gt;
&lt;td&gt;Kubernetes Node&lt;/td&gt;
&lt;td&gt;docker-ce 18.09.4、kubelet v1.14.0、kubeadm v1.14.0、kube-proxy v1.14.0、flannel v0.11.0、pause 3.1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ubuntu31&lt;/td&gt;
&lt;td&gt;Ubuntu 16.04&lt;/td&gt;
&lt;td&gt;172.16.206.31&lt;/td&gt;
&lt;td&gt;Kubernetes Node&lt;/td&gt;
&lt;td&gt;docker-ce 18.09.4、kubelet v1.14.0、kubeadm v1.14.0、kube-proxy v1.14.0、flannel v0.11.0、pause 3.1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;【注意】：如果操作系统选择的是CentOS的，建议操作系统选择CentOS 7.3+的，从7.3+开始，默认安装的xfs文件系统的 ftype=1，这样docker可以使用官方推荐的存储驱动：overlay2&lt;/strong&gt;&lt;br&gt;如果当前系统小于7.3，并且ftype=0，有几个方法：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;重新创建xfs文件系统&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://superuser.com/questions/1321926/recreating-an-xfs-file-system-with-ftype-1，没试过这种方法&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://superuser.com/questions/1321926/recreating-an-xfs-file-system-with-ftype-1，没试过这种方法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;如果你的主机上的卷组还有其他空间，可以重新分配一个逻辑卷，并且在格式化时指定 ftype=1，修改docker的默认存储路径(/var/lib/docker)为新创建的逻辑卷。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;【示例】：如何查看xfs文件系统的ftype的值&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/27.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;安装准备&quot;&gt;&lt;a href=&quot;#安装准备&quot; class=&quot;headerlink&quot; title=&quot;安装准备&quot;&gt;&lt;/a&gt;安装准备&lt;/h3&gt;&lt;p&gt;1.关闭iptables和firewalld&lt;br&gt;每个节点都需要做&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;systemctl stop firewalld.service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;systemctl disable firewalld.service&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;2.集群主机时间同步&lt;br&gt;采用NTP(Network Time Protocol)方式来实现, 选择一台机器, 作为集群的时间同步服务器, 然后分别配置服务端和集群其他机器。&lt;br&gt;参见之前的博客文档&lt;a href=&quot;http://jkzhao.github.io/2016/08/07/%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2Apache%20Hadoop%20(%E5%AE%8C%E5%85%A8%E5%88%86%E5%B8%83%E5%BC%8F%E6%A8%A1%E5%BC%8F%E5%B9%B6%E4%B8%94%E5%AE%9E%E7%8E%B0NameNode%20HA%E5%92%8CResourceManager%20HA&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;安装部署Apache Hadoop (完全分布式模式并且实现NameNode HA和ResourceManager HA)&lt;/a&gt;/)&lt;/p&gt;
&lt;p&gt;3.禁用SELINUX&lt;br&gt;每个节点都需要做&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;setenforce 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;vi /etc/selinux/config&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;SELINUX=disabled&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;4.配置/etc/hosts&lt;br&gt;每个节点都需要配置&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# vim /etc/hosts&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.32 spark32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.17 spark17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172.16.206.31 ubuntu31&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;5.docker会生成大量的ip规则，有可能对iptables内部的nfcall，需要打开内生的桥接功能&lt;br&gt;每个节点都需要配置&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# echo &amp;quot;net.bridge.bridge-nf-call-iptables = 1&amp;quot; &amp;gt;&amp;gt; /etc/sysctl.conf &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# echo &amp;quot;net.bridge.bridge-nf-call-ip6tables = 1&amp;quot; &amp;gt;&amp;gt; /etc/sysctl.conf &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# echo &amp;quot;net.ipv4.ip_forward=1&amp;quot; &amp;gt;&amp;gt; /etc/sysctl.conf&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# sysctl -p /etc/sysctl.conf&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;安装配置master节点&quot;&gt;&lt;a href=&quot;#安装配置master节点&quot; class=&quot;headerlink&quot; title=&quot;安装配置master节点&quot;&gt;&lt;/a&gt;安装配置master节点&lt;/h2&gt;&lt;h3 id=&quot;安装docker-ce、kubelet、kubeadm、kubectl&quot;&gt;&lt;a href=&quot;#安装docker-ce、kubelet、kubeadm、kubectl&quot; class=&quot;headerlink&quot; title=&quot;安装docker-ce、kubelet、kubeadm、kubectl&quot;&gt;&lt;/a&gt;安装docker-ce、kubelet、kubeadm、kubectl&lt;/h3&gt;&lt;p&gt;我们使用阿里云仓库。点击访问&lt;a href=&quot;https://opsx.alibaba.com/mirror&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;阿里云仓库&lt;/a&gt;，可以找到docker-ce和kubernetes，在右侧有“帮助”，里面会有说明。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/21.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/20.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/yum.repos.d/kubernetes.repo&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; [kubernetes]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; name=Kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; enabled=1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; gpgcheck=1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; repo_gpgcheck=1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;gt; EOF&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# yum install docker-ce kubelet kubeadm kubectl -y&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;你也可以自己安装时指定固定的版本安装，我这里默认使用最新的稳定版本1.14.0。以kubeadm为例，查看仓库里有哪些版本可以安装：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# yum list kubeadm.x86_64 --showduplicates | sort -r&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;配置启动docker&quot;&gt;&lt;a href=&quot;#配置启动docker&quot; class=&quot;headerlink&quot; title=&quot;配置启动docker&quot;&gt;&lt;/a&gt;配置启动docker&lt;/h3&gt;&lt;p&gt;接下来需要安装apiserver、controller manager、scheduler、kube-proxy。kubeadm安装Kubernetes集群时，这些组件是跑在静态Pods中的，官网&lt;a href=&quot;https://kubernetes.io/docs/tasks/administer-cluster/static-pod/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Static Pod文档&lt;/a&gt;。&lt;br&gt;docker是需要去docker仓库里下载所依赖的每一个镜像文件，这些镜像文件放在google的gcr仓库里，可能下载不了。我这里临时改下docker的配置文件，临时添加个代理，等集群安装完去掉代理。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# vim /usr/lib/systemd/system/docker.service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Environment=&amp;quot;HTTPS_PROXY=http://www.ik8s.io:10080&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Environment=&amp;quot;NO_PROXY=127.0.0.0/8,172.16.0.0/16&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl daemon-reload&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl start docker&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker info&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/22.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;如上图所示，有个提示，Storage Driver: overlay，以后会被移除。我这里改为overlay2。具体关于存储方面的可仔细阅读&lt;a href=&quot;https://docs.docker.com/storage/storagedriver/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;docker官方文档相应章节&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl stop docker&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# cp -au /var/lib/docker /var/lib/docker.bk&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# vim /etc/docker/daemon.json&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;quot;storage-driver&amp;quot;: &amp;quot;overlay2&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl start docker&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl enable docker.service&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;【注意】：如果你自己有代理，即使你在服务器上配置了访问所有地址都走代理，在使用命令：docker pull k8s.gcr.io/kube-apiserver:v1.14.0 就可以拉取镜像了，一定要在 /usr/lib/systemd/system/docker.service 里配置代理地址，比如：Environment=”HTTPS_PROXY=&lt;a href=&quot;http://127.0.0.1:8118&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://127.0.0.1:8118&lt;/a&gt;“&lt;br&gt;Environment=”HTTP_PROXY=&lt;a href=&quot;http://127.0.0.1:8118&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://127.0.0.1:8118&lt;/a&gt;“&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;配置kubelet&quot;&gt;&lt;a href=&quot;#配置kubelet&quot; class=&quot;headerlink&quot; title=&quot;配置kubelet&quot;&gt;&lt;/a&gt;配置kubelet&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# rpm -ql kubelet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/etc/kubernetes/manifests&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/etc/sysconfig/kubelet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/usr/bin/kubelet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/usr/lib/systemd/system/kubelet.service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# cat /etc/sysconfig/kubelet &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KUBELET_EXTRA_ARGS=&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;早期的k8s要求，每一个节点都不能打开swap设备。如果开了，不让你启动。但是我们可以人为的去忽略它，定义的方式就是上面这个参数。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# vim /etc/sysconfig/kubelet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KUBELET_EXTRA_ARGS=&amp;quot;--fail-swap-on=false&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果不配置这个，在下面使用kubeadm init初始化master时会报如下错误：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;        [ERROR Swap]: running with swap on is not supported. Please disable swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此时不能启动kubelet，它的配置文件还没有生成，在初始化master节点的过程中会生成kubelet的配置文件，并且启动kubelet。先设置开机自启动：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl enable kubelet.service&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;初始化master节点&quot;&gt;&lt;a href=&quot;#初始化master节点&quot; class=&quot;headerlink&quot; title=&quot;初始化master节点&quot;&gt;&lt;/a&gt;初始化master节点&lt;/h3&gt;&lt;p&gt;使用kubeadm安装master节点的各组件。&lt;br&gt;查看初始化参数：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubeadm init --help&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/23.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/24.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;在初始化前，我们可以打印出kubeadm默认的配置：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]#  kubeadm config print init-defaults&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;bootstrapTokens:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;- groups:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - system:bootstrappers:kubeadm:default-node-token&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  token: abcdef.0123456789abcdef&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ttl: 24h0m0s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  usages:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - signing&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - authentication&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: InitConfiguration&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;localAPIEndpoint:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  advertiseAddress: 1.2.3.4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  bindPort: 6443&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;nodeRegistration:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  criSocket: /var/run/dockershim.sock&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  name: spark32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  taints:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  - effect: NoSchedule&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    key: node-role.kubernetes.io/master&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;---&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiServer:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  timeoutForControlPlane: 4m0s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;apiVersion: kubeadm.k8s.io/v1beta1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;certificatesDir: /etc/kubernetes/pki&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterName: kubernetes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controlPlaneEndpoint: &amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controllerManager: &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;dns:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  type: CoreDNS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  local:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    dataDir: /var/lib/etcd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;imageRepository: k8s.gcr.io&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kind: ClusterConfiguration&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubernetesVersion: v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;networking:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  dnsDomain: cluster.local&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  podSubnet: &amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  serviceSubnet: 10.96.0.0/12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;scheduler: &amp;#123;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;下面开始初始化：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubeadm init --kubernetes-version=v1.14.0 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --ignore-preflight-errors=Swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[init] Using Kubernetes version: v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Running pre-flight checks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING IsDockerSystemdCheck]: detected &amp;quot;cgroupfs&amp;quot; as the Docker cgroup driver. The recommended driver is &amp;quot;systemd&amp;quot;. Please follow the guide at https://kubernetes.io/docs/setup/cri/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING Swap]: running with swap on is not supported. Please disable swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Pulling images required for setting up a Kubernetes cluster&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] This might take a minute or two, depending on the speed of your internet connection&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] You can also perform this action in beforehand using &amp;apos;kubeadm config images pull&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;error execution phase preflight: [preflight] Some fatal errors occurred:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [ERROR ImagePull]: failed to pull image k8s.gcr.io/kube-apiserver:v1.14.0: output: Error response from daemon: Get https://k8s.gcr.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;, error: exit status 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;问题：初始化时发现网上找的代理已经失效了，拉取不了gcr仓库的镜像。&lt;br&gt;先查看kubeadm初始化master需要哪些镜像：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubeadm config images list&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;I0408 15:43:21.372628    4131 version.go:96] could not fetch a Kubernetes version from the internet: unable to get URL &amp;quot;https://dl.k8s.io/release/stable-1.txt&amp;quot;: Get https://dl.k8s.io/release/stable-1.txt: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;I0408 15:43:21.372730    4131 version.go:97] falling back to the local client version: v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;k8s.gcr.io/kube-apiserver:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;k8s.gcr.io/kube-controller-manager:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;k8s.gcr.io/kube-scheduler:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;k8s.gcr.io/kube-proxy:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;k8s.gcr.io/pause:3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;k8s.gcr.io/etcd:3.3.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;k8s.gcr.io/coredns:1.3.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;去掉docker配置文件中代理配置：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# vim /usr/lib/systemd/system/docker.service &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Environment=&amp;quot;HTTPS_PROXY=http://www.ik8s.io:10080&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Environment=&amp;quot;NO_PROXY=127.0.0.0/8,172.16.0.0/16&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl daemon-reload&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl restart docker.service&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;配置阿里云加速：参照前面博客&lt;a href=&quot;http://jkzhao.github.io/2017/08/28/CentOS%E5%AE%89%E8%A3%85Docker-CE/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CentOS安装Docker CE&lt;/a&gt;&lt;br&gt;从阿里云registry拉取镜像&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.3.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker images&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;REPOSITORY                                                                    TAG                 IMAGE ID            CREATED             SIZE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy                v1.14.0             5cd54e388aba        13 days ago         82.1MB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager   v1.14.0             b95b1efa0436        13 days ago         158MB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler            v1.14.0             00638a24688b        13 days ago         81.6MB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver            v1.14.0             ecf910f40d6e        13 days ago         210MB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;registry.cn-hangzhou.aliyuncs.com/google_containers/coredns                   1.3.1               eb516548c180        2 months ago        40.3MB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;registry.cn-hangzhou.aliyuncs.com/google_containers/etcd                      3.3.10              2c4adeb21b4f        4 months ago        258MB&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;registry.cn-hangzhou.aliyuncs.com/google_containers/pause                     3.1                 da86e6ba6ca1        15 months ago       742kB&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;因为kubeadm安装的docker镜像默认是k8s.gcr.io网站的，所以需要改一下标签：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.14.0 k8s.gcr.io/kube-apiserver:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.14.0 k8s.gcr.io/kube-scheduler:v1.14.0     &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0 k8s.gcr.io/kube-proxy:v1.14.0             &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.3.10 k8s.gcr.io/etcd:3.3.10 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.3.1 k8s.gcr.io/coredns:1.3.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;下面再次初始化：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubeadm init --kubernetes-version=v1.14.0 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --ignore-preflight-errors=Swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[init] Using Kubernetes version: v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Running pre-flight checks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING IsDockerSystemdCheck]: detected &amp;quot;cgroupfs&amp;quot; as the Docker cgroup driver. The recommended driver is &amp;quot;systemd&amp;quot;. Please follow the guide at https://kubernetes.io/docs/setup/cri/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING Swap]: running with swap on is not supported. Please disable swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Pulling images required for setting up a Kubernetes cluster&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] This might take a minute or two, depending on the speed of your internet connection&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] You can also perform this action in beforehand using &amp;apos;kubeadm config images pull&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Writing kubelet environment file with flags to file &amp;quot;/var/lib/kubelet/kubeadm-flags.env&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Writing kubelet configuration to file &amp;quot;/var/lib/kubelet/config.yaml&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Activating the kubelet service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Using certificateDir folder &amp;quot;/etc/kubernetes/pki&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;etcd/ca&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;etcd/server&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] etcd/server serving cert is signed for DNS names [spark32 localhost] and IPs [172.16.206.32 127.0.0.1 ::1]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;apiserver-etcd-client&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;etcd/peer&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] etcd/peer serving cert is signed for DNS names [spark32 localhost] and IPs [172.16.206.32 127.0.0.1 ::1]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;etcd/healthcheck-client&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;ca&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;apiserver&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] apiserver serving cert is signed for DNS names [spark32 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 172.16.206.32]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;apiserver-kubelet-client&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;front-proxy-ca&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;front-proxy-client&amp;quot; certificate and key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[certs] Generating &amp;quot;sa&amp;quot; key and public key&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubeconfig] Using kubeconfig folder &amp;quot;/etc/kubernetes&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubeconfig] Writing &amp;quot;admin.conf&amp;quot; kubeconfig file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubeconfig] Writing &amp;quot;kubelet.conf&amp;quot; kubeconfig file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubeconfig] Writing &amp;quot;controller-manager.conf&amp;quot; kubeconfig file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubeconfig] Writing &amp;quot;scheduler.conf&amp;quot; kubeconfig file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[control-plane] Using manifest folder &amp;quot;/etc/kubernetes/manifests&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[control-plane] Creating static Pod manifest for &amp;quot;kube-apiserver&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[control-plane] Creating static Pod manifest for &amp;quot;kube-controller-manager&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[control-plane] Creating static Pod manifest for &amp;quot;kube-scheduler&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[etcd] Creating static Pod manifest for local etcd in &amp;quot;/etc/kubernetes/manifests&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &amp;quot;/etc/kubernetes/manifests&amp;quot;. This can take up to 4m0s&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[apiclient] All control plane components are healthy after 25.563846 seconds&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[upload-config] storing the configuration used in ConfigMap &amp;quot;kubeadm-config&amp;quot; in the &amp;quot;kube-system&amp;quot; Namespace&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet] Creating a ConfigMap &amp;quot;kubelet-config-1.14&amp;quot; in namespace kube-system with the configuration for the kubelets in the cluster&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[upload-certs] Skipping phase. Please see --experimental-upload-certs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[mark-control-plane] Marking the node spark32 as control-plane by adding the label &amp;quot;node-role.kubernetes.io/master=&amp;apos;&amp;apos;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[mark-control-plane] Marking the node spark32 as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[bootstrap-token] Using token: q8vnmo.3eav1kq9c3zp2xgq&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[bootstrap-token] creating the &amp;quot;cluster-info&amp;quot; ConfigMap in the &amp;quot;kube-public&amp;quot; namespace&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[addons] Applied essential addon: CoreDNS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[addons] Applied essential addon: kube-proxy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Your Kubernetes control-plane has initialized successfully!&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;To start using your cluster, you need to run the following as a regular user:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  mkdir -p $HOME/.kube&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  sudo chown $(id -u):$(id -g) $HOME/.kube/config&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You should now deploy a pod network to the cluster.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Run &amp;quot;kubectl apply -f [podnetwork].yaml&amp;quot; with one of the options listed at:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  https://kubernetes.io/docs/concepts/cluster-administration/addons/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Then you can join any number of worker nodes by running the following on each as root:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubeadm join 172.16.206.32:6443 --token q8vnmo.3eav1kq9c3zp2xgq \&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    --discovery-token-ca-cert-hash sha256:7fb950b750bc546d9343040b646bae7d8749a63a33124f51c1adb2b4c19aa235&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/25.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;【说明】：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;dns附件在k8s上已经进化到第三版了。第一版叫skydns，后来被kubedns所取代，而在1.11版开始，才正式被CoreDNS所取代。CoreDNS支持前面两版不支持的高级功能，比如像很多资源的动态配置等。&lt;/li&gt;
&lt;li&gt;kube-proxy是作为附件运行的，也是托管在k8s之上。来帮忙负责生成service资源的相关iptables或ipvs规则。从1.11版本开始，默认开始使用的是ipvs。如果当前系统支不支持，默认安装上不支持的时候自动降级为iptables。1.10版及之前都是iptables，那时候使用ipvs还不成熟。&lt;/li&gt;
&lt;li&gt;这个token是个认证令牌，其实是个域共享密钥，意思是当前这个集群不是谁都能加入进来的，你要想加入进来得拿着这个令牌。这个token是动态生成的，复制保存下来，免得以后找不着了。&lt;strong&gt;注意这个令牌有效期是24小时，过了24小时在拿这个令牌来加入集群就会报认证错误，具体看下面的章节-安装配置Ubuntu 16.04 node节点&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;–discovery-token-ca-cert-hash：做发现时TLS BootStrap那个相关证书的或者私钥文件的hash码，hash码不对是不会让加入集群的，复制保存下来。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# mkdir -p $HOME/.kube&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You have mail in /var/spool/mail/root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# cp -i /etc/kubernetes/admin.conf $HOME/.kube/config&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;【说明】：admin.conf里面是kubeadm帮我们生成的一个被kubectl可以拿来作为配置文件，指定连接至k8s的apiserver，并完成认证的配置文件。这里面包含了认证信息，认证证书信息。&lt;br&gt;&lt;strong&gt;kubeadm init workflow：&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/#init-workflow&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看kubelet状态，此时已经启动起来了。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# systemctl status kubelet&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看集群组件状态：kubectl get cs/componentstatus&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get cs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                 STATUS    MESSAGE             ERROR&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;scheduler            Healthy   ok                  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controller-manager   Healthy   ok                  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-0               Healthy   &amp;#123;&amp;quot;health&amp;quot;:&amp;quot;true&amp;quot;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get componentstatus&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                 STATUS    MESSAGE             ERROR&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;controller-manager   Healthy   ok                  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;scheduler            Healthy   ok                  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-0               Healthy   &amp;#123;&amp;quot;health&amp;quot;:&amp;quot;true&amp;quot;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这里没有显示apiserver的状态，如果apiserver不健康，我们是得不到这些组件健康状态信息的。&lt;/p&gt;
&lt;p&gt;查看集群节点信息：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get nodes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME      STATUS     ROLES    AGE   VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32   NotReady   master   29m   v1.14.0&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此时只有主节点一个节点，而且是未就绪状态，因为此时还缺少一个网络附件，此时Pod之间无法通信。&lt;/p&gt;
&lt;p&gt;查看集群Pods状态信息（默认查的是default空间的pods，系统级的pods都是在kube-system空间）：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                              READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-8zzkb           0/1     Pending   0          43m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-t69hm           0/1     Pending   0          43m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-spark32                      1/1     Running   1          43m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-apiserver-spark32            1/1     Running   1          43m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-controller-manager-spark32   1/1     Running   1          43m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-9clf7                  1/1     Running   0          43m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-scheduler-spark32            1/1     Running   1          43m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;coredns处于pending状态，未决定的，行将发生的状态，是因为此时网络插件还没有安装。此时/etc/cni/目录也不存在。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【注意】：原来kubeadm 1.14.0版本初始化master节点时，已经支持从其他仓库下载需要的镜像，选项为：–image-repository string&lt;/strong&gt;&lt;br&gt;这就意味着我们不需要像上面那样从阿里云registry下载镜像，在打tag了。&lt;/p&gt;
&lt;h3 id=&quot;部署网络附件flannel&quot;&gt;&lt;a href=&quot;#部署网络附件flannel&quot; class=&quot;headerlink&quot; title=&quot;部署网络附件flannel&quot;&gt;&lt;/a&gt;部署网络附件flannel&lt;/h3&gt;&lt;p&gt;官网：&lt;a href=&quot;https://github.com/coreos/flannel&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/coreos/flannel&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/26.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;podsecuritypolicy.extensions/psp.flannel.unprivileged created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrole.rbac.authorization.k8s.io/flannel created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;clusterrolebinding.rbac.authorization.k8s.io/flannel created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;serviceaccount/flannel created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;configmap/kube-flannel-cfg created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.extensions/kube-flannel-ds-amd64 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.extensions/kube-flannel-ds-arm64 created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.extensions/kube-flannel-ds-arm created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.extensions/kube-flannel-ds-ppc64le created&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;daemonset.extensions/kube-flannel-ds-s390x created&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;看到这些并不是执行好了，此时正在拉取flannel镜像。下载很慢，耐心等待。可以使用docker images查看是否下载完成。。。&lt;br&gt;可以使用docker images查看当前服务器上下载的镜像，如果一直没有下来，直接运行命令拉取：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# docker pull quay.io/coreos/flannel:v0.11.0-amd64&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;拉取下来后，过一会儿，对应的flannel的pod就会启动起来了。&lt;/p&gt;
&lt;p&gt;查看集群Pods状态：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                              READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-8zzkb           1/1     Running   0          79m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-t69hm           1/1     Running   0          79m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-spark32                      1/1     Running   1          78m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-apiserver-spark32            1/1     Running   1          78m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-controller-manager-spark32   1/1     Running   1          78m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-2hkjh       1/1     Running   0          27m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-9clf7                  1/1     Running   0          79m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-scheduler-spark32            1/1     Running   1          78m&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此时再次查看master节点状态，已经是就绪状态了：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get nodes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME      STATUS   ROLES    AGE   VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32   Ready    master   86m   v1.14.0&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;安装配置CentOS-7-node节点&quot;&gt;&lt;a href=&quot;#安装配置CentOS-7-node节点&quot; class=&quot;headerlink&quot; title=&quot;安装配置CentOS 7 node节点&quot;&gt;&lt;/a&gt;安装配置CentOS 7 node节点&lt;/h2&gt;&lt;p&gt;我这里以spark17节点为例：&lt;/p&gt;
&lt;h3 id=&quot;安装docker-ce、kubelet、kubeadm&quot;&gt;&lt;a href=&quot;#安装docker-ce、kubelet、kubeadm&quot; class=&quot;headerlink&quot; title=&quot;安装docker-ce、kubelet、kubeadm&quot;&gt;&lt;/a&gt;安装docker-ce、kubelet、kubeadm&lt;/h3&gt;&lt;p&gt;在master节点上远程拷贝 docker-ce.repo、kubernetes.repo 到node3节点。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# scp -p /etc/yum.repos.d/docker-ce.repo root@spark17:/etc/yum.repos.d/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# scp -p /etc/yum.repos.d/kubernetes.repo root@spark17:/etc/yum.repos.d/&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;安装docker-ce、kubelet、kubeadm&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@node3 ~]# yum install docker-ce kubelet kubeadm -y&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;启动docker：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# systemctl start docker&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;配置启动docker-1&quot;&gt;&lt;a href=&quot;#配置启动docker-1&quot; class=&quot;headerlink&quot; title=&quot;配置启动docker&quot;&gt;&lt;/a&gt;配置启动docker&lt;/h3&gt;&lt;p&gt;修改docker的Storage Driver：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# scp -p /etc/docker/daemon.json root@node3:/etc/docker/&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;重启docker并设置开机自启动：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# systemctl restart docker &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# systemctl enable docker&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;配置kubelet-1&quot;&gt;&lt;a href=&quot;#配置kubelet-1&quot; class=&quot;headerlink&quot; title=&quot;配置kubelet&quot;&gt;&lt;/a&gt;配置kubelet&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# vim /etc/sysconfig/kubelet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;KUBELET_EXTRA_ARGS=&amp;quot;--fail-swap-on=false&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# systemctl enable kubelet&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;加入集群&quot;&gt;&lt;a href=&quot;#加入集群&quot; class=&quot;headerlink&quot; title=&quot;加入集群&quot;&gt;&lt;/a&gt;加入集群&lt;/h3&gt;&lt;p&gt;我这里由于上面kubeadm init的时候没有使用 –image-repository string 指定从其他registry下载镜像，所以我先下载下来需要的镜像，然后再加入到集群中。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0 k8s.gcr.io/kube-proxy:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# docker pull quay.io/coreos/flannel:v0.11.0-amd64&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;或者可以在master节点上，把镜像docker save保存为tar，然后到node节点上docker load为镜像。以flannel为例：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark31 ~]# docker save -o flannel.tar quay.io/coreos/flannel:v0.11.0-amd64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# docker load -i flannel.tar&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;加入集群：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;kubeadm join 172.16.206.32:6443 --token q8vnmo.3eav1kq9c3zp2xgq --discovery-token-ca-cert-hash sha256:7fb950b750bc546d9343040b646bae7d8749a63a33124f51c1adb2b4c19aa235 --ignore-preflight-errors=Swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Running pre-flight checks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING IsDockerSystemdCheck]: detected &amp;quot;cgroupfs&amp;quot; as the Docker cgroup driver. The recommended driver is &amp;quot;systemd&amp;quot;. Please follow the guide at https://kubernetes.io/docs/setup/cri/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING Swap]: running with swap on is not supported. Please disable swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Reading configuration from the cluster...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] FYI: You can look at this config file with &amp;apos;kubectl -n kube-system get cm kubeadm-config -oyaml&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Downloading configuration for the kubelet from the &amp;quot;kubelet-config-1.14&amp;quot; ConfigMap in the kube-system namespace&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Writing kubelet configuration to file &amp;quot;/var/lib/kubelet/config.yaml&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Writing kubelet environment file with flags to file &amp;quot;/var/lib/kubelet/kubeadm-flags.env&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Activating the kubelet service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;This node has joined the cluster:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;* Certificate signing request was sent to apiserver and a response was received.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;* The Kubelet was informed of the new secure connection details.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Run &amp;apos;kubectl get nodes&amp;apos; on the control-plane to see this node join the cluster.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;要等待几分钟，node节点会下载kube-proxy和flannel，启动起来，才算真正完成。可以使用 kubectl get nodes 查看节点状态。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get nodes      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME      STATUS   ROLES    AGE   VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark17   Ready    &amp;lt;none&amp;gt;   14h   v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32   Ready    master   23h   v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubectl get pods -n kube-system -o wide&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                              READY   STATUS    RESTARTS   AGE   IP              NODE      NOMINATED NODE   READINESS GATES&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-8zzkb           1/1     Running   0          23h   10.244.0.2      spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-t69hm           1/1     Running   0          23h   10.244.0.3      spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-spark32                      1/1     Running   1          23h   172.16.206.32   spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-apiserver-spark32            1/1     Running   1          23h   172.16.206.32   spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-controller-manager-spark32   1/1     Running   1          23h   172.16.206.32   spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-2hkjh       1/1     Running   0          22h   172.16.206.32   spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-f5fhc       1/1     Running   0          14h   172.16.206.17   spark17   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-9clf7                  1/1     Running   0          23h   172.16.206.32   spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-p5nrg                  1/1     Running   0          14h   172.16.206.17   spark17   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-scheduler-spark32            1/1     Running   1          23h   172.16.206.32   spark32   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/28.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;安装配置Ubuntu-16-04-node节点&quot;&gt;&lt;a href=&quot;#安装配置Ubuntu-16-04-node节点&quot; class=&quot;headerlink&quot; title=&quot;安装配置Ubuntu 16.04 node节点&quot;&gt;&lt;/a&gt;安装配置Ubuntu 16.04 node节点&lt;/h2&gt;&lt;p&gt;集群中有一台服务器的操作系统是Ubuntu 16.04，作为Node节点。&lt;br&gt;关闭防火墙：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo systemctl status ufw.service &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo systemctl stop ufw.service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo systemctl disable ufw.service&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看apparmor（相当于CentOS中的SELinux）状态：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo systemctl status apparmor.service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;● apparmor.service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Loaded: not-found (Reason: No such file or directory)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Active: inactive (dead)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;检查nf-call：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ cat /proc/sys/net/bridge/bridge-nf-call-iptables &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ cat /proc/sys/net/bridge/bridge-nf-call-ip6tables &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;安装docker-ce、kubelet、kubeadm-1&quot;&gt;&lt;a href=&quot;#安装docker-ce、kubelet、kubeadm-1&quot; class=&quot;headerlink&quot; title=&quot;安装docker-ce、kubelet、kubeadm&quot;&gt;&lt;/a&gt;安装docker-ce、kubelet、kubeadm&lt;/h3&gt;&lt;p&gt;我们使用阿里云仓库。点击访问&lt;a href=&quot;https://opsx.alibaba.com/mirror&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;阿里云仓库&lt;/a&gt;，可以找到docker-ce和kubernetes，在右侧有“帮助”，里面会有说明。&lt;/p&gt;
&lt;h4 id=&quot;安装docker&quot;&gt;&lt;a href=&quot;#安装docker&quot; class=&quot;headerlink&quot; title=&quot;安装docker&quot;&gt;&lt;/a&gt;安装docker&lt;/h4&gt;&lt;p&gt;&lt;a href=&quot;https://yq.aliyun.com/articles/110806&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://yq.aliyun.com/articles/110806&lt;/a&gt;&lt;br&gt;step 1: 安装必要的一些系统工具&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get update&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;step 2: 安装GPG证书&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Step 3: 写入软件源信息&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo add-apt-repository &amp;quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Step 4: 更新并安装 Docker-CE&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get -y update&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get -y install docker-ce&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo docker info&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Containers: 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Running: 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Paused: 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Stopped: 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Images: 4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Server Version: 18.09.4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Storage Driver: overlay2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Backing Filesystem: extfs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Supports d_type: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Native Overlay Diff: true&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Logging Driver: json-file&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Cgroup Driver: cgroupfs&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	WARNING: No swap limit support&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;有个WARNING，根据错误提示，只是cgroups中的swap account没有开启。这个功能应该是用在 &lt;code&gt;docker run -m=1524288 -it ubuntu /bin/bash&lt;/code&gt; 类似的命令，用来限制一个docker容器的内存使用上限，所以这里只是WARNING，不影响使用。&lt;br&gt;解决：&lt;br&gt;编辑/etc/default/grub，找到 GRUB_CMDLINE_LINUX=””，在双引号里面输入cgroup_enable=memory swapaccount=1&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/29.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo vim /etc/default/grub&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo update-grub&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo reboot&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;安装kubelet、kubeadm&quot;&gt;&lt;a href=&quot;#安装kubelet、kubeadm&quot; class=&quot;headerlink&quot; title=&quot;安装kubelet、kubeadm&quot;&gt;&lt;/a&gt;安装kubelet、kubeadm&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get update&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get install -y apt-transport-https&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;下面这条命令需要切换到root用户运行，普通用户sudo执行时一直提示要求使用root用户执行：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;jkzhao@ubuntu31:~$ su - root&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Password: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cat &amp;lt;&amp;lt;EOF &amp;gt;/etc/apt/sources.list.d/kubernetes.list&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;EOF&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;下面在切回到普通用户执行：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get update&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-get install kubelet=1.14.0-00 kubeadm=1.14.0-00 kubectl=1.14.0-00 #这里安装时我发现默认最新的是1.14.1版本，所以我安装的时候指定版本为1.14.0&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;配置kubelet-2&quot;&gt;&lt;a href=&quot;#配置kubelet-2&quot; class=&quot;headerlink&quot; title=&quot;配置kubelet&quot;&gt;&lt;/a&gt;配置kubelet&lt;/h4&gt;&lt;p&gt;Kubernetes 1.8开始要求关闭系统的Swap，如果不关闭，默认配置下kubelet将无法启动。可以通过kubelet的启动参数–fail-swap-on=false更改这个限制。配置忽略swap：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ sudo vim /etc/systemd/system/kubelet.service.d/10-kubeadm.conf &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Environment=&amp;quot;KUBELET_EXTRA_ARGS=--fail-swap-on=false&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/30.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;加入集群-1&quot;&gt;&lt;a href=&quot;#加入集群-1&quot; class=&quot;headerlink&quot; title=&quot;加入集群&quot;&gt;&lt;/a&gt;加入集群&lt;/h3&gt;&lt;p&gt;把需要的3个镜像下载下来，分别是kube-proxy、pause、flannel。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ sudo docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ sudo docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0 k8s.gcr.io/kube-proxy:v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ sudo docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ sudo docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ sudo docker pull quay.io/coreos/flannel:v0.11.0-amd64&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;加入集群：&lt;br&gt;切换到root用户，执行如下命令：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# kubeadm join 172.16.206.32:6443 --token q8vnmo.3eav1kq9c3zp2xgq --discovery-token-ca-cert-hash sha256:7fb950b750bc546d9343040b646bae7d8749a63a33124f51c1adb2b4c19aa235 --ignore-preflight-errors=Swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Running pre-flight checks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING IsDockerSystemdCheck]: detected &amp;quot;cgroupfs&amp;quot; as the Docker cgroup driver. The recommended driver is &amp;quot;systemd&amp;quot;. Please follow the guide at https://kubernetes.io/docs/setup/cri/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        [WARNING Swap]: running with swap on is not supported. Please disable swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Reading configuration from the cluster...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] FYI: You can look at this config file with &amp;apos;kubectl -n kube-system get cm kubeadm-config -oyaml&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;error execution phase preflight: unable to fetch the kubeadm-config ConfigMap: failed to get config map: Unauthorized&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但是发现报错了：error execution phase preflight: unable to fetch the kubeadm-config ConfigMap: failed to get config map: Unauthorized&lt;br&gt;解决：&lt;a href=&quot;https://github.com/kubernetes/kubeadm/issues/1310&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/kubernetes/kubeadm/issues/1310&lt;/a&gt;&lt;br&gt;TTL for the token should be 24h.我这个是后面几天加的新节点。&lt;br&gt;回到master节点，查看集群token：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubeadm token list&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/31.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;生成一个新的token：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubeadm token create&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85e3nn.5copkyq2j5leqrpb&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/32.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;再次回到node节点执行加入集群命令：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# kubeadm join 172.16.206.32:6443 --token 85e3nn.5copkyq2j5leqrpb --discovery-token-ca-cert-hash sha256:7fb950b750bc546d9343040b646bae7d8749a63a33124f51c1adb2b4c19aa235 --ignore-preflight-errors=Swap&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/33.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;在Ubuntu上使用kubectl，&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ mkdir -p .kube&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;把master节点上的 $HOME/.kube/config/admin.conf 拷贝到 这台Ubuntu机器的 $HOME/.kube/，并将admin.conf重命名为config&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;jkzhao@ubuntu31:~$ kubectl get nodes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME       STATUS   ROLES    AGE   VERSION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark17    Ready    &amp;lt;none&amp;gt;   21h   v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;spark32    Ready    master   30h   v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ubuntu31   Ready    &amp;lt;none&amp;gt;   13m   v1.14.0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;jkzhao@ubuntu31:~$ kubectl get pods -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;NAME                              READY   STATUS    RESTARTS   AGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-8zzkb           1/1     Running   0          30h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;coredns-fb8b8dccf-t69hm           1/1     Running   0          30h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;etcd-spark32                      1/1     Running   1          30h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-apiserver-spark32            1/1     Running   1          30h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-controller-manager-spark32   1/1     Running   1          30h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-2hkjh       1/1     Running   0          29h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-f5fhc       1/1     Running   0          21h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-flannel-ds-amd64-j596v       1/1     Running   0          13m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-9clf7                  1/1     Running   0          30h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-p5nrg                  1/1     Running   0          21h&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-proxy-vbcs4                  1/1     Running   0          13m&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kube-scheduler-spark32            1/1     Running   1          30h&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;如何从集群中移除Node&quot;&gt;&lt;a href=&quot;#如何从集群中移除Node&quot; class=&quot;headerlink&quot; title=&quot;如何从集群中移除Node&quot;&gt;&lt;/a&gt;如何从集群中移除Node&lt;/h2&gt;&lt;p&gt;如果需要从集群中移除spark17这个Node执行下面的命令：&lt;br&gt;在master节点上执行：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;kubectl drain spark17 --delete-local-data --force --ignore-daemonsets&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kubectl delete node spark17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在spark17节点上执行：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;kubeadm reset&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ifconfig cni0 down&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ip link delete cni0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ifconfig flannel.1 down&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ip link delete flannel.1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;rm -rf /var/lib/cni/&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在ubuntu31节点上执行：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;kubectl delete node spark17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;重置集群&quot;&gt;&lt;a href=&quot;#重置集群&quot; class=&quot;headerlink&quot; title=&quot;重置集群&quot;&gt;&lt;/a&gt;重置集群&lt;/h2&gt;&lt;p&gt;在master节点上执行如下命令：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# kubeadm reset --ignore-preflight-errors=Swap &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] Reading configuration from the cluster...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] FYI: You can look at this config file with &amp;apos;kubectl -n kube-system get cm kubeadm-config -oyaml&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] WARNING: Changes made to this host by &amp;apos;kubeadm init&amp;apos; or &amp;apos;kubeadm join&amp;apos; will be reverted.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] Are you sure you want to proceed? [y/N]: y&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[preflight] Running pre-flight checks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] Removing info for node &amp;quot;spark32&amp;quot; from the ConfigMap &amp;quot;kubeadm-config&amp;quot; in the &amp;quot;kube-system&amp;quot; Namespace&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;W0412 13:10:50.222211    9235 reset.go:158] [reset] failed to remove etcd member: error syncing endpoints with etc: etcdclient: no available endpoints&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.Please manually remove this etcd member using etcdctl&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] Stopping the kubelet service&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] unmounting mounted directories in &amp;quot;/var/lib/kubelet&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] Deleting contents of stateful directories: [/var/lib/etcd /var/lib/kubelet /etc/cni/net.d /var/lib/dockershim /var/run/kubernetes]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] Deleting contents of config directories: [/etc/kubernetes/manifests /etc/kubernetes/pki]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[reset] Deleting files: [/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;The reset process does not reset or clean up iptables rules or IPVS tables.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;If you wish to reset iptables, you must do so manually.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;For example:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;iptables -F &amp;amp;&amp;amp; iptables -t nat -F &amp;amp;&amp;amp; iptables -t mangle -F &amp;amp;&amp;amp; iptables -X&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;If your cluster was setup to utilize IPVS, run ipvsadm --clear (or similar)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;to reset your system&amp;apos;s IPVS tables.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# iptables -F &amp;amp;&amp;amp; iptables -t nat -F &amp;amp;&amp;amp; iptables -t mangle -F &amp;amp;&amp;amp; iptables -X&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# rm -rf /var/lib/kubelet/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# rm -rf /var/lib/cni/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# rm -rf /var/lib/etcd/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# rm -rf /etc/kubernetes/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# rm -rf .kube/config &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# ifconfig cni0 down&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# ip link delete cni0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# ifconfig flannel.1 down&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 ~]# ip link delete flannel.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/37.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;登录另外两台机器：&lt;br&gt;CentOS：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# kubeadm reset --ignore-preflight-errors=Swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# iptables -F &amp;amp;&amp;amp; iptables -t nat -F &amp;amp;&amp;amp; iptables -t mangle -F &amp;amp;&amp;amp; iptables -X&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# rm -rf /var/lib/kubelet/                                                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# rm -rf /var/lib/cni/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# rm -rf /var/lib/etcd/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# rm -rf /etc/kubernetes/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# ifconfig flannel.1 down&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# ip link delete flannel.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Ubuntu：&lt;br&gt;切换到root用户：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# kubeadm reset --ignore-preflight-errors=Swap&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# iptables -F &amp;amp;&amp;amp; iptables -t nat -F &amp;amp;&amp;amp; iptables -t mangle -F &amp;amp;&amp;amp; iptables -X &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# rm -rf /var/lib/kubelet/  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# rm -rf /var/lib/cni/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# rm -rf /var/lib/etcd/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# rm -rf /etc/kubernetes/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# ifconfig flannel.1 down&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;root@ubuntu31:~# ip link delete flannel.1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;坑&quot;&gt;&lt;a href=&quot;#坑&quot; class=&quot;headerlink&quot; title=&quot;坑&quot;&gt;&lt;/a&gt;坑&lt;/h2&gt;&lt;h3 id=&quot;kubelet报错&quot;&gt;&lt;a href=&quot;#kubelet报错&quot; class=&quot;headerlink&quot; title=&quot;kubelet报错&quot;&gt;&lt;/a&gt;kubelet报错&lt;/h3&gt;&lt;p&gt;查看kubelet日志，发现kubelet一直在报错：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# journalctl -xeu kubelet&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;qos_container_manager_linux.go:139] [ContainerManager] Failed to reserve QoS requests: failed to set supported cgroup subsystems for cgroup [kubepods burburstable]: Failed to find subsystem mount for required subsystem: pids&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# tail -f /var/log/messages&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Apr 10 16:48:48 spark17 kubelet: E0410 16:48:48.871706   11041 qos_container_manager_linux.go:329] [ContainerManager]: Failed to update QoS cgroup configuration&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Apr 10 16:48:48 spark17 kubelet: W0410 16:48:48.871726   11041 qos_container_manager_linux.go:139] [ContainerManager] Failed to reserve QoS requests: failed to set supported cgroup subsystems for cgroup [kubepods burstable]: Failed to find subsystem mount for required subsystem: pids&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# kubectl describe node spark17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Events:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Type     Reason                            Age                     From              Message&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ----     ------                            ----                    ----              -------&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  Warning  FailedNodeAllocatableEnforcement  5m33s (x1741 over 31h)  kubelet, spark32  Failed to update Node Allocatable Limits [&amp;quot;kubepods&amp;quot;]: failed to set supported cgroup subsystems for cgroup [kubepods]: Failed to find subsystem mount for required subsystem: pids&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;查看当前系统支持哪些subsystem：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# cat /proc/cgroups&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#subsys_name    hierarchy       num_cgroups     enabled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cpuset  5       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cpu     4       104     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cpuacct 4       104     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;memory  6       104     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;devices 3       104     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;freezer 2       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;net_cls 8       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;blkio   9       104     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;perf_event      10      11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;hugetlb 7       11      1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;发现并不支持pids。&lt;/p&gt;
&lt;p&gt;查看当前系统内核：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# uname -r&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3.10.0-327.el7.x86_64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# grep CGROUP_ /boot/config-3.10.0-327.el7.x86_64   &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# CONFIG_CGROUP_DEBUG is not set&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CONFIG_CGROUP_FREEZER=y&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CONFIG_CGROUP_DEVICE=y&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CONFIG_CGROUP_CPUACCT=y&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CONFIG_CGROUP_HUGETLB=y&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CONFIG_CGROUP_PERF=y&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CONFIG_CGROUP_SCHED=y&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;升级内核，经过测试，在CentOS 7.4默认的内核为3.10.0-514.26.2.el7.x86_64，默认是开启了pids subsystem，我这边使用yum升级内核为 3.10.0-957.el7.x86_64&lt;br&gt;查看仓库里有哪些版本的内核，并安装：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# yum list kernel.x86_64 --showduplicates | sort -r&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * updates: ap.stykers.moe&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Loading mirror speeds from cached hostfile&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Loaded plugins: fastestmirror, langpacks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kernel.x86_64                   3.10.0-957.el7                         base     &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kernel.x86_64                   3.10.0-957.5.1.el7                     updates  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kernel.x86_64                   3.10.0-957.1.3.el7                     updates  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kernel.x86_64                   3.10.0-957.10.1.el7                    updates  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;kernel.x86_64                   3.10.0-327.el7                         @anaconda&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Installed Packages&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * extras: mirrors.huaweicloud.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * epel: mirrors.aliyun.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * elrepo: mirrors.tuna.tsinghua.edu.cn&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; * base: ap.stykers.moe&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Available Packages&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# yum install kernel-3.10.0-957.el7.x86_64 -y&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;由于CentOS 7使用grub2作为引导程序 ，所以和CentOS 6有所不同，并不是修改/etc/grub.conf来修改启动项，需要如下操作：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# cat /boot/grub2/grub.cfg |grep menuentry  ##查看有哪些内核选项&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if [ x&amp;quot;$&amp;#123;feature_menuentry_id&amp;#125;&amp;quot; = xy ]; then&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  menuentry_id_option=&amp;quot;--id&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  menuentry_id_option=&amp;quot;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;export menuentry_id_option&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;menuentry &amp;apos;CentOS Linux (3.10.0-957.el7.x86_64) 7 (Core)&amp;apos; --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option &amp;apos;gnulinux-3.10.0-327.el7.x86_64-advanced-7787952f-c2d4-4216-ae09-5188e7fd88b8&amp;apos; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;menuentry &amp;apos;CentOS Linux (3.10.0-327.el7.x86_64) 7 (Core)&amp;apos; --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option &amp;apos;gnulinux-3.10.0-327.el7.x86_64-advanced-7787952f-c2d4-4216-ae09-5188e7fd88b8&amp;apos; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;menuentry &amp;apos;CentOS Linux (0-rescue-d918a8d2df0e481a820b4e5554fed3b5) 7 (Core)&amp;apos; --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option &amp;apos;gnulinux-0-rescue-d918a8d2df0e481a820b4e5554fed3b5-advanced-7787952f-c2d4-4216-ae09-5188e7fd88b8&amp;apos; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# grub2-editenv list   #查看默认启动内核&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# shutdown -r now&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;重启后，查看内核版本，并查看是否支持pids subsystem。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# uname -r&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3.10.0-957.el7.x86_64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@spark17 ~]# cat /proc/cgroups&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#subsys_name    hierarchy       num_cgroups     enabled&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cpuset  5       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cpu     4       110     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cpuacct 4       110     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;memory  3       110     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;devices 6       110     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;freezer 7       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;net_cls 2       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;blkio   10      110     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;perf_event      8       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;hugetlb 9       11      1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pids    11      110     1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;net_prio        2       11      1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;此时已经支持了pids subsystem，查看kubelet已经不报错了&lt;/p&gt;
&lt;h3 id=&quot;apiserver疯狂刷日志：OpenAPI-AggregationController-Processing-item-k8s-internal-local-delegation-chain-0000000001&quot;&gt;&lt;a href=&quot;#apiserver疯狂刷日志：OpenAPI-AggregationController-Processing-item-k8s-internal-local-delegation-chain-0000000001&quot; class=&quot;headerlink&quot; title=&quot;apiserver疯狂刷日志：OpenAPI AggregationController: Processing item k8s_internal_local_delegation_chain_0000000001&quot;&gt;&lt;/a&gt;apiserver疯狂刷日志：OpenAPI AggregationController: Processing item k8s_internal_local_delegation_chain_0000000001&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# kubectl logs -f kube-apiserver-spark32 -n kube-system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;I0411 12:01:07.724117       1 controller.go:102] OpenAPI AggregationController: Processing item k8s_internal_local_delegation_chain_0000000001&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;I0411 12:01:07.724291       1 controller.go:102] OpenAPI AggregationController: Processing item k8s_internal_local_delegation_chain_0000000002&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;疯狂的刷这两行日志。。。&lt;br&gt;网上查了在1.14.0版本上确实有人遇到这样的情况，见kubernetes issue：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;https://github.com/kubernetes/kubernetes/issues/75777&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes/pull/75781，说会在1.14.1版本里修复。去查了下1.14.1的CHANGELOG，上面写了已经修复了这个bug：&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/kubernetes/kubernetes/pull/75781，说会在1.14.1版本里修复。去查了下1.14.1的CHANGELOG，上面写了已经修复了这个bug：&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/36.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;但如今装的是1.14.0版本，只能尝试着降低apiserver这个组件的日志级别。基本上每个 kubernetes 组件都会有个通用的参数 –v；这个参数用于控制 kubernetes 各个组件的日志级别。官方关于apiserver命令行文档：&lt;a href=&quot;https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/，里面可以看到有个关于日志级别的选项：&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/，里面可以看到有个关于日志级别的选项：&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;-v, --v Level&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    number for the log level verbosity&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;关于Kubernetes组件输出日志级别说明：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/logging.md&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;kubeadm init在初始化master节点的时候生成了apiserver组件的manifests，在 /etc/kubernetes/manifests/ 目录下。修改文件kube-apiserver.yaml：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# vim kube-apiserver.yaml&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/34.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;然后重启kubelet，在重启之前我们先查看当前集群的pod，注意apiserver这个pod的运行时间，等会重启kubelet之后，在运行查询pod的命令，会发现apiserver的运行时间改了，其实是kubelet检测到了kube-apiserver的manifest文件改变了，于是重新生成了pod。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@spark32 manifests]# systemctl restart kubelet&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Kubernetes/35.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;再去查看apiserver pod的日志，就发现没那么多输出了。&lt;br&gt;【说明】：&lt;br&gt;1.静态pod(DaemonSet)在特定的节点上直接通过 kubelet 守护进程进行管理，API 服务无法管理。它没有跟任何的副本控制器进行关联，kubelet 守护进程对它进行监控，如果崩溃了，kubelet 守护进程会重启它。Kubelet 通过 Kubernetes API 服务为每个静态 pod 创建 镜像 pod，这些镜像 pod 对于 API 服务是可见的，但是不受它控制。&lt;br&gt;2.&lt;a href=&quot;https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/#init-workflow&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;kubeadm init workflow&lt;/a&gt;里面有一句：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Static Pod manifests are written to /etc/kubernetes/manifests; the kubelet watches this directory for Pods to create on startup.&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;之前采用二进制方式部署过Kubernetes，操作较为繁琐，此次采用kubeadm安装Kubernetes，Kubernetes相关组件介绍详见前面的文章。
    
    </summary>
    
      <category term="容器编排" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/"/>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>访问https，抓包是明文的</title>
    <link href="http://yoursite.com/2019/03/25/%E8%AE%BF%E9%97%AEhttps%EF%BC%8C%E6%8A%93%E5%8C%85%E6%98%AF%E6%98%8E%E6%96%87%E7%9A%84/"/>
    <id>http://yoursite.com/2019/03/25/访问https，抓包是明文的/</id>
    <published>2019-03-25T02:29:21.000Z</published>
    <updated>2019-05-15T03:11:51.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;Nginx启用了https，但是测试部门在使用fiddler工具抓包时，发现能抓到用户账号和密码。但是我自己在服务端用tcpdump抓包却抓不到明文账号和密码。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;现象&quot;&gt;&lt;a href=&quot;#现象&quot; class=&quot;headerlink&quot; title=&quot;现象&quot;&gt;&lt;/a&gt;现象&lt;/h2&gt;&lt;p&gt;测试反馈的问题：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/37.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;解释&quot;&gt;&lt;a href=&quot;#解释&quot; class=&quot;headerlink&quot; title=&quot;解释&quot;&gt;&lt;/a&gt;解释&lt;/h2&gt;&lt;p&gt;测试人员是在本地打开fiddler工具抓包，同时打开本地浏览器，输入应用地址，然后输入用户账号和密码，然后点击登录。在这个操作过程中，其实fiddler把测试人员输入账号和密码也给录制下来了，是客户端上传的明文账号和密码，因此也看到了明文账号和密码。这个看到的账号密码并不是https传输过程中看到的账号名和密码。&lt;br&gt;密文是针对https两端以外其他路径而言，作为https链接的两端，自然可以看到明文。这就好比，你自己打开一个网站，然后输入用户名和密码，你的朋友在你旁边看着你输入账号和密码，他是肯定能看见明文账号和密码的。&lt;br&gt;Https保证的是传输过程中第三方抓包看到的是密文。客户端和服务端，无论如何都可以拿到明文。在自己本地抓包不能说明什么。&lt;/p&gt;
&lt;h2 id=&quot;示例&quot;&gt;&lt;a href=&quot;#示例&quot; class=&quot;headerlink&quot; title=&quot;示例&quot;&gt;&lt;/a&gt;示例&lt;/h2&gt;&lt;p&gt;以&lt;a href=&quot;https://gitee.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;码云&lt;/a&gt; 网站为例，不需要抓包工具，打开F12就可以看到明文账号和密码。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/38.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/39.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;更合理办法&quot;&gt;&lt;a href=&quot;#更合理办法&quot; class=&quot;headerlink&quot; title=&quot;更合理办法&quot;&gt;&lt;/a&gt;更合理办法&lt;/h2&gt;&lt;p&gt;更安全的方式是，在写代码时，先将用户输入的账号和密码加密，然后再发到后台校验。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Nginx启用了https，但是测试部门在使用fiddler工具抓包时，发现能抓到用户账号和密码。但是我自己在服务端用tcpdump抓包却抓不到明文账号和密码。
    
    </summary>
    
      <category term="Nginx" scheme="http://yoursite.com/categories/Nginx/"/>
    
    
      <category term="Nginx" scheme="http://yoursite.com/tags/Nginx/"/>
    
      <category term="HTTPS" scheme="http://yoursite.com/tags/HTTPS/"/>
    
  </entry>
  
  <entry>
    <title>CentOS下安装字体不重启系统</title>
    <link href="http://yoursite.com/2019/03/22/CentOS%E4%B8%8B%E5%AE%89%E8%A3%85%E5%AD%97%E4%BD%93%E4%B8%8D%E9%87%8D%E5%90%AF%E7%B3%BB%E7%BB%9F/"/>
    <id>http://yoursite.com/2019/03/22/CentOS下安装字体不重启系统/</id>
    <published>2019-03-22T08:38:07.000Z</published>
    <updated>2019-03-22T09:05:46.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;代码在实现svg转png时，英文字符能正常显示，但是中文显示为方框。项目在大多数Linux系统上正常，今天在部署一个客户时出现乱码。仔细查看系统字体文件，发现没有中文字体。由于系统是客户那边自己装的，该系统安装时选择的是最小化安装，缺少字体库。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;现象&quot;&gt;&lt;a href=&quot;#现象&quot; class=&quot;headerlink&quot; title=&quot;现象&quot;&gt;&lt;/a&gt;现象&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Linux/1.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;安装中文字体uming-ttc&quot;&gt;&lt;a href=&quot;#安装中文字体uming-ttc&quot; class=&quot;headerlink&quot; title=&quot;安装中文字体uming.ttc&quot;&gt;&lt;/a&gt;安装中文字体uming.ttc&lt;/h2&gt;&lt;p&gt;找一个有该字体的操作系统，&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# cd /usr/share/fonts/
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;在这个目录下，有一个目录cjkuni-uming，这个目录下就有字体uming.ttc，将这个cjkuni-uming复制到缺少字体的系统的/usr/share/fonts/目录下。&lt;/p&gt;
&lt;p&gt;然后在系统上刷新字体缓存，&lt;strong&gt;不需要重启Linux。&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# fc-cache -f -v
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;如果没有这个命令，需要安装下：yum install -y fontconfig&lt;/p&gt;
&lt;p&gt;刷新缓存后重启下我们的项目，在做转换时，乱码就没了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;代码在实现svg转png时，英文字符能正常显示，但是中文显示为方框。项目在大多数Linux系统上正常，今天在部署一个客户时出现乱码。仔细查看系统字体文件，发现没有中文字体。由于系统是客户那边自己装的，该系统安装时选择的是最小化安装，缺少字体库。
    
    </summary>
    
      <category term="Linux" scheme="http://yoursite.com/categories/Linux/"/>
    
    
      <category term="乱码" scheme="http://yoursite.com/tags/%E4%B9%B1%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>Nginx缓存功能</title>
    <link href="http://yoursite.com/2019/03/14/Nginx%E7%BC%93%E5%AD%98%E5%8A%9F%E8%83%BD/"/>
    <id>http://yoursite.com/2019/03/14/Nginx缓存功能/</id>
    <published>2019-03-14T05:27:37.000Z</published>
    <updated>2019-03-14T07:38:54.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;业务线在压测性能时，希望将应用一些图标(appIcon.do)利用Nginx缓存功能缓存下来。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Nginx缓存功能&quot;&gt;&lt;a href=&quot;#Nginx缓存功能&quot; class=&quot;headerlink&quot; title=&quot;Nginx缓存功能&quot;&gt;&lt;/a&gt;Nginx缓存功能&lt;/h2&gt;&lt;p&gt;简单来说，就是Nginx将后端服务器返回来的部分内容缓存到本地磁盘，后面客户端请求中含有这部分内容时，可以从本地磁盘取出这些内容返回给客户端。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;如果Nginx本地没有缓存时，那么响应给客户端的过程是：被代理服务器先得自己磁盘IO一次，将内容取出，然后将内容通过网络IO响应给Nginx，Nginx然后在将该内容响应给客户端。&lt;br&gt;如果Nginx在本地缓存下这部分内容，当用户请求到达时，如果请求的内容中包含这些，Nginx直接从自己本地磁盘取得内容，构建响应报文，响应给客户端。&lt;br&gt;在后端服务器上(被代理服务器上)，磁盘上文件是按树状结构组织的，按照文件名、按照路径去组织的。我们去查找文件时，只能把整个树状结构，就是把document_root所指向的子目录，整体装入内存。将来我们找哪个文件时，才会知道这个文件在哪个路径下，能快速定位到这个文件。&lt;br&gt;Nginx缓存是这么处理的：存储也是树状结构，但是这种树状结构格式很独特，名字是固定等级的，要么是一级路径，要么是两级路径，要么是三级路径。而且每一级路径的文件的名字是hash码的一部分，要么是两个字符，要么是1个字符，因此直接基于用户请求url的字符串，就能知道这个文件在什么地方存放的。因为缓存下来的文件名是用户请求资源的url字符串的hash码，内容是那个请求页面的正常内容。&lt;br&gt;&lt;strong&gt;当用户请求url时，如何判定本地缓存有没有呢？&lt;/strong&gt;像后端服务器就只能遍历，去找树状结构路径下是不是存在。但是对于hash格式来讲，它实际上是基于路由方式来实现。对Nginx而言，通常是这么找的。把这个url编码以后，从右往左截取字符，完成路径路由。因为是16进制的，有1个字符，就有16种变化，有两个字符，就是256种变化，最多不超过3级。如果你的缓存定义分级路径是1:1:2，意味着1级子目录16个，就是说用1个字符来表示， 2级目录16个(指的是1个1级子目录下有16个)，此时一共是256个，3级子目录，每个子目录有256个，每个子目录2个字符。所以从编码后的url截取字符，从右往左，截1个字符表示1级子目录，在截一个字符表示2级子目录，在截两个字符，表示3级子目录。所以Nginx去找文件的时候，直接在url路径上就这个文件在哪个路径下了。当到第三级子目录下，底下的文件肯定不止1个，有一堆，这时候就得遍历去寻找要匹配的文件了。&lt;br&gt;对于Nginx缓存来讲，它的数据存储分为两个部分，第一部分是放在内存中的hash表，以便于一个url请求来的时候，做hash计算后去查表。如果hash表中没有，就不会去缓存在本地文件系统磁盘里找这个文件了。所以有没有命中在内存中就能判断了。第二部分是放在本地磁盘上的目录结构，一旦有，就路由到那个目录下，那个数据就在那。所以这个查找过程速度无与伦比，第一基于内存，第二它是hash值，时间O(1)，恒定，从100个中找1个和在100万中找一个所需要的时间几乎是等同的。 &lt;/p&gt;
&lt;h2 id=&quot;使用Nginx缓存&quot;&gt;&lt;a href=&quot;#使用Nginx缓存&quot; class=&quot;headerlink&quot; title=&quot;使用Nginx缓存&quot;&gt;&lt;/a&gt;使用Nginx缓存&lt;/h2&gt;&lt;p&gt;缓存空间得先定义，后使用。比如说在内存中用哪段空间来存hash表，用多大内存。磁盘上用哪段文件路径来存放目录树。&lt;br&gt;查缓存也有讲究，http的请求方法有GET、HEAD、POST、PUT、DELETE，后3种方法没必要查缓存。因此对每一种请求过来，我们先判定方法，这个方法如果不支持从缓存里找，就不用看缓存了。一般只对GET和HEAD启用缓存。&lt;br&gt;而且并不是所有GET和HEAD的资源都应该缓存。如果用户GET一个资源的时候， 用户第一次来访问时，服务器setcookie，这个就不应该缓存下来。还有一种场景，用户去请求一些资源时，服务器要求输入用户名和密码，这些内容也不应该缓存。因此不是GET和HEAD的所有资源都要缓存的，对于用户的私有信息，不应该缓存下来。&lt;br&gt;还有一些服务器端在响应时就说了，有些资源不能缓存，告诉代理服务器不能缓存，代理服务器也不应该缓存。服务器在响应时，为了避免代理服务器缓存下来，会告诉代理服务器这些资源是no store，基于cache control来定义。&lt;br&gt;浏览器是可以使用shift+f5强刷的，强制刷新就要求发请求报文时，no cache，意思是不能从缓存中给我响应。&lt;br&gt;再考虑一种场景，第一个用户请求资源时使用的是http 1.1的协议，取得的内容被Nginx缓存下来了。第二个用户使用http 1.0的协议去请求了，它两也不一定能完全兼容。所以还得考虑协议版本。协议版本不一样时，没准也不能使用缓存来响应。&lt;br&gt;缓存空间是有限的，存满了，这就需要cache_manager进程了，根据LRU(最近最少使用算法)将此前没有用的缓存对象清除出去。&lt;/p&gt;
&lt;h2 id=&quot;缓存指令&quot;&gt;&lt;a href=&quot;#缓存指令&quot; class=&quot;headerlink&quot; title=&quot;缓存指令&quot;&gt;&lt;/a&gt;缓存指令&lt;/h2&gt;&lt;p&gt;Nginx缓存指令说明：&lt;a href=&quot;http://nginx.org/en/docs/http/ngx_http_proxy_module.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://nginx.org/en/docs/http/ngx_http_proxy_module.html&lt;/a&gt;&lt;br&gt;缓存相关的有多个指令，proxy_cache打头的。缓存得先定义，后使用。下面来介绍一些常用的关于缓存方面的指令。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;定义缓存：&lt;/strong&gt;path [levels=levels] 这个目录下分几级子目录，每一级用几个字符来表示。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Syntax:	proxy_cache_path path [levels=levels] [use_temp_path=on|off] keys_zone=name:size [inactive=time] [max_size=size] [manager_files=number] [manager_sleep=time] [manager_threshold=time] [loader_files=number] [loader_sleep=time] [loader_threshold=time] [purger=on|off] [purger_files=number] [purger_sleep=time] [purger_threshold=time];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Default:	—&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Context:	http&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;比如：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/29.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;缓存内容，是按需创建目录的。而不是一开始把所有目录都创建出来。现在只是把缓存定义了，还没调用。上面定义的目录/data/nginx/需要事先创建好。&lt;br&gt;&lt;strong&gt;调用缓存指令：&lt;/strong&gt;&lt;br&gt;对于调用缓存来讲，至少需要3个参数。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;首先得声明调用(proxy_cache指令)，使用哪块缓存空间。(实践过了，如果之定义这一条指令，没有任何东西会被缓存下来)&lt;/li&gt;
&lt;li&gt;缓存时把什么当key，这也是是必须要给的。proxy_cache_key&lt;/li&gt;
&lt;li&gt;哪些内容能存，存多长时间得自己来定义。哪些东西不能存，哪些方法不检查缓存也得自己定义，虽然你不定义有默认值，但是也得定义出来 proxy_cache_methods、proxy_cache_valid&lt;br&gt;比如：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/30.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;其中最后一项配置解释下：&lt;br&gt;如果我们把内容缓存下来以后，后端服务器找不着了，也就是后端服务器不在线了，此时能不能用缓存内容来响应。也就是指明什么情况下可以使用过期的缓存来响应。比如后端服务器响应error，后端服务器连不上timeout&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;缓存实例&quot;&gt;&lt;a href=&quot;#缓存实例&quot; class=&quot;headerlink&quot; title=&quot;缓存实例&quot;&gt;&lt;/a&gt;缓存实例&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;【实例】：Nginx实现缓存图标&lt;/strong&gt;&lt;br&gt;先创建缓存目录：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mkdir /opt/nginx_cache
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;定义缓存：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/32.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;使用缓存：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/31.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;重载Nginx。此时缓存目录/opt/nginx_cache/first/目录下没有任何内容。&lt;/p&gt;
&lt;p&gt;浏览器访问，打开F12查看：&lt;br&gt;第一次访问时，都是MISS。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/33.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;此时查看opt/nginx_cache/first/目录下&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/34.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/36.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;再次刷新页面，就可以看到是命中了。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/35.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;业务线在压测性能时，希望将应用一些图标(appIcon.do)利用Nginx缓存功能缓存下来。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Nginx缓存功能&quot;&gt;&lt;a href=&quot;#Nginx缓存功能&quot; class=&quot;headerlink&quot; title=&quot;Nginx缓存功能&quot;&gt;&lt;/a&gt;Nginx缓存功能&lt;/h2&gt;&lt;p&gt;简单来说，就是Nginx将后端服务器返回来的部分内容缓存到本地磁盘，后面客户端请求中含有这部分内容时，可以从本地磁盘取出这些内容返回给客户端。
    
    </summary>
    
      <category term="Nginx" scheme="http://yoursite.com/categories/Nginx/"/>
    
    
      <category term="Nginx" scheme="http://yoursite.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>Nginx如何处理一个请求</title>
    <link href="http://yoursite.com/2019/03/06/Nginx%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E4%B8%80%E4%B8%AA%E8%AF%B7%E6%B1%82/"/>
    <id>http://yoursite.com/2019/03/06/Nginx如何处理一个请求/</id>
    <published>2019-03-06T06:24:10.000Z</published>
    <updated>2019-03-06T07:32:54.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;今天在配置Nginx多个虚拟主机的时候，发现一个问题，访问一个虚拟主机里的资源，结果却访问到了另外一个虚拟主机中的资源，赶紧去看看了官方文档，补补知识，在此记录一下Nginx是如何选定由哪个虚拟主机去处理请求的。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;问题及现象&quot;&gt;&lt;a href=&quot;#问题及现象&quot; class=&quot;headerlink&quot; title=&quot;问题及现象&quot;&gt;&lt;/a&gt;问题及现象&lt;/h2&gt;&lt;p&gt;由于公司应用较多，所以单独选择了一个地方存放应用的Nginx配置文件，在Nginx主配置文件中引入这个路径的配置文件就可以了。&lt;br&gt;在配置某个应用程序(rsfw_origin.conf)需要临时支持下https的时候，要求关闭http，只允许https。于是复制该应用配置文件为一个名字(rsfw_https.conf)，修改新配置文件里的一些与原有配置文件冲突的命名，比如upstream_server的名字等。并且关闭了http，只开启了https。两个配置文件内容大体如下：&lt;br&gt;&lt;strong&gt;rsfw_https.conf&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;server &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    listen       443;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server_name  rsfw.wisedu.com;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ssl on;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    #证书和私钥&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ssl_certificate /opt/ssl/rsfw.crt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ssl_certificate_key /opt/ssl/rsfw.key;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    access_log  logs/gemini.access.log gemini;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    location  /test &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    proxy_set_header  Host             $host;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    proxy_set_header  X-Real-IP        $remote_addr;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    proxy_set_header REMOTE-HOST $remote_addr;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    proxy_redirect http:// https://;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    proxy_pass http://rsfw_server;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;rsfw_origin.conf&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;server &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    listen       80;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server_name  testdt.wisedu.com;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    access_log  logs/rsfw_adapter.access.log rsfw_origin;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    location / &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        root   html;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        index  index.html index.htm;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    location  /test &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                proxy_set_header  Host             $host;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                proxy_set_header  X-Real-IP        $remote_addr;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                proxy_set_header REMOTE-HOST $remote_addr;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                proxy_pass http://rsfw_server_origin;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后浏览器访问：&lt;strong&gt;https:&lt;/strong&gt;//rsfw.wisedu.com/test/sys/emaphome/portal/index.do&lt;br&gt;输入用户名密码登录认证，没有问题。&lt;br&gt;接着浏览器访问：&lt;strong&gt;http:&lt;/strong&gt;//rsfw.wisedu.com/test/sys/emaphome/portal/index.do&lt;br&gt;我原以为应该是访问不了，结果竟然还跳到了登录页面。两个虚拟主机，我访问其中一个虚拟主机下的资源，怎么会跳到另外一个虚拟主机下寻找资源呢？(两个虚拟主机下都有location /test)&lt;br&gt;查看nginx的error.log，发现是&lt;strong&gt;server: testdt.wisedu.com&lt;/strong&gt;这台虚拟主机响应了请求(看下面的server：testdt.wisedu.com)：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;2019/03/06 14:52:29 [warn] 3754#0: *1624 an upstream response is buffered to a temporary file /usr/local/openresty/nginx/proxy_temp/2/09/0000000092 while reading upstream, client: 172.20.5.15, server: testdt.wisedu.com, request: &amp;quot;GET /test/sys/emapfunauth/pages/funauth-login/images/login_bg.jpg HTTP/1.1&amp;quot;, upstream: &amp;quot;http://172.16.7.78:8003/test/sys/emapfunauth/pages/funauth-login/images/login_bg.jpg&amp;quot;, host: &amp;quot;rsfw.wisedu.com&amp;quot;, referrer: &amp;quot;http://rsfw.wisedu.com/test/sys/emapfunauth/pages/funauth-login/funauth-login.css&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;由此可见，Nginx对于使用哪个虚拟主机来处理用户请求应该有自己的一套规则，于是赶紧去官方文档找找资料。&lt;/p&gt;
&lt;h2 id=&quot;原因及解决&quot;&gt;&lt;a href=&quot;#原因及解决&quot; class=&quot;headerlink&quot; title=&quot;原因及解决&quot;&gt;&lt;/a&gt;原因及解决&lt;/h2&gt;&lt;p&gt;官方文档：&lt;a href=&quot;http://nginx.org/en/docs/http/request_processing.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://nginx.org/en/docs/http/request_processing.html&lt;/a&gt;&lt;br&gt;中文文档：&lt;a href=&quot;https://tengine.taobao.org/nginx_docs/cn/docs/http/request_processing.html#how_to_prevent_undefined_server_names&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://tengine.taobao.org/nginx_docs/cn/docs/http/request_processing.html#how_to_prevent_undefined_server_names&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;总结一下，就是nginx会检测请求中的port是否匹配某个server配置块中listen指令，接着nginx继续测试请求的Host头是否匹配这个server块中的某个server_name的值。&lt;br&gt;如果主机名没有找到，nginx将把这个请求交给默认虚拟主机处理。第一个被列出的虚拟主机即nginx的默认虚拟主机——这是nginx的默认行为。而且，可以显式地设置某个主机为默认虚拟主机，即在”listen”指令中设置”default_server”参数：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;server &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    listen      80 default_server;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    server_name test.wisedu.com;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在上面的例子中，由于rsfw_https.conf中的虚拟主机监听在了443端口，所以当我浏览器访问&lt;strong&gt;http:&lt;/strong&gt;//rsfw.wisedu.com/test/sys/emaphome/portal/index.do，不会被rsfw_https.conf中的虚拟主机rsfw.wisedu.com匹配到，于是交到了监听80端口的默认虚拟主机testdt.wisedu.com。&lt;/p&gt;
&lt;p&gt;接着做个实验，重新写一个配置文件，同时手动指定默认虚拟主机。新建一个配置文件wisedu_fe.conf，在其中加上default_server配置，如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;server &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        listen       80 default_server;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        server_name  ressignal.wisedu.com;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        access_log  logs/res.access.log res;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        location / &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            root   /opt/wisedu_fe/ver;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            index  index.html index.htm;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            add_header Access-Control-Allow-Origin *;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;加了default_server，这台新的虚拟主机就成为了默认虚拟主机。重载Nginx配置文件。&lt;br&gt;浏览器输入&lt;strong&gt;http:&lt;/strong&gt;//rsfw.wisedu.com/test/sys/emaphome/portal/index.do&lt;br&gt;结果：浏览器显示404，而不在登录界面了。&lt;br&gt;error.log日志：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;2019/03/06 15:28:53 [error] 4208#0: *4204 open() &amp;quot;/opt/wisedu_fe/ver/test/sys/emaphome/portal/index.do&amp;quot; failed (2: No such file or directory), client: 172.20.5.15, server: ressignal.wisedu.com, request: &amp;quot;GET /test/sys/emaphome/portal/index.do HTTP/1.1&amp;quot;, host: &amp;quot;rsfw.wisedu.com&amp;quot;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;相应的server也变为了&lt;strong&gt;server: ressignal.wisedu.com&lt;/strong&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;今天在配置Nginx多个虚拟主机的时候，发现一个问题，访问一个虚拟主机里的资源，结果却访问到了另外一个虚拟主机中的资源，赶紧去看看了官方文档，补补知识，在此记录一下Nginx是如何选定由哪个虚拟主机去处理请求的。
    
    </summary>
    
      <category term="Nginx" scheme="http://yoursite.com/categories/Nginx/"/>
    
    
      <category term="Nginx" scheme="http://yoursite.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>记几次Nginx问题处理</title>
    <link href="http://yoursite.com/2018/12/10/%E8%AE%B0%E5%87%A0%E6%AC%A1Nginx%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"/>
    <id>http://yoursite.com/2018/12/10/记几次Nginx问题处理/</id>
    <published>2018-12-10T02:38:00.000Z</published>
    <updated>2018-12-10T07:32:14.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;这几天遇到几个Nginx相关问题，处理完记录一下。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;前端资源无法加载&quot;&gt;&lt;a href=&quot;#前端资源无法加载&quot; class=&quot;headerlink&quot; title=&quot;前端资源无法加载&quot;&gt;&lt;/a&gt;前端资源无法加载&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;1.问题现象和排查&lt;/strong&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;客户反应浏览器访问应用，整个页面显示空白，开启浏览器F12发现很多前端资源报错误&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ERR_CONTENT_LENGTH_MISMATCH
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/27.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;查看Nginx error.log，发现竟然没有日志写入，于是立马查看磁盘空间，发现磁盘空间已满。检查发现是Nginx日志文件占用了很大的空间，应该是公司运维部门同事在安装时没有做日志切割策略，先解决问题。&lt;br&gt;先删除几个大的日志文件，然后reload nginx，但是发现磁盘空间并没有释放掉。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.解决&lt;/strong&gt;&lt;br&gt;一般说来不会出现删除文件后空间不释放的情况，但是也存在例外，比如文件被进程锁定，或者有进程一直在向这个文件写数据等等。&lt;br&gt;这里有多个服务在用到error.log这个文件，所以导致磁盘空间一直未释放。由于服务允许短时间重启，于是重启下Nginx，磁盘空间就释放了，并且服务访问也恢复了正常。&lt;br&gt;解决完再做个日志切割。&lt;/p&gt;
&lt;h2 id=&quot;后端在获取前端样式中文乱码&quot;&gt;&lt;a href=&quot;#后端在获取前端样式中文乱码&quot; class=&quot;headerlink&quot; title=&quot;后端在获取前端样式中文乱码&quot;&gt;&lt;/a&gt;后端在获取前端样式中文乱码&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;1.问题现象和排查&lt;/strong&gt;&lt;br&gt;公司前端css里会写一些字体样式，后端在引用时会偶尔出现中文乱码现象。F12查看时，发现css和js的response的Content-Type中没有charset=UTF-8。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.解决&lt;/strong&gt;&lt;br&gt;Nginx response 的 Content-Type 添加 charset=UTF-8。&lt;br&gt;查看官方文档，有指令可以配置：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;charset UTF-8;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;但是配置完发现js的响应上，Content-Type 已经添加了 charset=UTF-8，但是css样式的响应并没有自动添加上。&lt;br&gt;仔细阅读官方文档，发现Nignx默认只在     &lt;/p&gt;
&lt;pre&gt;&lt;code&gt;charset_types text/html text/xml text/plain text/vnd.wap.wml application/javascript application/rss+xml;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这几个后面添加。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/28.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;所以需要添加两个配置：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;charset UTF-8;
charset_types text/html text/xml text/plain text/vnd.wap.wml application/javascript application/rss+xml text/css;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这两个我配置在http段，然后重载Nginx，就生效了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;这几天遇到几个Nginx相关问题，处理完记录一下。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;前端资源无法加载&quot;&gt;&lt;a href=&quot;#前端资源无法加载&quot; class=&quot;headerlink&quot; title=&quot;前端资源无法加载&quot;&gt;&lt;/a&gt;前端资源无法加载&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;1.问题现象和排查&lt;/strong&gt;
    
    </summary>
    
      <category term="Nginx" scheme="http://yoursite.com/categories/Nginx/"/>
    
    
      <category term="Nginx" scheme="http://yoursite.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins+Ant自动化</title>
    <link href="http://yoursite.com/2018/12/04/jenkins-Ant%E8%87%AA%E5%8A%A8%E5%8C%96/"/>
    <id>http://yoursite.com/2018/12/04/jenkins-Ant自动化/</id>
    <published>2018-12-04T07:25:04.000Z</published>
    <updated>2018-12-04T08:46:56.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;最近需要帮部门一个ant项目做持续集成和发布，该项目有9个svn地址，还有比较多的依赖，踩了不少坑，搞完记录下。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;安装JDK-8&quot;&gt;&lt;a href=&quot;#安装JDK-8&quot; class=&quot;headerlink&quot; title=&quot;安装JDK 8&quot;&gt;&lt;/a&gt;安装JDK 8&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;# mkdir /usr/java
# tar zxf /usr/local/jdk-8u73-linux-x64.gz -C /usr/java/
# vim /etc/profile
export JAVA_HOME=/usr/java/jdk1.8.0_73
export PATH=$JAVA_HOME/bin:$PATH
export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
# source /etc/profile
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;安装Ant&quot;&gt;&lt;a href=&quot;#安装Ant&quot; class=&quot;headerlink&quot; title=&quot;安装Ant&quot;&gt;&lt;/a&gt;安装Ant&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;[root@res local]# wget http://mirror.bit.edu.cn/apache//ant/binaries/apache-ant-1.10.5-bin.zip
[root@res local]# unzip -oq apache-ant-1.10.5-bin.zip 
[root@res local]# ln -sv apache-ant-1.10.5 ant
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;Jenkins配置SVN地址&quot;&gt;&lt;a href=&quot;#Jenkins配置SVN地址&quot; class=&quot;headerlink&quot; title=&quot;Jenkins配置SVN地址&quot;&gt;&lt;/a&gt;Jenkins配置SVN地址&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;1.配置svn账号密码&lt;/strong&gt;&lt;br&gt;输入Jenkins访问地址，在首页左侧菜单有个“Credentials”，点击进去。在点击左侧菜单“Credentials”下的“System”，再点击右侧正文的“Global credentials (unrestricted)”。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/6.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;点击左侧菜单的“Add Credentials”，输入svn的账号密码，顺便添加一些描述信息。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/7.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.配置svn地址&lt;/strong&gt;&lt;br&gt;找到对应的项目，点击“配置”，点击“源码管理”，选择“Subversion”。输入9个项目的svn地址。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/8.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;需要注意的时，每个项目需要给它指定一个目录。否则最后一个项目拉下来的代码会把之前的代码全部覆盖掉。&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;外部依赖&quot;&gt;&lt;a href=&quot;#外部依赖&quot; class=&quot;headerlink&quot; title=&quot;外部依赖&quot;&gt;&lt;/a&gt;外部依赖&lt;/h2&gt;&lt;p&gt;由于需要很多外部jar包和其它的一些应用，所以必须在Jenkins服务器上创建并放好这些依赖。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/9.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/10.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;另外还需要创建ant编译时用到一些目录&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@res opt]# mkdir -p /opt/emap_build_workspace/out
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;编写build-xml文件&quot;&gt;&lt;a href=&quot;#编写build-xml文件&quot; class=&quot;headerlink&quot; title=&quot;编写build.xml文件&quot;&gt;&lt;/a&gt;编写build.xml文件&lt;/h2&gt;&lt;p&gt;build.xml文件内容如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;80&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;81&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;82&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;83&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;84&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;85&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;86&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;87&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;88&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;89&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;90&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;91&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;92&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;93&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;94&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;95&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;96&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;97&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;98&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;99&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;100&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;101&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;102&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;103&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;104&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;105&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;106&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;107&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;108&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;109&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;110&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;111&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;112&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;113&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;114&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;115&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;116&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;117&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;118&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;119&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;120&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;121&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;122&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;123&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;124&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;125&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;126&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;127&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;128&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;129&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;130&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;131&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;132&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;133&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;134&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;135&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;136&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;137&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;138&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;139&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;140&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;141&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;142&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;143&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;144&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;145&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;146&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;147&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;148&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;149&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;150&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;151&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;152&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;153&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;154&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;155&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;156&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;157&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;158&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;159&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;160&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;161&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;162&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;163&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;164&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;165&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;166&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;167&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;168&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;169&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;170&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;171&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;172&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;173&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;174&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;175&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;176&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;177&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;178&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;179&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;180&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;181&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;182&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;183&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;184&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;185&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;186&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;187&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;188&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;189&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;190&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;191&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;192&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;193&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;194&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;195&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;196&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;197&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;198&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;199&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;200&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;201&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;202&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;203&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;204&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;205&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;206&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;207&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;208&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;209&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;210&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;211&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;212&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;213&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;214&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;215&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;216&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;217&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;218&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;219&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;220&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;221&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;222&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;223&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;224&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;225&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;226&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;227&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;228&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;229&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;230&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;231&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;232&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;233&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;234&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;235&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;236&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;237&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;238&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;239&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;240&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;241&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;242&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;243&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;244&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;245&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;246&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;247&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;248&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;249&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;250&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;251&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;252&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;253&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;254&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;255&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;256&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;257&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;258&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;259&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;260&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;261&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;262&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;263&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;264&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;265&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;266&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;267&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;268&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;269&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;270&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;271&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;272&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;273&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;274&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;275&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;276&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;277&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;278&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;279&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;280&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;281&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;282&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;283&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;284&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;285&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;286&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;287&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;288&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;289&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;290&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;291&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;292&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;293&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;294&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;295&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;296&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;297&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;298&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;299&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;300&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;301&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;302&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;303&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;304&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;305&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;306&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;307&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;308&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;309&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;310&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;311&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;312&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;313&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;314&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;315&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;316&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;317&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;318&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;319&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;320&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;321&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;322&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;323&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;324&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;325&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;326&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;327&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;328&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;329&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;330&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;331&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;332&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;333&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;334&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;335&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;336&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;337&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;338&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;339&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;340&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;341&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;342&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;343&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;344&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;345&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;346&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;347&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;348&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;349&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;350&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;351&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;352&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;353&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;354&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;355&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;356&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;357&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;358&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;359&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;360&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;361&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;362&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;363&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;364&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;365&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;366&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;367&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;368&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;369&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;370&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;371&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;372&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;373&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;374&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;375&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;376&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;377&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;378&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;379&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;380&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;381&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;382&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;383&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;384&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;385&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;386&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;387&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;388&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;389&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;390&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;391&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;392&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;393&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;394&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;395&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;396&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;397&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;398&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;399&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;400&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;401&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;402&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;403&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;404&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;405&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;406&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;407&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;408&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;409&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;410&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;411&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;412&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;413&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;414&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;415&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;416&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;417&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;418&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;419&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;420&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;421&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;422&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;423&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;424&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;425&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;426&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;427&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;428&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;429&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;430&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;431&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;432&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;433&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;434&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;435&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;436&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;437&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;438&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;439&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;440&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;441&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;442&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;443&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;444&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;445&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;446&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;447&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;448&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;449&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;450&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;451&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;452&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;453&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;454&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;455&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;456&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;457&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;458&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;459&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;460&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;461&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;462&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;463&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;464&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;465&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;466&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;467&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;468&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;469&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;470&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;471&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;472&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;473&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;474&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;475&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;476&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;477&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;478&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;479&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;480&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;481&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;482&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;483&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;484&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;485&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;486&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;487&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;488&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;489&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;490&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;491&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;492&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;493&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;494&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;495&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;496&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;497&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;498&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;499&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;500&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;501&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;502&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;503&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;504&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;505&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;506&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;507&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;508&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;509&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;510&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;511&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;512&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;513&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;514&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;515&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;516&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;517&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;518&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;519&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;520&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;521&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;522&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;523&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;524&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;525&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;526&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;527&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;528&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;529&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;530&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;531&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;532&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;533&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;534&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;535&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;536&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;537&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;538&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;539&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;540&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;541&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;542&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;543&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;544&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;545&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;546&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;547&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;548&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;549&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;550&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;551&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;552&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;553&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;554&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;555&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;556&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;557&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;558&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;559&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;560&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;561&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;562&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;563&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;564&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot; standalone=&amp;quot;no&amp;quot;?&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;project basedir=&amp;quot;.&amp;quot; default=&amp;quot;build&amp;quot; name=&amp;quot;publish_jar&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property environment=&amp;quot;env&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;debuglevel&amp;quot; value=&amp;quot;source,lines,vars&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;encoding&amp;quot; value=&amp;quot;UTF-8&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;out&amp;quot; value=&amp;quot;/opt/emap_build_workspace/out/out&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;out_tmp&amp;quot; value=&amp;quot;/opt/emap_build_workspace/out/out_tmp&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;out_pub_classes&amp;quot; value=&amp;quot;/opt/emap_build_workspace/out/out_tmp_pub&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;work_home&amp;quot; value=&amp;quot;/root/.jenkins/workspace/gemini&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;pedestal_home&amp;quot; value=&amp;quot;/opt/emap&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;base_home&amp;quot; value=&amp;quot;/opt/wiseduAppGroups&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;tomcat_home_lib&amp;quot; value=&amp;quot;/opt/emap&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;emapAuth_classes&amp;quot; value=&amp;quot;/opt/wiseduAppGroups/emapAuth/pub_classes&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;emapcomponent_classes&amp;quot; value=&amp;quot;/opt/wiseduAppGroups/emapcomponent/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;property name=&amp;quot;zipOut&amp;quot; value=&amp;quot;/opt/emap_build_workspace/out/out.zip&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;emap_prj_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;fileset dir=&amp;quot;$&amp;#123;base_home&amp;#125;/$BASE/lib/&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;include name=&amp;quot;*.jar&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;fileset dir=&amp;quot;$&amp;#123;base_home&amp;#125;/$BASE/ext&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;include name=&amp;quot;**/*.jar&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;fileset dir=&amp;quot;$&amp;#123;tomcat_home_lib&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;include name=&amp;quot;jsp-api.jar&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;include name=&amp;quot;servlet-api.jar&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;fileset dir=&amp;quot;$&amp;#123;pedestal_home&amp;#125;/WEB-INF/lib/&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;include name=&amp;quot;*.jar&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;current_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/lib/&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;include name=&amp;quot;*.jar&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;pub_class_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;emapAuth_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;emapAuth_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;emapcomponent_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;emapcomponent_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;emapsender_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;out&amp;#125;/emapsender/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;emapfunauth_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;out&amp;#125;/emapfunauth/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;emapflow_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;out&amp;#125;/emapflow/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;flowstatistics_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;out&amp;#125;/flowstatistics/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;eetablecore_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;out&amp;#125;/eetablecore/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;path id=&amp;quot;emapturing_lib&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;pathelement location=&amp;quot;$&amp;#123;out&amp;#125;/emapturing/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/path&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;cleanall&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build.1.5&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/pub_src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;pub_class_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;app_info.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;EMAP_APP&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;init.project&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;jdkv1.5&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target  name=&amp;quot;init&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_emapsender&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/emapsender&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapsender/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapsender/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/pub_src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/emapsender/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;pub_class_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapsender/pub_classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapsender&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;app_info.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;EMAP_APP&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_emaptaskcenter&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/emaptaskcenter&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emaptaskcenter/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/emaptaskcenter/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emaptaskcenter&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;app_info.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;EMAP_APP&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;web&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emaptaskcenter/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_emapflow&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/emapflow&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapflow/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapflow/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/pub_src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;current_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapAuth_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/emapflow/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;current_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapAuth_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;pub_class_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapflow&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;config/propertiesPanel.json&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapflow/pub_classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapflow/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_flowstatistics&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/flowstatistics&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/flowstatistics/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/flowstatistics/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/pub_src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/flowstatistics/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;pub_class_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/flowstatistics/pub_classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/flowstatistics&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/flowstatistics/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_emapturing&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/emapturing&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapturing/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapturing/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/pub_src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapcomponent_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/emapturing/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapcomponent_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;pub_class_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapturing&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapturing/pub_classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapturing/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_emapfunauth&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/emapfunauth&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapfunauth/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/emapfunauth/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/pub_src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapAuth_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapcomponent_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/emapfunauth/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapAuth_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapcomponent_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;pub_class_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapsender_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapfunauth&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapfunauth/pub_classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/emapfunauth/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_eetablecore&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/eetablecore&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/eetablecore/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/eetablecore/pub_classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/pub_src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapflow_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/eetablecore/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;pub_class_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapflow_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/eetablecore&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/eetablecore/pub_classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;include name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/eetablecore/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_eetablemanage&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/eetablemanage&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		 &amp;lt;!--前端编译打包--&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;exec executable=&amp;quot;/bin/sh&amp;quot; failonerror=&amp;quot;true&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &amp;lt;arg value=&amp;quot;-c&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &amp;lt;arg value=&amp;quot;/root/.jenkins/workspace/tgbuilder release $&amp;#123;out_tmp&amp;#125;/web/&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;lt;/exec&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/eetablemanage/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/eetablemanage/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;current_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapAuth_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapflow_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;eetablecore_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapfunauth_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emapturing_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;flowstatistics_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/eetablemanage&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/eetablemanage/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target name=&amp;quot;build_skylobby&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;work_home&amp;#125;/skylobby&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.*&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;.settings/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;pub_classes/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;build.xml&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;mkdir dir=&amp;quot;$&amp;#123;out&amp;#125;/skylobby/classes&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;javac debug=&amp;quot;true&amp;quot; debuglevel=&amp;quot;$&amp;#123;debuglevel&amp;#125;&amp;quot; destdir=&amp;quot;$&amp;#123;out&amp;#125;/skylobby/classes&amp;quot; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				encoding=&amp;quot;$&amp;#123;encoding&amp;#125;&amp;quot; source=&amp;quot;1.5&amp;quot; target=&amp;quot;1.5&amp;quot; includeantruntime=&amp;quot;on&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:unchecked&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;compilerarg value=&amp;quot;-Xlint:-options&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;src path=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;emap_prj_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;classpath refid=&amp;quot;eetablecore_lib&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/javac&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/skylobby&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;src/**&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;copy includeemptydirs=&amp;quot;false&amp;quot; todir=&amp;quot;$&amp;#123;out&amp;#125;/skylobby/classes&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;fileset dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;/src&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;**/*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.java&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;				&amp;lt;exclude name=&amp;quot;*.class&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			&amp;lt;/fileset&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;lt;/copy&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;target  name=&amp;quot;end&amp;quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;lt;delete dir=&amp;quot;$&amp;#123;out_tmp&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;lt;delete dir=&amp;quot;$&amp;#123;out_pub_classes&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          &amp;lt;zip destfile=&amp;quot;$&amp;#123;zipOut&amp;#125;/&amp;quot; basedir=&amp;quot;$&amp;#123;out&amp;#125;&amp;quot; /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &amp;lt;delete dir=&amp;quot;$&amp;#123;out&amp;#125;&amp;quot;/&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;!--&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target depends=&amp;quot;init.project,build.1.5&amp;quot; name=&amp;quot;build&amp;quot;&amp;gt;&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target depends=&amp;quot;init,build_emapsender,build_emapfunauth&amp;quot; name=&amp;quot;build&amp;quot;&amp;gt;&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	--&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;lt;target depends=&amp;quot;init,build_emapsender,build_emaptaskcenter,build_emapflow,build_flowstatistics,build_emapturing,build_emapfunauth,build_eetablecore,build_skylobby,build_eetablemanage,end&amp;quot; name=&amp;quot;build&amp;quot;&amp;gt;&amp;lt;/target&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;/project&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;发布脚本&quot;&gt;&lt;a href=&quot;#发布脚本&quot; class=&quot;headerlink&quot; title=&quot;发布脚本&quot;&gt;&lt;/a&gt;发布脚本&lt;/h2&gt;&lt;p&gt;需要配置Jenkins服务器上运行jenkins服务的用户登录目标机器不需要输入用户名和密码。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# Define constant&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;GEMINI_IP=172.16.206.32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;TOMCAT_HOME=/opt/tomcat-gemini-dev&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;GEMINI_HOME=/opt/wiseduAppGroups/gemini_dev&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;BACKUPS_HOME=/opt/gemini_backups&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Stop tomcat.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;$&amp;#123;TOMCAT_HOME&amp;#125;/bin/shutdown.sh&amp;quot; &amp;amp;&amp;gt;/dev/null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sleep 15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Check the stop is successful or not. If until not, kill the tomcat process.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;apos;ps -ef|grep &amp;quot;tomcat-gemini-dev&amp;quot; |grep -v &amp;quot;grep&amp;quot;&amp;apos; &amp;amp;&amp;gt;/dev/null; then&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  tomcat_pid=`ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;ps -ef | grep tomcat-gemini-dev | grep -v &amp;quot;grep&amp;quot; | awk &amp;apos;&amp;#123;print $2&amp;#125;&amp;apos;&amp;quot;`&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;kill -9 $&amp;#123;tomcat_pid&amp;#125;&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;fi&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Check the stop is successful or not.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;apos;ps -ef|grep &amp;quot;tomcat-gemini-dev&amp;quot; |grep -v &amp;quot;grep&amp;quot;&amp;apos; &amp;amp;&amp;gt;/dev/null; then&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  echo &amp;quot;Tomcat stop failed.Please check the problem.&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  exit 5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;fi&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Backup previous version.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;cd $&amp;#123;GEMINI_HOME&amp;#125;; tar zcf gemini$(date +%Y%m%d).tar.gz eetablecore  eetablemanage  emapflow  emapfunauth  emapsender  emaptaskcenter  emapturing  flowstatistics  skylobby&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;mv -f $&amp;#123;GEMINI_HOME&amp;#125;/gemini$(date +%Y%m%d).tar.gz $&amp;#123;BACKUPS_HOME&amp;#125;/&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;cd $&amp;#123;GEMINI_HOME&amp;#125;; rm -rf eetablecore  eetablemanage  emapflow  emapfunauth  emapsender  emaptaskcenter  emapturing  flowstatistics  skylobby&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Copy the newest zip to host.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;scp /opt/emap_build_workspace/out/out.zip root@$&amp;#123;GEMINI_IP&amp;#125;:$&amp;#123;GEMINI_HOME&amp;#125;/ &amp;amp;&amp;gt;/dev/null&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;cd $&amp;#123;GEMINI_HOME&amp;#125;; unzip -oq $&amp;#123;GEMINI_HOME&amp;#125;/out.zip&amp;quot; #不进入目录解压不了&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;rm -f $&amp;#123;GEMINI_HOME&amp;#125;/out.zip&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Start the tomcat.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssh root@$&amp;#123;GEMINI_IP&amp;#125; &amp;quot;$&amp;#123;TOMCAT_HOME&amp;#125;/bin/startup.sh&amp;quot; &amp;amp;&amp;gt;/dev/null&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;邮件配置&quot;&gt;&lt;a href=&quot;#邮件配置&quot; class=&quot;headerlink&quot; title=&quot;邮件配置&quot;&gt;&lt;/a&gt;邮件配置&lt;/h2&gt;&lt;p&gt;我使用的是 Extended Email Publisher这个插件。在配置构建完发送邮件，遇到一个问题：&lt;br&gt;测试邮件能发出去，但是构建完收不到邮件。构建日志显示邮件触发器已经触发了。&lt;br&gt;解决：点开高级设置，&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/1.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/2.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;修改为：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/3.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;但是发现还是收不到邮件。&lt;/p&gt;
&lt;p&gt;网上找到了答案，需要在Jenkins系统设置里配置 Extended E-mail Notification，如下：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/4.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;Jenkins本身也有发邮件的配置，当你使用了其他发邮件的插件时，需要配置这些插件的发件人账号密码等。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/jenkins/5.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;最近需要帮部门一个ant项目做持续集成和发布，该项目有9个svn地址，还有比较多的依赖，踩了不少坑，搞完记录下。
    
    </summary>
    
      <category term="持续集成" scheme="http://yoursite.com/categories/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/"/>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>Nginx实现XSS防御</title>
    <link href="http://yoursite.com/2018/05/10/Nginx%E5%AE%9E%E7%8E%B0XSS%E9%98%B2%E5%BE%A1/"/>
    <id>http://yoursite.com/2018/05/10/Nginx实现XSS防御/</id>
    <published>2018-05-10T06:49:16.000Z</published>
    <updated>2018-05-10T06:49:16.000Z</updated>
    
    <content type="html"></content>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Lua + OpenResty修改response body</title>
    <link href="http://yoursite.com/2018/05/03/Lua-OpenResty%E4%BF%AE%E6%94%B9response-body/"/>
    <id>http://yoursite.com/2018/05/03/Lua-OpenResty修改response-body/</id>
    <published>2018-05-03T05:18:45.000Z</published>
    <updated>2018-05-03T07:33:50.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;最近公司前端框架组提了个需求，希望修改response中的一个css文件，去掉一个样式：max-width:1632px;。于是便想到了利用lua。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;OpenResty-lua编程相关资料&quot;&gt;&lt;a href=&quot;#OpenResty-lua编程相关资料&quot; class=&quot;headerlink&quot; title=&quot;OpenResty lua编程相关资料&quot;&gt;&lt;/a&gt;OpenResty lua编程相关资料&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/openresty/lua-nginx-module#name&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;OpenResty Readme&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://moonbingbing.gitbooks.io/openresty-best-practices/lua/main.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;OpenResty最佳实践
&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;其中Readme要看完，是github上对OpenResty的lua-nginx-module比较全面的介绍。&lt;/p&gt;
&lt;h2 id=&quot;Nginx处理的几个阶段&quot;&gt;&lt;a href=&quot;#Nginx处理的几个阶段&quot; class=&quot;headerlink&quot; title=&quot;Nginx处理的几个阶段&quot;&gt;&lt;/a&gt;Nginx处理的几个阶段&lt;/h2&gt;&lt;p&gt;此处放上从网上找来的一幅图，&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/24.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;我这里修改response body显然是需要用到body_filter_by_lua*指令。&lt;/p&gt;
&lt;h2 id=&quot;修改Response-Body&quot;&gt;&lt;a href=&quot;#修改Response-Body&quot; class=&quot;headerlink&quot; title=&quot;修改Response Body&quot;&gt;&lt;/a&gt;修改Response Body&lt;/h2&gt;&lt;p&gt;修改Response Body的方式总体来说有4种，分别是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1.使用 body_filter_by_lua&lt;br&gt;指令来实现：&lt;a href=&quot;http://wiki.nginx.org/HttpLuaModule#body_filter_by_lua&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://wiki.nginx.org/HttpLuaModule#body_filter_by_lua&lt;/a&gt; 这个支持流式处理。 &lt;/li&gt;
&lt;li&gt;2.使用 ngx.location.capture 发起子请求，然后对子请求的响应体进行全缓冲式修改&lt;/li&gt;
&lt;li&gt;&lt;p&gt;3.可以使用 &lt;a href=&quot;https://github.com/agentzh/replace-filter-nginx-module&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ngx_replace_filter 模块&lt;/a&gt;来进行流式正则替换&lt;br&gt;替换成的目标值可以通过 ngx_lua 模块嵌入一小段 Lua 代码来事先计算好，放置在你自己定义的 nginx 变量中，然后在 replace_filter 指令中直接引用之。比如 &lt;/p&gt;
&lt;p&gt;  set_by_lua $my_var ‘… return …’;&lt;br&gt;  replace_filter ‘folderlist=\w+’ ‘folderlist=$my_var’ ‘g’; &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;4.使用http_sub_module模块&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;根据实际的需求，使用第3种，需要先安装sregex library，然后重新编译安装OpenResty，在编译时 ./configure –add-module=/path/to/replace-filter-nginx-module 启用replace-filter-nginx-module模块。&lt;br&gt;如果使用第4种方式都需要重新编译安装OpenResty，在编译时 –with-http_sub_module 启用http_sub_module模块。&lt;br&gt;这两种他们都不接受，因为涉及的客户太多。&lt;br&gt;对于第2种方式，是个比较好的方式，但是使用第二种方式需要增加一个用于子请求的location，相当于大动了配置文件，并且相应的我还得去修改之前写的安装升级脚本，于是最终还是选择了第一种方式。&lt;br&gt;虽然第2种到第4种的方案不适用于此次的需求，但是我还是尝试了使用下第2种和第4种的方案，并会把相关的脚本和配置贴在下面。&lt;/p&gt;
&lt;h3 id=&quot;第一种处理办法&quot;&gt;&lt;a href=&quot;#第一种处理办法&quot; class=&quot;headerlink&quot; title=&quot;第一种处理办法&quot;&gt;&lt;/a&gt;第一种处理办法&lt;/h3&gt;&lt;p&gt;lua脚本代码如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;-- body_filter_by_lua, body filter模块，ngx.arg[1]代表输入的chunk，ngx.arg[2]代表当前chunk是否为last&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;local chunk, eof = ngx.arg[1], ngx.arg[2]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;local buffered = ngx.ctx.buffered&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if not buffered then&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   buffered = &amp;#123;&amp;#125;  -- XXX we can use table.new here &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   ngx.ctx.buffered = buffered&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;end&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if chunk ~= &amp;quot;&amp;quot; then&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   buffered[#buffered + 1] = chunk&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   ngx.arg[1] = nil&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;end&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;if eof then&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   local whole = table.concat(buffered)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   ngx.ctx.buffered = nil&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   -- try to unzip&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   -- local status, debody = pcall(com.decode, whole) &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   -- if status then whole = debody end&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   -- try to add or replace response body&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   -- local js_code = ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   -- whole = whole .. js_code&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   whole = string.gsub(whole, &amp;quot;max%-width%:1632px%;&amp;quot;,  &amp;quot;&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   ngx.arg[1] = whole&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;end&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Nginx相关location配置如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;location  /fe_components/ &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     location ~ /fe_components/jqwidget/.*/bh-scenes-1.2.min.css &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            root   /usr/local/nginx/nginx/html/;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            body_filter_by_lua_file /opt/lua/replace.lua;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     root   /usr/local/nginx/nginx/html;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但是重载Nginx后发现，这个css样式的响应时间竟然是1.1min，可怕。。。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/25.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Nginx/26.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;仔细阅读上面贴出来的&lt;a href=&quot;https://github.com/openresty/lua-nginx-module#name&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;OpenResty Readme&lt;/a&gt;，发现有这么一段话：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;When the Lua code may change the length of the response body, then it is required to always clear out the Content-Length response header (if any) in a header filter to enforce streaming output, as in&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;location /foo &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    # fastcgi_pass/proxy_pass/...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    header_filter_by_lua_block &amp;#123; ngx.header.content_length = nil &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    body_filter_by_lua &amp;apos;ngx.arg[1] = string.len(ngx.arg[1]) .. &amp;quot;\\n&amp;quot;&amp;apos;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;于是需要修改配置文件，在body_filter_by_lua_file /opt/lua/replace.lua之前就得把header中的 content_length 置为空。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;location  /fe_components/ &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     location ~ /fe_components/jqwidget/.*/bh-scenes-1.2.min.css &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            root   /usr/local/nginx/nginx/html/;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            header_filter_by_lua &amp;apos;ngx.header.content_length = nil&amp;apos;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            body_filter_by_lua_file /opt/lua/replace.lua;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     root   /usr/local/nginx/nginx/html;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这样重载Nginx，清除缓存重新访问下，发现加载就正常了。&lt;br&gt;仔细了解了下原因，当代码运行到 body_filter_by_lua&lt;em&gt; 时，HTTP 报头（header）已经发送出去了。如果在之前设置了跟响应体相关的报头，而又在 body_filter_by_lua&lt;/em&gt; 中修改了响应体，会导致响应报头和实际响应的不一致。举个简就是说这个例子里上游的服务器返回了 Content-Length 报头，而 body_filter_by_lua* 又修改了响应体的实际大小（因为我删除了一些字符串）。客户端收到这个报头后，按其中的 Content-Length 去处理，顺着一头栽进坑里。由于Nginx 的流式响应，发出去的报头就像泼出去的水，要想修改只能提前进行。这是流式处理常常面对的悖论：要在流的开始输出长度，但又不能在那个时间事先知道流的长度。&lt;br&gt;对于处理逻辑简单的场景来说，Lua是十分合适的。 &lt;/p&gt;
&lt;h3 id=&quot;第二种处理办法&quot;&gt;&lt;a href=&quot;#第二种处理办法&quot; class=&quot;headerlink&quot; title=&quot;第二种处理办法&quot;&gt;&lt;/a&gt;第二种处理办法&lt;/h3&gt;&lt;p&gt;lua脚本：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;ngx.req.read_body()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;local data = ngx.req.get_body_data()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;local args = ngx.req.get_uri_args()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;local res = ngx.location.capture(&amp;quot;/bh-scenes-1.2.min.css&amp;quot;, &amp;#123;method = ngx.HTTP_GET, body=data, args=args&amp;#125;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;res.body = string.gsub(res.body, &amp;quot;max%-width%:1632px%;&amp;quot;, &amp;quot;&amp;quot;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ngx.say(res.body)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Nginx相关配置：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;location = /bh-scenes-1.2.min.css &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      root   /usr/local/nginx/nginx/html/fe_components/jqwidget/teal/;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;location  /fe_components/ &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     location ~ /fe_components/jqwidget/.*/bh-scenes-1.2.min.css &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          content_by_lua_file /opt/lua/replace2.lua;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     root   /usr/local/nginx/nginx/html;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;第四种处理办法&quot;&gt;&lt;a href=&quot;#第四种处理办法&quot; class=&quot;headerlink&quot; title=&quot;第四种处理办法&quot;&gt;&lt;/a&gt;第四种处理办法&lt;/h3&gt;&lt;p&gt;需要重新编译安装OpenResty，编译时加入参数 –with-http_sub_module。&lt;br&gt;Nginx相关配置如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;location  /fe_components/ &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        location ~ /jqwidget/teal/bh-scenes-1.2.min.css &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           #sub_filter_types *;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           sub_filter_types text/css;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           sub_filter &amp;apos;max-width:1632px;&amp;apos;  &amp;apos;&amp;apos;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           sub_filter_once off;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           root   /usr/local/nginx/nginx/html/;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        root   /usr/local/nginx/nginx/html;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;最近公司前端框架组提了个需求，希望修改response中的一个css文件，去掉一个样式：max-width:1632px;。于是便想到了利用lua。
    
    </summary>
    
      <category term="Nginx" scheme="http://yoursite.com/categories/Nginx/"/>
    
    
      <category term="Nginx" scheme="http://yoursite.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>基于mysqldump做备份恢复</title>
    <link href="http://yoursite.com/2018/04/21/%E5%9F%BA%E4%BA%8Emysqldump%E5%81%9A%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"/>
    <id>http://yoursite.com/2018/04/21/基于mysqldump做备份恢复/</id>
    <published>2018-04-21T00:17:27.000Z</published>
    <updated>2018-04-24T03:27:19.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;备份和恢复概念&quot;&gt;&lt;a href=&quot;#备份和恢复概念&quot; class=&quot;headerlink&quot; title=&quot;备份和恢复概念&quot;&gt;&lt;/a&gt;备份和恢复概念&lt;/h2&gt;&lt;h3 id=&quot;备份和恢复的意义&quot;&gt;&lt;a href=&quot;#备份和恢复的意义&quot; class=&quot;headerlink&quot; title=&quot;备份和恢复的意义&quot;&gt;&lt;/a&gt;备份和恢复的意义&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;灾难恢复：比如机房被淹。&lt;/li&gt;
&lt;li&gt;审计：比如想知道某一数据在某一时刻是什么样的。&lt;/li&gt;
&lt;li&gt;测试 &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;备份：目的用于恢复。请注意要对备份数据做恢复测试，防止备份的不能恢复，到时候就麻烦了。&lt;/p&gt;
&lt;h3 id=&quot;备份类型&quot;&gt;&lt;a href=&quot;#备份类型&quot; class=&quot;headerlink&quot; title=&quot;备份类型&quot;&gt;&lt;/a&gt;备份类型&lt;/h3&gt;&lt;p&gt;1.根据备份时，数据库服务器是否在线：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;冷备：cold backup。&lt;/strong&gt;服务器离线，数据库读写操作都不能执行。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;温备：warm backup。&lt;/strong&gt;全局施加共享锁，所有业务只能读，不能写。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;热备：hot backup。&lt;/strong&gt;服务器不离线，读写操作都能进行。这就可能会有问题了。我们去备份，数据量很大，我们得夜间备份，在你复制的过程中，如果文件发生了改变，前一半后一半时间戳不一致，备份好的文件恢复过来是不允许访问的。在文件系统上，这样的文件属于时间点不一致文件，因此是不允许访问的。我们可以把整个数据库锁定，然后创建一快照，通过快照进行备份。通过快照备份，时间点一定是一致的，但是也有一些其他的问题。首先你要锁定整个库，你一锁定，别人就读写不了了。所以这也不能算是热备。真正的热备是指任何业务不终止，它能够自动在背后进行备份，而且自动保证时间点是一致的。&lt;strong&gt;【注意】:要想完成热备，通常是基于事务的存储引擎才能完成的。&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;2.根据备份的数据集：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;完全备份：full backup&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;部分备份: partial backup&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;3.根据备份时的接口（直接备份数据文件还是通过mysql服务器导出数据）：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;物理备份：&lt;/strong&gt;直接复制(归档)数据文件的备份方式；physical backup。&lt;br&gt;copy命令就可以备份了，还可以tar归档压缩备份，因此不需要额外的工具就可以备份。恢复也很简单，把备份的文件复制到数据库里面就可以了，但是要兼容才行。但好在MySQL的InnoDB和MyISAM非常容易跨平台，一般来说，在windows上备份的在Linux上也能用，在Linux上备份的在windows上也能用。物理备份比较适合大数据量备份，比如超过10G，甚至几十个G，千万别用逻辑备份。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;逻辑备份：&lt;/strong&gt;把数据从库中提出出来保存为文本文件；logical backup。&lt;br&gt;从根本上来讲，逻辑备份备份后为文本文件，我们可以使用grep、sed、awk来处理查看，物理备份的文件则不能被如此处理。而且逻辑备份恢复简单，导入就可以了。逻辑备份也有缺点，比如说与物理备份恢复速度比，逻辑备份恢复更慢，占据空间更大。还有逻辑备份有个重要缺点，无法保证浮点数的精度，因为我们必须把二进制数据转换成文本格式。更重要的是使用逻辑备份还原数据以后还需要重建索引。 对于非常大的表，重建索引是相当消耗时间和资源的，由其是CPU资源。逻辑备份的工具：mysqldump&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;4.根据备份时是备份整个数据还是仅备份变化的数据：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;完全备份：&lt;/strong&gt;full backup&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;增量备份：&lt;/strong&gt;incremental backup。得使用专业的备份工具进行增量备份。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;差异备份：&lt;/strong&gt;differential backup&lt;br&gt;增量和差异：差异，每一次起始点不是上一次备份，而是上一次完全备份。见下图。将来设计备份策略的时候，需要根据你的数据量变化频度来设计。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/93.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;备份策略&quot;&gt;&lt;a href=&quot;#备份策略&quot; class=&quot;headerlink&quot; title=&quot;备份策略&quot;&gt;&lt;/a&gt;备份策略&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;选择备份方式&lt;/li&gt;
&lt;li&gt;选择备份时间&lt;/li&gt;
&lt;li&gt;考虑到恢复成本&lt;ul&gt;
&lt;li&gt;恢复时长&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;备份成本：&lt;ul&gt;
&lt;li&gt;锁时间&lt;/li&gt;
&lt;li&gt;备份时长&lt;/li&gt;
&lt;li&gt;备份负载&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;备份对象&quot;&gt;&lt;a href=&quot;#备份对象&quot; class=&quot;headerlink&quot; title=&quot;备份对象&quot;&gt;&lt;/a&gt;备份对象&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;数据&lt;/li&gt;
&lt;li&gt;配置文件&lt;/li&gt;
&lt;li&gt;代码：存储过程，存储函数，触发器&lt;/li&gt;
&lt;li&gt;OS相关的配置文件，如crontab配置计划及相关的脚本&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;备份工具&quot;&gt;&lt;a href=&quot;#备份工具&quot; class=&quot;headerlink&quot; title=&quot;备份工具&quot;&gt;&lt;/a&gt;备份工具&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;1.mysqldump：&lt;/strong&gt;MySQL原生自带的逻辑备份工具，单线程工具。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;InnoDB热备、温备和冷备，MyISAM温备，Aria温备&lt;/li&gt;
&lt;li&gt;因为是逻辑备份，所以备份和恢复过程较慢&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;2.mysqldumper: &lt;/strong&gt;多线程的mysqldump。装上percona的tools之后，mysqldumper就在里面。多线程同时备份多个库，在必要的场景下缩短备份时间是很有必要的。&lt;/p&gt;
&lt;p&gt;这两个备份工具很难实现差异或增量备份；&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.lvm-snapshot:&lt;/strong&gt; 基于lvm的逻辑卷快照进行备份。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;这是接近于热备的工具：为什么叫接近于？因为要先请求全局锁，而后创建快照，并在创建快照完成后释放全局锁；&lt;/li&gt;
&lt;li&gt;使用cp、tar等工具进行物理备份；&lt;/li&gt;
&lt;li&gt;备份和恢复速度较快；&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;很难实现增量备份，并且请求全局需要等待一段时间，在繁忙的服务器上尤其如此；&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;4.部分备份工具：&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;SELECT clause INTO OUTFILE &amp;apos;/path/to/somefile&amp;apos;
LOAD DATA INFILE &amp;apos;/path/from/somefile&amp;apos;   #恢复时得使用这个命令恢复。
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;部分备份工具， 不会备份关系定义，仅备份表中的数据；&lt;/li&gt;
&lt;li&gt;也是个逻辑备份工具，快于mysqldump。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;5.mysqlhotcopy:&lt;/strong&gt;几乎冷备。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;6.专业备份工具：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Innobase: 商业备份工具, innobackup&lt;/li&gt;
&lt;li&gt;Xtrabackup: 由Percona提供的开源备份工具。需要单独安装。&lt;ul&gt;
&lt;li&gt;InnoDB热备，增量备份；&lt;/li&gt;
&lt;li&gt;MyISAM温备，只是完全备份，不支持增量；&lt;/li&gt;
&lt;li&gt;物理备份，速度快；&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;mysqldump备份&quot;&gt;&lt;a href=&quot;#mysqldump备份&quot; class=&quot;headerlink&quot; title=&quot;mysqldump备份&quot;&gt;&lt;/a&gt;mysqldump备份&lt;/h2&gt;&lt;h3 id=&quot;mysqldump备份介绍&quot;&gt;&lt;a href=&quot;#mysqldump备份介绍&quot; class=&quot;headerlink&quot; title=&quot;mysqldump备份介绍&quot;&gt;&lt;/a&gt;mysqldump备份介绍&lt;/h3&gt;&lt;p&gt;【注意】：数据量在10G以下。&lt;br&gt;相当于一个MySQL客户端工具，你的服务器在远程，mysqldump在本地，没有任何问题，也就意味着二者可以在不同的主机上。可实现完全备份和部分备份，但是还原一个库时，这个库得事先存在，就是说在还原前，先得CREATE DATABASE。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;man mysqldump
mysqldump [options] [db_name [tbl_name ...]]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;备份单个库：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysqldump [options] db_name
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;恢复时：如果目标库不存在，需要事先手动创建。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例1】：备份和恢复。&lt;/strong&gt;&lt;br&gt;1.先备份库&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# mysqldump -uroot -hlocalhost -p hellodb &amp;gt;/tmp/hdb.sql
Enter password: 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;2.连接上mysql数据库，删除库hellodb&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; DROP DATABASE hellodb;
Query OK, 7 rows affected (0.01 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;3.恢复，得事先创建库&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# mysql -uroot -hlocalhost -p &amp;lt;/tmp/hdb.sql 
Enter password: 
ERROR 1046 (3D000) at line 22: No database selected

mysql&amp;gt; CREATE DATABASE hellodb DEFAULT CHARSET &amp;apos;utf8&amp;apos;;
Query OK, 1 row affected (0.00 sec)

[root@db ~]# mysql -uroot -hlocalhost -p hellodb &amp;lt;/tmp/hdb.sql     
Enter password: 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;所以说指定数据库进行备份的这种方式，它只是备份这个库里的东西，它以为这个库是事先存在的，所以恢复时是不会自动创建库的。也可以备份某个表。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;--all-databases:　备份所有库。恢复时不需要事先创建库名。
--databases db1 db2 ...: 备份指定的多个库。多个库名间用空格隔开，事先不需要创建库名。
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;【示例2】：备份前加锁。（这才是真正的备份，要锁表）&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;–lock-all-tables：请求锁定所有表之后再备份，对MyISAM、InnoDB、Aria做温备。&lt;/li&gt;
&lt;li&gt;–lock-tables：备份哪张表，就锁定哪张表。这种并不理想，不建议使用，使用上面的那个。&lt;/li&gt;
&lt;li&gt;–single-transaction: 能够对InnoDB存储引擎实现热备；&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;[root@db ~]# mysqldump -uroot -hlocalhost -p hellodb --lock-all-tables &amp;gt;/root/hellodb.sql &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Enter password: &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[root@db ~]# mysqldump -uroot -hlocalhost -p --databases hellodb --lock-all-tables &amp;gt;/root/hellodb2.sql  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Enter password:&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;【注意】:上面两句，第二句在备份单个表时也加了–databases参数，这样备份后的文件里是有CREATE DATABASE语句的。但是–lock-all-tables这种方式也不是很理想，其他的请求会被阻塞，如果你能确保你要备份的数据库的表的底层存储引擎都是InnoDB的话，可以使用另外一种备份方式，–single-transaction，基于多版本并发控制完成对InnoDB存储的热备，和–lock-all-tables不要同时使用。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;备份代码：mysqldump只备份数据，不备份代码。&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;–events: 备份事件调度器代码&lt;/li&gt;
&lt;li&gt;–routines: 备份存储过程和存储函数&lt;/li&gt;
&lt;li&gt;–triggers：备份触发器&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;备份时滚动日志：&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;--flush-logs: 备份前、请求到锁之后滚动日志。
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;为什么要滚动日志呢？恢复是要采用完全备份+增量备份或差异备份，最后是恢复不到数据损坏的那一刻的，比如你周日做的完全备份，周三中午崩掉了，你可以采用完全备份+周一、周二的增量备份，或者完全备份+差异备份，但是你周三凌晨到周三中午的数据怎么恢复？依靠二进制日志。滚动之后，恢复时你就知道从哪个文件向后是要用到的。因此用mysqldump做完全备份时都应该做–flush-logs。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;复制时的同步位置标记：&lt;/strong&gt;&lt;br&gt;主从复制架构中的主服务器数据，说白了它就是在你没有flush-logs时怎么知道下一次恢复时用这个文件怎么恢复到时间点。–master-data帮我们备份那一刻二进制日志的文件名及事件所处的位置。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;--master-data=[0|1|2]
  0: 不记录
  1：记录为CHANGE MASTER语句
  2：记录为注释的CHANGE MASTER语句
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;【总结】:使用mysqldump备份需要使用的参数：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;请求锁：–lock-all-tables或使用–singe-transaction进行innodb热备；&lt;/li&gt;
&lt;li&gt;滚动日志：–flush-logs&lt;/li&gt;
&lt;li&gt;选定要备份的库：–databases&lt;/li&gt;
&lt;li&gt;记录二进制日志文件及位置：–master-data=&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;mysqldump备份示例&quot;&gt;&lt;a href=&quot;#mysqldump备份示例&quot; class=&quot;headerlink&quot; title=&quot;mysqldump备份示例&quot;&gt;&lt;/a&gt;mysqldump备份示例&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;【示例1】:手动施加锁，然后进行备份。&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/94.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/95.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;【注意】：刷写所有表：把所有表在缓冲区中的内容通通同步到磁盘上。如果你的数据量很大，这句刷写和加锁语句要等很长时间。&lt;br&gt;然后用mysqldump备份就可以了。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# mysqldump -uroot -p --databases hellodb &amp;gt;/tmp/hellodb2.sql
Enter password: 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;备份完了记得释放锁：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; UNLOCK TABLES;
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;【示例2】:手动施加锁太麻烦，直接用mysqldump备份。&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# mysqldump -uroot -p --databases hellodb --lock-all-tables --flush-logs &amp;gt;/tmp/hellodb3.sql
Enter password: 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;如果有代码块，也需要把相应选项加进来。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;–events: 备份事件调度器代码&lt;/li&gt;
&lt;li&gt;–routines: 备份存储过程和存储函数&lt;/li&gt;
&lt;li&gt;–triggers：备份触发器&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;热备，你得确定库中所有表的存储引擎都是InnoDB存储引擎&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# mysqldump -uroot -p --databases hellodb --single-transaction --flush-logs &amp;gt;/tmp/hellodb4.sql                 
Enter password: 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;还应该指定–master-data=[0|1|2]&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# mysqldump -uroot -p --databases hellodb --lock-all-tables --flush-logs --master-data=2 &amp;gt;/tmp/hellodb5.sql
Enter password: 
[root@db ~]# vim /tmp/hellodb5.sql 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/96.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;恢复:&lt;/strong&gt;&lt;br&gt;建议：临时性关闭二进制日志，关闭其它用户连接。因为恢复时经常会创建数据库，创建表，插入数据，这部分没必要记录二进制日志。用这个备份恢复时只能恢复到上一次完全备份的位置，要想做时间点还原，还需要二进制日志。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例3】:数据库即时点恢复。&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# mysqldump -uroot -p --databases hellodb --lock-all-tables --flush-logs --master-data=2 &amp;gt;/tmp/hellodb6.sql
Enter password: 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;备份后，我们在hellodb库中创建了表，插入了一些数据。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; use hellodb&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Database changed&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; create table newtable(Name CHAR(30));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Query OK, 0 rows affected (0.04 sec)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; insert into newtable values (&amp;apos;Tom&amp;apos;),(&amp;apos;Jerry&amp;apos;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Query OK, 2 rows affected (0.00 sec)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Records: 2  Duplicates: 0  Warnings: 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; quit&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Bye&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;没注意把数据库hellodb删除了&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; DROP DATABASE hellodb;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Query OK, 8 rows affected (0.03 sec)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; quit&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Bye&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;恢复过程：&lt;br&gt;①让服务器离线，最起码你得保证服务器不能被别人连进来。&lt;br&gt;开启防火墙或者其他。&lt;/p&gt;
&lt;p&gt;②把即时点前的二进制日志导出来。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/97.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;二进制日志是master-bin.000013的120位置。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# vim /tmp/hellodb6.sql 
[root@db ~]# cd /data/binlog/
[root@db binlog]# mysqlbinlog --start-position=120 master-bin.000013 #这个日志文件和文件名是在配置文件中定义的
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/98.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db binlog]# mysqlbinlog --start-position=120 --stop-position=446 master-bin.000013 &amp;gt;/tmp/helldb6.inc.sql
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/99.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;③连上mysql服务器做恢复，先临时性关闭二进制日志&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/100.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;千万不要xshell另起一个会话，导入完全备份，因为session sql_log_bin=0只对当前会话生效，另起一会话导入备份，那么同时也会写到二进制日志中，这是我们不期望的。&lt;/p&gt;
&lt;p&gt;④恢复到即时点。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/101.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/102.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/103.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;但事实上这个开不开没什么影响，只要你自己不在当前session中操作就行。     &lt;/p&gt;
&lt;p&gt;【总结】:备份策略：基于mysqldump&lt;br&gt;&lt;strong&gt;1.备份：mysqldump+二进制日志文件&lt;/strong&gt;&lt;br&gt;    周日做一次完全备份：备份的同时滚动日志&lt;br&gt;    周一至周六：备份二进制日志；(可以每天都FLUSH LOGS，然后把备份之前的那个二进制日志，每天备份每天的二进制日志，直接copy就可以备份二进制日志文件。这里其实是把二进制日志当增量备份)。&lt;br&gt;&lt;strong&gt;2.恢复&lt;/strong&gt;&lt;br&gt;    完全备份+各二进制日志文件中至此刻的事件&lt;br&gt;   日志滚动也可以使用mysqladmin工具：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db binlog]# mysqladmin -uroot -p flush-logs
Enter password: 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;对MySQL配置文件，以及与MySQL相关的OS配置文件在每次修改后都应该直接进行备份。cp一份放在一个地方就行。&lt;/p&gt;
&lt;p&gt;我们可以写一个备份脚本：&lt;br&gt;1、备份所有数据库；&lt;br&gt;2、在每周日凌晨自动执行；&lt;br&gt;【注意】:crontab的PATH环境变量和系统的PATH环境变量是不一样的，无论你在命令行中使用命令多么顺当，在crontab中未必会执行，所以你写一个脚本的目的不是在命令行中执行，而是在crontab中执行，请使用命令全路径。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;备份和恢复概念&quot;&gt;&lt;a href=&quot;#备份和恢复概念&quot; class=&quot;headerlink&quot; title=&quot;备份和恢复概念&quot;&gt;&lt;/a&gt;备份和恢复概念&lt;/h2&gt;&lt;h3 id=&quot;备份和恢复的意义&quot;&gt;&lt;a href=&quot;#备份和恢复的意义&quot; class=&quot;headerlink&quot; title=&quot;备份和恢复的意义&quot;&gt;&lt;/a&gt;备份和恢复的意义&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;灾难恢复：比如机房被淹。&lt;/li&gt;
&lt;li&gt;审计：比如想知道某一数据在某一时刻是什么样的。&lt;/li&gt;
&lt;li&gt;测试
    
    </summary>
    
      <category term="MySQL" scheme="http://yoursite.com/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="http://yoursite.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL日志功能详解</title>
    <link href="http://yoursite.com/2018/04/16/MySQL%E6%97%A5%E5%BF%97%E5%8A%9F%E8%83%BD%E8%AF%A6%E8%A7%A3/"/>
    <id>http://yoursite.com/2018/04/16/MySQL日志功能详解/</id>
    <published>2018-04-16T00:40:02.000Z</published>
    <updated>2018-04-18T06:03:54.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;MySQL日志&quot;&gt;&lt;a href=&quot;#MySQL日志&quot; class=&quot;headerlink&quot; title=&quot;MySQL日志&quot;&gt;&lt;/a&gt;MySQL日志&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;查询日志&lt;br&gt;这是最不应该记录的日志。因为一个非常繁忙的数据库服务器，其查询会有很多，每一次都记录日志会导致系统性能下降。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;而且还会有额外的空间开销。MySQL默认没有开启这个日志。注意不仅仅是SELECT。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;慢查询日志&lt;br&gt;查询执行时长超过指定时长的查询，即为慢查询。这里的慢不一定是语句自身执行慢，如果一个操作锁定了某张表，尤其是独占锁锁定了这张表，那么其他人对于这张表的查询就阻塞掉了。但不管怎么讲，慢查询日志是我们通常拿来定位系统上查询操作执行速度过慢时常用到的一个评估工具。所以在生产环境中有时是很有必要启用慢查日志的。percona公司在提供的工具perconatools中有专门工具用来分析慢查日志中哪些查询执行时长过长，以及产生的原因有哪些。这是一个应该启用的日志，但是默认没启用。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;错误日志&lt;br&gt;通常情况下记录的不光是错误信息，也包括mysql启动和关闭过程中的信息，以及启动复制线程时的信息。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;中继日志&lt;br&gt;在从服务器上的日志。就是说复制的时候，主服务器任何能够产生数据修改的操作，在写入数据文件的同时，还会把这个语句(也可能是行)记录到二进制日志文件中一份。从服务器就是使用一个用户帐号不断的去连接主服务器，并尝试去读取主服务器上二进制日志中的每一个条目，从服务器将这些挨个的读到从服务器上，在执行之前，先要将这些读到的保存在本地的日志文件中，而后从本地日志文件中读一条执行一条。这个日志文件就叫做中继日志。很显然，中继日志内容应该和二进制日志内容是一样的，为了完成复制，二进制日志不能随便删除，中继日志可以删除，用完后清了。如果发现清错了，可以找个二进制日志复制下就可以了。再想一个问题，从服务器也有二进制日志，每次执行都是从中继日志中读，然后执行，同时还要写入二进制日志，如果要记录二进制日志的话，应该是和主服务器的二进制日志一样的。这种记录是额外的开销，如果其他服务器不把这个从服务器当做主来用，这个二进制日志就没有用了，所以应该关闭掉，以提升性能。另外，从服务器是不能执行额外的任何写操作的，只能从中继日志中读一条写一条。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;事务日志&lt;br&gt;先暂存事务提交的数据，然后在同步到数据文件中。&lt;br&gt;随机I/O转换为顺序I/O。但是即便是顺序I/O，其速度依然有限。把事务日志放在RAID10上，或放在固态硬盘上，或放在PCI-E固态硬盘上，那就体会几乎内存的性能了。&lt;br&gt;如果是支持事务的存储引擎，要满足事务的要求，就必须满足ACID测试，其中有一点很重要就是持久性。事务还要能够回滚。考虑一种场景，我们的事务隔离级别是”读未提交”，两个连接进来了，都在做事务，第一个事务执行的语句，它的事务在提交之前有可能是保存在内存中，有可能是被同步到事务日志中，内存中可能放不下，就放到事务日志中去了。当第二个事务查询时，它的查询应该是来自磁盘上的数据文件，但问题是第一个事务执行的操作还没有同步到磁盘上，那它怎么查到呢？所以要支持事务，背后的工作逻辑是很复杂的，不但要从数据文件中找，还要去找那些有可能潜在修改这个数据文件的数据集，比如内存缓冲区，这个缓冲区我们称为innodb_buffer，还有可能要去查询事务日志。所以事务日志还要支撑读操作。只有完全把buffer和事务日志中的数据全部同步到磁盘的数据文件中去了，从磁盘上读到的数据才是最新的。所以buffer和事务日志中所保存的数据接近于表中所存储的格式的。&lt;br&gt;再考虑一种场景如果我们启动了一个非常大的事务，那么buffer实在缓存不下了，就要先写到事务日志中去了，日志文件至少需要两个，以实现轮替的，两个组成一个日志文件组。第一个日志文件写满了，就去写第二个。日志文件一个5M，可以调整的，但是大多数场景是够用的。第一个日志文件不够用了，写第二个日志文件，然后第一个日志文件中的数据开始往磁盘数据文件同步。即便如此，这个事务只执行了一半或者2/3，过一会，回滚。该怎么回滚？那些写到磁盘数据文件的数据也得删掉。所以回滚也是一个非常复杂的操作。如果说这个回滚的所有数据最多只到事务日志中和最多走到数据文件中，哪种回滚的开销比较小？只是走到事务日志中开销比较小，甚至于还没走到事务日志中，仍然还在innodb_buffer中，回滚的开销会更小，所以我们应该使用小事务。&lt;br&gt;为了保证提交的事务不丢失，其一部分写操作可能在内存中，我们一commit，所有位于内存中的数据有可能会因为断电或系统崩溃而丢失，为了避免这种情况，要立即写到持久存储中去。写到事务日志中。假如一个事务提交了，刚从内存中同步到事务日志中，还没同步到数据文件中，系统崩溃了。下次启动时，这个事务能恢复回来，因为事务日志中有。所以下一次mysql启动时，它必须保证把那些提交的事务从事务文件中同步到数据文件中。而未提交的事务，比如有些事务正在操作，但并未提交，系统崩溃了，这种情况怎么办？因为没有完成，所以之前这个事务的操作全部回滚，这个过程就叫做系统崩溃恢复的过程。把那些提交的事务同步到数据文件中，没提交的事务回滚。而事务性存储引擎的崩溃恢复能力是天生的。&lt;br&gt;如果MySQL崩溃是因为事务日志的磁盘坏了，这种情况下，就不能崩溃恢复了。只能用备份恢复了。所以我们应该让事务日志所在的硬盘足够可靠，RAID10或者RAID1。假如说是因为数据文件崩溃了，一样的场景。你有事务日志，但你数据文件坏了，怎么去写啊。有事务日志并不能恢复数据，&lt;strong&gt;事务日志不是用来恢复数据的，事务日志仅仅是崩溃时能够保证已提交事务不丢失，未提交事务能回滚。&lt;/strong&gt;&lt;br&gt;从性能上来讲，将事务日志和数据文件放在一块是不合理的。从内存到硬盘，I/O，从事务日志到数据文件也要I/O，所有的I/O都压在一块硬盘上去了，导致性能下降。因此，把数据文件放在一个RAID设备上，把事务日志放在一个RAID设备上。考虑独特的场景，我们实在没有RAID设备放事务日志了，那就给事务日志做镜像。如果你实在是没钱，那就找个其他磁盘空间，跟事务日志文件不在同一个磁盘上就行，做一个mirror，任何往第一组事务日志中写的数据会被自动同步到第二组中去的。&lt;br&gt;日志文件组：至少应该有两个日志文件；&lt;br&gt;【注意】：尽可能使用小事务以提升事务引擎的性能；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;二进制日志&lt;br&gt;主要用于MySQL时间点恢复和复制。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;查询日志&quot;&gt;&lt;a href=&quot;#查询日志&quot; class=&quot;headerlink&quot; title=&quot;查询日志&quot;&gt;&lt;/a&gt;查询日志&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;log={ON|OFF}:是否记录所有语句的日志信息于一般查询日志文件(general_log)。MySQL5.6已经弃用此项变量了，都使用general_log。&lt;/li&gt;
&lt;li&gt;log_output={TABLE|FILE|NONE}&lt;ul&gt;
&lt;li&gt;TABLE：记录于表中。MySQL库中会自动生成一个表记录。&lt;/li&gt;
&lt;li&gt;FILE：记录于general_log_file。&lt;/li&gt;
&lt;li&gt;NONE：不记录。&lt;/li&gt;
&lt;li&gt;TABLE和FILE可以同时出现，用逗号分隔即可。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;general_log：是否启用查询日志。由于历史的原因，和log是个冲突的概念。&lt;/li&gt;
&lt;li&gt;general_log_file：定义一般查询日志保存的文件。文件名为：主机名.log，保存路径没说的话保存在数据目录中。所有的相对路径通常都是相对于数据目录而言的。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; SHOW GLOBAL VARIABLES LIKE &amp;quot;%log%&amp;quot;;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/89.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;如果开启查询日志，包括SHOW、SET操作也会被记录，这些操作过程中也需要查询。如果要记录查询日志，记录到数据库中，会比记录到文件中快一点。但是一般是不启用记录查询日志的，除非特殊情况。&lt;/p&gt;
&lt;h2 id=&quot;慢查询日志&quot;&gt;&lt;a href=&quot;#慢查询日志&quot; class=&quot;headerlink&quot; title=&quot;慢查询日志&quot;&gt;&lt;/a&gt;慢查询日志&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;long_query_time： 10.000000&lt;br&gt;执行多长时间的查询算是慢查询&lt;/li&gt;
&lt;li&gt;slow_query_log={ON|OFF}  或者是1 | 0&lt;br&gt;设定是否启用慢查询日志；它的输出位置也取决log_output={TABLE|FILE|NONE}；&lt;/li&gt;
&lt;li&gt;slow_query_log_file=www-slow.log&lt;br&gt;定义日志文件路径及名称；&lt;/li&gt;
&lt;li&gt;log_slow_queries=ON    &lt;/li&gt;
&lt;li&gt;与上面slow_query_log={ON|OFF}好像是重复的，上面那个是全局的，下面这个是用户自己会话的。                                &lt;/li&gt;
&lt;li&gt;log_slow_rate_limit=1     记录慢查询日志的速率。                  &lt;/li&gt;
&lt;li&gt;log_slow_verbosity     是否记录详细的慢查询的详细信息。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; SHOW GLOBAL VARIABLES LIKE &amp;quot;long%&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+-----------------+-----------+&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Variable_name   | Value     |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+-----------------+-----------+&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| long_query_time | 10.000000 |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+-----------------+-----------+&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1 row in set (0.00 sec)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;错误日志&quot;&gt;&lt;a href=&quot;#错误日志&quot; class=&quot;headerlink&quot; title=&quot;错误日志&quot;&gt;&lt;/a&gt;错误日志&lt;/h2&gt;&lt;p&gt;错误日志： 通常是开启的。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;服务器启动和关闭过程中的信息；&lt;/li&gt;
&lt;li&gt;服务器运行过程中的错误信息；&lt;/li&gt;
&lt;li&gt;事件调度器运行一个事件时产生的信息；&lt;/li&gt;
&lt;li&gt;&lt;p&gt;在复制架构中的从服务器上启动从服务器线程时产生的信息。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_error = /path/to/error_log_file&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;log_warnings = {1|0}&lt;br&gt;是否记录警告信息于错误日志中。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; SHOW GLOBAL VARIABLES LIKE &amp;quot;%log%&amp;quot;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| log_error                               | /data/mydata/db.err           |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;二进制日志&quot;&gt;&lt;a href=&quot;#二进制日志&quot; class=&quot;headerlink&quot; title=&quot;二进制日志&quot;&gt;&lt;/a&gt;二进制日志&lt;/h2&gt;&lt;h3 id=&quot;二进制日志介绍&quot;&gt;&lt;a href=&quot;#二进制日志介绍&quot; class=&quot;headerlink&quot; title=&quot;二进制日志介绍&quot;&gt;&lt;/a&gt;二进制日志介绍&lt;/h3&gt;&lt;p&gt;二进制日志：也称为复制日志，记录的是”修改”类信息，记录的是一个个事件。&lt;br&gt;格式也应该是二进制的，不能使用cat命令查看，有专门的工具mysqlbinlog可以查看。&lt;br&gt;二进制日志能够基于过去某个数据集的基础上，把后续的所有操作重新跑一遍，能得到和此前第一次跑时所得到的是一样的结果。日志文件名字以及存放路径都是可以定义的。比如我在安装mysql时将数据文件和二进制日志文件就定义在了不同的目录：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# cd /data/binlog/
[root@db binlog]# ls
master-bin.000001  master-bin.000003  master-bin.000005  master-bin.000007  master-bin.index
master-bin.000002  master-bin.000004  master-bin.000006  master-bin.000008
[root@db binlog]# file master-bin.000001
master-bin.000001: MySQL replication log
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;可以使用工具mysqlbinlog查看二进制日志文件内容：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db binlog]# mysqlbinlog master-bin.000001
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/90.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;这个事件从66773开始到66846结束，66846-66773=中间的信息的偏移量。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;position：位置，空间记录法。空间记录法就是相对于当前日志文件而言它的偏移位置。&lt;/li&gt;
&lt;li&gt;time: 时间点，时间记录法。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;二进制日志文件内容格式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;事件发生的日期和时间&lt;/li&gt;
&lt;li&gt;服务器ID&lt;/li&gt;
&lt;li&gt;事件的结束位置&lt;/li&gt;
&lt;li&gt;事件的类型&lt;/li&gt;
&lt;li&gt;原服务器生成此事件时的线程ID&lt;/li&gt;
&lt;li&gt;语句的时间戳和写入二进制日志文件的时间差。exec_time=0，由于单位是s，所以很多时候是0。&lt;/li&gt;
&lt;li&gt;错误代码；&lt;/li&gt;
&lt;li&gt;事件内容：也就是语句本身。&lt;/li&gt;
&lt;li&gt;事件位置，相当于下一事件的开始位置&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;考虑一种场景：如果说我们有多个进程同时进行，比如处理两个请求的两个线程分别在两颗CPU上跑着，而且修改不是同一张表，这个时候都需要写入二进制日志，但是某个时刻只会往一个二进制日志文件中写，具体哪个见下面的命令。显然，这个文件不能有两个进程同时写，如果交替着写，事件就混到一块了。由于二进制日志成为了资源争用点，有可能会导致性能下降，如果你去设计的话，如何去避免性能下降？缓存，于是每一个线程在写数据时不是直接写文件，而是写在缓冲区中，专业点的说法是，写通常是叫做缓冲。过一段时间，由MySQL服务器后台线程找空闲时间自行往二进制日志文件中同步。但这会带来一个问题，如果说事件写在缓冲区中了，忽然间系统断电了，这些缓冲区的数据还没写到二进制文件中去呢，那么拿来二进制日志执行，数据也不对。虽然没有写到二进制日志文件中去，但是却已经写到本地数据文件中去了。只不过这个有可能产生数据修改的操作还得写到记录到二进制日志中去。将来把这个二进制日志信息复制到从服务器上，重新跑一遍，得到的数据不一样。因此这是不安全的做法。通常效率和安全性通常是两个背离的方向。所以我们要求应该在事务提交时无论如何也应该把二进制日志缓冲区中的信息同步到二进制日志文件中去。&lt;/p&gt;
&lt;p&gt;滚动： 二进制日志文件需要不停的进行滚动，防止文件大小过大。&lt;br&gt;1、大小&lt;br&gt;2、时间&lt;/p&gt;
&lt;p&gt;二进制日志的功用：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;即时点恢复：我们想恢复到哪个位置，可以通过二进制日志文件手动调整进行的。&lt;/li&gt;
&lt;li&gt;复制。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;二进制日志常用命令&quot;&gt;&lt;a href=&quot;#二进制日志常用命令&quot; class=&quot;headerlink&quot; title=&quot;二进制日志常用命令&quot;&gt;&lt;/a&gt;二进制日志常用命令&lt;/h3&gt;&lt;p&gt;1.查看当前服务器所正在使用的二进制日志文件，以及下一个事件要开始时记录的位置&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW MASTER STATUS;
+-------------------+----------+--------------+------------------+-------------------+
| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+-------------------+----------+--------------+------------------+-------------------+
| master-bin.000008 |  5525554 |              |                  |                   |
+-------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;2.每一次重启MySQL服务器或者FLUSH LOGS，日志文件都会滚动。FLUSH LOGS，对错误日志等没有意义，它主要是用来滚动二进制日志和中继日志的。二进制日志不像事务日志ib_logfile0、ib_logfile1，反复被用到。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; FLUSH LOGS;       
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;3.查看有多少二进制日志文件及其大小&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW BINARY LOGS; 
+-------------------+-----------+
| Log_name          | File_size |
+-------------------+-----------+
| master-bin.000001 |     67251 |
| master-bin.000002 |   1361538 |
| master-bin.000003 |  73892389 |
| master-bin.000004 |       120 |
| master-bin.000005 |   5076873 |
| master-bin.000006 |   8200661 |
| master-bin.000007 |  30885330 |
| master-bin.000008 |   5525554 |
+-------------------+-----------+
8 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;我们可以通过删除文件的方式清除二进制日志，注意不到万不得已，千万不要手动删除。而且手动删除也不是通过删除文件删除的，而是通过PURGE命令删除的。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; HELP PURGE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name: &amp;apos;PURGE BINARY LOGS&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Description:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Syntax:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;PURGE &amp;#123; BINARY | MASTER &amp;#125; LOGS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#123; TO &amp;apos;log_name&amp;apos; | BEFORE datetime_expr &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;The binary log is a set of files that contain information about data&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;modifications made by the MySQL server. The log consists of a set of&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;binary log files, plus an index file (see&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;http://dev.mysql.com/doc/refman/5.6/en/binary-log.html).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;The PURGE BINARY LOGS statement deletes all the binary log files listed&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;in the log index file prior to the specified log file name or date.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;BINARY and MASTER are synonyms. Deleted log files also are removed from&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the list recorded in the index file, so that the given log file becomes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the first in the list.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;This statement has no effect if the server was not started with the&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;--log-bin option to enable binary logging.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;URL: http://dev.mysql.com/doc/refman/5.6/en/purge-binary-logs.html&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Examples:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;PURGE BINARY LOGS TO &amp;apos;mysql-bin.010&amp;apos;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;PURGE BINARY LOGS BEFORE &amp;apos;2008-04-02 22:46:26&amp;apos;;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;4.查看事件信息&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; HELP SHOW BINLOG EVENTS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name: &amp;apos;SHOW BINLOG EVENTS&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Description:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Syntax:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;SHOW BINLOG EVENTS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   [IN &amp;apos;log_name&amp;apos;] [FROM pos] [LIMIT [offset,] row_count]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Shows the events in the binary log. If you do not specify &amp;apos;log_name&amp;apos;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;the first binary log is displayed.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;URL: http://dev.mysql.com/doc/refman/5.6/en/show-binlog-events.html&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW BINLOG EVENTS IN &amp;apos;master-bin.000001&amp;apos;\G
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/91.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;server-id: 服务器身份标识。MySQL的复制模型可以做的很复杂，服务器之间可以互为主从，也就是说各自是对方的主，又各自是对方的从。也就意味着左边的服务器也会复制右边的服务器的二进制日志，右边的机器是从左边的二进制日志中读取信息到中继日志中，并执行，同时写入自己的二进制日志，那左边从右边的二进制日志拿回来在执行一次，也就重复了。为了避免重复，server-id。左边读回来的信息发现是自己的server-id，就不会执行了。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;或者可以使用mysqlbinlog工具查看事件信息：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# mysqlbinlog      
    --start-time
    --stop-time
    --start-position
    --stop-position
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;考虑一种场景：我们当前执行了INSERT INTO t1 VALUE (CURRENT_DATE())，记录到了二进制日志，但是以后拿这个日志跑一遍，很显然这个函数在那个时刻获得值肯定和现在不一样的。&lt;br&gt;MySQL记录二进制日志的格式的三种方式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;基于语句：statement。像上面那个插入语句，就不能基于语句做了，就得把那个时间记录下来，叫基于行记录。&lt;/li&gt;
&lt;li&gt;基于行：row。但是基于行，每个行都得记录，比如我执行了一条语句UPDATE tb1 SET salary=salary+1000; ，如果公司有2万人，基于行记录得产生很大的数据量，但是基于语句，只需要记录这个语句就行。&lt;/li&gt;
&lt;li&gt;混合模式：mixed。由MySQL自动判断基于哪种方式记录。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;二进制日志相关配置&quot;&gt;&lt;a href=&quot;#二进制日志相关配置&quot; class=&quot;headerlink&quot; title=&quot;二进制日志相关配置&quot;&gt;&lt;/a&gt;二进制日志相关配置&lt;/h3&gt;&lt;p&gt;跟二进制日志相关的服务器参数：&lt;br&gt;&lt;strong&gt;1.log_bin = {ON|OFF},&lt;/strong&gt; 是否开启二进制日志。还可以是个文件路径。同样二进制日志文件也不要和数据文件放在一起。建议在安装好MySQL就配置好二进制日志文件存放路径和没给你做。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@db ~]# vim /etc/my.cnf
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/92.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.log_bin_trust_function_creators：&lt;/strong&gt;用于控制创建存储函数时如果会导致不完全事件的记录。一般是OFF。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.sql_log_bin = {ON|OFF} &lt;/strong&gt; sql_log_bin 是一个动态变量，修改该变量时，可以只对当前会话生效（Session），也可以是全局的（Global），当全局修改这个变量时，只会对新的会话生效（这意味当对当前会话也不会生效），因此一般全局修改了这个变量后，都要把原来的所有连接 kill 掉。在 mysql 启动时，通过命令行或配置文件决定是否开启 binlog，而 log_bin 这个变量仅仅是报告当前 binlog 系统的状态（打开与否）。若你想要关闭 binlog，你可以通过修改 sql_log_bin 并把原来的连接 kill 掉，也可以修改 log_bin，然后重启 mysql，后者更彻底，缺点就是需要重启。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;4.sync_binlog：&lt;/strong&gt;设定多久同步一次。就是定义多久将缓冲区中的二进制日志信息同步到二进制日志文件中。时间间隔越长，性能就越好，但数据安全性就越差。默认为0，表示不同步，也就是不靠时间来控制。如果你给的是正值，就表示每隔多长时间会同步。事实上如果你的auto_commit=0，意味着每一次事务提交时才会自动同步。虽然这里是二进制日志，和事务没关系，但为了保证事务安全，每一次事务提交时都会同步二进制日志。因此如果auto_commit=1，每个语句执行完都会同步，这是相当的性能低下。sync_binlog和MySQL的性能密切相关，虽然说不至于和事务日志、事务日志的刷写方式影响那么严重，这也是应该引起我们重视的一个服务器参数。=0反而是性能表现比较好的方式。默认情况下auto_commint=1，见下图。建议关闭。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;5.binlog_format = {statement|row|mixed}&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;6.max_binlog_cache_size = &lt;/strong&gt;&lt;br&gt;二进制日志缓冲空间大小，从MySQL5.5.9以后仅用于缓冲事务类的语句。一般不需要调整。如果是非事务类的，比如Aria存储引擎，max_binlog_stmt_cache_size。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;7.max_binlog_stmt_cache_size =&lt;/strong&gt;&lt;br&gt;非事务类的和事务类的共用的空间大小。一般不需要调整。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;8.max_binlog_size = &lt;/strong&gt;&lt;br&gt;二进制日志文件上限。一旦超过这个大小，就自动滚动了。默认单位是bytes。&lt;/p&gt;
&lt;p&gt;建议：切勿将二进制日志与数据文件放在一同设备。MySQL的很多默认设定并不适合生产环境，我们需要调整。&lt;/p&gt;
&lt;p&gt;中继日志：对于非从服务器，其中继日志默认是不启用的。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;relay_log_purge={ON|OFF} 是否自动清理 不再需要的中继日志。
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;总结日志相关的服务器参数&quot;&gt;&lt;a href=&quot;#总结日志相关的服务器参数&quot; class=&quot;headerlink&quot; title=&quot;总结日志相关的服务器参数&quot;&gt;&lt;/a&gt;总结日志相关的服务器参数&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;expire_logs_days={0..99}&lt;br&gt;设定二进制日志的过期天数，超出此天数的二进制日志文件将被自动删除。默认为0，表示不启用过期自动删除功能。如果启用此功能，自动删除工作通常发生在MySQL启动时或FLUSH日志时。作用范围为全局，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;general_log={ON|OFF}&lt;br&gt;设定是否启用查询日志，默认值为取决于在启动mysqld时是否使用了–general_log选项。如若启用此项，其输出位置则由–log_output选项进行定义，如果log_output的值设定为NONE，即使用启用查询日志，其也不会记录任何日志信息。作用范围为全局，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;general_log_file=FILE_NAME&lt;br&gt;查询日志的日志文件名称，默认为“hostname.log”。作用范围为全局，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;binlog-format={ROW|STATEMENT|MIXED}&lt;br&gt;指定二进制日志的类型，默认为STATEMENT。如果设定了二进制日志的格式，却没有启用二进制日志，则MySQL启动时会产生警告日志信息并记录于错误日志中。作用范围为全局或会话，可用于配置文件，且属于动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log={YES|NO}&lt;br&gt;是否启用记录所有语句的日志信息于一般查询日志(general query log)中，默认通常为OFF。MySQL 5.6已经弃用此选项。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log-bin={YES|NO}&lt;br&gt;是否启用二进制日志，如果为mysqld设定了–log-bin选项，则其值为ON，否则则为OFF。其仅用于显示是否启用了二进制日志，并不反应log-bin的设定值。作用范围为全局级别，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_bin_trust_function_creators={TRUE|FALSE}&lt;br&gt;此参数仅在启用二进制日志时有效，用于控制创建存储函数时如果会导致不安全的事件记录二进制日志条件下是否禁止创建存储函数。默认值为0，表示除非用户除了CREATE ROUTING或ALTER ROUTINE权限外还有SUPER权限，否则将禁止创建或修改存储函数，同时，还要求在创建函数时必需为之使用DETERMINISTIC属性，再不然就是附带READS SQL DATA或NO SQL属性。设置其值为1时则不启用这些限制。作用范围为全局级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_error=/PATH/TO/ERROR_LOG_FILENAME&lt;br&gt;定义错误日志文件。作用范围为全局或会话级别，可用于配置文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_output={TABLE|FILE|NONE}&lt;br&gt;定义一般查询日志和慢查询日志的保存方式，可以是TABLE、FILE、NONE，也可以是TABLE及FILE的组合(用逗号隔开)，默认为TABLE。如果组合中出现了NONE，那么其它设定都将失效，同时，无论是否启用日志功能，也不会记录任何相关的日志信息。作用范围为全局级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_query_not_using_indexes={ON|OFF}&lt;br&gt;设定是否将没有使用索引的查询操作记录到慢查询日志。作用范围为全局级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_slave_updates&lt;br&gt;用于设定复制场景中的从服务器是否将从主服务器收到的更新操作记录进本机的二进制日志中。本参数设定的生效需要在从服务器上启用二进制日志功能。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_slow_queries={YES|NO}&lt;br&gt;是否记录慢查询日志。慢查询是指查询的执行时间超出long_query_time参数所设定时长的事件。MySQL 5.6将此参数修改为了slow_query_log。作用范围为全局级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log_warnings=#&lt;br&gt;设定是否将警告信息记录进错误日志。默认设定为1，表示启用；可以将其设置为0以禁用；而其值为大于1的数值时表示将新发起连接时产生的“失败的连接”和“拒绝访问”类的错误信息也记录进错误日志。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;long_query_time=#&lt;br&gt;设定区别慢查询与一般查询的语句执行时间长度。这里的语句执行时长为实际的执行时间，而非在CPU上的执行时长，因此，负载较重的服务器上更容易产生慢查询。其最小值为0，默认值为10，单位是秒钟。它也支持毫秒级的解析度。作用范围为全局或会话级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;max_binlog_cache_size{4096 .. 18446744073709547520}&lt;br&gt;二进定日志缓存空间大小，5.5.9及以后的版本仅应用于事务缓存，其上限由max_binlog_stmt_cache_size决定。作用范围为全局级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;max_binlog_size={4096 .. 1073741824}&lt;br&gt;设定二进制日志文件上限，单位为字节，最小值为4K，最大值为1G，默认为1G。某事务所产生的日志信息只能写入一个二进制日志文件，因此，实际上的二进制日志文件可能大于这个指定的上限。作用范围为全局级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;max_relay_log_size={4096..1073741824}&lt;br&gt;设定从服务器上中继日志的体积上限，到达此限度时其会自动进行中继日志滚动。此参数值为0时，mysqld将使用max_binlog_size参数同时为二进制日志和中继日志设定日志文件体积上限。作用范围为全局级别，可用于配置文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;innodb_log_buffer_size={262144 .. 4294967295}&lt;br&gt;设定InnoDB用于辅助完成日志文件写操作的日志缓冲区大小，单位是字节，默认为8MB。较大的事务可以借助于更大的日志缓冲区来避免在事务完成之前将日志缓冲区的数据写入日志文件，以减少I/O操作进而提升系统性能。因此，在有着较大事务的应用场景中，建议为此变量设定一个更大的值。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;innodb_log_file_size={108576 .. 4294967295}&lt;br&gt;设定日志组中每个日志文件的大小，单位是字节，默认值是5MB。较为明智的取值范围是从1MB到缓存池体积的1/n，其中n表示日志组中日志文件的个数。日志文件越大，在缓存池中需要执行的检查点刷写操作就越少，这意味着所需的I/O操作也就越少，然而这也会导致较慢的故障恢复速度。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;innodb_log_files_in_group={2 .. 100}&lt;br&gt;设定日志组中日志文件的个数。InnoDB以循环的方式使用这些日志文件。默认值为2。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;innodb_log_group_home_dir=/PATH/TO/DIR&lt;br&gt;设定InnoDB重做日志文件的存储目录。在缺省使用InnoDB日志相关的所有变量时，其默认会在数据目录中创建两个大小为5MB的名为ib_logfile0和ib_logfile1的日志文件。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;relay_log=file_name&lt;br&gt;设定中继日志的文件名称，默认为host_name-relay-bin。也可以使用绝对路径，以指定非数据目录来存储中继日志。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;relay_log_index=file_name&lt;br&gt;设定中继日志的索引文件名，默认为为数据目录中的host_name-relay-bin.index。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;relay-log-info-file=file_name&lt;br&gt;设定中继服务用于记录中继信息的文件，默认为数据目录中的relay-log.info。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;relay_log_purge={ON|OFF}&lt;br&gt;设定对不再需要的中继日志是否自动进行清理。默认值为ON。作用范围为全局级别，可用于选项文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;relay_log_space_limit=#&lt;br&gt;设定用于存储所有中继日志文件的可用空间大小。默认为0，表示不限定。最大值取决于系统平台位数。作用范围为全局级别，可用于选项文件，属非动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;slow_query_log={ON|OFF}&lt;br&gt;设定是否启用慢查询日志。0或OFF表示禁用，1或ON表示启用。日志信息的输出位置取决于log_output变量的定义，如果其值为NONE，则即便slow_query_log为ON，也不会记录任何慢查询信息。作用范围为全局级别，可用于选项文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;slow_query_log_file=/PATH/TO/SOMEFILE&lt;br&gt;设定慢查询日志文件的名称。默认为hostname-slow.log，但可以通过–slow_query_log_file选项修改。作用范围为全局级别，可用于选项文件，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;sql_log_bin={ON|OFF}&lt;br&gt;用于控制二进制日志信息是否记录进日志文件。默认为ON，表示启用记录功能。用户可以在会话级别修改此变量的值，但其必须具有SUPER权限。作用范围为全局和会话级别，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;sql_log_off={ON|OFF}&lt;br&gt;用于控制是否禁止将一般查询日志类信息记录进查询日志文件。默认为OFF，表示不禁止记录功能。用户可以在会话级别修改此变量的值，但其必须具有SUPER权限。作用范围为全局和会话级别，属动态变量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;sync_binlog=#&lt;br&gt;设定多久同步一次二进制日志至磁盘文件中，0表示不同步，任何正数值都表示对二进制每多少次写操作之后同步一次。当autocommit的值为1时，每条语句的执行都会引起二进制日志同步，否则，每个事务的提交会引起二进制日志同步。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;MySQL日志&quot;&gt;&lt;a href=&quot;#MySQL日志&quot; class=&quot;headerlink&quot; title=&quot;MySQL日志&quot;&gt;&lt;/a&gt;MySQL日志&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;查询日志&lt;br&gt;这是最不应该记录的日志。因为一个非常繁忙的数据库服务器，其查询会有很多，每一次都记录日志会导致系统性能下降。
    
    </summary>
    
      <category term="MySQL" scheme="http://yoursite.com/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="http://yoursite.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL用户管理及查询缓存详解</title>
    <link href="http://yoursite.com/2018/04/12/MySQL%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E5%8F%8A%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98%E8%AF%A6%E8%A7%A3/"/>
    <id>http://yoursite.com/2018/04/12/MySQL用户管理及查询缓存详解/</id>
    <published>2018-04-12T06:46:07.000Z</published>
    <updated>2018-04-13T02:31:16.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;MySQL用户管理&quot;&gt;&lt;a href=&quot;#MySQL用户管理&quot; class=&quot;headerlink&quot; title=&quot;MySQL用户管理&quot;&gt;&lt;/a&gt;MySQL用户管理&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;用户帐号：username@hostname, password       
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;表示这个账号允许通过hostname主机连入mysql服务器。hostname可以是单个ip，也可以是一个网络，也可以是通配符。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/85.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;MySQL对用户帐号的管理是分两步的：创建和授权。&lt;/p&gt;
&lt;h3 id=&quot;用户账号管理&quot;&gt;&lt;a href=&quot;#用户账号管理&quot; class=&quot;headerlink&quot; title=&quot;用户账号管理&quot;&gt;&lt;/a&gt;用户账号管理&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;CREATE USER   #使用这种方式创建完用户后，他仅能够连入mysql服务器，并能够执行有限的查看类命令，想创建数据库、创建表、插入数据等没有权限。&lt;/li&gt;
&lt;li&gt;DROP UESER&lt;/li&gt;
&lt;li&gt;RENAME USER&lt;/li&gt;
&lt;li&gt;SET PASSWORD&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;CREATE-USER&quot;&gt;&lt;a href=&quot;#CREATE-USER&quot; class=&quot;headerlink&quot; title=&quot;CREATE USER&quot;&gt;&lt;/a&gt;CREATE USER&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;CREATE USER username@hostname
   [
       IDENTIFIED BY [PASSWORD] &amp;apos;password&amp;apos;
   ]            
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;【注意】:如果不给密码就是空密码。&lt;/p&gt;
&lt;p&gt;主机也可使用通配符：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;%：匹配任何字符
_: 匹配单个字符
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;【示例】：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;testuser@&amp;apos;172.16.100.1__&amp;apos; 代表 172.16.100.100-172.16.100.199


mysql&amp;gt; CREATE USER testuser@&amp;apos;172.16.%.%&amp;apos; IDENTIFIED BY &amp;apos;testpass&amp;apos;;
Query OK, 0 rows affected (0.13 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;对于CREATE USER、GRANT来说，FLUSH不是必须的。然后我们使用这个刚创建的用户账户连接mysql，&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@res ~]# mysql -h172.16.206.30  -utestuser -p
Enter password: 
mysql&amp;gt; CREATE DATABASE mydb;
ERROR 1044 (42000): Access denied for user &amp;apos;testuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos; to database &amp;apos;mydb&amp;apos;
mysql&amp;gt; SHOW GRANTS FOR &amp;apos;testuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos;;
+-------------------------------------------------------------------------------+
| Grants for testuser@172.16.%.%                                                |
+-------------------------------------------------------------------------------+
| GRANT USAGE ON *.* TO &amp;apos;testuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos; IDENTIFIED BY PASSWORD &amp;lt;secret&amp;gt; |
+-------------------------------------------------------------------------------+
1 row in set (0.04 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;【说明】：USAGE：只是一个简单的连入mysql服务器的权限。这是默认获取的授权。&lt;/p&gt;
&lt;p&gt;查看用户能够使用的权限：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;SHOW GRANTS FOR username@&amp;apos;hostname&amp;apos;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;重命名用户账号：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; RENAME USER &amp;apos;testuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos; TO &amp;apos;tuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos;;
Query OK, 0 rows affected (0.01 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;权限管理&quot;&gt;&lt;a href=&quot;#权限管理&quot; class=&quot;headerlink&quot; title=&quot;权限管理&quot;&gt;&lt;/a&gt;权限管理&lt;/h3&gt;&lt;p&gt;权限管理命令：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;GRANT    #GRANT命令在用户事先不存在的前提下，它可以自动创建用户。&lt;/li&gt;
&lt;li&gt;REVOKE&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;权限管理分类&quot;&gt;&lt;a href=&quot;#权限管理分类&quot; class=&quot;headerlink&quot; title=&quot;权限管理分类&quot;&gt;&lt;/a&gt;权限管理分类&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;库级别&lt;/li&gt;
&lt;li&gt;表级别&lt;/li&gt;
&lt;li&gt;字段级别&lt;/li&gt;
&lt;li&gt;管理类：比如能否把自己的权限转赠给其他用户、能否创建用户、能否执行复制等。&lt;/li&gt;
&lt;li&gt;程序类：比如存储过程、存储函数、触发器。   (这两类是我们自己定义的)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;1.管理类权限&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CREATE TEMPORARY TABLES&lt;/li&gt;
&lt;li&gt;CREATE USER&lt;/li&gt;
&lt;li&gt;FILE：在服务器上能够读取或写入文件的。比如我们通过客户端连入mysql服务器，如果想把mysql的查询结果保存到文件中，这个文件很显然就是在服务器上的。这个权限很危险，不能让用户随意使用。&lt;/li&gt;
&lt;li&gt;SUPER：杂项管理类命令。&lt;/li&gt;
&lt;li&gt;SHOW DATABASES&lt;/li&gt;
&lt;li&gt;RELOAD&lt;/li&gt;
&lt;li&gt;SHUTDOWN&lt;/li&gt;
&lt;li&gt;REPLICATION SLAVE&lt;/li&gt;
&lt;li&gt;REPLICATION CLIENT&lt;/li&gt;
&lt;li&gt;LOCK TABLES：显式施加表锁。&lt;/li&gt;
&lt;li&gt;PROCESS：查看当前服务器上执行的所有进程，可以理解为线程。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;查看当前MySQL服务器上的执行的所有线程：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW PROCESSLIST;
+---------+----------------+----------------------+------------+---------+------+-------+------------------+
| Id      | User           | Host                 | db         | Command | Time | State | Info             |
+---------+----------------+----------------------+------------+---------+------+-------+------------------+
| 7793848 | root           | localhost            | NULL       | Query   |    0 | init  | SHOW PROCESSLIST |
| 7793872 | sonar          | localhost:57831      | sonar      | Sleep   |   41 |       | NULL             |
| 7794027 | testuser       | res.wisedu.com:39982 | NULL       | Sleep   |  241 |       | NULL             |
...
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;【注意】: 这个命令是我们将来非常常用的命令，用于查看当前mysql上内部所执行的众多跟用户相关的线程的。&lt;/strong&gt;   &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.库级别和表级别&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ALTER&lt;/li&gt;
&lt;li&gt;ALTER ROUTINE：修改存储例程，包括存储过程和存储函数。&lt;/li&gt;
&lt;li&gt;CREATE &lt;/li&gt;
&lt;li&gt;CREATE ROUTINE&lt;/li&gt;
&lt;li&gt;CREATE VIEW&lt;/li&gt;
&lt;li&gt;DROP&lt;/li&gt;
&lt;li&gt;EXECUTE：是否能够执行存储过程或存储函数。&lt;/li&gt;
&lt;li&gt;GRNAT OPTION：把自己获得的权限转赠给别人。&lt;/li&gt;
&lt;li&gt;INDEX&lt;/li&gt;
&lt;li&gt;SHOW VIEW：查看一个视图是怎么被创建的。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;3.数据操作(表级别)&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SELECT&lt;/li&gt;
&lt;li&gt;INSERT&lt;/li&gt;
&lt;li&gt;UPDATE&lt;/li&gt;
&lt;li&gt;DELETE&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;4.数据操作(字段级别)&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SELECT(col1,…)&lt;/li&gt;
&lt;li&gt;UPDATE(col1,…)&lt;/li&gt;
&lt;li&gt;INSERT(col1,…)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;5.所有权限&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ALL [PRIVILEGES]&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;权限管理命令之GRANT&quot;&gt;&lt;a href=&quot;#权限管理命令之GRANT&quot; class=&quot;headerlink&quot; title=&quot;权限管理命令之GRANT&quot;&gt;&lt;/a&gt;权限管理命令之GRANT&lt;/h4&gt;&lt;p&gt;两种使用格式：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;GRANT ALL ON [FUNCTION] *.*      
第一个*表示库，如果第一个*前面没有修饰，那默认第2个*表示表，否则比如加个FUNCTION，第二个*表示的就是某个库的存储函数。修饰有3个，[TABLE|FUNCTION|PROCEDURE]。
&lt;/code&gt;&lt;/pre&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; HELP GRANT&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name: &amp;apos;GRANT&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Description:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Syntax:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;GRANT&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    priv_type [(column_list)]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      [, priv_type [(column_list)]] ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ON [object_type] priv_level&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    TO user_specification [, user_specification] ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    [REQUIRE &amp;#123;NONE | ssl_option [[AND] ssl_option] ...&amp;#125;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    [WITH &amp;#123;GRANT OPTION | resource_option&amp;#125; ...]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;GRANT PROXY ON user_specification&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    TO user_specification [, user_specification] ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    [WITH GRANT OPTION]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;object_type: &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    TABLE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | FUNCTION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | PROCEDURE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;priv_level: &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    *&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | *.*&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | db_name.*&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | db_name.tbl_name&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | tbl_name&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | db_name.routine_name&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;user_specification:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    user [ auth_option ]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;auth_option: &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    IDENTIFIED BY &amp;apos;auth_string&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | IDENTIFIED BY PASSWORD &amp;apos;hash_string&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | IDENTIFIED WITH auth_plugin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | IDENTIFIED WITH auth_plugin AS &amp;apos;hash_string&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ssl_option: &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    SSL&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | X509&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | CIPHER &amp;apos;cipher&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | ISSUER &amp;apos;issuer&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | SUBJECT &amp;apos;subject&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;GRANT OPTION # 允许把自己的权限转赠给其他用户&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;resource_option: &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | MAX_QUERIES_PER_HOUR count #每小时所能执行的最多查询请求的次数，这是做资源限定的&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | MAX_UPDATES_PER_HOUR count # 每小时所能执行的最多更新的次数&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | MAX_CONNECTIONS_PER_HOUR count&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  | MAX_USER_CONNECTIONS count # 指定某个用户帐号最多同时连接几次&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在上面那个例子中，我们使用普通用户 tuser@’172.16.%.%’ 连接上去是不能创建数据库的，接下来我们使用root账户登录上去授权这个普通用户一些权限，看看效果：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; GRANT CREATE ON mydb.tb1 TO &amp;apos;tuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos;;
Query OK, 0 rows affected (0.02 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;【注意】:这个权限只能创建tb1这个表，不能创建库mydb，见下面。管理员授权后，普通用户连接上mysql，可以查看自己的权限：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW GRANTS FOR &amp;apos;tuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos;;   
+----------------------------------------------------------------------------+
| Grants for tuser@172.16.%.%                                                |
+----------------------------------------------------------------------------+
| GRANT USAGE ON *.* TO &amp;apos;tuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos; IDENTIFIED BY PASSWORD &amp;lt;secret&amp;gt; |
| GRANT CREATE ON `mydb`.`tb1` TO &amp;apos;tuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos;                       |
+----------------------------------------------------------------------------+
2 rows in set (0.00 sec)

mysql&amp;gt; CREATE DATABASE mydb;
ERROR 1044 (42000): Access denied for user &amp;apos;tuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos; to database &amp;apos;mydb&amp;apos;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;此时确实不能创建数据库。使用root账号授权如下：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; GRANT CREATE ON mydb.* TO &amp;apos;tuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos;;   
Query OK, 0 rows affected (0.03 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;普通用户再次查看自己的权限，然后在创建数据库就可以了：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW GRANTS FOR &amp;apos;tuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos;;
+----------------------------------------------------------------------------+
| Grants for tuser@172.16.%.%                                                |
+----------------------------------------------------------------------------+
| GRANT USAGE ON *.* TO &amp;apos;tuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos; IDENTIFIED BY PASSWORD &amp;lt;secret&amp;gt; |
| GRANT CREATE ON `mydb`.* TO &amp;apos;tuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos;                           |
| GRANT CREATE ON `mydb`.`tb1` TO &amp;apos;tuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos;                       |
+----------------------------------------------------------------------------+
3 rows in set (0.00 sec)

mysql&amp;gt; CREATE DATABASE mydb;
Query OK, 1 row affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/86.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;在赋予删除表的权限：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; GRANT DROP ON mydb.* TO &amp;apos;tuser&amp;apos;@&amp;apos;172.16.%.%&amp;apos;;      
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;普通用户查看权限和删除表、库：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/87.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;所以为了让那些在线用户能够立即获取权限，就要在授权后FLUSH。&lt;/p&gt;
&lt;h4 id=&quot;权限管理命令之REVOKE&quot;&gt;&lt;a href=&quot;#权限管理命令之REVOKE&quot; class=&quot;headerlink&quot; title=&quot;权限管理命令之REVOKE&quot;&gt;&lt;/a&gt;权限管理命令之REVOKE&lt;/h4&gt;&lt;p&gt;两种使用格式：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;REVOKE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  priv_type [(column_list)]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    [, priv_type [(column_list)]] ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  ON [object_type] priv_level&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  FROM user [, user] ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;REVOKE ALL PRIVILEGES, GRANT OPTION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  FROM user [, user] ...&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;所有给用户授权的这些权限都会保存在跟用户相关的授权表当中，几个跟用户授权相关的表(都在mysql库中)：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;db: 库级别权限。&lt;/li&gt;
&lt;li&gt;host: 主机级别权限，已废弃。&lt;/li&gt;
&lt;li&gt;tables_priv: 表级别权限。&lt;/li&gt;
&lt;li&gt;colomns_priv：列级别的权限。&lt;/li&gt;
&lt;li&gt;procs_priv：存储过程和存储函数相关的权限。&lt;/li&gt;
&lt;li&gt;proxies_priv：代理用户权限。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/88.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;对MySQL来讲，检查用户授权分两个阶段，mysql用户刚刚执行连入数据库时需要认证，检查用户名密码并且检查用户是否有连进来的权限；连接进来以后，用户每次执行SELECT操作也要检验权限。所以MySQL在执行权限检查时，几乎每一次操作都涉及到，这也是为什么mysql为什么将授权表载入内存中的原因，不然它的速度会有多慢。&lt;br&gt;    如果用户在登录mysql时输错了命令，连续输错了好多次，会被mysql锁定的。再次登录，mysql会直接拒绝了，不会检查授权表。mysql认为这是尝试攻击。如果遇到这种情况，我们需要FLUSH hosts，让系统清空一下hosts相关的缓存，这样用户就可以再次连接。&lt;/p&gt;
&lt;p&gt;之前的文章中提到过MySQL作者在MySQL被Oracle收购后，又带着团队重新开发了MariaDB。在MariaDB中，有两款支持事务的，FEDERATED和InnoDB。只不过FEDERATED不支持XA(分布式事务)。&lt;br&gt;Aria是增强版的MyISAM。&lt;br&gt;MySQL和MariaDB除了这些存储引擎上的区别，他们两个区别并不大。但是要注意MariaDB的服务器变量非常多，有400多个。&lt;/p&gt;
&lt;h2 id=&quot;MySQL查询缓存&quot;&gt;&lt;a href=&quot;#MySQL查询缓存&quot; class=&quot;headerlink&quot; title=&quot;MySQL查询缓存&quot;&gt;&lt;/a&gt;MySQL查询缓存&lt;/h2&gt;&lt;p&gt;每个查询语句要做词法分析，语法分析、语义分析，然后执行解析树，从中选择一个最优路径，并且通过优化器重写查询，并选择合适的索引完成查询操作。而如果这个查询计划被缓存下来，多个用户使用同一个SELECT语句时，语句如果避免二次解析，它就能够加速查询操作。&lt;br&gt;    用于保存MySQL查询语句返回的完整结果。被命中时，MySQL会立即返回结果，省去解析、优化和执行等阶段。&lt;br&gt;    但是查询缓存带来的未必都是好事。为什么呢？现在运行数据库数据的服务器硬件越来越强大，内存动辄几十个g，32g、64g都很常见，而且CPU动辄就是好几颗，每一颗都有好多核，而多个用户同时连进来时，每个用户都有一个连接线程，这些线程会被分配到多颗CPU上执行的。由于MySQL的内生性限制，单独的一条查询最多只能在一颗CPU上执行，如果我们使用了查询缓存，多个用户都执行查询操作，每个查询操作都要查缓存，也就意味着缓存会成为多个能够并发在多颗CPU上执行的查询请求的热点所在，会不会争用。第一个线程发起了查询语句，去查了缓存，假设2颗CPU，每颗32核，现在连进来了64个用户，大家都发起了查询操作，都去查询缓存，所以缓存就成为资源争用的热点所在了。在某一时刻，这段内存空间只能为其中一颗CPU所访问。所以在这种场景下，缓存所带来的未必有我们想象中的好。因为你不能只用单颗CPU的方式去思考mysql服务器。并发查询量非常大，而且CPU核心数又非常多时，缓存是否有效就是个值得思考的问题。&lt;/p&gt;
&lt;p&gt;一个mysql查询操作会经过类似的步骤：&lt;br&gt;   一个查询请求来了，首先检查缓存是否命中，命中则直接返回结果。没命中，解析、优化、执行，执行后的结果先看看能否进行缓存，如果能，缓存到缓存中，然后在把结果返回给用户。&lt;/p&gt;
&lt;h3 id=&quot;什么样的语句不会被缓存？&quot;&gt;&lt;a href=&quot;#什么样的语句不会被缓存？&quot; class=&quot;headerlink&quot; title=&quot;什么样的语句不会被缓存？&quot;&gt;&lt;/a&gt;什么样的语句不会被缓存？&lt;/h3&gt;&lt;p&gt;查询语句中有一些不确定数据时，不会缓存：例如NOW(), CURRENT_TIME()；一般来说，如果查询中包含用户自定义函数、存储函数、用户变量、临时表、mysql库中系统表、或者任何包含权限的表，一般都不会缓存；&lt;/p&gt;
&lt;h3 id=&quot;缓存会带来额外开销&quot;&gt;&lt;a href=&quot;#缓存会带来额外开销&quot; class=&quot;headerlink&quot; title=&quot;缓存会带来额外开销&quot;&gt;&lt;/a&gt;缓存会带来额外开销&lt;/h3&gt;&lt;p&gt;缓存会带来如下的开销，只有当这种开销小于缓存给我们带来的益处时才有必要启用缓存&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;每个查询都得先检查是否命中；&lt;/li&gt;
&lt;li&gt;查询结果要先缓存；&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;查看当前MySQL上缓存的配置：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW GLOBAL VARIABLES LIKE &amp;apos;query_cache%&amp;apos;;
+------------------------------+---------+
| Variable_name                | Value   |
+------------------------------+---------+
| query_cache_limit            | 1048576 |
| query_cache_min_res_unit     | 4096    |
| query_cache_size             | 1048576 |
| query_cache_type             | OFF     |
| query_cache_wlock_invalidate | OFF     |
+------------------------------+---------+
5 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;query_cache_type: 查询缓存类型；就是指是否开启缓存功能，其开启方式有三种{ON|OFF|DEMAND}；&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DEMAND：意味着SELECT语句明确使用 SQL_CACHE 选项时才会缓存；&lt;/li&gt;
&lt;li&gt;一般而言除非我们明确知道哪些语句缓存下来才有意义的时候才会使用DEMAND，否则我们如果要想使用缓存机制，设置为ON。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;query_cache_size: 总空间，单位为字节，大小必须是1024的整数倍。16777216是16M，比较小。如果内存够用，可以调大点，但是也不要太大，看你命中率。如果调大能提高命中率，就应该调大些。但是查询命中率，要先”预热”，刚开机你就去查缓存命中率，那没意义。MySQL启动时，会一次性分配并立即初始化这里指定大小的内存空间；这意味着，如果修改此大小，会清空缓存并重新初始化的。不建议经常改，最好事先设置好。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;query_cache_min_res_unit: 存储缓存的最小内存块；(query_cache_size-Qcache_free_memory)/Qcache_queries_in_cache能够获得一个理想的值。缓存必须要划分成内存块进行缓存的，比如一个划分的内存块一个为1k，某一个查询结果只有30bytes，缓存在一个内存块里，剩余的空间就浪费了。所以这个内存块太大了会导致浪费，太小了我缓存一个大结果，得申请很多个内存块才能存下来。最好你能够观测一下大多数查询，很多结果都是满足正太分布的，找那些分布率比较集中的地方的缓存大小。当然也可以用上面的公式去计算，得到的值是比较理想的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;query_cache_limit: 单个缓存对象的最大值，超出时则不予缓存；可以在SELECT语句中手动使用SQL_NO_CACHE可以人为地避免尝试缓存返回结果超出此参数限定值的语句。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;query_cache_wlock_invalidate: 如果某个表被其它用户的连接(查询)锁住了，是否仍然从缓存中返回结果。OFF表示返回。&lt;br&gt;因为其他用户锁住了表，他可能会改表中的数据，也可能不改，这个时候是返回还是不返回呢？&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;如何检查缓存？&quot;&gt;&lt;a href=&quot;#如何检查缓存？&quot; class=&quot;headerlink&quot; title=&quot;如何检查缓存？&quot;&gt;&lt;/a&gt;如何检查缓存？&lt;/h3&gt;&lt;p&gt;MySQL保存结果于缓存中：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;把SELECT语句本身做hash计算，计算的结果作为key，查询结果作为value。&lt;/li&gt;
&lt;li&gt;所以缓存由两个字段组成，一个是key，一个是value。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;缓存到底有没有效不能简单的根据有多少SELECT语句来判定，我们要去判定缓存命中率。但是这个缓存命中率的高和低不能简单的根据查询的命中次数来判定，一般来讲，要根据它的开销来判断命中率到底有多高。命中率有两种，次数命中率和字节命中率(命中后所省去的传输数据量)。&lt;/p&gt;
&lt;h3 id=&quot;如何判断命中率？&quot;&gt;&lt;a href=&quot;#如何判断命中率？&quot; class=&quot;headerlink&quot; title=&quot;如何判断命中率？&quot;&gt;&lt;/a&gt;如何判断命中率？&lt;/h3&gt;&lt;p&gt;查看次数命中率，而不是字节命中率。衡量时最好都衡量&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; SHOW GLOBAL STATUS LIKE &amp;apos;Qcache%&amp;apos;;     &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+-------------------------+----------+&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Variable_name           | Value    |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+-------------------------+----------+&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Qcache_free_blocks      | 1        | 空闲的块数&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Qcache_free_memory      | 16757008 | 空闲空间&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Qcache_hits             | 4        | 命中次数&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Qcache_inserts          | 2        | 向缓存空间中缓存数据的次数&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Qcache_lowmem_prunes    | 0        | 因为内存太少而腾出内存的次数&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Qcache_not_cached       | 18       | 没被缓存的语句的次数&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Qcache_queries_in_cache | 2        | 在缓存中缓存的查询的个数。和Qcache_inserts不一定一样大。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Qcache_total_blocks     | 6        | 缓存总块数&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+-------------------------+----------+&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;【注意】:总空间-空闲空间=已用空间。但并非已用空间都缓存了数据，这些已用块数表示已划分好格式了，可以随时等待数据缓存进来。&lt;br&gt;如果内存中的确有碎片了，比如说空闲空间还很多，但是内存总是被修剪(腾出)，这可能是有大量碎片导致大结果无法被缓存。这就需要清理碎片了。只是把碎片挪出去，做成连续空间。&lt;br&gt;碎片整理：FLUSH QUERY_CACHE&lt;br&gt;清空缓存：RESET QUERY_CACHE&lt;/p&gt;
&lt;p&gt;计算次数命中率：(节命中率很难估算)&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; SHOW GLOBAL STATUS WHERE Variable_name=&amp;apos;Qcache_hits&amp;apos; OR Variable_name=&amp;apos;Com_select&amp;apos;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+---------------+-------+&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Variable_name | Value |&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+---------------+-------+&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Com_select    | 24    |  一共查询了这么多次&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;| Qcache_hits   | 4     |  命中的查询的次数，注意命中了缓存，上面那个查询次数是不会加1的。&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+---------------+-------+&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Qcache_hits/(Com_select+Qcache_hits)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;也应该参考另外一个指标：命中和写入的比率，即Qcache_hits/Qcache_inserts的值，此比值如果能大于3:1，则表明缓存也是有效的。能达到10:1，为比较理想的情况。&lt;/p&gt;
&lt;h3 id=&quot;缓存优化使用思路&quot;&gt;&lt;a href=&quot;#缓存优化使用思路&quot; class=&quot;headerlink&quot; title=&quot;缓存优化使用思路&quot;&gt;&lt;/a&gt;缓存优化使用思路&lt;/h3&gt;&lt;p&gt;1、批量写入而非多次单个写入；&lt;br&gt;2、缓存空间不宜过大，因为大量缓存同时失效时会导致服务器假死；&lt;br&gt;3、必要时，使用SQL_CACHE和SQL_N0_CACHE手动控制缓存；&lt;br&gt;4、对写密集型的应用场景来说，禁用缓存反而能提高性能。读写比例一样大的时候最好也关了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;MySQL用户管理&quot;&gt;&lt;a href=&quot;#MySQL用户管理&quot; class=&quot;headerlink&quot; title=&quot;MySQL用户管理&quot;&gt;&lt;/a&gt;MySQL用户管理&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;用户帐号：username@hostname, password       
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;表示这个账号允许通过hostname主机连入mysql服务器。hostname可以是单个ip，也可以是一个网络，也可以是通配符。
    
    </summary>
    
      <category term="MySQL" scheme="http://yoursite.com/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="http://yoursite.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL存储引擎对比</title>
    <link href="http://yoursite.com/2018/04/08/MySQL%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%AF%B9%E6%AF%94/"/>
    <id>http://yoursite.com/2018/04/08/MySQL存储引擎对比/</id>
    <published>2018-04-08T08:36:31.000Z</published>
    <updated>2018-04-10T09:12:34.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;MySQL存储引擎&quot;&gt;&lt;a href=&quot;#MySQL存储引擎&quot; class=&quot;headerlink&quot; title=&quot;MySQL存储引擎&quot;&gt;&lt;/a&gt;MySQL存储引擎&lt;/h2&gt;&lt;p&gt;存储引擎也通常称作“表类型”。可以在创建表时指定其存储引擎。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW ENGINES;    #查看支持的存储引擎。
mysql&amp;gt; SHOW TABLES STATUS [LIKE clause] [WHERE clause] #使用WHERE比使用LIKE性能好
SHOW TABLE STATUS [{FROM | IN} db_name] [LIKE &amp;apos;pattern&amp;apos; | WHERE expr] #如果设定了数据库，就不需要指定[{FROM | IN} db_name] 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;【示例】：查看某张表的存储引擎&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW TABLE STATUS IN hellodb WHERE Name=&amp;apos;classes&amp;apos;\G
*************************** 1. row ***************************
               Name: classes
             Engine: InnoDB
            Version: 10
         Row_format: Compact
               Rows: 8
     Avg_row_length: 2048
        Data_length: 16384
    Max_data_length: 0
       Index_length: 0
          Data_free: 9437184
     Auto_increment: 9
        Create_time: 2014-04-08 11:14:52
        Update_time: NULL
         Check_time: NULL
          Collation: utf8_general_ci
           Checksum: NULL
     Create_options: 
            Comment: 
    1 row in set (0.01 sec)   
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;Name: 表名&lt;/li&gt;
&lt;li&gt;Engine: 存储引擎&lt;/li&gt;
&lt;li&gt;Version: 表的版本&lt;/li&gt;
&lt;li&gt;Row_format: 行格式。这些行格式是MySQL在其内部存储行数据时所采用的格式。每一种不同格式，其存储空间、开销是各部相同的。对于MyISAM表，常用的通常有DYNAMIC、FIXED或者COMPRESSED。而对于InnoDB存储引擎来讲，还可以额外使用REDUNDANT、COMPACT等类型。对于InnoDB来讲，默认是COMPACT。&lt;br&gt;{DEFAULT|DYNAMIC|FIXED|COMPRESSED|REDUNDANT|COMPACT}&lt;/li&gt;
&lt;li&gt;Rows: 表中的行数。【注意】:对于MyISAM表来讲是精确的，但是对于InnoDB来讲未必精确。因为InnoDB基于多版本并发控制，里面有多种版本的快照，所以有些行你删了里面依然可能有。所以InnoDB表里的行数可能是个估计值。&lt;/li&gt;
&lt;li&gt;Avg_row_length: 平均每行所包含的字节数。&lt;/li&gt;
&lt;li&gt;Data_length: 表中数据总体大小，单位是字节。Data_length:=RowsXAvg_row_length。&lt;/li&gt;
&lt;li&gt;Max_data_length: 表能够占用的最大空间，单位为字节。0表示没有上限。&lt;/li&gt;
&lt;li&gt;Index_length: 索引的大小，单位为字节。&lt;/li&gt;
&lt;li&gt;Data_free: 对于MyISAM表，表示已经分配但尚未使用的空间(就是划分给这个表的块的剩余空间)，其中包含此前删除行之后腾出来的空间。对于InnoDB表，就比较复杂了。&lt;/li&gt;
&lt;li&gt;Auto_increment: 下一个AUTO_INCREMENT的值；&lt;/li&gt;
&lt;li&gt;Create_time: 表的创建时间；&lt;/li&gt;
&lt;li&gt;Update_time：表数据的最近一次的修改时间；&lt;/li&gt;
&lt;li&gt;Check_time：mysql的一些工具，比如使用CHECK TABLE或myisamchk最近一次检测表的时间；&lt;/li&gt;
&lt;li&gt;Collation: 排序规则；&lt;/li&gt;
&lt;li&gt;Checksum: 如果启用，则为表的checksum；为空表示没有启用校验功能。但是请注意，每次修改表，这个值也会变动，会产生额外的I/O，性能会有影响，但是对表的一致性和数据完整性提供了额外保证；&lt;/li&gt;
&lt;li&gt;Create_options: 创建表时指定使用的其它选项，比如SQL_Cache等选项；&lt;/li&gt;
&lt;li&gt;Comment: 表的注释信息。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;存储引擎中的数据和数据文件&quot;&gt;&lt;a href=&quot;#存储引擎中的数据和数据文件&quot; class=&quot;headerlink&quot; title=&quot;存储引擎中的数据和数据文件&quot;&gt;&lt;/a&gt;存储引擎中的数据和数据文件&lt;/h2&gt;&lt;h3 id=&quot;InnoDB&quot;&gt;&lt;a href=&quot;#InnoDB&quot; class=&quot;headerlink&quot; title=&quot;InnoDB&quot;&gt;&lt;/a&gt;InnoDB&lt;/h3&gt;&lt;p&gt;两种格式：&lt;br&gt;&lt;strong&gt;1、innodb_file_per_table=OFF，即使用共享表空间。&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;每张表有一个独有的格式定义文件: tb_name.frm&lt;/li&gt;
&lt;li&gt;还有一个默认位于数据目录下共享的表空间文件：ibdata#   (一个表空间文件大小到达一定程度后，会启动第二个表空间文件)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;2、innodb_file_per_table=ON，即使用独立表空间。&lt;/strong&gt;&lt;br&gt;每个表在数据库目录下存储两个文件：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;tb_name.frm&lt;/li&gt;
&lt;li&gt;tb_name.ibd&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;表空间：table space，由InnoDB管理的特有格式数据文件，内部可同时存储数据和索引(因此是聚簇索引)。&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;MyISAM&quot;&gt;&lt;a href=&quot;#MyISAM&quot; class=&quot;headerlink&quot; title=&quot;MyISAM&quot;&gt;&lt;/a&gt;MyISAM&lt;/h3&gt;&lt;p&gt;每个表都在数据库目录(data目录)下存储三个文件：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;tb_name.frm  #表结构的定义&lt;/li&gt;
&lt;li&gt;tb_name.MYD  #数据&lt;/li&gt;
&lt;li&gt;tb_name.MYI  #索引&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如何修改默认存储引擎：通过default_storage_engine服务变量实现。要想永久生效，需要写到配置文件中，重启生效。&lt;/p&gt;
&lt;h2 id=&quot;各存储引擎的特性&quot;&gt;&lt;a href=&quot;#各存储引擎的特性&quot; class=&quot;headerlink&quot; title=&quot;各存储引擎的特性&quot;&gt;&lt;/a&gt;各存储引擎的特性&lt;/h2&gt;&lt;p&gt;mysql 5.3.8之后mysql就被oracle收购了，原生自带InnoDB存储引擎了。(以前InnoDB是插件形式工作的，但是自从oracle收购InnoDB后做了很大改进，再到后来收购了sun，InnoDB就自然成为原生的了。)&lt;/p&gt;
&lt;h3 id=&quot;InnoDB-1&quot;&gt;&lt;a href=&quot;#InnoDB-1&quot; class=&quot;headerlink&quot; title=&quot;InnoDB&quot;&gt;&lt;/a&gt;InnoDB&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;支持事务：有事务日志。为什么要有事务日志啊？&lt;strong&gt;因为可以它能够把随机I/O改为顺序I/O。&lt;/strong&gt;事务日志在数据目录下，至少有两个，而且大小固定，不会增长，而且一定是磁盘上的一段连续存储空间。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/82.png&quot; alt=&quot;&quot;&gt;&lt;/li&gt;
&lt;li&gt;支持外键约束：MyISAM是不支持的，因为不支持事务就很难使用外键。&lt;/li&gt;
&lt;li&gt;MVCC：多版本并发控制。&lt;/li&gt;
&lt;li&gt;支持聚簇索引：也叫聚集索引。说白了就是数据和索引存储在一起，通过表空间来实现的。也就意味着创建InnoDB表时必须要有主键。这样的话InnoDB表的查询比MyISAM表的查询多了一步，因为所有非聚集索引(又称为辅助索引)不是指向数据的，而是指向聚簇索引的。什么意思呢？(该节视频31分钟左右开始)。&lt;br&gt;聚簇索引之外的其它索引，通常称为辅助索引。聚簇索引只能有一个，辅助索引可以有多个。&lt;/li&gt;
&lt;li&gt;行级锁：行级锁之上它在实现MVCC机制时是基于”间隙锁”实现的。在行和行之间加间隙锁来隔离行。&lt;/li&gt;
&lt;li&gt;支持辅助索引：有些NoSQL只支持一种索引。&lt;/li&gt;
&lt;li&gt;支持自适应hash索引&lt;/li&gt;
&lt;li&gt;支持热备份：因此数据库不用离线就可以实现备份了。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;【补充】:聚簇索引和辅助索引。&lt;/strong&gt;&lt;br&gt;位于磁盘上的数据，我们需要把所有载入内存才可以查询的，太慢了。于是我们把表中数据按我们经常查询的叫搜索键，通常是一个字段，通常我们用于WHERE子句中比较的字段，把它抽取出来做索引就好了，这样可以提高查询速度的。这个索引文件如果是额外存放的，意味着要把这个字段的值复制一份出来，放在另外一个位置，这就是索引文件。但是这索引信息是要被排序的，它把表中的字段拿出来后重新排了下序。排完序以后，一个字段对应的那个行在哪？也就是我们找到索引后，怎么找到对应的整行数据？索引里面有原数据，只有一部分，只有你所抽取的字段，如果你找的正好是那个字段，那就不用去查原来的表了。比如SELECT Age FROM students WHERE Age &amp;gt; 30，那就意味着索引要建立在Age上才行，假如我们在Age上创建了索引，意味着索引文件中已经都有了Age字段的所有数据，正好我们找的就是Age，但是如果我们找的不是Age这个字段，而是Name，那么就需要先找到符合索引条件(Age &amp;gt; 30)的条目，这个条目有指向其在原数据中的行的位置，接着就找到行所在的磁盘块，把这个磁盘块载入内存，对应表中的那个行的所有字段就找到了，从而Name也就找到了。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/83.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;图中，索引和数据是分开存放的，也就意味着我们找到索引以后，还得做第二次I/O，找到那个真正数据所在磁盘上的位置，然后把数据读进来。&lt;br&gt;        那什么是聚簇索引呢？索引条目和行是挨着存放的，所以你只要能找到索引，就直接能找到这个行了。一个表能有几个聚簇索引呢？索引是排序的，我们按年龄排序和按姓名排序，其结果不一样。由于索引和数据是存放在一起的，那就意味着索引怎么排序，数据就一定是怎么排序的。如果索引按年龄排序存放了，数据也就按年龄排序存放了，很显然不能在拿姓名来排序存放了。所以对于一张表来讲，聚簇索引只能有一个。非聚簇索引可以有多个，因为排序只是索引本身，不是数据。而对于InnoDB表来讲，非聚簇索引的数据指针并不是指向数据的，而是指向聚簇索引。因此查找InnoDB表分两步，先找辅助索引，然后根据辅助索引找到聚簇索引，然后在找到数据。所以选择一个好的聚簇索引能够非常好的提升InnoDB的查询性能的。&lt;br&gt;        因此对于InnoDB表来说必须有一个聚簇索引，而聚簇索引通常用主键来实现，因为主键中的数据是不允许重复的，所以索引中出现重复的可能性就没有了。因此我们通常提供一个主键用于聚簇索引。&lt;br&gt;        当然，无论是聚簇索引还是辅助索引都是B树索引，因为聚簇和辅助只是指明了它的存储位置是否和原数据存储在一块的，但B树指的是索引自己的内部结构，数据结构。你可以把房子盖到市中心，也可以盖到郊区，但房子本身可以是别墅或一室两厅。一个按位置来讲，一个是按数据结构来讲。B树是一种数据结构。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/84.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;MyISAM-1&quot;&gt;&lt;a href=&quot;#MyISAM-1&quot; class=&quot;headerlink&quot; title=&quot;MyISAM&quot;&gt;&lt;/a&gt;MyISAM&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;支持全文索引：InnoDB不支持。但是InnoDB不支持，好在可以借助额外的其他工具来完成对InnoDB表的全文索引。因此这对于InnoDB来说不是一个缺陷。比如编译Mroonga存储引擎，这是一个很独特的存储引擎。&lt;/li&gt;
&lt;li&gt;支持表压缩：用于实现数据仓库，能节约存储空间并提升性能。只不过压缩以后就不能修改了，只能查询。所以在压缩的时候主要是用来做数据仓库的。&lt;/li&gt;
&lt;li&gt;支持空间索引：InnoDB也支持空间索引。要想使用空间索引，得使用空间函数，才能完成里面的很多数据的操作。&lt;/li&gt;
&lt;li&gt;支持表级锁：不支持行级锁，所以锁开销比较小。如果读写比例是9:1或8:2，对MyISAM是非常理想的。如果读写差不多比例，那么使用MyISAM其性能就下降太厉害了。所以读写差不多的话，建议使用InnoDB表。&lt;/li&gt;
&lt;li&gt;&lt;p&gt;支持延迟更新索引：很多时候索引是为了提升读操作的，那么对写操作会有延迟。好在MyISAM支持延迟更新索引键。创建表有个选项delay_key_write，延迟键更新。这样每当数据更新时，不必要立即更新索引，使得其I/O压力就降低了。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;不支持事务、外键和行级锁&lt;br&gt;崩溃后无法安全恢复数据(你可能得使用repairtable这样的命令去修复表，而这个修复过程通常是不可控的。不像InnoDB，如果崩溃了，InnoDB存储引擎会自行根据事务日志进行恢复)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;适用场景：只读数据、较小的表、能够容忍崩溃后的修改操作时长和数据丢失。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;事实上，mysql库中的表都是MyISAM的，因为mysql这个库是数据字典，而数据字典大多数情况下都是一次创建，但是我们对表的读取却是多次的，所以是一种多读少写的场景，而且表也不会特别大。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW TABLE STATUS IN mysql\G
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;ARCHIVE&quot;&gt;&lt;a href=&quot;#ARCHIVE&quot; class=&quot;headerlink&quot; title=&quot;ARCHIVE&quot;&gt;&lt;/a&gt;ARCHIVE&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;仅支持INSERT和SELECT，支持很好压缩功能；&lt;/li&gt;
&lt;li&gt;&lt;p&gt;适用于存储日志信息，或其它按时间序列实现的数据采集类的应用；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;不支持事务，不能很好的支持索引；&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;CSV&quot;&gt;&lt;a href=&quot;#CSV&quot; class=&quot;headerlink&quot; title=&quot;CSV&quot;&gt;&lt;/a&gt;CSV&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;将数据存储为CSV格式；不支持索引；仅适用于数据交换场景；&lt;br&gt;你可以将excel中表中数据存储为csv格式的，然后在把它导入到mysql中&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;BLACKHOLE&quot;&gt;&lt;a href=&quot;#BLACKHOLE&quot; class=&quot;headerlink&quot; title=&quot;BLACKHOLE&quot;&gt;&lt;/a&gt;BLACKHOLE&lt;/h3&gt;&lt;p&gt;没有存储机制，任何发往此引擎的数据都会丢弃；其会记录二进制日志，因此，常用于多级复制架构中作中转服务器；&lt;/p&gt;
&lt;h3 id=&quot;MEMORY&quot;&gt;&lt;a href=&quot;#MEMORY&quot; class=&quot;headerlink&quot; title=&quot;MEMORY&quot;&gt;&lt;/a&gt;MEMORY&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;保存数据在内存中，内存表；常用于保存中间数据，如周期性的聚合数据等；也用于实现临时表&lt;/li&gt;
&lt;li&gt;仅支持hash索引，使用表级锁，不支持BLOB和TEXT数据类型；&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;MRG-MYISAM&quot;&gt;&lt;a href=&quot;#MRG-MYISAM&quot; class=&quot;headerlink&quot; title=&quot;MRG_MYISAM&quot;&gt;&lt;/a&gt;MRG_MYISAM&lt;/h3&gt;&lt;p&gt;是MYISAM的一个变种，能够将多个MyISAM表合并成一个虚表；&lt;br&gt;但是现在很多应用场景中存的数据量非常大，而一张表中存的数据过多，查询的时候性能会很差。所以很多时候需要借助一些机制将一个表切割成多张表，更别说合并表了。所以这个引擎很少用。&lt;/p&gt;
&lt;h3 id=&quot;NDB&quot;&gt;&lt;a href=&quot;#NDB&quot; class=&quot;headerlink&quot; title=&quot;NDB&quot;&gt;&lt;/a&gt;NDB&lt;/h3&gt;&lt;p&gt;是MySQL CLUSTER中专用的存储引擎。是位于内存中完成数据存储和交换的，能够实现分布式、不做任何共享的、容灾的、高可用的mysql集群，但实际上这种集群没人用。&lt;br&gt;其实早期NDB是爱立信的一个数据库，而后2003年mysql AB公司从爱立信收购了NDB，随后把NDB转换为了存储引擎。&lt;/p&gt;
&lt;h2 id=&quot;第三方的存储引擎&quot;&gt;&lt;a href=&quot;#第三方的存储引擎&quot; class=&quot;headerlink&quot; title=&quot;第三方的存储引擎&quot;&gt;&lt;/a&gt;第三方的存储引擎&lt;/h2&gt;&lt;h3 id=&quot;OLTP类：在线事务处理&quot;&gt;&lt;a href=&quot;#OLTP类：在线事务处理&quot; class=&quot;headerlink&quot; title=&quot;OLTP类：在线事务处理&quot;&gt;&lt;/a&gt;OLTP类：在线事务处理&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;XtraDB: 增强版的InnoDB，由Percona提供。&lt;br&gt;编译安装时，下载XtraDB的源码替换MySQL存储引擎中的InnoDB的源码。然后重命名XtraDB为InnoDB，接着编译安装mysql，就可以取代InnoDB，只不过仍然叫做InnoDB。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;PBXT: MariaDB自带此存储引擎。&lt;br&gt;支持引擎级别的复制、外键约束，对SSD磁盘提供适当支持；&lt;br&gt;支持事务、MVCC。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;TokuDB: 使用Fractal Trees(分形树)索引(这个索引很新，性能很好)，适用存储大数据，拥有很高的压缩比；已经被引入MariaDB。事实上，在mysql被oracle收购后，Apple就立即抛弃了mysql，转向了pgSQL。Apple的领导人很有远见的，迟早有一天要抛弃，还不如早点抛弃。现在Google、Facebook都在纷纷抛弃mysql，转向MariaDB。而Redhat7不在提供mysql，而默认提供MariaDB。可以预见，CentOS、Fedora以后都会转向MariaDB。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;列式存储引擎-NoSQL用的多&quot;&gt;&lt;a href=&quot;#列式存储引擎-NoSQL用的多&quot; class=&quot;headerlink&quot; title=&quot;列式存储引擎(NoSQL用的多)&quot;&gt;&lt;/a&gt;列式存储引擎(NoSQL用的多)&lt;/h3&gt;&lt;p&gt;Mysql数据是这么存的，所有数据在存储时首先划分成逻辑块的，在每一个逻辑块中存的是数据行，一行一行存，不够存的话，再找一个数据块存。而列式存储是按列存的，先存一个字段。这对于按列查询会很有效，比如找所有用户，找到Name那个字段就可以了。web应用常用的反而是列式查询。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Infobright: 目前较有名的列式存储引擎，适用于海量数据存储场景，如PB级别，专为数据分析和数据仓库设计，有商业版和社区版。但是要想使用Infobright存储引擎，需要对mysql做定制。&lt;/li&gt;
&lt;li&gt;InfiniDB&lt;/li&gt;
&lt;li&gt;MonetDB&lt;/li&gt;
&lt;li&gt;LucidDB&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;开源社区提供的存储引擎&quot;&gt;&lt;a href=&quot;#开源社区提供的存储引擎&quot; class=&quot;headerlink&quot; title=&quot;开源社区提供的存储引擎&quot;&gt;&lt;/a&gt;开源社区提供的存储引擎&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Aria：前身为Maria，可理解为增强版的MyISAM(支持崩溃后安全恢复，支持数据缓存。MyISAM只支持索引缓存，不支持数据缓存)&lt;/li&gt;
&lt;li&gt;Groona：全文索引引擎，Mroonga是基于Groona的二次开发版。&lt;/li&gt;
&lt;li&gt;OQGraph: 由Open Query研发，支持图结构的存储引擎。&lt;br&gt;图是最难处理的数据结构。常用的数据结构有4种：顺序结构(线性结构)、链式结构、树型结构和图。&lt;/li&gt;
&lt;li&gt;SphinxSE: 为Sphinx全文搜索服务器提供了SQL接口。这个已经被整合进了MariaDB了。&lt;/li&gt;
&lt;li&gt;Spider: 能将表中的物理数据切分成不同分片，比较高效透明地实现了分片(shared)，还可以存于不同的服务器上，并支持在分片上支持并行查询。就像很多NoSQL的分片。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;索引类型&quot;&gt;&lt;a href=&quot;#索引类型&quot; class=&quot;headerlink&quot; title=&quot;索引类型&quot;&gt;&lt;/a&gt;索引类型&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;聚簇索引&lt;/li&gt;
&lt;li&gt;&lt;p&gt;辅助索引&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;B树(B+树)索引&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;R树索引：空间索引&lt;/li&gt;
&lt;li&gt;hash索引&lt;/li&gt;
&lt;li&gt;全文索引：全文搜索，比如在某帖子里搜索内容。&lt;/li&gt;
&lt;li&gt;位图索引：oracle支持，mysql不支持。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;如何选择？&quot;&gt;&lt;a href=&quot;#如何选择？&quot; class=&quot;headerlink&quot; title=&quot;如何选择？&quot;&gt;&lt;/a&gt;如何选择？&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;是否需要事务&lt;/li&gt;
&lt;li&gt;备份的类型的支持&lt;/li&gt;
&lt;li&gt;崩溃后的恢复&lt;/li&gt;
&lt;li&gt;特有的特性&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;一般我们建议默认采用InnoDB，除非你是建立数据仓库时，我们建议使用MyISAM。MySQL5.5.8之前默认的存储引擎是MyISAM，而后其他版本默认是是InnoDB。&lt;br&gt;如果多个存储引擎满足你的需求，做测试，做性能剖析。&lt;/p&gt;
&lt;p&gt;优化没有任何放之四海而皆准的办法，你需要建立对对方良好的精确理解的基础上，并根据自己的需求去做选择。所以不要从网上搜一些文章朝自己的服务器咣当设置，就以为对服务器做优化了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;MySQL存储引擎&quot;&gt;&lt;a href=&quot;#MySQL存储引擎&quot; class=&quot;headerlink&quot; title=&quot;MySQL存储引擎&quot;&gt;&lt;/a&gt;MySQL存储引擎&lt;/h2&gt;&lt;p&gt;存储引擎也通常称作“表类型”。可以在创建表时指定其存储引擎。
    
    </summary>
    
      <category term="MySQL" scheme="http://yoursite.com/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="http://yoursite.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL事务及隔离级别</title>
    <link href="http://yoursite.com/2018/04/05/MySQL%E4%BA%8B%E5%8A%A1%E5%8F%8A%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/"/>
    <id>http://yoursite.com/2018/04/05/MySQL事务及隔离级别/</id>
    <published>2018-04-05T01:17:31.000Z</published>
    <updated>2018-04-08T08:35:32.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;MySQL逻辑架构&quot;&gt;&lt;a href=&quot;#MySQL逻辑架构&quot; class=&quot;headerlink&quot; title=&quot;MySQL逻辑架构&quot;&gt;&lt;/a&gt;MySQL逻辑架构&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/63.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;我们可以把mysql的架构分为3层：&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1.第一层：连接池或称为线程处理工具。处理用户的连接建立。&lt;/strong&gt;&lt;br&gt;        mysql现在对于线程管理是通过线程池来实现的。一个池子中所能够容纳的水量是有限的，所以一个线程池中所能够容纳的线程数也是有限的。所以mysql启动时事先创建好一个线程池，在这个池子内假如创建了100个空闲线程，来一个用户连接，给它一个线程，当用户连接达到100个，新连接就要排队等待，后面维持一个队列。当某个连接上的用户请求退出后，其对应的线程不会销毁，只会清理数据，还原成原来的样子，再去处理新的用户请求。&lt;br&gt;        所以用户的连接线程在线程池的管理模式中是不会被销毁的，一般是能够实现重用的。所以就避免了频繁的线程创建和删除。&lt;br&gt;        mysql客户端和服务器端通信要通过mysql协议进行通信，协议一般来讲有两种格式。http协议是文本的，我们可以通过telnet连进去手动发送命令的，https协议是二进制的。mysql协议这两种格式都支持。哪种协议会比较高效？二进制的会略微高效一点，所以很多支持两种协议的默认都使用二进制格式。无论是二进制还是文本，都是明文的，只不过你编码成了二进制格式而已，我们只需要一个解码工具，就能把二进制转换为原来的样子了。&lt;br&gt;        为了安全，加密。mysql支持将它的协议基于ssl进行发送的。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.第二层：mysql核心服务层。是MySQL的核心功能层。&lt;/strong&gt;包括查询解析、分析、优化、缓存以及mysql的所有内置函数(BIF)等。&lt;br&gt;        Parser：解析器，也叫分析器。主要功能是分析查询语句的。首先要做词法分析，要把整个sql语句切割成一个一个的片段，还要做语法分析，看看整个sql语句中有没有语法错误，甚至于还要做语义分析。这些都是由分析器完成。当然，mysql并没有自己开发分析器，有很多著名的开源分析器，yacc和lex，一个做词法分析，一个做语法分析的。mysql借用了这分析器做了二次开发并整合进mysql使用了。&lt;br&gt;        Optimizer：优化器。包括重写查询、决定表的读取顺序(多表查询时调整表的读取顺序)、多表查询时选择一个开销最小的索引。但是我们在查询时，如果你作为用户知道哪个索引更好用，你也可以向mysql发送语句时给它提示以影响mysql决策的。对于mysql来讲，优化器并不关心底层那个表真正使用的存储引擎是什么，但是存储引擎根据其特性的不同所提供的性能表现也不同。但是优化器又不考虑存储引擎，但好在优化器会通过向存储引擎的API发起调用请求让存储引擎返回这种存储引擎下所对应的表的统计数据来判断这个表的查询开销有多大，并基于此做出优化决策。一直在说查询，INSERT和UPDATE都要查询的，我们这里讲的查询是广义上的查询，不仅仅是SELECT。不过，如果你真正执行的是SELECT，mysql还有个内部的工具对这种查询可以发挥效用以提升性能的，就是图中的Query Cache。&lt;br&gt;        Query Cache只对SELECT语句有效。只有SELECT才会被缓存下来。所以如果我们执行的是SELECT语句，服务器每次在解析查询操作之前会去查看缓存中是否命中。所以这对SELECT操作是额外的开销，但是如果命中率足够可靠的话，Query Cache还是很有必要的。怎么查看查询缓存的命中率多高？后面讲到mysql优化时，会讲怎么根据缓存的统计数据来分析命中率的。在命中率的基础上决定到底是否开启缓存。你可以把缓存工作在某种特定模式下，默认mysql都不缓存。只有我们手动明确要缓存语句才缓存。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.第三层：存储引擎。&lt;/strong&gt;存储引擎的主要工作是真正负责数据的存储和提取的。&lt;/p&gt;
&lt;h2 id=&quot;MySQL锁&quot;&gt;&lt;a href=&quot;#MySQL锁&quot; class=&quot;headerlink&quot; title=&quot;MySQL锁&quot;&gt;&lt;/a&gt;MySQL锁&lt;/h2&gt;&lt;p&gt;MySQL允许多用户同时连接进来，如果多个用户在访问同一张表的时候，会发生什么问题？比如A用户连接进来修改表A，第二个用户B这时想查询表A中数据能否进行查询？不能查询，怎么达到这个目的呢？你得让B用户的查询操作知道表A正在被某一用户施加写操作。这需要MySQL内在的某些机制完成并发访问控制，而并发访问控制通常基于锁来实现。对于读操作来说，多个用户同时读是没问题的，但是对于写操作是不行的。&lt;/p&gt;
&lt;h3 id=&quot;MySQL锁-1&quot;&gt;&lt;a href=&quot;#MySQL锁-1&quot; class=&quot;headerlink&quot; title=&quot;MySQL锁&quot;&gt;&lt;/a&gt;MySQL锁&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;1.按执行操作时施加的锁模式来分类：两种类型。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;读锁：又称为共享锁，可以同时读，但是不可以写。读为什么要加锁，因为防止其他人去修改我们正在查询的数据的。&lt;/li&gt;
&lt;li&gt;写锁：独占锁，排它锁。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;2.按锁粒度划分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;表锁：table lock。锁定了整张表。开销最小。&lt;/li&gt;
&lt;li&gt;行锁：row lock。锁定了需要的行。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;粒度越小，开销越大，但并发性越好；&lt;br&gt;粒度越大，开销越小，但并发性越差；&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;3.按锁的实现位置划分：&lt;ul&gt;
&lt;li&gt;MySQL锁：可以使用显式锁。很多时候我们提到MySQL，是指第二层核心服务层。&lt;/li&gt;
&lt;li&gt;存储引擎锁：自动进行的（隐式锁）。大多数查询操作都会自动由存储引擎施加锁的。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;如何实现显式锁-在服务器级别显式锁只能是表级锁&quot;&gt;&lt;a href=&quot;#如何实现显式锁-在服务器级别显式锁只能是表级锁&quot; class=&quot;headerlink&quot; title=&quot;如何实现显式锁(在服务器级别显式锁只能是表级锁)&quot;&gt;&lt;/a&gt;如何实现显式锁(在服务器级别显式锁只能是表级锁)&lt;/h3&gt;&lt;pre&gt;&lt;code&gt;LOCK TABLES
UNLOCK TABLES  #只能一次释放所有表的锁，不能指定表和锁类型。见下面的截图语法。

LOCK TABLES
    tbl_name lock_type
    [, tbl_name lock_type] ...
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;锁类型：READ|WRITE&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例1】:演示读锁。&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; use hellodb
Database changed
mysql&amp;gt; LOCK TABLES classes READ;
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;启动另一个终端，连接进来：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/64.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;在第一个终端上，释放锁：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; UNLOCK TABLES;
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;然后到第二个窗口，会发现数据已经插入成功了。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;InnoDB存储引擎也支持另外一种显式锁(锁定挑选出的部分行，行级锁 )：&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;SELECT ... LOCK IN SHARE MODE;   共享锁
SELECT ... FOR UPDATE;   排它锁
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;【示例2】:演示InnoDB行级锁。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/65.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;【注意】:&lt;/strong&gt;&lt;br&gt;1.只是在语句执行过程中添加了锁，语句执行结束了锁就释放了。因此就没有UNLOCK了。&lt;br&gt;2.除了特性情况下，做备份操作时，不建议手动施加锁，因为存储引擎会自动进行锁操作，而且它的锁操作性能比我们自己施加要好的多。做备份操作时，要手动添加读锁。&lt;/p&gt;
&lt;h2 id=&quot;事务Transaction&quot;&gt;&lt;a href=&quot;#事务Transaction&quot; class=&quot;headerlink&quot; title=&quot;事务Transaction&quot;&gt;&lt;/a&gt;事务Transaction&lt;/h2&gt;&lt;p&gt;基于锁我们实现了一定意义上的并发功能了，但是一般来讲，为了完成更高级别的操作，需要支持事务。&lt;br&gt;事务就是一组原子性的查询语句，也即将多个查询当作一个独立的工作单元。&lt;br&gt;【注意】:MyISAM存储引擎是不支持事务的。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ACID测试：能满足ACID测试就表示其支持事务，或兼容事务。&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A：Atomicity，原子性。&lt;/li&gt;
&lt;li&gt;C：Consistency, 一致性。我们的数据库总是从一个一致性状态转到另一个一致性状态。比如，Tom从自己的账户(7000)转账3000到Jerry账户(5000)上， 这样Tom就只剩4000，Jerry就有了8000。转账前二者总和是12000，转账后还是12000。&lt;/li&gt;
&lt;li&gt;I: Isolation, 隔离性, 一个事务的所有修改操作在提交之前所有的修改对其它事务是不可见的。&lt;ul&gt;
&lt;li&gt;第一步：Tom: 7000-3000。事务没提交之前，有人查询Jerry账户，是不能看到这多3000的。同样查询Tom账户，也不能看到少了3000。因为我们事务还没提交&lt;/li&gt;
&lt;li&gt;第二步：Jerry: 5000+3000&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;D：Durability, 持久性, 一旦事务得到提交，其所做的修改会永久有效。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;事实上，ACID机制需要背后有强大的机制才能实现的，而且一旦让一个存储引擎或关系型数据库支持事务，那么它在复杂程度上面是成几何倍上升的。并且如果事务做的完全隔离，事务就是串行的了。如果做到完全隔离，只有在两个事务压根不会涉及到同一张表的时候才会同时执行，否则只要涉及到同一个数据集，事务都只能以串行方式进行。数据安全性越高，其并发性就越低。所以就有了隔离级别的概念。&lt;/p&gt;
&lt;h3 id=&quot;隔离级别&quot;&gt;&lt;a href=&quot;#隔离级别&quot; class=&quot;headerlink&quot; title=&quot;隔离级别&quot;&gt;&lt;/a&gt;隔离级别&lt;/h3&gt;&lt;p&gt;隔离级别(4个)：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;READ UNCOMMITTED (读未提交)&lt;br&gt;读别人还没提交的数据，这属于没什么隔离性的。数据安全性最差，但并发性最好(但从实际上来看，不会比其他级别好太多。又极其缺乏安全性，所以很少用。)&lt;br&gt;会产生脏读，不可重读，幻读(看到的数据和背后的数据不一样)&lt;/li&gt;
&lt;li&gt;READ COMMITTED (读提交)&lt;br&gt;只有别人提交了，我们才能看到。市面上常见的大多数关系型数据库隔离级别都是读提交，不过mysql不是。mysql是第3个隔离级别，可重读。&lt;br&gt;不可重读，幻读&lt;/li&gt;
&lt;li&gt;REPEATABLE READ (可重读)&lt;br&gt;解决了脏读问题，而且可重读，但是解决不了幻读问题。&lt;/li&gt;
&lt;li&gt;SERIALIZABLE (串行化)&lt;br&gt;强制事务的串行执行避免了幻读。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;跟事务相关的命令：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; HELP CONTENTS;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You asked for help about help category: &amp;quot;Contents&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;For more information, type &amp;apos;help &amp;lt;item&amp;gt;&amp;apos;, where &amp;lt;item&amp;gt; is one of the following&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;categories:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Account Management&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Administration&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Compound Statements&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Data Definition&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Data Manipulation&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Data Types&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Functions&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Functions and Modifiers for Use with GROUP BY&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Geographic Features&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Help Metadata&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Language Structure&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Plugins&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Procedures&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Storage Engines&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Table Maintenance&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Transactions&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   User-Defined Functions&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Utility&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; HELP Transactions;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;You asked for help about help category: &amp;quot;Transactions&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;For more information, type &amp;apos;help &amp;lt;item&amp;gt;&amp;apos;, where &amp;lt;item&amp;gt; is one of the following&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;topics:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   CHANGE MASTER TO&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   DEALLOCATE PREPARE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   EXECUTE STATEMENT&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   ISOLATION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   LOCK&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   PREPARE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   PURGE BINARY LOGS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   RESET MASTER&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   RESET SLAVE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   SAVEPOINT&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   SET GLOBAL SQL_SLAVE_SKIP_COUNTER&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   SET SQL_LOG_BIN&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   START SLAVE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   START TRANSACTION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   STOP SLAVE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   XA&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; HELP COMMIT&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Many help items for your request exist.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;To make a more specific request, please type &amp;apos;help &amp;lt;item&amp;gt;&amp;apos;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;where &amp;lt;item&amp;gt; is one of the following&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;topics:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   START TRANSACTION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   XA&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; HELP ROLLBACK&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Many help items for your request exist.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;To make a more specific request, please type &amp;apos;help &amp;lt;item&amp;gt;&amp;apos;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;where &amp;lt;item&amp;gt; is one of the following&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;topics:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   SAVEPOINT&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   START TRANSACTION&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   XA&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; HELP SAVEPOINT&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Name: &amp;apos;SAVEPOINT&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Description:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Syntax:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;SAVEPOINT identifier&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ROLLBACK [WORK] TO [SAVEPOINT] identifier&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RELEASE SAVEPOINT identifier&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;InnoDB supports the SQL statements SAVEPOINT, ROLLBACK TO SAVEPOINT,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;RELEASE SAVEPOINT and the optional WORK keyword for ROLLBACK.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;URL: http://dev.mysql.com/doc/refman/5.6/en/savepoint.html&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;解释下常用的：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; START TRANSACTION  手动显式启动一个事务。在这个事务中执行的所有语句在你执行下一条语句之前都处于未提交状态，未提交的事务都可以进行回滚。
mysql&amp;gt; COMMIT
mysql&amp;gt; ROLLBACK   回滚。回滚时有个问题，如果我们的事务非常大，假如有60个语句，我们执行到第40个的时候，发现第38个错了，如果能够回滚到第35个会比回滚到开头好多了，这就需要SAVEPOINT。我们可以在事务中设置多个保存点，给保存点设置个名字。

mysql&amp;gt; SAVEPOINT identifier
mysql&amp;gt; ROLLBACK [WORK] TO [SAVEPOINT] identifier
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;示例1：演示事务回滚&quot;&gt;&lt;a href=&quot;#示例1：演示事务回滚&quot; class=&quot;headerlink&quot; title=&quot;示例1：演示事务回滚&quot;&gt;&lt;/a&gt;示例1：演示事务回滚&lt;/h3&gt;&lt;p&gt;【注意】:MySQL数据库默认启动了自动提交的功能，也就意味着哪怕你手动不提交，也会自动提交的。但是当我们显式启动事务时，MySQL就不会自动帮我们提交。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/66.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/67.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;示例2：演示SAVEPOINT&quot;&gt;&lt;a href=&quot;#示例2：演示SAVEPOINT&quot; class=&quot;headerlink&quot; title=&quot;示例2：演示SAVEPOINT&quot;&gt;&lt;/a&gt;示例2：演示SAVEPOINT&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/68.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;如果没有显式启动事务，每个语句都会当作一个独立的事务，其执行完成后会被自动提交。自动提交会带来性能上的很大影响，因为每一个语句都自动提交，都会产生一个I/O。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW GLOBAL VARIABLES LIKE &amp;apos;%commit%&amp;apos;;
+--------------------------------+-------+
| Variable_name                  | Value |
+--------------------------------+-------+
| autocommit                     | ON    |
| binlog_order_commits           | ON    |
| innodb_api_bk_commit_interval  | 5     |
| innodb_commit_concurrency      | 0     |
| innodb_flush_log_at_trx_commit | 1     |
+--------------------------------+-------+
5 rows in set (0.00 sec)

mysql&amp;gt; SELECT @@global.autocommit;
+---------------------+
| @@global.autocommit |
+---------------------+
|                   1 |
+---------------------+
1 row in set (0.00 sec)

mysql&amp;gt; SET GLOBAL autocommit = 0;  注意这么改对当前会话没有影响，因为我改的是全局的。
如果关闭自动提交，请记得手动启动事务，手动进行提交；
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;事务隔离级别演示&quot;&gt;&lt;a href=&quot;#事务隔离级别演示&quot; class=&quot;headerlink&quot; title=&quot;事务隔离级别演示&quot;&gt;&lt;/a&gt;事务隔离级别演示&lt;/h3&gt;&lt;p&gt;MySQL默认的事务隔离级别是可重复读。查看MySQL的事务隔离级别：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW GLOBAL VARIABLES LIKE &amp;apos;%iso%&amp;apos;;
+---------------+-----------------+
| Variable_name | Value           |
+---------------+-----------------+
| tx_isolation  | REPEATABLE-READ |
+---------------+-----------------+
1 row in set (0.00 sec)

mysql&amp;gt; SHOW GLOBAL VARIABLES LIKE &amp;apos;tx_isolation&amp;apos;;
+---------------+-----------------+
| Variable_name | Value           |
+---------------+-----------------+
| tx_isolation  | REPEATABLE-READ |
+---------------+-----------------+
1 row in set (0.00 sec)

mysql&amp;gt; SELECT @@global.tx_isolation;  
+-----------------------+
| @@global.tx_isolation |
+-----------------------+
| REPEATABLE-READ       |
+-----------------------+
1 row in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&quot;示例3-演示”读未提交”&quot;&gt;&lt;a href=&quot;#示例3-演示”读未提交”&quot; class=&quot;headerlink&quot; title=&quot;示例3:演示”读未提交”&quot;&gt;&lt;/a&gt;示例3:演示”读未提交”&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SET GLOBAL tx_isolation=&amp;apos;READ-UNCOMMITTED&amp;apos;;
Query OK, 0 rows affected (0.00 sec)

mysql&amp;gt; SHOW GLOBAL VARIABLES LIKE &amp;apos;%iso%&amp;apos;;
+---------------+------------------+
| Variable_name | Value            |
+---------------+------------------+
| tx_isolation  | READ-UNCOMMITTED |
+---------------+------------------+
1 row in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;重新打开两个shell，连接进mysql：注意进去后两个shell要各自先启动事务。然后在到第一个会话执行操作。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/69.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;在打开一个shell，连接进mysql：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/70.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;下面第一个会话回滚事务：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; ROLLBACK;
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;到第2个会话中，再次查询：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/71.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;第2个会话回滚事务。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; ROLLBACK;
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&quot;示例4-演示”读提交”&quot;&gt;&lt;a href=&quot;#示例4-演示”读提交”&quot; class=&quot;headerlink&quot; title=&quot;示例4:演示”读提交”&quot;&gt;&lt;/a&gt;示例4:演示”读提交”&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SET GLOBAL tx_isolation=&amp;apos;READ-COMMITTED&amp;apos;;
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;重新打开两个shell，连接进mysql：注意进去后两个shell要各自先启动事务。然后在到第一个会话执行操作。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/72.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/73.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;此时如果第一个会话中的事务回滚了，那么第二个会话看到的还是第3个数据是有的，这是很正确的；&lt;br&gt;但是如果第一个会话中的事务提交了，&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/74.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/75.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;同一个事务中多次读取的结果不一样，这就是不可重复读。所以脏读了就一定不可重复读，因为你每一次都能读到别人直接修改的数据。所以”读提交”在同一个事务中多次读取仍然可能是不一样的。&lt;/strong&gt;&lt;/p&gt;
&lt;h4 id=&quot;示例3-演示”可重读”&quot;&gt;&lt;a href=&quot;#示例3-演示”可重读”&quot; class=&quot;headerlink&quot; title=&quot;示例3:演示”可重读”&quot;&gt;&lt;/a&gt;示例3:演示”可重读”&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SET GLOBAL tx_isolation=&amp;apos;REPEATABLE-READ&amp;apos;;
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;重新打开两个shell，连接进mysql：注意进去后两个shell要各自先启动事务。然后在到第一个会话执行操作。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/76.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/77.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;但是如果第一个会话中的事务提交了，&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/78.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/79.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;虽然”可重读”解决了不可重读的问题，但是仍然没有解决幻读的问题。&lt;/p&gt;
&lt;h4 id=&quot;示例4-演示”串行化”&quot;&gt;&lt;a href=&quot;#示例4-演示”串行化”&quot; class=&quot;headerlink&quot; title=&quot;示例4:演示”串行化”&quot;&gt;&lt;/a&gt;示例4:演示”串行化”&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SET GLOBAL tx_isolation=&amp;apos;serializable&amp;apos;;
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;重新打开两个shell，连接进mysql：注意进去后两个shell要各自先启动事务。然后在到第一个会话执行操作。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/80.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/81.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;只能等对方提交或者回滚，你才能查看结果。串行化解决了幻读的问题，但是性能太差了。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【建议】：对事务要求不特别严格的场景下，可以使用读提交。要想让配置永久生效，要改配置文件。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;事实上mysql是怎么实现的？为什么别人提交了，对可重读来讲，还不能看到数据。这就是MVCC机制。&lt;br&gt;&lt;strong&gt;MVCC：多版本并发控制&lt;/strong&gt;&lt;br&gt;对于可重读等机制来讲，每个事务启动时，InnoDB为会每个启动的事务提供一个当下时刻的快照，后续的所有操作都是在快照的基础上执行的。因此不管事务执行多长时间，在同一个事务中看到的数据是一致的。&lt;br&gt;为了实现此功能，InnoDB会为每个表提供两隐藏的字段，一个用于保存行的创建时间，一个用于保存行的失效时间(就是哪个事务删除过)。&lt;br&gt;实际上里面存的不是时间，里面存储的是系统版本号；（system version number）。每启动一个事务，InnoDB存储引擎就会给这个事务创建一个当下时刻的快照，并且为对应所读取的数据的快照启动一个新版本号，+1。&lt;/p&gt;
&lt;p&gt;MVCC只在两个隔离级别下有效：READ COMMITTED和REPEATABLE READ。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;MySQL逻辑架构&quot;&gt;&lt;a href=&quot;#MySQL逻辑架构&quot; class=&quot;headerlink&quot; title=&quot;MySQL逻辑架构&quot;&gt;&lt;/a&gt;MySQL逻辑架构&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/63.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;我们可以把mysql的架构分为3层：
    
    </summary>
    
      <category term="MySQL" scheme="http://yoursite.com/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="http://yoursite.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL DML</title>
    <link href="http://yoursite.com/2018/04/02/MySQL-DML/"/>
    <id>http://yoursite.com/2018/04/02/MySQL-DML/</id>
    <published>2018-04-02T10:25:25.000Z</published>
    <updated>2018-04-03T07:23:05.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;DML&quot;&gt;&lt;a href=&quot;#DML&quot; class=&quot;headerlink&quot; title=&quot;DML&quot;&gt;&lt;/a&gt;DML&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;DDL&lt;ul&gt;
&lt;li&gt;DATABASE&lt;/li&gt;
&lt;li&gt;TABLE&lt;/li&gt;
&lt;li&gt;VIEW&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;DML&lt;ul&gt;
&lt;li&gt;SELECT&lt;/li&gt;
&lt;li&gt;INSERT/REPLACE&lt;/li&gt;
&lt;li&gt;UPDATE&lt;/li&gt;
&lt;li&gt;DELETE&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;INSERT-REPLACE&quot;&gt;&lt;a href=&quot;#INSERT-REPLACE&quot; class=&quot;headerlink&quot; title=&quot;INSERT/REPLACE&quot;&gt;&lt;/a&gt;INSERT/REPLACE&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/62.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;INSERT INTO:(INTO可以省略)&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;第一种：&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;INSERT INTO tb_name [(col1, col2,...)] {VALUES|VALUE} (val1, val2,...)[,(val21,val22,...),...]      
    ——VALUE插入单行数据，VALUES插入多行数据。二者取其一，必选的。
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;第二种：&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;INSERT INTO tb_name SET col1=val1, col2=val2, ...
    ——大多数情况下用于插入一行数据。有点类似于UPDATE。
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;第三种：&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;INSERT INTO tb_name SELECT clause
    ——查询的结果要和插入的表的字段类型、字段个数保持一致。
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;REPLACE的工作机制：&lt;/strong&gt;与INSERT相同，除了在新插入的数据与表中的主键数据相同或与惟一索引定义的数据相同会替换老的行。&lt;br&gt;也是和INSERT一样3种使用方式。&lt;/p&gt;
&lt;h3 id=&quot;UPDATE&quot;&gt;&lt;a href=&quot;#UPDATE&quot; class=&quot;headerlink&quot; title=&quot;UPDATE&quot;&gt;&lt;/a&gt;UPDATE&lt;/h3&gt;&lt;pre&gt;&lt;code&gt;UPDATE [LOW_PRIORITY] [IGNORE] table_reference
    SET col_name1=val1 [, col_name2=val2] ...
    [WHERE where_condition]
    [ORDER BY ...]
    [LIMIT row_count]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;UPDATE通常情况下，必须要使用WHERE子句，或者使用LIMIT限制要修改的行数；否则就每行都修改了，不安全。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;--safe-updates     
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;启动mysqld还有这个选项，可用于限定如果你的DELETE语句忘记了带WHERE子句或LIMIT子句时是拒绝执行的。这个选项还包括对DELETE语句的限制。建议启动时使用–safe-updates。&lt;/p&gt;
&lt;h3 id=&quot;DELETE&quot;&gt;&lt;a href=&quot;#DELETE&quot; class=&quot;headerlink&quot; title=&quot;DELETE&quot;&gt;&lt;/a&gt;DELETE&lt;/h3&gt;&lt;pre&gt;&lt;code&gt;DELETE [LOW_PRIORITY] [QUICK] [IGNORE] FROM tbl_name
    [WHERE where_condition]
    [ORDER BY ...]
    [LIMIT row_count]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;如果对删除哪些行不做限定的话，非常危险。是删除行，不是删字段。不指定条件，就是清空表数据。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;TRUNCATE tb_name
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;如果我们的目的是清空整张表的话，delete有个问题：如果这个表中有自动增长的字段，它那个自动增长的数值不会重置为1。我们需要使用TRUNCATE，不要使用delete。所以如果我们是想清空某张表的话，请使用TRUNCATE。&lt;br&gt;事实上我们还建议，复制表结构，然后把原来的表删除掉，即DROP。创建表结构，在插入原表数据。&lt;/p&gt;
&lt;p&gt;以上的SELECT、INSERT、UPDATE和DELETE在NoSQL中被称为crud。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;DML&quot;&gt;&lt;a href=&quot;#DML&quot; class=&quot;headerlink&quot; title=&quot;DML&quot;&gt;&lt;/a&gt;DML&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;DDL&lt;ul&gt;
&lt;li&gt;DATABASE&lt;/li&gt;
&lt;li&gt;TABLE&lt;/li&gt;
&lt;li&gt;VIEW
    
    </summary>
    
      <category term="MySQL" scheme="http://yoursite.com/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="http://yoursite.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL查询和视图</title>
    <link href="http://yoursite.com/2018/03/29/MySQL%E6%9F%A5%E8%AF%A2%E5%92%8C%E8%A7%86%E5%9B%BE/"/>
    <id>http://yoursite.com/2018/03/29/MySQL查询和视图/</id>
    <published>2018-03-29T01:20:40.000Z</published>
    <updated>2018-04-03T06:23:16.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;查询的执行路径&quot;&gt;&lt;a href=&quot;#查询的执行路径&quot; class=&quot;headerlink&quot; title=&quot;查询的执行路径&quot;&gt;&lt;/a&gt;查询的执行路径&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;查询执行路径：&lt;/strong&gt;先查缓存，缓存未命中交给解析器。MySQL是允许多个用户连接进来的，因此有多个线程，如果每个线程上的用户都发起查询请求，而mysql真正能够执行查询的查询引擎只有一个，所以要排队，要给一个队列。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;所以就需要有查询执行计划和查询执行引擎。但是查询执行引擎不能直接去硬盘取数据，所以查询引擎是接收查询执行计划传递而来的优化器优化后的查询语句，它负责转换为对应表的存储引擎的API调用。后面的数据获取是由对应的存储引擎负责到磁盘上取数据，并将数据返回给执行引擎，最后在层层返回给客户端，返回客户端之前有可能要判断要不要缓存下来。比如查当前系统时间，这个就没必要缓存下来了。查询的结果缓存与否，用户是可以定义的。当然不是说用户想缓存就一定能缓存。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/25.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;MySQL的查询操作&quot;&gt;&lt;a href=&quot;#MySQL的查询操作&quot; class=&quot;headerlink&quot; title=&quot;MySQL的查询操作&quot;&gt;&lt;/a&gt;MySQL的查询操作&lt;/h2&gt;&lt;p&gt;使用SELECT语句查询数据，查询语句的通用语法格式：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;SELECT values_to_dispaly
FROM table_name 
WHERE expression
GROUP BY how_to_group
HAVING expression
ORDER BY how_to_sort
LIMIT row_count;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;查询又可分为：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;单表查询：也称为简单查询&lt;/li&gt;
&lt;li&gt;多表查询：也称为连接查询&lt;/li&gt;
&lt;li&gt;联合查询&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;选择和投影：就是关系代数，其实SELECT主要就包括这两方面&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;投影：挑选要显示的字段&lt;/li&gt;
&lt;li&gt;选择：挑选符合条件的行&lt;ul&gt;
&lt;li&gt;投影：SELECT 字段1, 字段2, … FROM tb_name; &lt;ul&gt;
&lt;li&gt;SELECT * FROM tb_name;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;选择：SELECT 字段1, … FROM tb_name WHERE 子句; &lt;ul&gt;
&lt;li&gt;WHERE 子句就是布尔条件表达式&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;WHERE子句&quot;&gt;&lt;a href=&quot;#WHERE子句&quot; class=&quot;headerlink&quot; title=&quot;WHERE子句&quot;&gt;&lt;/a&gt;WHERE子句&lt;/h3&gt;&lt;p&gt;HERE 子句就是布尔条件表达式&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;布尔条件表达式操作符： &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;=&lt;/li&gt;
&lt;li&gt;&amp;lt;=&amp;gt; ：空值安全比较。与空比较值的安全方式，跟空值比较不会产生意外情况的等值比较。和上面那个一样都是等值比较。&lt;/li&gt;
&lt;li&gt;&amp;lt;&amp;gt; ：不等于&lt;/li&gt;
&lt;li&gt;&amp;lt;&lt;/li&gt;
&lt;li&gt;&amp;lt;=&lt;/li&gt;
&lt;li&gt;&amp;gt;&lt;/li&gt;
&lt;li&gt;&lt;blockquote&gt;
&lt;p&gt;=&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;IS NULL ：判断一个字段的值是否为空。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;IS NOT NULL&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;LIKE: 支持的通配符: %(任意长度的任意字符)， _（任意单个字符） 。&lt;br&gt;【注意】:能用等值比较或不等值比较，就尽量不要用LIKE。因为它的性能要差得多。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;RLIKE(REGEXP): 支持使用正则表达式 。&lt;br&gt;【注意】:性能比较低。LIKE和RLIKE是用来做字符串比较的，千万不要拿来做数值比较。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;IN: 判断指定字段的值是否在给定在列表中。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;BETWEEN … AND …: 位于指定的范围之间 。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;【示例1】：NULL示例&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; CREATE TABLE `students` (`SID` int(100), `Name` varchar(50) NOT NULL, `Age` TINYINT UNSIGNED NOT NULL, `Gender` ENUM(&amp;apos;M&amp;apos;,&amp;apos;F&amp;apos;) NOT NULL DEFAULT &amp;apos;M&amp;apos;, `Tutor` varchar(50), PRIMARY KEY(`SID`));
Query OK, 0 rows affected (0.04 sec)

mysql&amp;gt; INSERT INTO `students` VALUES (1,&amp;apos;tom&amp;apos;,13,&amp;apos;M&amp;apos;,&amp;apos;Song Jiang&amp;apos;);
Query OK, 1 row affected (0.00 sec)

mysql&amp;gt; INSERT INTO `students` VALUES (2,&amp;apos;jerry&amp;apos;,14,&amp;apos;F&amp;apos;,&amp;apos;Jiabaoyu&amp;apos;); 
Query OK, 1 row affected (0.01 sec)

mysql&amp;gt; INSERT INTO `students` VALUES (3,&amp;apos;jack&amp;apos;,14,&amp;apos;M&amp;apos;,&amp;apos;JinJiao&amp;apos;);
Query OK, 1 row affected (0.01 sec)

mysql&amp;gt; INSERT INTO `students` VALUES (4,&amp;apos;Lucy&amp;apos;,14,&amp;apos;F&amp;apos;,NULL);
Query OK, 1 row affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/26.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例2】：LIKE示例&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/27.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例3】：RLIKE示例&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/28.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例4】：IN示例&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/29.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例5】：BETWEEN … AND示例&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/30.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;组合条件测试： 逻辑操作符组合多个条件。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;NOT, 可以用 ! 表示。&lt;/li&gt;
&lt;li&gt;AND, 可以用&amp;amp;&amp;amp;表示&lt;/li&gt;
&lt;li&gt;OR, 可以用 || 表示&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;聚合函数&quot;&gt;&lt;a href=&quot;#聚合函数&quot; class=&quot;headerlink&quot; title=&quot;聚合函数&quot;&gt;&lt;/a&gt;聚合函数&lt;/h3&gt;&lt;p&gt;聚合函数是mysql内置的。&lt;br&gt;&lt;strong&gt;SUM(), AVG(), MAX(), MIN(), COUNT()&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/31.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/32.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;分组&quot;&gt;&lt;a href=&quot;#分组&quot; class=&quot;headerlink&quot; title=&quot;分组&quot;&gt;&lt;/a&gt;分组&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;GROUP BY&lt;/strong&gt;。在聚合函数使用时，往往伴随着分组的使用，然后对一组进行聚合。分组的目的主要是来用聚合。我们可以在GROUP BY之前使用WHERE子句做条件过滤。具体前面写的通用查询格式。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/33.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;HAVING子句&quot;&gt;&lt;a href=&quot;#HAVING子句&quot; class=&quot;headerlink&quot; title=&quot;HAVING子句&quot;&gt;&lt;/a&gt;HAVING子句&lt;/h3&gt;&lt;p&gt;对GROUP BY、聚合函数查出的结果做条件过滤用HAVING子句。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; ALTER TABLE students ADD column `ClassID` int(10);
Query OK, 0 rows affected (0.05 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&amp;gt; UPDATE students SET ClassID=1 WHERE Name=&amp;apos;Tom&amp;apos;;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql&amp;gt; UPDATE students SET ClassID=1 WHERE Name=&amp;apos;Jerry&amp;apos;;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql&amp;gt; UPDATE students SET ClassID=1 WHERE Name=&amp;apos;Jack&amp;apos;;
Query OK, 1 row affected (0.01 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql&amp;gt; UPDATE students SET ClassID=2 WHERE Name=&amp;apos;Lucy&amp;apos;;
Query OK, 1 row affected (0.01 sec)
Rows matched: 1  Changed: 1  Warnings: 0
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/34.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;排序&quot;&gt;&lt;a href=&quot;#排序&quot; class=&quot;headerlink&quot; title=&quot;排序&quot;&gt;&lt;/a&gt;排序&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;ORDER BY。&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/35.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;LIMIT&quot;&gt;&lt;a href=&quot;#LIMIT&quot; class=&quot;headerlink&quot; title=&quot;LIMIT&quot;&gt;&lt;/a&gt;LIMIT&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;【注意】:有的时候为了简单的判断工作，我们只需要查询结果返回一部分结果，这时候可以使用LIMIT子句。&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/36.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;总结SELECT几种惯常用法&quot;&gt;&lt;a href=&quot;#总结SELECT几种惯常用法&quot; class=&quot;headerlink&quot; title=&quot;总结SELECT几种惯常用法&quot;&gt;&lt;/a&gt;总结SELECT几种惯常用法&lt;/h3&gt;&lt;pre&gt;&lt;code&gt;SELECT ...
FROM ...
ORDER BY ...

SELECT ...
FROM ...
GROUP BY ...
HAVING ...

SELECT ...
FROM ...
WHERE ...

SELECT ...

SELECT ...
FROM ...
WHERE ...
GROUP BY ...
LIMIT ...

SELECT ...
FROM ...
HAVING ...
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;SELECT语句的执行流程&quot;&gt;&lt;a href=&quot;#SELECT语句的执行流程&quot; class=&quot;headerlink&quot; title=&quot;SELECT语句的执行流程&quot;&gt;&lt;/a&gt;SELECT语句的执行流程&lt;/h3&gt;&lt;pre&gt;&lt;code&gt;FROM clause --&amp;gt; WHERE clause --&amp;gt; GROUP BY --&amp;gt; HAVING clause --&amp;gt; ORDER BY ... --&amp;gt; SELECT --&amp;gt; LIMIT
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;【注意】:where子句不能使用聚合函数&lt;/strong&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/37.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;【补充】：SELECT语句:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DISTINCT：指定的结果相同的只显示一次；&lt;/li&gt;
&lt;li&gt;SQL_CACHE：缓存于查询缓存中；&lt;/li&gt;
&lt;li&gt;SQL_NO_CACHE：不缓存查询结果。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/38.png&quot; alt=&quot;&quot;&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;多表查询&quot;&gt;&lt;a href=&quot;#多表查询&quot; class=&quot;headerlink&quot; title=&quot;多表查询&quot;&gt;&lt;/a&gt;多表查询&lt;/h2&gt;&lt;p&gt;联结查询：事先将两张或多张表join，根据join的结果进行查询。&lt;br&gt;为什么会有多表查询？数据库设计要求降低冗余。如果一个数据我们来回存了n次，就建议拆分成两张表，并且在两张表中都有的字段建立关联关系。&lt;/p&gt;
&lt;p&gt;下面先初始化数据，导入一个sql脚本，用于举例子。脚本内容如下：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;CREATE DATABASE /*!32312 IF NOT EXISTS*/ `test` /*!40100 DEFAULT CHARACTER SET utf8 */;

USE `test`;

--
-- Table structure for table `classes`
--

DROP TABLE IF EXISTS `classes`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `classes` (
  `ClassID` tinyint(3) unsigned NOT NULL AUTO_INCREMENT,
  `Class` varchar(100) DEFAULT NULL,
  `NumOfStu` smallint(5) unsigned DEFAULT NULL,
  PRIMARY KEY (`ClassID`)
) ENGINE=MyISAM AUTO_INCREMENT=9 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `classes`
--

LOCK TABLES `classes` WRITE;
/*!40000 ALTER TABLE `classes` DISABLE KEYS */;
INSERT INTO `classes` VALUES (1,&amp;apos;Shaolin Pai&amp;apos;,10),(2,&amp;apos;Emei Pai&amp;apos;,7),(3,&amp;apos;QingCheng Pai&amp;apos;,11),(4,&amp;apos;Wudang Pai&amp;apos;,12),(5,&amp;apos;Riyue Shenjiao&amp;apos;,31),(6,&amp;apos;Lianshan Pai&amp;apos;,27),(7,&amp;apos;Ming Jiao&amp;apos;,27),(8,&amp;apos;Xiaoyao Pai&amp;apos;,15);
/*!40000 ALTER TABLE `classes` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `coc`
--

DROP TABLE IF EXISTS `coc`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `coc` (
  `ID` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `ClassID` tinyint(3) unsigned NOT NULL,
  `CourseID` smallint(5) unsigned DEFAULT NULL,
  PRIMARY KEY (`ID`)
) ENGINE=MyISAM AUTO_INCREMENT=15 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `coc`
--

LOCK TABLES `coc` WRITE;
/*!40000 ALTER TABLE `coc` DISABLE KEYS */;
INSERT INTO `coc` VALUES (1,1,2),(2,1,5),(3,2,2),(4,2,6),(5,3,1),(6,3,7),(7,4,5),(8,4,2),(9,5,1),(10,5,9),(11,6,3),(12,6,4),(13,7,4),(14,7,3);
/*!40000 ALTER TABLE `coc` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `courses`
--

DROP TABLE IF EXISTS `courses`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `courses` (
  `CourseID` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  `Course` varchar(100) NOT NULL,
  PRIMARY KEY (`CourseID`)
) ENGINE=MyISAM AUTO_INCREMENT=8 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `courses`
--

LOCK TABLES `courses` WRITE;
/*!40000 ALTER TABLE `courses` DISABLE KEYS */;
INSERT INTO `courses` VALUES (1,&amp;apos;Hamo Gong&amp;apos;),(2,&amp;apos;Kuihua Baodian&amp;apos;),(3,&amp;apos;Jinshe Jianfa&amp;apos;),(4,&amp;apos;Taiji Quan&amp;apos;),(5,&amp;apos;Daiyu Zanghua&amp;apos;),(6,&amp;apos;Weituo Zhang&amp;apos;),(7,&amp;apos;Dagou Bangfa&amp;apos;);
/*!40000 ALTER TABLE `courses` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `scores`
--

DROP TABLE IF EXISTS `scores`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `scores` (
  `ID` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `StuID` int(10) unsigned NOT NULL,
  `CourseID` smallint(5) unsigned NOT NULL,
  `Score` tinyint(3) unsigned DEFAULT NULL,
  PRIMARY KEY (`ID`)
) ENGINE=MyISAM AUTO_INCREMENT=16 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `scores`
--

LOCK TABLES `scores` WRITE;
/*!40000 ALTER TABLE `scores` DISABLE KEYS */;
INSERT INTO `scores` VALUES (1,1,2,77),(2,1,6,93),(3,2,2,47),(4,2,5,97),(5,3,2,88),(6,3,6,75),(7,4,5,71),(8,4,2,89),(9,5,1,39),(10,5,7,63),(11,6,1,96),(12,7,1,86),(13,7,7,83),(14,8,4,57),(15,8,3,93);
/*!40000 ALTER TABLE `scores` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `students`
--

DROP TABLE IF EXISTS `students`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `students` (
  `StuID` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `Name` varchar(50) NOT NULL,
  `Age` tinyint(3) unsigned NOT NULL,
  `Gender` enum(&amp;apos;F&amp;apos;,&amp;apos;M&amp;apos;) NOT NULL,
  `ClassID` tinyint(3) unsigned DEFAULT NULL,
  `TeacherID` int(10) unsigned DEFAULT NULL,
  PRIMARY KEY (`StuID`)
) ENGINE=MyISAM AUTO_INCREMENT=26 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `students`
--

LOCK TABLES `students` WRITE;
/*!40000 ALTER TABLE `students` DISABLE KEYS */;
INSERT INTO `students` VALUES (1,&amp;apos;Shi Zhongyu&amp;apos;,22,&amp;apos;M&amp;apos;,2,3),(2,&amp;apos;Shi Potian&amp;apos;,22,&amp;apos;M&amp;apos;,1,7),(3,&amp;apos;Xie Yanke&amp;apos;,53,&amp;apos;M&amp;apos;,2,16),(4,&amp;apos;Ding Dian&amp;apos;,32,&amp;apos;M&amp;apos;,4,4),(5,&amp;apos;Yu Yutong&amp;apos;,26,&amp;apos;M&amp;apos;,3,1),(6,&amp;apos;Shi Qing&amp;apos;,46,&amp;apos;M&amp;apos;,5,NULL),(7,&amp;apos;Xi Ren&amp;apos;,19,&amp;apos;F&amp;apos;,3,NULL),(8,&amp;apos;Lin Daiyu&amp;apos;,17,&amp;apos;F&amp;apos;,7,NULL),(9,&amp;apos;Ren Yingying&amp;apos;,20,&amp;apos;F&amp;apos;,6,NULL),(10,&amp;apos;Yue Lingshan&amp;apos;,19,&amp;apos;F&amp;apos;,3,NULL),(11,&amp;apos;Yuan Chengzhi&amp;apos;,23,&amp;apos;M&amp;apos;,6,NULL),(12,&amp;apos;Wen Qingqing&amp;apos;,19,&amp;apos;F&amp;apos;,1,NULL),(13,&amp;apos;Tian Boguang&amp;apos;,33,&amp;apos;M&amp;apos;,2,NULL),(14,&amp;apos;Lu Wushuang&amp;apos;,17,&amp;apos;F&amp;apos;,3,NULL),(15,&amp;apos;Duan Yu&amp;apos;,19,&amp;apos;M&amp;apos;,4,NULL),(16,&amp;apos;Xu Zhu&amp;apos;,21,&amp;apos;M&amp;apos;,1,NULL),(17,&amp;apos;Lin Chong&amp;apos;,25,&amp;apos;M&amp;apos;,4,NULL),(18,&amp;apos;Hua Rong&amp;apos;,23,&amp;apos;M&amp;apos;,7,NULL),(19,&amp;apos;Xue Baochai&amp;apos;,18,&amp;apos;F&amp;apos;,6,NULL),(20,&amp;apos;Diao Chan&amp;apos;,19,&amp;apos;F&amp;apos;,7,NULL),(21,&amp;apos;Huang Yueying&amp;apos;,22,&amp;apos;F&amp;apos;,6,NULL),(22,&amp;apos;Xiao Qiao&amp;apos;,20,&amp;apos;F&amp;apos;,1,NULL),(23,&amp;apos;Ma Chao&amp;apos;,23,&amp;apos;M&amp;apos;,4,NULL),(24,&amp;apos;Xu Xian&amp;apos;,27,&amp;apos;M&amp;apos;,NULL,NULL),(25,&amp;apos;Sun Dasheng&amp;apos;,100,&amp;apos;M&amp;apos;,NULL,NULL);
/*!40000 ALTER TABLE `students` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `teachers`
--

DROP TABLE IF EXISTS `teachers`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `teachers` (
  `TID` smallint(5) unsigned NOT NULL AUTO_INCREMENT,
  `Name` varchar(100) NOT NULL,
  `Age` tinyint(3) unsigned NOT NULL,
  `Gender` enum(&amp;apos;F&amp;apos;,&amp;apos;M&amp;apos;) DEFAULT NULL,
  PRIMARY KEY (`TID`)
) ENGINE=MyISAM AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `teachers`
--

LOCK TABLES `teachers` WRITE;
/*!40000 ALTER TABLE `teachers` DISABLE KEYS */;
INSERT INTO `teachers` VALUES (1,&amp;apos;Song Jiang&amp;apos;,45,&amp;apos;M&amp;apos;),(2,&amp;apos;Zhang Sanfeng&amp;apos;,94,&amp;apos;M&amp;apos;),(3,&amp;apos;Miejue Shitai&amp;apos;,77,&amp;apos;F&amp;apos;),(4,&amp;apos;Lin Chaoying&amp;apos;,93,&amp;apos;F&amp;apos;);
/*!40000 ALTER TABLE `teachers` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `toc`
--

DROP TABLE IF EXISTS `toc`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `toc` (
  `ID` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `CourseID` smallint(5) unsigned DEFAULT NULL,
  `TID` smallint(5) unsigned DEFAULT NULL,
  PRIMARY KEY (`ID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `toc`
--

LOCK TABLES `toc` WRITE;
/*!40000 ALTER TABLE `toc` DISABLE KEYS */;
/*!40000 ALTER TABLE `toc` ENABLE KEYS */;
UNLOCK TABLES;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;join的方式：&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;1.cross join: 交叉联结。多项式相乘。效率极低，很少用。&lt;/strong&gt;&lt;br&gt;(a+b)(c+d+e)=ac+ad+ae+bc+bd+be&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.自然联结：内连接，等值连接。&lt;/strong&gt;&lt;br&gt;等值连接:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SELECT * FROM students, classes WHERE students.ClassID = classes.ClassID;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/39.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.外联结：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;左外联结：只保留出现在左外连接运算之前（左边）的关系中的元组(元组就是记录)；&lt;br&gt;left_tb LEFT JOIN right_tb ON 连接条件(通常是一种等值比较)&lt;/li&gt;
&lt;li&gt;右外联结：只保留出现在右外连接运算之后（右边）的关系中的元组；left_tb RIGHT JOIN right_tb ON 连接条件&lt;/li&gt;
&lt;li&gt;全外联结：左右都出现，保留关系中的每一个元组。对应于右外连接来讲，左侧没有的左侧留空；对应于左外链接来讲，右侧没有的右留空。但是mysql是不支持全外联结。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;【示例】：左外连接&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SELECT s.Name,c.Class FROM students AS s LEFT JOIN classes AS c ON s.ClassID=c.ClassID;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/40.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;【示例】：右外连接&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SELECT s.Name,c.Class FROM students AS s RIGHT JOIN classes AS c ON s.ClassID=c.ClassID;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/41.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;4.自联结：自己连接自己。&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SELECT t.Name,s.Name FROM students AS s,students AS t WHERE s.StuID = t.TeacherID;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/42.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;别名：&lt;/strong&gt;当表名、字段名太长时，或者为了区分，可以起个别名。使用AS&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/43.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/44.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/45.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【示例】：&lt;/strong&gt;&lt;br&gt; 1、显示前5位同学的姓名、课程及成绩；&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SELECT Name,Course FROM students AS s,courses AS c,coc WHERE s.ClassID = coc.ClassID AND coc.CourseID = c.CourseID AND s.StuID &amp;lt; 5;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/46.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SELECT Name,Course,Score FROM students AS s,courses AS c,coc,scores AS ss WHERE s.ClassID = coc.ClassID AND coc.CourseID = c.CourseID AND s.StuID &amp;lt; 5 AND s.StuID=ss.StuID;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/47.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;但是由于scores表的StuID有重复，导致上面的s.StuID=ss.StuID条件挑选出来有重复，所以还要加一个条件。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SELECT Name,Course,Score FROM students AS s,courses AS c,coc,scores AS ss WHERE s.ClassID = coc.ClassID AND coc.CourseID = c.CourseID AND s.StuID &amp;lt; 5 AND s.StuID=ss.StuID AND coc.CourseID=ss.CourseID;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/48.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;2、求前8位同学每位同学自己两门课的平均成绩，并按降序排列；&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SELECT Name,AVG(Score) FROM students AS s,courses AS c,coc,scores AS ss WHERE s.ClassID = coc.ClassID AND coc.CourseID = c.CourseID AND s.StuID&amp;lt;=8 AND s.StuID=ss.StuID AND coc.CourseID=ss.CourseID GROUP BY Name ORDER BY AVG(Score) DESC;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/49.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;子查询&quot;&gt;&lt;a href=&quot;#子查询&quot; class=&quot;headerlink&quot; title=&quot;子查询&quot;&gt;&lt;/a&gt;子查询&lt;/h2&gt;&lt;p&gt;【思考】：如何显示其年龄大于平均年龄的同学的名字？&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/50.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;子查询：在查询中嵌套的查询。&lt;/p&gt;
&lt;h3 id=&quot;用于WHERE中的子查询&quot;&gt;&lt;a href=&quot;#用于WHERE中的子查询&quot; class=&quot;headerlink&quot; title=&quot;用于WHERE中的子查询&quot;&gt;&lt;/a&gt;用于WHERE中的子查询&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;1、用于比较表达式中的子查询&lt;/strong&gt;&lt;br&gt;子查询的返回值只能有一个；&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SELECT Name,Age FROM students WHERE Age &amp;gt; (SELECT AVG(Age) FROM students GROUP BY Gender); 
ERROR 1242 (21000): Subquery returns more than 1 row
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;2、用于EXISTS中的子查询&lt;/strong&gt;&lt;br&gt;判断存在与否&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3、用于IN中的子查询&lt;/strong&gt;&lt;br&gt;判断存在于指定列表中&lt;/p&gt;
&lt;h3 id=&quot;用于FROM中的子查询&quot;&gt;&lt;a href=&quot;#用于FROM中的子查询&quot; class=&quot;headerlink&quot; title=&quot;用于FROM中的子查询&quot;&gt;&lt;/a&gt;用于FROM中的子查询&lt;/h3&gt;&lt;pre&gt;&lt;code&gt;SELECT alias.col,... FROM (SELECT clause) AS alias WHERE condition  
mysql&amp;gt; SELECT s.Name,s.Age,s.Gender FROM (SELECT * FROM students WHERE Gender=&amp;apos;M&amp;apos;) AS s WHERE s.Age &amp;gt; 25;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/51.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【注意】：MySQL不擅长于子查询：应该避免使用子查询。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;【总结】：MySQL的联结查询及子查询&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;联结&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;交叉联结&lt;/li&gt;
&lt;li&gt;内联结&lt;/li&gt;
&lt;li&gt;外联结&lt;ul&gt;
&lt;li&gt;左外&lt;/li&gt;
&lt;li&gt;右外&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;自联结&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;子查询&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;用于WHERE中的子查询&lt;ul&gt;
&lt;li&gt;用于条件比较：子查询只能一个值&lt;/li&gt;
&lt;li&gt;用于IN：子查询可以返回多个值&lt;/li&gt;
&lt;li&gt;EXISTS：子查询可以返回多个值&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;用于FROM子句的子查询&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;MySQL的联合查询&quot;&gt;&lt;a href=&quot;#MySQL的联合查询&quot; class=&quot;headerlink&quot; title=&quot;MySQL的联合查询&quot;&gt;&lt;/a&gt;MySQL的联合查询&lt;/h2&gt;&lt;p&gt;把两个或多个查询语句的结果合并成一个结果进行输出。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;SELECT clauase UNION SELECT clause UNION ...
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;【示例】：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SELECT Name,Age FROM teachers UNION SELECT Name,Age FROM students;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;所谓索引有用，就是查询条件上面有索引，比如下例，你在姓名上创建索引，根据年龄来查找是没用的。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SELECT Name,Age FROM students WHERE Age &amp;gt; 25;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;查询表中是否有索引：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/52.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;查看一个查询语句是否用到索引：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; EXPLAIN SELECT Name,Age FROM students WHERE Age &amp;gt; 25\G
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/53.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;在某个字段上添加一个索引，然后再来查看这个查询是否用到索引：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; ALTER TABLE students ADD INDEX (Age);
mysql&amp;gt; SHOW INDEXES FROM students;
mysql&amp;gt; EXPLAIN SELECT Name,Age FROM students WHERE Age &amp;gt; 25\G
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/54.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;MySQL视图&quot;&gt;&lt;a href=&quot;#MySQL视图&quot; class=&quot;headerlink&quot; title=&quot;MySQL视图&quot;&gt;&lt;/a&gt;MySQL视图&lt;/h2&gt;&lt;p&gt;视图就是一虚表，MySQL对视图的支持很有限，因为MySQL支持子查询很有限。&lt;/p&gt;
&lt;p&gt;【示例】：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; GRANT ALL on hellodb.students TO &amp;apos;testuser&amp;apos;@&amp;apos;172.%.%.%&amp;apos; IDENTIFIED BY &amp;apos;testpass&amp;apos;;
Query OK, 0 rows affected (0.00 sec)
mysql&amp;gt; GRANT ALL on hellodb.students TO &amp;apos;testuser&amp;apos;@&amp;apos;localhost&amp;apos; IDENTIFIED BY &amp;apos;testpass&amp;apos;;          
Query OK, 0 rows affected (0.00 sec)
mysql&amp;gt; FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/55.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;为什么会出现这样的情况？&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;In many default installations, all users have all privileges on tables within any database called test or beginning with test_.
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;所以我这边重新导入上面的数据，并将数据库名字命名为hellodb。然后删除上面的两个用户，并且重新授权。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; use mysql
Database changed
mysql&amp;gt; DELETE FROM user WHERE user=&amp;apos;testuser&amp;apos;;
Query OK, 2 rows affected (0.00 sec)

mysql&amp;gt; FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.00 sec)

mysql&amp;gt; GRANT ALL on hellodb.students TO &amp;apos;testuser&amp;apos;@&amp;apos;172.%.%.%&amp;apos; IDENTIFIED BY &amp;apos;testpass&amp;apos;;
Query OK, 0 rows affected (0.01 sec)

mysql&amp;gt; GRANT ALL on hellodb.students TO &amp;apos;testuser&amp;apos;@&amp;apos;localhost&amp;apos; IDENTIFIED BY &amp;apos;testpass&amp;apos;; 
Query OK, 0 rows affected (0.00 sec)

mysql&amp;gt; FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/56.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/57.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;其实授权的时候可以指定只给看表的某几个字段，但是用户用DESC students还是能看到这两个字段的定义。所以如果我们要想让用户意识到这两个用户不存在怎么办？这就是视图的意义了。创建一个虚表。授权视图给用户。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;视图：存储下来的SELECT语句； 说白了就是把SELECT语句当表来用。&lt;/strong&gt;&lt;br&gt;【注意】:你什么时候用，它什么时候才执行，平时是没有的。因为存下来的是SELECT语句，不是SELECT查询的结果。当然，Oracle支持物化视图，MySQL不支持。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; HELP CREATE VIEW
Name: &amp;apos;CREATE VIEW&amp;apos;
Description:
Syntax:
CREATE
    [OR REPLACE]
    [ALGORITHM = {UNDEFINED | MERGE | TEMPTABLE}]
    [DEFINER = { user | CURRENT_USER }]
    [SQL SECURITY { DEFINER | INVOKER }]
    VIEW view_name [(column_list)]
    AS select_statement
    [WITH [CASCADED | LOCAL] CHECK OPTION]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/58.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/59.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/60.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/61.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;删除视图：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; DROP VIEW stu;
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;查询的执行路径&quot;&gt;&lt;a href=&quot;#查询的执行路径&quot; class=&quot;headerlink&quot; title=&quot;查询的执行路径&quot;&gt;&lt;/a&gt;查询的执行路径&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;查询执行路径：&lt;/strong&gt;先查缓存，缓存未命中交给解析器。MySQL是允许多个用户连接进来的，因此有多个线程，如果每个线程上的用户都发起查询请求，而mysql真正能够执行查询的查询引擎只有一个，所以要排队，要给一个队列。
    
    </summary>
    
      <category term="MySQL" scheme="http://yoursite.com/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="http://yoursite.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL数据库及表管理</title>
    <link href="http://yoursite.com/2018/03/26/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8F%8A%E8%A1%A8%E7%AE%A1%E7%90%86/"/>
    <id>http://yoursite.com/2018/03/26/MySQL数据库及表管理/</id>
    <published>2018-03-26T01:16:02.000Z</published>
    <updated>2018-03-26T02:58:27.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;MySQL中字符大小写&quot;&gt;&lt;a href=&quot;#MySQL中字符大小写&quot; class=&quot;headerlink&quot; title=&quot;MySQL中字符大小写&quot;&gt;&lt;/a&gt;MySQL中字符大小写&lt;/h2&gt;&lt;p&gt;1、SQL关键字及函数名不区分字符大小写； 但是为了提高缓存命中率，无论你使用大写或小写，风格上要一致。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;2、数据库、表及视图名称的大小区分与否取决于底层OS及FS。如果你是装在windows上的，是不区分大小写的，如果是安装在Linux上的，默认是区分大小写。因此很多时候我们把windows上的库移植到linux上就可能出问题。反过来移植更有问题。&lt;br&gt;3、存储过程、存储函数及事件调度器的名字不区分大小写，但触发器区分；&lt;br&gt;4、表的别名区分大小写；&lt;br&gt;5、对字段中的数据，如果字段类型为Binary类型，则区分大小写；非Binary不区分大小写(非Binary的排序取决于字符集及排序规则)。&lt;/p&gt;
&lt;h2 id=&quot;MySQL-DDL&quot;&gt;&lt;a href=&quot;#MySQL-DDL&quot; class=&quot;headerlink&quot; title=&quot;MySQL DDL&quot;&gt;&lt;/a&gt;MySQL DDL&lt;/h2&gt;&lt;h3 id=&quot;数据库&quot;&gt;&lt;a href=&quot;#数据库&quot; class=&quot;headerlink&quot; title=&quot;数据库&quot;&gt;&lt;/a&gt;数据库&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;1.创建数据库&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;CREATE {DATABASE|SCHEMA} [IF NOT EXISTS] db_name [DEFAULT] [CHARACTER SET=&amp;apos;&amp;apos;] [DEFAULT] [COLLATE=&amp;apos;&amp;apos;]

mysql&amp;gt; HELP CREATE DATABASE
Name: &amp;apos;CREATE DATABASE&amp;apos;
Description:
Syntax:
CREATE {DATABASE | SCHEMA} [IF NOT EXISTS] db_name
    [create_specification] ...

create_specification:
    [DEFAULT] CHARACTER SET [=] charset_name
  | [DEFAULT] COLLATE [=] collation_name

CREATE DATABASE creates a database with the given name. To use this statement, you need the CREATE privilege for the database. CREATE SCHEMA is a synonym for CREATE DATABASE.

URL: http://dev.mysql.com/doc/refman/5.6/en/create-database.html
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;【注意】:创建数据库时使用database或者schema都可以，对于oracle来讲，通常数据库被叫做schema，对Linux而言，schema或datable都表示数据库。&lt;br&gt;【示例】：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; create database t1 default charset utf8;
Query OK, 1 row affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;2.删除和修改数据库&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;DROP {DATABASE | SCHEMA} [IF EXISTS] db_name
ALTER {DATABASE|SCHEMA} db_name [DEFAULT] [CHARACTER SET=&amp;apos;&amp;apos;] [DEFAULT] [COLLATE=&amp;apos;&amp;apos;]  #如果创建数据库时忘记指定其默认字符集默认排序规则，可以使用ALTER进行修改。
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;【注意】:如果想换数据库的名字，没有什么好办法，只能把数据库删除再重新创建或者备份数据库，然后删除，创建个新库，把表在导进去，这是比较理想的做法。还有一种比较粗暴的方法，到数据目录下，把那个目录名改一下就可以了。但改完后，这个数据库的数据字典中的信息并没有改变。因此千万不要试图通过修改那个目录名称来达到修改数据库名的目的，所以唯一的可靠做法就是备份、删除、创建新库、导入表，这个代价是很大的。&lt;/p&gt;
&lt;h3 id=&quot;表&quot;&gt;&lt;a href=&quot;#表&quot; class=&quot;headerlink&quot; title=&quot;表&quot;&gt;&lt;/a&gt;表&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/15.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;表创建&quot;&gt;&lt;a href=&quot;#表创建&quot; class=&quot;headerlink&quot; title=&quot;表创建&quot;&gt;&lt;/a&gt;表创建&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;1.第一种方式&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name       
(create_definition,...)
[table_options]
[partition_options]   # 把一张表切割开，分成几张小表。
    TEMPORARY：创建临时表，临时表是保存在内存中，将占据内存空间，因此一般情况下非管理员在创建内存表上是没有权限的。

(create_definition,...)：
    字段的定义：字段名、类型和类型修饰符
    键、约束或索引：
        PRIMARY KEY, UNIQUE KEY, FOREIGN KEY, CHECK(检查约束)
        {INDEX|KEY}

[table_options]
    ENGINE [=] engine_name   ——指定表的存储引擎，如果不指定，将使用默认存储引擎。
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;【示例】：&lt;br&gt;查看默认存储引擎:&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/16.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;查看表的存储引擎：&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/17.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;创建表时指定存储引擎为MyISAM：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; CREATE TABLE `t3`(Name VARCHAR(50) NOT NULL, Age TINYINT UNSIGNED NOT NULL, PRIMARY KEY(Name,Age)) ENGINE=&amp;apos;MyISAM&amp;apos;;
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/18.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[table_options]
    AUTO_INCREMENT [=] value
    [DEFAULT] CHARACTER SET [=] charset_name
    [DEFAULT] COLLATE [=] collation_name
    COMMENT [=] &amp;apos;string&amp;apos;   #表的注释。如果表名不足以描述表的功能的话，给表加注释是一个好的习惯。
    DELAY_KEY_WRITE [=] {0 | 1}   ——延迟键写入。这一项在一定程度上能够提升性能的，但是有可能会影响查询。索引是加速查询的，但索引会降低写操作性能，为什么？因为我们更新表时必然得重建索引。所以一个修改非常频繁的表，其索引几乎是无效的。因为索引会经常被重建，索引的大量重建会导致性能很低。这就需要延迟键写入，把跟索引相关的信息几个合并起来，过一次会儿写入。
    ROW_FORMAT [=] {DEFAULT|DYNAMIC|FIXED|COMPRESSED|REDUNDANT|COMPACT}
    TABLESPACE tablespace_name [STORAGE {DISK|MEMORY|DEFAULT}]  #指定表空间。MySQL的表主要有两种类型，一种是MyISAM表，一种是InnoDB表。对于InnoDB表来说，如果使用默认的存储方式，我们可以通过TABLESPACE来指定多个共享表空间。如果是独立的表空间存储方式，也可以通过TABLESPACE来指定表空间名字。
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;MyISAM表，每张表有三个文件，都位于数据库目录中：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;tb_name.frm: 表结构定义&lt;/li&gt;
&lt;li&gt;tb_name.MYD: 数据文件&lt;/li&gt;
&lt;li&gt;tb_name.MYI: 索引文件&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;InnoDB表，有两种存储方式：&lt;/strong&gt;&lt;br&gt;（1）默认：每表有一个独立文件和一个多表共享的文件&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;tb_name.frm: 表结构的定义，位于数据库目录(与数据库名同名的目录)中；&lt;/li&gt;
&lt;li&gt;ibdata#: 所有数据库的所有Innodb表共享的表空间文件，默认位于数据目录(datadir指向的目录)中；管理起来不方便，所以一般很少这么用。采用第二种方式，将来备份恢复时也很方便。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;（2）独立的表空间：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;tb_name.frm: 每表有一个表结构文件&lt;/li&gt;
&lt;li&gt;tb_name.ibd: 一个独有的表空间文件&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;【注意】:一般我们创建一张表时，表就会放在数据库目录下，但是对Innodb存储引擎例外。Innodb存储引擎的所有表默认都放在一个统一的表空间的文件中。&lt;br&gt;如何启用第二种方式呢？&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SHOW GLOBAL VARIABLES LIKE &amp;apos;innodb%&amp;apos;;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/19.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;这里已经开启了第二种。可以修改这个值：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; SET GLOBAL innodb_file_per_table=OFF;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;【注意】：修改GLOBAL变量对当前会话不生效，需要退出重建会话。如果想要永久有效就得把这个配置写到配置文件的[mysqld]中。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# vim /etc/my.cnf
innodb_file_per_table=ON
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;2.表创建的第二种方式（复制表数据，也就是根据其他表来创建当前表）&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name
  [(create_definition,...)]
  [table_options]
  select_statement  #只是数据一致，但是字段属性跟源表并不一定一致。因此不是复制表，而是复制表中的数据。并自动判断实现字段的创建。对我们而言，这种方法不靠谱。
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/20.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.表创建：第三种方式（只复制表结构，不复制数据）&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name
{ LIKE old_tbl_name | (LIKE old_tbl_name) }
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;所以要先用第三种方式复制表结构，在使用INSERT语句往新表中插入数据，但数据不是自己手动创建的，而是从另外一张表中查询而来的。这样才能做到完整复制一张表。&lt;/p&gt;
&lt;h3 id=&quot;表删除&quot;&gt;&lt;a href=&quot;#表删除&quot; class=&quot;headerlink&quot; title=&quot;表删除&quot;&gt;&lt;/a&gt;表删除&lt;/h3&gt;&lt;pre&gt;&lt;code&gt;DROP [TEMPORARY] TABLE [IF EXISTS]
  tbl_name [, tbl_name] ...
  [RESTRICT | CASCADE]  #CASCADE做级联删除，就是说如果某张表被其他表依赖，那么删除这个某表，使用CASCADE就会删除依赖这张某表的其他表。
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;表修改&quot;&gt;&lt;a href=&quot;#表修改&quot; class=&quot;headerlink&quot; title=&quot;表修改&quot;&gt;&lt;/a&gt;表修改&lt;/h3&gt;&lt;p&gt;和表创建一样麻烦。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/21.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ALTER TABLE tbl_name
  [alter_specification [, alter_specification] ...]
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&quot;修改字段定义&quot;&gt;&lt;a href=&quot;#修改字段定义&quot; class=&quot;headerlink&quot; title=&quot;修改字段定义&quot;&gt;&lt;/a&gt;修改字段定义&lt;/h4&gt;&lt;p&gt;&lt;strong&gt;1.插入新字段&lt;/strong&gt;&lt;br&gt;插入新字段：可以一次插入单个字段，也可以一次插入多个字段。插入多个字段时，多个字段需要用()括起来。&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/22.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.删除字段&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;DROP [COLUMN] col_name
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/23.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.修改字段&lt;/strong&gt;&lt;br&gt;(1)仅修改字段名称&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;CHANGE [COLUMN] old_col_name new_col_name column_definition
[FIRST|AFTER col_name]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;(2)修改字段类型及属性等&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;MODIFY [COLUMN] col_name column_definition
[FIRST | AFTER col_name]
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&quot;修改约束、键或索引等&quot;&gt;&lt;a href=&quot;#修改约束、键或索引等&quot; class=&quot;headerlink&quot; title=&quot;修改约束、键或索引等&quot;&gt;&lt;/a&gt;修改约束、键或索引等&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;ADD {INDEX|KEY} [index_name]
[index_type] (index_col_name,...) [index_option] ...
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/24.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;表改名&quot;&gt;&lt;a href=&quot;#表改名&quot; class=&quot;headerlink&quot; title=&quot;表改名&quot;&gt;&lt;/a&gt;表改名&lt;/h4&gt;&lt;p&gt;使用ALTER命令：RENAME [TO|AS] new_tbl_name&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; ALTER TABLE `t5` RENAME TO `t7`;
Query OK, 0 rows affected (0.03 sec) 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;或者RENAME命令：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mysql&amp;gt; RENAME TABLE old_name TO new_name;  
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&quot;修改表的存储引擎&quot;&gt;&lt;a href=&quot;#修改表的存储引擎&quot; class=&quot;headerlink&quot; title=&quot;修改表的存储引擎&quot;&gt;&lt;/a&gt;修改表的存储引擎&lt;/h4&gt;&lt;p&gt;表引擎的修改背后mysql所执行的操作是创建一个你所指定存储引擎的新表，并把老的表中的数据导入到新表中。不建议通过ALTER直接修改表的存储引擎。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;MySQL中字符大小写&quot;&gt;&lt;a href=&quot;#MySQL中字符大小写&quot; class=&quot;headerlink&quot; title=&quot;MySQL中字符大小写&quot;&gt;&lt;/a&gt;MySQL中字符大小写&lt;/h2&gt;&lt;p&gt;1、SQL关键字及函数名不区分字符大小写； 但是为了提高缓存命中率，无论你使用大写或小写，风格上要一致。
    
    </summary>
    
      <category term="MySQL" scheme="http://yoursite.com/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="http://yoursite.com/tags/MySQL/"/>
    
  </entry>
  
</feed>
