<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="MySQL," />





  <link rel="alternate" href="/atom.xml" title="jkzhao's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.0.1" />






<meta name="description" content="MySQL逻辑架构我们可以把mysql的架构分为3层：">
<meta name="keywords" content="MySQL">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL事务及隔离级别">
<meta property="og:url" content="http://yoursite.com/2018/04/05/MySQL事务及隔离级别/index.html">
<meta property="og:site_name" content="jkzhao&#39;s blog">
<meta property="og:description" content="MySQL逻辑架构我们可以把mysql的架构分为3层：">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/63.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/64.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/65.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/66.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/67.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/68.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/69.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/70.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/71.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/72.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/73.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/74.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/75.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/76.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/77.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/78.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/79.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/80.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/81.png">
<meta property="og:updated_time" content="2018-04-08T08:35:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL事务及隔离级别">
<meta name="twitter:description" content="MySQL逻辑架构我们可以把mysql的架构分为3层：">
<meta name="twitter:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/63.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6287775856811050000,
      author: 'Author'
    }
  };
</script>

  <title> MySQL事务及隔离级别 | jkzhao's blog </title>
</head>
<a href="https://github.com/you"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?c179eb46ac47d3b4b1b9203b82ee5821";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <a href="https://github.com/jkzhao"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">jkzhao's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">学习 总结 思考</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            留言
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'CziK4aDdRyzFJrfygnHH','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                MySQL事务及隔离级别
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-04-05T09:17:31+08:00" content="2018-04-05">
              2018-04-05
            </time>
            
              <span class="post-updated">
              &nbsp; | &nbsp; 更新于
              <time itemprop="dateUpdated" datetime="2018-04-08T16:35:32+08:00" content="2018-04-08">
              2018-04-08
              </time>
              </span>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2018/04/05/MySQL事务及隔离级别/" class="leancloud_visitors" data-flag-title="MySQL事务及隔离级别">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="MySQL逻辑架构"><a href="#MySQL逻辑架构" class="headerlink" title="MySQL逻辑架构"></a>MySQL逻辑架构</h2><p><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/63.png" alt=""><br>我们可以把mysql的架构分为3层：<a id="more"></a></p>
<p><strong>1.第一层：连接池或称为线程处理工具。处理用户的连接建立。</strong><br>        mysql现在对于线程管理是通过线程池来实现的。一个池子中所能够容纳的水量是有限的，所以一个线程池中所能够容纳的线程数也是有限的。所以mysql启动时事先创建好一个线程池，在这个池子内假如创建了100个空闲线程，来一个用户连接，给它一个线程，当用户连接达到100个，新连接就要排队等待，后面维持一个队列。当某个连接上的用户请求退出后，其对应的线程不会销毁，只会清理数据，还原成原来的样子，再去处理新的用户请求。<br>        所以用户的连接线程在线程池的管理模式中是不会被销毁的，一般是能够实现重用的。所以就避免了频繁的线程创建和删除。<br>        mysql客户端和服务器端通信要通过mysql协议进行通信，协议一般来讲有两种格式。http协议是文本的，我们可以通过telnet连进去手动发送命令的，https协议是二进制的。mysql协议这两种格式都支持。哪种协议会比较高效？二进制的会略微高效一点，所以很多支持两种协议的默认都使用二进制格式。无论是二进制还是文本，都是明文的，只不过你编码成了二进制格式而已，我们只需要一个解码工具，就能把二进制转换为原来的样子了。<br>        为了安全，加密。mysql支持将它的协议基于ssl进行发送的。</p>
<p><strong>2.第二层：mysql核心服务层。是MySQL的核心功能层。</strong>包括查询解析、分析、优化、缓存以及mysql的所有内置函数(BIF)等。<br>        Parser：解析器，也叫分析器。主要功能是分析查询语句的。首先要做词法分析，要把整个sql语句切割成一个一个的片段，还要做语法分析，看看整个sql语句中有没有语法错误，甚至于还要做语义分析。这些都是由分析器完成。当然，mysql并没有自己开发分析器，有很多著名的开源分析器，yacc和lex，一个做词法分析，一个做语法分析的。mysql借用了这分析器做了二次开发并整合进mysql使用了。<br>        Optimizer：优化器。包括重写查询、决定表的读取顺序(多表查询时调整表的读取顺序)、多表查询时选择一个开销最小的索引。但是我们在查询时，如果你作为用户知道哪个索引更好用，你也可以向mysql发送语句时给它提示以影响mysql决策的。对于mysql来讲，优化器并不关心底层那个表真正使用的存储引擎是什么，但是存储引擎根据其特性的不同所提供的性能表现也不同。但是优化器又不考虑存储引擎，但好在优化器会通过向存储引擎的API发起调用请求让存储引擎返回这种存储引擎下所对应的表的统计数据来判断这个表的查询开销有多大，并基于此做出优化决策。一直在说查询，INSERT和UPDATE都要查询的，我们这里讲的查询是广义上的查询，不仅仅是SELECT。不过，如果你真正执行的是SELECT，mysql还有个内部的工具对这种查询可以发挥效用以提升性能的，就是图中的Query Cache。<br>        Query Cache只对SELECT语句有效。只有SELECT才会被缓存下来。所以如果我们执行的是SELECT语句，服务器每次在解析查询操作之前会去查看缓存中是否命中。所以这对SELECT操作是额外的开销，但是如果命中率足够可靠的话，Query Cache还是很有必要的。怎么查看查询缓存的命中率多高？后面讲到mysql优化时，会讲怎么根据缓存的统计数据来分析命中率的。在命中率的基础上决定到底是否开启缓存。你可以把缓存工作在某种特定模式下，默认mysql都不缓存。只有我们手动明确要缓存语句才缓存。</p>
<p><strong>3.第三层：存储引擎。</strong>存储引擎的主要工作是真正负责数据的存储和提取的。</p>
<h2 id="MySQL锁"><a href="#MySQL锁" class="headerlink" title="MySQL锁"></a>MySQL锁</h2><p>MySQL允许多用户同时连接进来，如果多个用户在访问同一张表的时候，会发生什么问题？比如A用户连接进来修改表A，第二个用户B这时想查询表A中数据能否进行查询？不能查询，怎么达到这个目的呢？你得让B用户的查询操作知道表A正在被某一用户施加写操作。这需要MySQL内在的某些机制完成并发访问控制，而并发访问控制通常基于锁来实现。对于读操作来说，多个用户同时读是没问题的，但是对于写操作是不行的。</p>
<h3 id="MySQL锁-1"><a href="#MySQL锁-1" class="headerlink" title="MySQL锁"></a>MySQL锁</h3><ul>
<li><p>1.按执行操作时施加的锁模式来分类：两种类型。</p>
<ul>
<li>读锁：又称为共享锁，可以同时读，但是不可以写。读为什么要加锁，因为防止其他人去修改我们正在查询的数据的。</li>
<li>写锁：独占锁，排它锁。</li>
</ul>
</li>
<li><p>2.按锁粒度划分：</p>
<ul>
<li>表锁：table lock。锁定了整张表。开销最小。</li>
<li>行锁：row lock。锁定了需要的行。</li>
</ul>
</li>
</ul>
<p>粒度越小，开销越大，但并发性越好；<br>粒度越大，开销越小，但并发性越差；</p>
<ul>
<li>3.按锁的实现位置划分：<ul>
<li>MySQL锁：可以使用显式锁。很多时候我们提到MySQL，是指第二层核心服务层。</li>
<li>存储引擎锁：自动进行的（隐式锁）。大多数查询操作都会自动由存储引擎施加锁的。</li>
</ul>
</li>
</ul>
<h3 id="如何实现显式锁-在服务器级别显式锁只能是表级锁"><a href="#如何实现显式锁-在服务器级别显式锁只能是表级锁" class="headerlink" title="如何实现显式锁(在服务器级别显式锁只能是表级锁)"></a>如何实现显式锁(在服务器级别显式锁只能是表级锁)</h3><pre><code>LOCK TABLES
UNLOCK TABLES  #只能一次释放所有表的锁，不能指定表和锁类型。见下面的截图语法。

LOCK TABLES
    tbl_name lock_type
    [, tbl_name lock_type] ...
</code></pre><p>锁类型：READ|WRITE</p>
<p><strong>【示例1】:演示读锁。</strong></p>
<pre><code>mysql&gt; use hellodb
Database changed
mysql&gt; LOCK TABLES classes READ;
Query OK, 0 rows affected (0.00 sec)
</code></pre><p>启动另一个终端，连接进来：<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/64.png" alt=""></p>
<p>在第一个终端上，释放锁：</p>
<pre><code>mysql&gt; UNLOCK TABLES;
Query OK, 0 rows affected (0.00 sec)
</code></pre><p>然后到第二个窗口，会发现数据已经插入成功了。</p>
<p><strong>InnoDB存储引擎也支持另外一种显式锁(锁定挑选出的部分行，行级锁 )：</strong></p>
<pre><code>SELECT ... LOCK IN SHARE MODE;   共享锁
SELECT ... FOR UPDATE;   排它锁
</code></pre><p>【示例2】:演示InnoDB行级锁。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/65.png" alt=""><br><strong>【注意】:</strong><br>1.只是在语句执行过程中添加了锁，语句执行结束了锁就释放了。因此就没有UNLOCK了。<br>2.除了特性情况下，做备份操作时，不建议手动施加锁，因为存储引擎会自动进行锁操作，而且它的锁操作性能比我们自己施加要好的多。做备份操作时，要手动添加读锁。</p>
<h2 id="事务Transaction"><a href="#事务Transaction" class="headerlink" title="事务Transaction"></a>事务Transaction</h2><p>基于锁我们实现了一定意义上的并发功能了，但是一般来讲，为了完成更高级别的操作，需要支持事务。<br>事务就是一组原子性的查询语句，也即将多个查询当作一个独立的工作单元。<br>【注意】:MyISAM存储引擎是不支持事务的。</p>
<p><strong>ACID测试：能满足ACID测试就表示其支持事务，或兼容事务。</strong></p>
<ul>
<li>A：Atomicity，原子性。</li>
<li>C：Consistency, 一致性。我们的数据库总是从一个一致性状态转到另一个一致性状态。比如，Tom从自己的账户(7000)转账3000到Jerry账户(5000)上， 这样Tom就只剩4000，Jerry就有了8000。转账前二者总和是12000，转账后还是12000。</li>
<li>I: Isolation, 隔离性, 一个事务的所有修改操作在提交之前所有的修改对其它事务是不可见的。<ul>
<li>第一步：Tom: 7000-3000。事务没提交之前，有人查询Jerry账户，是不能看到这多3000的。同样查询Tom账户，也不能看到少了3000。因为我们事务还没提交</li>
<li>第二步：Jerry: 5000+3000</li>
</ul>
</li>
<li>D：Durability, 持久性, 一旦事务得到提交，其所做的修改会永久有效。</li>
</ul>
<p>事实上，ACID机制需要背后有强大的机制才能实现的，而且一旦让一个存储引擎或关系型数据库支持事务，那么它在复杂程度上面是成几何倍上升的。并且如果事务做的完全隔离，事务就是串行的了。如果做到完全隔离，只有在两个事务压根不会涉及到同一张表的时候才会同时执行，否则只要涉及到同一个数据集，事务都只能以串行方式进行。数据安全性越高，其并发性就越低。所以就有了隔离级别的概念。</p>
<h3 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h3><p>隔离级别(4个)：</p>
<ul>
<li>READ UNCOMMITTED (读未提交)<br>读别人还没提交的数据，这属于没什么隔离性的。数据安全性最差，但并发性最好(但从实际上来看，不会比其他级别好太多。又极其缺乏安全性，所以很少用。)<br>会产生脏读，不可重读，幻读(看到的数据和背后的数据不一样)</li>
<li>READ COMMITTED (读提交)<br>只有别人提交了，我们才能看到。市面上常见的大多数关系型数据库隔离级别都是读提交，不过mysql不是。mysql是第3个隔离级别，可重读。<br>不可重读，幻读</li>
<li>REPEATABLE READ (可重读)<br>解决了脏读问题，而且可重读，但是解决不了幻读问题。</li>
<li>SERIALIZABLE (串行化)<br>强制事务的串行执行避免了幻读。</li>
</ul>
<p>跟事务相关的命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">mysql&gt; HELP CONTENTS;</div><div class="line">You asked for help about help category: &quot;Contents&quot;</div><div class="line">For more information, type &apos;help &lt;item&gt;&apos;, where &lt;item&gt; is one of the following</div><div class="line">categories:</div><div class="line">   Account Management</div><div class="line">   Administration</div><div class="line">   Compound Statements</div><div class="line">   Data Definition</div><div class="line">   Data Manipulation</div><div class="line">   Data Types</div><div class="line">   Functions</div><div class="line">   Functions and Modifiers for Use with GROUP BY</div><div class="line">   Geographic Features</div><div class="line">   Help Metadata</div><div class="line">   Language Structure</div><div class="line">   Plugins</div><div class="line">   Procedures</div><div class="line">   Storage Engines</div><div class="line">   Table Maintenance</div><div class="line">   Transactions</div><div class="line">   User-Defined Functions</div><div class="line">   Utility</div><div class="line"></div><div class="line">mysql&gt; HELP Transactions;</div><div class="line">You asked for help about help category: &quot;Transactions&quot;</div><div class="line">For more information, type &apos;help &lt;item&gt;&apos;, where &lt;item&gt; is one of the following</div><div class="line">topics:</div><div class="line">   CHANGE MASTER TO</div><div class="line">   DEALLOCATE PREPARE</div><div class="line">   EXECUTE STATEMENT</div><div class="line">   ISOLATION</div><div class="line">   LOCK</div><div class="line">   PREPARE</div><div class="line">   PURGE BINARY LOGS</div><div class="line">   RESET MASTER</div><div class="line">   RESET SLAVE</div><div class="line">   SAVEPOINT</div><div class="line">   SET GLOBAL SQL_SLAVE_SKIP_COUNTER</div><div class="line">   SET SQL_LOG_BIN</div><div class="line">   START SLAVE</div><div class="line">   START TRANSACTION</div><div class="line">   STOP SLAVE</div><div class="line">   XA</div><div class="line"></div><div class="line">mysql&gt; HELP COMMIT</div><div class="line">Many help items for your request exist.</div><div class="line">To make a more specific request, please type &apos;help &lt;item&gt;&apos;,</div><div class="line">where &lt;item&gt; is one of the following</div><div class="line">topics:</div><div class="line">   START TRANSACTION</div><div class="line">   XA</div><div class="line"></div><div class="line">mysql&gt; HELP ROLLBACK</div><div class="line">Many help items for your request exist.</div><div class="line">To make a more specific request, please type &apos;help &lt;item&gt;&apos;,</div><div class="line">where &lt;item&gt; is one of the following</div><div class="line">topics:</div><div class="line">   SAVEPOINT</div><div class="line">   START TRANSACTION</div><div class="line">   XA</div><div class="line"></div><div class="line">mysql&gt; HELP SAVEPOINT</div><div class="line">Name: &apos;SAVEPOINT&apos;</div><div class="line">Description:</div><div class="line">Syntax:</div><div class="line">SAVEPOINT identifier</div><div class="line">ROLLBACK [WORK] TO [SAVEPOINT] identifier</div><div class="line">RELEASE SAVEPOINT identifier</div><div class="line"></div><div class="line">InnoDB supports the SQL statements SAVEPOINT, ROLLBACK TO SAVEPOINT,</div><div class="line">RELEASE SAVEPOINT and the optional WORK keyword for ROLLBACK.</div><div class="line"></div><div class="line">URL: http://dev.mysql.com/doc/refman/5.6/en/savepoint.html</div></pre></td></tr></table></figure></p>
<p>解释下常用的：</p>
<pre><code>mysql&gt; START TRANSACTION  手动显式启动一个事务。在这个事务中执行的所有语句在你执行下一条语句之前都处于未提交状态，未提交的事务都可以进行回滚。
mysql&gt; COMMIT
mysql&gt; ROLLBACK   回滚。回滚时有个问题，如果我们的事务非常大，假如有60个语句，我们执行到第40个的时候，发现第38个错了，如果能够回滚到第35个会比回滚到开头好多了，这就需要SAVEPOINT。我们可以在事务中设置多个保存点，给保存点设置个名字。

mysql&gt; SAVEPOINT identifier
mysql&gt; ROLLBACK [WORK] TO [SAVEPOINT] identifier
</code></pre><h3 id="示例1：演示事务回滚"><a href="#示例1：演示事务回滚" class="headerlink" title="示例1：演示事务回滚"></a>示例1：演示事务回滚</h3><p>【注意】:MySQL数据库默认启动了自动提交的功能，也就意味着哪怕你手动不提交，也会自动提交的。但是当我们显式启动事务时，MySQL就不会自动帮我们提交。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/66.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/67.png" alt=""></p>
<h3 id="示例2：演示SAVEPOINT"><a href="#示例2：演示SAVEPOINT" class="headerlink" title="示例2：演示SAVEPOINT"></a>示例2：演示SAVEPOINT</h3><p><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/68.png" alt=""><br>如果没有显式启动事务，每个语句都会当作一个独立的事务，其执行完成后会被自动提交。自动提交会带来性能上的很大影响，因为每一个语句都自动提交，都会产生一个I/O。</p>
<pre><code>mysql&gt; SHOW GLOBAL VARIABLES LIKE &apos;%commit%&apos;;
+--------------------------------+-------+
| Variable_name                  | Value |
+--------------------------------+-------+
| autocommit                     | ON    |
| binlog_order_commits           | ON    |
| innodb_api_bk_commit_interval  | 5     |
| innodb_commit_concurrency      | 0     |
| innodb_flush_log_at_trx_commit | 1     |
+--------------------------------+-------+
5 rows in set (0.00 sec)

mysql&gt; SELECT @@global.autocommit;
+---------------------+
| @@global.autocommit |
+---------------------+
|                   1 |
+---------------------+
1 row in set (0.00 sec)

mysql&gt; SET GLOBAL autocommit = 0;  注意这么改对当前会话没有影响，因为我改的是全局的。
如果关闭自动提交，请记得手动启动事务，手动进行提交；
</code></pre><h3 id="事务隔离级别演示"><a href="#事务隔离级别演示" class="headerlink" title="事务隔离级别演示"></a>事务隔离级别演示</h3><p>MySQL默认的事务隔离级别是可重复读。查看MySQL的事务隔离级别：</p>
<pre><code>mysql&gt; SHOW GLOBAL VARIABLES LIKE &apos;%iso%&apos;;
+---------------+-----------------+
| Variable_name | Value           |
+---------------+-----------------+
| tx_isolation  | REPEATABLE-READ |
+---------------+-----------------+
1 row in set (0.00 sec)

mysql&gt; SHOW GLOBAL VARIABLES LIKE &apos;tx_isolation&apos;;
+---------------+-----------------+
| Variable_name | Value           |
+---------------+-----------------+
| tx_isolation  | REPEATABLE-READ |
+---------------+-----------------+
1 row in set (0.00 sec)

mysql&gt; SELECT @@global.tx_isolation;  
+-----------------------+
| @@global.tx_isolation |
+-----------------------+
| REPEATABLE-READ       |
+-----------------------+
1 row in set (0.00 sec)
</code></pre><h4 id="示例3-演示”读未提交”"><a href="#示例3-演示”读未提交”" class="headerlink" title="示例3:演示”读未提交”"></a>示例3:演示”读未提交”</h4><pre><code>mysql&gt; SET GLOBAL tx_isolation=&apos;READ-UNCOMMITTED&apos;;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; SHOW GLOBAL VARIABLES LIKE &apos;%iso%&apos;;
+---------------+------------------+
| Variable_name | Value            |
+---------------+------------------+
| tx_isolation  | READ-UNCOMMITTED |
+---------------+------------------+
1 row in set (0.00 sec)
</code></pre><p>重新打开两个shell，连接进mysql：注意进去后两个shell要各自先启动事务。然后在到第一个会话执行操作。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/69.png" alt=""><br>在打开一个shell，连接进mysql：<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/70.png" alt=""><br>下面第一个会话回滚事务：</p>
<pre><code>mysql&gt; ROLLBACK;
Query OK, 0 rows affected (0.00 sec)
</code></pre><p>到第2个会话中，再次查询：<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/71.png" alt=""><br>第2个会话回滚事务。</p>
<pre><code>mysql&gt; ROLLBACK;
Query OK, 0 rows affected (0.00 sec)
</code></pre><h4 id="示例4-演示”读提交”"><a href="#示例4-演示”读提交”" class="headerlink" title="示例4:演示”读提交”"></a>示例4:演示”读提交”</h4><pre><code>mysql&gt; SET GLOBAL tx_isolation=&apos;READ-COMMITTED&apos;;
Query OK, 0 rows affected (0.00 sec)
</code></pre><p>重新打开两个shell，连接进mysql：注意进去后两个shell要各自先启动事务。然后在到第一个会话执行操作。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/72.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/73.png" alt=""><br>此时如果第一个会话中的事务回滚了，那么第二个会话看到的还是第3个数据是有的，这是很正确的；<br>但是如果第一个会话中的事务提交了，<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/74.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/75.png" alt=""><br><strong>同一个事务中多次读取的结果不一样，这就是不可重复读。所以脏读了就一定不可重复读，因为你每一次都能读到别人直接修改的数据。所以”读提交”在同一个事务中多次读取仍然可能是不一样的。</strong></p>
<h4 id="示例3-演示”可重读”"><a href="#示例3-演示”可重读”" class="headerlink" title="示例3:演示”可重读”"></a>示例3:演示”可重读”</h4><pre><code>mysql&gt; SET GLOBAL tx_isolation=&apos;REPEATABLE-READ&apos;;
Query OK, 0 rows affected (0.00 sec)
</code></pre><p>重新打开两个shell，连接进mysql：注意进去后两个shell要各自先启动事务。然后在到第一个会话执行操作。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/76.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/77.png" alt=""><br>但是如果第一个会话中的事务提交了，<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/78.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/79.png" alt=""><br>虽然”可重读”解决了不可重读的问题，但是仍然没有解决幻读的问题。</p>
<h4 id="示例4-演示”串行化”"><a href="#示例4-演示”串行化”" class="headerlink" title="示例4:演示”串行化”"></a>示例4:演示”串行化”</h4><pre><code>mysql&gt; SET GLOBAL tx_isolation=&apos;serializable&apos;;
Query OK, 0 rows affected (0.00 sec)
</code></pre><p>重新打开两个shell，连接进mysql：注意进去后两个shell要各自先启动事务。然后在到第一个会话执行操作。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/80.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/MySQL/81.png" alt=""><br>只能等对方提交或者回滚，你才能查看结果。串行化解决了幻读的问题，但是性能太差了。</p>
<p><strong>【建议】：对事务要求不特别严格的场景下，可以使用读提交。要想让配置永久生效，要改配置文件。</strong></p>
<p>事实上mysql是怎么实现的？为什么别人提交了，对可重读来讲，还不能看到数据。这就是MVCC机制。<br><strong>MVCC：多版本并发控制</strong><br>对于可重读等机制来讲，每个事务启动时，InnoDB为会每个启动的事务提供一个当下时刻的快照，后续的所有操作都是在快照的基础上执行的。因此不管事务执行多长时间，在同一个事务中看到的数据是一致的。<br>为了实现此功能，InnoDB会为每个表提供两隐藏的字段，一个用于保存行的创建时间，一个用于保存行的失效时间(就是哪个事务删除过)。<br>实际上里面存的不是时间，里面存储的是系统版本号；（system version number）。每启动一个事务，InnoDB存储引擎就会给这个事务创建一个当下时刻的快照，并且为对应所读取的数据的快照启动一个新版本号，+1。</p>
<p>MVCC只在两个隔离级别下有效：READ COMMITTED和REPEATABLE READ。</p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MySQL/" rel="tag"><i class="fa fa-tag"></i>MySQL</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/02/MySQL-DML/" rel="next" title="MySQL DML">
                <i class="fa fa-chevron-left"></i> MySQL DML
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/04/08/MySQL存储引擎对比/" rel="prev" title="MySQL存储引擎对比">
                MySQL存储引擎对比 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>
  
        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Zhao Jiankai" />
          <p class="site-author-name" itemprop="name">Zhao Jiankai</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">83</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/jkzhao" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/3566507667/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.importnew.com/" title="ImportNew" target="_blank">ImportNew</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL逻辑架构"><span class="nav-number">1.</span> <span class="nav-text">MySQL逻辑架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL锁"><span class="nav-number">2.</span> <span class="nav-text">MySQL锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL锁-1"><span class="nav-number">2.1.</span> <span class="nav-text">MySQL锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何实现显式锁-在服务器级别显式锁只能是表级锁"><span class="nav-number">2.2.</span> <span class="nav-text">如何实现显式锁(在服务器级别显式锁只能是表级锁)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务Transaction"><span class="nav-number">3.</span> <span class="nav-text">事务Transaction</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#隔离级别"><span class="nav-number">3.1.</span> <span class="nav-text">隔离级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例1：演示事务回滚"><span class="nav-number">3.2.</span> <span class="nav-text">示例1：演示事务回滚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例2：演示SAVEPOINT"><span class="nav-number">3.3.</span> <span class="nav-text">示例2：演示SAVEPOINT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事务隔离级别演示"><span class="nav-number">3.4.</span> <span class="nav-text">事务隔离级别演示</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#示例3-演示”读未提交”"><span class="nav-number">3.4.1.</span> <span class="nav-text">示例3:演示”读未提交”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例4-演示”读提交”"><span class="nav-number">3.4.2.</span> <span class="nav-text">示例4:演示”读提交”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例3-演示”可重读”"><span class="nav-number">3.4.3.</span> <span class="nav-text">示例3:演示”可重读”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例4-演示”串行化”"><span class="nav-number">3.4.4.</span> <span class="nav-text">示例4:演示”串行化”</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhao Jiankai</span>
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共219.9k字</span>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



    
    
    
    
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    
        <script type="text/javascript">
            function showGitment(){
                document.getElementById("gitment-display-button").style.display = "none";
                document.getElementById("gitment-container").style.display = "block";
                var gitment = new Gitment({
                        id: window.location.pathname, 
                        owner: 'jkzhao',
                        repo: 'jkzhao.github.io',
                        oauth: {
                            client_id: '4be0e4fdeba4fe3321a1',
                            client_secret: 'fba8264a3d059fb80eb9c77c8bef5a3a962a88e8',
                        }});
                gitment.render('gitment-container');
            }
        </script>
    


  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  



  
  
  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("r9OTvh5qdm5WfVnhJBm4XoP9-gzGzoHsz", "VAES8qziiwbdUq0IzdQVj5xD");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

<!--    -->
</body>
</html>
