<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Ansible," />





  <link rel="alternate" href="/atom.xml" title="jkzhao's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.0.1" />






<meta name="description" content="背景产品组在开发一个分布式日志系统，用的组件较多，单独手工部署一各个个软件比较繁琐，花的时间比较长，于是就想到了使用ansible playbook + roles进行部署，效率大大提高。">
<meta name="keywords" content="Ansible">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible实战：部署分布式日志系统">
<meta property="og:url" content="http://yoursite.com/2017/07/27/Ansible实战：部署分布式日志系统/index.html">
<meta property="og:site_name" content="jkzhao&#39;s blog">
<meta property="og:description" content="背景产品组在开发一个分布式日志系统，用的组件较多，单独手工部署一各个个软件比较繁琐，花的时间比较长，于是就想到了使用ansible playbook + roles进行部署，效率大大提高。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Ansible/48.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Ansible/49.png">
<meta property="og:updated_time" content="2017-11-07T07:45:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ansible实战：部署分布式日志系统">
<meta name="twitter:description" content="背景产品组在开发一个分布式日志系统，用的组件较多，单独手工部署一各个个软件比较繁琐，花的时间比较长，于是就想到了使用ansible playbook + roles进行部署，效率大大提高。">
<meta name="twitter:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Ansible/48.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6287775856811050000,
      author: 'Author'
    }
  };
</script>

  <title> Ansible实战：部署分布式日志系统 | jkzhao's blog </title>
</head>
<a href="https://github.com/you"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?c179eb46ac47d3b4b1b9203b82ee5821";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <a href="https://github.com/jkzhao"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">jkzhao's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">学习 总结 思考</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            留言
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'CziK4aDdRyzFJrfygnHH','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Ansible实战：部署分布式日志系统
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-07-27T20:30:05+08:00" content="2017-07-27">
              2017-07-27
            </time>
            
              <span class="post-updated">
              &nbsp; | &nbsp; 更新于
              <time itemprop="dateUpdated" datetime="2017-11-07T15:45:32+08:00" content="2017-11-07">
              2017-11-07
              </time>
              </span>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/运维自动化/" itemprop="url" rel="index">
                    <span itemprop="name">运维自动化</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2017/07/27/Ansible实战：部署分布式日志系统/" class="leancloud_visitors" data-flag-title="Ansible实战：部署分布式日志系统">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>产品组在开发一个分布式日志系统，用的组件较多，单独手工部署一各个个软件比较繁琐，花的时间比较长，于是就想到了使用ansible playbook + roles进行部署，效率大大提高。<br><a id="more"></a></p>
<h2 id="分布式日志系统架构图"><a href="#分布式日志系统架构图" class="headerlink" title="分布式日志系统架构图"></a>分布式日志系统架构图</h2><p><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Ansible/48.png" alt=""></p>
<h2 id="创建和使用roles"><a href="#创建和使用roles" class="headerlink" title="创建和使用roles"></a>创建和使用roles</h2><p>每一个软件或集群都创建一个单独的角色。</p>
<pre><code>[root@node1 ~]# mkdir -pv ansible_playbooks/roles/{db_server,web_server,redis_server,zk_server,kafka_server,es_server,tomcat_server,flume_agent,hadoop,spark,hbase,hive,jdk7,jdk8}/{tasks,files,templates,meta,handlers,vars} 
</code></pre><p><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Ansible/49.png" alt=""></p>
<h3 id="JDK7-role"><a href="#JDK7-role" class="headerlink" title="JDK7 role"></a>JDK7 role</h3><pre><code>[root@node1 jdk7]# pwd
/root/ansible_playbooks/roles/jdk7
[root@node1 jdk7]# ls
files  handlers  meta  tasks  templates  vars
</code></pre><h4 id="上传安装包"><a href="#上传安装包" class="headerlink" title="上传安装包"></a>上传安装包</h4><p>将jdk-7u80-linux-x64.gz上传到files目录下。</p>
<h4 id="编写tasks"><a href="#编写tasks" class="headerlink" title="编写tasks"></a>编写tasks</h4><pre><code>[root@node1 jdk7]# vim tasks/main.yml 
- name: mkdir necessary catalog                                                                                                               
  file: path=/usr/java state=directory mode=0755
- name: copy and unzip jdk 
  unarchive: src={{jdk_package_name}} dest=/usr/java/
- name: set env 
  lineinfile: dest={{env_file}} insertafter=&quot;{{item.position}}&quot; line=&quot;{{item.value}}&quot; state=present
  with_items:
  - {position: EOF, value: &quot;\n&quot;}
  - {position: EOF, value: &quot;export JAVA_HOME=/usr/java/{{jdk_version}}&quot;}
  - {position: EOF, value: &quot;export PATH=$JAVA_HOME/bin:$PATH&quot;}
  - {position: EOF, value: &quot;export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar&quot;}
- name: enforce env 
  shell: source {{env_file}}
</code></pre><h4 id="编写vars"><a href="#编写vars" class="headerlink" title="编写vars"></a>编写vars</h4><pre><code>[root@node1 jdk7]# vim vars/main.yml 
jdk_package_name: jdk-7u80-linux-x64.gz                                                                                                       
env_file: /etc/profile
jdk_version: jdk1.7.0_80
</code></pre><h4 id="使用角色"><a href="#使用角色" class="headerlink" title="使用角色"></a>使用角色</h4><p>在roles同级目录，创建一个jdk.yml文件，里面定义好你的playbook。</p>
<pre><code>[root@node1 ansible_playbooks]# vim jdk.yml 
- hosts: jdk
  remote_user: root
  roles:
  - jdk7
</code></pre><p>运行playbook安装JDK7：</p>
<pre><code>[root@node1 ansible_playbooks]# ansible-playbook jdk.yml 
</code></pre><p><strong>使用jdk7 role可以需要根据实际环境修改vars/main.yml里的变量以及/etc/ansible/hosts文件里定义的主机。</strong></p>
<h3 id="JDK8-role"><a href="#JDK8-role" class="headerlink" title="JDK8 role"></a>JDK8 role</h3><pre><code>[root@node1 jdk8]# pwd
/root/ansible_playbooks/roles/jdk8
[root@node1 jdk8]# ls
files  handlers  meta  tasks  templates  vars
</code></pre><h4 id="上传安装包-1"><a href="#上传安装包-1" class="headerlink" title="上传安装包"></a>上传安装包</h4><p>将jdk-8u73-linux-x64.gz上传到files目录下。</p>
<h4 id="编写tasks-1"><a href="#编写tasks-1" class="headerlink" title="编写tasks"></a>编写tasks</h4><pre><code>[root@node1 jdk8]# vim tasks/main.yml 
- name: mkdir necessary catalog                                                                                                               
  file: path=/usr/java state=directory mode=0755
- name: copy and unzip jdk 
  unarchive: src={{jdk_package_name}} dest=/usr/java/
- name: set env 
  lineinfile: dest={{env_file}} insertafter=&quot;{{item.position}}&quot; line=&quot;{{item.value}}&quot; state=present
  with_items:
  - {position: EOF, value: &quot;\n&quot;}
  - {position: EOF, value: &quot;export JAVA_HOME=/usr/java/{{jdk_version}}&quot;}
  - {position: EOF, value: &quot;export PATH=$JAVA_HOME/bin:$PATH&quot;}
  - {position: EOF, value: &quot;export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar&quot;}
- name: enforce env 
  shell: source {{env_file}}
</code></pre><h4 id="编写vars-1"><a href="#编写vars-1" class="headerlink" title="编写vars"></a>编写vars</h4><pre><code>[root@node1 jdk8]# vim vars/main.yml 
jdk_package_name: jdk-8u73-linux-x64.gz                                                                                                       
env_file: /etc/profile
jdk_version: jdk1.8.0_73
</code></pre><h4 id="使用角色-1"><a href="#使用角色-1" class="headerlink" title="使用角色"></a>使用角色</h4><p>在roles同级目录，创建一个jdk.yml文件，里面定义好你的playbook。</p>
<pre><code>[root@node1 ansible_playbooks]# vim jdk.yml 
- hosts: jdk
  remote_user: root
  roles:
  - jdk8
</code></pre><p>运行playbook安装JDK8：</p>
<pre><code>[root@node1 ansible_playbooks]# ansible-playbook jdk.yml 
</code></pre><p><strong>使用jdk8 role可以需要根据实际环境修改vars/main.yml里的变量以及/etc/ansible/hosts文件里定义的主机。</strong></p>
<h3 id="Zookeeper-role"><a href="#Zookeeper-role" class="headerlink" title="Zookeeper role"></a>Zookeeper role</h3><p>Zookeeper集群节点配置好/etc/hosts文件，配置集群各节点主机名和ip地址的对应关系。</p>
<pre><code>[root@node1 zk_server]# pwd
/root/ansible_playbooks/roles/zk_server
[root@node1 zk_server]# ls
files  handlers  meta  tasks  templates  vars
</code></pre><h4 id="上传安装包-2"><a href="#上传安装包-2" class="headerlink" title="上传安装包"></a>上传安装包</h4><p>将zookeeper-3.4.6.tar.gz和clean_zklog.sh上传到files目录。clean_zklog.sh是清理Zookeeper日志的脚本。</p>
<h4 id="编写tasks-2"><a href="#编写tasks-2" class="headerlink" title="编写tasks"></a>编写tasks</h4><pre><code>[root@node1 zk_server]# vim tasks/main.yml 
- name: install zookeeper                                                                                                                     
  unarchive: src=zookeeper-3.4.6.tar.gz dest=/usr/local/
- name: install configuration file for zookeeper
  template: src=zoo.cfg.j2 dest=/usr/local/zookeeper-3.4.6/conf/zoo.cfg
- name: add myid file
  shell: echo {{ myid }} &gt; /usr/local/zookeeper-3.4.6/dataDir/myid
- name: copy script to clear zookeeper logs.
  copy: src=clean_zklog.sh dest=/usr/local/zookeeper-3.4.6/clean_zklog.sh mode=755
- name: crontab task
  cron: name=&quot;clear zk logs&quot; weekday=&quot;0&quot; hour=&quot;0&quot; minute=&quot;0&quot; job=&quot;/usr/local/zookeeper-3.4.6/clean_zklog.sh&quot;
- name: start zookeeper
  shell: /usr/local/zookeeper-3.4.6/bin/zkServer.sh start
  tags:
  - start
</code></pre><h4 id="编写templates"><a href="#编写templates" class="headerlink" title="编写templates"></a>编写templates</h4><p>将zookeeper-3.4.6.tar.gz包中的默认配置文件重命名为zoo.cfg.j2，并修改其中的内容。</p>
<pre><code>[root@node1 ansible_playbooks]# vim roles/zk_server/templates/zoo.cfg.j2
</code></pre><p>配置文件内容过多，具体见github，地址是<a href="https://github.com/jkzhao/ansible-godseye。配置文件内容也不在解释，在前面博客中的文章中都已写明。" target="_blank" rel="external">https://github.com/jkzhao/ansible-godseye。配置文件内容也不在解释，在前面博客中的文章中都已写明。</a></p>
<h4 id="编写vars-2"><a href="#编写vars-2" class="headerlink" title="编写vars"></a>编写vars</h4><pre><code>[root@node1 zk_server]# vim vars/main.yml 
server1_hostname: hadoop27                                                                                                                    
server2_hostname: hadoop28
server3_hostname: hadoop29
</code></pre><p>另外在tasks中还使用了个变量，该变量每台主机的值是不一样的，所以定义在了/etc/ansible/hosts文件中:</p>
<pre><code>[zk_servers]
172.16.206.27 myid=1
172.16.206.28 myid=2
172.16.206.29 myid=3
</code></pre><h4 id="设置主机组"><a href="#设置主机组" class="headerlink" title="设置主机组"></a>设置主机组</h4><p>/etc/ansible/hosts文件：</p>
<pre><code>[zk_servers]
172.16.206.27 myid=1
172.16.206.28 myid=2
172.16.206.29 myid=3
</code></pre><h4 id="使用角色-2"><a href="#使用角色-2" class="headerlink" title="使用角色"></a>使用角色</h4><p>在roles同级目录，创建一个zk.yml文件，里面定义好你的playbook。</p>
<pre><code>[root@node1 ansible_playbooks]# vim zk.yml 
- hosts: zk_servers
  remote_user: root
  roles:
  - zk_server
</code></pre><p>运行playbook安装Zookeeper集群：</p>
<pre><code>[root@node1 ansible_playbooks]# ansible-playbook zk.yml 
</code></pre><p><strong>使用zk_server role需要根据实际环境修改vars/main.yml里的变量以及/etc/ansible/hosts文件里定义的主机。</strong></p>
<h3 id="Kafka-role"><a href="#Kafka-role" class="headerlink" title="Kafka role"></a>Kafka role</h3><pre><code>[root@node1 kafka_server]# pwd
/root/ansible_playbooks/roles/kafka_server
[root@node1 kafka_server]# ls
files  handlers  meta  tasks  templates  vars
</code></pre><h4 id="上传安装包-3"><a href="#上传安装包-3" class="headerlink" title="上传安装包"></a>上传安装包</h4><p>将kafka_2.11-0.9.0.1.tar.gz、kafka-manager-1.3.0.6.zip和clean_kafkalog.sh上传到files目录。clean_kafkalog.sh是清理kafka日志的脚本。</p>
<h4 id="编写tasks-3"><a href="#编写tasks-3" class="headerlink" title="编写tasks"></a>编写tasks</h4><pre><code>[root@node1 kafka_server]# vim tasks/main.yml 
- name: copy and unzip kafka
  unarchive: src=kafka_2.11-0.9.0.1.tgz dest=/usr/local/
- name: install configuration file for kafka
  template: src=server.properties.j2 dest=/usr/local/kafka_2.11-0.9.0.1/config/server.properties
- name: copy script to clear kafka logs.
  copy: src=clean_kafkalog.sh dest=/usr/local/kafka_2.11-0.9.0.1/clean_kafkalog.sh mode=755                                                   
- name: crontab task                                                         
  cron: name=&quot;clear kafka logs&quot; weekday=&quot;0&quot; hour=&quot;0&quot; minute=&quot;0&quot; job=&quot;/usr/local/kafka_2.11-0.9.0.1/clean_kafkalog.sh&quot;
- name: start kafka                            
  shell: JMX_PORT=9997 /usr/local/kafka_2.11-0.9.0.1/bin/kafka-server-start.sh -daemon /usr/local/kafka_2.11-0.9.0.1/config/server.properties &amp;                                              
  tags:                                        
  - start                                      
- name: copy and unizp kafka-manager           
  unarchive: src=kafka-manager-1.3.0.6.zip dest=/usr/local/
  when: ansible_default_ipv4[&apos;address&apos;] == &quot;{{kafka_manager_ip}}&quot;
- name: install configuration file for kafka-manager
  template: src=application.conf.j2 dest=/usr/local/kafka-manager-1.3.0.6/conf/application.conf
  when: ansible_default_ipv4[&apos;address&apos;] == &quot;{{kafka_manager_ip}}&quot;
- name: start kafka-manager                    
  shell: nohup /usr/local/kafka-manager-1.3.0.6/bin/kafka-manager &amp;
  when: ansible_default_ipv4[&apos;address&apos;] == &quot;{{kafka_manager_ip}}&quot;
  tags:                                        
  - kafkaManagerStart
</code></pre><h4 id="编写templates-1"><a href="#编写templates-1" class="headerlink" title="编写templates"></a>编写templates</h4><pre><code>[root@node1 kafka_server]# vim templates/server.properties.j2 
</code></pre><p>配置文件内容过多，具体见github，地址是<a href="https://github.com/jkzhao/ansible-godseye。配置文件内容也不再解释，在前面博客中的文章中都已写明。" target="_blank" rel="external">https://github.com/jkzhao/ansible-godseye。配置文件内容也不再解释，在前面博客中的文章中都已写明。</a></p>
<h4 id="编写vars-3"><a href="#编写vars-3" class="headerlink" title="编写vars"></a>编写vars</h4><pre><code>[root@node1 kafka_server]# vim vars/main.yml
zk_cluster: 172.16.7.151:2181,172.16.7.152:2181,172.16.7.153:2181
kafka_manager_ip: 172.16.7.151 
</code></pre><p>另外在template的文件中还使用了个变量，该变量每台主机的值是不一样的，所以定义在了/etc/ansible/hosts文件中:</p>
<pre><code>[kafka_servers]
172.16.206.17 broker_id=0
172.16.206.31 broker_id=1
172.16.206.32 broker_id=2
</code></pre><h4 id="设置主机组-1"><a href="#设置主机组-1" class="headerlink" title="设置主机组"></a>设置主机组</h4><p>/etc/ansible/hosts文件：</p>
<pre><code>[kafka_servers]
172.16.206.17 broker_id=0
172.16.206.31 broker_id=1
172.16.206.32 broker_id=2
</code></pre><h4 id="使用角色-3"><a href="#使用角色-3" class="headerlink" title="使用角色"></a>使用角色</h4><p>在roles同级目录，创建一个kafka.yml文件，里面定义好你的playbook。</p>
<pre><code>[root@node1 ansible_playbooks]# vim kafka.yml 
- hosts: kafka_servers
  remote_user: root
  roles:
  - kafka_server
</code></pre><p>运行playbook安装kafka集群：</p>
<pre><code>[root@node1 ansible_playbooks]# ansible-playbook kafka.yml 
</code></pre><p><strong>使用kafka_server role需要根据实际环境修改vars/main.yml里的变量以及/etc/ansible/hosts文件里定义的主机。</strong></p>
<h3 id="Elasticsearch-role"><a href="#Elasticsearch-role" class="headerlink" title="Elasticsearch role"></a>Elasticsearch role</h3><pre><code>[root@node1 es_server]# pwd
/root/ansible_playbooks/roles/es_server
[root@node1 es_server]# ls
files  handlers  meta  tasks  templates  vars
</code></pre><h4 id="上传安装包-4"><a href="#上传安装包-4" class="headerlink" title="上传安装包"></a>上传安装包</h4><p>将elasticsearch-2.3.3.tar.gz  elasticsearch-analysis-ik-1.9.3.zip上传到files目录。</p>
<h4 id="编写tasks-4"><a href="#编写tasks-4" class="headerlink" title="编写tasks"></a>编写tasks</h4><pre><code>[root@node1 es_server]# vim tasks/main.yml
- name: create es user
  user: name=es password={{password}}
  vars:
    # created with:
    # python -c &apos;import crypt; print crypt.crypt(&quot;This is my Password&quot;, &quot;$1$SomeSalt$&quot;)&apos;
    # &gt;&gt;&gt; import crypt
    # &gt;&gt;&gt; crypt.crypt(&apos;wisedu123&apos;, &apos;$1$bigrandomsalt$&apos;)
    # &apos;$1$bigrando$wzfZ2ifoHJPvaMuAelsBq0&apos;
    password: $1$bigrando$wzfZ2ifoHJPvaMuAelsBq0
- name: mkdir directory for elasticsearch data
  file: dest=/esdata mode=0755 state=directory owner=es group=es
- name: copy and unzip es
  #unarchive module owner and group only effect on directory.
  unarchive: src=elasticsearch-2.3.3.tar.gz dest=/usr/local/
- name: install memory configuration file for es
  template: src=elasticsearch.in.sh.j2 dest=/usr/local/elasticsearch-2.3.3/bin/elasticsearch.in.sh owner=es group=es
- name: install configuration file for es
  template: src=elasticsearch.yml.j2 dest=/usr/local/elasticsearch-2.3.3/config/elasticsearch.yml owner=es group=es
- name: mkdir directory for elasticsearch-analysis-ik plugin
  file: dest=/usr/local/elasticsearch-2.3.3/plugins/ik mode=0755 state=directory owner=es group=es
- name: copy and unizp elasticsearch-analysis-ik plugin
  unarchive: src=elasticsearch-analysis-ik-1.9.3.zip dest=/usr/local/elasticsearch-2.3.3/plugins/ik
- name: change owner and group
  #recurse=yes make all files in a directory changed.
  file: path=/usr/local/elasticsearch-2.3.3 owner=es group=es recurse=yes
- name: start es
  shell: su - es -c &apos;/usr/local/elasticsearch-2.3.3/bin/elasticsearch -d&apos;
  #command: /usr/local/elasticsearch-2.3.3/bin/elasticsearch -d
  #become: true
  #become_method: su
  #become_user: es
  tags:
  - start
</code></pre><h4 id="编写templates-2"><a href="#编写templates-2" class="headerlink" title="编写templates"></a>编写templates</h4><p>将模板elasticsearch.in.sh.j2和elasticsearch.yml.j2放入templates目录下<br><strong>注意模板里的变量名中间不能用.。比如：这样的变量名是不合法的。</strong></p>
<p>配置文件内容过多，具体见github，地址是<a href="https://github.com/jkzhao/ansible-godseye。配置文件内容也不再解释，在前面博客中的文章中都已写明。" target="_blank" rel="external">https://github.com/jkzhao/ansible-godseye。配置文件内容也不再解释，在前面博客中的文章中都已写明。</a></p>
<h4 id="编写vars-4"><a href="#编写vars-4" class="headerlink" title="编写vars"></a>编写vars</h4><pre><code>[root@node1 es_server]# vim vars/main.yml
ES_MEM: 2g
cluster_name: wisedu
master_ip: 172.16.7.151 
</code></pre><p>另外在template的文件中还使用了个变量，该变量每台主机的值是不一样的，所以定义在了/etc/ansible/hosts文件中:</p>
<pre><code>[es_servers]
172.16.7.151 node_master=true
172.16.7.152 node_master=false
172.16.7.153 node_master=false 
</code></pre><h4 id="设置主机组-2"><a href="#设置主机组-2" class="headerlink" title="设置主机组"></a>设置主机组</h4><p>/etc/ansible/hosts文件：</p>
<pre><code>[es_servers]
172.16.7.151 node_master=true
172.16.7.152 node_master=false
172.16.7.153 node_master=false 
</code></pre><h4 id="使用角色-4"><a href="#使用角色-4" class="headerlink" title="使用角色"></a>使用角色</h4><p>在roles同级目录，创建一个es.yml文件，里面定义好你的playbook。</p>
<pre><code>[root@node1 ansible_playbooks]# vim es.yml 
- hosts: es_servers
  remote_user: root
  roles:
  - es_server
</code></pre><p>运行playbook安装Elasticsearch集群：</p>
<pre><code>[root@node1 ansible_playbooks]# ansible-playbook es.yml 
</code></pre><p><strong>使用es_server role需要根据实际环境修改vars/main.yml里的变量以及/etc/ansible/hosts文件里定义的主机。</strong></p>
<h3 id="MySQL-role"><a href="#MySQL-role" class="headerlink" title="MySQL role"></a>MySQL role</h3><pre><code>[root@node1 db_server]# pwd
/root/ansible_playbooks/roles/db_server
[root@node1 db_server]# ls
files  handlers  meta  tasks  templates  vars
</code></pre><h4 id="上传安装包-5"><a href="#上传安装包-5" class="headerlink" title="上传安装包"></a>上传安装包</h4><p>将制作好的rpm包mysql-5.6.27-1.x86_64.rpm放到/root/ansible_playbooks/roles/db_server/files/目录下。<br><strong>【注意】:这个rpm包是自己打包制作的，打包成rpm会使得部署的效率提高。关于如何打包成rpm见之前的博客《速成RPM包制作》。</strong></p>
<h4 id="编写tasks-5"><a href="#编写tasks-5" class="headerlink" title="编写tasks"></a>编写tasks</h4><pre><code>[root@node1 db_server]# vim tasks/main.yml
- name: install dependency package
  yum: name={{ item }} state=present
  with_items:
  - libaio
  - libaio-devel
- name: copy mysql rpm
  copy: src=mysql-5.6.27-1.x86_64.rpm dest=/tmp/
- name: install mysql
  yum: name=/tmp/mysql-5.6.27-1.x86_64.rpm state=present
- name: start mysql
  shell: /etc/init.d/mysqld start
  tags:
  - start
- name: set up root password
  shell: /usr/local/mysql/bin/mysql -uroot -e &quot;UPDATE mysql.user SET Password=PASSWORD(&apos;wisedu123&apos;) where USER=&apos;root&apos;&quot; &amp;&gt;/dev/null
- name: delete anonymous account1
  shell: /usr/local/mysql/bin/mysql -uroot -Dmysql -pwisedu123 -e &quot;DROP USER &apos;&apos;@localhost&quot; &amp;&gt;/dev/null
- name: delete anonymous account2
  shell: /usr/local/mysql/bin/mysql -uroot -Dmysql -pwisedu123 -e &quot;grant all on *.* to root@&apos;%.%.%.%&apos; identified by &apos;wisedu123&apos;&quot; &amp;&gt;/dev/null
- name: flush privileges
  shell: /usr/local/mysql/bin/mysql -uroot -Dmysql -pwisedu123 -e &quot;flush privileges&quot; &amp;&gt;/dev/null
</code></pre><h4 id="设置主机组-3"><a href="#设置主机组-3" class="headerlink" title="设置主机组"></a>设置主机组</h4><pre><code># vim /etc/ansible/hosts 
[db_servers]
172.16.7.152 
</code></pre><h4 id="使用角色-5"><a href="#使用角色-5" class="headerlink" title="使用角色"></a>使用角色</h4><p>在roles同级目录，创建一个db.yml文件，里面定义好你的playbook。</p>
<pre><code>[root@node1 ansible_playbooks]# vim db.yml 
- hosts: mysql_server
  remote_user: root
  roles:
  - db_server
</code></pre><p>运行playbook安装MySQL：</p>
<pre><code>[root@node1 ansible_playbooks]# ansible-playbook db.yml 
</code></pre><p><strong>使用db_server role需要根据实际环境修改/etc/ansible/hosts文件里定义的主机。</strong></p>
<h3 id="Nginx-role"><a href="#Nginx-role" class="headerlink" title="Nginx role"></a>Nginx role</h3><pre><code>[root@node1 web_server]# pwd
/root/ansible_playbooks/roles/web_server
[root@node1 web_server]# ls
files  handlers  meta  tasks  templates  vars
</code></pre><h4 id="上传安装包-6"><a href="#上传安装包-6" class="headerlink" title="上传安装包"></a>上传安装包</h4><p>将制作好的rpm包openresty-for-godseye-1.9.7.3-1.x86_64.rpm放到/root/ansible_playbooks/roles/web_server/files/目录下。<br><strong>【注意】:做成rpm包，在安装时省去了编译nginx的过程，提升了部署效率。这个包里面打包了很多与我们系统相关的文件。</strong></p>
<h4 id="编写tasks-6"><a href="#编写tasks-6" class="headerlink" title="编写tasks"></a>编写tasks</h4><pre><code>[root@node1 web_server]# vim tasks/main.yml 
- name: install dependency package
  yum: name={{ item }} state=present
  with_items:
  - openssl-devel
  - readline-devel
  - pcre-devel
  - gcc
- name: copy nginx
  copy: src=openresty-for-godseye-1.9.7.3-1.x86_64.rpm dest=/tmp/
- name: install nginx
  yum: name=/tmp/openresty-for-godseye-1.9.7.3-1.x86_64.rpm state=present
- name: install configuration file for nginx
  template: src=nginx.conf.j2 dest=/usr/local/openresty/nginx/conf/nginx.conf
- name: crontab task
  cron: name=&quot;clear nginx logs&quot; weekday=&quot;0&quot; hour=&quot;0&quot; minute=&quot;0&quot; job=&quot;/usr/local/openresty/clrnginxlog.sh&quot;
- name: start nginx
  shell: systemctl start nginx.service
  tags:
  - start
</code></pre><h4 id="编写templates-3"><a href="#编写templates-3" class="headerlink" title="编写templates"></a>编写templates</h4><p>将模板nginx.conf.j2放入templates目录下</p>
<p>配置文件内容过多，具体见github，地址是<a href="https://github.com/jkzhao/ansible-godseye。配置文件内容也不再解释，在前面博客中的文章中都已写明。" target="_blank" rel="external">https://github.com/jkzhao/ansible-godseye。配置文件内容也不再解释，在前面博客中的文章中都已写明。</a></p>
<h4 id="编写vars-5"><a href="#编写vars-5" class="headerlink" title="编写vars"></a>编写vars</h4><pre><code>[root@node1 web_server]# vim vars/main.yml 
elasticsearch_cluster: server 172.16.7.151:9200;server 172.16.7.152:9200;server 172.16.7.153:9200;
kafka_server1: 172.16.7.151
kafka_server2: 172.16.7.152
kafka_server3: 172.16.7.153   
</code></pre><p><strong>经过测试，变量里面不能有逗号。 </strong></p>
<h4 id="设置主机组-4"><a href="#设置主机组-4" class="headerlink" title="设置主机组"></a>设置主机组</h4><p>/etc/ansible/hosts文件：</p>
<pre><code># vim /etc/ansible/hosts 
[nginx_servers]
172.16.7.153 
</code></pre><h4 id="使用角色-6"><a href="#使用角色-6" class="headerlink" title="使用角色"></a>使用角色</h4><p>在roles同级目录，创建一个nginx.yml文件，里面定义好你的playbook。</p>
<pre><code>[root@node1 ansible_playbooks]# vim nginx.yml 
- hosts: nginx_servers
  remote_user: root
  roles:
  - web_server  
</code></pre><p>运行playbook安装Nginx：</p>
<pre><code>[root@node1 ansible_playbooks]# ansible-playbook nginx.yml 
</code></pre><p><strong>使用web_server role需要根据实际环境修改vars/main.yml里的变量以及/etc/ansible/hosts文件里定义的主机。</strong></p>
<h3 id="Redis-role"><a href="#Redis-role" class="headerlink" title="Redis role"></a>Redis role</h3><pre><code>[root@node1 redis_server]# pwd
/root/ansible_playbooks/roles/redis_server
[root@node1 redis_server]# ls
files  handlers  meta  tasks  templates  vars
</code></pre><h4 id="上传安装包-7"><a href="#上传安装包-7" class="headerlink" title="上传安装包"></a>上传安装包</h4><p>将制作好的rpm包redis-3.2.2-1.x86_64.rpm放到/root/ansible_playbooks/roles/redis_server/files/目录下。</p>
<h4 id="编写tasks-7"><a href="#编写tasks-7" class="headerlink" title="编写tasks"></a>编写tasks</h4><pre><code>[root@node1 redis_server]# vim tasks/main.yml
- name: install dependency package
  yum: name={{ item }} state=present
  with_items:
  - openssl-devel
  - readline-devel
  - pcre-devel
- name: copy redis
  copy: src=redis-3.2.2-1.x86_64.rpm dest=/tmp/
- name: install redis
  yum: name=/tmp/redis-3.2.2-1.x86_64.rpm state=present
- name: start redis
  shell: /usr/local/bin/redis-server /etc/redis.conf
  tags:
  - start
</code></pre><h4 id="设置主机组-5"><a href="#设置主机组-5" class="headerlink" title="设置主机组"></a>设置主机组</h4><p>/etc/ansible/hosts文件：</p>
<pre><code># vim /etc/ansible/hosts 
[redis_servers]
172.16.7.152 
</code></pre><h4 id="使用角色-7"><a href="#使用角色-7" class="headerlink" title="使用角色"></a>使用角色</h4><p>在roles同级目录，创建一个redis.yml文件，里面定义好你的playbook。</p>
<pre><code>[root@node1 ansible_playbooks]# vim redis.yml 
- hosts: redis_servers
  remote_user: root
  roles:
  - redis_server 
</code></pre><p>运行playbook安装redis：</p>
<pre><code>[root@node1 ansible_playbooks]# ansible-playbook redis.yml 
</code></pre><p><strong>使用redis_server role需要根据实际环境修改vars/main.yml里的变量以及/etc/ansible/hosts文件里定义的主机。</strong></p>
<h3 id="Hadoop-role"><a href="#Hadoop-role" class="headerlink" title="Hadoop role"></a>Hadoop role</h3><p>完全分布式集群部署，NameNode和ResourceManager高可用。<br>提前配置集群节点的/etc/hosts文件、节点时间同步、某些集群主节点登录其他节点不需要输入密码。</p>
<pre><code>[root@node1 hadoop]# pwd
/root/ansible_playbooks/roles/hadoop
[root@node1 hadoop]# ls
files  handlers  meta  tasks  templates  vars
</code></pre><h4 id="上传安装包-8"><a href="#上传安装包-8" class="headerlink" title="上传安装包"></a>上传安装包</h4><p>将hadoop-2.7.2.tar.gz放到/root/ansible_playbooks/roles/hadoop/files/目录下。</p>
<h4 id="编写tasks-8"><a href="#编写tasks-8" class="headerlink" title="编写tasks"></a>编写tasks</h4><pre><code>[root@node1 hadoop]# cat tasks/main.yml 
- name: install dependency package
  yum: name={{ item }} state=present
  with_items:
  - openssh
  - rsync
- name: create hadoop user
  user: name=hadoop password={{password}}
  vars:
    # created with:
    # python -c &apos;import crypt; print crypt.crypt(&quot;This is my Password&quot;, &quot;$1$SomeSalt$&quot;)&apos;
    # &gt;&gt;&gt; import crypt
    # &gt;&gt;&gt; crypt.crypt(&apos;wisedu123&apos;, &apos;$1$bigrandomsalt$&apos;)
    # &apos;$1$bigrando$wzfZ2ifoHJPvaMuAelsBq0&apos;
    password: $1$bigrando$wzfZ2ifoHJPvaMuAelsBq0
- name: copy and unzip hadoop
  #unarchive module owner and group only effect on directory.
  unarchive: src=hadoop-2.7.2.tar.gz dest=/usr/local/
- name: create hadoop soft link
  file: src=/usr/local/hadoop-2.7.2 dest=/usr/local/hadoop state=link
- name: create hadoop logs directory
  file: dest=/usr/local/hadoop/logs mode=0775 state=directory
- name: change hadoop soft link owner and group
  #recurse=yes make all files in a directory changed.
  file: path=/usr/local/hadoop owner=hadoop group=hadoop recurse=yes
- name: change hadoop-2.7.2 directory owner and group
  #recurse=yes make all files in a directory changed.
  file: path=/usr/local/hadoop-2.7.2 owner=hadoop group=hadoop recurse=yes
- name: set hadoop env
  lineinfile: dest={{env_file}} insertafter=&quot;{{item.position}}&quot; line=&quot;{{item.value}}&quot; state=present
  with_items:
  - {position: EOF, value: &quot;\n&quot;}
  - {position: EOF, value: &quot;# Hadoop environment&quot;}
  - {position: EOF, value: &quot;export HADOOP_HOME=/usr/local/hadoop&quot;}
  - {position: EOF, value: &quot;export PATH=$PATH:${HADOOP_HOME}/bin:${HADOOP_HOME}/sbin&quot;}
- name: enforce env
  shell: source {{env_file}}
- name: install configuration file hadoop-env.sh.j2 for hadoop
  template: src=hadoop-env.sh.j2 dest=/usr/local/hadoop/etc/hadoop/hadoop-env.sh owner=hadoop group=hadoop
- name: install configuration file core-site.xml.j2 for hadoop
  template: src=core-site.xml.j2 dest=/usr/local/hadoop/etc/hadoop/core-site.xml owner=hadoop group=hadoop
- name: install configuration file hdfs-site.xml.j2 for hadoop
  template: src=hdfs-site.xml.j2 dest=/usr/local/hadoop/etc/hadoop/hdfs-site.xml owner=hadoop group=hadoop
- name: install configuration file mapred-site.xml.j2 for hadoop
  template: src=mapred-site.xml.j2 dest=/usr/local/hadoop/etc/hadoop/mapred-site.xml owner=hadoop group=hadoop
- name: install configuration file yarn-site.xml.j2 for hadoop
  template: src=yarn-site.xml.j2 dest=/usr/local/hadoop/etc/hadoop/yarn-site.xml owner=hadoop group=hadoop
- name: install configuration file slaves.j2 for hadoop
  template: src=slaves.j2 dest=/usr/local/hadoop/etc/hadoop/slaves owner=hadoop group=hadoop
- name: install configuration file hadoop-daemon.sh.j2 for hadoop
  template: src=hadoop-daemon.sh.j2 dest=/usr/local/hadoop/sbin/hadoop-daemon.sh owner=hadoop group=hadoop
- name: install configuration file yarn-daemon.sh.j2 for hadoop
  template: src=yarn-daemon.sh.j2 dest=/usr/local/hadoop/sbin/yarn-daemon.sh owner=hadoop group=hadoop
# make sure zookeeper started, and then start hadoop.
# start journalnode
- name: start journalnode
  shell: /usr/local/hadoop/sbin/hadoop-daemon.sh start journalnode
  become: true
  become_method: su
  become_user: hadoop
  when: datanode == &quot;true&quot;
# format namenode
- name: format active namenode hdfs
  shell: /usr/local/hadoop/bin/hdfs namenode -format
  become: true
  become_method: su
  become_user: hadoop
  when: namenode_active == &quot;true&quot;
- name: start active namenode hdfs
  shell: /usr/local/hadoop/sbin/hadoop-daemon.sh start namenode
  become: true
  become_method: su
  become_user: hadoop
  when: namenode_active == &quot;true&quot;
- name: format standby namenode hdfs
  shell: /usr/local/hadoop/bin/hdfs namenode -bootstrapStandby
  become: true
  become_method: su
  become_user: hadoop
  when: namenode_standby == &quot;true&quot;
- name: stop active namenode hdfs
  shell: /usr/local/hadoop/sbin/hadoop-daemon.sh stop namenode
  become: true
  become_method: su
  become_user: hadoop
  when: namenode_active == &quot;true&quot;
# format ZKFC
- name: format ZKFC
  shell: /usr/local/hadoop/bin/hdfs zkfc -formatZK
  become: true
  become_method: su
  become_user: hadoop
  when: namenode_active == &quot;true&quot;
# start hadoop cluster
- name: start namenode
  shell: /usr/local/hadoop/sbin/start-dfs.sh
  become: true
  become_method: su
  become_user: hadoop
  when: namenode_active == &quot;true&quot;
- name: start yarn
  shell: /usr/local/hadoop/sbin/start-yarn.sh
  become: true
  become_method: su
  become_user: hadoop
  when: namenode_active == &quot;true&quot;
- name: start standby rm
  shell: /usr/local/hadoop/sbin/yarn-daemon.sh start resourcemanager
  become: true
  become_method: su
  become_user: hadoop
  when: namenode_standby == &quot;true&quot; 
</code></pre><h4 id="编写templates-4"><a href="#编写templates-4" class="headerlink" title="编写templates"></a>编写templates</h4><p>将模板core-site.xml.j2、hadoop-daemon.sh.j2、hadoop-env.sh.j2、hdfs-site.xml.j2、mapred-site.xml.j2、slaves.j2、yarn-daemon.sh.j2、yarn-site.xml.j2放入templates目录下。</p>
<p>配置文件内容过多，具体见github，地址是<a href="https://github.com/jkzhao/ansible-godseye。配置文件内容也不再解释，在前面博客中的文章中都已写明。" target="_blank" rel="external">https://github.com/jkzhao/ansible-godseye。配置文件内容也不再解释，在前面博客中的文章中都已写明。</a></p>
<h4 id="编写vars-6"><a href="#编写vars-6" class="headerlink" title="编写vars"></a>编写vars</h4><pre><code>[root@node1 hadoop]# vim vars/main.yml 
env_file: /etc/profile
# hadoop-env.sh.j2 file variables.
JAVA_HOME: /usr/java/jdk1.8.0_73
# core-site.xml.j2 file variables.
ZK_NODE1: node1:2181
ZK_NODE2: node2:2181
ZK_NODE3: node3:2181
# hdfs-site.xml.j2 file variables.
NAMENODE1_HOSTNAME: node1
NAMENODE2_HOSTNAME: node2
DATANODE1_HOSTNAME: node3
DATANODE2_HOSTNAME: node4
DATANODE3_HOSTNAME: node5
# mapred-site.xml.j2 file variables.
MR_MODE: yarn
# yarn-site.xml.j2 file variables.
RM1_HOSTNAME: node1
RM2_HOSTNAME: node2
</code></pre><h4 id="设置主机组-6"><a href="#设置主机组-6" class="headerlink" title="设置主机组"></a>设置主机组</h4><p>/etc/ansible/hosts文件：</p>
<pre><code># vim /etc/ansible/hosts 
[hadoop]
172.16.7.151 namenode_active=true namenode_standby=false datanode=false
172.16.7.152 namenode_active=false namenode_standby=true datanode=false
172.16.7.153 namenode_active=false namenode_standby=false datanode=true
172.16.7.154 namenode_active=false namenode_standby=false datanode=true
172.16.7.155 namenode_active=false namenode_standby=false datanode=true
</code></pre><h4 id="使用角色-8"><a href="#使用角色-8" class="headerlink" title="使用角色"></a>使用角色</h4><p>在roles同级目录，创建一个hadoop.yml文件，里面定义好你的playbook。</p>
<pre><code>[root@node1 ansible_playbooks]# vim hadoop.yml 
- hosts: hadoop
  remote_user: root
  roles:
  - jdk8
  - hadoop  
</code></pre><p>运行playbook安装hadoop集群：</p>
<pre><code>[root@node1 ansible_playbooks]# ansible-playbook hadoop.yml 
</code></pre><p><strong>使用hadoop role需要根据实际环境修改vars/main.yml里的变量以及/etc/ansible/hosts文件里定义的主机。</strong></p>
<h3 id="Spark-role"><a href="#Spark-role" class="headerlink" title="Spark role"></a>Spark role</h3><p>Standalone模式部署spark (无HA)</p>
<pre><code>[root@node1 spark]# pwd
/root/ansible_playbooks/roles/spark
[root@node1 spark]# ls
files  handlers  meta  tasks  templates  vars
</code></pre><h4 id="上传安装包-9"><a href="#上传安装包-9" class="headerlink" title="上传安装包"></a>上传安装包</h4><p>将scala-2.10.6.tgz和spark-1.6.1-bin-hadoop2.6.tgz放到/root/ansible_playbooks/roles/hadoop/files/目录下。</p>
<h4 id="编写tasks-9"><a href="#编写tasks-9" class="headerlink" title="编写tasks"></a>编写tasks</h4><pre><code>[root@node1 spark]# cat tasks/main.yml 
- name: copy and unzip scala
  unarchive: src=scala-2.10.6.tgz dest=/usr/local/
- name: set scala env
  lineinfile: dest={{env_file}} insertafter=&quot;{{item.position}}&quot; line=&quot;{{item.value}}&quot; state=present
  with_items:
  - {position: EOF, value: &quot;\n&quot;}
  - {position: EOF, value: &quot;# Scala environment&quot;}
  - {position: EOF, value: &quot;export SCALA_HOME=/usr/local/scala-2.10.6&quot;}
  - {position: EOF, value: &quot;export PATH=$SCALA_HOME/bin:$PATH&quot;}
- name: copy and unzip spark
  unarchive: src=spark-1.6.1-bin-hadoop2.6.tgz dest=/usr/local/
- name: rename spark directory
  command: mv /usr/local/spark-1.6.1-bin-hadoop2.6 /usr/local/spark-1.6.1
- name: set spark env
  lineinfile: dest={{env_file}} insertafter=&quot;{{item.position}}&quot; line=&quot;{{item.value}}&quot; state=present
  with_items:
  - {position: EOF, value: &quot;\n&quot;}
  - {position: EOF, value: &quot;# Spark environment&quot;}
  - {position: EOF, value: &quot;export SPARK_HOME=/usr/local/spark-1.6.1&quot;}
  - {position: EOF, value: &quot;export PATH=$SPARK_HOME/bin:$PATH&quot;}
- name: enforce env
  shell: source {{env_file}}
- name: install configuration file for spark
  template: src=slaves.j2 dest=/usr/local/spark-1.6.1/conf/slaves
- name: install configuration file for spark
  template: src=spark-env.sh.j2 dest=/usr/local/spark-1.6.1/conf/spark-env.sh
- name: start spark cluster
  shell: /usr/local/spark-1.6.1/sbin/start-all.sh
  tags:
  - start
</code></pre><h4 id="编写templates-5"><a href="#编写templates-5" class="headerlink" title="编写templates"></a>编写templates</h4><p>将模板slaves.j2和spark-env.sh.j2放到/root/ansible_playbooks/roles/spark/templates/目录下。</p>
<p>配置文件内容过多，具体见github，地址是<a href="https://github.com/jkzhao/ansible-godseye。配置文件内容也不再解释，在前面博客中的文章中都已写明。" target="_blank" rel="external">https://github.com/jkzhao/ansible-godseye。配置文件内容也不再解释，在前面博客中的文章中都已写明。</a></p>
<h4 id="编写vars-7"><a href="#编写vars-7" class="headerlink" title="编写vars"></a>编写vars</h4><pre><code>[root@node1 spark]# vim vars/main.yml
env_file: /etc/profile
# spark-env.sh.j2 file variables
JAVA_HOME: /usr/java/jdk1.8.0_73
SCALA_HOME: /usr/local/scala-2.10.6
SPARK_MASTER_HOSTNAME: node1
SPARK_HOME: /usr/local/spark-1.6.1
SPARK_WORKER_MEMORY: 256M
HIVE_HOME: /usr/local/apache-hive-2.1.0-bin
HADOOP_CONF_DIR: /usr/local/hadoop/etc/hadoop/
# slave.j2 file variables
SLAVE1_HOSTNAME: node2
SLAVE2_HOSTNAME: node3
</code></pre><h4 id="设置主机组-7"><a href="#设置主机组-7" class="headerlink" title="设置主机组"></a>设置主机组</h4><p>/etc/ansible/hosts文件：</p>
<pre><code># vim /etc/ansible/hosts 
[spark]
172.16.7.151
172.16.7.152
172.16.7.153 
</code></pre><h4 id="使用角色-9"><a href="#使用角色-9" class="headerlink" title="使用角色"></a>使用角色</h4><p>在roles同级目录，创建一个spark.yml文件，里面定义好你的playbook。</p>
<pre><code>[root@node1 ansible_playbooks]# vim spark.yml 
- hosts: spark
  remote_user: root
  roles:
  - spark  
</code></pre><p>运行playbook安装spark集群：</p>
<pre><code>[root@node1 ansible_playbooks]# ansible-playbook spark.yml 
</code></pre><p><strong>使用spark role需要根据实际环境修改vars/main.yml里的变量以及/etc/ansible/hosts文件里定义的主机。</strong></p>
<p>所有的文件都在github上，<a href="https://github.com/jkzhao/ansible-godseye。" target="_blank" rel="external">https://github.com/jkzhao/ansible-godseye。</a></p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Ansible/" rel="tag"><i class="fa fa-tag"></i>Ansible</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/07/24/Ansible之roles介绍/" rel="next" title="Ansible之roles介绍">
                <i class="fa fa-chevron-left"></i> Ansible之roles介绍
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/08/11/Spark介绍及安装部署/" rel="prev" title="Spark介绍及安装部署">
                Spark介绍及安装部署 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


      <div id="lv-container" data-id="city" data-uid="MTAyMC8yODkyNi81NDk1"></div>

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Zhao Jiankai" />
          <p class="site-author-name" itemprop="name">Zhao Jiankai</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">83</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/jkzhao" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/3566507667/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.importnew.com/" title="ImportNew" target="_blank">ImportNew</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式日志系统架构图"><span class="nav-number">2.</span> <span class="nav-text">分布式日志系统架构图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建和使用roles"><span class="nav-number">3.</span> <span class="nav-text">创建和使用roles</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JDK7-role"><span class="nav-number">3.1.</span> <span class="nav-text">JDK7 role</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#上传安装包"><span class="nav-number">3.1.1.</span> <span class="nav-text">上传安装包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写tasks"><span class="nav-number">3.1.2.</span> <span class="nav-text">编写tasks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写vars"><span class="nav-number">3.1.3.</span> <span class="nav-text">编写vars</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用角色"><span class="nav-number">3.1.4.</span> <span class="nav-text">使用角色</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JDK8-role"><span class="nav-number">3.2.</span> <span class="nav-text">JDK8 role</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#上传安装包-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">上传安装包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写tasks-1"><span class="nav-number">3.2.2.</span> <span class="nav-text">编写tasks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写vars-1"><span class="nav-number">3.2.3.</span> <span class="nav-text">编写vars</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用角色-1"><span class="nav-number">3.2.4.</span> <span class="nav-text">使用角色</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zookeeper-role"><span class="nav-number">3.3.</span> <span class="nav-text">Zookeeper role</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#上传安装包-2"><span class="nav-number">3.3.1.</span> <span class="nav-text">上传安装包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写tasks-2"><span class="nav-number">3.3.2.</span> <span class="nav-text">编写tasks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写templates"><span class="nav-number">3.3.3.</span> <span class="nav-text">编写templates</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写vars-2"><span class="nav-number">3.3.4.</span> <span class="nav-text">编写vars</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置主机组"><span class="nav-number">3.3.5.</span> <span class="nav-text">设置主机组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用角色-2"><span class="nav-number">3.3.6.</span> <span class="nav-text">使用角色</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kafka-role"><span class="nav-number">3.4.</span> <span class="nav-text">Kafka role</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#上传安装包-3"><span class="nav-number">3.4.1.</span> <span class="nav-text">上传安装包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写tasks-3"><span class="nav-number">3.4.2.</span> <span class="nav-text">编写tasks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写templates-1"><span class="nav-number">3.4.3.</span> <span class="nav-text">编写templates</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写vars-3"><span class="nav-number">3.4.4.</span> <span class="nav-text">编写vars</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置主机组-1"><span class="nav-number">3.4.5.</span> <span class="nav-text">设置主机组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用角色-3"><span class="nav-number">3.4.6.</span> <span class="nav-text">使用角色</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Elasticsearch-role"><span class="nav-number">3.5.</span> <span class="nav-text">Elasticsearch role</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#上传安装包-4"><span class="nav-number">3.5.1.</span> <span class="nav-text">上传安装包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写tasks-4"><span class="nav-number">3.5.2.</span> <span class="nav-text">编写tasks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写templates-2"><span class="nav-number">3.5.3.</span> <span class="nav-text">编写templates</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写vars-4"><span class="nav-number">3.5.4.</span> <span class="nav-text">编写vars</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置主机组-2"><span class="nav-number">3.5.5.</span> <span class="nav-text">设置主机组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用角色-4"><span class="nav-number">3.5.6.</span> <span class="nav-text">使用角色</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-role"><span class="nav-number">3.6.</span> <span class="nav-text">MySQL role</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#上传安装包-5"><span class="nav-number">3.6.1.</span> <span class="nav-text">上传安装包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写tasks-5"><span class="nav-number">3.6.2.</span> <span class="nav-text">编写tasks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置主机组-3"><span class="nav-number">3.6.3.</span> <span class="nav-text">设置主机组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用角色-5"><span class="nav-number">3.6.4.</span> <span class="nav-text">使用角色</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-role"><span class="nav-number">3.7.</span> <span class="nav-text">Nginx role</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#上传安装包-6"><span class="nav-number">3.7.1.</span> <span class="nav-text">上传安装包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写tasks-6"><span class="nav-number">3.7.2.</span> <span class="nav-text">编写tasks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写templates-3"><span class="nav-number">3.7.3.</span> <span class="nav-text">编写templates</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写vars-5"><span class="nav-number">3.7.4.</span> <span class="nav-text">编写vars</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置主机组-4"><span class="nav-number">3.7.5.</span> <span class="nav-text">设置主机组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用角色-6"><span class="nav-number">3.7.6.</span> <span class="nav-text">使用角色</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-role"><span class="nav-number">3.8.</span> <span class="nav-text">Redis role</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#上传安装包-7"><span class="nav-number">3.8.1.</span> <span class="nav-text">上传安装包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写tasks-7"><span class="nav-number">3.8.2.</span> <span class="nav-text">编写tasks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置主机组-5"><span class="nav-number">3.8.3.</span> <span class="nav-text">设置主机组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用角色-7"><span class="nav-number">3.8.4.</span> <span class="nav-text">使用角色</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hadoop-role"><span class="nav-number">3.9.</span> <span class="nav-text">Hadoop role</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#上传安装包-8"><span class="nav-number">3.9.1.</span> <span class="nav-text">上传安装包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写tasks-8"><span class="nav-number">3.9.2.</span> <span class="nav-text">编写tasks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写templates-4"><span class="nav-number">3.9.3.</span> <span class="nav-text">编写templates</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写vars-6"><span class="nav-number">3.9.4.</span> <span class="nav-text">编写vars</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置主机组-6"><span class="nav-number">3.9.5.</span> <span class="nav-text">设置主机组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用角色-8"><span class="nav-number">3.9.6.</span> <span class="nav-text">使用角色</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spark-role"><span class="nav-number">3.10.</span> <span class="nav-text">Spark role</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#上传安装包-9"><span class="nav-number">3.10.1.</span> <span class="nav-text">上传安装包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写tasks-9"><span class="nav-number">3.10.2.</span> <span class="nav-text">编写tasks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写templates-5"><span class="nav-number">3.10.3.</span> <span class="nav-text">编写templates</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写vars-7"><span class="nav-number">3.10.4.</span> <span class="nav-text">编写vars</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置主机组-7"><span class="nav-number">3.10.5.</span> <span class="nav-text">设置主机组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用角色-9"><span class="nav-number">3.10.6.</span> <span class="nav-text">使用角色</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhao Jiankai</span>
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共219.9k字</span>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  


  
  
  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("r9OTvh5qdm5WfVnhJBm4XoP9-gzGzoHsz", "VAES8qziiwbdUq0IzdQVj5xD");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

<!--    -->
</body>
</html>
