<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Docker,Jenkins," />





  <link rel="alternate" href="/atom.xml" title="jkzhao's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.0.1" />






<meta name="description" content="Jenkins介绍Jenkins是一个开源软件项目，是基于Java开发的一种持续集成工具，用于监控持续重复的工作，旨在提供一个开放易用的软件平台，使软件的持续集成变成可能。">
<meta name="keywords" content="Docker,Jenkins">
<meta property="og:type" content="article">
<meta property="og:title" content="Jenkins + Docker 持续集成">
<meta property="og:url" content="http://yoursite.com/2017/09/30/Jenkins-Docker-持续集成/index.html">
<meta property="og:site_name" content="jkzhao&#39;s blog">
<meta property="og:description" content="Jenkins介绍Jenkins是一个开源软件项目，是基于Java开发的一种持续集成工具，用于监控持续重复的工作，旨在提供一个开放易用的软件平台，使软件的持续集成变成可能。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/44.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/45.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/46.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/47.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/48.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/49.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/50.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/51.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/52.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/53.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/54.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/55.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/56.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/57.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/58.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/59.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/60.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/61.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/62.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/63.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/64.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/65.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/66.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/67.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/68.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/69.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/70.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/71.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/72.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/73.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/74.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/75.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/76.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/77.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/78.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/79.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/80.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/81.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/82.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/83.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/84.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/85.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/86.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/87.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/88.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/89.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/90.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/91.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/92.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/93.png">
<meta property="og:updated_time" content="2019-05-15T02:44:45.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jenkins + Docker 持续集成">
<meta name="twitter:description" content="Jenkins介绍Jenkins是一个开源软件项目，是基于Java开发的一种持续集成工具，用于监控持续重复的工作，旨在提供一个开放易用的软件平台，使软件的持续集成变成可能。">
<meta name="twitter:image" content="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/44.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6287775856811050000,
      author: 'Author'
    }
  };
</script>

  <title> Jenkins + Docker 持续集成 | jkzhao's blog </title>
</head>
<a href="https://github.com/you"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?c179eb46ac47d3b4b1b9203b82ee5821";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <a href="https://github.com/jkzhao"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">jkzhao's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">学习 总结 思考</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            留言
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'CziK4aDdRyzFJrfygnHH','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Jenkins + Docker 持续集成
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-09-30T16:56:51+08:00" content="2017-09-30">
              2017-09-30
            </time>
            
              <span class="post-updated">
              &nbsp; | &nbsp; 更新于
              <time itemprop="dateUpdated" datetime="2019-05-15T10:44:45+08:00" content="2019-05-15">
              2019-05-15
              </time>
              </span>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/持续集成/" itemprop="url" rel="index">
                    <span itemprop="name">持续集成</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2017/09/30/Jenkins-Docker-持续集成/" class="leancloud_visitors" data-flag-title="Jenkins + Docker 持续集成">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Jenkins介绍"><a href="#Jenkins介绍" class="headerlink" title="Jenkins介绍"></a>Jenkins介绍</h2><p>Jenkins是一个开源软件项目，是基于Java开发的一种持续集成工具，用于监控持续重复的工作，旨在提供一个开放易用的软件平台，使软件的持续集成变成可能。<br><a id="more"></a></p>
<h2 id="安装部署Jenkins"><a href="#安装部署Jenkins" class="headerlink" title="安装部署Jenkins"></a>安装部署Jenkins</h2><p><a href="https://jenkins.io/download/" target="_blank" rel="external">https://jenkins.io/download/</a><br>我这里下载war包安装，版本：1.642.3 LTS .war</p>
<h3 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>操作系统版本</th>
<th>IP地址</th>
<th>安装软件</th>
</tr>
</thead>
<tbody>
<tr>
<td>osb30</td>
<td>Redhat 6.5</td>
<td>172.16.206.30</td>
<td>jenkins</td>
</tr>
</tbody>
</table>
<h3 id="新建Jenkins用户"><a href="#新建Jenkins用户" class="headerlink" title="新建Jenkins用户"></a>新建Jenkins用户</h3><pre><code>[root@osb30 ~]# groupadd jenkins
[root@osb30 ~]# useradd -g jenkins jenkins
[root@osb30 ~]# id jenkins
uid=501(jenkins) gid=501(jenkins) groups=501(jenkins)
[root@osb30 ~]# echo &quot;wisedu&quot; | passwd --stdin jenkins &amp;&gt; /dev/null
</code></pre><h3 id="Jenkins安装方式"><a href="#Jenkins安装方式" class="headerlink" title="Jenkins安装方式"></a>Jenkins安装方式</h3><p>安装jenkins有两种方式，tomcat方式部署和java部署启动。本次实验我以tomcat下部署启动为例。</p>
<h4 id="tomcat方式部署"><a href="#tomcat方式部署" class="headerlink" title="tomcat方式部署"></a>tomcat方式部署</h4><p>1.首先安装tomcat和JAVA，配置环境变量（此步骤不再讲述，java配置不可缺少）<br>我这里安装的是jdk 1.8.0_65。</p>
<p>2.将从官网下载下来的jenkins.war文件放入tomcat下的webapps目录下，进入tomcat的/bin目录下，启动tomcat即启动jenkins。<br>我这里用的是tomcat8。</p>
<p>3.启动jenkins时，会自动在webapps目录下建立jenkins目录，访问地址为：<a href="http://localhost:8080/jenkins" target="_blank" rel="external">http://localhost:8080/jenkins</a></p>
<pre><code>[jenkins@osb30 ~]$ tar zxf apache-tomcat-8.0.30.tar.gz
[jenkins@osb30 ~]$ mv jenkins.war apache-tomcat-8.0.30/webapps/
[jenkins@osb30 ~]$ cd apache-tomcat-8.0.30
[jenkins@osb30 apache-tomcat-8.0.30]$ bin/startup.sh
Jenkins home directory: /home/jenkins/.jenkins found at: $user.home/.jenkins
</code></pre><p>如果启动时报错：</p>
<pre><code>Caused by:java.awt.AWTError: Can&apos;t connect to X11 window server using &apos;:0&apos; as the value of the DISPLAY varible...
</code></pre><p>解决：</p>
<pre><code>[jenkins@osb30 ~]$ cd apache-tomcat-8.0.30/bin/
[jenkins@osb30 bin]$ vim catalina.sh 
JAVA_OPTS=&quot;-Xms1024m -Xmx1024m -Djava.awt.headless=true&quot;
</code></pre><p>4.访问jenkins<br><a href="http://172.16.206.30:8080/jenkins" target="_blank" rel="external">http://172.16.206.30:8080/jenkins</a></p>
<h4 id="java部署启动jenkins"><a href="#java部署启动jenkins" class="headerlink" title="java部署启动jenkins"></a>java部署启动jenkins</h4><p>切换到jenkins.war存放的目录，输入如下命令：</p>
<pre><code>$ java -jar jenkins.war   
</code></pre><p>可以修改启动端口</p>
<pre><code>$ java -jar jenkins.war --httpPort=8000
</code></pre><p>然后在浏览器中（推荐用火狐、chrome）输入<a href="http://localhost:8080，localhost可以是本机的ip，也可以是计算机名。就可以打开jenkins；修改端口后，访问地址的端口需同步变更。" target="_blank" rel="external">http://localhost:8080，localhost可以是本机的ip，也可以是计算机名。就可以打开jenkins；修改端口后，访问地址的端口需同步变更。</a></p>
<h3 id="Jenkins授权和访问控制"><a href="#Jenkins授权和访问控制" class="headerlink" title="Jenkins授权和访问控制"></a>Jenkins授权和访问控制</h3><p>默认地Jenkins不包含任何的安全检查，任何人可以修改Jenkins设置，job和启动build等。显然地在大规模的公司需要多个部门一起协调工作的时候，没有任何安全检查会带来很多的问题。 我们可以通过下面的方式来增强Jenkins的安全：<br>访问jenkins：<a href="http://172.16.206.30:8080/jenkins，" target="_blank" rel="external">http://172.16.206.30:8080/jenkins，</a><br>点击系统管理—&gt; Configure Global Security，点击”启用安全”，可以看到可以使用多种方式来增强Jenkins的授权和访问控制：<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/44.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/45.png" alt=""><br>如上图所示，默认是”任何用户可以做任何事情(没有任何限制)”。<br>我们在”安全域”选择”Jenkins专有用户数据库”，”允许用户注册”；并先在“授权策略”点击“任何用户可以做任何事情(没有任何限制)”， 防止注册之后无法再管理jenkins。此时就可以刷新一下jenkins的页面看到右上角有登录、注册的按钮。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/46.png" alt=""></p>
<h4 id="注册管理员账号"><a href="#注册管理员账号" class="headerlink" title="注册管理员账号"></a>注册管理员账号</h4><p>1.点击注册，首先注册一个管理员账号。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/47.png" alt=""></p>
<p>2.点击系统管理—&gt; Configure Global Security，在“授权策略”选择”安全矩阵”，添加用户/组——添加admin账户——为admin账户添加所有权限，为匿名用户勾选你希望对方了解的功能。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/48.png" alt=""><br>【注意】：匿名用户一定要开启此处的可读权限，若不开启，后面github或者bitbucket的webhook自动构建会没有权限。<br>并且勾选上该项，点击保存。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/49.png" alt=""><br>做完此部操作之后，即可用admin帐号登录，取消登录用户可以做任何事的权限。<br>以上操作，即可完成jenkins的授权和访问控制。</p>
<h3 id="Jenkins系统配置"><a href="#Jenkins系统配置" class="headerlink" title="Jenkins系统配置"></a>Jenkins系统配置</h3><p>登录jenkins——系统管理——系统设置，为jenkins添加上需要的功能配置，有如下几个方面：<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/50.png" alt=""></p>
<h4 id="jdk版本"><a href="#jdk版本" class="headerlink" title="jdk版本"></a>jdk版本</h4><p>在jdk的选项，点击”新增JDK”，取消自动安装，输入jdk别名（名称随意），JAVA_HOME大家应该都很了解，在此处填写jenkins所在服务器安装的java程序的HOME位置即可，根据不同操作系统填写不同路径，如win7 D:\Java\jdk1.8   linux /usr/lib/jvm/jdk1.7.0_51。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/51.png" alt=""><br>设置完了请记得保存。</p>
<h4 id="git-svn版本控制添加"><a href="#git-svn版本控制添加" class="headerlink" title="git/svn版本控制添加"></a>git/svn版本控制添加</h4><p>根据使用的版本选择控制版本的应用程序的路径，如jdk配置即可。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/52.png" alt=""><br>【注意】:如果使用Git作为版本控制库，Jenkins默认情况下是没有安装Git的。我们需要到插件管理界面中选中Git，然后点击直接安装。<br>点击系统管理—&gt;管理插件—&gt;可选插件，在右上角”过滤”处输入git进行搜索：<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/53.png" alt=""><br>找到Git client plugin和Git plugin，在前面打上√，点击直接安装。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/54.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/55.png" alt=""><br>安装成功后，重启jenkins。</p>
<pre><code>[jenkins@osb30 ~]$ cd apache-tomcat-8.0.30
[jenkins@osb30 apache-tomcat-8.0.30]$ bin/shutdown.sh
[jenkins@osb30 apache-tomcat-8.0.30]$ bin/startup.sh ;tail -f logs/catalina.out
</code></pre><h4 id="Jenkins添加maven配置"><a href="#Jenkins添加maven配置" class="headerlink" title="Jenkins添加maven配置"></a>Jenkins添加maven配置</h4><p>先判断jenkins所在主机是否安装了maven：</p>
<pre><code># mvn –version
-bash: mvn: command not found
</code></pre><p>如果没有安装，请先安装maven。</p>
<h5 id="CentOS-安装maven"><a href="#CentOS-安装maven" class="headerlink" title="CentOS 安装maven"></a>CentOS 安装maven</h5><pre><code>[root@osb30 ~]# cd /usr/local/
[root@osb30 local]# wget http://apache.opencas.org/maven/maven-3/3.3.9/binaries/apache-maven-3.3.9-bin.tar.gz

[root@osb30 local]# tar zxf apache-maven-3.3.9-bin.tar.gz
[root@osb30 local]# ln -s apache-maven-3.3.9 maven
[root@osb30 local]# vim /etc/profile
# 添加如下配置：
# Maven configuration.
MAVEN_HOME=/usr/local/maven
export PATH=$MAVEN_HOME/bin:$PATH
[root@osb30 local]# source /etc/profile

[root@osb30 local]# mvn -version
Apache Maven 3.3.9 (bb52d8502b132ec0a5a3f4c09453c07478323dc5; 2015-11-11T00:41:47+08:00)
Maven home: /usr/local/maven
Java version: 1.8.0_65, vendor: Oracle Corporation
Java home: /usr/java/jdk1.8.0_65/jre
Default locale: en_US, platform encoding: UTF-8
OS name: &quot;linux&quot;, version: &quot;2.6.32-431.el6.x86_64&quot;, arch: &quot;amd64&quot;, family: &quot;unix&quot;
</code></pre><h5 id="Jenkins配置maven"><a href="#Jenkins配置maven" class="headerlink" title="Jenkins配置maven"></a>Jenkins配置maven</h5><p>安装完成后，登录jenkins。点击系统管理—&gt;系统设置。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/56.png" alt=""></p>
<h2 id="Jenkins构建maven风格的job"><a href="#Jenkins构建maven风格的job" class="headerlink" title="Jenkins构建maven风格的job"></a>Jenkins构建maven风格的job</h2><h3 id="新建maven任务"><a href="#新建maven任务" class="headerlink" title="新建maven任务"></a>新建maven任务</h3><p>登录jenkins，点击新建。输入Item名称，选择“构建一个maven项目”，点击OK。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/57.png" alt=""></p>
<h3 id="构建任务配置"><a href="#构建任务配置" class="headerlink" title="构建任务配置"></a>构建任务配置</h3><p><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/58.png" alt=""></p>
<h3 id="源码管理配置"><a href="#源码管理配置" class="headerlink" title="源码管理配置"></a>源码管理配置</h3><p>进入配置页面，找到”源码管理”。我这里是svn，输入项目所在版本库的地址。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/59.png" alt=""></p>
<h3 id="构建触发器配置"><a href="#构建触发器配置" class="headerlink" title="构建触发器配置"></a>构建触发器配置</h3><p>在”源码管理”下面是”构建触发器”。<br>”构建触发器”是一个持续集成的触发器插件，可以根据已经完成构建的结果，触发新Job或者传递参数。默认的选项是Build whenever a SNAPSHOT dependency is built，意思是依赖于快照的构建，意思是依赖于快照的构建，当代码有更新时就构建项目。<br>Build periodically和Poll SCM可以设置定时自动构建。两者区别如下：</p>
<ul>
<li>Poll SCM：定时检查源码变更（根据SCM软件的版本号），如果有更新就checkout最新code下来，然后执行构建动作。</li>
<li>Build periodically：定时进行项目构建（它不care源码是否发生变化）。</li>
</ul>
<p>我这里设置为每12小时构建一次。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/60.png" alt=""></p>
<h3 id="Maven构建设置"><a href="#Maven构建设置" class="headerlink" title="Maven构建设置"></a>Maven构建设置</h3><h4 id="Pre-Step"><a href="#Pre-Step" class="headerlink" title="Pre Step"></a>Pre Step</h4><p>Pre Steps选项用来配置构建前的工作，这里不作更改。</p>
<h4 id="配置Root-POM和Goals-and-options"><a href="#配置Root-POM和Goals-and-options" class="headerlink" title="配置Root POM和Goals and options"></a>配置Root POM和Goals and options</h4><p>因为是Maven项目，所以Build选项有Root POM和Goals and options的设置。Root POM:填写你项目的pom.xml文件的位置，注意：是相对位置，如果该文件不存在，会有红色字提示。<br>比如我这里是：<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/61.png" alt=""></p>
<h4 id="Post-Steps"><a href="#Post-Steps" class="headerlink" title="Post Steps"></a>Post Steps</h4><p>在maven项目创建完成后，我们还需要实现每次构建完成，将war发布到阿里云主机上，以实现自动发布。我们通过添加shell实现自动发布。</p>
<p>找到Post steps下有个Execute shell：<br>【注意】:Jenkins在执行该shell脚本的时候是以jenkins这个用户身份去执行。某些场景下请注意环境变量PATH。<br>将构建完成后，所要采取的动作，shell脚本脚本内容如下：</p>
<pre><code>#!/bin/bash

# Stop tomcat.
ssh root@114.55.29.246 &apos;/usr/local/apache-tomcat-7.0.65/bin/shutdown.sh&apos; &amp;&gt;/dev/null
sleep 10

# Check the stop is successful or not.
if ssh root@114.55.29.246 &apos;ps -ef|grep tomcat |grep -v &quot;grep&quot;&apos; &amp;&gt;/dev/null; then
  echo &quot;Tomcat stop failed.Please check the problem.&quot;
  exit 5
fi

# Backup previous version and delete the war in the path /usr/local/apache-tomcat-7.0.65/webapps/.
ssh root@114.55.29.246 &apos;/usr/bin/cp -f /usr/local/apache-tomcat-7.0.65/webapps/*.war /backups/*war&apos;
ssh root@114.55.29.246 &apos;rm -rf /usr/local/apache-tomcat-7.0.65/webapps/*&apos;

# Copy the newest war to aliyun ECS.
scp /home/jenkins/.jenkins/workspace/godseye/godseye-parent/godseye-container/target/godseye-container-aliyun.war root@114.55.29.246:/usr/local/apache-tomcat-7.0.65/webapps/godseye.war &amp;&gt;/dev/null

# Start the tomcat.
ssh root@114.55.29.246 &apos;/usr/local/apache-tomcat-7.0.65/bin/startup.sh&apos; &amp;&gt;/dev/null
</code></pre><p>配置阿里云主机信任内网的这台jenkins主机：<br>由于是war包在内网服务器上，发布的环境是在阿里云主机上，所以要配置主机互信，防止scp war包时还需要输入密码。我这里内网服务器ip是172.16.206.30，外网是114.55.29.246。</p>
<pre><code>[jenkins@osb30 ~]$ ssh-keygen -t rsa -f .ssh/id_rsa
[jenkins@osb30 ~]$ ssh-copy-id -i .ssh/id_rsa.pub root@114.55.29.246
</code></pre><h2 id="Jenkins邮件通知设置"><a href="#Jenkins邮件通知设置" class="headerlink" title="Jenkins邮件通知设置"></a>Jenkins邮件通知设置</h2><h3 id="配置jenkins自带的邮件功能"><a href="#配置jenkins自带的邮件功能" class="headerlink" title="配置jenkins自带的邮件功能"></a>配置jenkins自带的邮件功能</h3><p>1.找到系统设置<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/62.png" alt=""></p>
<p>2.填写系统管理员邮箱<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/63.png" alt=""></p>
<p>3.找到邮件通知，输入SMTP服务器地址，点击高级，输入发件人帐号和密码<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/64.png" alt=""></p>
<p>4.勾选上”通过发送测试邮件测试配置”，然后输入收件人帐号<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/65.png" alt=""><br>此时我们已经可以发送邮件了。在具体job配置处，找到”构建设置”，输入收件人信箱，但是你会发现只能在构建失败时发邮件。可以安装插件Email Extension Plugin来自定义。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/66.png" alt=""></p>
<h3 id="安装使用插件Email-Extension-Plugin"><a href="#安装使用插件Email-Extension-Plugin" class="headerlink" title="安装使用插件Email Extension Plugin"></a>安装使用插件Email Extension Plugin</h3><p>1.安装插件Email Extension Plugin<br>该插件支持jenkins 1.5以上的版本。<br>在系统管理-插件管理-安装Email Extension Plugin。它可根据构建的结果，发送构建报告。该插件支持jenkins 1.5以上的版本。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/67.png" alt=""><br>【注意】:安装完如果使用Email Extension Plugin，就可以弃用自带的那个邮件功能了。</p>
<p>2.配置使用插件Email Extension Plugin<br>点击”系统配置”—&gt;”系统设置”。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/68.png" alt=""><br>找到Extended E-mail Notification处，输入如下的配置：<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/69.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/70.png" alt=""></p>
<pre><code>构建通知：$PROJECT_NAME - Build # $BUILD_NUMBER - $BUILD_STATUS!

&lt;hr/&gt;
(本邮件是程序自动下发的，请勿回复！)&lt;br/&gt;&lt;hr/&gt;
项目名称：$PROJECT_NAME&lt;br/&gt;&lt;hr/&gt;
构建编号：$BUILD_NUMBER&lt;br/&gt;&lt;hr/&gt;
svn版本号：${SVN_REVISION}&lt;br/&gt;&lt;hr/&gt;
构建状态：$BUILD_STATUS&lt;br/&gt;&lt;hr/&gt;
触发原因：${CAUSE}&lt;br/&gt;&lt;hr/&gt;
构建日志地址：&lt;a href=&quot;${BUILD_URL}console&quot;&gt;${BUILD_URL}console&lt;/a&gt;&lt;br/&gt;&lt;hr/&gt;
构建地址：&lt;a href=&quot;$BUILD_URL&quot;&gt;$BUILD_URL&lt;/a&gt;&lt;br/&gt;&lt;hr/&gt;
变更集:${JELLY_SCRIPT,template=&quot;html&quot;}&lt;br/&gt;&lt;hr/&gt;
</code></pre><p>点击下面的保存。<br>然后去job配置页面激活这个插件。找到需要发邮件的项目，点击进去。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/71.png" alt=""><br>点击配置，点击”增加构建后操作步骤”，选择Editable Email Notification。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/72.png" alt=""><br>附上构建日志，点击高级设置。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/73.png" alt=""><br>配置Triggers：<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/74.png" alt=""><br>更详细的介绍：<a href="http://www.cnblogs.com/zz0412/p/jenkins_jj_01.html" target="_blank" rel="external">http://www.cnblogs.com/zz0412/p/jenkins_jj_01.html</a></p>
<h2 id="sonar"><a href="#sonar" class="headerlink" title="sonar"></a>sonar</h2><p>官方文档：<a href="http://docs.sonarqube.org/display/SONARQUBE45/Documentation" target="_blank" rel="external">http://docs.sonarqube.org/display/SONARQUBE45/Documentation</a></p>
<h3 id="sonar简介"><a href="#sonar简介" class="headerlink" title="sonar简介"></a>sonar简介</h3><p>Sonar是一个用于代码质量管理的开源平台，用于管理Java源代码的质量。通过插件机制，Sonar 可以集成不同的测试工具，代码分析工具，以及持续集成工具，比如pmd-cpd、checkstyle、findbugs、Jenkins。通过不同的插件对这些结果进行再加工处理，通过量化的方式度量代码质量的变化，从而可以方便地对不同规模和种类的工程进行代码质量管理。<br>与持续集成工具（例如 Hudson/Jenkins 等）不同，Sonar 并不是简单地把不同的代码检查工具结果（例如 FindBugs，PMD 等）直接显示在 Web 页面上，而是通过不同的插件对这些结果进行再加工处理，通过量化的方式度量代码质量的变化，从而可以方便地对不同规模和种类的工程进行代码质量管理。<br>在对其他工具的支持方面，Sonar 不仅提供了对 IDE 的支持，可以在 Eclipse 和 IntelliJ IDEA 这些工具里联机查看结果；同时 Sonar 还对大量的持续集成工具提供了接口支持，可以很方便地在持续集成中使用 Sonar。<br>此外，Sonar 的插件还可以对 Java 以外的其他编程语言提供支持，对国际化以及报告文档化也有良好的支持。</p>
<h3 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h3><p><a href="http://docs.sonarqube.org/display/SONAR/Requirements" target="_blank" rel="external">http://docs.sonarqube.org/display/SONAR/Requirements</a></p>
<h3 id="新建用户"><a href="#新建用户" class="headerlink" title="新建用户"></a>新建用户</h3><pre><code>[root@osb30 ~]# groupadd sonar
[root@osb30 ~]# useradd -g sonar sonar
[root@osb30 ~]# id sonar
uid=502(sonar) gid=502(sonar) groups=502(sonar)
[root@osb30 ~]# echo &quot;wisedu&quot; | passwd --stdin sonar &amp;&gt; /dev/null
</code></pre><h3 id="安装jdk"><a href="#安装jdk" class="headerlink" title="安装jdk"></a>安装jdk</h3><pre><code>[sonar@osb30 ~]$ java -version
java version &quot;1.8.0_65&quot;
Java(TM) SE Runtime Environment (build 1.8.0_65-b17)
Java HotSpot(TM) 64-Bit Server VM (build 25.65-b01, mixed mode)
</code></pre><h3 id="安装配置数据库"><a href="#安装配置数据库" class="headerlink" title="安装配置数据库"></a>安装配置数据库</h3><pre><code>[root@osb30 ~]# mysql -uroot –p
mysql&gt; CREATE DATABASE sonar CHARACTER SET utf8 COLLATE utf8_general_ci;
mysql&gt; CREATE USER &apos;sonar&apos; IDENTIFIED BY &apos;sonar&apos;;
mysql&gt; GRANT ALL ON sonar.* TO &apos;sonar&apos;@&apos;%&apos; IDENTIFIED BY &apos;wisedu&apos;;
mysql&gt; GRANT ALL ON sonar.* TO &apos;sonar&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;wisedu&apos;;
mysql&gt; FLUSH PRIVILEGES;
</code></pre><h3 id="安装sonar"><a href="#安装sonar" class="headerlink" title="安装sonar"></a>安装sonar</h3><p>我这里用的版本是SonarQube 4.5.7 (LTS *)，上传该软件到sonar用户的家目录下。</p>
<pre><code>[sonar@osb30 ~]$ unzip -oq sonarqube-4.5.7.zip
[sonar@osb30 ~]$ vim sonarqube-4.5.7/conf/sonar.properties
</code></pre><p>修改如下字段(就是配置数据库信息，其他不用动)：</p>
<pre><code>sonar.jdbc.username:                       sonar
sonar.jdbc.password:                       wisedu
sonar.jdbc.url:                            jdbc:mysql://localhost:3306/sonar?useUnicode=true&amp;characterEncoding=utf8&amp;rewriteBatchedStatements=true

# Optional properties
sonar.jdbc.driverClassName:                com.mysql.jdbc.Driver
</code></pre><h3 id="启动sonar"><a href="#启动sonar" class="headerlink" title="启动sonar"></a>启动sonar</h3><p>Sonar默认集成了jetty容器，可以直接启动提供服务，也可以通过脚本构建为war包，部署在tomcat容器中。<br>Sonar默认的端口是”9000”、默认的上下文路径是”/”、默认的网络接口是”0.0.0.0”，默认的管理员帐号和密码为:admin/admin，这些参数都可以在配置文件sonar.properties中修改。我这里修改下port，因为本机的9000端口被其他程序占用了。</p>
<pre><code>[sonar@osb30 ~]$ vim sonarqube-4.5.7/conf/sonar.properties
sonar.web.port=9003
[sonar@osb30 ~]$ sonarqube-4.5.7/bin/linux-x86-64/sonar.sh start
</code></pre><p>查看日志：</p>
<pre><code>[sonar@osb30 ~]$ tail -f sonarqube-4.5.7/logs/sonar.log
</code></pre><p>可以看到第一次启动时，初始化语句：<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/75.png" alt=""></p>
<h3 id="关闭sonar"><a href="#关闭sonar" class="headerlink" title="关闭sonar"></a>关闭sonar</h3><pre><code>[sonar@osb30 ~]$ sonarqube-4.5.7/bin/linux-x86-64/sonar.sh stop
</code></pre><h3 id="访问sonar"><a href="#访问sonar" class="headerlink" title="访问sonar"></a>访问sonar</h3><p>浏览器输入<a href="http://172.16.206.30:9003/" target="_blank" rel="external">http://172.16.206.30:9003/</a><br>默认的管理员帐号和密码为:admin/admin。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/76.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/77.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/78.png" alt=""></p>
<h3 id="sonar插件"><a href="#sonar插件" class="headerlink" title="sonar插件"></a>sonar插件</h3><p>Sonar支持多种插件，插件的下载地址为：<a href="http://docs.codehaus.org/display/SONAR/Plugin+Library" target="_blank" rel="external">http://docs.codehaus.org/display/SONAR/Plugin+Library</a><br>将下载后的插件上传到${SONAR_HOME}extensions\plugins目录下，重新启动sonar。</p>
<p>sonar默认集成了Java Ecosystem插件，该插件是一组插件的合集:</p>
<ul>
<li>Java [sonar-java-plugin]：java源代码解析，计算指标等</li>
<li>Squid [sonar-squid-java-plugin]：检查违反Sonar定义规则的代码</li>
<li>Checkstyle [sonar-checkstyle-plugin]：使用CheckStyle检查违反统一代码编写风格的代码</li>
<li>FindBugs [sonar-findbugs-plugin]：使用FindBugs检查违反规则的缺陷代码</li>
<li>PMD [sonar-pmd-plugin]：使用pmd检查违反规则的代码</li>
<li>Surefire [sonar-surefire-plugin]：使用Surefire执行单元测试</li>
<li>Cobertura [sonar-cobertura-plugin]：使用Cobertura获取代码覆盖率</li>
<li>JaCoCo [sonar-jacoco-plugin]：使用JaCOCO获取代码覆盖率</li>
</ul>
<h3 id="与jenkins集成"><a href="#与jenkins集成" class="headerlink" title="与jenkins集成"></a>与jenkins集成</h3><p>可以通过maven集成，也可以直接与jenkins集成。我这里选择直接与jenkins集成。</p>
<h4 id="通过maven集成"><a href="#通过maven集成" class="headerlink" title="通过maven集成"></a>通过maven集成</h4><p>修改maven的主配置文件（${MAVEN_HOME}/conf/settings.xml文件或者 ~/.m2/settings.xml文件），在其中增加访问Sonar数据库及Sonar服务地址，添加如下配置：</p>
<pre><code>&lt;profile&gt;
&lt;id&gt;sonar&lt;/id&gt;
&lt;properties&gt;
    &lt;sonar.jdbc.url&gt;jdbc:mysql://localhost:3306/sonar&lt;/sonar.jdbc.url&gt;
    &lt;sonar.jdbc.driver&gt;com.mysql.jdbc.Driver&lt;/sonar.jdbc.driver&gt;
    &lt;sonar.jdbc.username&gt;sonar&lt;/sonar.jdbc.username&gt;
    &lt;sonar.jdbc.password&gt;sonar&lt;/sonar.jdbc.password&gt;
    &lt;sonar.host.url&gt;http://localhost:9003&lt;/sonar.host.url&gt; &lt;!-- Sonar服务器访问地址 --&gt;
&lt;/properties&gt;
&lt;/profile&gt;

&lt;activeProfiles&gt;
  &lt;activeProfile&gt;sonar&lt;/activeProfile&gt;
&lt;/activeProfiles&gt;

...
</code></pre><p>这部分内容具体可参照网上<a href="http://www.cnblogs.com/gao241/p/3190701.html" target="_blank" rel="external">http://www.cnblogs.com/gao241/p/3190701.html</a></p>
<h4 id="直接与Jenkins集成"><a href="#直接与Jenkins集成" class="headerlink" title="直接与Jenkins集成"></a>直接与Jenkins集成</h4><p>在jenkins的插件管理中选择安装sonar jenkins plugin，该插件可以使项目每次构建都调用sonar进行代码度量。</p>
<p>1.安装插件<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/79.png" alt=""></p>
<p>2.系统配置添加sonar的配置<br>进入系统配置页面对sonar插件进行配置，如下图：<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/80.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/81.png" alt=""><br>然后点击下面的保存。</p>
<p>3.配置构建项目，增加Post Build Action<br>点击要构建的项目，在点击左侧的配置。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/82.png" alt=""><br>在页面的最下面找到”构建后操作”，选择SonarQube。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/83.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/84.png" alt=""><br>It is no longer recommended to use SonarQube maven builder. It is preferable to set up SonarQube in the build environment and use a standard Jenkins maven target.<br>【解决】：<br><a href="http://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner+for+Jenkins" target="_blank" rel="external">http://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner+for+Jenkins</a><br>修改Build处：<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/85.png" alt=""></p>
<p>最后去jenkins构建项目，构建完查看sonar控制台：<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/86.png" alt=""></p>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><p>Jenkins构建完成后，sonar扫描代码报错：<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/87.png" alt=""><br>解决：<br>卸载sonar的JavaScript插件。</p>
<h2 id="Jenkins与Docker结合"><a href="#Jenkins与Docker结合" class="headerlink" title="Jenkins与Docker结合"></a>Jenkins与Docker结合</h2><p>我这里没有使用Docker Pipeline，直接在构建完成后，执行shell脚本，这样更灵活。</p>
<h3 id="部署流程"><a href="#部署流程" class="headerlink" title="部署流程"></a>部署流程</h3><p>1.研发push到svn代码库<br>2.Jenkins 构建，pull svn代码 使用maven进行编译打包<br>3.打包生成的代码，生成一个新版本的镜像，push到本地docker仓库harbor<br>4.发布，测试机器 pull 新版本的镜像，并删除原来的容器，重新运行新版本镜像。</p>
<h3 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>操作系统版本</th>
<th>IP地址</th>
<th>用途</th>
<th>安装软件</th>
</tr>
</thead>
<tbody>
<tr>
<td>osb30</td>
<td>Redhat 6.5</td>
<td>172.16.206.30</td>
<td>svn代码库、Jenkins、Docker</td>
<td>jenkins、svn、Docker 1.7.1</td>
</tr>
<tr>
<td>spark32</td>
<td>CentOS 7.0</td>
<td>172.16.206.32</td>
<td>本地docker仓库、业务部署测试环境</td>
<td>harbor、Docker 17.06.1-ce</td>
</tr>
</tbody>
</table>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>由于在Jenkins机器上docker是使用root用户运行的，而Jenkins是使用普通用户jenkins运行的，所以要先配置下jenkins用户可以使用docker命令。</p>
<pre><code>[root@osb30 ~]# visudo
jenkins ALL=(root)      NOPASSWD: /usr/bin/docker
</code></pre><p>另外在Jenkins机器上配置：</p>
<pre><code># Disable &quot;ssh hostname sudo &lt;cmd&gt;&quot;, because it will show the password in clear.
#         You have to run &quot;ssh -t hostname sudo &lt;cmd&gt;&quot;.
#
#Defaults    requiretty
Defaults:jenkins !requiretty
</code></pre><p>如果不配置这个，在执行下面脚本时，会报错误：</p>
<pre><code>+ cp -f /home/jenkins/.jenkins/workspace/godseyeBranchForNov/godseye-container/target/godseye-container-wisedu.war /home/jenkins/docker-file/godseye_war/godseye.war
+ sudo docker login -u jkzhao -p Wisedu123 -e 01115004@wisedu.com 172.16.206.32
sudo: sorry, you must have a tty to run sudo
</code></pre><p>在172.16.206.32机器上配置：</p>
<pre><code># visudo
#
#Defaults    requiretty
Defaults:root !requiretty
</code></pre><p>否则在机器172.16.206.32机器上执行脚本时会报错：</p>
<pre><code>[SSH] executing...
sudo: sorry, you must have a tty to run sudo
docker: invalid reference format.
</code></pre><h3 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h3><p>登录Jenkins，点击“系统管理”，点击“管理插件”，搜索插件“SSH plugin”，进行安装。<br>登录Jenkins，点击“Credentials”，点击“Add domain”。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/88.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/89.png" alt=""><br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/90.png" alt=""><br>点击“系统管理”，“系统配置”，找到“SSH remote hosts”。<br><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/91.png" alt=""></p>
<h3 id="配置Post-Steps"><a href="#配置Post-Steps" class="headerlink" title="配置Post Steps"></a>配置Post Steps</h3><p>项目其他的配置不变，见上面的章节。<br>【注意】：脚本中用到的仓库和认证的账号需要先在harbor新建好。</p>
<p><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/92.png" alt=""></p>
<pre><code># Jenkins机器：编译完成后，build生成一个新版本的镜像，push到远程docker仓库

# Variables
JENKINS_WAR_HOME=&apos;/home/jenkins/.jenkins/workspace/godseyeBranchForNov/godseye-container/target&apos;
DOCKERFILE_HOME=&apos;/home/jenkins/docker-file/godseye_war&apos;
HARBOR_IP=&apos;172.16.206.32&apos;
REPOSITORIES=&apos;godseye_war/godseye&apos;
HARBOR_USER=&apos;jkzhao&apos;
HARBOR_USER_PASSWD=&apos;Wisedu123&apos;
HARBOR_USER_EMAIL=&apos;01115004@wisedu.com&apos;

# Copy the newest war to docker-file directory.
\cp -f ${JENKINS_WAR_HOME}/godseye-container-wisedu.war ${DOCKERFILE_HOME}/godseye.war 

# Delete image early version.
sudo docker login -u ${HARBOR_USER} -p ${HARBOR_USER_PASSWD} -e ${HARBOR_USER_EMAIL} ${HARBOR_IP}  
IMAGE_ID=`sudo docker images | grep ${REPOSITORIES} | awk &apos;{print $3}&apos;`
if [ -n &quot;${IMAGE_ID}&quot; ];then
    sudo docker rmi ${IMAGE_ID}
fi

# Build image.
cd ${DOCKERFILE_HOME}
TAG=`date +%Y%m%d-%H%M%S`
sudo docker build -t ${HARBOR_IP}/${REPOSITORIES}:${TAG} . &amp;&gt;/dev/null

# Push to the harbor registry.
sudo docker push ${HARBOR_IP}/${REPOSITORIES}:${TAG} &amp;&gt;/dev/null
</code></pre><p><img src="https://raw.githubusercontent.com/jkzhao/MarkdownPictures/master/Docker/93.png" alt=""></p>
<pre><code># 拉取镜像，发布
HARBOR_IP=&apos;172.16.206.32&apos;
REPOSITORIES=&apos;godseye_war/godseye&apos;
HARBOR_USER=&apos;jkzhao&apos;
HARBOR_USER_PASSWD=&apos;Wisedu123&apos;

# 登录harbor
#docker login -u ${HARBOR_USER} -p ${HARBOR_USER_PASSWD} ${HARBOR_IP}

# Stop container, and delete the container.
CONTAINER_ID=`docker ps | grep &quot;godseye_web&quot; | awk &apos;{print $1}&apos;`
if [ -n &quot;$CONTAINER_ID&quot; ]; then
    docker stop $CONTAINER_ID
    docker rm $CONTAINER_ID
else #如果容器启动时失败了，就需要docker ps -a才能找到那个容器
    CONTAINER_ID=`docker ps -a | grep &quot;godseye_web&quot; | awk &apos;{print $1}&apos;`
    if [ -n &quot;$CONTAINER_ID&quot; ]; then  # 如果是第一次在这台机器上拉取运行容器，那么docker ps -a也是找不到这个容器的
        docker rm $CONTAINER_ID
    fi
fi

# Delete godseye_web image early version.
IMAGE_ID=`sudo docker images | grep ${REPOSITORIES} | awk &apos;{print $3}&apos;`
if [ -n &quot;${IMAGE_ID}&quot; ];then
    docker rmi ${IMAGE_ID}
fi

# Pull image.
TAG=`curl -s http://${HARBOR_IP}/api/repositories/${REPOSITORIES}/tags | jq &apos;.[-1]&apos; | sed &apos;s/\&quot;//g&apos;` #最后的sed是为了去掉tag前后的双引号
docker pull ${HARBOR_IP}/${REPOSITORIES}:${TAG} &amp;&gt;/dev/null

# Run.
docker run -d --name godseye_web -p 8080:8080 ${HARBOR_IP}/${REPOSITORIES}:${TAG}
</code></pre>
      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Docker/" rel="tag"><i class="fa fa-tag"></i>Docker</a>
          
            <a href="/tags/Jenkins/" rel="tag"><i class="fa fa-tag"></i>Jenkins</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/09/25/在Kubernetes上使用Traefik/" rel="next" title="在Kubernetes上使用Traefik">
                <i class="fa fa-chevron-left"></i> 在Kubernetes上使用Traefik
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/10/09/Kubernetes架构/" rel="prev" title="Kubernetes架构">
                Kubernetes架构 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


      <div id="lv-container" data-id="city" data-uid="MTAyMC8yODkyNi81NDk1"></div>

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Zhao Jiankai" />
          <p class="site-author-name" itemprop="name">Zhao Jiankai</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">92</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/jkzhao" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/3566507667/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.importnew.com/" title="ImportNew" target="_blank">ImportNew</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Jenkins介绍"><span class="nav-number">1.</span> <span class="nav-text">Jenkins介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装部署Jenkins"><span class="nav-number">2.</span> <span class="nav-text">安装部署Jenkins</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#环境信息"><span class="nav-number">2.1.</span> <span class="nav-text">环境信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新建Jenkins用户"><span class="nav-number">2.2.</span> <span class="nav-text">新建Jenkins用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jenkins安装方式"><span class="nav-number">2.3.</span> <span class="nav-text">Jenkins安装方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#tomcat方式部署"><span class="nav-number">2.3.1.</span> <span class="nav-text">tomcat方式部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#java部署启动jenkins"><span class="nav-number">2.3.2.</span> <span class="nav-text">java部署启动jenkins</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jenkins授权和访问控制"><span class="nav-number">2.4.</span> <span class="nav-text">Jenkins授权和访问控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#注册管理员账号"><span class="nav-number">2.4.1.</span> <span class="nav-text">注册管理员账号</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jenkins系统配置"><span class="nav-number">2.5.</span> <span class="nav-text">Jenkins系统配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#jdk版本"><span class="nav-number">2.5.1.</span> <span class="nav-text">jdk版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#git-svn版本控制添加"><span class="nav-number">2.5.2.</span> <span class="nav-text">git/svn版本控制添加</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Jenkins添加maven配置"><span class="nav-number">2.5.3.</span> <span class="nav-text">Jenkins添加maven配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#CentOS-安装maven"><span class="nav-number">2.5.3.1.</span> <span class="nav-text">CentOS 安装maven</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Jenkins配置maven"><span class="nav-number">2.5.3.2.</span> <span class="nav-text">Jenkins配置maven</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jenkins构建maven风格的job"><span class="nav-number">3.</span> <span class="nav-text">Jenkins构建maven风格的job</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#新建maven任务"><span class="nav-number">3.1.</span> <span class="nav-text">新建maven任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#构建任务配置"><span class="nav-number">3.2.</span> <span class="nav-text">构建任务配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码管理配置"><span class="nav-number">3.3.</span> <span class="nav-text">源码管理配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#构建触发器配置"><span class="nav-number">3.4.</span> <span class="nav-text">构建触发器配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Maven构建设置"><span class="nav-number">3.5.</span> <span class="nav-text">Maven构建设置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Pre-Step"><span class="nav-number">3.5.1.</span> <span class="nav-text">Pre Step</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置Root-POM和Goals-and-options"><span class="nav-number">3.5.2.</span> <span class="nav-text">配置Root POM和Goals and options</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Post-Steps"><span class="nav-number">3.5.3.</span> <span class="nav-text">Post Steps</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jenkins邮件通知设置"><span class="nav-number">4.</span> <span class="nav-text">Jenkins邮件通知设置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置jenkins自带的邮件功能"><span class="nav-number">4.1.</span> <span class="nav-text">配置jenkins自带的邮件功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装使用插件Email-Extension-Plugin"><span class="nav-number">4.2.</span> <span class="nav-text">安装使用插件Email Extension Plugin</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sonar"><span class="nav-number">5.</span> <span class="nav-text">sonar</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sonar简介"><span class="nav-number">5.1.</span> <span class="nav-text">sonar简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#环境要求"><span class="nav-number">5.2.</span> <span class="nav-text">环境要求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新建用户"><span class="nav-number">5.3.</span> <span class="nav-text">新建用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装jdk"><span class="nav-number">5.4.</span> <span class="nav-text">安装jdk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装配置数据库"><span class="nav-number">5.5.</span> <span class="nav-text">安装配置数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装sonar"><span class="nav-number">5.6.</span> <span class="nav-text">安装sonar</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动sonar"><span class="nav-number">5.7.</span> <span class="nav-text">启动sonar</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭sonar"><span class="nav-number">5.8.</span> <span class="nav-text">关闭sonar</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问sonar"><span class="nav-number">5.9.</span> <span class="nav-text">访问sonar</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sonar插件"><span class="nav-number">5.10.</span> <span class="nav-text">sonar插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#与jenkins集成"><span class="nav-number">5.11.</span> <span class="nav-text">与jenkins集成</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#通过maven集成"><span class="nav-number">5.11.1.</span> <span class="nav-text">通过maven集成</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#直接与Jenkins集成"><span class="nav-number">5.11.2.</span> <span class="nav-text">直接与Jenkins集成</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常见问题"><span class="nav-number">5.12.</span> <span class="nav-text">常见问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jenkins与Docker结合"><span class="nav-number">6.</span> <span class="nav-text">Jenkins与Docker结合</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#部署流程"><span class="nav-number">6.1.</span> <span class="nav-text">部署流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#环境说明"><span class="nav-number">6.2.</span> <span class="nav-text">环境说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置"><span class="nav-number">6.3.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装插件"><span class="nav-number">6.4.</span> <span class="nav-text">安装插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置Post-Steps"><span class="nav-number">6.5.</span> <span class="nav-text">配置Post Steps</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhao Jiankai</span>
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共259.0k字</span>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  



  
  
  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("r9OTvh5qdm5WfVnhJBm4XoP9-gzGzoHsz", "VAES8qziiwbdUq0IzdQVj5xD");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

<!--    -->
</body>
</html>
